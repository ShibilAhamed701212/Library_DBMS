Project Structure:
pythonProject/
    mainCLI.py
    README.md
    requirements.txt
    run.py
    backend/
        app.py
        scheduler.py
        socket_events.py
        __init__.py
        brain/
            orchestrator.py
            rag.py
            __init__.py
            data/
                acb01918-e830-4898-944e-712b20980092/
        chat/
            message_engine.py
            room_manager.py
            socket_service.py
            __init__.py
        config/
            config.py
            db.py
            logging_config.py
            settings.py
            __init__.py
        middleware/
            auth.py
            __init__.py
        models/
            book_model.py
            user_model.py
            __init__.py
        repository/
            db_access.py
            __init__.py
        routes/
            admin_routes.py
            analytics_routes.py
            auth_routes.py
            chat_routes.py
            common_routes.py
            member_routes.py
            system_routes.py
            test_auth.py
            test_db.py
            __init__.py
        scripts/
        services/
            activity_service.py
            ai_service.py
            analytics_service.py
            api_service.py
            audit_service.py
            author_service.py
            auth_service.py
            book_service.py
            bulk_service.py
            channel_service.py
            chat_service.py
            discovery_service.py
            email_service.py
            enrichment_service.py
            file_service.py
            gamification_service.py
            gateway_service.py
            goal_service.py
            guild_service.py
            health_service.py
            ingestion_service.py
            issue_service.py
            membership_service.py
            metadata_service.py
            notification_service.py
            recommendation_service.py
            report_service.py
            request_service.py
            reservation_service.py
            review_service.py
            settings_service.py
            social_service.py
            support_service.py
            user_service.py
            wishlist_service.py
            __init__.py
        utils/
            db_utils.py
            decorators.py
            rate_limiter.py
            security.py
            snowflake.py
            validators.py
    database/
        DBMS_library_db.sql
        init_db.py
        seed_data.py
    docs/
        01_LDBMS_Architectural_Analysis.md
        02_Deployment_Guide.md
        03_Chat_System_Design.md
        04_Deep_Component_Analysis.md
    exports/
    scripts/
        export_codebase_for_ai.py
        setup/
            check_roles.py
            create_chat_tables.py
            db_setup.py
            setup_activities.py
            setup_api_keys.py
            setup_audit.py
            setup_author_series.py
            setup_avatars.py
            setup_category_fines.py
            setup_chat_db.py
            setup_ebooks.py
            setup_fines.py
            setup_gamification.py
            setup_membership_tiers.py
            setup_notifications.py
            setup_reading_goals.py
            setup_reviews.py
            setup_settings.py
            setup_social_features.py
            setup_test_user.py
            setup_tickets.py
            setup_waitlist.py
            setup_wishlist.py
        verify/
            check_channel2.py
            check_global_members.py
            check_icons.py
            check_msg_schema.py
            check_user_roles.py
            data_check.py
            debug_chat_db.py
            debug_chat_state.py
            debug_db.py
            debug_group_roles.py
            debug_schema.py
            debug_user_room.py
            deep_health_check.py
            diag.py
            diagnostic_test.py
            get_create.py
            inspect_schema.py
            schema_check.py
            schema_debug.py
            schema_debug_dm.py
            test_brain.py
            test_import.py
            test_internal.py
            test_privacy_logic.py
            test_ratelimit.py
            test_routes.py
            test_socket_flow.py
            verify_api.py
            verify_backend_logic.py
            verify_categorization.py
            verify_channel_fix.py
            verify_chat_privacy.py
            verify_chat_privacy_backend.py
            verify_community.py
            verify_history.py
            verify_id_search.py
            verify_invites.py
            verify_logs_rules.py
            verify_members.py
            verify_members_debug.py
            verify_message_dates.py
            verify_recs.py
            verify_search.py
            verify_search_logic.py
            verify_upload_access.py
            verify_upload_fix.py
    templates/
        books_management.html
        change_password.html
        dashboard_admin.html
        dashboard_member.html
        layout.html
        login.html
        maintenance.html
        member_dashboard.html
        reports.html
        admin/
            analytics.html
            audit_logs.html
            authors.html
            books.html
            community_hub.html
            edit_author.html
            health.html
            issues.html
            overview.html
            purchase_list.html
            requests.html
            scanner.html
            series.html
            series_details.html
            settings.html
            suggestions.html
            support.html
            ticket_view.html
            users.html
        member/
            achievements.html
            ai_chat.html
            api_keys.html
            author.html
            catalog.html
            community.html
            discovery.html
            goals.html
            overview.html
            profile.html
            public_profile.html
            reader.html
            series.html
            suggest_book.html
            support.html
            ticket_view.html
            wishlist.html

==================================================

<file path="mainCLI.py">
"""
mainCLI.py
----------
Advanced CLI for Library DBMS

This file provides a command-line interface (CLI) for the Library Management System.

Key features:
- Secure login using the same authentication logic as Flask
- Role-based menus (Admin / Member)
- Reuses service layer (no duplicate logic)
- Uses Pandas-powered analytics for search/filter
- Safe password input (Windows / IDE compatible)
"""

# ===================== STANDARD LIBRARIES =====================

import sys              # Used for system-level operations (future-safe, exits, etc.)
import getpass          # Secure password input (does not echo characters)


# ===================== SERVICE LAYER IMPORTS =====================
# These are the SAME services used by the Flask web app
# This ensures consistency between CLI and Web UI

from backend.services.auth_service import authenticate_user
from backend.services.user_service import view_users, add_user, delete_user
from backend.services.book_service import view_books, add_book, delete_book
from backend.services.issue_service import issue_book, return_book
from backend.services.analytics_service import (
    search_by_title,
    available_books,
    overdue_books
)


# ===================== CLI UTILITY FUNCTIONS =====================

def divider():
    """
    Prints a visual divider line for better CLI readability.
    """
    print("\n" + "=" * 60)


def pause():
    """
    Pauses execution until user presses ENTER.
    Prevents menu from instantly refreshing.
    """
    input("\nPress ENTER to continue...")


def read_int(prompt: str):
    """
    Safely reads integer input from the user.

    Prevents ValueError crashes when user enters invalid input.
    Returns:
        int   -> if valid
        None  -> if invalid
    """
    try:
        return int(input(prompt))
    except ValueError:
        print("‚ùå Please enter a valid number")
        return None


def print_df(df):
    """
    Pretty-prints a Pandas DataFrame safely.

    - Avoids ugly index numbering
    - Handles empty or None DataFrames gracefully
    """
    if df is None or df.empty:
        print("‚ö† No data found")
    else:
        print(df.to_string(index=False))


# ===================== LOGIN HANDLER =====================

def cli_login():
    """
    Handles CLI login flow.

    Steps:
    1. Ask for email
    2. Securely ask for password
    3. Authenticate using auth_service
    4. Return user object if valid
    """

    divider()
    print("üìö LIBRARY MANAGEMENT SYSTEM ‚Äî CLI LOGIN")
    divider()

    # Read email input
    email = input("Email: ").strip()

    # Basic validation
    if not email:
        print("‚ùå Email cannot be empty")
        return None

    # ---- SAFE PASSWORD INPUT ----
    # getpass hides input and works in Windows / IDE terminals
    try:
        password = getpass.getpass("Password: ")
    except (KeyboardInterrupt, EOFError):
        # Handle Ctrl+C or broken input stream
        print("\n‚ùå Login cancelled")
        return None

    # Validate password
    if not password:
        print("‚ùå Password cannot be empty")
        return None

    # Authenticate using service layer (DB-backed)
    user = authenticate_user(email, password)

    # Authentication failure
    if not user:
        print("‚ùå Invalid email or password")
        return None

    # Success
    print(f"\n‚úÖ Login successful | Role: {user['role'].upper()}")
    return user


# ===================== ADMIN MENU =====================

def admin_menu(user):
    """
    Displays and handles Admin menu operations.

    Admin capabilities:
    - User management
    - Book management
    - Issue / return books
    - Analytics (Pandas-powered)
    """

    while True:
        divider()
        print(f"üëë ADMIN DASHBOARD ‚Äî {user['email']}")
        divider()

        # Menu options
        print("""
01. View Users
02. Add User
03. Delete User
04. View Books
05. Add Book
06. Delete Book
07. Issue Book
08. Return Book
09. Search Book by Title
10. Available Books
11. Overdue Books
00. Logout
""")

        # Read menu choice
        choice = input("üëâ Enter choice: ").strip()

        # Logout
        if choice == "00":
            print("üëã Logged out")
            break

        # View all users
        elif choice == "01":
            for u in view_users():
                print(u)

        # Add a new user
        elif choice == "02":
            name = input("Name: ").strip()
            email = input("Email: ").strip()
            role = input("Role (admin/member): ").strip().lower()
            password = getpass.getpass("Password: ")
            print(add_user(name, email, role, password))

        # Delete a user
        elif choice == "03":
            uid = read_int("User ID to delete: ")
            if uid is not None:
                print(delete_user(uid))

        # View all books
        elif choice == "04":
            for b in view_books():
                print(b)

        # Add a new book
        elif choice == "05":
            title = input("Title: ").strip()
            author = input("Author: ").strip()
            category = input("Category: ").strip()
            copies = read_int("Total copies: ")
            if copies is not None:
                add_book(title, author, category, copies)
                print("‚úÖ Book added")

        # Delete a book
        elif choice == "06":
            bid = read_int("Book ID to delete: ")
            if bid is not None:
                print(delete_book(bid))

        # Issue a book
        elif choice == "07":
            uid = read_int("User ID: ")
            bid = read_int("Book ID: ")
            if uid is not None and bid is not None:
                print(issue_book(uid, bid))

        # Return a book
        elif choice == "08":
            uid = read_int("User ID: ")
            bid = read_int("Book ID: ")
            if uid is not None and bid is not None:
                print(return_book(uid, bid))

        # Search books (Pandas)
        elif choice == "09":
            key = input("Search title: ")
            print_df(search_by_title(key))

        # View available books (Pandas filter)
        elif choice == "10":
            print_df(available_books())

        # View overdue books (Pandas analytics)
        elif choice == "11":
            print_df(overdue_books())

        # Invalid menu option
        else:
            print("‚ùå Invalid choice")

        pause()


# ===================== MEMBER MENU =====================

def member_menu(user):
    """
    Displays and handles Member menu operations.

    Member capabilities:
    - View available books
    - Search books
    """

    while True:
        divider()
        print(f"üë§ MEMBER DASHBOARD ‚Äî {user['email']}")
        divider()

        print("""
01. View Available Books
02. Search Book by Title
00. Logout
""")

        choice = input("üëâ Enter choice: ").strip()

        # Logout
        if choice == "00":
            print("üëã Logged out")
            break

        # View available books
        elif choice == "01":
            print_df(available_books())

        # Search books
        elif choice == "02":
            key = input("Search title: ")
            print_df(search_by_title(key))

        else:
            print("‚ùå Invalid choice")

        pause()


# ===================== PROGRAM ENTRY POINT =====================

def main():
    """
    Entry point for CLI application.

    Flow:
    1. Login
    2. Route user based on role
    """

    user = cli_login()

    # Exit if login failed
    if not user:
        return

    # Role-based menu routing
    if user["role"] == "admin":
        admin_menu(user)
    else:
        member_menu(user)


# Run CLI only if executed directly
if __name__ == "__main__":
    main()

</file>

<file path="README.md">
# üìö Enterprise Library Database Management System (LDBMS)

> **The Ultimate "Mega Project" Evolution** - A high-performance, AI-augmented, and gamified Library Management Ecosystem. Built with a "Golden Ratio" design philosophy and powered by Google Gemini 1.5.

[![Python](https://img.shields.io/badge/Python-3.10+-blue.svg)](https://www.python.org/downloads/)
[![Flask](https://img.shields.io/badge/Flask-3.0+-green.svg)](https://flask.palletsprojects.com/)
[![AI-Powered](https://img.shields.io/badge/AI-Gemini_1.5_Flash-purple.svg)](https://deepmind.google/technologies/gemini/)
[![Gamified](https://img.shields.io/badge/Gamification-Active-gold.svg)](#-gamification-system)
[![Real-Time](https://img.shields.io/badge/Real--Time-Socket.IO-orange.svg)](https://socket.io/)

---

## üìñ Documentation Hub
We have moved our in-depth technical documentation to the `docs/` folder. Please refer to these files for detailed insights:

- üìò **[Architectural Deep Dive](docs/01_LDBMS_Architectural_Analysis.md)** - A comprehensive breakdown of the Service-Repository Monolith pattern, Layered Architecture, and Design philosophy.
- üî¨ **[Deep Component Analysis](docs/04_Deep_Component_Analysis.md)** - An exhaustive, technical audit of every file, its limitations, and strategic roadmap.
- üöÄ **[Deployment Guide](docs/02_Deployment_Guide.md)** - Step-by-step instructions for deploying to platforms like Render using GitHub.
- üí¨ **[Chat System Design](docs/03_Chat_System_Design.md)** - Internal mechanics of the real-time chat, anarchy/privacy modes, and guild systems.

---

## üåü Capabilities at a Glance

The LDBMS has evolved from a standard management tool into an enterprise-grade platform. Featuring **over 35 modular features**, it now combines traditional library science with cutting-edge AI, behavioral design, and real-time social interaction.

### ‚ú® Enterprise Core Highlights
- üß† **AI-First Discovery**: Semantic search and "Vibe" matching powered by Gemini 1.5.
- üí¨ **Social Hub**: Real-time chat, guilds, and community interaction.
- üéÆ **Gamified Retention**: XP systems, level-ups, and badges for active readers.
- üì± **Mobile-First Premium UI**: Fully responsive, touch-optimized design with glassmorphism aesthetics.
- üíé **Dynamic Tiering**: Silver, Gold, and Platinum membership with intelligent privilege enforcement.
- üìä **Real-time Analytics**: Interactive Chart.js dashboards and automated PDF reporting.
- üèóÔ∏è **Smart Inventory**: ISBN Auto-Hydration for zero-effort catalog expansion.

---

## üöÄ Feature Set

### üí¨ Real-Time Collaboration & Social Hub
- **Channels & DMs**: Seamless real-time messaging with individual users or topic-based channels.
- **Guilds & Communities**: Join interest-based guilds (e.g., "Sci-Fi Lovers") with role-based access (Admin/Moderator).
- **Rich Media Support**: Share files and images with instant previews; typing indicators and read receipts.
- **Privacy First**: Anonymous chat mode for discreet discussions and granular profile privacy toggles.
- **Connections Hub**: Manage friend requests and view pending invitations in a centralized dashboard.

### üß† Artificial Intelligence & Search
- **AI Librarian Chatbot**: Conversational assistant for citations and general help.
- **"Vibe" & Mood Discovery**: Find books by describing a mood (e.g., "dark and rainy").
- **Smart Recommendations**: Personalized "Recommended for You" engine based on user history.
- **ISBN Auto-Hydrator**: Fetch metadata (Title, Author, Cover) via global APIs (OpenLibrary/Google Books).

### üì± User Experience & Interface
- **Premium Glassmorphism Design**: Modern, translucent UI with vibrant gradients and golden-ratio typography.
- **Mobile-Adaptive Layouts**: Collapsible sidebars, touch-friendly tables, and optimized headers for phones/tablets.
- **Interactive Visuals**: Smooth transitions, hover effects, and micro-animations for a "living" interface feeling.

### üéÆ Gamification & Community
- **XP & Leveling System**: Earn experience for borrowing and returning on time.
- **Achievement Gallery**: Unlock badges like "First Bloom" or "Scholar" for library milestones.
- **Personal Activity Feed**: A visual timeline of your literary journey.
- **Social Discovery**: Public profiles (optional) to see what fellow "Platinum" members are reading.

### üëë Enterprise Administration
- **Automated Reporting**: Weekly PDF performance audits sent via scheduled email (APscheduler).
- **Advanced Analytics Dashboard**: Interactive trends, genre popularity, and usage heatmaps.
- **System Health Monitor**: Live diagnostics for DB latency, CPU load, and resource vitals.
- **Maintenance Mode**: One-click system lockdown for updates (Admin-exclusive access).
- **Bulk Data Management**: Import/Export capabilities for massive library catalogs.

---

## üèóÔ∏è Technical Architecture

### üìÅ Project Structure
```
LDBMS/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ app.py                      # Application Factory & SocketIO Init
‚îÇ   ‚îú‚îÄ‚îÄ scheduler.py                # Background job engine
‚îÇ   ‚îú‚îÄ‚îÄ socket_events.py            # Real-time Event Handlers
‚îÇ   ‚îú‚îÄ‚îÄ config/                     # Environment & Logging Config
‚îÇ   ‚îú‚îÄ‚îÄ repository/                 # Data Access Layer (DAL)
‚îÇ   ‚îú‚îÄ‚îÄ services/                   # Business Logic (AI, Chat, Guilds, etc.)
‚îÇ   ‚îî‚îÄ‚îÄ routes/                     # Blueprints (Admin, Chat, Member, System)
‚îú‚îÄ‚îÄ docs/                           # Documentation Module
‚îÇ   ‚îú‚îÄ‚îÄ 01_LDBMS_Architectural_Analysis.md
‚îÇ   ‚îú‚îÄ‚îÄ 02_Deployment_Guide.md
‚îÇ   ‚îî‚îÄ‚îÄ 03_Chat_System_Design.md
‚îú‚îÄ‚îÄ scripts/                        # Utility Scripts
‚îÇ   ‚îî‚îÄ‚îÄ export_codebase_for_ai.py   # Codebase consolidation tool
‚îú‚îÄ‚îÄ templates/                      # Jinja2 Layouts (Responsive/Glassmorphism)
‚îÇ   ‚îú‚îÄ‚îÄ chat/                       # Chat & Guild Interfaces
‚îÇ   ‚îú‚îÄ‚îÄ admin/                      # Management Dashboards
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ static/                         # Compiled CSS, JS Bundles, Assets
‚îú‚îÄ‚îÄ mainCLI.py                      # Admin Terminal Interface
‚îú‚îÄ‚îÄ run.py                          # Entry Point (Flask + SocketIO + Ngrok)
‚îî‚îÄ‚îÄ requirements.txt                # Project Dependencies
```

### üß™ Tech Stack
- **Backend**: Flask 3.0, Flask-SocketIO (Real-time), Apscheduler
- **Database**: MySQL 8.0 (Pooled Connections)
- **AI Layer**: Google Generative AI (Gemini 1.5 Flash)
- **Frontend**: Vanilla CSS (Modern Variables), JavaScript (ES6+), Chart.js
- **Tools**: Pandas, FPDF2, PyNgrok (Tunneling)

---

## ‚öôÔ∏è Installation & Setup

### Prerequisites
- Python 3.10+
- MySQL 8.x
- Google Gemini API Key (Optional)

### 1Ô∏è‚É£ Environment Setup
```bash
python -m venv .venv
# Windows
.venv\Scripts\activate
# Linux/Mac
source .venv/bin/activate

pip install -r requirements.txt
```

### 2Ô∏è‚É£ Configuration
Create a `.env` file in the root directory:
```env
DB_HOST=127.0.0.1
DB_NAME=library_db
DB_USER=root
DB_PASSWORD=your_password
GEMINI_API_KEY=your_key_here
SECRET_KEY=your_secret_key
MAIL_SERVER=smtp.gmail.com
MAIL_USERNAME=your_email@gmail.com
MAIL_PASSWORD=app_password
```

### 3Ô∏è‚É£ Initialize Database
```bash
mysql -u root -p < database/schema_evolution.sql
python database/seed_mega.py
```

### 4Ô∏è‚É£ Execution
```bash
python run.py
```
*The application will launch with a local URL and an optional public Ngrok URL.*

---

## üë®‚Äçüíª Author & Credits

**Shibil Ahamed**  
Built with the goal of redefining the "Library System" as a high-tech literary social hub.

Special thanks to the **Google Gemini Team** for providing the intelligence layer that powers our discovery engine.

---

<div align="center">

**‚≠ê Star the LDBMS if you want to revolutionize reading!**

Made with ‚ù§Ô∏è using Flask, MySQL, and Artificial Intelligence

</div>

</file>

<file path="requirements.txt">
# Core Dependencies
Flask==2.3.3
Werkzeug==2.3.7
Jinja2==3.1.2
itsdangerous==2.1.2
click==8.1.6
flask-socketio==5.3.6

# Database
mysql-connector-python>=9.0.0,<10.0.0
SQLAlchemy==2.0.21
alembic==1.12.1

# Security
bcrypt==4.0.1
python-dotenv==1.0.0
PyJWT==2.8.0

# Data Processing
pandas>=2.2.0,<3.0.0
numpy>=2.0.0
openpyxl>=3.1.2

# Development
pytest==7.4.2
black==23.9.1
flake8==6.1.0
mypy==1.5.1

# Production
gunicorn==21.2.0

# Email
email-validator==2.0.0.post2

# Logging
python-json-logger==2.0.7

# Utils
python-dateutil==2.8.2
pytz==2023.3
psutil==7.2.2
pyngrok==7.1.6

# AI / ML
huggingface_hub==0.17.3
chromadb==0.4.15
sentence-transformers==2.2.2

</file>

<file path="run.py">
"""
run.py
------
Application entry point with integrated ngrok tunneling.
"""

from backend.app import create_app
import os
import subprocess
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

app = create_app()

def cleanup_before_start():
    """Kill any existing ngrok processes and free port 5000."""
    try:
        # Kill all ngrok processes
        subprocess.run(['taskkill', '/F', '/IM', 'ngrok.exe'], 
                      capture_output=True, shell=True)
    except:
        pass
    
    try:
        # Find and kill process using port 5000
        result = subprocess.run(
            'netstat -ano | findstr :5000 | findstr LISTENING',
            capture_output=True, text=True, shell=True
        )
        for line in result.stdout.strip().split('\n'):
            if line:
                parts = line.split()
                if len(parts) >= 5:
                    pid = parts[-1]
                    subprocess.run(['taskkill', '/F', '/PID', pid], 
                                 capture_output=True, shell=True)
    except:
        pass

def start_ngrok():
    """Start ngrok tunnel and return public URL."""
    ngrok_token = os.getenv('NGROK_AUTHTOKEN')
    if ngrok_token and ngrok_token != 'YOUR_TOKEN_HERE':
        try:
            from pyngrok import ngrok
            ngrok.set_auth_token(ngrok_token)
            tunnel = ngrok.connect("127.0.0.1:5000")
            return tunnel.public_url
        except Exception as e:
            print(f"‚ö†Ô∏è Ngrok error: {e}")
    return None

if __name__ == "__main__":
    
    # Silence pyngrok and other noisy loggers
    import logging
    # logging.getLogger("pyngrok").setLevel(logging.WARNING)
    # logging.getLogger("werkzeug").setLevel(logging.WARNING)
    # logging.getLogger("apscheduler").setLevel(logging.WARNING)

    # -----------------------------
    # MAIN PROCESS ONLY (Pre-Reload)
    # -----------------------------
    if os.environ.get('WERKZEUG_RUN_MAIN') != 'true':
        # Clean up ONLY in the main process before anything else
        cleanup_before_start()
        
        import time
        time.sleep(2)  # Wait for processes to fully terminate
    
    # -----------------------------
    # CHILD PROCESS ONLY (Reloader)
    # -----------------------------
    if os.environ.get('WERKZEUG_RUN_MAIN') == 'true':
        from backend.scheduler import start_scheduler
        start_scheduler()
    
    # Start ngrok (Only in main/parent process to persist across reloads)
    public_url = None
    if os.environ.get('WERKZEUG_RUN_MAIN') != 'true':
        public_url = start_ngrok()
        
        # Display startup info
        print("\n" + "="*60)
        print("üöÄ LDBMS IS STARTING UP!")
        print(f"üëâ Local URL:   http://127.0.0.1:5000")
        if public_url:
            print(f"üåê Public URL:  {public_url}")
        else:
            print(f"üåê Public URL:  Not available")
        print("="*60 + "\n")
    
    from backend import socketio
    socketio.run(app, debug=True, host='0.0.0.0', use_reloader=True, log_output=True)

</file>

<file path="backend\app.py">
# backend/app.py
# ----------------
# Flask application factory.
# Responsible for:
# - Creating the Flask app instance
# - Configuring templates & static paths
# - Loading environment variables
# - Registering all route blueprints
#
# This file does NOT contain business logic.
# This file does NOT contain database code.
# This file is the central app bootstrap.

import os                          # Used for filesystem path operations
from flask import Flask            # Core Flask class
from dotenv import load_dotenv     # Loads environment variables from .env file

# -------------------------------
# IMPORT BLUEPRINTS (ROUTES)
# -------------------------------
# Each blueprint handles a separate domain of the app

from backend.routes.auth_routes import auth_bp      # Login, logout, password change
from backend.routes.admin_routes import admin_bp    # Admin dashboard & admin actions
from backend.routes.member_routes import member_bp  # Member dashboard
from backend.routes.system_routes import system_bp  # Cloud initialization

# Import test routes (for debugging)
from backend.routes.test_auth import test_auth_bp   # Test authentication routes

# -------------------------------
# LOAD ENVIRONMENT VARIABLES
# -------------------------------
# Reads values from .env into os.environ
# Example: FLASK_SECRET_KEY
load_dotenv()


def create_app():
    """
    Application factory function.

    Purpose:
    - Creates and configures the Flask app
    - Allows scalability (testing, prod, dev configs)
    - Industry-standard Flask pattern

    Returns:
        Flask app instance
    """

    # -------------------------------
    # BASE DIRECTORY RESOLUTION
    # -------------------------------
    # Computes project root directory
    # backend/app.py ‚Üí ../ (project root)
    BASE_DIR = os.path.abspath(
        os.path.join(os.path.dirname(__file__), "..")
    )

    # -------------------------------
    # FLASK APP INITIALIZATION
    # -------------------------------
    # Explicitly define:
    # - template folder (HTML files)
    # - static folder (CSS, JS, images)
    app = Flask(
        __name__,
        template_folder=os.path.join(BASE_DIR, "templates"),
        static_folder=os.path.join(BASE_DIR, "static")
    )
    
    # Initialize SocketIO
    from backend import socketio
    socketio.init_app(app, async_mode='threading')
    
    # Register Socket Events
    import backend.socket_events
    import backend.chat.socket_service # Load Chat Handlers



    # -------------------------------
    # SECURITY CONFIGURATION
    # -------------------------------
    # Secret key used for:
    # - Sessions
    # - Flash messages
    # - CSRF protection (if enabled)
    #
    # Pulled from environment for security
    app.secret_key = os.getenv(
        "FLASK_SECRET_KEY",
        "dev-secret"   # fallback ONLY for development
    )

    # -------------------------------
    # REGISTER BLUEPRINTS
    # -------------------------------
    # Connects route modules to the app
    # Keeps routes modular and clean

    # Register main application blueprints
    app.register_blueprint(auth_bp)     # /
    app.register_blueprint(admin_bp)    # /dashboard
    app.register_blueprint(member_bp)   # /member/dashboard
    app.register_blueprint(system_bp)   # /system
    
    from backend.routes.chat_routes import chat_bp
    app.register_blueprint(chat_bp, url_prefix='/chat')
    
    from backend.routes.analytics_routes import analytics_bp
    app.register_blueprint(analytics_bp) # /admin/analytics
    
    # Register test blueprints (for debugging)
    # Register test blueprints (for debugging)
    app.register_blueprint(test_auth_bp, url_prefix='/test')  # /test/auth/...

    from backend.routes.common_routes import common_bp
    app.register_blueprint(common_bp)

    # Context Processor for Notifications
    from flask import session
    # Context Processor for Notifications & Settings
    from flask import session
    @app.context_processor
    def inject_global_data():
        data = {
            'unread_notifications': [],
            'unread_count': 0,
            'system_settings': {
                'library_name': 'LibManage',
                'library_tagline': 'Professional Library Management System',
                'branding_emoji': 'üìö',
                'currency_symbol': '‚Çπ',
                'library_email': 'support@libmanage.com',
                'library_phone': '+91 98765 43210',
                'library_address': 'Central Library, MG Road, Tech City',
                'max_books_per_user': '3',
                'default_issue_days': '14',
                'max_renewals': '2',
                'reservation_expiry_days': '3',
                'max_pending_requests': '5',
                'daily_fine_rate': '5',
                'fine_grace_period': '0',
                'fine_cap': '500',
                'default_theme': 'auto',
                'pagination_size': '12',
                'show_cover_images': 'true',
                'sidebar_style': 'full',
                'accent_color': '#4e73df',
                'registration_mode': 'open',
                'allow_suggestions': 'true'
            }
        }
        
        # Inject Notifications
        if 'user_id' in session:
            try:
                from backend.services.notification_service import get_unread_notifications
                notifs = get_unread_notifications(session['user_id'])
                data['unread_notifications'] = notifs
                data['unread_count'] = len(notifs)
            except:
                pass
        
        # Inject Settings
        try:
            from backend.services.settings_service import get_all_settings
            settings = get_all_settings()
            if settings:
                data['system_settings'].update(settings)
        except:
            pass
            
        return data

    # Maintenance Mode Hook
    from flask import request, render_template
    from backend.services.settings_service import is_maintenance_mode

    @app.before_request
    def check_maintenance():
        # Exclude static files, auth routes, and system setup
        if request.path.startswith('/static') or \
           request.path.startswith('/auth') or \
           request.path == '/' or \
           request.path.startswith('/admin') or \
           request.path.startswith('/api/book') or \
           request.path.startswith('/system'):
            return None

        # Check maintenance status
        if is_maintenance_mode():
            # If logged in as admin, allow through
            if session.get('role') == 'admin':
                return None
            
            # Everyone else gets maintenance page
            return render_template("maintenance.html"), 503

    # -------------------------------
    # RETURN CONFIGURED APP
    # -------------------------------
    return app

</file>

<file path="backend\scheduler.py">

from apscheduler.schedulers.background import BackgroundScheduler
from backend.services.issue_service import send_overdue_reminders
import atexit

def start_scheduler():
    """
    Initializes and starts the background scheduler.
    """
    scheduler = BackgroundScheduler()
    
    # Schedule overdue reminders every day at 10:00 AM
    scheduler.add_job(func=send_overdue_reminders, trigger="cron", hour=10, minute=0)
    
    # Schedule weekly performance report every Monday at 9:00 AM
    from backend.services.report_service import generate_weekly_report
    scheduler.add_job(func=generate_weekly_report, trigger="cron", day_of_week="mon", hour=9, minute=0)
    
    scheduler.start()
    print("‚è∞ Scheduler started. Automated emails will be sent daily at 10:00 AM.")
    
    # Shut down the scheduler when exiting the app
    atexit.register(lambda: scheduler.shutdown())

</file>

<file path="backend\socket_events.py">
# This file is deprecated.
# New chat logic is in backend/chat/socket_service.py
# Kept as empty to avoid import errors if referenced elsewhere.

</file>

<file path="backend\__init__.py">
from flask_socketio import SocketIO

socketio = SocketIO(cors_allowed_origins="*")

</file>

<file path="backend\brain\orchestrator.py">
import os
from typing import List, Dict, Any, Optional
from huggingface_hub import InferenceClient
from datetime import datetime

# Initialize environment variables if not already done
# In Flask context, this is usually handled by the app setup, 
# but for standalone testing we might need dotenv.
try:
    from dotenv import load_dotenv
    load_dotenv()
except ImportError:
    pass

from backend.brain.rag import rag

class Orchestrator:
    """
    The Orchestrator is the central brain of the AI agent.
    It manages:
    1. Conversation State (Memory)
    2. Prompt Construction (System Instructions)
    3. LLM Interaction (Inference)
       - Primary: HuggingFace API (Mistral/Phi-3)
       - Fallback: Local TinyLlama (Offline)
       - Last Resort: Rule-Based Logic
    """
    
    def __init__(self):
        self.api_token = os.getenv("HF_TOKEN")
        self.local_pipeline = None
        self.using_local = False
        
        # System Prompt
        self.system_prompt = """You are the AI Assistant for the Library Database Management System (LDBMS).
Your goal is to help users find books, understand library rules, and discover new content.
RULES:
1. Be helpful, polite, and professional.
2. Provide specific book recommendations when possible.
3. Keep responses concise (under 3 sentences where possible).
"""

        # Initialize Brain connection
        if self.api_token:
            print("üß† AI Brain: Connected to HuggingFace API (Mistral-7B)")
            # self.client = ... (Initialized on demand or here)
            # using updated simple inference for robustness
            self.client = InferenceClient(token=self.api_token)
            self.model_id = "mistralai/Mistral-7B-Instruct-v0.2" 
        else:
            print("üß† AI Brain: No API Token found. Switching to LOCAL MODE.")
            self._init_local_model()

    def _init_local_model(self):
        """Initializes a small local model for offline use."""
        try:
            from transformers import pipeline
            print("üì• Loading local model (TinyLlama-1.1B)... This may take a moment first time.")
            
            # TinyLlama is ~600MB and runs fast on CPU
            model_id = "TinyLlama/TinyLlama-1.1B-Chat-v1.0"
            
            self.local_pipeline = pipeline(
                "text-generation", 
                model=model_id, 
                torch_dtype="auto", 
                device_map="auto",
                max_new_tokens=256
            )
            self.using_local = True
            print("‚úÖ Local Brain Ready!")
        except Exception as e:
            print(f"‚ùå Local Brain Init Failed: {e}")
            print("‚ö†Ô∏è Falling back to Rule-Based responses.")
            self.using_local = False

    def process_message(self, user_message: str, history: List[Dict[str, str]] = None) -> str:
        """
        Process a user message and return the AI's response.
        """
        if history is None:
            history = []
            
        # 1. Retrieve Context (RAG)
        print(f"üîç Searching memory for: {user_message}")
        try:
            context_docs = rag.search_books(user_message)
        except:
            context_docs = []
        
        context_str = ""
        if context_docs:
            context_str = "\nCONTEXT BOOKS:\n" + "\n".join(
                [f"- {d['title']} by {d['author']}" for d in context_docs[:3]]
            )
            
        # 2. Generate Response
        full_user_msg = f"{context_str}\n\nUser: {user_message}"
        
        try:
            if self.api_token:
                return self._call_api(full_user_msg, history)
            elif self.using_local and self.local_pipeline:
                return self._call_local(full_user_msg, history)
            else:
                return self._rule_based_fallback(user_message)
        except Exception as e:
            print(f"‚ùå Brain Error: {e}")
            return self._rule_based_fallback(user_message)

    def _call_api(self, message: str, history: List[Dict[str, str]]) -> str:
        messages = [{"role": "system", "content": self.system_prompt}]
        # Simplified history
        for msg in history[-3:]:
             messages.append({"role": msg.get("role", "user"), "content": msg.get("content", "")})
        messages.append({"role": "user", "content": message})
        
        try:
            response = self.client.chat_completion(messages, model=self.model_id, max_tokens=512)
            return response.choices[0].message.content
        except Exception as e:
            print(f"API Error, trying local: {e}")
            if not self.local_pipeline: 
                self._init_local_model()
            if self.local_pipeline:
                 return self._call_local(message, history)
            return self._rule_based_fallback(message)

    def _call_local(self, message: str, history: List[Dict[str, str]]) -> str:
        # Construct a simple prompt for TinyLlama
        # TinyLlama Chat format: <|system|>\n{sys}<|user|>\n{query}<|assistant|>
        prompt = f"<|system|>\n{self.system_prompt}</s>\n"
        for msg in history[-2:]:
            role = msg.get("role", "user")
            prompt += f"<|{role}|>\n{msg.get('content')}</s>\n"
        prompt += f"<|user|>\n{message}</s>\n<|assistant|>\n"
        
        outputs = self.local_pipeline(prompt, max_new_tokens=256, do_sample=True, temperature=0.7)
        generated_text = outputs[0]['generated_text']
        # Extract only the assistant part
        return generated_text.split("<|assistant|>\n")[-1].strip()

    def _rule_based_fallback(self, message: str) -> str:
        """Simple keyword matching when no brain is available."""
        msg = message.lower()
        if "hello" in msg or "hi" in msg:
            return "Hello! Welcome to the library. How can I verify your books today?"
        if "book" in msg:
            return "I can help you find books. Try searching in the Catalog!"
        if "goal" in msg:
            return "You can set your reading goals in the 'My Goals' section."
        return "I'm currently operating in offline mode. Please check the Catalog for specific book inquiries."

# Singleton instance
brain = Orchestrator()

</file>

<file path="backend\brain\rag.py">
import chromadb
from chromadb.config import Settings
from sentence_transformers import SentenceTransformer
import os
from typing import List, Dict, Any

class RAGManager:
    """
    Manages Retrieval Augmented Generation (RAG) pipeline.
    - Stores knowledge in a local Vector Database (ChromaDB)
    - Retrieves relevant context for the Orchestrator
    """
    
    def __init__(self, persistence_path: str = "./backend/brain/data"):
        """
        Initialize the Vector DB and Embedding Model.
        """
        # Ensure data directory exists
        os.makedirs(persistence_path, exist_ok=True)
        
        print("üß† Loading RAG Engine...")
        
        # 1. Initialize Vector DB (ChromaDB)
        self.chroma_client = chromadb.PersistentClient(path=persistence_path)
        
        # 2. Initialize Neural Network for Embeddings
        # 'all-MiniLM-L6-v2' is fast, lightweight, and effective for local use.
        self.encoder = SentenceTransformer('all-MiniLM-L6-v2')
        
        # 3. Get or Create Collections
        self.book_collection = self.chroma_client.get_or_create_collection("books")
        self.rules_collection = self.chroma_client.get_or_create_collection("rules")
        
        print("‚úÖ RAG Engine Ready.")

    def add_book_to_memory(self, book_id: str, title: str, author: str, description: str, category: str):
        """
        Embeds a book and saves it to the vector store.
        """
        # Create a rich textual representation for embedding
        text_to_embed = f"{title} by {author}. Category: {category}. Description: {description}"
        
        # Add to ChromaDB (it will handle embedding automatically if we didn't use a custom encoder, 
        # but manual encoding is often more stable across environments).
        # Actually, let's use the built-in embedding function of Chroma or our own.
        # For control, we'll embed manually or just pass text if using default.
        # Let's pass text and let Chroma's default or our SentenceTransformer handle it.
        # To keep it simple, we'll generate embeddings manually.
        
        embedding = self.encoder.encode(text_to_embed).tolist()
        
        self.book_collection.upsert(
            documents=[text_to_embed],
            embeddings=[embedding],
            metadatas=[{
                "book_id": book_id, 
                "title": title, 
                "author": author, 
                "category": category
            }],
            ids=[str(book_id)]
        )

    def search_books(self, query: str, n_results: int = 3):
        """
        Semantic search for books based on a user query.
        """
        query_embedding = self.encoder.encode(query).tolist()
        
        results = self.book_collection.query(
            query_embeddings=[query_embedding],
            n_results=n_results
        )
        
        # Chroma returns lists of lists. Flatten for easier consumption.
        # results['metadatas'][0] contains the list of metadata dicts
        return results['metadatas'][0] if results['metadatas'] else []

# Singleton instance
rag = RAGManager()

</file>

<file path="backend\brain\__init__.py">
# backend/brain/__init__.py
# Makes the 'brain' directory a Python package
from .orchestrator import brain

</file>

<file path="backend\chat\message_engine.py">
from backend.repository.db_access import execute, fetch_all
from datetime import datetime

class MessageEngine:
    """
    Handles message persistence and retrieval.
    """
    
    @staticmethod
    def save_message(room_id, user_id, content, msg_type="text"):
        """Saves a message to the DB."""
        execute("""
            INSERT INTO chat_messages (room_id, user_id, content, msg_type)
            VALUES (%s, %s, %s, %s)
        """, (room_id, user_id, content, msg_type))
        return True

    @staticmethod
    def get_recent_messages(room_id, limit=50):
        """Fetches recent history for a room."""
        results = fetch_all("""
            SELECT 
                m.message_id, 
                m.content, 
                m.msg_type,
                m.created_at,
                u.user_id, 
                u.name as user_name, 
                u.profile_pic
            FROM chat_messages m
            JOIN users u ON m.user_id = u.user_id
            WHERE m.room_id = %s
            ORDER BY m.created_at DESC
            LIMIT %s
        """, (room_id, limit))
        
        # Convert date to ISO string for JSON serialization
        for msg in results:
            if msg.get('created_at'):
                msg['created_at'] = str(msg['created_at']).replace(" ", "T")
                
        return results

message_engine = MessageEngine()

</file>

<file path="backend\chat\room_manager.py">
from backend.repository.db_access import execute, fetch_all, fetch_one
from datetime import datetime

class RoomManager:
    """
    Manages logic for chat rooms, membership, and permissions.
    """
    
    @staticmethod
    def create_room(name, description, user_id, room_type="general", is_official=False):
        """Creates a new room."""
        # 1. Create Room
        room_id = execute("""
            INSERT INTO chat_rooms (name, description, created_by, is_official, room_type)
            VALUES (%s, %s, %s, %s, %s)
        """, (name, description, user_id, 1 if is_official else 0, room_type))
        
        # 2. Add Creator as Admin
        RoomManager.add_member(room_id, user_id, role='admin')
        
        return room_id

    @staticmethod
    def add_member(room_id, user_id, role="member"):
        """Adds a user to a room."""
        # Check if already exists
        exists = fetch_one("SELECT 1 FROM chat_members WHERE room_id=%s AND user_id=%s", (room_id, user_id))
        if exists:
            return False
            
        execute("""
            INSERT INTO chat_members (room_id, user_id, role)
            VALUES (%s, %s, %s)
        """, (room_id, user_id, role))
        return True

    @staticmethod
    def remove_member(room_id, user_id):
        execute("DELETE FROM chat_members WHERE room_id=%s AND user_id=%s", (room_id, user_id))

    @staticmethod
    def get_user_rooms(user_id):
        """Returns rooms the user is a member of."""
        return fetch_all("""
            SELECT r.*, m.role, m.joined_at
            FROM chat_rooms r
            JOIN chat_members m ON r.room_id = m.room_id
            WHERE m.user_id = %s
            ORDER BY m.joined_at DESC
        """, (user_id,))

    @staticmethod
    def get_public_rooms():
        """Returns list of public/official rooms."""
        return fetch_all("""
            SELECT * FROM chat_rooms 
            WHERE is_official = 1 OR room_type = 'public'
            ORDER BY created_at DESC
        """)

    @staticmethod
    def get_room_details(room_id):
        return fetch_one("SELECT * FROM chat_rooms WHERE room_id=%s", (room_id,))

    @staticmethod
    def is_member(room_id, user_id):
        res = fetch_one("SELECT 1 FROM chat_members WHERE room_id=%s AND user_id=%s", (room_id, user_id))
        return res is not None

room_manager = RoomManager()

</file>

<file path="backend\chat\socket_service.py">
from backend import socketio
from flask_socketio import emit, join_room, leave_room
from flask import request, session
from backend.services.channel_service import save_message, get_channel_messages
from backend.services.chat_service import get_or_create_anon_id, delete_message, edit_message # We might need to move these
# Actually, delete/edit should be in channel_service now or compatible. 
# For now, let's assume strict separation. I need to move edit/delete to ChannelService ideally.
# But for speed, I will use direct DB Access here if simple, or import from chat_service if compatible.
# Wait, chat_service operations work on 'chat_messages' table. 
# Since we only renamed the column, the SQL in chat_service might break if it uses 'room_id'.
# I need to update chat_service functions or implement them in channel_service.
# I WILL IMPLEMENT THEM IN channel_service NOW TO BE SAFE.

from backend.repository.db_access import execute, fetch_one
from backend.services.gateway_service import GatewayService
from backend.services.ingestion_service import IngestionService

# --- Helper functions for Edit/Delete in new architecture ---
def service_edit_message(user_id, message_id, new_content):
    anon_id = get_or_create_anon_id(user_id)
    # Check ownership
    msg = fetch_one("SELECT * FROM chat_messages WHERE message_id = %s", (message_id,))
    if not msg: return False
    if msg['anon_id'] != anon_id: return False
    
    execute("UPDATE chat_messages SET message_text = %s, is_edited = TRUE WHERE message_id = %s", (new_content, message_id))
    return True

def service_delete_message(user_id, message_id):
    anon_id = get_or_create_anon_id(user_id)
    msg = fetch_one("SELECT * FROM chat_messages WHERE message_id = %s", (message_id,))
    if not msg: return False
    
    # Allow self or admin (TODO: Check guild permissions for admin)
    if msg['anon_id'] != anon_id: return False 
    
    execute("UPDATE chat_messages SET is_deleted = TRUE WHERE message_id = %s", (message_id,))
    return True
# -----------------------------------------------------------

print("‚úÖ Loaded backend.chat.socket_service event handlers (Discord Arch)", flush=True)

@socketio.on('connect')
def handle_connect():
    user_id = session.get('user_id')
    if user_id:
        print(f"üîå User {session.get('name')} (ID: {user_id}) connected.", flush=True)

@socketio.on('disconnect')
def handle_disconnect():
    print(f"üîå User disconnected: {request.sid}")

@socketio.on('join_channel')
def handle_join_channel(data):
    """User joining a channel (initially called join_room)."""
    # Helper to support both 'room_id' (legacy frontend) and 'channel_id'
    channel_id = data.get('channel_id') or data.get('room_id')
    user_id = session.get('user_id')
    
    if channel_id is None: return

    print(f"üö™ Socket Join Channel: {channel_id}, User {user_id}", flush=True)

    # Verify Channel Exists
    channel = fetch_one("SELECT * FROM channels WHERE channel_id = %s", (channel_id,))
    if not channel:
        emit('error', {'message': 'Channel not found'})
        return

    # Join Socket Room (using channel_id as the room name)
    join_room(str(channel_id))
    
    # Fetch History
    try:
        raw_msgs = get_channel_messages(channel_id)
        # Format for Frontend (Frontend expects specific keys)
        formatted = []
        my_anon_id = get_or_create_anon_id(user_id)
        
        for m in raw_msgs:
            formatted.append({
                'message_id': m['message_id'],
                'content': m['content'],
                'created_at': m['created_at'], # Already formatted in service
                'sender_id': m['sender_id'],
                'sender_type': 'me' if m['anon_id'] == my_anon_id else 'other',
                'file_url': m['file_url'],
                'user_profile': {
                    'name': m['sender_name'] or 'Unknown',
                    'pic': m['sender_pic']
                },
                'sender_name': m['sender_name']
            })
        
        # Send history (Oldest first for scrolling)
        emit('message_history', {'messages': formatted[::-1]})
        
    except Exception as e:
        import traceback
        print(f"‚ùå Error fetching history: {e}")
        traceback.print_exc()
        emit('error', {'message': "Failed to load history"})


@socketio.on('send_message')
def handle_message(data):
    user_id = session.get('user_id')
    channel_id = data.get('channel_id') or data.get('room_id')
    content = data.get('message') or data.get('content')
    
    if not channel_id: return

    # --- RESTRICTION: Global Community (ID 1) is Admin-Only for posting ---
    try:
        if int(channel_id) == 1:
            role = session.get('role', 'member')
            if role != 'admin':
                emit('error', {'message': 'Only admins can post in the Global Community.'})
                return
    except ValueError:
        pass # Ignore invalid ID format

    # Anonymous Check
    # Prioritize payload flag (more reliable for real-time toggling)
    # But check session as fallback
    is_anon = data.get('is_anon')
    if is_anon is None:
        is_anon = session.get('is_anon', False)
    
    if is_anon:
        user_profile = {
            'name': 'Anonymous Member',
            'pic': 'default.jpg'
        }
    else:
        user_profile = {
            'name': session.get('name'),
            'pic': session.get('profile_pic', 'default.jpg')
        }
    
    attachment = data.get('attachment')
    reply_to_id = data.get('reply_to_id')

    success, result = IngestionService.process_message(
        user_id, channel_id, content, socketio, user_profile, attachment, reply_to_id
    )
    
    if success:
        # Confirm to sender (Optimistic Ack)
        result['sender_type'] = 'me'
        emit('receive_message', result)
    else:
        # Error (Rate Limit / Validation)
        emit('error', {'message': result})

@socketio.on('edit_message')
def handle_edit(data):
    if service_edit_message(session['user_id'], data['message_id'], data['new_content']):
        channel_id = data.get('channel_id') or data.get('room_id')
        emit('message_updated', {
            'message_id': data['message_id'],
            'new_content': data['new_content']
        }, to=str(channel_id))

@socketio.on('delete_message')
def handle_delete(data):
    if service_delete_message(session['user_id'], data['message_id']):
        channel_id = data.get('channel_id') or data.get('room_id')
        emit('message_deleted', {'message_id': data['message_id']}, to=str(channel_id))

@socketio.on('typing')
def handle_typing(data):
    # Architecture: Throttling could be added here via RateLimiter
    channel_id = data.get('channel_id') or data.get('room_id')
    emit('typing', {'user': session.get('name')}, to=str(channel_id), include_self=False)

@socketio.on('stop_typing')
def handle_stop_typing(data):
    channel_id = data.get('channel_id') or data.get('room_id')
    emit('stop_typing', {}, to=str(channel_id), include_self=False)

</file>

<file path="backend\chat\__init__.py">
# Init chat package

</file>

<file path="backend\config\config.py">
"""
config.py
---------
Application configuration management.
"""

import os
from pathlib import Path
from typing import Any, Dict, Optional

from dotenv import load_dotenv

# Load environment variables from .env file
env_path = Path(__file__).parent.parent.parent / '.env'
load_dotenv(dotenv_path=env_path)

class Config:
    """Base configuration class."""
    
    # Application settings
    DEBUG = False
    TESTING = False
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-key-change-me-in-production')
    
    # Database settings
    DB_HOST = os.getenv('DB_HOST', 'localhost')
    DB_PORT = int(os.getenv('DB_PORT', '3306'))
    DB_NAME = os.getenv('DB_NAME', 'library_db')
    DB_USER = os.getenv('DB_USER', 'app_user')
    DB_PASSWORD = os.getenv('DB_PASSWORD', '')
    
    # Session settings
    SESSION_COOKIE_SECURE = True
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Lax'
    
    # Security settings
    PASSWORD_SALT_ROUNDS = 12
    JWT_SECRET_KEY = os.getenv('JWT_SECRET_KEY', 'jwt-secret-change-me')
    JWT_ACCESS_TOKEN_EXPIRES = 3600  # 1 hour
    
    # File upload settings
    UPLOAD_FOLDER = str(Path(__file__).parent.parent / 'uploads')
    MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB max upload size
    ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'pdf'}
    
    # Email settings
    MAIL_SERVER = os.getenv('MAIL_SERVER', 'smtp.gmail.com')
    MAIL_PORT = int(os.getenv('MAIL_PORT', '587'))
    MAIL_USE_TLS = os.getenv('MAIL_USE_TLS', 'true').lower() == 'true'
    MAIL_USERNAME = os.getenv('MAIL_USERNAME', '')
    MAIL_PASSWORD = os.getenv('MAIL_PASSWORD', '')
    MAIL_DEFAULT_SENDER = os.getenv('MAIL_DEFAULT_SENDER', 'noreply@library.com')
    
    # AI settings
    GEMINI_API_KEY = os.getenv('GEMINI_API_KEY', '')
    
    # Logging
    LOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO').upper()
    
    @classmethod
    def get_db_uri(cls) -> str:
        """Get database connection URI."""
        return f"mysql+mysqlconnector://{cls.DB_USER}:{cls.DB_PASSWORD}@{cls.DB_HOST}:{cls.DB_PORT}/{cls.DB_NAME}"
    
    @classmethod
    def to_dict(cls) -> Dict[str, Any]:
        """Convert config to dictionary, excluding sensitive data."""
        return {
            'DEBUG': cls.DEBUG,
            'TESTING': cls.TESTING,
            'DB_HOST': cls.DB_HOST,
            'DB_PORT': cls.DB_PORT,
            'DB_NAME': cls.DB_NAME,
            'UPLOAD_FOLDER': cls.UPLOAD_FOLDER,
            'LOG_LEVEL': cls.LOG_LEVEL,
        }


class DevelopmentConfig(Config):
    """Development configuration."""
    DEBUG = True
    DB_NAME = os.getenv('DB_NAME', 'library_dev')
    LOG_LEVEL = os.getenv('LOG_LEVEL', 'DEBUG').upper()


class TestingConfig(Config):
    """Testing configuration."""
    TESTING = True
    DB_NAME = os.getenv('TEST_DB_NAME', 'library_test')
    WTF_CSRF_ENABLED = False


class ProductionConfig(Config):
    """Production configuration."""
    DB_NAME = os.getenv('DB_NAME', 'library_prod')
    LOG_LEVEL = os.getenv('LOG_LEVEL', 'WARNING').upper()


# Configuration dictionary
config = {
    'development': DevelopmentConfig,
    'testing': TestingConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}

def get_config(config_name: Optional[str] = None) -> Config:
    """Retrieve configuration by name."""
    if config_name is None:
        config_name = os.getenv('FLASK_ENV', 'development')
    return config.get(config_name.lower(), config['default'])

</file>

<file path="backend\config\db.py">
"""
db.py
------
Database connection management with connection pooling and environment validation.

Features:
- Connection pooling for better performance
- Environment variable validation
- Secure defaults
- Comprehensive error handling
"""

import os
import logging
from pathlib import Path
from typing import Optional, Dict, Any
import mysql.connector
from mysql.connector import Error, pooling
from dotenv import load_dotenv

# Initialize logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Load environment variables from .env file
env_path = Path(__file__).parent.parent.parent / '.env'
load_dotenv(dotenv_path=env_path)

# Environment variables we expect (used for warnings only)
REQUIRED_ENV_VARS = ['DB_HOST', 'DB_USER', 'DB_PASSWORD', 'DB_NAME', 'DB_PORT']

# Database connection pool
_connection_pool: Optional[pooling.MySQLConnectionPool] = None

def validate_environment() -> None:
    """Warn if some environment variables are missing; do not raise."""
    missing_vars = [var for var in REQUIRED_ENV_VARS if not os.getenv(var)]
    if missing_vars:
        logger.warning("Missing DB env vars: %s. Falling back to defaults where possible.", ", ".join(missing_vars))

def get_connection_config() -> Dict[str, Any]:
    """Get database configuration from environment variables."""
    return {
        "host": os.getenv("DB_HOST", "127.0.0.1"),
        "user": os.getenv("DB_USER", "app_user"),
        # WARNING: Default password is for development only. 
        # Always set DB_PASSWORD in production via environment variables.
        "password": os.getenv("DB_PASSWORD", "App@123"),
        "database": os.getenv("DB_NAME", "library_db"),
        "port": int(os.getenv("DB_PORT", 3306)),
        "charset": "utf8mb4",
        "use_unicode": True,
        "connect_timeout": 10,
        "auth_plugin": os.getenv("DB_AUTH_PLUGIN", "mysql_native_password"),
        # Pool configuration (extracted below)
        "pool_name": "library_pool",
        "pool_size": int(os.getenv("DB_POOL_SIZE", 5)),
        "pool_reset_session": True,
    }

def init_connection_pool() -> None:
    """Initialize the database connection pool."""
    global _connection_pool
    if _connection_pool is None:
        try:
            validate_environment()
            config = get_connection_config()
            
            # Extract pool-specific config
            pool_config = {
                'pool_name': config.pop('pool_name'),
                'pool_size': config.pop('pool_size'),
                'pool_reset_session': config.pop('pool_reset_session'),
            }
            
            _connection_pool = pooling.MySQLConnectionPool(
                **pool_config,
                **config
            )
            logger.info("Database connection pool initialized successfully")
            
        except Error as e:
            logger.error(f"Error initializing database connection pool: {e}")
            raise

def get_connection():
    """
    Get a database connection from the connection pool.
    
    Returns:
        MySQLConnection: A database connection object.
        
    Raises:
        RuntimeError: If connection pool is not initialized or connection fails.
    """
    global _connection_pool
    
    if _connection_pool is None:
        init_connection_pool()
    
    try:
        return _connection_pool.get_connection()
    except Error as e:
        logger.error(f"Error getting database connection: {e}")
        raise RuntimeError("Failed to get database connection") from e

# Do not initialize at import time; initialize lazily on first use

</file>

<file path="backend\config\logging_config.py">
"""
logging_config.py
----------------
Centralized logging configuration for the application.
"""

import os
import logging
from logging.handlers import RotatingFileHandler
from pathlib import Path
from typing import Dict, Any

# Create logs directory if it doesn't exist
LOG_DIR = Path(__file__).parent.parent.parent / 'logs'
LOG_DIR.mkdir(exist_ok=True)

# Log format
LOG_FORMAT = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
LOG_DATE_FORMAT = '%Y-%m-%d %H:%M:%S'
MAX_BYTES = 10 * 1024 * 1024  # 10 MB
BACKUP_COUNT = 5

# Log levels
LOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO').upper()
LOG_LEVELS = {
    'DEBUG': logging.DEBUG,
    'INFO': logging.INFO,
    'WARNING': logging.WARNING,
    'ERROR': logging.ERROR,
    'CRITICAL': logging.CRITICAL,
}

def get_logger(name: str) -> logging.Logger:
    """
    Get a configured logger instance.
    
    Args:
        name: Logger name (usually __name__)
        
    Returns:
        Configured logger instance
    """
    logger = logging.getLogger(name)
    logger.setLevel(LOG_LEVELS.get(LOG_LEVEL, logging.INFO))
    
    # Prevent adding handlers multiple times
    if not logger.handlers:
        # Console handler
        console_handler = logging.StreamHandler()
        console_formatter = logging.Formatter(LOG_FORMAT, LOG_DATE_FORMAT)
        console_handler.setFormatter(console_formatter)
        logger.addHandler(console_handler)
        
        # File handler
        log_file = LOG_DIR / 'library_app.log'
        file_handler = RotatingFileHandler(
            log_file,
            maxBytes=MAX_BYTES,
            backupCount=BACKUP_COUNT,
            encoding='utf-8'
        )
        file_formatter = logging.Formatter(LOG_FORMAT, LOG_DATE_FORMAT)
        file_handler.setFormatter(file_formatter)
        logger.addHandler(file_handler)
    
    return logger

def configure_logging() -> None:
    """Configure root logger and third-party loggers."""
    # Configure root logger
    root_logger = logging.getLogger()
    root_logger.setLevel(LOG_LEVELS.get(LOG_LEVEL, logging.INFO))
    
    # Configure third-party loggers
    for logger_name in ['sqlalchemy', 'mysql.connector']:
        logging.getLogger(logger_name).setLevel(logging.WARNING)
    
    # Configure our application logger
    logger = get_logger(__name__)
    logger.info("Logging configured successfully")

# Configure logging when module is imported
configure_logging()

</file>

<file path="backend\config\settings.py">
"""
settings.py
------------
Centralised application configuration file.

Purpose:
- Load environment variables once
- Expose clean Python constants
- Avoid calling os.getenv() everywhere
- Keep configuration separate from logic

This file is imported wherever configuration is needed.
"""

# ===============================
# IMPORTS
# ===============================

import os                      # Used to read environment variables
from dotenv import load_dotenv  # Loads variables from .env file into environment

# ===============================
# LOAD ENV FILE
# ===============================

# Reads the .env file and makes variables available via os.getenv()
# This should be done ONCE at application startup
load_dotenv()

# ===============================
# DATABASE SETTINGS
# ===============================

# Database host (IP or hostname)
DB_HOST = os.getenv("DB_HOST", "127.0.0.1")

# Database port (converted to int because env vars are strings)
DB_PORT = int(os.getenv("DB_PORT", 3306))

# Database name
DB_NAME = os.getenv("DB_NAME", "library_db")

# Database username
DB_USER = os.getenv("DB_USER", "app_user")

# Database password
# WARNING: Default password is for development only.
# Always set DB_PASSWORD in production via environment variables.
DB_PASSWORD = os.getenv("DB_PASSWORD", "App@123")

# ===============================
# FLASK SETTINGS
# ===============================

# Secret key used by Flask for:
# - Sessions
# - Flash messages
# - CSRF protection (if enabled)
FLASK_SECRET_KEY = os.getenv("FLASK_SECRET_KEY", "dev-secret")

# ===============================
# BUSINESS RULES (CENTRALISED)
# ===============================

# Maximum number of books a user can issue at once
MAX_BOOKS_PER_USER = 3

# Maximum number of days a book can be kept without fine
MAX_DAYS_ALLOWED = 7

# Fine charged per extra day (currency unit decided by system)
FINE_PER_DAY = 5

</file>

<file path="backend\config\__init__.py">

</file>

<file path="backend\middleware\auth.py">
from functools import wraps
from flask import redirect, url_for, session, flash, jsonify

def login_required(f):
    """
    Decorator to ensure the user is logged in.
    Redirects to the login page if not authenticated.
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            flash('Please log in to access this page.', 'warning')
            return redirect(url_for('auth.login'))
        return f(*args, **kwargs)
    return decorated_function

def member_required(f):
    """
    Decorator to ensure the user is a member.
    Redirects to the appropriate page if not a member.
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            flash('Please log in to access this page.', 'warning')
            return redirect(url_for('auth.login'))
            
        if session.get('role') not in ['member', 'admin']:
            flash('You do not have permission to access this page.', 'danger')
            return redirect(url_for('member.member_dashboard'))
            
        return f(*args, **kwargs)
    return decorated_function

def admin_required(f):
    """
    Decorator to ensure the user is an admin.
    Redirects to the appropriate page if not an admin.
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            flash('Please log in to access this page.', 'warning')
            return redirect(url_for('auth.login'))
            
        if session.get('role') != 'admin':
            flash('You do not have permission to access this page.', 'danger')
            return redirect(url_for('member.member_dashboard'))
            
        return f(*args, **kwargs)
    return decorated_function

def api_login_required(f):
    """
    API version of login_required that returns a 401 if not authenticated.
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return jsonify({
                'status': 'error',
                'message': 'Authentication required',
                'redirect': url_for('auth.login')
            }), 401
        return f(*args, **kwargs)
    return decorated_function

def api_member_required(f):
    """
    API version of member_required that returns a 403 if not a member.
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return jsonify({
                'status': 'error',
                'message': 'Authentication required',
                'redirect': url_for('auth.login')
            }), 401
            
        if session.get('role') != 'member':
            return jsonify({
                'status': 'error',
                'message': 'Insufficient permissions',
                'redirect': url_for('member.member_dashboard')
            }), 403
            
        return f(*args, **kwargs)
    return decorated_function

def api_admin_required(f):
    """
    API version of admin_required that returns a 403 if not an admin.
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return jsonify({
                'status': 'error',
                'message': 'Authentication required',
                'redirect': url_for('auth.login')
            }), 401
            
        if session.get('role') != 'admin':
            return jsonify({
                'status': 'error',
                'message': 'Insufficient permissions',
                'redirect': url_for('member.member_dashboard')
            }), 403
            
        return f(*args, **kwargs)
    return decorated_function

</file>

<file path="backend\middleware\__init__.py">
# This file makes the middleware directory a Python package

</file>

<file path="backend\models\book_model.py">
"""
book.py
--------
Domain model for Book.

Purpose:
- Represents a Book as a pure data object
- Contains NO database logic
- Contains NO business rules
- Used for clean data transfer between layers
"""

# ===============================
# IMPORTS
# ===============================

# dataclass is used to automatically generate:
# - __init__()
# - __repr__()
# - __eq__()
# and other boilerplate methods
from dataclasses import dataclass


# ===============================
# DOMAIN MODEL
# ===============================

@dataclass
class Book:
    """
    Book domain object.

    This class represents a single book record in the system.
    It mirrors the structure of the `books` table in the database
    but is NOT tied to database operations.

    Used for:
    - Clean data representation
    - Type safety
    - Readability
    - Passing data between services, repository, and views
    """

    # Unique identifier for the book (Primary Key)
    book_id: int

    # Title of the book
    title: str

    # Author name
    author: str

    # Category / genre of the book
    category: str

    # Total number of copies owned by the library
    total_copies: int

    # Number of copies currently available for issue
    available_copies: int

</file>

<file path="backend\models\user_model.py">
"""
user.py
--------
Domain model for User.

Purpose:
- Represents a user entity in the system
- Pure data structure (NO database logic)
- Used across authentication, services, and analytics
"""

# ===============================
# IMPORTS
# ===============================

# dataclass removes boilerplate by auto-generating:
# __init__, __repr__, __eq__, etc.
from dataclasses import dataclass

# datetime is used to store user creation timestamp
from datetime import datetime


# ===============================
# DOMAIN MODEL
# ===============================

@dataclass
class User:
    """
    User domain object.

    This class represents one user record from the `users` table.
    It is a clean, structured representation of user data.

    This class:
    - Does NOT handle login
    - Does NOT hash passwords
    - Does NOT access the database
    - Only holds user-related data
    """

    # Unique identifier for the user (Primary Key)
    user_id: int

    # Full name of the user
    name: str

    # Email address (used for login & identification)
    email: str

    # Role of the user (e.g., "admin", "member")
    role: str

    # Flag to enforce password change on first login
    must_change_password: bool

    # Timestamp when the user account was created
    created_at: datetime

</file>

<file path="backend\models\__init__.py">

</file>

<file path="backend\repository\db_access.py">
# ===============================
# REPOSITORY / DATA ACCESS LAYER
# ===============================
# This file acts as the ONLY layer that talks directly to the database.
# All SQL queries from services and routes pass through this file.
# This keeps database logic centralized and maintainable.

from backend.config.db import get_connection
# get_connection() is imported from db.py
# It is responsible ONLY for opening a database connection


# ===============================
# READ OPERATIONS
# ===============================

def fetch_all(query, params=None):
    """
    Fetch multiple rows from the database.

    Used for:
    - SELECT queries that return many rows
    - Lists (users, books, issues, reports, etc.)
    """

    # Create a new database connection
    conn = get_connection()

    # Create a cursor that returns rows as dictionaries
    # Example: {"user_id": 1, "name": "Admin"}
    cursor = conn.cursor(dictionary=True, buffered=True)

    try:
        # Execute the SQL query
        # params are safely injected to prevent SQL injection
        cursor.execute(query, params or ())

        # Fetch all matching rows from the database
        return cursor.fetchall()

    finally:
        # Always close cursor to free DB resources
        cursor.close()

        # Always close connection to avoid connection leaks
        conn.close()


def fetch_one(query, params=None):
    """
    Fetch a single row from the database.

    Used for:
    - Login checks
    - Fetching one user/book/issue by ID
    - Validations
    """

    # Create a new database connection
    conn = get_connection()

    # Create a dictionary cursor
    cursor = conn.cursor(dictionary=True, buffered=True)

    try:
        # Execute SQL query with parameters
        cursor.execute(query, params or ())

        # Fetch exactly one row (or None if no match)
        return cursor.fetchone()

    finally:
        # Close cursor
        cursor.close()

        # Close database connection
        conn.close()


# ---------------------------------------------------------------
# Compatibility alias used by some routes
# ---------------------------------------------------------------
def execute_query(query, params=None):
    """
    Compatibility wrapper around execute().
    Some routes import execute_query; keep this alias to avoid failures.
    """
    return execute(query, params)


# ===============================
# WRITE OPERATIONS
# ===============================

def execute(query, params=None):
    """
    Execute INSERT, UPDATE, or DELETE queries.

    Used for:
    - Creating users
    - Updating passwords
    - Issuing / returning books
    - Deleting records
    """

    # Create a new database connection
    conn = get_connection()

    # Cursor without dictionary mode (not needed for writes)
    cursor = conn.cursor(buffered=True)

    try:
        # Execute write query safely with parameters
        cursor.execute(query, params or ())

        # Commit the transaction to persist changes
        conn.commit()

        # If it's an INSERT, return the new ID
        if query.strip().upper().startswith("INSERT"):
            return cursor.lastrowid

        # Return number of affected rows
        return cursor.rowcount

    except Exception:
        # Roll back transaction if ANY error occurs
        # This protects data consistency
        conn.rollback()

        # Re-raise exception so caller knows something failed
        raise

    finally:
        # Close cursor
        cursor.close()

        # Close database connection
        conn.close()

</file>

<file path="backend\repository\__init__.py">

</file>

<file path="backend\routes\admin_routes.py">
"""
admin_routes.py
----------------
Defines ALL Flask routes that are accessible ONLY to ADMIN users.

DESIGN PRINCIPLES FOLLOWED:
- Routes handle HTTP only (request / response)
- Business logic is delegated to SERVICE layer
- No direct DB mutations in routes
- Clean separation of concerns (MVC / Clean Architecture)
"""

# =====================================================
# FLASK CORE IMPORTS
# =====================================================

from flask import (
    Blueprint,          # Groups admin-related routes
    render_template,    # Renders Jinja2 HTML templates
    session,            # Stores logged-in user info
    redirect,           # Redirects browser to another URL
    request,            # Reads POSTed form data
    flash,              # Sends messages to UI
    url_for             # Generates URLs for routes
)

# =====================================================
# INTERNAL PROJECT IMPORTS
# =====================================================

# DB read helper (single-row SELECT)
from backend.repository.db_access import fetch_one, fetch_all

# Access control decorator
from backend.utils.decorators import admin_required

# Service-layer functions (business logic)
from backend.services.user_service import view_users, add_user
from backend.services.book_service import view_books_paginated, view_books
from backend.services.issue_service import issue_book, return_book, send_overdue_reminders
from backend.services.request_service import get_pending_requests, process_request
from backend.services.report_service import most_issued_books, most_active_users, monthly_issue_count, export_report, book_category_distribution

# =====================================================
# BLUEPRINT DEFINITION
# =====================================================


# All admin routes will be registered under this blueprint
admin_bp = Blueprint("admin", __name__)


# =====================================================
# ADMIN DASHBOARD (GET)
# =====================================================

# =====================================================
# ADMIN OVERVIEW (DASHBOARD)
# =====================================================

@admin_bp.route("/dashboard")
@admin_bp.route("/admin/dashboard")
@admin_required
def admin_dashboard():
    """Renders the Admin Overview with statistics and analytics."""
    from backend.services.analytics_service import get_monthly_borrowing_stats, get_category_stats, get_user_engagement_stats, get_quick_stats
    
    quick_stats = get_quick_stats()
    monthly_stats = get_monthly_borrowing_stats()
    category_stats = get_category_stats()
    user_stats = get_user_engagement_stats()

    # Recent activity for overview
    recent_issues = fetch_all(
        """
        SELECT i.issue_id, u.name AS user_name, b.title AS book_title, i.issue_date
        FROM issues i
        JOIN users u ON i.user_id = u.user_id
        JOIN books b ON i.book_id = b.book_id
        ORDER BY i.issue_date DESC LIMIT 5
        """
    )

    return render_template(
        "admin/overview.html",
        active_page="admin_overview",
        quick_stats=quick_stats,
        monthly_stats=monthly_stats,
        category_stats=category_stats,
        user_stats=user_stats,
        recent_issues=recent_issues
    )


# =====================================================
# BOOK MANAGEMENT (GET)
# =====================================================

@admin_bp.route("/admin/books")
@admin_required
def admin_books_view():
    """Renders the Books Management page with pagination and metadata."""
    from backend.services.author_service import get_all_authors, get_all_series
    page = request.args.get('page', 1, type=int)
    search_query = request.args.get('q', '')
    
    pagination = view_books_paginated(page, 10, search_query)
    authors = get_all_authors()
    series_list = get_all_series()
    
    return render_template(
        "admin/books.html",
        active_page="admin_books",
        books=pagination['books'],
        total=pagination['total'],
        current_page=pagination['page'],
        total_pages=pagination['total_pages'],
        q=search_query,
        authors=authors,
        series_list=series_list
    )


@admin_bp.route("/admin/books/get/<int:book_id>")
@admin_required
def admin_get_book_json(book_id):
    """Securely returns book details for the Edit Modal."""
    from backend.services.book_service import get_book
    from flask import jsonify
    try:
        book = get_book(book_id)
        if not book:
            return jsonify({"error": "Book not found", "success": False}), 404
        return jsonify({"success": True, "data": book})
    except Exception as e:
        return jsonify({"error": str(e), "success": False}), 500


@admin_bp.route("/admin/book/add", methods=["POST"])
@admin_required
def admin_add_book_route():
    """Adds a new book with relational author/series support."""
    from backend.services.book_service import add_book
    from werkzeug.utils import secure_filename
    import os
    from datetime import datetime
    
    title = request.form.get("title")
    author_id = request.form.get("author_id", type=int)
    series_id = request.form.get("series_id", type=int) or None
    series_order = request.form.get("series_order", type=int) or None
    category = request.form.get("category")
    copies = request.form.get("copies", type=int)
    
    if not all([title, author_id, category, copies]):
        flash("‚ùå All required fields must be filled", "error")
        return redirect("/admin/books")
        
    p_src = None
    if 'pdf_file' in request.files:
        file = request.files['pdf_file']
        if file and file.filename != '':
            filename = secure_filename(f"ebook_{int(datetime.now().timestamp())}_{file.filename}")
            save_path = os.path.join("static", "uploads", "ebooks", filename)
            file.save(save_path)
            pdf_src = f"uploads/ebooks/{filename}"
            
    # MANUAL PIVOT: Handle New Author/Series Creation
    from backend.repository.db_access import fetch_one, execute
    
    # 1. Handle Author (ID or New Name)
    final_author_id = author_id
    new_author_name = request.form.get("new_author_name")
    if new_author_name and new_author_name.strip():
        # Check if exists
        existing_auth = fetch_one("SELECT author_id FROM authors WHERE name = %s", (new_author_name.strip(),))
        if existing_auth:
             final_author_id = existing_auth['author_id']
        else:
             execute("INSERT INTO authors (name) VALUES (%s)", (new_author_name.strip(),))
             final_author_id = fetch_one("SELECT author_id FROM authors WHERE name = %s", (new_author_name.strip(),))['author_id']
    
    # 2. Handle Series (ID or New Name)
    final_series_id = series_id
    new_series_name = request.form.get("new_series_name")
    if new_series_name and new_series_name.strip():
        existing_series = fetch_one("SELECT series_id FROM series WHERE name = %s", (new_series_name.strip(),))
        if existing_series:
            final_series_id = existing_series['series_id']
        else:
            execute("INSERT INTO series (name) VALUES (%s)", (new_series_name.strip(),))
            final_series_id = fetch_one("SELECT series_id FROM series WHERE name = %s", (new_series_name.strip(),))['series_id']

    # Add Book
    book_id = add_book(title, final_author_id, category, copies, pdf_src, final_series_id, series_order)
    
    # AI ENRICHMENT (Restored via Open Source)
    from backend.services.enrichment_service import enrich_book_metadata
    enrich_result = enrich_book_metadata(book_id)
    
    if isinstance(book_id, int):
        from backend.services.audit_service import log_action
        log_action(session.get('user_id'), "ADD_BOOK", f"Title: {title}")
        flash(f"‚úÖ Book added successfully! {enrich_result}")
    else:
        flash(book_id) # Error message

    return redirect("/admin/books")


@admin_bp.route("/admin/book/edit/<int:book_id>", methods=["POST"])
@admin_required
def admin_edit_book_route(book_id):
    """Updates book details."""
    from backend.services.book_service import update_book
    
    title = request.form.get("title")
    author_id = request.form.get("author_id", type=int)
    series_id = request.form.get("series_id", type=int) or None
    series_order = request.form.get("series_order", type=int) or None
    category = request.form.get("category")
    total_copies = request.form.get("copies", type=int)
    
    # MANUAL PIVOT: Handle New Author/Series Creation
    from backend.repository.db_access import fetch_one, execute
    
    # 1. Handle Author
    final_author_id = author_id
    new_author_name = request.form.get("new_author_name")
    if new_author_name and new_author_name.strip():
        existing_auth = fetch_one("SELECT author_id FROM authors WHERE name = %s", (new_author_name.strip(),))
        if existing_auth:
             final_author_id = existing_auth['author_id']
        else:
             execute("INSERT INTO authors (name) VALUES (%s)", (new_author_name.strip(),))
             final_author_id = fetch_one("SELECT author_id FROM authors WHERE name = %s", (new_author_name.strip(),))['author_id']
    
    # 2. Handle Series
    final_series_id = series_id
    new_series_name = request.form.get("new_series_name")
    if new_series_name and new_series_name.strip():
        existing_series = fetch_one("SELECT series_id FROM series WHERE name = %s", (new_series_name.strip(),))
        if existing_series:
            final_series_id = existing_series['series_id']
        else:
            execute("INSERT INTO series (name) VALUES (%s)", (new_series_name.strip(),))
            final_series_id = fetch_one("SELECT series_id FROM series WHERE name = %s", (new_series_name.strip(),))['series_id']

    if not all([title, author_id, category, total_copies]):
        flash("‚ùå Required fields are missing", "error")
        return redirect("/admin/books")

    result = update_book(book_id, title, final_author_id, category, total_copies, final_series_id, series_order)
    
    if "‚úÖ" in result:
        from backend.services.audit_service import log_action
        log_action(session.get('user_id'), "EDIT_BOOK", f"Book ID: {book_id}, Title: {title}")

    flash(result)
    return redirect("/admin/books")

@admin_bp.route("/admin/book/fetch-metadata", methods=["POST"])
@admin_required
def admin_fetch_metadata():
    """Fetches book details by ISBN from external APIs."""
    from backend.services.metadata_service import process_metadata_for_form
    data = request.get_json()
    isbn = data.get("isbn")
    
    if not isbn:
        return jsonify({"error": "ISBN is required"}), 400
        
    metadata = process_metadata_for_form(isbn)
    if not metadata:
        return jsonify({"error": "No data found for this ISBN"}), 404
        
    return jsonify(metadata)


@admin_bp.route("/admin/books/import", methods=["POST"])
@admin_required
def admin_import_books_route():
    """Bulk imports books from CSV and enriches them with AI."""
    from backend.services.book_service import add_book
    from backend.services.enrichment_service import enrich_book_metadata
    import pandas as pd
    
    if 'csv_file' not in request.files:
        flash("‚ùå No file selected", "error")
        return redirect("/admin/books")
        
    file = request.files['csv_file']
    if not file or file.filename == '':
        flash("‚ùå No file selected", "error")
        return redirect("/admin/books")
        
    try:
        # Load and normalize headers
        df = pd.read_csv(file)
        df.columns = [c.strip().lower() for c in df.columns]
        
        success_count = 0
        for _, row in df.iterrows():
            try:
                # Find or Create Author
                author_name = str(row['author']).strip()
                from backend.repository.db_access import fetch_one, execute
                author = fetch_one("SELECT author_id FROM authors WHERE name = %s", (author_name,))
                if not author:
                    execute("INSERT INTO authors (name) VALUES (%s)", (author_name,))
                    author = fetch_one("SELECT author_id FROM authors WHERE name = %s", (author_name,))
                
                # Add Book Record
                b_id = add_book(
                    str(row['title']).strip(), 
                    author['author_id'], 
                    str(row['category']).strip(), 
                    int(row['copies'])
                )
                
                # Trigger Background Intelligence enrichment
                if isinstance(b_id, int):
                    enrich_book_metadata(b_id)
                    success_count += 1
            except Exception as row_err:
                print(f"‚ö†Ô∏è Skipping import row: {row_err}")
                continue
                
        from backend.services.audit_service import log_action
        log_action(session.get('user_id'), "IMPORT_BOOKS", f"Bulk Import: {success_count} books enriched via AI.")
        flash(f"‚úÖ Successfully imported and enriched {success_count} books.")
    except Exception as e:
        flash(f"‚ùå Import failed: {str(e)}", "error")
            
    return redirect("/admin/books")


# =====================================================
# MODERN BOOKS MANAGEMENT (GET)
# =====================================================

@admin_bp.route("/books-management")
@admin_required
def books_management():
    """Renders the modern Books Management page with add/delete functionality."""
    books = view_books()
    return render_template(
        "books_management.html",
        active_page="books_management",
        books=books
    )


@admin_bp.route("/admin/books/export")
@admin_required
def admin_export_books():
    """Generates and downloads book catalog as CSV."""
    from backend.services.bulk_service import export_books_csv
    from flask import Response
    
    csv_data = export_books_csv()
    return Response(
        csv_data,
        mimetype="text/csv",
        headers={"Content-disposition": "attachment; filename=library_catalog_export.csv"}
    )

# Duplicate import route removed to resolve conflict and IndentationError. 
# Replaced by admin_import_books_route which includes AI background enrichment.


# =====================================================
# USER MANAGEMENT (GET)
# =====================================================

@admin_bp.route("/admin/users")
@admin_required
def admin_users_view():
    """Renders the User Management page."""
    users = view_users()
    return render_template(
        "admin/users.html",
        active_page="admin_users",
        users=users
    )

@admin_bp.route("/admin/user/tier", methods=["POST"])
@admin_required
def admin_update_user_tier_route():
    """Updates a user's membership tier."""
    from backend.services.membership_service import update_user_tier
    user_id = request.form.get("user_id", type=int)
    new_tier = request.form.get("tier")
    
    if not all([user_id, new_tier]):
        flash("‚ùå Missing data", "error")
        return redirect("/admin/users")
        
    result = update_user_tier(user_id, new_tier)
    flash(result)
    
    if "‚úÖ" in result:
        from backend.services.audit_service import log_action
        log_action(session.get('user_id'), "UPDATE_TIER", f"User: {user_id}, Tier: {new_tier}")
        
    return redirect("/admin/users")


# =====================================================
# BOOK MANAGEMENT (ADD/DELETE)
# =====================================================

@admin_bp.route("/admin/book/delete/<int:book_id>", methods=["POST"])
@admin_required
def admin_delete_book(book_id):
    """Deletes a book from the inventory."""
    from backend.repository.db_access import execute
    try:
        execute("DELETE FROM books WHERE book_id = %s", (book_id,))
        flash("‚úÖ Book deleted successfully!")
    except Exception as e:
        flash(f"‚ùå Error deleting book: {e}", "error")
    return redirect("/admin/books")


# =====================================================
# ISSUE/RETURN MANAGEMENT (GET)
# =====================================================

@admin_bp.route("/admin/issues")
@admin_required
def admin_issues_view():
    """Renders the Issue/Return Management page."""
    users = view_users()
    books = view_books()
    active_issues = fetch_all(
        """
        SELECT i.issue_id, u.name AS user_name, b.title AS book_title, i.issue_date
        FROM issues i
        JOIN users u ON i.user_id = u.user_id
        JOIN books b ON i.book_id = b.book_id
        WHERE i.return_date IS NULL
        ORDER BY i.issue_date DESC
        """
    )
    past_issues = fetch_all(
        """
        SELECT i.issue_id, u.name AS user_name, b.title AS book_title, i.issue_date, i.return_date, i.fine, i.fine_paid
        FROM issues i
        JOIN users u ON i.user_id = u.user_id
        JOIN books b ON i.book_id = b.book_id
        WHERE i.return_date IS NOT NULL
        ORDER BY i.return_date DESC
        """
    )

    return render_template(
        "admin/issues.html",
        active_page="admin_issues",
        users=users,
        books=books,
        active_issues=active_issues,
        past_issues=past_issues
    )


# =====================================================
# REQUEST MANAGEMENT (GET)
# =====================================================

@admin_bp.route("/admin/requests")
@admin_required
def admin_requests_view():
    """Renders the Pending Requests page."""
    pending_requests = get_pending_requests()
    if pending_requests is None:
        flash("‚ö†Ô∏è Database Error: 'book_requests' table missing.", "error")
        pending_requests = []
    
    return render_template(
        "admin/requests.html",
        active_page="admin_requests",
        pending_requests=pending_requests
    )


# =====================================================
# BOOK SUGGESTIONS (GET)
# =====================================================

@admin_bp.route("/admin/suggestions")
@admin_required
def admin_suggestions_view():
    """Renders the Book Suggestions page with member recommendations."""
    try:
        # Helper to get available columns
        try:
            cols = fetch_all("SHOW COLUMNS FROM book_suggestions")
            available_columns = {c['Field'] for c in cols}
        except:
            available_columns = set()

        if not available_columns:
            flash("‚ö†Ô∏è Database Error: 'book_suggestions' table not found.", "error")
            suggestions = []
        else:
            # 1. Notes / Reason
            notes_col = "notes"
            if "notes" not in available_columns and "reason" in available_columns:
                notes_col = "reason"
            
            # 2. Date
            date_col = "created_at"
            if "created_at" not in available_columns and "suggestion_date" in available_columns:
                date_col = "suggestion_date"

            # Construct Query with aliases for template compatibility
            # Template likely expects: suggestion_id, user_name, email, title, author, reason (or notes), suggestion_date, status
            query = f"""
            SELECT 
                bs.suggestion_id, 
                bs.user_id, 
                u.name AS user_name, 
                u.email, 
                bs.title, 
                bs.author, 
                bs.{notes_col} AS reason, 
                bs.{date_col} AS suggestion_date, 
                bs.status
            FROM book_suggestions bs
            JOIN users u ON bs.user_id = u.user_id
            ORDER BY bs.{date_col} DESC
            """
            
            suggestions = fetch_all(query)
            
            if suggestions is None:
                suggestions = []
                
    except Exception as e:
        flash(f"‚ö†Ô∏è Error loading suggestions: {str(e)}", "error")
        suggestions = []
    
    return render_template(
        "admin/suggestions.html",
        active_page="admin_suggestions",
        suggestions=suggestions
    )


# =====================================================
# APPROVE BOOK SUGGESTION (POST)
# =====================================================

@admin_bp.route("/admin/suggestion/approve/<int:suggestion_id>", methods=["POST"])
@admin_required
def admin_approve_suggestion(suggestion_id):
    """Approves a book suggestion and moves it to the Purchase List."""
    try:
        from backend.repository.db_access import execute_query
        execute_query(
            "UPDATE book_suggestions SET status = %s WHERE suggestion_id = %s",
            ("approved", suggestion_id)
        )
        flash("‚úÖ Suggestion approved! Book moved to Purchase List.", "success")
    except Exception as e:
        flash(f"‚ùå Error approving suggestion: {str(e)}", "error")
    
    return redirect("/admin/suggestions")


# =====================================================
# REJECT BOOK SUGGESTION (POST)
# =====================================================

@admin_bp.route("/admin/suggestion/reject/<int:suggestion_id>", methods=["POST"])
@admin_required
def admin_reject_suggestion(suggestion_id):
    """Rejects a book suggestion."""
    try:
        from backend.repository.db_access import execute_query
        execute_query(
            "UPDATE book_suggestions SET status = %s WHERE suggestion_id = %s",
            ("rejected", suggestion_id)
        )
        flash("‚úÖ Suggestion rejected.", "success")
    except Exception as e:
        flash(f"‚ùå Error rejecting suggestion: {str(e)}", "error")
    
    return redirect("/admin/suggestions")


# =====================================================
# PURCHASE LIST MANAGEMENT
# =====================================================

@admin_bp.route("/admin/purchase-list")
@admin_required
def admin_purchase_list_view():
    """Renders the Purchase List (Approved Suggestions)."""
    try:
        # Helper to get available columns
        try:
            cols = fetch_all("SHOW COLUMNS FROM book_suggestions")
            available_columns = {c['Field'] for c in cols}
        except:
            available_columns = set()

        if not available_columns:
            flash("‚ö†Ô∏è Database Error: 'book_suggestions' table missing.", "error")
            pending_purchases = []
        else:
            # 1. Notes / Reason
            notes_col = "notes"
            if "notes" not in available_columns and "reason" in available_columns:
                notes_col = "reason"
            
            # 2. Date
            date_col = "created_at"
            if "created_at" not in available_columns and "suggestion_date" in available_columns:
                date_col = "suggestion_date"

            # Construct Query (LEFT JOIN to include admin-added entries with NULL user_id)
            query = f"""
            SELECT 
                bs.suggestion_id, 
                bs.user_id, 
                COALESCE(u.name, 'Admin') AS user_name,
                bs.title, 
                bs.author, 
                bs.{notes_col} AS reason, 
                bs.{date_col} AS suggestion_date, 
                bs.status
            FROM book_suggestions bs
            LEFT JOIN users u ON bs.user_id = u.user_id
            WHERE bs.status = 'approved'
            ORDER BY bs.{date_col} DESC
            """
            
            pending_purchases = fetch_all(query)
            if pending_purchases is None:
                pending_purchases = []
                
    except Exception as e:
        flash(f"‚ö†Ô∏è Error loading purchase list: {str(e)}", "error")
        pending_purchases = []
    
    return render_template(
        "admin/purchase_list.html",
        active_page="admin_purchase_list",
        pending_purchases=pending_purchases
    )


@admin_bp.route("/admin/purchase-list/add/<int:suggestion_id>", methods=["POST"])
@admin_required
def admin_add_purchased_book(suggestion_id):
    """
    Finalizes purchase:
    1. Adds book to inventory
    2. Marks suggestion as 'completed'
    """
    try:
        from backend.repository.db_access import execute_query, fetch_all, fetch_one
        from backend.services.book_service import add_book
        
        # 1. Fetch details
        try:
            cols = fetch_all("SHOW COLUMNS FROM book_suggestions")
            available_columns = {c['Field'] for c in cols}
        except:
            available_columns = set()
            
        title_col = "title"
        author_col = "author"
        category_col = "category" if "category" in available_columns else None
        
        select_cols = f"{title_col}, {author_col}"
        if category_col:
            select_cols += f", {category_col}"
            
        suggestion = fetch_one(f"SELECT {select_cols} FROM book_suggestions WHERE suggestion_id = %s", (suggestion_id,))
        
        if not suggestion:
            flash("‚ùå Order not found.", "error")
            return redirect("/admin/purchase-list")
            
        # 2. Add to Library
        title = suggestion.get('title')
        author = suggestion.get('author')
        category = suggestion.get('category', 'General')
        
        result = add_book(title, author, category, 1) # Add 1 copy
        
        if "‚ùå" in result:
            flash(result, "error")
            return redirect("/admin/purchase-list")
            
        # 3. Mark as Completed (HANDLING ENUM ISSUE properly)
        try:
            execute_query(
                "UPDATE book_suggestions SET status = %s WHERE suggestion_id = %s",
                ("completed", suggestion_id)
            )
        except Exception as e:
            # If ENUM error, try to expand it (Only works if user has permissions, but worth a try)
            # OR fallback to deleting the suggestion since it's now a real book
            if "Data truncated" in str(e) or "Review your MySQL error" in str(e):
                try:
                    execute_query("ALTER TABLE book_suggestions MODIFY COLUMN status ENUM('pending','approved','rejected','completed')")
                    execute_query(
                        "UPDATE book_suggestions SET status = %s WHERE suggestion_id = %s",
                        ("completed", suggestion_id)
                    )
                except:
                    # Fallback: Just delete it if we can't mark it completed
                    # This prevents it from staying in the list forever
                    execute_query("DELETE FROM book_suggestions WHERE suggestion_id = %s", (suggestion_id,))
                    flash(f"‚úÖ Book added! (Order removed from list)", "success")
                    return redirect("/admin/purchase-list")
                    
        flash(f"‚úÖ Book purchased and added to library: {title}", "success")
        
    except Exception as e:
        flash(f"‚ùå Error processing purchase: {str(e)}", "error")
        
    return redirect("/admin/purchase-list")


@admin_bp.route("/admin/purchase-list/remove/<int:suggestion_id>", methods=["POST"])
@admin_required
def admin_remove_purchase(suggestion_id):
    """
    Removes a book from the purchase list (sets status to 'rejected').
    """
    try:
        from backend.repository.db_access import execute_query
        execute_query(
            "UPDATE book_suggestions SET status = %s WHERE suggestion_id = %s",
            ("rejected", suggestion_id)
        )
        flash("‚úÖ Item removed from purchase list.", "success")
    except Exception as e:
        flash(f"‚ùå Error removing item: {str(e)}", "error")
    
    return redirect("/admin/purchase-list")


@admin_bp.route("/admin/purchase/add-manual", methods=["POST"])
@admin_required
def admin_add_manual_purchase():
    """
    Adds a book to the purchase list manually (not from member suggestion).
    """
    try:
        from backend.repository.db_access import execute_query
        
        title = request.form.get("title", "").strip()
        author = request.form.get("author", "").strip()
        notes = request.form.get("notes", "").strip()
        
        if not title or not author:
            flash("‚ùå Title and Author are required.", "error")
            return redirect("/admin/purchase-list")
        
        # Insert into book_suggestions with NULL user_id (indicates admin-added)
        # and status = 'approved' so it appears in purchase list
        execute_query(
            """
            INSERT INTO book_suggestions (user_id, title, author, reason, status, created_at)
            VALUES (NULL, %s, %s, %s, 'approved', NOW())
            """,
            (title, author, notes if notes else "Admin added")
        )
        
        flash(f"‚úÖ Added to purchase list: {title} by {author}", "success")
        
    except Exception as e:
        flash(f"‚ùå Error adding to purchase list: {str(e)}", "error")
    
    return redirect("/admin/purchase-list")


# =====================================================
# REPORTS & ANALYTICS (GET)
# =====================================================

@admin_bp.route("/reports")
@admin_required
def admin_reports():
    """
    Renders the Library Insights page with 10 analytics widgets.
    """
    from collections import namedtuple
    from backend.services.report_service import (
        most_issued_books, most_active_users, 
        monthly_issue_count, book_category_distribution
    )
    from backend.repository.db_access import fetch_one
    
    ReportData = namedtuple('ReportData', ['most_issued', 'active_users', 'monthly', 'categories'])
    
    # Fetch data from services
    most_issued = most_issued_books()
    active_users = most_active_users()
    monthly = monthly_issue_count()
    categories = book_category_distribution()
    
    # Fetch quick stats
    total_books = fetch_one("SELECT COUNT(*) as cnt FROM books")
    total_members = fetch_one("SELECT COUNT(*) as cnt FROM users WHERE role = 'member'")
    active_issues = fetch_one("SELECT COUNT(*) as cnt FROM issues WHERE return_date IS NULL")
    
    # Use fine > 0 as proxy for overdue since we don't have due_date column
    overdue_books = fetch_one("""
        SELECT COUNT(*) as cnt FROM issues 
        WHERE return_date IS NULL AND fine > 0
    """)
    
    # Check if created_at column exists in books, otherwise skip
    try:
        new_books_month = fetch_one("""
            SELECT COUNT(*) as cnt FROM books 
            WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
        """)
    except:
        new_books_month = {'cnt': 0}
        
    total_fines = fetch_one("SELECT COALESCE(SUM(fine), 0) as total FROM issues WHERE fine > 0")
    pending_fines = fetch_one("""
        SELECT COALESCE(SUM(fine), 0) as total FROM issues 
        WHERE fine > 0 AND return_date IS NULL
    """)
    returned_issues = fetch_one("SELECT COUNT(*) as cnt FROM issues WHERE return_date IS NOT NULL")
    
    quick_stats = {
        "total_books": total_books['cnt'] if total_books else 0,
        "total_members": total_members['cnt'] if total_members else 0,
        "active_issues": active_issues['cnt'] if active_issues else 0,
        "overdue_books": overdue_books['cnt'] if overdue_books else 0,
        "new_books_month": new_books_month['cnt'] if new_books_month else 0,
        "total_fines": float(total_fines['total']) if total_fines else 0,
        "pending_fines": float(pending_fines['total']) if pending_fines else 0,
    }

    # Prepare data for charts (frontend expects lists of values)
    chart_data = {
        "monthlyLabels": [r['month'] for r in monthly],
        "monthlyValues": [r['total_issues'] for r in monthly],
        "categoryLabels": [r['category'] for r in categories],
        "categoryValues": [r['book_count'] for r in categories],
        "activeIssues": quick_stats['active_issues'],
        "returnedIssues": returned_issues['cnt'] if returned_issues else 0,
        "statusValues": [quick_stats['active_issues'], returned_issues['cnt'] if returned_issues else 0]
    }
    
    data = ReportData(
        most_issued=most_issued,
        active_users=active_users,
        monthly=monthly,
        categories=categories
    )

    return render_template(
        "reports.html",
        active_page="admin_reports",
        data=data,
        chart_data=chart_data,
        quick_stats=quick_stats
    )


# =====================================================
# COMMUNITY HUB (GET/POST)
# =====================================================

@admin_bp.route("/admin/community")
@admin_required
def admin_community_hub():
    """Renders the Community Hub dashboard."""
    return render_template(
        "admin/community_hub.html",
        active_page="admin_community"
    )

@admin_bp.route("/admin/api/logs")
@admin_required
def admin_get_logs_api():
    """Returns system audit logs."""
    from backend.repository.db_access import fetch_all
    try:
        # Get logs with user names
        logs = fetch_all("""
            SELECT l.*, u.name as user_name, u.profile_pic, c.name as channel_name 
            FROM audit_logs l
            LEFT JOIN users u ON l.user_id = u.user_id
            LEFT JOIN channels c ON l.channel_id = c.channel_id
            ORDER BY l.timestamp DESC LIMIT 100
        """)
        
        # Format for JSON
        formatted = []
        for l in logs:
            formatted.append({
                'id': l['log_id'],
                'user': l['user_name'] or 'Unknown',
                'user_pic': l['profile_pic'],
                'action': l['action_type'],
                'details': l['details'],
                'channel': l['channel_name'] or 'General',
                'time': l['timestamp'].strftime('%Y-%m-%d %H:%M:%S') if l['timestamp'] else ''
            })
            
        return {"success": True, "logs": formatted}
    except Exception as e:
        return {"success": False, "error": str(e)}, 500

@admin_bp.route("/admin/api/chats")
@admin_required
def admin_get_chats_api():
    """Returns active chat groups."""
    from backend.repository.db_access import fetch_all
    try:
        # Get all channels except Global Chat (ID 1) typically
        # But user asked for list showing chat database which implies everything or groups
        chats = fetch_all("""
            SELECT c.channel_id, c.name, c.type, c.created_at, u.name as owner_name,
            (SELECT COUNT(*) FROM chat_messages WHERE channel_id = c.channel_id) as msg_count
            FROM channels c
            LEFT JOIN users u ON c.created_by = u.user_id
            ORDER BY msg_count DESC
        """)
        
        return {"success": True, "chats": chats}
    except Exception as e:
        return {"success": False, "error": str(e)}, 500

@admin_bp.route("/admin/api/chat/delete/<int:channel_id>", methods=["POST"])
@admin_required
def admin_delete_chat(channel_id):
    """Deletes a specific chat channel."""
    from backend.repository.db_access import execute
    
    if channel_id == 1:
        return {"success": False, "error": "Cannot delete Global Community"}, 403
        
    try:
        execute("DELETE FROM chat_messages WHERE channel_id = %s", (channel_id,))
        execute("DELETE FROM dm_participants WHERE channel_id = %s", (channel_id,))
        execute("DELETE FROM chat_invitations WHERE target_channel_id = %s", (channel_id,))
        execute("DELETE FROM channels WHERE channel_id = %s", (channel_id,))
        return {"success": True}
    except Exception as e:
        return {"success": False, "error": str(e)}, 500

@admin_bp.route("/admin/api/chat/wipe", methods=["POST"])
@admin_required
def admin_wipe_chats():
    """
    DANGER: Wipes all chat data except Global Community (ID 1).
    """
    from backend.repository.db_access import execute
    try:
        # 1. Delete messages from non-global channels
        execute("DELETE FROM chat_messages WHERE channel_id != 1")
        
        # 2. Delete invitations
        execute("DELETE FROM chat_invitations")
        
        # 3. Delete participants from non-global channels
        execute("DELETE FROM dm_participants WHERE channel_id != 1")
        
        # 4. Delete channels (except ID 1)
        execute("DELETE FROM channels WHERE channel_id != 1")
        
        # 5. Optionally clear logs if requested, but usually separate. 
        # User said "clean wipe all chat dataset and only keep global community"
        
        # Log this administrative action
        from backend.services.audit_service import log_action
        log_action(session.get('user_id'), "WIPE_CHATS", "Administrator wiped all non-global chat data.")
        
        return {"success": True}
    except Exception as e:
        return {"success": False, "error": str(e)}, 500




@admin_bp.route("/admin/system/health")
@admin_required
def admin_health_view():
    """Renders the System Health Monitoring page."""
    from backend.services.health_service import get_system_health, get_error_logs
    health_data = get_system_health()
    error_logs = get_error_logs()
    
    return render_template(
        "admin/health.html",
        active_page="admin_health",
        health=health_data,
        logs=error_logs
    )

# Legacy author/series routes removed to resolve duplicated endpoint conflict.
# Consolidated logic resides at the end of this file with AI background support.

@admin_bp.route("/admin/overdue-reminders", methods=["POST"])
@admin_required
def send_overdue_reminders_route():
    """Triggers mass email notifications for overdue books."""
    from backend.services.issue_service import send_overdue_reminders
    result = send_overdue_reminders()
    flash(result)
    return redirect("/reports")


# =====================================================
# REPORT EXPORTS (GET)
# =====================================================

@admin_bp.route("/reports/export/<report_type>")
@admin_required
def admin_export_report(report_type):
    """
    Triggers CSV export for a specific report.
    """
    from backend.services.report_service import (
        most_issued_books, most_active_users, 
        monthly_issue_count, export_report
    )

    if report_type == "most_issued":
        df = most_issued_books()
        filename = "most_issued_books"
    elif report_type == "active_users":
        df = most_active_users()
        filename = "active_users"
    elif report_type == "monthly":
        df = monthly_issue_count()
        filename = "monthly_issues"
    else:
        flash("‚ùå Invalid report type", "error")
        return redirect("/reports")

    result = export_report(df, filename)
    flash(result)
    return redirect("/reports")



# =====================================================
# ISSUE BOOK (POST)
# =====================================================

@admin_bp.route("/admin/issue", methods=["POST"])
@admin_required
def admin_issue_book():
    """
    Issues a book to a user.

    Triggered when admin submits:
    - Issue Book form

    URL:
        POST /admin/issue
    """

    # -------------------------------------------------
    # STEP 1: READ FORM DATA
    # -------------------------------------------------
    user_id = request.form.get("user_id")
    book_id = request.form.get("book_id")

    # -------------------------------------------------
    # STEP 2: VALIDATE INPUT
    # -------------------------------------------------
    if not user_id or not book_id:
        flash("‚ùå User ID and Book ID are required", "error")
        return redirect("/admin/issues")

    # -------------------------------------------------
    # STEP 3: SERVICE LAYER CALL
    # -------------------------------------------------
    try:
        # Convert inputs to integers (SAFE)
        uid = int(user_id)
        bid = int(book_id)

        # Business rules, limits, transactions are handled
        # inside issue_service.issue_book()
        result = issue_book(uid, bid)

    except ValueError:
        result = "‚ùå Invalid User ID or Book ID (Must be numeric)"

    # -------------------------------------------------
    # STEP 4: FEEDBACK + REDIRECT
    # -------------------------------------------------
    flash(result)
    return redirect("/admin/issues")


# =====================================================
# RETURN BOOK (POST)
# =====================================================

@admin_bp.route("/admin/return", methods=["POST"])
@admin_required
def admin_return_book():
    """
    Returns a previously issued book.

    Triggered when admin submits:
    - Return Book form

    URL:
        POST /admin/return
    """

    # -------------------------------------------------
    # STEP 1: READ FORM DATA
    # -------------------------------------------------
    user_id = request.form.get("user_id")
    book_id = request.form.get("book_id")

    # -------------------------------------------------
    # STEP 2: VALIDATE INPUT
    # -------------------------------------------------
    if not user_id or not book_id:
        flash("‚ùå User ID and Book ID are required", "error")
        return redirect("/admin/issues")

    # -------------------------------------------------
    # STEP 3: SERVICE LAYER CALL
    # -------------------------------------------------
    try:
        # Convert inputs to integers (SAFE)
        uid = int(user_id)
        bid = int(book_id)

        # Handles:
        # - Finding active issue
        # - Fine calculation
        # - Transaction safety
        result = return_book(uid, bid)

    except ValueError:
        result = "‚ùå Invalid User ID or Book ID (Must be numeric)"

    # -------------------------------------------------
    # STEP 4: FEEDBACK + REDIRECT
    # -------------------------------------------------
    flash(result)
    return redirect("/admin/issues")



@admin_bp.route("/admin/fine/pay/<int:issue_id>", methods=["POST"])
@admin_required
def admin_pay_fine_route(issue_id):
    """
    Marks a fine as paid.
    """
    from backend.services.issue_service import pay_fine
    result = pay_fine(issue_id)
    if "‚úÖ" in result:
        from backend.services.audit_service import log_action
        log_action(session.get('user_id'), "PAY_FINE", f"Issue ID: {issue_id}")
    flash(result)
    return redirect("/admin/issues")


# =====================================================
# REQUEST MANAGEMENT (POST)
# =====================================================

@admin_bp.route("/admin/request/approve", methods=["POST"])
@admin_required
def approve_request_route():
    request_id = request.form.get("request_id")
    result = process_request(request_id, "approve")
    if "‚úÖ" in result:
        from backend.services.audit_service import log_action
        log_action(session.get('user_id'), "APPROVE_REQUEST", f"Request ID: {request_id}")
    flash(result)
    return redirect("/admin/requests")

@admin_bp.route("/admin/request/reject", methods=["POST"])
@admin_required
def reject_request_route():
    request_id = request.form.get("request_id")
    result = process_request(request_id, "reject")
    flash(result)
    return redirect("/admin/requests")


# =====================================================
# USER MANAGEMENT (POST)
# =====================================================

@admin_bp.route("/admin/user/add", methods=["POST"])
@admin_required
def admin_add_user():
    """
    Creates a new user account.
    """
    name = request.form.get("name")
    email = request.form.get("email")
    password = request.form.get("password")
    role = request.form.get("role")

    if not name or not email or not password or not role:
        flash("‚ùå All fields are required", "error")
        return redirect("/admin/users")

    result = add_user(name, email, role, password)
    if "‚úÖ" in result:
        from backend.services.audit_service import log_action
        log_action(session.get('user_id'), "ADD_USER", f"Email: {email}")
    flash(result)
    return redirect("/admin/users")


@admin_bp.route("/admin/user/delete/<int:user_id>", methods=["POST"])
@admin_required
def admin_delete_user(user_id):
    """
    Deletes a user account.
    """
    from backend.services.user_service import delete_user
    
    # Prevent admin from deleting themselves
    if user_id == session.get("user_id"):
        flash("‚ùå You cannot delete your own admin account while logged in.", "error")
        return redirect("/admin/users")

    result = delete_user(user_id)
    if "‚úÖ" in result:
        from backend.services.audit_service import log_action
        log_action(session.get('user_id'), "DELETE_USER", f"Deleted User ID: {user_id}")
    flash(result)
    return redirect("/admin/users")


@admin_bp.route("/admin/audit-logs")
@admin_required
def admin_audit_logs_route():
    """Renders the Audit Logs page."""
    from backend.services.audit_service import get_audit_logs
    logs = get_audit_logs(100)
    return render_template("admin/audit_logs.html", active_page="admin_audit", logs=logs)


@admin_bp.route("/admin/scanner")
@admin_required
def admin_scanner_route():
    """Renders the QR/Barcode Scanner."""
    return render_template("admin/scanner.html", active_page="admin_scanner")


@admin_bp.route("/admin/support")
@admin_required
def admin_support_route():
    from backend.services.support_service import get_all_tickets
    tickets = get_all_tickets()
    return render_template("admin/support.html", active_page="admin_support", tickets=tickets)

@admin_bp.route("/admin/support/<int:ticket_id>", methods=["GET", "POST"])
@admin_required
def admin_ticket_view(ticket_id):
    from backend.services.support_service import get_ticket_details, add_reply, close_ticket
    
    if request.method == "POST":
        action = request.form.get("action")
        if action == "reply":
            msg = request.form.get("message")
            result = add_reply(ticket_id, session["user_id"], msg)
            flash(result)
        elif action == "close":
            result = close_ticket(ticket_id)
            flash(result)
        return redirect(f"/admin/support/{ticket_id}")
        
    data = get_ticket_details(ticket_id)
    return render_template("admin/ticket_view.html", active_page="admin_support", **data)


@admin_bp.route("/admin/settings", methods=["GET", "POST"])
@admin_required
def admin_settings_route():
    from backend.services.settings_service import (
        is_maintenance_mode, set_maintenance_mode, 
        get_category_fines, update_category_fine, delete_category_fine,
        get_all_settings, update_settings
    )
    
    if request.method == "POST":
        from backend.services.audit_service import log_action
        action = request.form.get("action")
        if action == "maintenance":
            status = request.form.get("maintenance_mode") == "true"
            result = set_maintenance_mode(status)
            log_action(session["user_id"], "SET_MAINTENANCE", f"Status: {status}")
            flash(result)
        elif action == "update_fine":
            cat = request.form.get("category")
            rate = request.form.get("rate")
            result = update_category_fine(cat, rate)
            log_action(session["user_id"], "UPDATE_FINE", f"Category: {cat}, Rate: {rate}")
            flash(result)
        elif action == "delete_fine":
            cat = request.form.get("category")
            result = delete_category_fine(cat)
            log_action(session["user_id"], "DELETE_FINE", f"Category: {cat}")
            flash(result)
        elif action == "update_general":
            # List of all possible keys to capture from form
            keys = [
                "library_name", "library_tagline", "branding_emoji", 
                "library_email", "library_phone", "library_address",
                "max_books_per_user", "default_issue_days", "max_renewals",
                "reservation_expiry_days", "max_pending_requests",
                "currency_symbol", "daily_fine_rate", "fine_grace_period", "fine_cap",
                "default_theme", "pagination_size", "show_cover_images",
                "sidebar_style", "accent_color", "registration_mode", "allow_suggestions"
            ]
            new_settings = {k: request.form.get(k) for k in keys if request.form.get(k) is not None}
            result = update_settings(new_settings)
            log_action(session["user_id"], "UPDATE_GENERAL_SETTINGS", "Updated comprehensive library config")
            flash(result)
        return redirect("/admin/settings")
        
    m_mode = is_maintenance_mode()
    fines = get_category_fines()
    all_settings = get_all_settings()
    return render_template("admin/settings.html", 
        active_page="admin_settings", 
        maintenance_mode=m_mode, 
        category_fines=fines,
        settings=all_settings
    )

@admin_bp.route("/admin/authors")
@admin_required
def admin_authors_view():
    """Renders the Authors Management page."""
    from backend.repository.db_access import fetch_all
    authors = fetch_all("SELECT * FROM authors ORDER BY name ASC")
    return render_template("admin/authors.html", active_page="admin_authors", authors=authors)

@admin_bp.route("/admin/authors/edit/<int:author_id>", methods=["POST"])
@admin_required
def admin_edit_author(author_id):
    """Updates author biography and metadata."""
    from backend.repository.db_access import execute
    bio = request.form.get("bio")
    nationality = request.form.get("nationality")
    execute("UPDATE authors SET bio = %s, nationality = %s WHERE author_id = %s", (bio, nationality, author_id))
    flash("‚úÖ Author updated successfully")
    return redirect("/admin/authors")

@admin_bp.route("/admin/series")
@admin_required
def admin_series_view():
    """Renders the Series Management page."""
    from backend.services.author_service import get_all_series
    series_list = get_all_series()
    return render_template("admin/series.html", active_page="admin_series", series_list=series_list)

@admin_bp.route("/admin/series/<int:series_id>")
@admin_required
def admin_series_details(series_id):
    """View details and books within a specific series."""
    from backend.services.author_service import get_series_details, get_series_books
    series = get_series_details(series_id)
    books = get_series_books(series_id)
    return render_template("admin/series_details.html", active_page="admin_series", series=series, books=books)

@admin_bp.route("/admin/series/delete/<int:series_id>", methods=["POST"])
@admin_required
def admin_delete_series(series_id):
    """Deletes a series. Books are not deleted, just unlinked."""
    from backend.repository.db_access import execute
    try:
        # Unlink books first
        execute("UPDATE books SET series_id = NULL, series_order = NULL WHERE series_id = %s", (series_id,))
        # Delete series
        execute("DELETE FROM series WHERE series_id = %s", (series_id,))
        flash("‚úÖ Series deleted successfully.")
    except Exception as e:
        flash(f"‚ùå Error deleting series: {e}", "error")
    return redirect("/admin/series")



@admin_bp.route("/admin/series/create", methods=["POST"])
@admin_required
def admin_create_series():
    """Manually creates a new series."""
    from backend.repository.db_access import execute
    name = request.form.get("name")
    description = request.form.get("description")
    
    if name:
        execute("INSERT INTO series (name, description) VALUES (%s, %s)", (name, description))
        flash("‚úÖ Series created successfully!")
    else:
        flash("‚ùå Series name is required", "error")
    return redirect("/admin/series")

@admin_bp.route("/admin/series/add-book", methods=["POST"])
@admin_required
def admin_series_add_book():
    """Adds a book to a series manually."""
    from backend.repository.db_access import execute
    series_id = request.form.get("series_id")
    book_id = request.form.get("book_id")
    order = request.form.get("order")
    
    if series_id and book_id:
        execute("UPDATE books SET series_id = %s, series_order = %s WHERE book_id = %s", (series_id, order, book_id))
        flash("‚úÖ Book added to series!")
    else:
        flash("‚ùå Invalid selection", "error")
    return redirect(f"/admin/series/{series_id}")

@admin_bp.route("/admin/series/rename", methods=["POST"])
@admin_required
def admin_rename_series():
    """Renames an existing series."""
    from backend.repository.db_access import execute
    series_id = request.form.get("series_id")
    new_name = request.form.get("new_name")
    
    if series_id and new_name:
        execute("UPDATE series SET name = %s WHERE series_id = %s", (new_name, series_id))
        flash("‚úÖ Series renamed successfully.")
    else:
        flash("‚ùå Missing data", "error")
    return redirect("/admin/books")

@admin_bp.route("/api/books/search")
@admin_required
def api_search_books():
    """JSON API to search books for manual linking."""
    from backend.repository.db_access import fetch_all
    q = request.args.get('q', '')
    if len(q) < 2: return jsonify([])
    
    books = fetch_all("SELECT book_id, title FROM books WHERE title LIKE %s LIMIT 10", (f"%{q}%",))
    return jsonify(books)

@admin_bp.route("/api/series/<int:series_id>/books")
@admin_required
def api_get_series_books(series_id):
    """JSON API to get books in a series."""
    from flask import jsonify
    from backend.services.author_service import get_series_books
    books = get_series_books(series_id)
    return jsonify(books)


@admin_bp.route("/api/admin/settings/ai-suggest", methods=["POST"])
@admin_required
def admin_settings_ai_suggest():
    """Returns AI-suggested settings based on description."""
    from flask import jsonify
    data = request.get_json()
    description = data.get("description", "")
    if not description:
        return jsonify({"error": "Please provide a description."}), 400
        
    from backend.services.ai_service import suggest_settings
    suggestions = suggest_settings(description)
    return jsonify(suggestions)


# =====================================================
# API: GET BORROWED BOOKS FOR A USER
# =====================================================

@admin_bp.route("/api/user/<int:user_id>/borrowed-books")
@admin_required
def api_get_user_borrowed_books(user_id):
    """
    Returns a JSON list of books currently borrowed by a specific user.
    Used for dynamic filtering in Return Book form.
    """
    from flask import jsonify
    
    borrowed_books = fetch_all(
        """
        SELECT b.book_id, b.title
        FROM issues i
        JOIN books b ON i.book_id = b.book_id
        WHERE i.user_id = %s AND i.return_date IS NULL
        ORDER BY b.title
        """,
        (user_id,)
    )
    
    return jsonify(borrowed_books)

</file>

<file path="backend\routes\analytics_routes.py">

from flask import Blueprint, render_template, jsonify
from backend.middleware.auth import admin_required
from backend.repository.db_access import fetch_all
from datetime import datetime, timedelta

analytics_bp = Blueprint('analytics', __name__, url_prefix='/admin/analytics')

@analytics_bp.route("/")
@admin_required
def analytics_dashboard():
    """Renders the main analytics dashboard."""
    return render_template("admin/analytics.html", active_page="admin_analytics")

@analytics_bp.route("/data")
@admin_required
def get_analytics_data():
    """Returns JSON data for charts."""
    
    # 1. Borrowing Trends (Last 30 Days)
    today = datetime.now()
    dates = [(today - timedelta(days=i)).strftime('%Y-%m-%d') for i in range(29, -1, -1)]
    
    trend_query = """
        SELECT DATE(issue_date) as day, COUNT(*) as count 
        FROM issues 
        WHERE issue_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
        GROUP BY day 
        ORDER BY day ASC
    """
    trend_results = fetch_all(trend_query)
    trend_dict = {str(r['day']): r['count'] for r in trend_results}
    trend_data = [trend_dict.get(d, 0) for d in dates]
    
    # 2. Category Popularity
    cat_query = """
        SELECT b.category, COUNT(*) as count 
        FROM issues i
        JOIN books b ON i.book_id = b.book_id
        GROUP BY b.category
        ORDER BY count DESC
    """
    cat_results = fetch_all(cat_query)
    cat_labels = [r['category'] for r in cat_results]
    cat_data = [r['count'] for r in cat_results]
    
    # 3. Monthly Status (Issued vs Returned)
    status_query = """
        SELECT 
            SUM(CASE WHEN return_date IS NULL THEN 1 ELSE 0 END) as active,
            SUM(CASE WHEN return_date IS NOT NULL THEN 1 ELSE 0 END) as returned
        FROM issues
    """
    status_res = fetch_all(status_query)[0]
    
    return jsonify({
        "trends": {
            "labels": dates,
            "values": trend_data
        },
        "categories": {
            "labels": cat_labels,
            "values": cat_data
        },
        "status": {
            "labels": ["Active", "Returned"],
            "values": [status_res['active'] or 0, status_res['returned'] or 0]
        }
    })

</file>

<file path="backend\routes\auth_routes.py">
"""
auth_routes.py
--------------
Handles authentication-related routes (session-based).

Responsibilities:
- Login (session-based)
- Logout
- Forced password change
- Role-based redirection (admin / member)
"""

# ===============================
# IMPORTS
# ===============================

from flask import Blueprint, render_template, request, redirect, session, flash
# Blueprint      ‚Üí groups auth routes
# render_template‚Üí renders HTML pages
# request        ‚Üí reads form data (email/password)
# redirect       ‚Üí redirects users after actions
# session        ‚Üí stores logged-in user state
# flash          ‚Üí shows temporary messages in UI

from backend.services.auth_service import authenticate_user
# authenticate_user ‚Üí verifies email & password against DB

from backend.utils.decorators import login_required
# login_required ‚Üí ensures user is logged in before accessing route

from backend.utils.security import hash_password
# hash_password ‚Üí securely hashes passwords (bcrypt)

from backend.repository.db_access import execute
# execute ‚Üí runs INSERT / UPDATE / DELETE queries


# ===============================
# BLUEPRINT SETUP
# ===============================

# Create authentication blueprint
auth_bp = Blueprint("auth", __name__)


# =====================================================
# LOGIN ROUTE
# =====================================================

@auth_bp.route("/", methods=["GET", "POST"])
def login():
    """
    Login page handler.

    GET  ‚Üí shows login page
    POST ‚Üí validates credentials and creates session
    """

    # -----------------------------
    # HANDLE LOGIN SUBMISSION
    # -----------------------------
    if request.method == "POST":

        # Read email & password from login form
        email = request.form.get("email")
        password = request.form.get("password")

        # Authenticate user credentials
        user = authenticate_user(email, password)

        # If authentication fails
        if not user:
            flash("‚ùå Invalid email or password", "error")
            return render_template("login.html")

        # -----------------------------
        # CREATE USER SESSION
        # -----------------------------

        # Clear any existing session data
        session.clear()

        # Store user identity in session
        session["user_id"] = user["user_id"]
        session["role"] = user["role"]
        session["name"] = user["name"]  # Store name for Dashboard Header
        session["profile_pic"] = user.get("profile_pic")

        # -----------------------------
        # FORCE PASSWORD CHANGE
        # -----------------------------

        # If user is logging in with default password
        if user.get("must_change_password"):
            return redirect("/change-password")

        # -----------------------------
        # ROLE-BASED REDIRECTION
        # -----------------------------

        # Admin users ‚Üí admin dashboard
        if user["role"] == "admin":
            return redirect("/dashboard")

        # Member users ‚Üí member dashboard
        else:
            return redirect("/member/dashboard")

    # -----------------------------
    # SHOW LOGIN PAGE (GET)
    # -----------------------------
    return render_template("login.html")


# =====================================================
# LOGOUT ROUTE
# =====================================================

@auth_bp.route("/logout")
def logout():
    """
    Logs user out by clearing session.
    """

    # Remove all session data
    session.clear()

    # Inform user
    flash("‚ÑπÔ∏è Logged out successfully", "info")

    # Redirect to login page
    return redirect("/")


# =====================================================
# CHANGE PASSWORD ROUTE
# =====================================================

@auth_bp.route("/change-password", methods=["GET", "POST"])
@login_required
def change_password():
    """
    Forces user to change password on first login.

    Accessible only if user is logged in.
    """

    # -----------------------------
    # HANDLE PASSWORD UPDATE
    # -----------------------------
    if request.method == "POST":

        # Read new password fields
        new_password = request.form.get("password")
        confirm_password = request.form.get("confirm_password")

        # Validate empty fields
        if not new_password or not confirm_password:
            flash("‚ùå All fields are required", "error")
            return redirect("/change-password")

        # Validate password match
        if new_password != confirm_password:
            flash("‚ùå Passwords do not match", "error")
            return redirect("/change-password")

        # Validate minimum length
        if len(new_password) < 8:
            flash("‚ùå Password must be at least 8 characters", "error")
            return redirect("/change-password")

        # -----------------------------
        # HASH PASSWORD
        # -----------------------------

        # Securely hash password using bcrypt
        password_hash = hash_password(new_password)

        # -----------------------------
        # UPDATE PASSWORD IN DATABASE
        # -----------------------------

        execute(
            """
            UPDATE users
            SET password_hash = %s,
                must_change_password = FALSE
            WHERE user_id = %s
            """,
            (password_hash, session["user_id"])
        )

        # Notify user
        flash("‚úÖ Password updated successfully", "success")

        # -----------------------------
        # REDIRECT BASED ON ROLE
        # -----------------------------

        # Admin ‚Üí admin dashboard
        if session.get("role") == "admin":
            return redirect("/dashboard")

        # Member ‚Üí member dashboard
        else:
            return redirect("/member/dashboard")

    # -----------------------------
    # SHOW CHANGE PASSWORD PAGE
    # -----------------------------
    return render_template("change_password.html", active_page="settings")

</file>

<file path="backend\routes\chat_routes.py">
from flask import Blueprint, render_template, request, jsonify, session, redirect, flash, current_app
from backend.middleware.auth import member_required
from backend.services.guild_service import get_my_guilds, create_guild, get_guild_details
from backend.services.channel_service import create_channel, get_channel_messages
from backend.services.social_service import get_friends_list

chat_bp = Blueprint('chat_bp', __name__)

# --- Guild Routes ---
@chat_bp.route('/guilds', methods=['GET'])
@member_required
def list_guilds():
    """Returns list of guilds user is in."""
    try:
        guilds = get_my_guilds(session['user_id'])
        return jsonify({'success': True, 'guilds': guilds})
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@chat_bp.route('/guilds', methods=['POST'])
@member_required
def route_create_guild():
    data = request.json
    name = data.get('name')
    if not name: return jsonify({'error': 'Name required'}), 400
    
    try:
        guild_id = create_guild(session['user_id'], name)
        return jsonify({'success': True, 'guild_id': guild_id})
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@chat_bp.route('/conversations')
@member_required
def get_conversations_route():
    from backend.services.channel_service import get_my_dms
    from backend.services.guild_service import get_my_guilds
    from backend.repository.db_access import fetch_all
    
    user_id = session['user_id']
    
    # 1. Fetch DMs
    dms = get_my_dms(user_id)
    formatted_dms = []
    for d in dms:
        formatted_dms.append({
            'channel_id': d['channel_id'],
            'name': d['partner_name'], # Use partner name
            'type': 'personal',
            'public_id': 1000000000 + d['channel_id'],
            'icon': d.get('partner_pic') # User avatar
        })

    # 2. Fetch Public Channels (Global Community, etc.)
    # We define 'public' as channels with guild_id IS NULL and is_private = FALSE
    public_channels = fetch_all("""
        SELECT channel_id, name, topic, icon FROM channels 
        WHERE guild_id IS NULL AND is_private = FALSE AND name != 'DM'
    """)
    formatted_public = []
    for p in public_channels:
        formatted_public.append({
            'channel_id': p['channel_id'],
            'name': p['name'],
            'type': 'public',
            'icon': p.get('icon'),
            'public_id': 1000000000 + p['channel_id']
        })

    # 3. Fetch Private Groups (Channels in joined guilds)
    guilds = get_my_guilds(user_id)
    formatted_groups = []
    for g in guilds:
        # Fetch channels for this guild
        channels = fetch_all("SELECT channel_id, name FROM channels WHERE guild_id = %s", (g['guild_id'],))
        for c in channels:
            formatted_groups.append({
                'channel_id': c['channel_id'],
                'name': c['name'],
                'guild_name': g['name'],
                'type': 'group',
                'public_id': 1000000000 + c['channel_id']
            })
            
    # 4. Fetch Private Global Groups (Non-Guild Private Channels)
    # Re-using get_my_dms logic but filtering for non-DM names
    # Or strict query:
    private_groups = fetch_all("""
        SELECT c.channel_id, c.name, c.icon 
        FROM channels c
        JOIN dm_participants dp ON c.channel_id = dp.channel_id
        WHERE dp.user_id = %s AND c.guild_id IS NULL AND c.is_private = TRUE AND c.name != 'DM'
    """, (user_id,))
    
    for pg in private_groups:
        formatted_groups.append({
            'channel_id': pg['channel_id'],
            'name': pg['name'],
            'icon': pg.get('icon'),
            'guild_name': 'Private Group',
            'type': 'group', # Display in Group Tab
            'public_id': 1000000000 + pg['channel_id']
        })

    return jsonify({
        'success': True,
        'conversations': {
            'personal': formatted_dms,
            'public': formatted_public,
            'group': formatted_groups
        }
    })
@chat_bp.route('/dms', methods=['POST'])
@member_required
def create_dm_route():
    from backend.services.channel_service import create_dm
    data = request.json
    target_id = data.get('target_id')
    
    if not target_id:
        return jsonify({'error': 'Target ID required'}), 400
        
    cid = create_dm(session['user_id'], target_id)
    return jsonify({'success': True, 'channel_id': cid})


@chat_bp.route('/guilds/<int:guild_id>', methods=['GET'])
@member_required
def route_get_guild(guild_id):
    """Returns full hierarchy for a guild."""
    try:
        data = get_guild_details(guild_id)
        if not data: return jsonify({'error': 'Guild not found'}), 404
        return jsonify({'success': True, 'data': data})
    except Exception as e:
        return jsonify({'error': str(e)}), 500

# --- Channel Routes ---
@chat_bp.route('/channels', methods=['POST'])
@member_required
def route_create_channel():
    data = request.json
    guild_id = data.get('guild_id')
    name = data.get('name')
    cat_id = data.get('category_id') # Optional
    type = data.get('type', 'text')
    is_private = data.get('is_private', False)
    
    try:
        cid = create_channel(guild_id, cat_id, name, type, is_private=is_private, creator_id=session['user_id'])
        return jsonify({'success': True, 'channel_id': cid})
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@chat_bp.route('/channels/<int:channel_id>/messages', methods=['GET'])
@member_required
def route_get_messages(channel_id):
    try:
        msgs = get_channel_messages(channel_id)
        return jsonify({'success': True, 'messages': msgs})
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@chat_bp.route('/join/<int:channel_id>', methods=['POST'])
@member_required
def route_join_channel(channel_id):
    """Join a channel (public or private group by ID)."""
    from backend.repository.db_access import fetch_one, execute
    
    try:
        # 1. Verify channel exists
        channel = fetch_one("SELECT * FROM channels WHERE channel_id = %s", (channel_id,))
        if not channel:
            return jsonify({'success': False, 'message': 'Channel not found'}), 404
        
        # 2. Prevent joining DM channels directly (must be invited/created)
        if channel.get('name') == 'DM':
            return jsonify({'success': False, 'message': 'Cannot join DM channels directly'}), 400
        
        # 3. Check if already a member
        user_id = session['user_id']
        existing = fetch_one(
            "SELECT * FROM dm_participants WHERE channel_id = %s AND user_id = %s",
            (channel_id, user_id)
        )
        if existing:
            return jsonify({'success': True, 'message': 'Already a member'})
        
        # 4. Add user as member
        execute(
            "INSERT INTO dm_participants (channel_id, user_id, role) VALUES (%s, %s, 'member')",
            (channel_id, user_id)
        )
        
        return jsonify({'success': True, 'message': 'Joined successfully'})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)}), 400

# --- Legacy/Helper Routes (Social, etc) ---
@chat_bp.route('/social/friends', methods=['GET'])
@member_required
def route_get_friends():
    try:
        friends = get_friends_list(session['user_id'])
        return jsonify({'success': True, 'friends': friends})
    except Exception as e:
        return jsonify({'error': str(e)}), 400

# Include other necessary routes like upload/me if needed...
# For brevity in this large rebuild, focusing on core structure.
@chat_bp.route('/me', methods=['GET'])
@member_required
def route_get_me():
    from backend.services.chat_service import get_or_create_anon_id
    try:
        anon_id = get_or_create_anon_id(session['user_id'])
        return jsonify({'success': True, 'anon_id': anon_id})
    except:
        return jsonify({'error': 'Error'}), 500

@chat_bp.route('/anonymous', methods=['POST'])
@member_required
def toggle_anonymous():
    """Toggle anonymous mode for the user."""
    data = request.json
    is_anon = data.get('is_anon', False)
    session['is_anon'] = is_anon
    return jsonify({'success': True, 'is_anon': is_anon})

@chat_bp.route('/channels/<int:channel_id>', methods=['PATCH'])
@member_required
def route_update_channel(channel_id):
    data = request.json
    name = data.get('name')
    if not name: return jsonify({'error': 'Name required'}), 400
    from backend.repository.db_access import execute
    execute("UPDATE channels SET name = %s WHERE channel_id = %s", (name, channel_id))
    return jsonify({'success': True})

@chat_bp.route('/channels/<int:channel_id>', methods=['DELETE'])
@member_required
def route_delete_channel(channel_id):
    from backend.repository.db_access import execute, fetch_one
    user_id = session['user_id']
    system_role = session.get('role', 'member')  # System-level role (site admin)
    
    # Check if user is system admin OR channel creator OR channel admin
    channel = fetch_one("SELECT created_by FROM channels WHERE channel_id = %s", (channel_id,))
    
    # Check channel-level admin status
    participant = fetch_one(
        "SELECT role FROM dm_participants WHERE channel_id = %s AND user_id = %s",
        (channel_id, user_id)
    )
    is_channel_admin = participant and participant.get('role') == 'admin'
    is_channel_creator = channel and channel.get('created_by') == user_id
    is_system_admin = system_role == 'admin'
    
    if not (is_system_admin or is_channel_creator or is_channel_admin):
        return jsonify({'success': False, 'error': 'Only admins or channel creators can delete channels'}), 403
    
    execute("DELETE FROM chat_messages WHERE channel_id = %s", (channel_id,))
    execute("DELETE FROM dm_participants WHERE channel_id = %s", (channel_id,))
    execute("DELETE FROM channels WHERE channel_id = %s", (channel_id,))
    return jsonify({'success': True})

# --- Leave Channel ---
@chat_bp.route('/channels/<int:channel_id>/leave', methods=['POST'])
@member_required
def route_leave_channel(channel_id):
    """Leave a channel (remove from dm_participants)."""
    from backend.repository.db_access import execute
    user_id = session['user_id']
    
    # Remove user from participants
    execute("DELETE FROM dm_participants WHERE channel_id = %s AND user_id = %s", (channel_id, user_id))
    
    return jsonify({'success': True})

# --- Kick Member (Admin/Owner only) ---
@chat_bp.route('/channels/<int:channel_id>/kick/<int:target_user_id>', methods=['POST'])
@member_required
def route_kick_member(channel_id, target_user_id):
    """Kick a member from the channel (admin or channel creator only)."""
    from backend.repository.db_access import execute, fetch_one
    user_id = session['user_id']
    user_role = session.get('role', 'member')
    
    # Check if user is admin OR channel creator
    channel = fetch_one("SELECT created_by FROM channels WHERE channel_id = %s", (channel_id,))
    
    if user_role != 'admin':
        is_creator = channel and channel.get('created_by') == user_id
        is_channel_admin = False
        
        if not is_creator:
             participant = fetch_one("SELECT role FROM dm_participants WHERE channel_id = %s AND user_id = %s", (channel_id, user_id))
             if participant and participant['role'] == 'admin':
                 is_channel_admin = True

        if not (is_creator or is_channel_admin):
            return jsonify({'success': False, 'error': 'Only admins or channel creators can kick members'}), 403
    
    # Cannot kick yourself
    if target_user_id == user_id:
        return jsonify({'success': False, 'error': 'Cannot kick yourself'}), 400
    
    # Remove user from channel
    execute("DELETE FROM dm_participants WHERE channel_id = %s AND user_id = %s", (channel_id, target_user_id))
    
    # LOGGING
    log_audit_action(channel_id, user_id, "KICK_MEMBER", f"Kicked User ID {target_user_id}")

    return jsonify({'success': True, 'message': 'Member kicked successfully'})

# --- Channel Members ---
@chat_bp.route('/channels/<int:channel_id>/members', methods=['GET'])
@member_required
def route_get_channel_members(channel_id):
    """Get list of members in a channel."""
    from backend.repository.db_access import fetch_all, fetch_one
    user_id = session['user_id']
    user_role = session.get('role', 'member')
    
    # Get channel info
    channel = fetch_one("SELECT * FROM channels WHERE channel_id = %s", (channel_id,))
    if not channel:
        return jsonify({'error': 'Channel not found'}), 404
    
    channel_creator = channel.get('created_by')
    members = []
    
    # Check if current user is owner
    is_current_user_owner = (channel_creator == user_id) or (user_role == 'admin')
    
    # For private channels, get from dm_participants
    if channel.get('is_private') or channel.get('guild_id') is None:
        # Special Case: Global Chat (ID 1) - Include ALL Admins (Library Admins)
        if channel_id == 1:
            participants = fetch_all("""
                SELECT u.user_id, u.name, u.profile_pic, u.role, NULL as channel_role
                FROM users u
                WHERE u.role = 'admin'
                UNION
                SELECT u.user_id, u.name, u.profile_pic, u.role, dp.role as channel_role
                FROM dm_participants dp
                JOIN users u ON dp.user_id = u.user_id
                WHERE dp.channel_id = %s
            """, (channel_id,))
        else:
            # Regular Groups/DMs: Only participants
            participants = fetch_all("""
                SELECT u.user_id, u.name, u.profile_pic, u.role, dp.role as channel_role
                FROM dm_participants dp
                JOIN users u ON dp.user_id = u.user_id
                WHERE dp.channel_id = %s
            """, (channel_id,))
        
        # Remove duplicates (in case admin is also in participants)
        seen_ids = set()
        unique_participants = []
        for p in participants:
            if p['user_id'] not in seen_ids:
                unique_participants.append(p)
                seen_ids.add(p['user_id'])
                
        for p in unique_participants:
            members.append({
                'user_id': p['user_id'],
                'name': p['name'],
                'profile_pic': p['profile_pic'] or 'default.jpg',
                'role': p.get('channel_role') or p['role'], # Prefer channel role (admin) if set, else global role
                'is_owner': p['user_id'] == channel_creator
            })
    else:
        # For guild channels, get guild members
        guild_id = channel.get('guild_id')
        guild_members = fetch_all("""
            SELECT u.user_id, u.name, u.profile_pic, gm.role 
            FROM guild_members gm
            JOIN users u ON gm.user_id = u.user_id
            WHERE gm.guild_id = %s
        """, (guild_id,))
        
        for m in guild_members:
            members.append({
                'user_id': m['user_id'],
                'name': m['name'],
                'profile_pic': m['profile_pic'] or 'default.jpg',
                'role': m['role'], # Guild role
                'is_owner': m.get('role') == 'owner'
            })
    
    # Calculate if current user is admin of this channel
    is_admin = is_current_user_owner # Start with owner logic
    if not is_admin:
        # Check specific channel role
        for m in members:
            if str(m['user_id']) == str(user_id) and m['role'] == 'admin':
                is_admin = True
                break

    return jsonify({'success': True, 'members': members, 'is_owner': is_current_user_owner, 'is_admin': is_admin})

# --- Member Management ---
@chat_bp.route('/channels/<int:channel_id>/members/<int:target_user_id>/role', methods=['POST'])
@member_required
def route_update_member_role(channel_id, target_user_id):
    """Update a member's role in the channel (Promote/Demote)."""
    from backend.repository.db_access import execute, fetch_one
    
    # Check permissions
    # Only Channel Creator (Owner) or System Admin can change roles
    user_id = session['user_id']
    user_role = session.get('role', 'member') # Global role
    
    channel = fetch_one("SELECT * FROM channels WHERE channel_id = %s", (channel_id,))
    if not channel:
        return jsonify({'error': 'Channel not found'}), 404
        
    # Is requester authorized?
    is_owner = (channel.get('created_by') == user_id)
    is_sys_admin = (user_role == 'admin')
    
    # Check if channel admin
    is_channel_admin = False
    participant = fetch_one("SELECT role FROM dm_participants WHERE channel_id = %s AND user_id = %s", (channel_id, user_id))
    if participant and participant['role'] == 'admin':
        is_channel_admin = True

    if not (is_owner or is_sys_admin or is_channel_admin):
        return jsonify({'error': 'Unauthorized'}), 403
        
    # Update role in dm_participants
    new_role = request.json.get('role', 'member') # 'admin' or 'member'
    
    # Prevent demoting the Owner
    if channel.get('created_by') == target_user_id and new_role != 'admin':
         # Actually owner should probably stay owner, but let's allow them to be 'admin' in role column
         pass
         
    execute("UPDATE dm_participants SET role = %s WHERE channel_id = %s AND user_id = %s", 
            (new_role, channel_id, target_user_id))
            
    # LOGGING
    log_audit_action(channel_id, user_id, "UPDATE_ROLE", f"Changed User {target_user_id} role to {new_role}")

    return jsonify({'success': True})

# --- Channel Settings ---
@chat_bp.route('/channels/<int:channel_id>/settings', methods=['GET'])
@member_required
def route_get_channel_settings(channel_id):
    """Get channel settings."""
    from backend.repository.db_access import fetch_one
    
    # 1. Fetch Channel
    channel = fetch_one("""
        SELECT c.*, u.name as owner_name 
        FROM channels c
        LEFT JOIN users u ON c.created_by = u.user_id
        WHERE c.channel_id = %s
    """, (channel_id,))
    
    if not channel:
        return jsonify({'error': 'Channel not found'}), 404

    # 2. Get caller's role
    current_user_id = session.get('user_id')
    user_role = 'member'
    try:
        participant = fetch_one("SELECT role FROM dm_participants WHERE channel_id = %s AND user_id = %s", (channel_id, current_user_id))
        if participant:
            user_role = participant['role']
    except:
        pass

    return jsonify({
        'success': True,
        'name': channel.get('name'),
        'owner_name': channel.get('owner_name') or 'System',
        'is_private': bool(channel.get('is_private')),
        'type': channel.get('type'),
        'topic': channel.get('topic'),
        'icon': channel.get('icon'),  # If exists in schema
        'user_role': user_role # Return role
    })

@chat_bp.route('/channels/<int:channel_id>/settings', methods=['POST'])
@member_required
def route_update_channel_settings(channel_id):
    """Update channel settings."""
    from backend.repository.db_access import execute, fetch_one
    from werkzeug.utils import secure_filename
    import os
    import uuid
    
    channel = fetch_one("SELECT * FROM channels WHERE channel_id = %s", (channel_id,))
    if not channel:
        return jsonify({'error': 'Channel not found'}), 404
        
    # --- RESTRICTION: Admin Only ---
    current_user_id = session.get('user_id')
    
    # 1. Global Community Check
    if channel_id == 1:
        if session.get('role') != 'admin':
             return jsonify({'success': False, 'error': 'Only admins can change Global Community settings'}), 403
             
    # 2. Private Group Check
    else:
        # Check if user is admin in this group
        participant = fetch_one("SELECT role FROM dm_participants WHERE channel_id = %s AND user_id = %s", (channel_id, current_user_id))
        
        # EXCEPTION: Allow if it is a DM (P2P) and user is a participant
        is_dm = (channel.get('name') == 'DM')
        
        if not participant: # Not even a member
            return jsonify({'success': False, 'error': 'Unauthorized'}), 403
            
        if participant['role'] != 'admin' and not is_dm:
             # Also allow if strictly 'created_by' (owner) even if role isn't 'admin' (failsafe)
             if channel.get('created_by') != current_user_id:
                return jsonify({'success': False, 'error': 'Only group admins can change settings'}), 403
    
    # Handle form data
    is_private = request.form.get('is_private') == 'true'
    chat_type = request.form.get('type', 'text')
    
    # Handle icon upload
    icon_path = None
    if 'icon' in request.files:
        file = request.files['icon']
        if file and file.filename:
            ext = os.path.splitext(file.filename)[1]
            unique_name = f"channel_{channel_id}_{uuid.uuid4().hex[:8]}{ext}"
            save_dir = os.path.join(current_app.static_folder, 'uploads', 'channels')
            os.makedirs(save_dir, exist_ok=True)
            file.save(os.path.join(save_dir, unique_name))
            icon_path = f"uploads/channels/{unique_name}"
    
    # Update channel
        execute("""
            UPDATE channels SET is_private = %s, type = %s, icon = %s WHERE channel_id = %s
        """, (is_private, chat_type, icon_path, channel_id))
    else:
        # Check if topic was provided
        topic = request.form.get('topic')
        if topic is not None:
            execute("""
                UPDATE channels SET is_private = %s, type = %s, topic = %s WHERE channel_id = %s
            """, (is_private, chat_type, topic, channel_id))
        else:
            execute("""
                UPDATE channels SET is_private = %s, type = %s WHERE channel_id = %s
            """, (is_private, chat_type, channel_id))
    
    # FIX: If switching to PRIVATE, ensure the owner is in participants list
    if is_private:
        # Get creator (use existing channel obj)
        owner_id = channel.get('created_by')
        
        if owner_id:
             # Insert ignore to avoid duplicates
            execute("""
                INSERT IGNORE INTO dm_participants (channel_id, user_id, role) 
                VALUES (%s, %s, 'admin')
            """, (channel_id, owner_id))
            
        # Also ensure the CURRENT user (if different from owner, e.g. Admin) is added
        current_user_id = session['user_id']
        if owner_id != current_user_id:
             execute("""
                INSERT IGNORE INTO dm_participants (channel_id, user_id, role) 
                VALUES (%s, %s, 'admin')
            """, (channel_id, current_user_id))
            
    # LOGGING
    log_details = f"Updated settings. Private: {is_private}"
    log_audit_action(channel_id, session['user_id'], "UPDATE_SETTINGS", log_details)
    
    response = {'success': True}
    if icon_path:
        response['icon'] = icon_path
    return jsonify(response)

# --- Invitation System ---
@chat_bp.route('/invites/send', methods=['POST'])
@member_required
def send_invite():
    data = request.json
    target_user_id = data.get('target_user_id')
    target_channel_id = data.get('target_channel_id')
    invite_type = data.get('type', 'DM')
    
    from backend.utils.snowflake import SnowflakeGenerator
    from backend.repository.db_access import execute
    
    gen = SnowflakeGenerator()
    invite_id = gen.next_id()
    
    execute("""
        INSERT INTO chat_invitations (invite_id, sender_id, target_user_id, target_channel_id, type)
        VALUES (%s, %s, %s, %s, %s)
    """, (invite_id, session['user_id'], target_user_id, target_channel_id, invite_type))
    
    return jsonify({'success': True, 'invite_id': str(invite_id)})

@chat_bp.route('/invites/pending', methods=['GET'])
@member_required
def get_pending_invites():
    from backend.repository.db_access import fetch_all
    user_id = session['user_id']
    
    # 1. Invites sent TO me (Friend reqs + Group invites)
    my_invites = fetch_all("""
        SELECT i.*, u.name as sender_name, u.profile_pic as sender_pic, c.name as channel_name 
        FROM chat_invitations i
        JOIN users u ON i.sender_id = u.user_id
        LEFT JOIN channels c ON i.target_channel_id = c.channel_id
        WHERE i.target_user_id = %s AND i.status = 'pending'
    """, (user_id,))
    
    # 2. Group invites for channels I own (via guild)
    group_invites = fetch_all("""
        SELECT i.*, u.name as sender_name, u.profile_pic as sender_pic, c.name as channel_name
        FROM chat_invitations i
        JOIN users u ON i.sender_id = u.user_id
        JOIN channels c ON i.target_channel_id = c.channel_id
        JOIN guilds g ON c.guild_id = g.guild_id
        WHERE g.owner_id = %s AND i.status = 'pending' AND i.type = 'GROUP'
    """, (user_id,))
    
    all_invites = my_invites + group_invites
    
    # Stringify invite_id for JSON safety
    for iv in all_invites:
        iv['invite_id'] = str(iv['invite_id'])
        
    return jsonify({'success': True, 'invites': all_invites})

@chat_bp.route('/invites/handle', methods=['POST'])
@member_required
def handle_invite():
    data = request.json
    invite_id = data.get('invite_id')
    action = data.get('action') # 'accept' or 'reject'
    
    if action not in ['accept', 'reject']:
        return jsonify({'error': 'Invalid action'}), 400
        
    status = 'accepted' if action == 'accept' else 'rejected'
    
    from backend.repository.db_access import execute, fetch_one
    execute("UPDATE chat_invitations SET status = %s WHERE invite_id = %s", (status, invite_id))
    
    if action == 'accept':
        invite = fetch_one("SELECT * FROM chat_invitations WHERE invite_id = %s", (invite_id,))
        if not invite: return jsonify({'error': 'Invite not found'}), 404
        
        if invite['type'] == 'DM':
            from backend.services.channel_service import create_dm
            cid = create_dm(invite['sender_id'], invite['target_user_id'])
            return jsonify({'success': True, 'channel_id': cid})
        
        elif invite['type'] == 'GROUP':
            chan = fetch_one("SELECT guild_id FROM channels WHERE channel_id = %s", (invite['target_channel_id'],))
            if chan:
                if chan['guild_id']:
                    execute("INSERT IGNORE INTO guild_members (guild_id, user_id) VALUES (%s, %s)", (chan['guild_id'], invite['target_user_id']))
                else:
                    # Non-guild private group
                    execute("INSERT IGNORE INTO dm_participants (channel_id, user_id, role) VALUES (%s, %s, 'member')", (invite['target_channel_id'], invite['target_user_id']))
                
                return jsonify({'success': True})
            
    return jsonify({'success': True})
@chat_bp.route('/upload', methods=['POST'])
@member_required
def route_upload_file():
    if 'file' not in request.files:
        return jsonify({'error': 'No file part'}), 400
    file = request.files['file']
    if file.filename == '':
        return jsonify({'error': 'No selected file'}), 400
    
    import os
    import uuid
    from werkzeug.utils import secure_filename
    
    ALLOWED_EXTENSIONS = {'txt', 'pdf', 'png', 'jpg', 'jpeg', 'gif', 'doc', 'docx', 'zip'}
    def allowed_file(filename):
        return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

    if file and allowed_file(file.filename):
        filename = secure_filename(file.filename)
        ext = filename.rsplit('.', 1)[1].lower()
        unique_name = f"{uuid.uuid4().hex}.{ext}"
        
        # Save to static/uploads/chat using Flask's configured static folder
        from flask import current_app
        save_dir = os.path.join(current_app.static_folder, 'uploads', 'chat')
        os.makedirs(save_dir, exist_ok=True)
        
        save_path = os.path.join(save_dir, unique_name)
        file.save(save_path)
        
        return jsonify({
            'success': True, 
            'file_path': f"/static/uploads/chat/{unique_name}", 
            'filename': filename,
            'type': 'image' if ext in ['png', 'jpg', 'jpeg', 'gif'] else 'file'
        })
        
    return jsonify({'error': 'File type not allowed'}), 400

# ==========================================
# RULES & LOGS IMPLEMENTATION
# ==========================================

def log_audit_action(channel_id, user_id, action_type, details=None):
    """Helper to insert audit log entry."""
    from backend.repository.db_access import execute
    try:
        execute("""
            INSERT INTO audit_logs (channel_id, user_id, action_type, details)
            VALUES (%s, %s, %s, %s)
        """, (channel_id, user_id, action_type, details))
    except Exception as e:
        print(f"‚ùå Failed to log action: {e}")

@chat_bp.route('/channels/<int:channel_id>/rules', methods=['GET'])
@member_required
def route_get_rules(channel_id):
    """Get channel rules."""
    from backend.repository.db_access import fetch_one
    channel = fetch_one("SELECT rules, guild_id, created_by FROM channels WHERE channel_id = %s", (channel_id,))
    if not channel:
        return jsonify({'error': 'Channel not found'}), 404
        
    rules = channel.get('rules') or "No rules set for this channel."
    
    # If global chat, maybe return hardcoded rules if empty?
    if channel_id == 1 and not channel.get('rules'):
        rules = "1. Be respectful.\n2. No spamming.\n3. Keep it family friendly."

    # Determine Edit Permissions
    user_id = session['user_id']
    user_role = session.get('role', 'member')
    
    can_edit = (user_role == 'admin') or (channel.get('created_by') == user_id)
    if not can_edit:
         # Check channel admin
         from backend.repository.db_access import fetch_one
         p = fetch_one("SELECT role FROM dm_participants WHERE channel_id = %s AND user_id = %s", (channel_id, user_id))
         if p and p['role'] == 'admin':
             can_edit = True
        
    return jsonify({'success': True, 'rules': rules, 'can_edit': can_edit})

@chat_bp.route('/channels/<int:channel_id>/rules', methods=['POST'])
@member_required
def route_update_rules(channel_id):
    """Update channel rules (Admin/Owner only)."""
    from backend.repository.db_access import execute, fetch_one
    
    data = request.json
    new_rules = data.get('rules')
    
    if new_rules is None:
        return jsonify({'error': 'Rules content required'}), 400
        
    user_id = session['user_id']
    user_role = session.get('role', 'member')
    
    channel = fetch_one("SELECT created_by FROM channels WHERE channel_id = %s", (channel_id,))
    if not channel:
        return jsonify({'error': 'Channel not found'}), 404
        
    # Check permissions
    # Check permissions
    if user_role != 'admin' and channel.get('created_by') != user_id:
        # Check channel admin
        p = fetch_one("SELECT role FROM dm_participants WHERE channel_id = %s AND user_id = %s", (channel_id, user_id))
        is_channel_admin = (p and p['role'] == 'admin')
        if not is_channel_admin:
            return jsonify({'error': 'Unauthorized'}), 403
        
    execute("UPDATE channels SET rules = %s WHERE channel_id = %s", (new_rules, channel_id))
    
    # Log it
    log_audit_action(channel_id, user_id, "UPDATE_RULES", "Updated channel rules")
    
    return jsonify({'success': True})

@chat_bp.route('/channels/<int:channel_id>/logs', methods=['GET'])
@member_required
def route_get_logs(channel_id):
    """Get audit logs for a channel."""
    from backend.repository.db_access import fetch_all, fetch_one
    
    user_id = session['user_id']
    user_role = session.get('role', 'member')
    
    channel = fetch_one("SELECT created_by FROM channels WHERE channel_id = %s", (channel_id,))
    if not channel:
        return jsonify({'error': 'Channel not found'}), 404
    
    # Permission: Admins, Channel Owners, or maybe Channel Admins
    # For now: Global Admin or Channel Creator
    # Permission: Admins, Channel Owners, or Channel Admins
    if user_role != 'admin' and channel.get('created_by') != user_id:
        # Check channel admin
        p = fetch_one("SELECT role FROM dm_participants WHERE channel_id = %s AND user_id = %s", (channel_id, user_id))
        is_channel_admin = (p and p['role'] == 'admin')
        if not is_channel_admin:
            return jsonify({'error': 'Unauthorized access to verify logs'}), 403
        
    logs = fetch_all("""
        SELECT a.log_id, a.action_type, a.details, a.created_at, u.name as user_name, u.role as user_role
        FROM audit_logs a
        JOIN users u ON a.user_id = u.user_id
        WHERE a.channel_id = %s
        ORDER BY a.created_at DESC
        LIMIT 50
    """, (channel_id,))
    
    return jsonify({'success': True, 'logs': logs})

</file>

<file path="backend\routes\common_routes.py">

from flask import Blueprint, session, redirect, request, jsonify, flash

common_bp = Blueprint('common_bp', __name__)

@common_bp.route("/notifications/read/<int:notif_id>")
def mark_read(notif_id):
    if 'user_id' not in session: return redirect("/")
    
    from backend.services.notification_service import mark_notification_read
    mark_notification_read(notif_id, session['user_id'])
    return redirect(request.referrer or "/")

@common_bp.route("/notifications/read/all")
def mark_all_read_route():
    if 'user_id' not in session: return redirect("/")
    
    from backend.services.notification_service import mark_all_read
    mark_all_read(session['user_id'])
    return redirect(request.referrer or "/")

@common_bp.route("/api/notifications/unread")
def api_get_unread():
    if 'user_id' not in session: return jsonify([])
    
    from backend.services.notification_service import get_unread_notifications
    notifs = get_unread_notifications(session['user_id'])
    return jsonify(notifs)

@common_bp.route("/api/external/catalog")
def external_api_catalog():
    from backend.services.api_service import validate_key
    from backend.services.book_service import view_books
    
    key = request.headers.get("X-API-Key")
    if not key:
        return jsonify({"error": "Missing API Key"}), 401
        
    user_id = validate_key(key)
    if not user_id:
        return jsonify({"error": "Invalid API Key"}), 401
        
    books = view_books()
    return jsonify(books)
@common_bp.route("/api/book/get/<int:book_id>")
def common_get_book_json(book_id):
    """Returns book details for admin/member modals."""
    from backend.services.book_service import get_book
    from flask import jsonify
    
    # We allow this for everyone (maintenance bypass), 
    # but the service only returns what's safe.
    # However, let's keep it restricted to logged in for basic security
    if 'user_id' not in session:
        return jsonify({"error": "Unauthorized"}), 401
        
    try:
        book = get_book(book_id)
        if not book:
            return jsonify({"error": "Book not found", "success": False}), 404
        return jsonify({"success": True, "data": book})
    except Exception as e:
        return jsonify({"error": str(e), "success": False}), 500

</file>

<file path="backend\routes\member_routes.py">
# ===============================
# IMPORTS
# ===============================

from flask import Blueprint, session, render_template, request, redirect, url_for, flash, jsonify, current_app
from functools import wraps
import json
import os
from datetime import datetime, timedelta

# Import database access functions
from backend.repository.db_access import (
    execute_query,
    fetch_all,
    fetch_one
)

# Import authentication decorator
from backend.middleware.auth import member_required

# Blueprint for member routes
member_bp = Blueprint('member', __name__, url_prefix='/member')

def ensure_isbn_column_exists():
    """
    Ensure the book_suggestions table has an isbn column.
    If the column doesn't exist, it will be added.
    """
    try:
        # Check if the column exists
        result = fetch_one(
            """
            SELECT COUNT(*) AS count
            FROM information_schema.COLUMNS 
            WHERE TABLE_SCHEMA = DATABASE() 
            AND TABLE_NAME = 'book_suggestions' 
            AND COLUMN_NAME = 'isbn'
            """
        )
        
        if not result or result.get('count', 0) == 0:
            # Add the isbn column if it doesn't exist
            current_app.logger.info("Adding 'isbn' column to book_suggestions table")
            execute_query(
                """
                ALTER TABLE book_suggestions 
                ADD COLUMN isbn VARCHAR(20) NULL DEFAULT NULL 
                COMMENT 'ISBN number of the suggested book' AFTER author
                """
            )
            return True
        return False
    except Exception as e:
        current_app.logger.error(f"Error ensuring isbn column exists: {str(e)}")
        return False




@member_bp.route("/toggle_anon", methods=["POST"])
@member_required
def toggle_anon():
    """Toggles anonymous mode for the session."""
    data = request.get_json()
    is_anon = data.get('anon', False)
    session['is_anon'] = is_anon
    return jsonify({"success": True, "is_anon": is_anon})

# ===============================
# MEMBER DASHBOARD ROUTE
# ===============================

@member_bp.route("/goal/update", methods=["POST"])
@member_required
def member_update_goal_route():
    """Updates the user's annual reading goal target."""
    from backend.services.goal_service import update_goal_target
    user_id = session.get("user_id")
    target = request.form.get("target", type=int)
    
    if target and target > 0:
        result = update_goal_target(user_id, target)
        flash(result)
    else:
        flash("‚ùå Invalid goal target", "error")
        
    return redirect("/member/dashboard")


# ===============================
# MEMBER DASHBOARD (GET)
# ===============================


@member_bp.route("/goals", methods=["GET", "POST"])
@member_required
def member_goals():
    """Renders the dedicated Reading Goals page with extended stats."""
    from backend.services.goal_service import get_or_create_goal, update_goal_target
    from backend.services.social_service import update_privacy_settings
    
    user_id = session["user_id"]
    
    # Handle POST (Settings Update)
    if request.method == "POST":
        # Check if it's a Goal Update or Privacy Update
        if "target" in request.form:
             target = request.form.get("target", type=int)
             if target and target > 0:
                 update_goal_target(user_id, target)
                 flash("‚úÖ Reading goal updated!", "success")
             else:
                 flash("‚ùå Invalid goal target", "error")
        else:
            # Privacy Update
            is_public = request.form.get("is_public") == "on"
            allow_requests = request.form.get("allow_requests") == "on"
            show_activity = request.form.get("show_activity") == "on"
            update_privacy_settings(user_id, is_public, allow_requests, show_activity)
            flash("‚úÖ Privacy settings updated!", "success")
            
        return redirect("/member/goals")

    # GET: Fetch Data
    reading_goal = get_or_create_goal(user_id)
    
    # Calculate Extended Stats
    # Calculate Extended Stats
    # 1. Monthly Breakdown (Books returned per month)
    monthly_stats = fetch_all("""
        SELECT MONTH(return_date) as month_num, COUNT(*) as count 
        FROM issues 
        WHERE user_id = %s AND return_date IS NOT NULL AND YEAR(return_date) = YEAR(CURDATE())
        GROUP BY MONTH(return_date)
        ORDER BY month_num
    """, (user_id,))
    
    # Fill missing months for chart
    months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
    chart_data = {m: 0 for m in months}
    
    for row in monthly_stats:
        # month_num is 1-12, map to index 0-11
        m_index = row['month_num'] - 1
        if 0 <= m_index < 12:
            chart_data[months[m_index]] = row['count']
        
    # 2. Total Pages (Estimated) - Assuming avg 300 pages per book since we don't have page counts
    pages_read = reading_goal['current_books'] * 320 
    
    # 3. Longest Streak (Consecutive months with at least 1 book)
    # Simple logic: just count active months for now as a proxy
    active_months = len(monthly_stats)
    
    return render_template(
        "member/goals.html", 
        active_page="member_goals",
        reading_goal=reading_goal,
        chart_labels=list(chart_data.keys()),
        chart_values=list(chart_data.values()),
        pages_read=pages_read,
        streak=active_months
    )


@member_bp.route("/dashboard")
@member_required
def member_dashboard():
    """
    Member dashboard ‚Äì displays books currently issued to the member.
    """
    user_id = session["user_id"]

    # FETCH CURRENT ISSUES
    issues = fetch_all(
        """
        SELECT b.title, i.issue_date, i.return_date, i.fine
        FROM issues i
        JOIN books b ON i.book_id = b.book_id
        WHERE i.user_id = %s
        ORDER BY i.issue_date DESC
        """,
        (user_id,)
    )

    # FETCH ACTIVITIES
    from backend.services.activity_service import get_user_activities
    activities = get_user_activities(user_id)

    # FETCH RECOMMENDATIONS
    from backend.services.recommendation_service import get_smart_recommendations
    recommendations = get_smart_recommendations(user_id)

    # FETCH READING GOAL
    from backend.services.goal_service import get_or_create_goal
    reading_goal = get_or_create_goal(user_id)

    # FETCH GAMIFICATION STATS
    from backend.services.gamification_service import get_user_stats
    game_stats = get_user_stats(user_id)

    return render_template(
        "member/overview.html",
        active_page="member_overview",
        issues=issues,
        activities=activities,
        recommendations=recommendations,
        reading_goal=reading_goal,
        game_stats=game_stats
    )


@member_bp.route("/achievements")
@member_required
def member_achievements():
    """
    Renders the dedicated achievements/trophy room page.
    Shows all unlocked and locked badges.
    """
    from backend.services.gamification_service import get_user_stats, get_all_achievements_status
    
    user_id = session["user_id"]
    game_stats = get_user_stats(user_id)
    all_achievements = get_all_achievements_status(user_id)
    
    return render_template(
        "member/achievements.html",
        active_page="member_achievements",
        game_stats=game_stats,
        achievements=all_achievements
    )


@member_bp.route("/book/read/<int:book_id>")
@member_required
def member_read_book(book_id):
    """Renders the in-app digital reader for a specific book."""
    from backend.repository.db_access import fetch_one
    
    # Fetch book details
    book = fetch_one("SELECT * FROM books WHERE book_id = %s", (book_id,))
    
    if not book:
        flash("‚ùå Book not found", "error")
        return redirect("/member/dashboard")
        
    if not book.get("pdf_src"):
        flash("‚ùå Digital version not available for this book", "error")
        return redirect("/member/dashboard")
        
    return render_template("member/reader.html", book=book)


# ===============================
# BOOK CATALOG (GET)
# ===============================

@member_bp.route("/catalog")
@member_required
def member_catalog_view():
    """
    Renders the searchable Book Catalog with server-side pagination.
    """
    from flask import request
    from backend.services.book_service import view_books_paginated, get_all_authors, get_all_categories
    
    page = request.args.get('page', 1, type=int)
    search_query = request.args.get('q', '')
    author_id = request.args.get('author_id', type=int)
    category_filter = request.args.get('category', '')
    
    per_page = 12  # Grid looks better with 12 items
    
    pagination = view_books_paginated(page, 12, search_query, author_id, category_filter)
    
    authors = get_all_authors()
    categories = get_all_categories()

    return render_template(
        "member/catalog.html",
        active_page="member_catalog",
        books=pagination['books'],
        total=pagination['total'],
        current_page=pagination['page'],
        total_pages=pagination['total_pages'],
        q=search_query,
        selected_author_id=author_id,
        selected_category=category_filter,
        authors=authors,
        categories=categories
    )


@member_bp.route("/community")
@member_required
def member_community():
    """Renders the Community Hub (Client-side loaded)."""
    from backend.services.auth_service import get_user_by_id
    user = get_user_by_id(session["user_id"])
    
    # Sync session data in case it was missed during login or changed elsewhere
    if user:
        session["profile_pic"] = user.get("profile_pic")
        session["name"] = user.get("name")
    
    is_embedded = request.args.get('embed') == 'true'
    
    return render_template(
        "member/community.html",
        active_page="member_community",
        user=user,
        user_id=session["user_id"],
        fullscreen=is_embedded, # Hides layout
        embedded=is_embedded    # Custom styling flag
    )




@member_bp.route("/profile/privacy", methods=["POST"])
@member_required
def member_toggle_privacy():
    """Toggles user profile visibility."""
    from backend.services.social_service import update_privacy_settings
    is_public = request.form.get("is_public") == "on"
    allow_requests = request.form.get("allow_requests") == "on"
    show_activity = request.form.get("show_activity") == "on"
    
    result = update_privacy_settings(session["user_id"], is_public, allow_requests, show_activity)
    flash(result)
    return redirect("/member/dashboard")

@member_bp.route("/review/like", methods=["POST"])
@member_required
def member_like_review():
    """Likes a book review."""
    from backend.services.social_service import like_review
    review_id = request.form.get("review_id", type=int)
    result = like_review(session["user_id"], review_id)
    return jsonify({"message": result})


@member_bp.route("/author/<int:author_id>")
@member_required
def member_author_view(author_id):
    """Shows author profile and their books."""
    from backend.services.author_service import get_author_details, get_author_books
    author = get_author_details(author_id)
    books = get_author_books(author_id)
    return render_template("member/author.html", author=author, books=books)

@member_bp.route("/series/<int:series_id>")
@member_required
def member_series_view(series_id):
    """Shows series details and ordered books."""
    from backend.services.author_service import get_series_details, get_series_books
    series = get_series_details(series_id)
    books = get_series_books(series_id)
    return render_template("member/series.html", series=series, books=books)


# ===============================
# REQUEST BOOK (POST)
# ===============================

@member_bp.route("/request", methods=["POST"])
@member_required
def member_request_book():
    """
    Handles book request submissions.
    """
    from flask import request, redirect, flash
    from backend.services.request_service import create_request

    user_id = session["user_id"]
    book_id = request.form.get("book_id")

    result = create_request(user_id, book_id)
    
    flash(result)
    return redirect("/member/catalog")


# ===============================
# SUGGEST A BOOK (GET & POST)
# ===============================

@member_bp.route("/suggest-book", methods=["GET", "POST"])
@member_required
def member_suggest_book():
    """
    GET: Displays the book suggestion form
    POST: Handles book suggestion submissions from members
    
    Robust implementation: dynamically detects schema variations.
    """
    from flask import request, redirect, flash, render_template, jsonify, current_app
    from backend.repository.db_access import execute_query, fetch_all
    from datetime import datetime
    
    # helper to get available columns
    def get_table_columns():
        try:
            # SHOW COLUMNS returns dict with 'Field' key when using dictionary cursor
            cols = fetch_all("SHOW COLUMNS FROM book_suggestions")
            return {c['Field'] for c in cols}
        except Exception:
            return set()
    
    available_columns = get_table_columns()
    
    # If table doesn't exist or we can't read it
    if not available_columns:
        flash("‚ùå System Error: Book suggestions table is missing or inaccessible.", "error")
        return redirect("/member/dashboard")

    # -----------------------------
    # GET REQUEST (View Suggestions)
    # -----------------------------
    if request.method == 'GET':
        try:
            user_id = session["user_id"]
            
            # Map correct column names based on what exists
            # We want: id, title, author, notes, date, status
            
            # 1. ID
            id_col = "suggestion_id" if "suggestion_id" in available_columns else "id"
            
            # 2. Notes / Reason
            notes_col = "notes"
            if "notes" not in available_columns and "reason" in available_columns:
                notes_col = "reason"
            
            # 3. Date - MUST alias to 'created_at' for template compatibility
            date_col = "created_at"
            if "created_at" not in available_columns and "suggestion_date" in available_columns:
                date_col = "suggestion_date"
                
            # 4. ISBN (optional for display)
            isbn_col = ", isbn" if "isbn" in available_columns else ""

            # Construct Query - Alias date_col to created_at
            query = f"""
                SELECT 
                    {id_col} as suggestion_id, 
                    title, 
                    author, 
                    {notes_col} as notes, 
                    {date_col} as created_at, 
                    status
                    {isbn_col}
                FROM book_suggestions 
                WHERE user_id = %s 
                ORDER BY {date_col} DESC
            """
            
            suggestions = fetch_all(query, (user_id,))
            
            return render_template(
                "member/suggest_book.html",
                active_page="suggest_book",
                suggestions=suggestions or []
            )
            
        except Exception as e:
            current_app.logger.error(f"Error in member_suggest_book (GET): {str(e)}")
            flash("‚ùå An error occurred while loading the page. Please ensure your database is updated.", "error")
            return redirect("/member/dashboard")
    
    # -----------------------------
    # POST REQUEST (Submit Suggestion)
    # -----------------------------
    
    user_id = session["user_id"]
    is_json_request = request.is_json or (request.content_type and 'application/json' in request.content_type)
    
    try:
        # Get Data
        if is_json_request:
            data = request.get_json(force=True, silent=True) or {}
            title = data.get("title", "").strip()
            author = data.get("author", "").strip()
            isbn = data.get("isbn", "").strip()
            notes = data.get("notes", "").strip()
        else:
            title = request.form.get("title", "").strip()
            author = request.form.get("author", "").strip()
            isbn = request.form.get("isbn", "").strip()
            notes = request.form.get("notes", "").strip()

        # Validation
        if not title or not author:
            msg = "‚ùå Title and Author are required."
            if is_json_request: return jsonify({"error": msg}), 400
            flash(msg, "error")
            return redirect(url_for("member.member_suggest_book"))

        # Build Dynamic INSERT
        insert_cols = ["user_id", "title", "author"]
        insert_vals = [user_id, title, author]
        
        # ISBN
        if "isbn" in available_columns and isbn:
            insert_cols.append("isbn")
            insert_vals.append(isbn)
            
        # Notes / Reason
        if "notes" in available_columns:
            insert_cols.append("notes")
            insert_vals.append(notes)
        elif "reason" in available_columns:
            insert_cols.append("reason")
            insert_vals.append(notes)
            
        # Date
        if "created_at" in available_columns:
            insert_cols.append("created_at")
            insert_vals.append(datetime.utcnow())
        elif "suggestion_date" in available_columns:
            insert_cols.append("suggestion_date")
            insert_vals.append(datetime.utcnow())
            
        # Status
        if "status" in available_columns:
            insert_cols.append("status")
            insert_vals.append("pending")
            
        # Execute
        ph = ", ".join(["%s"] * len(insert_vals))
        col_str = ", ".join(insert_cols)
        
        from backend.config.db import get_connection
        conn = get_connection()
        cursor = conn.cursor(dictionary=True)
        try:
            cursor.execute(f"INSERT INTO book_suggestions ({col_str}) VALUES ({ph})", insert_vals)
            conn.commit()
            new_id = cursor.lastrowid
            
            if is_json_request:
                return jsonify({"message": "Success!", "suggestion_id": new_id}), 200
        finally:
            cursor.close()
            conn.close()
            
        flash("‚úÖ Suggestion submitted successfully!", "success")
        return redirect(url_for("member.member_suggest_book"))
        
    except Exception as e:
        current_app.logger.error(f"Error in member_suggest_book (POST): {str(e)}")
        msg = f"Error submitting suggestion: {str(e)}"
        if is_json_request: return jsonify({"error": msg}), 500
        flash(f"‚ùå {msg}", "error")
        return redirect(url_for("member.member_suggest_book"))


@member_bp.route("/delete-account", methods=["POST"])
@member_required
def member_delete_my_account():
    """
    Allows a member to delete their own account.
    """
    from flask import flash, redirect, session
    from backend.services.user_service import delete_user
    
    user_id = session.get("user_id")
    result = delete_user(user_id)
    
    if "‚úÖ" in result or "successfully" in result.lower():
        # Clear session after deletion
        session.clear()
        flash("Your account has been permanently deleted.")
        return redirect("/")
    else:
        flash(result, "error")
        return redirect("/member/dashboard")


@member_bp.route("/review/add", methods=["POST"])
@member_required
def member_submit_review():
    """
    Handles review submission.
    """
    from flask import request, redirect, flash, session
    from backend.services.review_service import add_review
    
    user_id = session.get("user_id")
    book_id = request.form.get("book_id")
    rating = request.form.get("rating")
    comment = request.form.get("comment")
    
    if not rating:
        flash("‚ùå Please provide a rating.", "error")
        return redirect(f"/member/catalog") # Ideally redirect to book details
        
    result = add_review(user_id, book_id, int(rating), comment)
    
    # Gamification Hook
    if "‚úÖ" in result:
        try:
            from backend.services.gamification_service import check_and_award_badges
            new_badges = check_and_award_badges(user_id, 'review')
            if new_badges:
                flash(f"üèÜ You earned new badges: {', '.join(new_badges)}!", "success")
            
            from backend.services.activity_service import log_user_activity
            log_user_activity(user_id, "REVIEW", f"Reviewed book #{book_id}")
        except Exception as e:
            print(f"Gamification/Activity Error: {e}")
            
    flash(result)
    
    # Stay on catalog for now, or redirect to Referer
    return redirect(request.referrer or "/member/catalog")


@member_bp.route("/profile")
@member_required
def member_profile():
    """renders the profile page"""
    from backend.services.gamification_service import get_user_badges
    from backend.repository.db_access import fetch_one # Direct DB access to bypass stale service
    
    user_id = session["user_id"]
    
    # Direct Query to ensure we get the profile_pic (Bypassing potential stale user_service)
    user = fetch_one(
        "SELECT user_id, name, email, role, created_at, profile_pic FROM users WHERE user_id = %s",
        (user_id,)
    )
    
    badges = get_user_badges(user_id)
    
    # DEBUG: Check if profile_pic is present
    print(f"üë§ Profile Page: User Data = {user}", flush=True)
    
    return render_template("member/profile.html", active_page="member_profile", profile_user=user, badges=badges)


@member_bp.route("/api/leaderboard")
@member_required
def member_api_leaderboard():
    """Returns Top 50 Readers (JSON) for the Community Leaderboard."""
    from backend.services.social_service import get_leaderboard
    leaderboard = get_leaderboard(limit=50)
    return jsonify(leaderboard)


@member_bp.route("/profile/<int:user_id>")
@member_required
def member_public_profile(user_id):
    """
    Renders the public profile of another user.
    Respects privacy settings.
    """
    from backend.services.social_service import get_public_profile
    from backend.services.gamification_service import get_user_badges
    
    # Don't show public profile for self, redirect to private profile edit
    if user_id == session["user_id"]:
        return redirect("/member/profile")
        
    data, error = get_public_profile(user_id, session["user_id"])
    
    if error:
        flash(f"üîí {error}", "error")
        return redirect("/member/community")
        
    badges = get_user_badges(user_id)
    
    return render_template(
        "member/public_profile.html",
        active_page="member_community", # Keep community active
        profile=data,
        badges=badges
    )

@member_bp.route("/profile/upload", methods=["POST"])
@member_required
def upload_profile_pic():
    """Handles avatar upload"""
    from werkzeug.utils import secure_filename
    import os
    
    if 'avatar' not in request.files:
        flash("‚ùå No file selected", "error")
        return redirect("/member/profile")
        
    file = request.files['avatar']
    if file.filename == '':
        flash("‚ùå No file selected", "error")
        return redirect("/member/profile")
        
    if file:
        try:
            filename = secure_filename(f"user_{session['user_id']}_{int(datetime.now().timestamp())}.png")
            
            # Method 3: Absolute Path via Pathlib (Bulletproof)
            from pathlib import Path
            
            # This file is: .../backend/routes/member_routes.py
            # We want: .../static/uploads/avatars
            
            current_file = Path(__file__).resolve()
            project_root = current_file.parent.parent.parent # routes -> backend -> pythonProject
            upload_dir = project_root / "static" / "uploads" / "avatars"
            
            # Print for debug
            print(f"üìÇ Upload Target Path (Pathlib): {upload_dir}", flush=True)
            
            os.makedirs(upload_dir, exist_ok=True)
            
            save_path = os.path.join(upload_dir, filename)
            file.save(save_path)
            
            # Update DB
            # We store relative path 'uploads/avatars/...' so templating is easy
            db_path = f"uploads/avatars/{filename}"
            
            execute_query(
                "UPDATE users SET profile_pic = %s WHERE user_id = %s",
                (db_path, session["user_id"])
            )
            
            # Update session too so layout updates immediately
            session['profile_pic'] = db_path
            
            flash("‚úÖ Profile picture updated!", "success")
        except Exception as e:
            flash(f"‚ùå Upload failed: {str(e)}", "error")
            
    return redirect("/member/profile")






@member_bp.route("/profile/update", methods=["POST"])
@member_required
def member_update_profile():
    """Updates basic profile info (name, bio)"""
    from backend.services.user_service import update_user_bio
    from backend.repository.db_access import execute
    
    user_id = session["user_id"]
    data = request.get_json() or {}
    
    bio = data.get("bio", "").strip()
    name = data.get("name", "").strip()
    
    try:
        if bio:
            update_user_bio(user_id, bio)
        
        if name:
            execute("UPDATE users SET name = %s WHERE user_id = %s", (name, user_id))
            session["name"] = name # Update session cache
            
        return jsonify({"success": True})
    except Exception as e:
        return jsonify({"error": str(e)}), 400

@member_bp.route("/ai-chat", methods=["GET", "POST"])
@member_required
def member_ai_chat():
    """
    Renders the AI Assistant Chat Interface.
    Handlers API requests for chat interaction.
    """
    from flask import render_template, request, jsonify, session
    from backend.brain.orchestrator import brain
    
    # API Handler
    if request.method == "POST":
        data = request.json
        user_message = data.get("message")
        history = data.get("history", []) # List of {role, content}
        
        if not user_message:
            return jsonify({"error": "Empty message"}), 400
            
        # Process with Brain (LLM + RAG)
        ai_response = brain.process_message(user_message, history)
        
        return jsonify({
            "response": ai_response,
            "timestamp": "Just now"
        })
    
    # Page Render
    return render_template(
        "member/ai_chat.html",
        active_page="ai_chat",
        user=session.get("user")
    )


@member_bp.route("/waitlist/join", methods=["POST"])
@member_required
def join_waitlist_route():
    from backend.services.reservation_service import join_waitlist
    
    user_id = session.get("user_id")
    book_id = request.form.get("book_id")
    
    result = join_waitlist(user_id, book_id)
    flash(result)
    return redirect("/member/catalog")


@member_bp.route("/wishlist")
@member_required
def member_wishlist():
    from backend.services.wishlist_service import get_user_wishlist
    books = get_user_wishlist(session["user_id"])
    return render_template("member/wishlist.html", active_page="member_wishlist", books=books)

@member_bp.route("/wishlist/add", methods=["POST"])
@member_required
def add_wishlist_route():
    from backend.services.wishlist_service import add_to_wishlist
    result = add_to_wishlist(session["user_id"], request.form.get("book_id"))
    flash(result)
    return redirect(request.referrer or "/member/catalog")

@member_bp.route("/wishlist/remove", methods=["POST"])
@member_required
def remove_wishlist_route():
    from backend.services.wishlist_service import remove_from_wishlist
    result = remove_from_wishlist(session["user_id"], request.form.get("book_id"))
    flash(result)
    return redirect("/member/wishlist")


@member_bp.route("/support", methods=["GET", "POST"])
@member_required
def member_support():
    from backend.services.support_service import create_ticket, get_user_tickets
    
    if request.method == "POST":
        subject = request.form.get("subject")
        message = request.form.get("message")
        result = create_ticket(session["user_id"], subject, message)
        flash(result)
        return redirect("/member/support")
        
    tickets = get_user_tickets(session["user_id"])
    return render_template("member/support.html", active_page="member_support", tickets=tickets)

@member_bp.route("/support/<int:ticket_id>", methods=["GET", "POST"])
@member_required
def member_ticket_view(ticket_id):
    from backend.services.support_service import get_ticket_details, add_reply
    
    if request.method == "POST":
        message = request.form.get("message")
        result = add_reply(ticket_id, session["user_id"], message)
        flash(result)
        return redirect(f"/member/support/{ticket_id}")
        
    data = get_ticket_details(ticket_id)
    if not data:
        flash("‚ùå Ticket not found", "error")
        return redirect("/member/support")
        
    return render_template("member/ticket_view.html", active_page="member_support", **data)


@member_bp.route("/api-keys", methods=["GET"])
@member_required
def member_api_keys_view():
    from backend.services.api_service import get_user_keys
    keys = get_user_keys(session["user_id"])
    return render_template("member/api_keys.html", active_page="member_api_keys", keys=keys)

@member_bp.route("/api-keys/generate", methods=["POST"])
@member_required
def generate_api_key_route():
    from backend.services.api_service import generate_key
    key = generate_key(session["user_id"])
    if key:
        flash(f"‚úÖ New API Key Generated: {key}")
    else:
        flash("‚ùå Failed to generate key")
    return redirect("/member/api-keys")

@member_bp.route("/api-keys/delete/<int:key_id>", methods=["POST"])
@member_required
def delete_api_key_route(key_id):
    from backend.services.api_service import delete_key
    result = delete_key(key_id, session["user_id"])
    flash(result)
    return redirect("/member/api-keys")

@member_bp.route("/ai/chat", methods=["POST"])
@member_required
def ai_chat_route():
    """Endpoint for the floating AI librarian chatbot."""
    data = request.get_json()
    user_query = data.get("prompt", "")
    
    if not user_query:
        return jsonify({"response": "I didn't catch that. Could you repeat?"})
        
    from backend.services.ai_service import chat_with_librarian
    response = chat_with_librarian(user_query)
    
    return jsonify({"response": response})

@member_bp.route("/ai/discovery", methods=["GET", "POST"])
@member_required
def ai_discovery_route():
    """Renders the AI Discovery page and handles 'vibe' requests."""
    if request.method == "POST":
        data = request.get_json()
        vibe = data.get("vibe", "")
        if not vibe:
            return jsonify({"response": "Tell me a bit about your mood or what you're looking for!"})
            
        from backend.services.discovery_service import discover_by_vibe
        response = discover_by_vibe(vibe)
        return jsonify({"response": response})
        
    return render_template("member/discovery.html", active_page="member_discovery")

@member_bp.route("/search_users_json", methods=["GET"])
@member_required
def search_users_json():
    """Returns a JSON list of users matching the query."""
    query = request.args.get('q', '')
    if len(query) < 2:
        return jsonify({"users": []})
        
    search_id = None
    # Robust ID Parsing: Extract digits and check if valid Public ID
    import re
    digits = re.sub(r'\D', '', query) # Remove non-digits
    
    # Logic: If raw digits match a potential Public ID (>= 1000000000)
    if digits and len(digits) >= 9:
        try:
            val = int(digits)
            if val >= 1000000000:
                search_id = val - 1000000000
        except:
            pass

    # Fallback: If user typed raw ID (e.g. "5") - unlikely but possible
    if search_id is None and query.isdigit():
        try:
            search_id = int(query)
        except:
            pass
            
    if search_id:
        users = fetch_all("""
            SELECT user_id, name, profile_pic, role 
            FROM users 
            WHERE user_id = %s OR name LIKE %s OR role LIKE %s
            LIMIT 10
        """, (search_id, f"%{query}%", f"%{query}%"))
    else:
        users = fetch_all("""
            SELECT user_id, name, profile_pic, role 
            FROM users 
            WHERE name LIKE %s OR role LIKE %s
            LIMIT 10
        """, (f"%{query}%", f"%{query}%"))
    
    return jsonify({"users": users})

@member_bp.app_template_filter('datetimeformat')
def datetimeformat(value, format='%Y-%m-%d %H:%M'):
    if value is None:
        return ""
    return value.strftime(format)

</file>

<file path="backend\routes\system_routes.py">
from flask import Blueprint, request, current_app
import os
from database.init_db import run_schema
from database.seed_data import main as run_seed

system_bp = Blueprint('system', __name__)

@system_bp.route('/system/initialize-db-cloud-sync')
def initialize_db():
    """
    Hidden route to initialize the database from the cloud server.
    Bypasses local network port 3306 restrictions.
    """
    # Simple security check using the FLASK_SECRET_KEY
    token = request.args.get('token')
    expected_token = os.getenv('FLASK_SECRET_KEY', 'default-dev-token')
    
    if token != expected_token:
        return "‚ùå Unauthorized: Invalid initialization token.", 403

    output = []
    output.append("üèóÔ∏è --- STARTING CLOUD INITIALIZATION ---")
    
    # 1. Run Schema
    msg_schema, success_schema = run_schema()
    output.append(msg_schema)
    
    if not success_schema:
        return "<pre>" + "\n".join(output) + "\n‚ùå FAILED during schema creation.</pre>", 500
        
    # 2. Run Seeding
    # Note: seed_data.main prints to stdout, we might want to capture or refactor it
    # For now, let's just trigger it.
    output.append("\nüå± --- STARTING DATA SEEDING ---")
    try:
        run_seed() # This will seed users and 30 books
        output.append("‚úÖ Seeding triggered successfully.")
    except Exception as e:
        output.append(f"‚ùå Seeding Error: {e}")
        
    output.append("\nüéâ --- CLOUD INITIALIZATION COMPLETE ---")
    output.append("You can now go to the login page and use admin@library.com")
    
    return "<pre>" + "\n".join(output) + "</pre>"

</file>

<file path="backend\routes\test_auth.py">
from flask import Blueprint, jsonify
from backend.repository.db_access import fetch_all, fetch_one

test_auth_bp = Blueprint('test_auth', __name__)

@test_auth_bp.route('/test/auth/check-users')
def check_users():
    try:
        # Check if users table exists
        table_exists = fetch_one("SHOW TABLES LIKE 'users'")
        if not table_exists:
            return jsonify({
                'status': 'error',
                'message': 'Users table does not exist',
                'solution': 'Run database migrations to create the users table'
            })
        
        # Get all users (for debugging only!)
        users = fetch_all("SELECT user_id, email, name, role FROM users")
        
        return jsonify({
            'status': 'success',
            'table_exists': True,
            'user_count': len(users),
            'users': users
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

</file>

<file path="backend\routes\test_db.py">
from flask import Blueprint, jsonify
from backend.repository.db_access import fetch_all

test_bp = Blueprint('test', __name__)

@test_bp.route('/test/db-schema')
def test_db_schema():
    try:
        # Get table structure
        table_info = fetch_all("SHOW CREATE TABLE book_suggestions")
        
        # Get column details
        columns = fetch_all("""
            SELECT COLUMN_NAME, DATA_TYPE, IS_NULLABLE, COLUMN_KEY, 
                   COLUMN_DEFAULT, EXTRA, CHARACTER_MAXIMUM_LENGTH
            FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = 'book_suggestions'
            ORDER BY ORDINAL_POSITION
        """)
        
        # Get sample data (first 5 rows)
        sample_data = fetch_all("SELECT * FROM book_suggestions LIMIT 5")
        
        return jsonify({
            'create_table': table_info[0][1] if table_info else 'Table not found',
            'columns': columns,
            'sample_data': sample_data,
            'status': 'success'
        })
    except Exception as e:
        return jsonify({
            'error': str(e),
            'status': 'error',
            'hint': 'Make sure the book_suggestions table exists and is accessible'
        }), 500

</file>

<file path="backend\routes\__init__.py">

</file>

<file path="backend\services\activity_service.py">

from backend.repository.db_access import execute_query, fetch_all

def log_user_activity(user_id, activity_type, description):
    try:
        execute_query(
            "INSERT INTO user_activities (user_id, activity_type, description) VALUES (%s, %s, %s)",
            (user_id, activity_type, description)
        )
    except Exception as e:
        print(f"Failed to log user activity: {e}")

def get_user_activities(user_id, limit=10):
    return fetch_all(
        "SELECT * FROM user_activities WHERE user_id = %s ORDER BY created_at DESC LIMIT %s",
        (user_id, limit)
    )

</file>

<file path="backend\services\ai_service.py">

# backend/services/ai_service.py

from backend.repository.db_access import fetch_all
import re

def recommend_books_by_mood(user_text):
    """
    A local, rule-based AI that interprets user mood and recommends books.
    No API keys required. 100% Free.
    """
    user_text = user_text.lower()
    
    # 1. Define Mood Mappings (Knowledge Base)
    # Format: 'mood_keyword': ['matching_category_1', 'matching_category_2']
    mood_map = {
        'happy': ['comedy', 'adventure', 'comic', 'romance'],
        'joy': ['comedy', 'romance'],
        'fun': ['comedy', 'adventure', 'comic'],
        'laugh': ['comedy', 'comic'],
        
        'sad': ['drama', 'biography', 'history', 'poetry'],
        'depressed': ['drama', 'philosophy', 'biography'],
        'cry': ['drama', 'romance'],
        'lonely': ['biography', 'fiction'],
        
        'angry': ['thriller', 'mystery', 'action', 'politics'],
        'frustrated': ['philosophy', 'self-help', 'psychology'],
        'stress': ['fantasy', 'fiction', 'comedy'],
        
        'bored': ['fantasy', 'sci-fi', 'mystery', 'thriller'],
        'curious': ['science', 'history', 'non-fiction', 'technology'],
        'learn': ['education', 'science', 'history'],
        'smart': ['philosophy', 'science'],
        
        'inspired': ['biography', 'business', 'self-help'],
        'motivated': ['business', 'sports', 'biography'],
        
        'scared': ['horror', 'thriller'],
        'adventurous': ['adventure', 'travel', 'fantasy'],
        
        'chill': ['fiction', 'poetry', 'art'],
        'relax': ['fiction', 'romance', 'fantasy']
    }
    
    # 2. Analyze User Input (Semantic Matching)
    detected_categories = set()
    detected_moods = []
    
    # Direct keyword match
    for mood, categories in mood_map.items():
        if re.search(r'\b' + re.escape(mood) + r'\b', user_text):
            detected_moods.append(mood)
            detected_categories.update(categories)
            
    # If no moods detected, check for direct category mentions
    if not detected_categories:
        all_cats = fetch_all("SELECT DISTINCT category FROM books")
        for c in all_cats:
            cat_name = c['category'].lower()
            if cat_name in user_text:
                detected_categories.add(c['category'])
                detected_moods.append(f"interested in {cat_name}")

    # 3. Query Database
    if not detected_categories:
        # Fallback: Random "Surprise Me" selection
        return {
            "moods": ["indifferent", "open-minded"],
            "message": "I couldn't quite catch your specific mood, so here are some popular picks from our collection!",
            "books": fetch_all("SELECT * FROM books ORDER BY RAND() LIMIT 5")
        }
    
    # Format categories for SQL
    placeholders = ', '.join(['%s'] * len(detected_categories))
    query = f"""
        SELECT b.*, a.name as author_name 
        FROM books b
        LEFT JOIN authors a ON b.author_id = a.author_id
        WHERE LOWER(b.category) IN ({placeholders})
        ORDER BY RAND()
        LIMIT 6
    """
    
    books = fetch_all(query, tuple(detected_categories))
    
    return {
        "moods": detected_moods,
        "message": f"I see you're feeling {' and '.join(detected_moods[:3])}. tailored these selections just for you:",
        "books": books
    }

</file>

<file path="backend\services\analytics_service.py">

from backend.repository.db_access import fetch_all, fetch_one

def get_monthly_borrowing_stats():
    """Returns number of books issued per month for the last 6 months."""
    return fetch_all("""
        SELECT 
            DATE_FORMAT(issue_date, '%b %Y') as month,
            COUNT(*) as count
        FROM issues
        WHERE issue_date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
        GROUP BY month
        ORDER BY MIN(issue_date) ASC
    """)

def get_category_stats():
    """Returns total books and total issues per category."""
    return fetch_all("""
        SELECT 
            b.category,
            COUNT(DISTINCT b.book_id) as total_books,
            COUNT(i.issue_id) as total_issues
        FROM books b
        LEFT JOIN issues i ON b.book_id = i.book_id
        GROUP BY b.category
        ORDER BY total_issues DESC
        LIMIT 10
    """)

def get_user_engagement_stats():
    """Returns user breakdown based on activity."""
    return fetch_all("""
        SELECT 
            role,
            COUNT(*) as count
        FROM users
        GROUP BY role
    """)

def get_quick_stats():
    """Returns card-style stats for the dashboard overview."""
    books = fetch_one("SELECT COUNT(*) as c FROM books")
    users = fetch_one("SELECT COUNT(*) as c FROM users")
    issues = fetch_one("SELECT COUNT(*) as c FROM issues")
    fines = fetch_one("SELECT SUM(fine) as s FROM issues")
    
    return {
        "total_books": books['c'],
        "total_users": users['c'],
        "total_issues": issues['c'],
        "total_fines": fines['s'] or 0
    }

</file>

<file path="backend\services\api_service.py">

import secrets
import string
from backend.repository.db_access import execute_query, fetch_all, fetch_one

def generate_key(user_id):
    # Generate a random 32-character key
    alphabet = string.ascii_letters + string.digits
    key = ''.join(secrets.choice(alphabet) for i in range(32))
    
    try:
        execute_query("INSERT INTO api_keys (user_id, api_key) VALUES (%s, %s)", (user_id, key))
        return key
    except Exception as e:
        print(f"Key generation failed: {e}")
        return None

def get_user_keys(user_id):
    return fetch_all("SELECT * FROM api_keys WHERE user_id = %s ORDER BY created_at DESC", (user_id,))

def delete_key(key_id, user_id):
    execute_query("DELETE FROM api_keys WHERE key_id = %s AND user_id = %s", (key_id, user_id))
    return "‚úÖ Key deleted."

def validate_key(key):
    res = fetch_one("SELECT user_id FROM api_keys WHERE api_key = %s", (key,))
    return res['user_id'] if res else None

</file>

<file path="backend\services\audit_service.py">

from backend.repository.db_access import execute_query, fetch_all

def log_action(admin_id, action, details=None):
    """
    Logs an administrative action.
    """
    try:
        execute_query(
            "INSERT INTO audit_logs (admin_id, action, details) VALUES (%s, %s, %s)",
            (admin_id, action, details)
        )
    except Exception as e:
        print(f"‚ùå Failed to log action: {e}")

def get_audit_logs(limit=50):
    """
    Fetches recent audit logs.
    """
    return fetch_all(
        """
        SELECT l.log_id, u.name AS admin_name, l.action, l.details, l.timestamp
        FROM audit_logs l
        JOIN users u ON l.admin_id = u.user_id
        ORDER BY l.timestamp DESC
        LIMIT %s
        """,
        (limit,)
    )

</file>

<file path="backend\services\author_service.py">

from backend.repository.db_access import fetch_all, fetch_one, execute

def get_author_details(author_id):
    """Fetches full bio and metadata for an author."""
    return fetch_one("SELECT * FROM authors WHERE author_id = %s", (author_id,))

def get_author_books(author_id):
    """Fetches all books written by a specific author."""
    return fetch_all("""
        SELECT book_id, title, category, available_copies, pdf_src 
        FROM books 
        WHERE author_id = %s
    """, (author_id,))

def get_series_details(series_id):
    """Fetches description and title for a series."""
    return fetch_one("SELECT series_id, name as title, description, created_at FROM series WHERE series_id = %s", (series_id,))

def get_series_books(series_id):
    """Fetches all books in a series, ordered by their sequence."""
    return fetch_all("""
        SELECT book_id, title, series_order 
        FROM books 
        WHERE series_id = %s 
        ORDER BY series_order ASC
    """, (series_id,))

def update_author_bio(author_id, bio, nationality=None):
    """Updates author information."""
    if nationality:
        execute("UPDATE authors SET bio = %s, nationality = %s WHERE author_id = %s", (bio, nationality, author_id))
    else:
        execute("UPDATE authors SET bio = %s WHERE author_id = %s", (bio, author_id))
    return "‚úÖ Author updated"

def get_all_authors():
    """Returns a list of all authors for dropdowns/discovery."""
    return fetch_all("SELECT author_id, name FROM authors ORDER BY name ASC")

def get_all_series():
    """Returns a list of all series with book counts."""
    return fetch_all("""
        SELECT s.series_id, s.name as title, s.description, 
               (SELECT COUNT(*) FROM books b WHERE b.series_id = s.series_id) as book_count 
        FROM series s 
        ORDER BY s.name ASC
    """)

</file>

<file path="backend\services\auth_service.py">
"""
auth_service.py
----------------
Handles authentication logic.

Responsibilities:
- Validate user credentials
- Verify hashed passwords
- Return user details for session creation

This module:
- Contains NO Flask code
- Contains NO session handling
- Contains NO database connection logic
"""

# ===============================
# IMPORTS
# ===============================

from backend.repository.db_access import fetch_one
# fetch_one ‚Üí retrieves a single record from the database (SELECT ... LIMIT 1)

from backend.utils.security import verify_password
# verify_password ‚Üí compares plaintext password with hashed password (bcrypt)


# ===============================
# AUTHENTICATION FUNCTION
# ===============================

def authenticate_user(email: str, password: str):
    """
    Validates user credentials.

    Args:
        email (str): User email entered during login
        password (str): Plain-text password entered during login

    Returns:
        dict ‚Üí user data if credentials are valid
        None ‚Üí if authentication fails
    """

    # -----------------------------
    # BASIC INPUT VALIDATION
    # -----------------------------

    # Reject empty email or password
    if not email or not password:
        return None

    # -----------------------------
    # FETCH USER FROM DATABASE
    # -----------------------------

    # Query database for user record using email
    user = fetch_one(
        """
        SELECT
            user_id,               -- Unique user identifier
            name,                  -- Full name
            email,                 -- Email address
            password_hash,         -- Hashed password (bcrypt)
            role,                  -- User role (admin / member)
            must_change_password,   -- Flag for first-login password change
            profile_pic,
            bio,
            is_public
        FROM users
        WHERE email = %s
        """,
        (email,)
    )

    # -----------------------------
    # USER EXISTENCE CHECK
    # -----------------------------

    # If no user found with given email
    if not user:
        return None

    # -----------------------------
    # PASSWORD VERIFICATION
    # -----------------------------

    # Compare entered password with stored hashed password
    if not verify_password(password, user["password_hash"]):
        return None

    # -----------------------------
    # AUTHENTICATION SUCCESS
    # -----------------------------

    # Return user data for session creation
    return user

def get_user_by_id(user_id):
    """Fetch user details by ID."""
    return fetch_one(
        "SELECT user_id, name, email, role, profile_pic, bio, is_public FROM users WHERE user_id = %s",
        (user_id,)
    )

</file>

<file path="backend\services\book_service.py">
"""
book_service.py
----------------
Handles book-related operations.

Responsibilities:
- Add new books
- View existing books
- Fetch a single book
- Delete books

This module:
- Contains business logic related to books
- Uses repository layer for database access
- Does NOT contain Flask routes
"""

# ===============================
# IMPORTS
# ===============================

from backend.repository.db_access import fetch_all, fetch_one, execute
# fetch_all ‚Üí retrieve multiple records (SELECT)
# fetch_one ‚Üí retrieve a single record
# execute   ‚Üí execute INSERT / UPDATE / DELETE queries


# ===============================
# ADD BOOK
# ===============================

def add_book(title, author_id, category, total_copies, pdf_src=None, series_id=None, series_order=None):
    """
    Adds a new book to the library with relational author/series support.
    """

    if total_copies <= 0:
        return "‚ùå Total copies must be positive"

    book_id = execute(
        """
        INSERT INTO books
            (title, author_id, category, total_copies, available_copies, pdf_src, series_id, series_order)
        VALUES
            (%s, %s, %s, %s, %s, %s, %s, %s)
        """,
        (title, author_id, category, total_copies, total_copies, pdf_src, series_id, series_order)
    )

    return book_id


# ===============================
# UPDATE BOOK
# ===============================

def update_book(book_id, title, author_id, category, total_copies, series_id=None, series_order=None):
    """
    Updates existing book details and intelligently manages inventory counts.
    """
    book = get_book(book_id)
    if not book:
        return "‚ùå Book not found"

    # Calculate stock adjustment
    diff = total_copies - book['total_copies']
    new_available = book['available_copies'] + diff

    if new_available < 0:
        return f"‚ùå Cannot reduce stock to {total_copies}. {abs(new_available)} copies are currently issued."

    execute(
        """
        UPDATE books 
        SET title = %s, author_id = %s, category = %s, total_copies = %s, 
            available_copies = %s, series_id = %s, series_order = %s
        WHERE book_id = %s
        """,
        (title, author_id, category, total_copies, new_available, series_id, series_order, book_id)
    )

    return "‚úÖ Book updated successfully"


# ===============================
# VIEW ALL BOOKS (PAGINATED & SEARCHABLE)
# ===============================

def view_books_paginated(page: int = 1, per_page: int = 10, search_query: str = "", author_id: int = None, category_filter: str = None):
    """
    Fetches books with enriched author and series metadata.
    """
    offset = (page - 1) * per_page
    
    # Base Query with JOINs
    query = """
        SELECT b.*, a.name as author_name, s.name as series_title 
        FROM books b
        LEFT JOIN authors a ON b.author_id = a.author_id
        LEFT JOIN series s ON b.series_id = s.series_id
        WHERE 1=1
    """
    params = []
    
    if search_query:
        query += " AND (b.title LIKE %s OR a.name LIKE %s OR b.category LIKE %s)"
        pattern = f"%{search_query}%"
        params.extend([pattern, pattern, pattern])
        
    if author_id:
        query += " AND b.author_id = %s"
        params.append(author_id)
        
    if category_filter:
        query += " AND b.category = %s"
        params.append(category_filter)
        
    count_query = query.replace("SELECT b.*, a.name as author_name, s.name as series_title", "SELECT COUNT(*) AS c", 1)
    count_params = params.copy()
    
    query += " ORDER BY b.title ASC LIMIT %s OFFSET %s"
    params.extend([per_page, offset])
    
    books = fetch_all(query, tuple(params))
    total_count = fetch_one(count_query, tuple(count_params))["c"]
    
    import math
    return {
        "books": books,
        "total": total_count,
        "page": page,
        "per_page": per_page,
        "total_pages": math.ceil(total_count / per_page)
    }


def view_books():
    """
    Legacy helper: Fetches ALL books without pagination.
    Avoid using for large datasets.
    """
    return fetch_all("SELECT * FROM books ORDER BY title ASC")


# ===============================
# GET SINGLE BOOK
# ===============================

def get_book(book_id: int):
    """
    Fetch a single book with author and series info.
    """
    return fetch_one(
        """
        SELECT b.*, a.name as author_name, s.name as series_title 
        FROM books b
        LEFT JOIN authors a ON b.author_id = a.author_id
        LEFT JOIN series s ON b.series_id = s.series_id
        WHERE b.book_id = %s
        """,
        (book_id,)
    )


# ===============================
# DELETE BOOK
# ===============================

def delete_book(book_id: int):
    """
    Deletes a book from the system.

    Args:
        book_id (int): Primary key of the book

    Returns:
        Status message indicating success or failure
    """

    # Execute delete query
    affected = execute(
        "DELETE FROM books WHERE book_id = %s",
        (book_id,)
    )

    # If no rows were affected, book does not exist
    if affected == 0:
        return "‚ùå Book not found"

    # Confirm deletion
    return "üóëÔ∏è Book deleted successfully"


def import_books_csv(file_stream):
    """
    Imports books from a CSV file stream.
    Expected columns: Title, Author, Category, Copies
    """
    import pandas as pd
    import io
    
    try:
        # Read CSV
        df = pd.read_csv(file_stream)
        
        # Normalize headers: strip space, lower case
        df.columns = [c.strip().lower() for c in df.columns]
        
        required = {'title', 'author', 'category', 'copies'}
        if not required.issubset(df.columns):
            return f"‚ùå CSV missing required columns: {required - set(df.columns)}"
            
        success_count = 0
        errors = []
        
        for index, row in df.iterrows():
            try:
                title = str(row['title']).strip()
                author = str(row['author']).strip()
                category = str(row['category']).strip()
                copies = int(row['copies'])
                
                if copies < 1:
                    errors.append(f"Row {index+1}: Copies must be > 0")
                    continue
                    
                # Call add_book
                add_book(title, author, category, copies)
                success_count += 1
                
            except Exception as row_err:
                errors.append(f"Row {index+1}: {str(row_err)}")
                
        result = f"‚úÖ Imported {success_count} books."
        if errors:
            result += f" ( {len(errors)} failed inputs)"
            # Optionally log errors
            
        return result
        
    except Exception as e:
        return f"‚ùå Import failed: {str(e)}"

def get_all_authors():
    """Returns authors from the normalized authors table."""
    return fetch_all("SELECT * FROM authors ORDER BY name ASC")

def get_all_categories():
    return fetch_all("SELECT DISTINCT category FROM books ORDER BY category")

</file>

<file path="backend\services\bulk_service.py">

import csv
import io
from backend.repository.db_access import fetch_all, execute

def export_books_csv():
    """Returns the entire book catalog as a CSV formatted string."""
    books = fetch_all("SELECT title, author, category, copies FROM books")
    
    output = io.StringIO()
    writer = csv.writer(output)
    
    # Header
    writer.writerow(['Title', 'Author', 'Category', 'Total Copies'])
    
    # Data
    for b in books:
        writer.writerow([b['title'], b['author'], b['category'], b['copies']])
        
    return output.getvalue()

def import_books_csv(stream):
    """
    Parses a CSV file stream and imports books into the database.
    Format: Title, Author, Category, Copies
    """
    try:
        data = stream.read().decode('utf-8')
        reader = csv.DictReader(io.StringIO(data))
        
        imported_count = 0
        errors = []
        
        for row in reader:
            try:
                title = row.get('Title') or row.get('title')
                author = row.get('Author') or row.get('author')
                category = row.get('Category') or row.get('category')
                copies = int(row.get('Total Copies') or row.get('copies') or 1)
                
                if not title or not author:
                    continue
                
                execute(
                    """
                    INSERT INTO books (title, author, category, copies, available_copies)
                    VALUES (%s, %s, %s, %s, %s)
                    """,
                    (title, author, category, copies, copies)
                )
                imported_count += 1
            except Exception as e:
                errors.append(f"Row {reader.line_num}: {str(e)}")
        
        return {
            "success": True, 
            "message": f"‚úÖ Successfully imported {imported_count} books.",
            "errors": errors
        }
    except Exception as e:
        return {"success": False, "message": f"‚ùå Import failed: {str(e)}"}

</file>

<file path="backend\services\channel_service.py">
from backend.repository.db_access import execute, fetch_one, fetch_all, get_connection
from backend.services.chat_service import get_or_create_anon_id

def create_channel(guild_id, category_id, name, type='text', topic=None, is_private=False, creator_id=None):
    """Creates a new channel in a guild or global."""
    cid = execute("""
        INSERT INTO channels (guild_id, category_id, name, type, topic, is_private)
        VALUES (%s, %s, %s, %s, %s, %s)
    """, (guild_id, category_id, name, type, topic, is_private))
    
    # Always add creator as admin participant (so they persist if switched private/public)
    if creator_id:
        execute("INSERT INTO dm_participants (channel_id, user_id, role) VALUES (%s, %s, 'admin')", (cid, creator_id))
        
    return cid

def get_channel_messages(channel_id, limit=50):
    """Fetches messages for a channel with user profile data."""
    messages = fetch_all("""
        SELECT 
            m.message_id, m.message_text as content, m.file_url, m.sent_at as created_at, m.sender_type,
            u.user_id as sender_id, u.name as sender_name, u.profile_pic as sender_pic,
            ca.anon_id
        FROM chat_messages m
        LEFT JOIN chat_anon_id ca ON m.anon_id = ca.anon_id
        LEFT JOIN users u ON ca.user_id = u.user_id
        WHERE m.channel_id = %s AND m.is_deleted = FALSE
        ORDER BY m.sent_at DESC LIMIT %s
    """, (channel_id, limit))
    
    # Format dates and handle anonymity for JSON
    for msg in messages:
        if msg['created_at']:
            msg['created_at'] = msg['created_at'].strftime("%Y-%m-%d %H:%M:%S")
        
        # Structure Attachment
        if msg['file_url']:
            import os
            ext = os.path.splitext(msg['file_url'])[1].lower()
            msg['attachment'] = {
                'url': msg['file_url'],
                'type': 'image' if ext in ['.png', '.jpg', '.jpeg', '.gif', '.webp'] else 'file',
                'name': os.path.basename(msg['file_url'])
            }
        else:
            msg['attachment'] = None
            
        # Anonymity Check
        if msg['sender_type'] == 'anon':
            msg['sender_name'] = 'Anonymous Member'
            msg['sender_pic'] = 'default.jpg'
            msg['sender_id'] = None # Hide real ID
            
    return messages

def save_message(user_id, channel_id, text=None, file_url=None, reply_to_id=None, sender_type='user'):
    """Saves a message to the channel."""
    anon_id = get_or_create_anon_id(user_id)
    
    # Ensure sender_type is valid
    if sender_type not in ['anon', 'user']:
        sender_type = 'user'
        
    # Ensure text is not None if DB requires it
    if text is None:
        text = ""

    msg_id = execute("""
        INSERT INTO chat_messages (channel_id, anon_id, message_text, file_url, reply_to_id, sender_type)
        VALUES (%s, %s, %s, %s, %s, %s)
    """, (channel_id, anon_id, text, file_url, reply_to_id, sender_type))
    
    # Return full message object for socket broadcast
    return {
        'message_id': msg_id,
        'channel_id': channel_id,
        'content': text,
        'file_url': file_url,
        'sender_id': user_id,
        'anon_id': anon_id,
        'sender_type': sender_type
    }

def get_my_dms(user_id):
    """Fetches private DM channels for a user."""
    # Assuming dm_participants table is used.
    # If not populated, this returns empty, which is fine for now.
    return fetch_all("""
        SELECT c.channel_id, c.created_at, u.name as partner_name, u.profile_pic as partner_pic
        FROM channels c
        JOIN dm_participants dp1 ON c.channel_id = dp1.channel_id
        JOIN dm_participants dp2 ON c.channel_id = dp2.channel_id
        JOIN users u ON dp2.user_id = u.user_id
        WHERE dp1.user_id = %s 
        AND dp2.user_id != %s
        AND c.guild_id IS NULL AND c.name = 'DM'
        ORDER BY c.created_at DESC
    """, (user_id, user_id))

def create_dm(user_id, target_user_id):
    """Creates or Retrieves a DM channel."""
    # Check if exists
    # (Complex SQL to find intersection of channel_ids for both users)
    existing = fetch_one("""
        SELECT c.channel_id 
        FROM channels c
        JOIN dm_participants dp1 ON c.channel_id = dp1.channel_id
        JOIN dm_participants dp2 ON c.channel_id = dp2.channel_id
        WHERE c.guild_id IS NULL 
        AND dp1.user_id = %s 
        AND dp2.user_id = %s
    """, (user_id, target_user_id))
    
    if existing: return existing['channel_id']
    
    # Create
    cid = execute("INSERT INTO channels (name, type, is_private) VALUES ('DM', 'text', TRUE)")
    
    # Add Participants
    execute("INSERT INTO dm_participants (channel_id, user_id) VALUES (%s, %s)", (cid, user_id))
    execute("INSERT INTO dm_participants (channel_id, user_id) VALUES (%s, %s)", (cid, target_user_id))
    
    return cid

</file>

<file path="backend\services\chat_service.py">
import random
import string
from backend.repository.db_access import fetch_one, fetch_all, execute

def generate_anon_id():
    """Generates a random anonymous ID like 'anon_9fA32X'."""
    suffix = ''.join(random.choices(string.ascii_letters + string.digits, k=6))
    return f"anon_{suffix}"

def get_or_create_anon_id(user_id):
    """
    Retrieves the existing anonymous ID for a user, or creates a new one.
    """
    # Check if exists
    existing = fetch_one("SELECT anon_id FROM chat_anon_id WHERE user_id = %s", (user_id,))
    if existing:
        return existing['anon_id']
    
    # Create new (retry if collision, though unlikely)
    for _ in range(3):
        new_id = generate_anon_id()
        try:
            execute(
                "INSERT INTO chat_anon_id (anon_id, user_id) VALUES (%s, %s)",
                (new_id, user_id)
            )
            return new_id
        except Exception:
            continue # Retry
            
    raise Exception("Failed to generate unique Anonymous ID")

def create_room(user_id, name, room_type):
    """
    Creates a new chat room and adds the creator as 'admin'.
    """
    # 1. Create Room
    execute(
        "INSERT INTO chat_rooms (room_name, room_type, created_by) VALUES (%s, %s, %s)",
        (name, room_type, user_id)
    )
    
    # Get the ID (Warning: fetch_one("SELECT LAST_INSERT_ID()") is safer in same transaction, 
    # but db_access.execute commits immediately. We will query by name/creator/time or use max ID)
    # Ideally db_access should return lastrowid. Inspecting db_access execute... it returns rowcount.
    # We will query max_id for this user.
    room = fetch_one(
        "SELECT room_id FROM chat_rooms WHERE created_by = %s ORDER BY created_at DESC LIMIT 1",
        (user_id,)
    )
    if not room:
        raise Exception("Room creation failed")
    
    room_id = room['room_id']
    
    # 2. Add Creator as Admin
    # First get their anon ID
    anon_id = get_or_create_anon_id(user_id)
    
    join_room_internal(room_id, anon_id, role='admin')
    
    return room_id

def join_room(user_id, room_id, role='member'):
    """
    Public method for a user to join a room.
    """
    room = fetch_one("SELECT room_type FROM chat_rooms WHERE room_id = %s", (room_id,))
    if not room:
        raise Exception("Channel not found")
    
    if room['room_type'] != 'public':
        raise Exception("Unauthorized: This channel is private")

    anon_id = get_or_create_anon_id(user_id)
    return join_room_internal(room_id, anon_id, role)

def join_room_internal(room_id, anon_id, role='member'):
    """
    Adds an anon user to a room. Handles re-joining.
    """
    # Check if already member
    existing = fetch_one(
        "SELECT * FROM room_members WHERE room_id = %s AND anon_id = %s",
        (room_id, anon_id)
    )
    if existing:
        return True # Already there
        
    execute(
        "INSERT INTO room_members (room_id, anon_id, role) VALUES (%s, %s, %s)",
        (room_id, anon_id, role)
    )
    return True

def save_message(user_id, channel_id, text=None, file_path=None, sender_type='anon', reply_to_id=None):
    """
    Saves a message (text or file) from a user to a channel.
    Matches the updated 'channel_id' schema.
    """
    anon_id = get_or_create_anon_id(user_id)
    
    if text is None:
        text = ""

    execute(
        """
        INSERT INTO chat_messages (channel_id, anon_id, message_text, file_url, sender_type, reply_to_id) 
        VALUES (%s, %s, %s, %s, %s, %s)
        """,
        (channel_id, anon_id, text, file_path, sender_type, reply_to_id)
    )
    
    # Return the message object for broadcasting
    return {
        "channel_id": channel_id,
        "anon_id": anon_id,
        "message_text": text,
        "file_url": file_path,
        "sender_type": sender_type,
        "reply_to_id": reply_to_id
    }

def edit_message(user_id, message_id, new_text):
    anon_id = get_or_create_anon_id(user_id)
    
    # Verify ownership
    msg = fetch_one("SELECT * FROM chat_messages WHERE message_id = %s", (message_id,))
    if not msg:
        raise Exception("Message not found")
        
    if msg['anon_id'] != anon_id:
        raise Exception("Unauthorized")
        
    execute(
        "UPDATE chat_messages SET message_text = %s, is_edited = TRUE WHERE message_id = %s",
        (new_text, message_id)
    )
    return True

def delete_message(user_id, message_id):
    anon_id = get_or_create_anon_id(user_id)
    
    # Verify ownership or admin
    msg = fetch_one("SELECT * FROM chat_messages WHERE message_id = %s", (message_id,))
    if not msg:
        raise Exception("Message not found")
        
    if msg['anon_id'] != anon_id:
        # Allow room admin to delete?
        member = fetch_one("SELECT role FROM room_members WHERE room_id = %s AND anon_id = %s", (msg['room_id'], anon_id))
        if not member or member['role'] not in ['admin', 'moderator']:
             raise Exception("Unauthorized")

    execute("UPDATE chat_messages SET is_deleted = TRUE WHERE message_id = %s", (message_id,))
    return True

def invite_user_to_room(room_id, email, requester_id):
    """Invites a user by email to a private room."""
    # Logic: Find user by email, generate invite or force join
    user = fetch_one("SELECT user_id FROM users WHERE email = %s", (email,))
    if not user:
        raise Exception("User not found")
        
    target_user_id = user['user_id']
    
    # Check requester permissions (must be member/admin of room)
    # For now, allow any member to invite? Or just admins?
    # Let's say any member for now.
    
    send_notification = True # We should notify them
    
    # Add to room members directly
    target_anon_id = get_or_create_anon_id(target_user_id)
    join_room_internal(room_id, target_anon_id, role='member')
    
    return True

def get_public_rooms():
    return fetch_all("SELECT * FROM chat_rooms WHERE room_type = 'public' ORDER BY created_at DESC")

def get_my_rooms(user_id):
    anon_id = get_or_create_anon_id(user_id)
    rooms = fetch_all("""
        SELECT r.*, m.role as user_role
        FROM chat_rooms r
        JOIN room_members m ON r.room_id = m.room_id
        WHERE m.anon_id = %s
    """, (anon_id,))
    
    # Enrich private rooms with peer info
    for room in rooms:
        # Only override name for DMs (which default to "Direct Message")
        # Custom private groups should keep their names
        if room['room_type'] == 'private' and room['room_name'] == 'Direct Message':
            # Find the other member (peer)
            peer = fetch_one("""
                SELECT u.name, u.profile_pic, ca.anon_id
                FROM room_members rm
                JOIN chat_anon_id ca ON rm.anon_id = ca.anon_id
                JOIN users u ON ca.user_id = u.user_id
                WHERE rm.room_id = %s AND rm.anon_id != %s
                LIMIT 1
            """, (room['room_id'], anon_id))
            
            if peer:
                room['room_name'] = peer['name']
                room['room_avatar'] = peer['profile_pic']
                room['peer_anon_id'] = peer['anon_id']
                # Expose real user_id to frontend for matching with friend list
                room['peer_user_id'] = fetch_one("SELECT user_id FROM chat_anon_id WHERE anon_id = %s", (peer['anon_id'],))['user_id']
            else:
                 room['room_name'] = "Unknown User"

    return rooms

def update_room(user_id, room_id, name, description, avatar_path=None):
    """Updates room details if the user is the creator."""
    # Verify permissions
    room = fetch_one("SELECT * FROM chat_rooms WHERE room_id = %s", (room_id,))
    if not room:
        raise Exception("Room not found")
        
    # Check if user is owner OR if it's a private chat (DM) where both are equals
    can_edit = False
    if room['created_by'] == user_id:
        can_edit = True
    elif room['room_type'] == 'private':
        # Check if member
        anon_id = get_or_create_anon_id(user_id)
        member = fetch_one("SELECT * FROM room_members WHERE room_id = %s AND anon_id = %s", (room_id, anon_id))
        if member:
            can_edit = True
            
    if not can_edit:
        raise Exception("Unauthorized: You are not the owner")
        
    if avatar_path:
        execute(
            "UPDATE chat_rooms SET room_name = %s, description = %s, room_avatar = %s WHERE room_id = %s",
            (name, description, avatar_path, room_id)
        )
    else:
        execute(
            "UPDATE chat_rooms SET room_name = %s, description = %s WHERE room_id = %s",
            (name, description, room_id)
        )

def delete_room(user_id, room_id):
    """Deletes a room if the user is the creator/admin."""
    # Verify ownership
    room = fetch_one("SELECT * FROM chat_rooms WHERE room_id = %s", (room_id,))
    if not room:
        raise Exception("Room not found")
    
    # Check if user is admin of this room
    anon_id = get_or_create_anon_id(user_id)
    member = fetch_one(
        "SELECT role FROM room_members WHERE room_id = %s AND anon_id = %s",
        (room_id, anon_id)
    )
    
    if room['created_by'] != user_id and (not member or member['role'] != 'admin'):
        raise Exception("Unauthorized: Only admins can delete this channel")
        
    # Cascade delete handles members and messages
    execute("DELETE FROM chat_rooms WHERE room_id = %s", (room_id,))
    return True

def get_or_create_dm_room(user_id1, user_id2):
    """
    Finds an existing DM room between two users or creates a new one.
    """
    if user_id1 == user_id2:
        raise Exception("You cannot DM yourself")
        
    anon_id1 = get_or_create_anon_id(user_id1)
    anon_id2 = get_or_create_anon_id(user_id2)
    
    # Try to find existing private room with exactly these two members
    # We look for a room type 'private' that both users are in.
    room = fetch_one("""
        SELECT r.room_id 
        FROM chat_rooms r
        JOIN room_members m1 ON r.room_id = m1.room_id
        JOIN room_members m2 ON r.room_id = m2.room_id
        WHERE r.room_type = 'private' 
        AND m1.anon_id = %s 
        AND m2.anon_id = %s
        AND (SELECT COUNT(*) FROM room_members rm WHERE rm.room_id = r.room_id) = 2
    """, (anon_id1, anon_id2))
    
    if room:
        return room['room_id']
        
    # Create new private room
    # We'll use a specific naming convention for DMs: "DM: UserA & UserB"
    # But for privacy, we'll just name it "null" or "Private Chat" and let UI handle display
    execute(
        "INSERT INTO chat_rooms (room_name, room_type, created_by) VALUES (%s, %s, %s)",
        ("Direct Message", "private", user_id1)
    )
    
    room = fetch_one(
        "SELECT room_id FROM chat_rooms WHERE created_by = %s AND room_type = 'private' ORDER BY created_at DESC LIMIT 1",
        (user_id1,)
    )
    room_id = room['room_id']
    
    # Add both users
    join_room_internal(room_id, anon_id1, role='member')
    join_room_internal(room_id, anon_id2, role='member')
    
    return room_id


</file>

<file path="backend\services\discovery_service.py">

import os
import requests
from backend.config.config import get_config
from backend.repository.db_access import fetch_all

def discover_by_vibe(user_vibe):
    """
    Uses AI to find books in the catalog that match a user's 'vibe' or mood.
    Supports: Gemini (paid), Hugging Face (free), or local keyword matching.
    """
    config = get_config()
    gemini_key = config.GEMINI_API_KEY
    hf_token = os.getenv('HF_TOKEN')  # Free Hugging Face API token
    
    # Fetch ALL books for semantic mapping (within reasonable limits)
    books = fetch_all("SELECT title, author, category FROM books LIMIT 200")
    book_context = "\n".join([f"- {b['title']} | {b['author']} | {b['category']}" for b in books])
    
    # Method 1: Gemini (if API key provided)
    if gemini_key:
        try:
            import google.generativeai as genai
            genai.configure(api_key=gemini_key)
            model = genai.GenerativeModel('gemini-1.5-flash')
            
            prompt = f"""
            You are a master "Vibe Librarian". A user describes their mood or the "vibe" they want, and you find the best matches from our library catalog.
            
            USER VIBE: "{user_vibe}"
            
            LIBRARY CATALOG:
            {book_context}
            
            TASK:
            1. Analyze the user's vibe (e.g., 'dark', 'cozy', 'hopeful', 'educational').
            2. Select 3-5 books from the CATALOG that best match this vibe.
            3. For each book, write a one-sentence explanation of why it fits the vibe.
            4. Format your response in clean Markdown.
            5. If no books match well, suggest the closest ones and explain why.
            """
            
            response = model.generate_content(prompt)
            return response.text
            
        except Exception as e:
            print(f"‚ö†Ô∏è Gemini Error: {e}")
    
    # Method 2: Hugging Face Free API (Mistral or similar)
    if hf_token:
        try:
            response = call_huggingface_ai(user_vibe, book_context, hf_token)
            if response:
                return response
        except Exception as e:
            print(f"‚ö†Ô∏è Hugging Face Error: {e}")
    
    # Method 3: Local keyword-based matching (no API needed)
    return local_vibe_matching(user_vibe, books)


def call_huggingface_ai(user_vibe, book_context, token):
    """Call Hugging Face's free Inference API."""
    API_URL = "https://api-inference.huggingface.co/models/mistralai/Mixtral-8x7B-Instruct-v0.1"
    
    headers = {"Authorization": f"Bearer {token}"}
    
    prompt = f"""<s>[INST] You are a librarian. A user wants books matching this vibe: "{user_vibe}"

Here are available books:
{book_context}

Select 3-5 books that best match the vibe. For each, write a one-sentence explanation. Format in Markdown. [/INST]"""
    
    payload = {
        "inputs": prompt,
        "parameters": {
            "max_new_tokens": 500,
            "temperature": 0.7,
            "return_full_text": False
        }
    }
    
    response = requests.post(API_URL, headers=headers, json=payload, timeout=30)
    
    if response.status_code == 200:
        result = response.json()
        if isinstance(result, list) and len(result) > 0:
            return result[0].get('generated_text', '')
    
    return None


def local_vibe_matching(user_vibe, books):
    """
    Simple keyword-based matching when no AI API is available.
    Works completely offline!
    """
    vibe_lower = user_vibe.lower()
    
    # Define vibe-to-category mappings
    vibe_mappings = {
        'dark': ['Fiction', 'Mystery', 'Horror', 'Thriller'],
        'cozy': ['Fiction', 'Romance', 'Self Help'],
        'inspiring': ['Biography', 'Self Help', 'History'],
        'educational': ['Science', 'Technology', 'Reference', 'History'],
        'exciting': ['Fiction', 'Adventure', 'Thriller'],
        'relaxing': ['Fiction', 'Poetry', 'Romance'],
        'mysterious': ['Mystery', 'Fiction', 'Thriller'],
        'happy': ['Fiction', 'Romance', 'Self Help'],
        'sad': ['Fiction', 'Biography', 'Poetry'],
        'adventurous': ['Fiction', 'Adventure', 'History'],
    }
    
    # Find matching categories based on keywords in user vibe
    matched_categories = set()
    for keyword, categories in vibe_mappings.items():
        if keyword in vibe_lower:
            matched_categories.update(categories)
    
    # If no specific vibe matched, use general fiction
    if not matched_categories:
        matched_categories = {'Fiction', 'Self Help', 'Biography'}
    
    # Filter books by matched categories
    matching_books = [b for b in books if b['category'] in matched_categories]
    
    # If still no matches, return top 5 books
    if not matching_books:
        matching_books = books[:5]
    else:
        matching_books = matching_books[:5]
    
    # Format response
    if matching_books:
        response = f"### üìö Books matching your vibe: *\"{user_vibe}\"*\n\n"
        for book in matching_books:
            response += f"- **{book['title']}** by {book['author']} ({book['category']})\n"
        response += "\n*üí° Tip: Add a Gemini or Hugging Face API key for smarter AI recommendations!*"
        return response
    else:
        return "No books found matching your vibe. Try browsing the catalog!"

</file>

<file path="backend\services\email_service.py">
"""
email_service.py
----------------
Handles automated email notifications for the Library System.

Features:
- Book Issue Confirmation
- Overdue Reminders
- System Alerts

Note: Requires SMTP configuration in .env
"""

import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import os
from dotenv import load_dotenv

load_dotenv()

# SMTP Configuration
SMTP_SERVER = os.getenv("SMTP_SERVER", "smtp.gmail.com")
SMTP_PORT = int(os.getenv("SMTP_PORT", 587))
SMTP_USER = os.getenv("SMTP_USER", "")
SMTP_PASS = os.getenv("SMTP_PASS", "")

from email.mime.application import MIMEApplication

def send_email(to_email: str, subject: str, body: str, attachment_path: str = None):
    """
    Direct SMTP email sender.
    If no credentials found, it logs to console (Simulation Mode).
    """
    if not SMTP_USER or not SMTP_PASS:
        print(f"üìß [SIMULATION] Email to {to_email}")
        print(f"Subject: {subject}")
        if attachment_path:
            print(f"Attachment: {attachment_path}")
        print(f"Body: {body}\n")
        return True

    try:
        msg = MIMEMultipart()
        msg['From'] = SMTP_USER
        msg['To'] = to_email
        msg['Subject'] = subject

        msg.attach(MIMEText(body, 'plain'))

        if attachment_path and os.path.exists(attachment_path):
            with open(attachment_path, "rb") as f:
                part = MIMEApplication(f.read(), Name=os.path.basename(attachment_path))
            part['Content-Disposition'] = f'attachment; filename="{os.path.basename(attachment_path)}"'
            msg.attach(part)

        server = smtplib.SMTP(SMTP_SERVER, SMTP_PORT)
        server.starttls()
        server.login(SMTP_USER, SMTP_PASS)
        server.send_message(msg)
        server.quit()
        return True
    except Exception as e:
        print(f"‚ùå Email Error: {e}")
        return False

def notify_issue(user_name: str, user_email: str, book_title: str, due_date: str):
    """Sends a confirmation email when a book is issued."""
    subject = f"üìö Book Issued: {book_title}"
    body = f"""Hi {user_name},

Happy reading! You have successfully issued '{book_title}' from LibManage.

üìÖ Due Date: {due_date}

Please return the book on or before the due date to avoid late fees.

Best regards,
Library Management Team
"""
    return send_email(user_email, subject, body)

def notify_overdue(user_name: str, user_email: str, book_title: str, days: int, fine: int):
    """Sends an alert for overdue books."""
    subject = f"‚ö†Ô∏è Overdue Notice: {book_title}"
    body = f"""Hi {user_name},

This is a reminder that '{book_title}' is overdue by {days} days.

üí∞ Current Fine: ‚Çπ{fine}

Please return the book as soon as possible to prevent further fines.

Best regards,
Library Management Team
"""
    return send_email(user_email, subject, body)


def notify_request_status(user_name: str, user_email: str, book_title: str, status: str):
    """Notifies user if their request was Rejected."""
    if status.lower() != 'rejected':
        return  # Approval is handled via notify_issue

    subject = f"üìù Request Update: {book_title}"
    body = f"""Hi {user_name},

We regret to inform you that your request for '{book_title}' has been {status}.

This may be due to high demand or library policy. You can browse the catalog for other available books.

Best regards,
Library Management Team
"""
    return send_email(user_email, subject, body)

</file>

<file path="backend\services\enrichment_service.py">
import requests
from backend.repository.db_access import execute, fetch_one, fetch_all
from backend.config.config import get_config

def enrich_book_metadata(book_id):
    """
    Intelligently enriches book data using AI.
    - Creates Author profile if missing.
    - Fetches Bio/Nationality.
    - Identifies and Links Series.
    - Sets Series Order.
    - NEW: Fetches Book Cover & Description.
    """
    book = fetch_one("SELECT * FROM books WHERE book_id = %s", (book_id,))
    if not book: return "Book not found."
    
    title = book['title']
    author_name = book['author']
    
    try:
        # 1. FETCH AUTHOR BIO (OpenLibrary)
        # We need to search for the author first to get their OLID
        print(f"üåç Searching OpenLibrary for author: {author_name}")
        search_url = f"https://openlibrary.org/search/authors.json?q={author_name}"
        search_resp = requests.get(search_url, timeout=5).json()
        
        bio = None
        
        if search_resp.get('numFound', 0) > 0:
            author_key = search_resp['docs'][0]['key'] # e.g. "OL23919A"
            
            # Fetch Author Details
            details_url = f"https://openlibrary.org/authors/{author_key}.json"
            details_resp = requests.get(details_url, timeout=5).json()
            
            bio_raw = details_resp.get('bio', '')
            if isinstance(bio_raw, dict):
                bio = bio_raw.get('value', '')
            else:
                bio = str(bio_raw)
                
            # Limit bio length
            if bio:
                # CLEANUP: Strip HTML tags (like <q>, <i>, <br>)
                import re
                bio = re.sub(r'<[^>]+>', '', bio)
                bio = bio[:4000] + "..." if len(bio) > 4000 else bio
                
        # 1.5. FALLBACK OR UPGRADE: WIKIPEDIA
        if not bio or len(bio) < 200:
            print(f"üåç Upgrading bio via Wikipedia for: {author_name}")
            try:
                # 1. SEARCH Wikipedia first to get the correct Page Title
                search_url = f"https://en.wikipedia.org/w/api.php?action=opensearch&search={author_name}&limit=1&namespace=0&format=json"
                search_res = requests.get(search_url, timeout=5).json()
                
                wiki_title = None
                if search_res and len(search_res) > 1 and search_res[1]:
                    wiki_title = search_res[1][0] 
                    print(f"üîç Wikipedia found matching page: {wiki_title}")
                
                if wiki_title:
                     # 2. Fetch Extract using Action API
                    query_url = "https://en.wikipedia.org/w/api.php"
                    params = {
                        "action": "query",
                        "format": "json",
                        "prop": "extracts",
                        "titles": wiki_title,
                        "exintro": 1,
                        "explaintext": 1,
                        "redirects": 1
                    }
                    wiki_resp = requests.get(query_url, params=params, timeout=5)
                    wiki_data = wiki_resp.json()
                    
                    # Extract the page content (page ID is dynamic)
                    pages = wiki_data.get("query", {}).get("pages", {})
                    for page_id, page_val in pages.items():
                        if page_id != "-1" and 'extract' in page_val:
                            wiki_bio = page_val['extract']
                            if wiki_bio and len(wiki_bio) > len(str(bio or "")):
                                bio = wiki_bio
                                print("‚úÖ Upgraded to Wikipedia Bio via Action API!")
                            break
            except Exception as w_e:
                print(f"‚ö†Ô∏è Wikipedia lookup failed: {w_e}")
        
        # 2. SAVE AUTHOR
        author = fetch_one("SELECT author_id, bio FROM authors WHERE name = %s", (author_name,))
        if not author:
            execute("INSERT INTO authors (name, bio) VALUES (%s, %s)", (author_name, bio))
            author = fetch_one("SELECT author_id, bio FROM authors WHERE name = %s", (author_name,))
        else:
            current_bio = author.get('bio', '') or ''
            should_update = False
            if bio and len(bio) > len(current_bio):
                should_update = True
            elif bio and '<' in current_bio:
                should_update = True
                
            if should_update:
                print(f"üîÑ Updating bio for {author_name}")
                execute("UPDATE authors SET bio = %s WHERE author_id = %s", (bio, author['author_id']))
                
        author_id = author['author_id']
        
        # 3. IDENTIFY SERIES & FETCH METADATA (Google Books)
        series_id = None
        s_name = None
        s_order = None
        cover_url = None
        description = None
        
        print(f"üåç Searching Google Books for series info: {title}")
        gb_url = f"https://www.googleapis.com/books/v1/volumes?q=intitle:{title}+inauthor:{author_name}&maxResults=1"
        gb_resp = requests.get(gb_url, timeout=5).json()
        
        if gb_resp.get('totalItems', 0) > 0:
            info = gb_resp['items'][0]['volumeInfo']
            
            # --- 3.1 Fetch Description ---
            description = info.get('description')
            if description:
                description = description[:2000] + "..." if len(description) > 2000 else description
            
            # --- 3.2 Fetch Cover URL ---
            image_links = info.get('imageLinks', {})
            cover_url = image_links.get('extraLarge') or \
                        image_links.get('large') or \
                        image_links.get('medium') or \
                        image_links.get('thumbnail')
            
            if cover_url:
                 cover_url = cover_url.replace("http://", "https://")
            
            print(f"üñºÔ∏è Found Cover: {cover_url is not None}")
            
            # --- 3.3 Identify Series ---
            subtitle = info.get('subtitle', '')
            import re
            text_to_search = f"{info.get('title')} {info.get('subtitle', '')} {info.get('description', '')[:200]}"
            
            patterns = [
                r'\(([^)]+),?\s+[#]?(\d+)\)',         
                r'Book (\d+) of (?:the )?([A-Z][a-zA-Z0-9\s\']+)',   
                r'Vol\.? (\d+) of (?:the )?([A-Z][a-zA-Z0-9\s\']+)', 
                r'([A-Z][a-zA-Z0-9\s\']+) Series,? Book (\d+)', 
            ]
            
            found = False
            for pat in patterns:
                match = re.search(pat, text_to_search) 
                if match:
                    g1, g2 = match.groups()
                    if g1.isdigit(): 
                        s_order = int(g1)
                        s_name = g2.strip()
                    else:
                        s_name = g1.strip()
                        if g2.isdigit():
                            s_order = int(g2)
                        
                    if len(s_name) < 50 and s_name and s_name[0].isupper() and " " in s_name:
                        if "history of" in s_name.lower() or "struggle for" in s_name.lower():
                             continue
                        found = True
                        print(f"‚úÖ Found Series via Regex: {s_name} (#{s_order})")
                        break
            
            if not found:
                s_name = None 
                
        # 3.5. FALLBACK: OpenLibrary Work Search
        if not s_name:
            print(f"üåç Google Books failed, trying OpenLibrary Series for: {title}")
            try:
                ol_s_url = f"https://openlibrary.org/search.json?title={title}&author={author_name}&limit=1"
                ol_s_data = requests.get(ol_s_url, timeout=5).json()
                
                if ol_s_data.get('numFound', 0) > 0:
                     doc = ol_s_data['docs'][0]
                     
                     # 3.5.1 Try to get Cover from OL if Google failed
                     if not cover_url and 'cover_i' in doc:
                         cover_id = doc['cover_i']
                         cover_url = f"https://covers.openlibrary.org/b/id/{cover_id}-L.jpg"
                         print("üñºÔ∏è Found Cover via OpenLibrary")
                         
                     work_key = doc.get('key')
                     if work_key:
                         work_url = f"https://openlibrary.org{work_key}.json"
                         work_res = requests.get(work_url, timeout=5).json()
                         
                         if 'series' in work_res and isinstance(work_res['series'], list) and len(work_res['series']) > 0:
                             raw_series = work_res['series'][0]
                             if isinstance(raw_series, str):
                                 s_name = raw_series
                                 s_order = 1
                                 print(f"‚úÖ Found OpenLibrary Series: {s_name}")
            except Exception as e:
                print(f"‚ö†Ô∏è OpenLibrary Series lookup failed: {e}")

        # 4. SAVE SERIES
        if s_name:
            s_name = s_name.replace("Series", "").strip()
            series = fetch_one("SELECT series_id FROM series WHERE name = %s", (s_name,))
            if not series:
                execute("INSERT INTO series (name) VALUES (%s)", (s_name,))
                series = fetch_one("SELECT series_id FROM series WHERE name = %s", (s_name,))
            series_id = series['series_id']
            
        # 5. UPDATE BOOK
        print(f"üìù Saving Metadata for {title}: Cover={bool(cover_url)}, Desc={bool(description)}")
        execute("""
            UPDATE books 
            SET author_id = %s, series_id = %s, series_order = %s, cover_url = %s, description = %s
            WHERE book_id = %s
        """, (author_id, series_id, s_order, cover_url, description, book_id))
        
        return "Success (Open Source)"
        
    except Exception as e:
        print(f"‚ùå Open Source Enrichment Error: {e}")
        return f"Error: {str(e)}"

def get_author_books(author_id):
    """Returns all books by a specific author."""
    return fetch_all("SELECT * FROM books WHERE author_id = %s ORDER BY series_id, series_order", (author_id,))

def get_series_books(series_id):
    """Returns all books in a series in order."""
    return fetch_all("SELECT * FROM books WHERE series_id = %s ORDER BY series_order", (series_id,))

</file>

<file path="backend\services\file_service.py">
import os
import uuid
from werkzeug.utils import secure_filename
from flask import current_app

ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'pdf', 'doc', 'docx', 'txt'}

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def save_chat_file(file):
    """
    Saves a file uploaded in chat.
    Returns the relative path to be stored in DB.
    """
    if not file or file.filename == '':
        return None
        
    if not allowed_file(file.filename):
        raise ValueError("File type not allowed")
        
    # Create secure filename with UUID prefix to avoid collisions
    original_name = secure_filename(file.filename)
    unique_name = f"{uuid.uuid4().hex[:8]}_{original_name}"
    
    # Check upload folder exists
    upload_folder = os.path.join(current_app.static_folder, 'uploads', 'chat')
    os.makedirs(upload_folder, exist_ok=True)
    
    # Save
    file_path = os.path.join(upload_folder, unique_name)
    file.save(file_path)
    
    # Return relative path for URL usage
    return f"uploads/chat/{unique_name}"

</file>

<file path="backend\services\gamification_service.py">

from backend.repository.db_access import fetch_all, fetch_one, execute
from datetime import datetime

def get_user_stats(user_id):
    """Fetches user's level, XP, and earned badges."""
    stats = fetch_one("SELECT * FROM user_profile_stats WHERE user_id = %s", (user_id,))
    if not stats:
        # Lazy initialization
        execute("INSERT IGNORE INTO user_profile_stats (user_id) VALUES (%s)", (user_id,))
        stats = {'user_id': user_id, 'xp': 0, 'level': 1}
    
    badges = fetch_all("""
        SELECT b.* FROM badges b
        JOIN user_achievements ua ON b.badge_id = ua.badge_id
        WHERE ua.user_id = %s
    """, (user_id,))
    
    
    # Calculate Rank and Perks based on Level
    level = stats['level']
    rank_title = "Reader"
    next_perk = "None"
    
    if level < 5:
        rank_title = "Novice Page-Turner"
        next_perk = "Bronze Border"
    elif level < 10:
        rank_title = "Apprentice Scholar"
        next_perk = "Silver Border & 5% XP Boost"
    elif level < 20:
        rank_title = "Library Guardian"
        next_perk = "Gold Border & 10% XP Boost"
    else:
        rank_title = "Grand Archivist"
        next_perk = "Living Legend Status"

    return {
        "xp": stats['xp'],
        "level": stats['level'],
        "badges": badges,
        "xp_to_next": stats['level'] * 100,
        "rank_title": rank_title,
        "next_perk": next_perk
    }

def award_xp(user_id, amount, reason=""):
    """Adds XP to a user and checks for level up."""
    execute("UPDATE user_profile_stats SET xp = xp + %s WHERE user_id = %s", (amount, user_id))
    
    # Check for level up
    stats = fetch_one("SELECT xp, level FROM user_profile_stats WHERE user_id = %s", (user_id,))
    current_xp = stats['xp']
    current_level = stats['level']
    
    # Formula: XP for level L = (L-1)*L/2 * 100
    # Let's simplify: Level = 1 + floor(sqrt(xp / 50))? No.
    # We will just iterate to see if they leveled up.
    new_level = current_level
    while True:
        xp_needed_for_next = (new_level * (new_level + 1) / 2) * 100
        if current_xp >= xp_needed_for_next:
            new_level += 1
        else:
            break
            
    if new_level > current_level:
        execute("UPDATE user_profile_stats SET level = %s WHERE user_id = %s", (new_level, user_id))
        from backend.services.notification_service import add_notification
        add_notification(user_id, f"üéâ Level Up! You are now Level {new_level}!")
        
    # Check if this qualifies for any badges
    check_for_badges(user_id)
    return True

def check_for_badges(user_id):
    """Evaluates if user qualifies for any unearned badges."""
    # 1. First Borrow (check if user has at least 1 record in issues)
    # 2. Knowledge Seeker (10 unique books)
    # 3. Socialite (check users.is_public)
    # 4. Library Legend (Level 10)
    
    # --- DYNAMIC RULE ENGINE ---
    # Fetch unearned badges that have rules
    unearned_dynamic = fetch_all("""
        SELECT * FROM badges 
        WHERE rule_type IS NOT NULL 
        AND badge_id NOT IN (SELECT badge_id FROM user_achievements WHERE user_id = %s)
    """, (user_id,))
    
    # Pre-fetch stats to avoid N+1 queries
    # 1. Total Reads
    res_reads = fetch_one("SELECT COUNT(*) as cnt FROM issues WHERE user_id = %s", (user_id,))
    total_reads = res_reads['cnt'] if res_reads else 0
    
    # 2. Total Reviews (Assuming 'reviews' table exists, otherwise handle gracefully)
    try:
        res_reviews = fetch_one("SELECT COUNT(*) as cnt FROM reviews WHERE user_id = %s", (user_id,))
        total_reviews = res_reviews['cnt'] if res_reviews else 0
    except:
        total_reviews = 0 # Table might not exist yet
        
    # 3. Unique Genres
    res_genres = fetch_one("""
        SELECT COUNT(DISTINCT b.genre) as cnt 
        FROM issues i 
        JOIN books b ON i.book_id = b.book_id 
        WHERE i.user_id = %s
    """, (user_id,))
    unique_genres = res_genres['cnt'] if res_genres else 0
    
    # 4. Member Days
    res_days = fetch_one("SELECT DATEDIFF(NOW(), join_date) as days FROM users WHERE user_id = %s", (user_id,))
    member_days = res_days['days'] if res_days else 0

    for badge in unearned_dynamic:
        earned = False
        rtype = badge.get('rule_type')
        rval = badge.get('rule_value', 0) or 0 # Handle None/Null safely
        
        if rtype == 'total_reads':
            if total_reads >= rval: earned = True
            
        elif rtype == 'total_reviews':
            if total_reviews >= rval: earned = True
            
        elif rtype == 'unique_genres':
            if unique_genres >= rval: earned = True
            
        elif rtype == 'days_member':
            if member_days >= rval: earned = True
            
        if earned:
            execute("INSERT IGNORE INTO user_achievements (user_id, badge_id) VALUES (%s, %s)", (user_id, badge['badge_id']))
            from backend.services.notification_service import add_notification
            add_notification(user_id, f"üèÜ Achievement Unlocked: {badge['icon']} {badge['name']}!")
            
            # Award XP if associated with badge
            if badge.get('xp_required') and badge['xp_required'] > 0:
                 execute("UPDATE user_profile_stats SET xp = xp + %s WHERE user_id = %s", (badge['xp_required'], user_id))
                 
            from backend.services.activity_service import log_user_activity
            log_user_activity(user_id, "BADGE", f"Earned the {badge['name']} badge! {badge['icon']}")

    # --- LEGACY / SPECIAL LOGIC ---
    # Keep this for complex badges that can't be rule-based
    
    # Socialite (check users.is_public)
    # Check if Socialite is unearned
    unearned_legacy = fetch_all("""
        SELECT * FROM badges 
        WHERE name IN ('Socialite', 'Quick Reader', 'Library Legend')
        AND badge_id NOT IN (SELECT badge_id FROM user_achievements WHERE user_id = %s)
    """, (user_id,))
    
    for badge in unearned_legacy:
        earned = False
        if badge['name'] == "Socialite":
            res = fetch_one("SELECT is_public FROM users WHERE user_id = %s", (user_id,))
            if res and res['is_public']: earned = True
            
        elif badge['name'] == "Quick Reader":
            res = fetch_one("""
                SELECT COUNT(*) as cnt FROM issues 
                WHERE user_id = %s AND return_date IS NOT NULL 
                AND DATEDIFF(return_date, issue_date) <= 3
            """, (user_id,))
            if res['cnt'] > 0: earned = True
            
        elif badge['name'] == "Library Legend":
             # This could be a rule 'min_level', but keeping here for now
            res = fetch_one("SELECT level FROM user_profile_stats WHERE user_id = %s", (user_id,))
            if res and res['level'] >= 10: earned = True

        if earned:
             execute("INSERT IGNORE INTO user_achievements (user_id, badge_id) VALUES (%s, %s)", (user_id, badge['badge_id']))
             from backend.services.notification_service import add_notification
             add_notification(user_id, f"üèÜ Achievement Unlocked: {badge['icon']} {badge['name']}!")
             from backend.services.activity_service import log_user_activity
             log_user_activity(user_id, "BADGE", f"Earned the {badge['name']} badge! {badge['icon']}")

def get_leaderboard():
    """Returns top 10 players based on level and XP."""
    return fetch_all("""
        SELECT u.name, ups.level, ups.xp 
        FROM user_profile_stats ups
        JOIN users u ON ups.user_id = u.user_id
        ORDER BY ups.level DESC, ups.xp DESC
        LIMIT 10
    """)
    
def get_user_badges(user_id):
    """Fetches just the badges of a user."""
    return fetch_all("""
        SELECT b.* FROM badges b
        JOIN user_achievements ua ON b.badge_id = ua.badge_id
        WHERE ua.user_id = %s
    """, (user_id,))

def get_all_achievements_status(user_id):
    """
    Returns ALL badges with a flag indicating if the user has unlocked them.
    Used for the dedicated "Trophy Room" page.
    """
    # 1. Fetch all badges
    all_badges = fetch_all("SELECT * FROM badges")
    
    # 2. Fetch user's unlocked badge IDs
    unlocked_ids = {
        row['badge_id'] 
        for row in fetch_all("SELECT badge_id FROM user_achievements WHERE user_id = %s", (user_id,))
    }
    
    # 3. Merge and formatting
    results = []
    for badge in all_badges:
        is_unlocked = badge['badge_id'] in unlocked_ids
        
        # Add unlock date if unlocked (Optional enhancement)
        unlocked_date = None
        if is_unlocked:
            res = fetch_one("SELECT earned_at FROM user_achievements WHERE user_id = %s AND badge_id = %s", (user_id, badge['badge_id']))
            if res: unlocked_date = res['earned_at']
            
        results.append({
            "badge_id": badge['badge_id'],
            "name": badge['name'],
            "description": badge['description'],
            "icon": badge['icon'],
            "criteria": badge.get('criteria', ''), # Assuming criteria column exists or is inferred
            "is_unlocked": is_unlocked,
            "earned_at": unlocked_date
        })
        
    return results

</file>

<file path="backend\services\gateway_service.py">
import time
from backend.utils.snowflake import generate_id

# In-Memory Session Store (Simulating Redis)
# Map: socket_id -> { user_id, last_heartbeat, connected_at }
_sessions = {}
# Map: user_id -> set(socket_ids)
_user_sockets = {}

class GatewayService:
    """
    Manages WebSocket Connection Lifecycle.
    """
    
    @staticmethod
    def register_connection(socket_id, user_id):
        """Registers a new socket connection."""
        print(f"üîå Gateway: Registering {user_id} on {socket_id}")
        
        # Zombie Cleanup (Max 1 session for MVP)
        existing = _user_sockets.get(user_id)
        if existing:
            # logic to force disconnect old socket could go here
            pass
            
        _sessions[socket_id] = {
            'user_id': user_id,
            'connected_at': time.time(),
            'last_heartbeat': time.time(),
            'session_id': generate_id()
        }
        
        if user_id not in _user_sockets:
            _user_sockets[user_id] = set()
        _user_sockets[user_id].add(socket_id)
        
        return _sessions[socket_id]['session_id']

    @staticmethod
    def deregister_connection(socket_id):
        """Removes a socket connection."""
        session = _sessions.pop(socket_id, None)
        if session:
            uid = session['user_id']
            if uid in _user_sockets:
                _user_sockets[uid].discard(socket_id)
                if not _user_sockets[uid]:
                    del _user_sockets[uid]
            print(f"üîå Gateway: Deregistered {uid}")

    @staticmethod
    def update_heartbeat(socket_id):
        """Updates the heartbeat timestamp."""
        if socket_id in _sessions:
            _sessions[socket_id]['last_heartbeat'] = time.time()
            return True
        return False

    @staticmethod
    def get_online_users():
        """Returns list of online user IDs."""
        return list(_user_sockets.keys())

</file>

<file path="backend\services\goal_service.py">

from datetime import datetime
from backend.repository.db_access import fetch_one, execute

def get_or_create_goal(user_id):
    """Fetches the current year's reading goal for a user (including tier & privacy), creating goal if missing."""
    year = datetime.now().year
    query = """
    SELECT rg.*, u.tier, u.is_public, u.allow_requests, u.show_activity
    FROM reading_goals rg
    JOIN users u ON rg.user_id = u.user_id
    WHERE rg.user_id = %s AND rg.year = %s
    """
    goal = fetch_one(query, (user_id, year))
    
    if not goal:
        execute("INSERT INTO reading_goals (user_id, year, goal_books) VALUES (%s, %s, 12)", (user_id, year))
        goal = fetch_one(query, (user_id, year))
    
    return goal

def update_goal_target(user_id, target):
    """Allows user to set their personal reading target for the current year."""
    year = datetime.now().year
    execute("UPDATE reading_goals SET goal_books = %s WHERE user_id = %s AND year = %s", (target, user_id, year))
    return "‚úÖ Reading goal updated!"

def increment_goal_progress(user_id):
    """Increments the current reading count by 1."""
    year = datetime.now().year
    # Ensure goal exists first
    get_or_create_goal(user_id)
    execute("UPDATE reading_goals SET current_books = current_books + 1 WHERE user_id = %s AND year = %s", (user_id, year))

</file>

<file path="backend\services\guild_service.py">
from backend.repository.db_access import execute, fetch_one, fetch_all

def create_guild(owner_id, name, description=None, icon_url=None):
    """Creates a new Guild (Server) and adds owner."""
    execute("""
        INSERT INTO guilds (owner_id, name, description, icon_url)
        VALUES (%s, %s, %s, %s)
    """, (owner_id, name, description, icon_url))
    
    guild_id = fetch_one("SELECT LAST_INSERT_ID() as id")['id']
    
    # Add owner as member
    execute("INSERT INTO guild_members (guild_id, user_id) VALUES (%s, %s)", (guild_id, owner_id))
    
    # Create Default Categories and Channels
    execute("INSERT INTO categories (guild_id, name, position) VALUES (%s, 'Text Channels', 0)", (guild_id,))
    cat_id = fetch_one("SELECT LAST_INSERT_ID() as id")['id']
    
    execute("INSERT INTO channels (guild_id, category_id, name, type) VALUES (%s, %s, 'general', 'text')", (guild_id, cat_id))
    
    return guild_id

def get_my_guilds(user_id):
    """Returns all guilds the user is a member of."""
    return fetch_all("""
        SELECT g.* 
        FROM guilds g
        JOIN guild_members m ON g.guild_id = m.guild_id
        WHERE m.user_id = %s
    """, (user_id,))

def get_guild_details(guild_id):
    """Returns full guild hierarchy (Categories -> Channels)."""
    guild = fetch_one("SELECT * FROM guilds WHERE guild_id = %s", (guild_id,))
    if not guild: return None
    
    categories = fetch_all("SELECT * FROM categories WHERE guild_id = %s ORDER BY position", (guild_id,))
    channels = fetch_all("SELECT * FROM channels WHERE guild_id = %s ORDER BY position", (guild_id,))
    
    # Hierarchy Assembly
    grid = []
    
    # Uncategorized channels first
    uncategorized = [c for c in channels if not c['category_id']]
    if uncategorized:
        grid.append({'id': 'null', 'name': 'Channels', 'channels': uncategorized})
        
    for cat in categories:
        cat_channels = [c for c in channels if c['category_id'] == cat['category_id']]
        grid.append({
            'id': cat['category_id'],
            'name': cat['name'],
            'channels': cat_channels
        })
        
    return {
        'guild': guild,
        'hierarchy': grid
    }

</file>

<file path="backend\services\health_service.py">

import os
import psutil
import time
from backend.repository.db_access import fetch_one

def get_system_health():
    """Aggregates all system health metrics into a single report."""
    return {
        "database": check_db_health(),
        "disk": check_disk_usage(),
        "memory": check_memory_usage(),
        "cpu": psutil.cpu_percent(interval=None),
        "status": "Healthy"
    }

def check_db_health():
    """Checks DB connectivity and basic latency."""
    start_time = time.time()
    try:
        # Simple query to check connectivity
        fetch_one("SELECT 1")
        latency = round((time.time() - start_time) * 1000, 2)
        return {"status": "Online", "latency_ms": latency}
    except Exception as e:
        return {"status": "Offline", "error": str(e)}

def check_disk_usage():
    """Checks disk space on the drive where the project is located."""
    path = os.getcwd()
    usage = psutil.disk_usage(path)
    return {
        "total_gb": round(usage.total / (1024**3), 2),
        "used_gb": round(usage.used / (1024**3), 2),
        "free_gb": round(usage.free / (1024**3), 2),
        "percent": usage.percent
    }

def check_memory_usage():
    """Checks system memory usage."""
    memory = psutil.virtual_memory()
    return {
        "total_mb": round(memory.total / (1024**2), 2),
        "used_mb": round(memory.used / (1024**2), 2),
        "percent": memory.percent
    }

def get_error_logs(limit=10):
    """Fetches recent error logs from the database (if an audit/logs table exists)."""
    # Assuming audit_logs table exists from previous features
    try:
        from backend.repository.db_access import fetch_all
        return fetch_all("SELECT * FROM audit_logs WHERE action_type LIKE '%%ERROR%%' ORDER BY timestamp DESC LIMIT %s", (limit,))
    except Exception:
        return []

</file>

<file path="backend\services\ingestion_service.py">
from backend.utils.snowflake import generate_id
from backend.utils.rate_limiter import check_rate_limit
from backend.services.channel_service import save_message
from backend.services.gateway_service import GatewayService
from flask_socketio import emit

class IngestionService:
    """
    Central Pipeline for Message Processing.
    Steps: RateLimit -> Validate -> Persist -> Fan-out
    """
    
    @staticmethod
    def process_message(user_id, channel_id, content, socket_io_instance, user_profile, attachment=None, reply_to_id=None):
        """
        Ingests a message payload.
        Returns: Success (Bool), Error (String or None)
        """
        
        # 1. Rate Limiting
        # Key = rate:channel:{cid}:user:{uid}
        rate_key = f"rate:channel:{channel_id}:user:{user_id}"
        if not check_rate_limit(rate_key):
             return False, "You are being rate limited."
             
        # 2. Validation (Length, Content)
        # Content can be empty if attachment exists
        if not content and not attachment:
             return False, "Message cannot be empty."
        if content and len(content) > 4000:
             return False, "Message too long."
             
        # 3. Persistence (DB)
        # Determine sender_type based on profile (set by socket_service)
        sender_type = 'anon' if user_profile.get('name') == 'Anonymous Member' else 'user'
        
        file_url = attachment.get('url') if attachment else None
        
        try:
            # save_message returns dict with message_id, etc.
            msg_obj = save_message(user_id, channel_id, text=content, file_url=file_url, reply_to_id=reply_to_id, sender_type=sender_type)
        except Exception as e:
            print(f"‚ùå DB Insert Failed: {e}")
            return False, "Database Error"

        # 4. Fan-Out (Broadcast)
        # We should ideally fetch the reply_to content for the UI
        reply_to_content = None
        if reply_to_id:
             # Optimization: Pass it in or fetch it lightly.
             # For now we'll just send the ID and let frontend handle or fetch if needed
             # Or backend can fetch strictly the content snippet.
             # Skipping strict fetch for speed, frontend will just show "Replied to message"
             pass

        payload = {
            'message_id': msg_obj['message_id'],
            'content': content,
            'channel_id': channel_id,
            'sender_id': user_id,
            'sender_type': 'other',
            'user_profile': user_profile,
            'nonce': generate_id(),
            'created_at': 'Just now',
            'attachment': attachment,
            'reply_to_id': reply_to_id,
            # 'reply_to': { 'content': ... } # If we fetched it
        }
        
        from backend import socketio
        socketio.emit('receive_message', payload, to=str(channel_id), include_self=False)
        
        # Ack to sender with same payload
        payload['sender_type'] = 'me'
        return True, payload

</file>

<file path="backend\services\issue_service.py">
"""
issue_service.py
-----------------
Handles issuing and returning books.

Key characteristics:
- Uses database transactions
- Ensures data consistency (atomic operations)
- Contains business rules for issuing & returning
"""

# ===============================
# IMPORTS
# ===============================

from datetime import date
# date ‚Üí used to record issue_date and return_date

from backend.config.db import get_connection
# get_connection ‚Üí provides raw DB connection for transactions


# =====================================================
# MEMBER ISSUE HISTORY
# =====================================================

def get_member_issues(user_id):
    """
    Returns all issued books for a specific member.

    Used by:
    - Member dashboard (Flask)
    - CLI (Member view)

    This function is READ-ONLY.
    """

    # Local import to avoid circular dependency
    from backend.repository.db_access import fetch_all

    # SQL query to fetch issue history for a user
    query = """
    SELECT
        b.title,        -- Book title
        i.issue_date,   -- Date book was issued
        i.return_date,  -- Date book was returned (NULL if active)
        i.fine          -- Fine amount (if any)
    FROM issues i
    JOIN books b ON i.book_id = b.book_id
    WHERE i.user_id = %s
    ORDER BY i.issue_date DESC
    """

    # Execute query and return results
    return fetch_all(query, (user_id,))


# ==============================
# BUSINESS RULES (CENTRALISED)
# ==============================

# Maximum number of books a user can hold at a time
MAX_BOOKS_PER_USER = 3

# Number of days allowed without fine
MAX_DAYS_ALLOWED = 7

# Fine amount charged per extra day
FINE_PER_DAY = 5


# =====================================================
# ISSUE BOOK
# =====================================================

def issue_book(user_id: int, book_id: int):
    """
    Issues a book to a user.

    Characteristics:
    - Atomic operation (all-or-nothing)
    - Uses database transactions
    - Enforces ALL business rules in one place
    - Used by BOTH Flask and CLI
    """

    # --------------------------------------------------
    # STEP 1: CREATE DATABASE CONNECTION
    # --------------------------------------------------
    # A direct connection is used here because issuing
    # a book involves MULTIPLE dependent queries that
    # must succeed or fail together (transaction).
    conn = get_connection()

    # Dictionary cursor allows access like row["column"]
    cursor = conn.cursor(dictionary=True)

    try:
        # --------------------------------------------------
        # STEP 2: FETCH USER ROLE (CRITICAL BUSINESS RULE)
        # --------------------------------------------------
        # We must know WHO the target user is before issuing.
        # Admins manage the system and are NOT allowed
        # to borrow books.
        cursor.execute(
            """
            SELECT name, email, role
            FROM users
            WHERE user_id = %s
            """,
            (user_id,)
        )

        user = cursor.fetchone()

        # If user_id does not exist in DB
        if not user:
            return "‚ùå User not found"

        # Enforce rule: admins cannot issue books
        if user["role"] == "admin":
            return "‚ùå Admins cannot issue books"

        # --------------------------------------------------
        # NEW: FETCH MEMBERSHIP LIMITS
        # --------------------------------------------------
        from backend.services.membership_service import get_user_membership_config
        membership = get_user_membership_config(user_id)
        max_books = membership['max_books']
        loan_days = membership['loan_days']

        # --------------------------------------------------
        # STEP 3: CHECK ACTIVE ISSUE COUNT
        # --------------------------------------------------
        # Count how many books the user is CURRENTLY holding
        # (return_date IS NULL means book not yet returned)
        cursor.execute(
            """
            SELECT COUNT(*) AS count
            FROM issues
            WHERE user_id = %s
              AND return_date IS NULL
            """,
            (user_id,)
        )

        # Extract numeric count from result
        active_count = cursor.fetchone()["count"]

        # Enforce maximum books per user rule
        if active_count >= max_books:
            return f"‚ùå User has reached issue limit for {membership['tier']} tier ({max_books} books)"

        # --------------------------------------------------
        # STEP 4: CHECK BOOK AVAILABILITY
        # --------------------------------------------------
        # A book can only be issued if at least one copy
        # is available in inventory.
        cursor.execute(
            """
            SELECT title, available_copies
            FROM books
            WHERE book_id = %s
            """,
            (book_id,)
        )

        book = cursor.fetchone()

        # Book does not exist OR no copies left
        if not book or book["available_copies"] <= 0:
            return "‚ùå Book not available"

        # --------------------------------------------------
        # STEP 5: PREVENT DUPLICATE ACTIVE ISSUE
        # --------------------------------------------------
        # A user should NOT be able to issue the same book
        # multiple times without returning it first.
        cursor.execute(
            """
            SELECT issue_id
            FROM issues
            WHERE user_id = %s
              AND book_id = %s
              AND return_date IS NULL
            """,
            (user_id, book_id)
        )

        # If any active issue exists ‚Üí block operation
        if cursor.fetchone():
            return "‚ùå Book already issued to user"

        # --------------------------------------------------
        # STEP 6: ISSUE TRANSACTION (ATOMIC OPERATION)
        # --------------------------------------------------
        # From this point onward, ALL operations must succeed
        # together or be rolled back.

        # Insert new issue record
        cursor.execute(
            """
            INSERT INTO issues (user_id, book_id, issue_date)
            VALUES (%s, %s, %s)
            """,
            (user_id, book_id, date.today())
        )

        # Reduce available copies by 1
        cursor.execute(
            """
            UPDATE books
            SET available_copies = available_copies - 1
            WHERE book_id = %s
            """,
            (book_id,)
        )

        # NEW: Clean up any active reservation/waitlist entry for this user
        cursor.execute(
            "DELETE FROM reservations WHERE user_id = %s AND book_id = %s",
            (user_id, book_id)
        )

        # Commit transaction ‚Äî changes become permanent
        conn.commit()

        # --------------------------------------------------
        # NEW: GAMIFICATION HOOK
        # --------------------------------------------------
        try:
            from backend.services.gamification_service import award_xp
            award_xp(user_id, 20, "Borrowed a book")
        except Exception as game_err:
            print(f"‚ö†Ô∏è Gamification error: {game_err}")

        # --------------------------------------------------
        # STEP 7: NOTIFICATIONS & HOOKS
        # --------------------------------------------------
        try:
            from backend.services.email_service import notify_issue
            from datetime import timedelta
            due_date = (date.today() + timedelta(days=loan_days)).strftime('%Y-%m-%d')
            notify_issue(user["name"], user["email"], book["title"], due_date)
            
            # In-App Notification
            from backend.services.notification_service import add_notification
            add_notification(user_id, f"üìñ Book Issued: '{book['title']}'. Due: {due_date} ({membership['tier']} Tier)")
        except Exception as e:
            print(f"‚ö†Ô∏è Notification failed: {e}")

        # Trigger Waitlist Notification
        try:
            from backend.services.reservation_service import notify_waitlist_user
            notify_waitlist_user(book_id, book['title'])
        except Exception as e:
            print(f"‚ö†Ô∏è Waitlist notification failed: {e}")
            
        # Trigger Reading Goal Progress
        try:
            from backend.services.goal_service import increment_goal_progress
            increment_goal_progress(user_id)
        except Exception as e:
            print(f"‚ö†Ô∏è Reading goal progress update failed: {e}")
            
        # Activity Log
        try:
            from backend.services.activity_service import log_user_activity
            log_user_activity(user_id, "BORROW", f"Borrowed '{book['title']}'")
        except Exception as e:
            print(f"‚ö†Ô∏è Activity log failed: {e}")

        return "‚úÖ Book issued successfully"

    except Exception as e:
        # --------------------------------------------------
        # STEP 7: ERROR HANDLING
        # --------------------------------------------------
        # If ANY error occurs at ANY step above,
        # rollback ensures database consistency.
        conn.rollback()
        return f"‚ùå Issue failed: {str(e)}"

    finally:
        # --------------------------------------------------
        # STEP 8: CLEANUP (ALWAYS EXECUTED)
        # --------------------------------------------------
        # Prevents connection leaks
        cursor.close()
        conn.close()


# =====================================================
# RETURN BOOK
# =====================================================

def return_book(user_id: int, book_id: int):
    """
    Returns a previously issued book.

    Responsibilities:
    - Validate active issue
    - Calculate fine if overdue
    - Update issue & book tables atomically
    """

    # Create database connection
    conn = get_connection()

    # Dictionary cursor
    cursor = conn.cursor(dictionary=True)

    try:
        # ------------------------------
        # FETCH ACTIVE ISSUE
        # ------------------------------

        # Get issue record that is not yet returned
        cursor.execute(
            """
            SELECT issue_id, issue_date
            FROM issues
            WHERE user_id = %s
              AND book_id = %s
              AND return_date IS NULL
            """,
            (user_id, book_id)
        )

        issue = cursor.fetchone()

        # If no active issue exists
        if not issue:
            return "‚ùå No active issue found"

        # ------------------------------
        # FINE CALCULATION (DYNAMIC)
        # ------------------------------
        from backend.services.membership_service import get_user_membership_config
        membership = get_user_membership_config(user_id)
        loan_days = membership['loan_days']

        # Get book category and its fine rate
        cursor.execute("""
            SELECT b.category, COALESCE(cf.daily_rate, %s) as rate
            FROM books b
            LEFT JOIN category_fines cf ON b.category = cf.category
            WHERE b.book_id = %s
        """, (FINE_PER_DAY, book_id))
        
        fine_data = cursor.fetchone()
        rate = fine_data['rate'] if fine_data else FINE_PER_DAY

        # Calculate how many days book was kept
        days_kept = (date.today() - issue["issue_date"]).days

        # Default fine is zero
        fine = 0

        # Apply fine if overdue
        if days_kept > loan_days:
            fine = (days_kept - loan_days) * rate

        # ------------------------------
        # RETURN TRANSACTION (ATOMIC)
        # ------------------------------

        # Update issue record with return date & fine
        cursor.execute(
            """
            UPDATE issues
            SET return_date = %s,
                fine = %s
            WHERE issue_id = %s
            """,
            (date.today(), fine, issue["issue_id"])
        )

        # Increase available copies count
        cursor.execute(
            """
            UPDATE books
            SET available_copies = available_copies + 1
            WHERE book_id = %s
            """,
            (book_id,)
        )

        # Commit transaction
        conn.commit()

        # --------------------------------------------------
        # NEW: GAMIFICATION HOOK (XP on Return)
        # --------------------------------------------------
        try:
            from backend.services.gamification_service import award_xp
            xp_reward = 50 if fine == 0 else 10
            award_xp(user_id, xp_reward, "Returned a book")
        except Exception as game_err:
            print(f"‚ö†Ô∏è Gamification return XP error: {game_err}")

        # --------------------------------------------------
        # STEP 4: NOTIFY WAITLIST
        # --------------------------------------------------
        try:
            from backend.services.reservation_service import notify_waitlist_user
            # We need title for the email
            cursor.execute("SELECT title FROM books WHERE book_id = %s", (book_id,))
            b_data = cursor.fetchone()
            if b_data:
                # Notify via Email
                notify_waitlist_user(book_id, b_data['title'])
                
                # Notify via App (We need to find who the waitlist user is, but the service handles it internally)
                # Actually notify_waitlist_user takes book_id, let's see reservation_service.
                # For now just leave email for waitlist or improve later.
                pass
        except Exception as ignored:
            print(f"Waitlist notification warning: {ignored}")

        # Notify Borrower of Return
        from backend.services.notification_service import add_notification
        add_notification(user_id, f"‚úÖ Returned: '{book_id}' (Fine: ‚Çπ{fine})")
        
        # Activity Log
        from backend.services.activity_service import log_user_activity
        log_user_activity(user_id, "RETURN", f"Returned book {book_id}")

        return f"‚úÖ Book returned | Fine: ‚Çπ{fine}"

    except Exception as e:
        # Rollback on failure
        conn.rollback()
        return f"‚ùå Return failed: {str(e)}"

    finally:
        # Always close DB resources
        cursor.close()
        conn.close()


def send_overdue_reminders():
    """
    Scans for all overdue books and sends email alerts.
    """
    from backend.repository.db_access import fetch_all
    from backend.services.email_service import notify_overdue
    
    # Fetch active issues that are overdue
    overdue_records = fetch_all(
        """
        SELECT 
            u.name, 
            u.email, 
            b.title, 
            i.issue_date,
            DATEDIFF(CURDATE(), i.issue_date) - %s AS days_overdue
        FROM issues i
        JOIN users u ON i.user_id = u.user_id
        JOIN books b ON i.book_id = b.book_id
        WHERE i.return_date IS NULL
          AND DATEDIFF(CURDATE(), i.issue_date) > %s
        """,
        (MAX_DAYS_ALLOWED, MAX_DAYS_ALLOWED)
    )
    
    count = 0
    for rec in overdue_records:
        fine = rec["days_overdue"] * FINE_PER_DAY
        if notify_overdue(rec["name"], rec["email"], rec["title"], rec["days_overdue"], fine):
            count += 1
            
            
    return f"‚úÖ Sent {count} overdue reminders successfully"


def pay_fine(issue_id: int):
    """
    Marks a fine as paid for a specific issue record.
    """
    from backend.repository.db_access import execute_query, fetch_one
    
    # Verify fine exists and is positive
    issue = fetch_one("SELECT fine, fine_paid FROM issues WHERE issue_id = %s", (issue_id,))
    
    if not issue:
        return "‚ùå Record not found"
        
    if issue['fine'] <= 0:
        return "‚ö†Ô∏è No fine to pay for this record."
        
    if issue['fine_paid']:
        return "‚ö†Ô∏è Fine already paid."
        
    try:
        execute_query("UPDATE issues SET fine_paid = TRUE WHERE issue_id = %s", (issue_id,))
        return f"‚úÖ Fine of ‚Çπ{issue['fine']} collected successfully."
    except Exception as e:
        return f"‚ùå Error collecting fine: {str(e)}"

</file>

<file path="backend\services\membership_service.py">

from backend.repository.db_access import fetch_one, execute, fetch_all

def get_user_tier(user_id):
    """Returns the membership tier of a user (Silver, Gold, or Platinum)."""
    res = fetch_one("SELECT tier FROM users WHERE user_id = %s", (user_id,))
    return res['tier'] if (res and res['tier']) else 'Silver'

def get_tier_config(tier):
    """Returns the borrowing limits and duration (max_books, loan_days) for a given tier."""
    from backend.services.settings_service import get_setting
    
    # Fetch global defaults for base tier (Silver)
    default_max = int(get_setting('max_books_per_user', 3))
    default_days = int(get_setting('default_issue_days', 7))

    configs = {
        'Silver': {'max_books': default_max, 'loan_days': default_days},
        'Gold': {'max_books': 6, 'loan_days': 21},
        'Platinum': {'max_books': 10, 'loan_days': 30}
    }
    return configs.get(tier, configs['Silver'])

def get_user_membership_config(user_id):
    """Returns the membership configuration for a specific user based on their tier."""
    tier = get_user_tier(user_id)
    config = get_tier_config(tier)
    if not config:
        # Default fallback to Silver if config is missing (safety)
        return {'tier': 'Silver', 'max_books': 3, 'loan_days': 14}
    return config

def update_user_tier(user_id, new_tier):
    """Updates a user's membership tier."""
    valid_tiers = ['Silver', 'Gold', 'Platinum']
    if new_tier not in valid_tiers:
        return "‚ùå Invalid tier"
    execute("UPDATE users SET tier = %s WHERE user_id = %s", (new_tier, user_id))
    return f"‚úÖ User {user_id} updated to {new_tier}"

def get_all_tiers():
    """Returns all available membership configurations."""
    return [
        {'tier': 'Silver', 'max_books': 3, 'loan_days': 14},
        {'tier': 'Gold', 'max_books': 6, 'loan_days': 21},
        {'tier': 'Platinum', 'max_books': 10, 'loan_days': 30}
    ]

</file>

<file path="backend\services\metadata_service.py">

import requests
from backend.services.author_service import add_author
from backend.repository.db_access import fetch_one

def fetch_book_metadata(isbn):
    """
    Fetches book details from OpenLibrary and Google Books APIs.
    Returns a dict with title, author_name, category, and cover_url.
    """
    isbn = isbn.strip().replace("-", "")
    
    # 1. Try Google Books API first (usually better results)
    try:
        gb_url = f"https://www.googleapis.com/books/v1/volumes?q=isbn:{isbn}"
        resp = requests.get(gb_url, timeout=5)
        data = resp.json()
        
        if data.get("totalItems", 0) > 0:
            item = data["items"][0]["volumeInfo"]
            author_name = item.get("authors", ["Unknown"])[0]
            
            return {
                "title": item.get("title", "Unknown Title"),
                "author_name": author_name,
                "category": item.get("categories", ["General"])[0],
                "description": item.get("description", ""),
                "cover_url": item.get("imageLinks", {}).get("thumbnail", ""),
                "isbn": isbn
            }
    except Exception as e:
        print(f"‚ö†Ô∏è Google Books API error: {e}")

    # 2. Fallback to OpenLibrary API
    try:
        ol_url = f"https://openlibrary.org/api/books?bibkeys=ISBN:{isbn}&format=json&jscmd=data"
        resp = requests.get(ol_url, timeout=5)
        data = resp.json()
        
        key = f"ISBN:{isbn}"
        if key in data:
            book = data[key]
            author_name = book.get("authors", [{"name": "Unknown"}])[0]["name"]
            
            return {
                "title": book.get("title", "Unknown Title"),
                "author_name": author_name,
                "category": "General", # OL data varies
                "description": book.get("notes", ""),
                "cover_url": book.get("cover", {}).get("large", ""),
                "isbn": isbn
            }
    except Exception as e:
        print(f"‚ö†Ô∏è OpenLibrary API error: {e}")

    return None

def process_metadata_for_form(isbn):
    """
    Fetches metadata and checks if author exists.
    Returns data ready for the frontend form.
    """
    data = fetch_book_metadata(isbn)
    if not data:
        return None
        
    # Check if author exists, if not we might need to handle it on the frontend
    # or return the author_name for the admin to confirm.
    author_res = fetch_one("SELECT author_id FROM authors WHERE name = %s", (data['author_name'],))
    data['author_id'] = author_res['author_id'] if author_res else None
    
    return data

</file>

<file path="backend\services\notification_service.py">

from backend.repository.db_access import execute_query, fetch_all

def add_notification(user_id, message):
    try:
        execute_query(
            "INSERT INTO notifications (user_id, message) VALUES (%s, %s)",
            (user_id, message)
        )
    except Exception as e:
        print(f"Failed to add notification: {e}")

def get_unread_notifications(user_id):
    return fetch_all(
        """
        SELECT * FROM notifications 
        WHERE user_id = %s AND is_read = FALSE
        ORDER BY created_at DESC
        """,
        (user_id,)
    )

def mark_notification_read(notification_id, user_id):
    execute_query("UPDATE notifications SET is_read = TRUE WHERE notification_id = %s AND user_id = %s", (notification_id, user_id))

def mark_all_read(user_id):
    execute_query("UPDATE notifications SET is_read = TRUE WHERE user_id = %s", (user_id,))

</file>

<file path="backend\services\recommendation_service.py">

from backend.repository.db_access import fetch_all, fetch_one

def get_smart_recommendations(user_id, limit=6):
    """
    Suggests books based on user's borrowing history.
    1. Finds top categories borrowed by user.
    2. Suggests highest-rated/popular books in those categories not yet borrowed by user.
    """
    # Step 1: Get user's top 2 categories
    user_categories = fetch_all("""
        SELECT b.category, COUNT(*) as count
        FROM issues i
        JOIN books b ON i.book_id = b.book_id
        WHERE i.user_id = %s
        GROUP BY b.category
        ORDER BY count DESC
        LIMIT 2
    """, (user_id,))
    
    if not user_categories:
        # Fallback: Just return popular books if no history
        return fetch_all("""
            SELECT b.*, COALESCE(AVG(r.rating), 0) as avg_rating
            FROM books b
            LEFT JOIN reviews r ON b.book_id = r.book_id
            GROUP BY b.book_id
            ORDER BY avg_rating DESC, available_copies DESC
            LIMIT %s
        """, (limit,))

    categories = [c['category'] for c in user_categories]
    
    # Step 2: Get recommendations from these categories
    # Excluding books already borrowed
    
    # We need to construct the placeholder string for the IN clause
    placeholders = ', '.join(['%s'] * len(categories))
    
    # Base query for category-based recs
    query = f"""
        SELECT b.book_id, b.title, b.author, b.category, b.cover_url, b.description, COALESCE(AVG(r.rating), 0) as avg_rating
        FROM books b
        LEFT JOIN reviews r ON b.book_id = r.book_id
        WHERE b.category IN ({placeholders})
        AND b.book_id NOT IN (SELECT book_id FROM issues WHERE user_id = %s)
        AND b.available_copies > 0
        GROUP BY b.book_id
        ORDER BY avg_rating DESC, RAND()
        LIMIT %s
    """
    
    # prepare params: categories... + user_id + limit
    params = categories + [user_id, limit]
    
    results = fetch_all(query, tuple(params))
    
    # Fallback if categories don't yield enough new books (or if user has read them all)
    if len(results) < limit:
        remaining = limit - len(results)
        
        # Avoid suggesting what we already found
        found_ids = [r['book_id'] for r in results]
        
        # Query for general popular/random books
        fallback_query = """
            SELECT b.book_id, b.title, b.author, b.category, b.cover_url, b.description, COALESCE(AVG(r.rating), 0) as avg_rating
            FROM books b
            LEFT JOIN reviews r ON b.book_id = r.book_id
            WHERE b.book_id NOT IN (SELECT book_id FROM issues WHERE user_id = %s)
            AND b.available_copies > 0
        """
        
        fallback_params = [user_id]
        
        if found_ids:
            fallback_placeholders = ', '.join(['%s'] * len(found_ids))
            fallback_query += f" AND b.book_id NOT IN ({fallback_placeholders})"
            fallback_params.extend(found_ids)
            
        fallback_query += """
            GROUP BY b.book_id
            ORDER BY avg_rating DESC, RAND()
            LIMIT %s
        """
        fallback_params.append(remaining)
        
        extra = fetch_all(fallback_query, tuple(fallback_params))
        results.extend(extra)
        
    return results

</file>

<file path="backend\services\report_service.py">

import os
from fpdf import FPDF
from datetime import datetime
from backend.repository.db_access import fetch_one, fetch_all
from backend.services.email_service import send_email

def generate_weekly_report():
    """Generates a PDF report of library performance and emails it to admins."""
    print("Generating report...")
    
    # 1. Gather Data
    book_count = fetch_one("SELECT COUNT(*) as cnt FROM books")['cnt']
    user_count = fetch_one("SELECT COUNT(*) as cnt FROM users WHERE role='member'")['cnt']
    active_issues = fetch_one("SELECT COUNT(*) as cnt FROM issues WHERE return_date IS NULL")['cnt']
    
    top_books = most_issued_books()

    # 2. Create PDF
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("helvetica", 'B', 16)
    pdf.cell(0, 10, 'Weekly Library Performance Report', ln=True, align='C')
    pdf.set_font("helvetica", size=12)
    pdf.cell(0, 10, f'Generated on: {datetime.now().strftime("%Y-%m-%d %H:%M")}', ln=True, align='C')
    pdf.ln(10)

    # Stats Summary
    pdf.set_font("helvetica", 'B', 14)
    pdf.cell(0, 10, 'General Statistics:', ln=True)
    pdf.set_font("helvetica", size=12)
    pdf.cell(0, 10, f'- Total Books in Catalog: {book_count}', ln=True)
    pdf.cell(0, 10, f'- Total Registered Members: {user_count}', ln=True)
    pdf.cell(0, 10, f'- Current Active Borrowings: {active_issues}', ln=True)
    pdf.ln(10)

    # Most Popular Books
    pdf.set_font("helvetica", 'B', 14)
    pdf.cell(0, 10, 'Most Popular Books this Week:', ln=True)
    pdf.set_font("helvetica", size=12)
    for i, book in enumerate(top_books[:5], 1):
        pdf.cell(0, 10, f'{i}. {book["title"]} ({book["count"]} borrows)', ln=True)

    # 3. Save PDF
    report_dir = "reports"
    if not os.path.exists(report_dir):
        os.makedirs(report_dir)
        
    filename = f"report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf"
    filepath = os.path.join(report_dir, filename)
    pdf.output(filepath)
    print(f"‚úÖ Report saved: {filepath}")

    # 4. Email to Admins
    admins = fetch_all("SELECT email FROM users WHERE role='admin'")
    for admin in admins:
        send_email(
            admin['email'], 
            f"üìä Weekly Library Report - {datetime.now().strftime('%Y-%m-%d')}",
            "Please find the attached weekly library performance report.",
            filepath
        )
    
    return filepath

# --- RESTORED ANALYTICS FUNCTIONS ---

def most_issued_books():
    """Returns top 10 most borrowed books."""
    return fetch_all("""
        SELECT b.title, COUNT(*) as issue_count 
        FROM issues i 
        JOIN books b ON i.book_id = b.book_id 
        GROUP BY b.book_id 
        ORDER BY issue_count DESC LIMIT 10
    """)

def most_active_users():
    """Returns top 10 members with most borrowings."""
    return fetch_all("""
        SELECT u.name, COUNT(*) as total_issues 
        FROM issues i 
        JOIN users u ON i.user_id = u.user_id 
        WHERE u.role = 'member'
        GROUP BY u.user_id 
        ORDER BY total_issues DESC LIMIT 10
    """)

def monthly_issue_count():
    """Returns issue count per month for the last 12 months."""
    return fetch_all("""
        SELECT DATE_FORMAT(issue_date, '%Y-%m') as month, COUNT(*) as total_issues 
        FROM issues 
        GROUP BY month 
        ORDER BY month DESC LIMIT 12
    """)

def book_category_distribution():
    """Returns book count per category."""
    return fetch_all("SELECT category, COUNT(*) as book_count FROM books GROUP BY category")

def export_report(data, filename):
    """Exports data to CSV and returns success message."""
    import csv
    if not os.path.exists("exports"):
        os.makedirs("exports")
    
    filepath = f"exports/{filename}_{datetime.now().strftime('%Y%m%d')}.csv"
    if data:
        keys = data[0].keys()
        with open(filepath, 'w', newline='', encoding='utf-8') as f:
            writer = csv.DictWriter(f, fieldnames=keys)
            writer.writeheader()
            writer.writerows(data)
        return f"‚úÖ Report exported successfully to {filepath}"
    return "‚ö†Ô∏è No data found to export."

</file>

<file path="backend\services\request_service.py">
"""
request_service.py
-------------------
Handles book request operations:
- create request
- view pending requests
- process request (approve/reject)
"""

from datetime import date
from backend.repository.db_access import execute, fetch_all, fetch_one
from backend.services.issue_service import issue_book

def create_request(user_id: int, book_id: int):
    """
    Creates a new book request for a user.
    """
    if not book_id:
        return "‚ùå Request Failed: No book selected"

    import mysql.connector

    try:
        # Check if user already has a pending or approved request for this book
        # (Optional business rule: prevent spamming requests)
        existing = fetch_one(
            """
            SELECT request_id FROM book_requests 
            WHERE user_id = %s AND book_id = %s AND status = 'Pending'
            """,
            (user_id, book_id)
        )
        if existing:
            return "‚ö†Ô∏è You already have a pending request for this book"

        # Insert request
        execute(
            """
            INSERT INTO book_requests (user_id, book_id, request_date, status)
            VALUES (%s, %s, %s, 'Pending')
            """,
            (user_id, book_id, date.today())
        )
        return "‚úÖ Request sent to admin"
    
    except mysql.connector.Error as err:
        if err.errno == 1146: # Table doesn't exist
            return "‚ùå Error: 'book_requests' table missing. Contact Admin to run DB setup."
        raise err

def get_pending_requests():
    """
    Fetches all pending requests with user and book details.
    """
    import mysql.connector
    try:
        return fetch_all(
            """
            SELECT 
                r.request_id,
                r.request_date,
                u.name AS user_name,
                b.title AS book_title
            FROM book_requests r
            JOIN users u ON r.user_id = u.user_id
            JOIN books b ON r.book_id = b.book_id
            WHERE r.status = 'Pending'
            ORDER BY r.request_date ASC
            """
        )
    except mysql.connector.Error as err:
        # Gracefully handle missing table error so dashboard doesn't crash
        if err.errno == 1146: # Table doesn't exist
            print("‚ö†Ô∏è Table 'book_requests' missing. Please run database/DBMS_library_db.sql")
            return None # Indicate error to caller
        raise err

def process_request(request_id: int, action: str):
    """
    Approves or Rejects a request.
    If Approved -> Issues the book.
    """
    # Verify request exists
    req = fetch_one(
        """
        SELECT r.user_id, r.book_id, r.status, u.name, u.email, b.title 
        FROM book_requests r
        JOIN users u ON r.user_id = u.user_id
        JOIN books b ON r.book_id = b.book_id
        WHERE r.request_id = %s
        """,
        (request_id,)
    )
    if not req:
        return "‚ùå Request not found"
    
    if req["status"] != "Pending":
        return f"‚ö†Ô∏è Request is already {req['status']}"

    if action == "approve":
        # Try to issue the book
        result = issue_book(req["user_id"], req["book_id"])
        
        # If issue successful, update request status
        if "‚úÖ" in result:
            execute(
                "UPDATE book_requests SET status = 'Approved' WHERE request_id = %s",
                (request_id,)
            )
            return "‚úÖ Request Approved & Book Issued"
        else:
            return f"‚ùå Approval Failed: {result}"
            
    elif action == "reject":
        execute(
            "UPDATE book_requests SET status = 'Rejected' WHERE request_id = %s",
            (request_id,)
        )
        try:
            from backend.services.email_service import notify_request_status
            notify_request_status(req["name"], req["email"], req["title"], "Rejected")
        except:
            pass
        return "‚úÖ Request Rejected"

    return "‚ùå Invalid Action"

</file>

<file path="backend\services\reservation_service.py">

from backend.repository.db_access import execute_query, fetch_one, fetch_all

def join_waitlist(user_id, book_id):
    """
    Adds a user to the waitlist for a book.
    """
    # Check if book is actually out of stock?
    # Ideally frontend checks, but double check here.
    book = fetch_one("SELECT available_copies FROM books WHERE book_id = %s", (book_id,))
    if not book:
        return "‚ùå Book not found."
    
    if book['available_copies'] > 0:
        return "‚ö†Ô∏è This book is available! You can request it directly."

    try:
        execute_query(
            "INSERT INTO reservations (user_id, book_id) VALUES (%s, %s)",
            (user_id, book_id)
        )
        return "‚úÖ Added to waitlist! We'll notify you when it's available."
    except Exception as e:
        if "Duplicate entry" in str(e):
            return "‚ö†Ô∏è You are already on the waitlist for this book."
        return f"‚ùå Error joining waitlist: {str(e)}"

def get_next_in_line(book_id):
    """
    Gets the next user waiting for a book.
    """
    return fetch_one(
        "SELECT * FROM reservations WHERE book_id = %s AND status='active' ORDER BY reserved_at ASC LIMIT 1",
        (book_id,)
    )

def notify_waitlist_user(book_id, book_title):
    """
    Checks if anyone is waiting and notifies the first person.
    Called when a book is returned.
    """
    from backend.services.email_service import send_email, SMTP_USER, SMTP_PASS
    
    reservation = get_next_in_line(book_id)
    if not reservation:
        return # No one waiting
        
    user = fetch_one("SELECT name, email FROM users WHERE user_id = %s", (reservation['user_id'],))
    if not user:
        return

    # Notify via Email
    subject = f"üìö Good News! '{book_title}' is now available"
    body = f"""Hi {user['name']},

Great news! The book you were waiting for, '{book_title}', has been returned to the library.

Please log in and request it immediately to secure your copy.

Best regards,
Library Management Team
"""
    # Send email (async ideally, but here sync is fine for now)
    # Mark reservation as fulfilled? 
    # Or keep it active until they actually Request it?
    # Usually we notify them. If we mark it 'fulfilled' they might miss it.
    # Let's keep it 'active' but maybe add a 'notified_at' column effectively?
    # For simplicity, we just notify. They trigger the Request manually.
    
    # Notify via Email
    send_email(user['email'], subject, body)
    
    # NEW: Notify via In-App Notification
    try:
        from backend.services.notification_service import add_notification
        add_notification(reservation['user_id'], f"üìó Book Available: '{book_title}' is now back in stock!")
    except Exception as e:
        print(f"Waitlist In-App Notification Error: {e}")

</file>

<file path="backend\services\review_service.py">

from backend.repository.db_access import execute_query, fetch_all, fetch_one

def add_review(user_id, book_id, rating, comment):
    """
    Adds a review for a book.
    Ensures user handles constraints (one review per book per user).
    """
    try:
        # Check if review already exists
        existing = fetch_one(
            "SELECT review_id FROM reviews WHERE user_id = %s AND book_id = %s",
            (user_id, book_id)
        )
        if existing:
            return "‚ùå You have already reviewed this book."

        execute_query(
            "INSERT INTO reviews (user_id, book_id, rating, comment) VALUES (%s, %s, %s, %s)",
            (user_id, book_id, rating, comment)
        )
        return "‚úÖ Review submitted successfully."
    except Exception as e:
        return f"‚ùå Error submitting review: {str(e)}"

def get_book_reviews(book_id):
    """
    Fetches all reviews for a book details page.
    """
    query = """
    SELECT r.rating, r.comment, r.created_at, u.name as user_name
    FROM reviews r
    JOIN users u ON r.user_id = u.user_id
    WHERE r.book_id = %s
    ORDER BY r.created_at DESC
    """
    return fetch_all(query, (book_id,))

def get_average_rating(book_id):
    """
    Calculates average rating for a book.
    """
    res = fetch_one("SELECT AVG(rating) as avg_rating, COUNT(*) as count FROM reviews WHERE book_id = %s", (book_id,))
    if res and res['avg_rating']:
        return round(res['avg_rating'], 1), res['count']
    return 0, 0

</file>

<file path="backend\services\settings_service.py">

from backend.repository.db_access import execute_query, fetch_one, fetch_all

def get_all_settings():
    """Returns a dictionary of all system settings."""
    try:
        rows = fetch_all("SELECT setting_key, setting_value FROM settings")
        return {r['setting_key']: r['setting_value'] for r in rows}
    except:
        return {}

def get_setting(key, default=None):
    """Returns a single setting value."""
    try:
        res = fetch_one("SELECT setting_value FROM settings WHERE setting_key = %s", (key,))
        return res['setting_value'] if res else default
    except:
        return default

def is_maintenance_mode():
    return get_setting('maintenance_mode', 'false') == 'true'

def set_maintenance_mode(status: bool):
    val = 'true' if status else 'false'
    update_setting('maintenance_mode', val)
    return f"‚úÖ Maintenance Mode set to {val}"

def update_setting(key, value):
    """Updates or inserts a setting key."""
    execute_query("INSERT INTO settings (setting_key, setting_value) VALUES (%s, %s) ON DUPLICATE KEY UPDATE setting_value = %s", (key, value, value))

def update_settings(settings_dict):
    """Updates multiple settings at once."""
    for key, val in settings_dict.items():
        update_setting(key, val)
    return "‚úÖ Settings updated successfully."

def get_category_fines():
    return fetch_all("SELECT * FROM category_fines ORDER BY category")

def update_category_fine(category, rate):
    execute_query("INSERT INTO category_fines (category, daily_rate) VALUES (%s, %s) ON DUPLICATE KEY UPDATE daily_rate = %s", (category, rate, rate))
    return f"‚úÖ Fine rate for '{category}' updated to ‚Çπ{rate}."

def delete_category_fine(category):
    execute_query("DELETE FROM category_fines WHERE category = %s", (category,))
    return f"‚úÖ Fine rate for '{category}' removed."

</file>

<file path="backend\services\social_service.py">
from backend.repository.db_access import execute, fetch_all, fetch_one
from backend.services.chat_service import get_or_create_dm_room

def send_friend_request(sender_id, search_query):
    """Sends a friend request from one user to another. search_query can be user_id or anon_id."""
    
    # Resolve receiver_id
    receiver_id = None
    
    # 1. Try as direct user_id (if numeric)
    if str(search_query).isdigit():
        receiver = fetch_one("SELECT user_id FROM users WHERE user_id = %s", (search_query,))
        if receiver:
            receiver_id = receiver['user_id']
            
    # 2. Try as anon_id
    if not receiver_id:
        anon_map = fetch_one("SELECT user_id FROM chat_anon_id WHERE anon_id = %s", (search_query,))
        if anon_map:
            receiver_id = anon_map['user_id']
            
    if not receiver_id:
        raise Exception("User not found")

    # Check privacy settings
    receiver_data = fetch_one("SELECT allow_requests FROM users WHERE user_id = %s", (receiver_id,))
    if receiver_data and receiver_data.get('allow_requests') == 0:
        raise Exception("This user is not accepting friend requests")

    if sender_id == receiver_id:
        raise Exception("You cannot add yourself as a friend")
    
    # Check if a request already exists
    existing = fetch_one(
        "SELECT id, status FROM friend_requests WHERE (sender_id = %s AND receiver_id = %s) OR (sender_id = %s AND receiver_id = %s)",
        (sender_id, receiver_id, receiver_id, sender_id)
    )
    
    if existing:
        if existing['status'] == 'accepted':
            raise Exception("You are already friends")
        if existing['status'] == 'pending':
            raise Exception("A friend request is already pending")
        # If rejected, we allow a new one? Or just update it? Let's just allow a new one by deleting old
        execute("DELETE FROM friend_requests WHERE id = %s", (existing['id'],))

    execute(
        "INSERT INTO friend_requests (sender_id, receiver_id, status) VALUES (%s, %s, 'pending')",
        (sender_id, receiver_id)
    )
    return True

def get_pending_requests(user_id):
    """Gets all pending friend requests for a user."""
    return fetch_all("""
        SELECT f.id, f.sender_id, u.name as sender_name, u.profile_pic as sender_pic
        FROM friend_requests f
        JOIN users u ON f.sender_id = u.user_id
        WHERE f.receiver_id = %s AND f.status = 'pending'
    """, (user_id,))

def get_friends_list(user_id):
    """Gets the list of friends for a user."""
    return fetch_all("""
        SELECT 
            CASE 
                WHEN sender_id = %s THEN receiver_id 
                ELSE sender_id 
            END as friend_id,
            u.name, u.profile_pic, u.email
        FROM friend_requests f
        JOIN users u ON u.user_id = CASE WHEN f.sender_id = %s THEN f.receiver_id ELSE f.sender_id END
        WHERE (sender_id = %s OR receiver_id = %s) AND status = 'accepted'
    """, (user_id, user_id, user_id, user_id))

def respond_to_friend_request(request_id, current_user_id, status):
    """Accepts or rejects a friend request."""
    if status not in ['accepted', 'rejected']:
        raise Exception("Invalid status")
    
    request = fetch_one("SELECT * FROM friend_requests WHERE id = %s AND receiver_id = %s", (request_id, current_user_id))
    if not request:
        raise Exception("Request not found")
    
    execute("UPDATE friend_requests SET status = %s WHERE id = %s", (status, request_id))
    
    if status == 'accepted':
        # Automatically create/join a DM room
        get_or_create_dm_room(request['sender_id'], request['receiver_id'])
        
    return True

    return True

def update_privacy_settings(user_id, is_public, allow_requests, show_activity):
    """Updates user granular privacy settings."""
    try:
        val_public = 1 if is_public else 0
        val_requests = 1 if allow_requests else 0
        val_activity = 1 if show_activity else 0
        
        execute("""
            UPDATE users 
            SET is_public = %s, allow_requests = %s, show_activity = %s 
            WHERE user_id = %s
        """, (val_public, val_requests, val_activity, user_id))
        
        return "‚úÖ Privacy settings updated."
    except Exception as e:
        return f"‚ùå Error updating privacy: {str(e)}"

def get_leaderboard(limit=50):
    """
    Fetches top readers for the leaderboard.
    Only includes users with is_public = 1.
    """
    from datetime import datetime
    year = datetime.now().year
    
    return fetch_all("""
        SELECT 
            u.user_id, u.name, u.profile_pic, u.tier,
            COALESCE(rg.current_books, 0) as books_read,
            COALESCE(rg.goal_books, 0) as goal_books
        FROM users u
        LEFT JOIN reading_goals rg ON u.user_id = rg.user_id AND rg.year = %s
        WHERE u.is_public = 1
        ORDER BY books_read DESC, goal_books DESC
        LIMIT %s
    """, (year, limit))

def get_public_profile(target_user_id, viewer_id):
    """
    Fetches public profile data if the user is public.
    """
    # 1. Fetch User Basics & Privacy
    query = """
        SELECT user_id, name, bio, profile_pic, tier, created_at, 
               is_public, allow_requests, show_activity
        FROM users WHERE user_id = %s
    """
    user = fetch_one(query, (target_user_id,))
    
    if not user:
        return None, "User not found"
        
    if user['is_public'] == 0 and user['user_id'] != viewer_id:
        return None, "This profile is private."
        
    # 2. Fetch Reading Stats (Current Year)
    from datetime import datetime
    year = datetime.now().year
    goal = fetch_one("SELECT * FROM reading_goals WHERE user_id = %s AND year = %s", (target_user_id, year))
    
    # 3. Check Friendship Status
    friend_status = "none"
    if viewer_id:
         f_req = fetch_one("""
            SELECT status, sender_id FROM friend_requests 
            WHERE (sender_id = %s AND receiver_id = %s) OR (sender_id = %s AND receiver_id = %s)
         """, (viewer_id, target_user_id, target_user_id, viewer_id))
         
         if f_req:
             if f_req['status'] == 'accepted':
                 friend_status = "friends"
             elif f_req['status'] == 'pending':
                 friend_status = "sent" if f_req['sender_id'] == viewer_id else "received"

    return {
        "user": user,
        "goal": goal,
        "friend_status": friend_status
    }, None

</file>

<file path="backend\services\support_service.py">

from backend.repository.db_access import execute_query, fetch_all, fetch_one

def create_ticket(user_id, subject, message):
    try:
        from backend.config.db import get_connection
        conn = get_connection()
        cursor = conn.cursor()
        
        # 1. Create Ticket
        cursor.execute("INSERT INTO tickets (user_id, subject) VALUES (%s, %s)", (user_id, subject))
        conn.commit() # Commit to get ID
        ticket_id = cursor.lastrowid
        
        # 2. Add First Message as Reply
        cursor.execute("INSERT INTO ticket_replies (ticket_id, sender_id, message) VALUES (%s, %s, %s)", 
                       (ticket_id, user_id, message))
        conn.commit()
        cursor.close()
        conn.close()
        
        return "‚úÖ Ticket created successfully"
    except Exception as e:
        return f"‚ùå Failed to create ticket: {str(e)}"

def add_reply(ticket_id, sender_id, message):
    try:
        execute_query("INSERT INTO ticket_replies (ticket_id, sender_id, message) VALUES (%s, %s, %s)",
                     (ticket_id, sender_id, message))
        
        # Notification Hook
        ticket = fetch_one("SELECT user_id FROM tickets WHERE ticket_id = %s", (ticket_id,))
        if ticket and ticket['user_id'] != int(sender_id):
             from backend.services.notification_service import add_notification
             add_notification(ticket['user_id'], f"üé´ New Reply on Ticket #{ticket_id}")

        return "‚úÖ Reply added"
    except Exception as e:
        return f"‚ùå Reply failed: {str(e)}"

def close_ticket(ticket_id):
    execute_query("UPDATE tickets SET status = 'closed' WHERE ticket_id = %s", (ticket_id,))
    
    # Notification Hook
    ticket = fetch_one("SELECT user_id FROM tickets WHERE ticket_id = %s", (ticket_id,))
    if ticket:
         from backend.services.notification_service import add_notification
         add_notification(ticket['user_id'], f"üîí Ticket #{ticket_id} has been closed.")

    return "‚úÖ Ticket closed"

def get_user_tickets(user_id):
    return fetch_all("SELECT * FROM tickets WHERE user_id = %s ORDER BY created_at DESC", (user_id,))

def get_all_tickets():
    return fetch_all(
        """
        SELECT t.*, u.name as user_name, u.email 
        FROM tickets t
        JOIN users u ON t.user_id = u.user_id
        ORDER BY t.created_at DESC
        """
    )

def get_ticket_details(ticket_id):
    ticket = fetch_one(
        """
        SELECT t.*, u.name as user_name 
        FROM tickets t 
        JOIN users u ON t.user_id = u.user_id 
        WHERE t.ticket_id = %s
        """, 
        (ticket_id,)
    )
    
    if not ticket: return None
    
    replies = fetch_all(
        """
        SELECT r.*, u.name as sender_name, u.role as sender_role
        FROM ticket_replies r
        JOIN users u ON r.sender_id = u.user_id
        WHERE r.ticket_id = %s
        ORDER BY r.created_at ASC
        """,
        (ticket_id,)
    )
    
    return {"ticket": ticket, "replies": replies}

</file>

<file path="backend\services\user_service.py">
"""
user_service.py
----------------
Handles user-related operations:
- add user
- view users
- delete user
- role checks
"""

from backend.repository.db_access import fetch_all, fetch_one, execute
from backend.utils.security import hash_password


def get_user_by_id(user_id: int):
    """
    Returns a user by their ID.
    """
    return fetch_one(
        """
        SELECT user_id, name, email, role, created_at, profile_pic, bio
        FROM users WHERE user_id = %s
        """,
        (user_id,)
    )


def add_user(name: str, email: str, role: str, password: str = "Lib@123"):
    """
    Adds a new user to the system.
    Default password is forced to be changed on first login.
    
    WARNING: Default password is for development only.
    Always provide a secure password in production.
    """

    # Check if user already exists
    existing_user = fetch_one(
        "SELECT user_id FROM users WHERE email = %s",
        (email,)
    )

    if existing_user:
        return "‚ùå User with this email already exists"

    # Hash password securely
    password_hash = hash_password(password)

    # Insert user record
    execute(
        """
        INSERT INTO users
            (name, email, password_hash, role, must_change_password)
        VALUES
            (%s, %s, %s, %s, TRUE)
        """,
        (name, email, password_hash, role)
    )

    return "‚úÖ User added successfully"


def view_users():
    """
    Returns a list of all users (admin use).
    """

    return fetch_all(
        """
        SELECT
            user_id,
            name,
            email,
            role,
            created_at
        FROM users
        ORDER BY user_id ASC
        """
    )


def delete_user(user_id: int):
    """
    Deletes a user by ID.
    """

    affected = execute(
        "DELETE FROM users WHERE user_id = %s",
        (user_id,)
    )

    if affected == 0:
        return "‚ùå User not found"

    return "üóëÔ∏è User deleted successfully"


def is_admin(user_id: int) -> bool:
    """
    Checks if a given user is an admin.
    """

    user = fetch_one(
        "SELECT role FROM users WHERE user_id = %s",
        (user_id,)
    )

    return bool(user and user["role"] == "admin")

def update_user_bio(user_id: int, bio: str):
    """
    Updates the biography/description of a user.
    """
    return execute(
        "UPDATE users SET bio = %s WHERE user_id = %s",
        (bio, user_id)
    )

</file>

<file path="backend\services\wishlist_service.py">

from backend.repository.db_access import execute_query, fetch_all

def add_to_wishlist(user_id, book_id):
    try:
        execute_query(
            "INSERT INTO wishlist (user_id, book_id) VALUES (%s, %s)",
            (user_id, book_id)
        )
        # Activity Log
        from backend.services.activity_service import log_user_activity
        log_user_activity(user_id, "WISHLIST", f"Added book #{book_id} to wishlist")
        
        return "‚úÖ Added to wishlist"
    except Exception as e:
        if "Duplicate" in str(e):
            return "‚ö†Ô∏è Already in wishlist"
        return f"‚ùå Failed to add: {str(e)}"

def remove_from_wishlist(user_id, book_id):
    execute_query("DELETE FROM wishlist WHERE user_id = %s AND book_id = %s", (user_id, book_id))
    return "‚úÖ Removed from wishlist"

def get_user_wishlist(user_id):
    return fetch_all(
        """
        SELECT b.*, w.added_at 
        FROM wishlist w
        JOIN books b ON w.book_id = b.book_id
        WHERE w.user_id = %s
        ORDER BY w.added_at DESC
        """,
        (user_id,)
    )

</file>

<file path="backend\services\__init__.py">

</file>

<file path="backend\utils\db_utils.py">
"""
db_utils.py
-----------
Database utility functions including context managers for database operations.
"""

from contextlib import contextmanager
from typing import Any, Iterator, Optional
import logging
from mysql.connector import Error as MySQLError
from mysql.connector.connection import MySQLConnection

from backend.config.db import get_connection

logger = logging.getLogger(__name__)

@contextmanager
def get_db_connection() -> Iterator[MySQLConnection]:
    """
    Context manager for database connections.
    
    Ensures proper connection handling and cleanup.
    
    Yields:
        MySQLConnection: A database connection from the pool.
        
    Raises:
        RuntimeError: If connection cannot be established.
    """
    conn = None
    try:
        conn = get_connection()
        yield conn
    except MySQLError as e:
        logger.error(f"Database error: {e}")
        raise RuntimeError("Database operation failed") from e
    finally:
        if conn and conn.is_connected():
            conn.close()

@contextmanager
def transaction() -> Iterator[MySQLConnection]:
    """
    Context manager for database transactions.
    
    Handles transaction commit/rollback automatically.
    
    Yields:
        MySQLConnection: A database connection for the transaction.
        
    Raises:
        RuntimeError: If transaction fails.
    """
    with get_db_connection() as conn:
        try:
            conn.start_transaction()
            yield conn
            conn.commit()
        except Exception as e:
            conn.rollback()
            logger.error(f"Transaction failed: {e}")
            raise RuntimeError("Transaction failed") from e

def execute_query(query: str, params: Optional[tuple] = None, fetch: bool = True) -> Any:
    """
    Execute a database query with parameters.
    
    Args:
        query: SQL query to execute
        params: Query parameters
        fetch: Whether to fetch results (for SELECT queries)
        
    Returns:
        Query results if fetch=True, otherwise None
    """
    with get_db_connection() as conn:
        cursor = conn.cursor(dictionary=True)
        try:
            cursor.execute(query, params or ())
            if fetch and cursor.with_rows:
                return cursor.fetchall()
            return None
        except MySQLError as e:
            logger.error(f"Query failed: {e}\nQuery: {query}\nParams: {params}")
            raise
        finally:
            cursor.close()

</file>

<file path="backend\utils\decorators.py">
from functools import wraps
from flask import session, redirect


def login_required(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        if "user_id" not in session:
            return redirect("/")
        return func(*args, **kwargs)
    return wrapper


def admin_required(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        if session.get("role") != "admin":
            return redirect("/")
        return func(*args, **kwargs)
    return wrapper


def member_required(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        if session.get("role") != "member":
            return redirect("/")
        return func(*args, **kwargs)
    return wrapper

</file>

<file path="backend\utils\rate_limiter.py">
import time
import threading
from collections import defaultdict

class RateLimiter:
    """
    In-Memory Rate Limiter using Token Bucket / Sliding Window.
    """
    def __init__(self):
        # Key -> (tokens, last_refill)
        self.buckets = defaultdict(lambda: (5, time.time())) 
        self.lock = threading.Lock()
        
        # Rate: 5 requests per 2 seconds
        self.rate = 5
        self.per = 2.0 

    def check(self, key):
        with self.lock:
            now = time.time()
            tokens, last_refill = self.buckets[key]
            
            # Refill
            elapsed = now - last_refill
            refill = int(elapsed * (self.rate / self.per))
            
            if refill > 0:
                tokens = min(self.rate, tokens + refill)
                last_refill = now
            
            # Consume
            if tokens >= 1:
                self.buckets[key] = (tokens - 1, last_refill)
                return True
            else:
                self.buckets[key] = (tokens, last_refill)
                return False

rate_limiter = RateLimiter()

def check_rate_limit(key):
    return rate_limiter.check(key)

</file>

<file path="backend\utils\security.py">
"""
security.py
------------
Handles password hashing and verification.
Centralising this avoids bugs and inconsistencies.
"""

import bcrypt


def hash_password(plain_password: str) -> str:
    """
    Hashes a plain-text password using bcrypt.

    Why bcrypt?
    - Salted automatically
    - Slow by design (prevents brute-force attacks)
    - Industry standard
    """

    # Convert string password to bytes (bcrypt requires bytes)
    password_bytes = plain_password.encode("utf-8")

    # Generate salt with cost factor 12 (secure & performant)
    salt = bcrypt.gensalt(rounds=12)

    # Hash password + salt
    hashed_password = bcrypt.hashpw(password_bytes, salt)

    # Return UTF-8 string representation suitable for VARCHAR storage
    return hashed_password.decode("utf-8")


def verify_password(plain_password: str, hashed_password) -> bool:
    """
    Verifies a plain password against a stored bcrypt hash.
    """

    # Convert plain password to bytes
    password_bytes = plain_password.encode("utf-8")

    # Support both str and bytes for the stored hash
    if isinstance(hashed_password, str):
        hashed_bytes = hashed_password.encode("utf-8")
    else:
        hashed_bytes = hashed_password

    try:
        # bcrypt safely checks hash
        return bcrypt.checkpw(password_bytes, hashed_bytes)
    except ValueError:
        # Covers corrupted hashes or invalid formats
        return False

</file>

<file path="backend\utils\snowflake.py">
import time
import threading

class SnowflakeGenerator:
    """
    Distributed Unique ID Generator (Twitter Snowflake).
    Format:
    [1 bit unused] [41 bits timestamp] [10 bits machine_id] [12 bits sequence]
    """
    def __init__(self, machine_id=1):
        self.machine_id = machine_id
        self.epoch = 1672531200000  # Custom Epoch (Jan 1, 2023)
        self.sequence = 0
        self.last_timestamp = -1
        
        # Bit configurations
        self.timestamp_bits = 41
        self.machine_id_bits = 10
        self.sequence_bits = 12
        
        # Shifts
        self.timestamp_shift = self.machine_id_bits + self.sequence_bits
        self.machine_id_shift = self.sequence_bits
        
        self.lock = threading.Lock()

    def _current_timestamp(self):
        return int(time.time() * 1000)

    def next_id(self):
        with self.lock:
            timestamp = self._current_timestamp()

            if timestamp < self.last_timestamp:
                raise Exception("Clock moved backwards. Refusing to generate id")

            if timestamp == self.last_timestamp:
                self.sequence = (self.sequence + 1) & 4095
                if self.sequence == 0:
                    # Sequence overflow, wait for next millisecond
                    while timestamp <= self.last_timestamp:
                        timestamp = self._current_timestamp()
            else:
                self.sequence = 0

            self.last_timestamp = timestamp

            id = ((timestamp - self.epoch) << self.timestamp_shift) | \
                 (self.machine_id << self.machine_id_shift) | \
                 self.sequence
            
            return id

# Global instance
snowflake = SnowflakeGenerator(machine_id=1)

def generate_id():
    return snowflake.next_id()

</file>

<file path="backend\utils\validators.py">
"""
validators.py
-------------
Input validation utilities for the application.
"""

import re
from datetime import datetime
from typing import Any, Dict, List, Optional, Tuple, Union
from email_validator import validate_email, EmailNotValidError

from backend.config.config import Config

class ValidationError(Exception):
    """Custom exception for validation errors."""
    def __init__(self, message: str, field: str = None):
        self.message = message
        self.field = field
        super().__init__(self.message)

def validate_string(value: Any, field_name: str, min_length: int = 1, max_length: int = 255) -> str:
    """
    Validate a string value.
    
    Args:
        value: The value to validate
        field_name: Name of the field for error messages
        min_length: Minimum allowed length
        max_length: Maximum allowed length
        
    Returns:
        The validated string
        
    Raises:
        ValidationError: If validation fails
    """
    if not isinstance(value, str):
        raise ValidationError(f"{field_name} must be a string", field_name)
    
    value = value.strip()
    length = len(value)
    
    if length < min_length:
        raise ValidationError(
            f"{field_name} must be at least {min_length} characters long", 
            field_name
        )
    
    if length > max_length:
        raise ValidationError(
            f"{field_name} must not exceed {max_length} characters", 
            field_name
        )
    
    return value

def validate_email_address(email: str) -> str:
    """
    Validate an email address.
    
    Args:
        email: Email address to validate
        
    Returns:
        Normalized email address
        
    Raises:
        ValidationError: If email is invalid
    """
    try:
        # Validate and normalize the email
        valid = validate_email(email)
        return valid.email
    except EmailNotValidError as e:
        raise ValidationError("Invalid email address", "email") from e

def validate_password(password: str) -> str:
    """
    Validate password strength.
    
    Args:
        password: Password to validate
        
    Returns:
        The validated password
        
    Raises:
        ValidationError: If password doesn't meet requirements
    """
    if not password:
        raise ValidationError("Password is required", "password")
    
    # Custom strength checks: length, upper, lower, digit, special
    rules = {
        "length": len(password) >= 8,
        "upper": re.search(r"[A-Z]", password) is not None,
        "lower": re.search(r"[a-z]", password) is not None,
        "digit": re.search(r"\d", password) is not None,
        "special": re.search(r"[^A-Za-z0-9]", password) is not None,
    }

    if not all(rules.values()):
        missing = [name for name, ok in rules.items() if not ok]
        raise ValidationError(
            "Weak password: must be at least 8 chars and include upper, lower, digit, and special character",
            "password",
        )
    
    return password

def validate_date(date_str: str, date_format: str = "%Y-%m-%d") -> str:
    """
    Validate a date string.
    
    Args:
        date_str: Date string to validate
        date_format: Expected date format
        
    Returns:
        The validated date string
        
    Raises:
        ValidationError: If date is invalid or in wrong format
    """
    try:
        datetime.strptime(date_str, date_format)
        return date_str
    except ValueError as e:
        raise ValidationError(f"Invalid date format. Expected {date_format}", "date") from e

def validate_integer(value: Any, field_name: str, min_val: int = None, max_val: int = None) -> int:
    """
    Validate an integer value.
    
    Args:
        value: Value to validate
        field_name: Name of the field for error messages
        min_val: Minimum allowed value (inclusive)
        max_val: Maximum allowed value (inclusive)
        
    Returns:
        The validated integer
        
    Raises:
        ValidationError: If validation fails
    """
    try:
        num = int(value)
    except (ValueError, TypeError) as e:
        raise ValidationError(f"{field_name} must be an integer", field_name) from e
    
    if min_val is not None and num < min_val:
        raise ValidationError(
            f"{field_name} must be at least {min_val}", 
            field_name
        )
    
    if max_val is not None and num > max_val:
        raise ValidationError(
            f"{field_name} must not exceed {max_val}", 
            field_name
        )
    
    return num

def validate_choice(value: Any, field_name: str, choices: list) -> Any:
    """
    Validate that a value is one of the allowed choices.
    
    Args:
        value: Value to validate
        field_name: Name of the field for error messages
        choices: List of allowed values
        
    Returns:
        The validated value
        
    Raises:
        ValidationError: If value is not in choices
    """
    if value not in choices:
        raise ValidationError(
            f"{field_name} must be one of: {', '.join(map(str, choices))}",
            field_name
        )
    return value

</file>

<file path="database\DBMS_library_db.sql">
-- ======================================================
-- DATABASE SETUP
-- ======================================================
-- This script initializes the Library Management System
-- database, users, tables, constraints, and indexes.
--
-- SAFE TO RUN MULTIPLE TIMES:
-- - Uses IF NOT EXISTS
-- - Drops users before recreation
-- ======================================================

-- ------------------------------------------------------
-- Create main application database if it does not exist (disabled for cloud compliance)
-- ------------------------------------------------------
-- CREATE DATABASE IF NOT EXISTS library_db;

-- Switch context to library_db (handeled by connection string in cloud)
-- USE library_db;


-- ======================================================
-- USERS (MYSQL DATABASE-LEVEL USERS)
-- ======================================================
-- These are NOT application users.
-- These are MySQL accounts used by the app and reports.
-- ======================================================

-- ------------------------------------------------------
-- Cleanup old database users to avoid conflicts
-- ------------------------------------------------------
DROP USER IF EXISTS 'app_user'@'localhost';
DROP USER IF EXISTS 'app_user'@'%';
DROP USER IF EXISTS 'report_user'@'localhost';


-- ======================================================
-- APP USER (CRUD ACCESS)
-- ======================================================
-- This user is used by:
-- - Flask backend
-- - CLI application
--
-- Permissions:
-- - Full CRUD on library_db
-- - NO admin privileges
-- ======================================================

CREATE USER 'app_user'@'localhost'
IDENTIFIED WITH mysql_native_password
BY 'App@123';

-- Grant CRUD permissions on entire database
GRANT SELECT, INSERT, UPDATE, DELETE
ON library_db.*
TO 'app_user'@'localhost';


-- ======================================================
-- REPORT USER (READ-ONLY ACCESS)
-- ======================================================
-- This user is used for:
-- - Analytics
-- - Reports
-- - Data exports
--
-- Security principle:
-- - Least privilege
-- ======================================================

CREATE USER 'report_user'@'localhost'
IDENTIFIED WITH mysql_native_password
BY 'Report@123';

-- Grant read-only access
GRANT SELECT
ON library_db.*
TO 'report_user'@'localhost';

-- Apply privilege changes immediately
FLUSH PRIVILEGES;


-- ======================================================
-- TABLE DEFINITIONS
-- ======================================================
-- Defines core entities of the system:
-- - users
-- - books
-- - issues
-- ======================================================


-- ------------------------------------------------------
-- USERS TABLE
-- ------------------------------------------------------
-- Stores application users (admin / member)
-- Password is stored as HASH (bcrypt from app)
-- ------------------------------------------------------

CREATE TABLE users (
    user_id INT AUTO_INCREMENT PRIMARY KEY,     -- Unique user identifier
    name VARCHAR(100) NOT NULL,                  -- User full name
    email VARCHAR(100) NOT NULL UNIQUE,          -- Login email (unique)
    password_hash VARCHAR(255) NOT NULL,              -- Hashed password
    role ENUM('admin', 'member') NOT NULL,       -- Authorization role
    must_change_password BOOLEAN DEFAULT TRUE,   -- Force password change
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP -- Account creation time
);


-- ------------------------------------------------------
-- BOOKS TABLE
-- ------------------------------------------------------
-- Stores book inventory and stock tracking
-- available_copies changes with issue/return
-- ------------------------------------------------------

CREATE TABLE books (
    book_id INT AUTO_INCREMENT PRIMARY KEY,      -- Unique book identifier
    title VARCHAR(200) NOT NULL,                  -- Book title
    author VARCHAR(100) NOT NULL,                 -- Author name
    category VARCHAR(50),                         -- Optional category
    total_copies INT NOT NULL CHECK (total_copies >= 0),       -- Total stock
    available_copies INT NOT NULL CHECK (available_copies >= 0), -- Available stock
    cover_image_url VARCHAR(255) DEFAULT NULL     -- Cover image URL
);


-- ------------------------------------------------------
-- ISSUES TABLE (HARDENED)
-- ------------------------------------------------------
-- Tracks book issue & return history
-- Enforces data integrity using constraints
-- ------------------------------------------------------

CREATE TABLE issues (
    issue_id INT AUTO_INCREMENT PRIMARY KEY,     -- Unique issue record
    user_id INT NOT NULL,                         -- User who issued the book
    book_id INT NOT NULL,                         -- Issued book
    issue_date DATE NOT NULL,                     -- Issue date
    return_date DATE DEFAULT NULL,                -- Return date (NULL = active)
    fine INT DEFAULT 0,                            -- Fine amount

    -- -----------------------------------------------
    -- FOREIGN KEY: issues ‚Üí users
    -- Cascade delete ensures cleanup on user removal
    -- -----------------------------------------------
    CONSTRAINT fk_issues_user
        FOREIGN KEY (user_id)
        REFERENCES users(user_id)
        ON DELETE CASCADE,

    -- -----------------------------------------------
    -- FOREIGN KEY: issues ‚Üí books
    -- Cascade delete ensures cleanup on book removal
    -- -----------------------------------------------
    CONSTRAINT fk_issues_book
        FOREIGN KEY (book_id)
        REFERENCES books(book_id)
        ON DELETE CASCADE,

    -- -----------------------------------------------
    -- UNIQUE CONSTRAINT
    -- Prevents multiple ACTIVE issues for same book
    -- return_date NULL means active issue
    -- -----------------------------------------------
    CONSTRAINT uq_user_book_active
        UNIQUE (user_id, book_id, return_date)
);


-- ------------------------------------------------------
-- BOOK REQUESTS TABLE
-- ------------------------------------------------------
-- Tracks books requested by members
-- ------------------------------------------------------

CREATE TABLE IF NOT EXISTS book_requests (
    request_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    book_id INT NOT NULL,
    request_date DATE NOT NULL,
    status ENUM('Pending', 'Approved', 'Rejected') DEFAULT 'Pending',

    -- Foreign Keys
    CONSTRAINT fk_requests_user
        FOREIGN KEY (user_id)
        REFERENCES users(user_id)
        ON DELETE CASCADE,

    CONSTRAINT fk_requests_book
        FOREIGN KEY (book_id)
        REFERENCES books(book_id)
        ON DELETE CASCADE
);

-- ------------------------------------------------------
-- BOOK SUGGESTIONS TABLE (for member suggestions)
-- ------------------------------------------------------
-- Tracks suggested books from members for admin review
-- ------------------------------------------------------

CREATE TABLE IF NOT EXISTS book_suggestions (
    suggestion_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    title VARCHAR(200) NOT NULL,
    author VARCHAR(100) NOT NULL,
    isbn VARCHAR(20),
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('pending','approved','rejected') DEFAULT 'pending',

    CONSTRAINT fk_suggestions_user
        FOREIGN KEY (user_id)
        REFERENCES users(user_id)
        ON DELETE CASCADE
);


-- ======================================================
-- INDEXES (PERFORMANCE OPTIMIZATION)
-- ======================================================
-- Indexes improve query performance for:
-- - Dashboards
-- - Issue checks
-- - Analytics
-- ======================================================

-- Speed up member dashboard issue lookup
CREATE INDEX idx_issues_user
ON issues(user_id);

-- Speed up book-based queries
CREATE INDEX idx_issues_book
ON issues(book_id);

-- Speed up active issue checks (critical path)
CREATE INDEX idx_issues_user_book_active
ON issues(user_id, book_id, return_date);


-- ======================================================
-- VERIFY STRUCTURE
-- ======================================================
-- Sanity checks to verify schema correctness
-- ======================================================

SHOW TABLES;
DESCRIBE users;
DESCRIBE books;
DESCRIBE issues;
SHOW INDEX FROM issues;


-- ======================================================
-- FINAL PRIVILEGE FLUSH
-- ======================================================
-- Ensures all permission changes are active
-- ======================================================
FLUSH PRIVILEGES;

</file>

<file path="database\init_db.py">
import sys
import os

# Add project root to Python path
project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, project_root)

from backend.config.db import get_connection

def run_schema():
    """
    Reads the SQL schema file and executes it to create tables.
    """
    # Use absolute project root for reliability
    script_dir = os.path.dirname(os.path.abspath(__file__))
    project_root_local = os.path.dirname(script_dir)
    schema_path = os.path.join(project_root_local, "database", "DBMS_library_db.sql")
    
    if not os.path.exists(schema_path):
        return f"‚ùå Schema file not found at {schema_path}", False

    output = ["üöÄ Initializing database schema..."]
    
    try:
        conn = get_connection()
        # Use buffered cursor so results are fetched and we can safely run subsequent statements
        cursor = conn.cursor(buffered=True)
        
        with open(schema_path, 'r', encoding='utf-8') as f:
            raw_sql = f.read()
            # Split, filter admin/verification statements, and re-join for multi execution
            parts = [p.strip() for p in raw_sql.split(';')]
            safe_cmds = []
            for cmd in parts:
                if not cmd:
                    continue
                up = cmd.upper()
                if any(k in up for k in (
                    'CREATE USER', 'DROP USER', 'GRANT ', 'FLUSH PRIVILEGES', 'SHOW TABLES', 'DESCRIBE '
                )):
                    continue
                safe_cmds.append(cmd)

            # Execute each statement individually
            for cmd in safe_cmds:
                cmd = cmd.strip()
                if not cmd:
                    continue
                try:
                    cursor.execute(cmd)
                    # Try to fetch results if any
                    try:
                        while cursor.nextset():
                            pass
                    except Exception:
                        pass
                except Exception as e:
                    # Capture and continue; schema runs should be best-effort
                    first_line = cmd.split('\n', 1)[0][:120]
                    output.append(f"‚ö†Ô∏è Warning: {e} | SQL: {first_line}")
        
        conn.commit()
        cursor.close()
        conn.close()
        output.append("‚úÖ Database tables created successfully!")
        return "\n".join(output), True
        
    except Exception as e:
        return f"‚ùå Error: {e}", False

if __name__ == "__main__":
    msg, success = run_schema()
    print(msg)

</file>

<file path="database\seed_data.py">
"""
seed_data.py
------------
Seeds initial data into the database using
application services (professional approach).

Run:
    python database/seed_data.py
"""

import sys
import os

# Add project root to Python path
project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, project_root)

# ------------------------------------------------------
# IMPORT APPLICATION SERVICES
# ------------------------------------------------------
from backend.services.user_service import add_user
from backend.services.book_service import add_book
from backend.repository.db_access import fetch_one
from backend.config.db import get_connection

# ======================================================
# CLEAR EXISTING BOOKS
# ======================================================

def clear_books():
    """
    Deletes all existing book records from the database.
    """
    print("\nüóëÔ∏è  Clearing existing books...")
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("DELETE FROM books")
        conn.commit()
        cursor.close()
        conn.close()
        print("‚úÖ All existing books deleted")
    except Exception as e:
        print(f"‚ùå Error clearing books: {e}")


# ======================================================
# USER SEEDING
# ======================================================

def seed_users():
    """
    Inserts admin and member users.
    - Uses add_user() service
    - Automatically hashes passwords
    - Enforces uniqueness on email
    """
    users = [
        ("Admin User", "admin@library.com", "admin", "Admin@123"),
        ("Rahul Verma", "rahul@gmail.com", "member", "Admin@123"),
        ("Aisha Khan", "aisha@gmail.com", "member", "Admin@123"),
        ("Neha Sharma", "neha@gmail.com", "member", "Admin@123"),
    ]

    for name, email, role, password in users:
        result = add_user(name, email, role, password)
        print(result)


# ======================================================
# BOOK SEEDING - 30 DIVERSE BOOKS
# ======================================================

def seed_books():
    """
    Inserts 30 diverse books across multiple categories.
    Format: (title, author, category, total_copies)
    """
    books = [
        # Programming & Technology (8 books)
        ("Clean Code", "Robert C. Martin", "Programming", 10),
        ("The Pragmatic Programmer", "Andrew Hunt", "Programming", 8),
        ("Python Crash Course", "Eric Matthes", "Programming", 12),
        ("JavaScript: The Good Parts", "Douglas Crockford", "Programming", 7),
        ("Design Patterns", "Gang of Four", "Programming", 6),
        ("Head First Java", "Kathy Sierra", "Programming", 9),
        ("You Don't Know JS", "Kyle Simpson", "Programming", 8),
        ("Eloquent JavaScript", "Marijn Haverbeke", "Programming", 10),
        
        # Fiction (7 books)
        ("The Alchemist", "Paulo Coelho", "Fiction", 15),
        ("1984", "George Orwell", "Fiction", 12),
        ("To Kill a Mockingbird", "Harper Lee", "Fiction", 10),
        ("The Great Gatsby", "F. Scott Fitzgerald", "Fiction", 8),
        ("Pride and Prejudice", "Jane Austen", "Fiction", 9),
        ("The Catcher in the Rye", "J.D. Salinger", "Fiction", 7),
        ("Harry Potter and the Sorcerer's Stone", "J.K. Rowling", "Fiction", 20),
        
        # Non-Fiction & Self-Help (8 books)
        ("Atomic Habits", "James Clear", "Self Help", 18),
        ("Sapiens", "Yuval Noah Harari", "History", 14),
        ("Educated", "Tara Westover", "Biography", 10),
        ("Thinking, Fast and Slow", "Daniel Kahneman", "Psychology", 9),
        ("The 7 Habits of Highly Effective People", "Stephen Covey", "Self Help", 12),
        ("How to Win Friends and Influence People", "Dale Carnegie", "Self Help", 11),
        ("Man's Search for Meaning", "Viktor Frankl", "Philosophy", 8),
        ("The Power of Now", "Eckhart Tolle", "Spirituality", 10),
        
        # Science & History (7 books)
        ("A Brief History of Time", "Stephen Hawking", "Science", 8),
        ("Cosmos", "Carl Sagan", "Science", 9),
        ("The Immortal Life of Henrietta Lacks", "Rebecca Skloot", "Science", 7),
        ("Guns, Germs, and Steel", "Jared Diamond", "History", 6),
        ("The Wright Brothers", "David McCullough", "History", 8),
        ("Steve Jobs", "Walter Isaacson", "Biography", 12),
        ("Becoming", "Michelle Obama", "Biography", 15),
    ]

    for title, author, category, copies in books:
        result = add_book(title, author, category, copies)
        print(result)


# ======================================================
# VERIFICATION STEP
# ======================================================

def verify_seed():
    """
    Verifies that seeding completed successfully.
    """
    admin = fetch_one("SELECT email FROM users WHERE role = 'admin'")
    book_count = fetch_one("SELECT COUNT(*) as count FROM books")
    
    if admin and book_count:
        print(f"‚úÖ Seed verification successful")
        print(f"üìö Total books in database: {book_count['count']}")
    else:
        print("‚ùå Seed verification failed")


# ======================================================
# MAIN ENTRY POINT
# ======================================================

def main():
    """
    Main entry point for seeding.
    
    Execution order:
    1. Clear existing books
    2. Seed users
    3. Seed 30 new books
    4. Verify seed
    """
    print("\n" + "="*50)
    print("üå± DATABASE SEEDING STARTED")
    print("="*50)
    
    clear_books()
    
    print("\nüå± Seeding users...")
    seed_users()

    print("\nüìö Seeding 30 books...")
    seed_books()

    print("\nüîç Verifying seed...")
    verify_seed()

    print("\n" + "="*50)
    print("‚úÖ DATABASE SEEDING COMPLETED")
    print("="*50 + "\n")


if __name__ == "__main__":
    main()

</file>

<file path="docs\01_LDBMS_Architectural_Analysis.md">
# Comprehensive Architectural Analysis of the LDBMS Enterprise Ecosystem

## 1. Architectural Philosophy and Design Paradigms

The Library Database Management System (LDBMS) represents a sophisticated implementation of the **Service-Oriented Monolith** architectural pattern. This design choice is not merely a transitional state between a simple application and a distributed system but a deliberate strategic framework intended to maximize cohesion, maintainability, and performance within a single deployment unit. Unlike the "Big Ball of Mud" anti-pattern frequently observed in rapid application development‚Äîwhere business logic, data access, and presentation code are inextricably intertwined‚Äîthe LDBMS enforces a rigid separation of concerns that mimics the isolation benefits of microservices without the operational overhead of distributed networking.

### 1.1 The Service-Repository Pattern: A Monolithic Adaptation of Clean Architecture

At the core of the LDBMS is the **Service-Repository Pattern**, a structural methodology that acts as a localized implementation of Hexagonal Architecture (Ports and Adapters). In this paradigm, the application is stratified into three distinct, concentric layers, each with immutable responsibilities and strict interaction rules. This layered approach ensures that dependencies flow inwards, protecting the core business logic from the volatility of external interfaces like HTTP requests or database drivers.

#### 1.1.1 The Presentation Layer: Protocol Translation and Interface
The outermost layer, the Presentation Layer, is constituted by the **Flask Routes** (`backend/routes/`) and the **Jinja2 Templates** (`templates/`). Its primary function is **protocol translation**. It accepts external inputs‚Äîwhether they be HTTP POST requests from a browser or WebSocket events from a chat client‚Äîand converts them into internal data structures that the domain logic can process.

Crucially, this layer is **devoid of business intelligence**. A route handler in `auth_routes.py` does not know how to authenticate a user; it only knows how to extract credentials from a form and invoke the appropriate service. Similarly, a template does not query the database to list books; it merely renders the list provided to it by the route. This separation allows the interface to change independently of the core logic. For instance, the system includes a `mainCLI.py` module that provides a Command Line Interface. Because the business logic is decoupled from the web routes, the CLI can import and reuse the exact same Service Layer functions (`authenticate_user`, `issue_book`) as the web application, proving the architectural purity of the design.

#### 1.1.2 The Service Layer: The Domain Brain
The Service Layer (`backend/services/`) encapsulates the application's domain model and business rules. It serves as the **transaction boundary** for the system. Every operation that mutates the state of the system‚Äîissuing a book, generating a chat ID, or calculating a fine‚Äîmust originate here.

This layer is responsible for **Orchestration and Validation**. When a user attempts to borrow a book, the `IssueService` does not merely insert a record. It orchestrates a complex sequence of checks: validating the user's membership tier, calculating current loan counts against tier limits, verifying inventory stock levels, and checking for outstanding fines. Only when all logical gates are cleared does it instruct the persistence layer to act. This centralization of logic prevents the duplication of rules across different controllers and ensures that constraints are enforced uniformly, regardless of whether the request comes from the Web UI, the Admin CLI, or an API call.

#### 1.1.3 The Repository Layer: The Persistence Abstraction
The Repository Layer (`backend/repository/`) functions as the "Vault," providing an abstraction over the raw data storage. In the LDBMS, this is implemented via `db_access.py`, which manages raw SQL execution. Unlike heavy Object-Relational Mappers (ORMs) like SQLAlchemy (which is included in `requirements.txt` likely for migration or specific utility but bypassed for core operations in favor of raw SQL for performance), this layer provides fine-grained control over the database interactions.

The Repository Layer operates under a strict **"No Logic" mandate**. Its role is purely mechanical: lease a connection from the pool, parameterize the query to prevent injection attacks, execute the SQL, and manage the transaction commit or rollback. By isolating SQL in this layer, the system achieves **Persistence Ignorance** in the Service Layer; the services work with Python dictionaries and primitive types, remaining largely unaware of the underlying MySQL schema mechanics.

### 1.2 Comparison with Distributed Microservices

While the LDBMS structures its internal modules (Auth, Chat, Core) similarly to microservices, it avoids the fallacies of distributed computing by running them in a shared process space. In a true microservices architecture, a request to borrow a book might involve a synchronous HTTP call from the Order Service to the User Service, introducing network latency, serialization overhead, and failure modes like timeouts.

In the LDBMS Service-Oriented Monolith, these boundaries are **logical, not physical**. The `IssueService` calls the `UserService` via an in-memory function call, which executes in nanoseconds rather than milliseconds. This architecture provides the organizational scalability of microservices‚Äîallowing different teams to work on different service modules‚Äîwhile retaining the performance and transactional integrity of a monolith. It allows for ACID (Atomicity, Consistency, Isolation, Durability) transactions across domains (e.g., updating user XP and book inventory in one commit), which is notoriously difficult to achieve in distributed systems.

## 2. Technology Stack and Tooling Inventory

The LDBMS leverages a carefully curated stack of technologies, selected to balance the ease of Python development with the performance requirements of an enterprise-grade system. The explicit version pinning in `requirements.txt` indicates a focus on stability and reproducibility.

### 2.1 Core Framework and Runtime
*   **Flask 2.3.3**: The core web framework. Flask's lightweight, unopinionated nature makes it the ideal chassis for a custom architectural implementation. Unlike Django, which enforces a specific MVC pattern, Flask allows the LDBMS to construct its unique Service-Repository hierarchy.
*   **Werkzeug 2.3.7**: Provides the underlying WSGI utility library, handling request/response objects and low-level HTTP protocols.
*   **Python 3.10+**: The runtime environment, leveraging modern features like type hinting (evident in the codebase's use of `mypy` for static analysis) and structural pattern matching.

### 2.2 Real-Time and Concurrency Infrastructure
*   **Flask-SocketIO 5.3.6**: This library acts as the real-time backbone, wrapping the Flask application to support the WebSocket protocol. It enables bi-directional communication essential for the Chat and Notification features.
*   **Gevent / Eventlet**: While not explicitly pinned in the snippet, `flask-socketio` requires an asynchronous worker to handle concurrent WebSocket connections. The architecture likely utilizes Eventlet or Gevent to "monkey patch" the standard Python I/O library, allowing the synchronous Flask code to run non-blocking operations. This is critical for scaling; without it, a Python thread would be blocked for the duration of every WebSocket connection, quickly exhausting server resources.

### 2.3 Data Persistence and Management
*   **MySQL Connector Python (9.0.0+)**: The primary driver for database connectivity. The usage of version 9.x suggests a commitment to the latest MySQL protocol features and security standards.
*   **SQLAlchemy 2.0.21 & Alembic 1.12.1**: Although the `DEEP_DIVE_MANUAL.md` emphasizes raw SQL in `db_access.py`, the presence of these libraries in `requirements.txt` suggests they are used for **Schema Migration Management**. Alembic allows the team to version control the database schema, applying incremental changes (migrations) programmatically rather than running manual SQL scripts, which is a DevOps best practice.
*   **PyMySQL / MySQLClient**: Implicitly utilized dependencies for database interfacing.

### 2.4 Security and Cryptography
*   **Bcrypt 4.0.1**: Used for password hashing. Bcrypt is computationally expensive by design, incorporating a "work factor" (salt rounds) that makes brute-force attacks and rainbow table lookups infeasible.
*   **PyJWT 2.8.0**: Indicates the use of JSON Web Tokens, likely for API authentication or stateless session management in the mobile/CLI context.
*   **ItsDangerous 2.1.2**: Provides cryptographic signing helpers, used by Flask to secure session cookies against tampering.

### 2.5 Intelligence and Data Processing
*   **Pandas 2.2.0 & NumPy 2.0.0**: Used in the Analytics Service (`analytics_service.py`) for heavy data manipulation. The system likely loads table data into DataFrames to perform complex aggregations, pivot tables, and time-series analysis for the Admin Dashboard reports.
*   **ChromaDB 0.4.15**: A vector database used in the AI "Brain" module. It stores high-dimensional embeddings of book descriptions, enabling semantic search (RAG).
*   **Sentence-Transformers 2.2.2**: Used to generate the embeddings for ChromaDB. This allows the system to understand that a query for "sad books" relates to "melancholy fiction" mathematically.
*   **HuggingFace Hub 0.17.3**: Provides access to pre-trained models for the local AI pipeline.

### 2.6 Utilities and Operations
*   **APScheduler (Implicit)**: References to `scheduler.py` and background tasks confirm the use of Advanced Python Scheduler for cron-job management (e.g., daily fine calculations).
*   **PyNgrok 7.1.6**: Used in `run.py` to programmatically create secure tunnels from localhost to the public internet. This facilitates remote demos and webhook testing during development.
*   **PSUtil 7.2.2**: Used for system health monitoring, allowing the Admin Dashboard to display server CPU and RAM usage in real-time.

| Category | Tool/Library | Version | Purpose |
| :--- | :--- | :--- | :--- |
| **Framework** | Flask | 2.3.3 | Core Web Application Framework |
| **Real-Time** | Flask-SocketIO | 5.3.6 | WebSocket & Event Handling |
| **Database** | MySQL Connector | 9.0.0+ | Raw SQL Execution Driver |
| **ORM/Migration** | SQLAlchemy/Alembic | 2.0/1.12 | Schema Version Control |
| **Security** | Bcrypt | 4.0.1 | Password Hashing |
| **AI/ML** | ChromaDB | 0.4.15 | Vector Storage for RAG |
| **AI/ML** | Sentence-Transformers | 2.2.2 | Text Embeddings |
| **Data** | Pandas | 2.2.0 | Analytics & Reporting |
| **Ops** | PyNgrok | 7.1.6 | Public Tunneling |

## 3. System Bootstrapping and Execution Lifecycle

The operational life of the LDBMS begins with a sophisticated bootstrapping sequence designed to initialize the layered architecture, establish resource pools, and prepare the asynchronous event loop.

### 3.1 The run.py Entry Point
The execution starts in `run.py`, which serves as the orchestrator for the application startup.
*   **Environment Sanitization**: The script includes a specific routine `cleanup_before_start()` that aggressively cleans up the runtime environment. It executes system commands (`taskkill` on Windows) to terminate any lingering ngrok processes or zombie Python processes occupying port 5000. This self-healing step ensures a clean bind to the socket, preventing "Address already in use" errors common in development cycles.
*   **Factory Invocation**: It calls `create_app()` from `backend/app.py`. This implementation of the **Application Factory Pattern** allows for the creation of multiple app instances with different configurations (e.g., Testing, Production) from the same codebase.
*   **Tunneling**: In development mode, `run.py` initializes PyNgrok to open a public tunnel to `localhost:5000`. This URL is printed to the console, enabling immediate remote access.
*   **Server Launch**: Finally, `socketio.run(app)` takes over the main thread. This effectively wraps the Flask WSGI application in an evented WSGI server (like Gevent), upgrading it to support long-lived WebSocket connections alongside standard HTTP requests.

### 3.2 The Application Factory (backend/app.py)
The `create_app` function is the nexus of configuration:
*   **Configuration Loading**: It loads environment variables (`.env`) using `python-dotenv` to set sensitive keys like `FLASK_SECRET_KEY` and `DB_PASSWORD`.
*   **Resource Initialization**:
    *   **DB Pool**: It triggers `backend/config/db.py` to create the `MySQLConnectionPool`. This pool establishes 5-10 persistent connections immediately. This "warm-up" strategy shifts the latency cost of connection establishment to the startup phase, rather than imposing it on the first user request.
    *   **Scheduler**: It initializes the `BackgroundScheduler` on a daemon thread. This scheduler registers jobs (e.g., `send_overdue_reminders`) to run at specific cron intervals (e.g., daily at 10:00 AM).
*   **Blueprint Registration**: The factory imports and registers the various Blueprints (`auth_bp`, `admin_bp`, `chat_bp`), effectively routing the URL namespace to the appropriate modules.
*   **Context Processors**: A critical UX component is initialized here. The `inject_global_data` processor is registered to run before every template render. It queries the `NotificationService` and `SettingsService` to inject `unread_notifications` and system config into the Jinja2 context. This ensures that the notification bell and global site branding are present on every page without requiring every route to manually query this data.

### 3.3 Request Lifecycle: Synchronous HTTP (Borrowing a Book)
When a user clicks "Issue Book," a synchronous request flows through the stack:
1.  **Routing**: The `routes/issue_routes.py` receives the POST request. The `@login_required` decorator intercepts it, validating the session.
2.  **Service Invocation**: The route delegates to `IssueService.request_book(user_id, book_id)`.
3.  **Business Logic (The Brain)**:
    *   **Rule Check**: The service queries the repository to count the user's active issues. If `count >= 3` (or tier limit), it raises a `LimitReached` exception.
    *   **Inventory Check**: It verifies `available_copies > 0`.
    *   **Conflict Check**: It enforces the rule that a user cannot borrow the same book twice simultaneously.
4.  **Persistence (The Vault)**: If checks pass, `db_access.py` is called. It borrows a connection from the pool, executes `INSERT INTO book_requests`, commits the transaction, and returns the connection.
5.  **Response**: The success is propagated up, and the route returns a JSON success message.

### 3.4 Request Lifecycle: Asynchronous WebSocket (Chat Message)
The chat flow demonstrates the real-time capabilities:
1.  **Event Ingestion**: `socket_service.py` receives a `send_message` event.
2.  **Pipeline Processing**: The payload is passed to `IngestionService`.
3.  **Rate Limiting**: `backend/utils/rate_limiter.py` checks the user's message frequency against an in-memory token bucket.
4.  **Sanitization**: Content is validated.
5.  **Persistence**: `ChannelService` persists the message via the Repository.
6.  **Broadcast**: `socketio.emit` pushes the message to the specific room corresponding to the `channel_id`. This targeted broadcast ensures privacy and efficiency.

## 4. Deep Dive: Data Persistence and Repository Architecture

The LDBMS adopts a "Database-First" design mentality, utilizing a highly normalized schema and explicit transaction management to ensure data integrity.

### 4.1 Schema Design and Normalization
The database structure (inferred from setup scripts and usage) adheres to **Third Normal Form (3NF)**:
*   **Identity Separation**: User credentials (`users` table) are separated from profile data and gamification stats (`user_profile_stats`), preventing table bloat.
*   **Transactional Integrity**: The `issues` table acts as a ledger. The constraint `uq_user_book_active` (Unique on `user_id`, `book_id`, `return_date`) physically prevents the logical error of a user borrowing a book they already have. The database engine enforces this, acting as the final line of defense against race conditions.
*   **Cascading Actions**: Foreign keys use `ON DELETE CASCADE`. If a user is deleted, the database engine automatically removes their issue history, chat messages, and requests. This prevents "orphan data"‚Äîfragments of data that point to non-existent parents‚Äîwhich creates reporting errors and storage waste.

### 4.2 MySQL Connection Pooling Implementation
The implementation in `backend/config/db.py` is critical for high-concurrency performance.
*   **The Problem**: Opening a MySQL connection involves a TCP handshake, authentication, and session setup, taking ~100ms. In a naive implementation, 100 concurrent users would incur 10 seconds of cumulative latency just for connection overhead.
*   **The Solution**: The `MySQLConnectionPool` maintains 5-10 "warm" connections.
*   **Lifecycle**:
    *   **Borrow**: `pool.get_connection()` hands over an existing connection handle (0ms latency).
    *   **Execute**: The query runs.
    *   **Return**: `conn.close()` is overridden to return the connection to the pool rather than terminating the TCP link.
*   **Safety Valve**: If traffic exceeds the pool size, requests queue up. This acts as a throttle, preventing the database from being overwhelmed by a "thundering herd" of requests, trading a small amount of latency for system stability.

### 4.3 Raw SQL vs. ORM
The choice to use raw SQL in `db_access.py` (despite having SQLAlchemy installed) suggests a performance-critical mindset. While ORMs provide developer convenience, they often generate suboptimal queries (the "N+1 select problem"). By writing explicit SQL, the LDBMS developers ensure that queries are optimized for the specific MySQL index structures, such as the `idx_issues_user_book_active` index mentioned in optimization contexts.

## 5. The Intelligence Engine: AI, RAG, and Heuristics

The LDBMS features a hybrid "Intelligence Engine" that bridges deterministic logic with probabilistic AI recommendations.

### 5.1 The MoodMap Heuristic Engine
Located in `backend/services/ai_service.py`, the MoodMap algorithm is a specialized recommendation system.
*   **Mechanism**: It uses a Knowledge Graph approach rather than simple keyword matching.
*   **Tokenization**: It parses user input (e.g., "I feel lonely") into emotional tokens.
*   **Mapping**: It traverses a graph where `lonely` edges connect to nodes like `Biography` or `Introspective Fiction`.
*   **Query Generation**: It dynamically constructs a SQL query: `SELECT * FROM books WHERE category IN ('Biography', 'Fiction') ORDER BY RAND()`.
*   **Significance**: This allows the system to provide "Vibe-based" discovery without requiring expensive calls to external LLM APIs for every interaction, ensuring responsiveness and privacy.

### 5.2 RAG (Retrieval-Augmented Generation) Pipeline
The project structure reveals a RAG implementation in `backend/brain/rag.py`.
*   **Vector Store**: The `chromadb` library is used to manage a local vector database. Book descriptions and library rules are embedded using `sentence-transformers` and stored in `backend/brain/data/`.
*   **Orchestration**: The `orchestrator.py` module likely manages the flow. When a complex query arrives ("What books deal with post-colonialism?"), it embeds the query, retrieves semantically similar records from ChromaDB, and augments the prompt before sending it to an LLM.
*   **Local vs. Cloud**: The presence of HuggingFace Hub suggests the system can use local models (like a quantized Llama) or cloud APIs, providing flexibility based on deployment resources.

## 6. Real-Time Communication and Gamification

The transition from a static database to a social platform is enabled by the Chat and Gamification subsystems.

### 6.1 Flask-SocketIO Architecture
The system uses the Socket.IO protocol, which provides a layer over WebSockets with fallback to HTTP Long-Polling.
*   **Concurrency Model**: To handle thousands of concurrent connections, the system uses Gevent or Eventlet. These libraries provide "green threads"‚Äîlightweight coroutines that allow the single-threaded Python process to handle I/O-bound tasks (like waiting for a chat message) without blocking.
*   **Namespace Isolation**: Chat traffic is isolated in the `/chat` namespace, separating it from system notifications. Within this, distinct "Rooms" (`channel_id`) ensure that messages are broadcast only to relevant participants.

### 6.2 Gamification Logic
The `gamification_service.py` implements a behavioral reinforcement loop.
*   **Event Triggers**: Actions in other services (e.g., `IssueService` completing a return) trigger events.
*   **XP Calculation**: Logic defines that a "Return" action yields +50 XP. This is calculated and the `user_profile_stats` table is updated.
*   **Leveling System**: The service checks if the new XP total crosses a tier threshold. If so, it updates the user's level.
*   **Real-Time Feedback**: Using the SocketIO integration, the system immediately pushes a "Level Up" notification to the client UI, closing the feedback loop instantly.

## 7. Frontend Architecture and UX

The frontend is not merely a display layer but an active participant in the application's logic through advanced templating and design systems.

### 7.1 Jinja2 "Skeleton" Architecture
The system uses a hierarchical templating strategy. `layout.html` serves as the Skeleton, containing the persistent sidebar, navigation, and script imports. Page-specific templates (`dashboard_member.html`) extend this skeleton, injecting only the unique content ("Flesh"). This ensures that global changes (like adding a new script) are propagated instantly across the entire application.

### 7.2 Glassmorphism Design System
The visual identity is constructed using **Glassmorphism**, implemented in `static/css/style.css`.
*   **Technique**: It utilizes the CSS `backdrop-filter: blur(12px)` property combined with semi-transparent RGBA backgrounds.
*   **Implementation**: This creates a sense of depth and hierarchy. Floating modals and cards blur the content beneath them, focusing user attention while maintaining context. This modern UI approach positions the LDBMS as a premium, user-centric product rather than a utilitarian administrative tool.

## 8. Security and Operations

Security is woven into the architectural fabric, not applied as a patch.

### 8.1 Authentication and Authorization
*   **Bcrypt Hashing**: Passwords are hashed with a salt using bcrypt before storage. This makes the database resistant to rainbow table attacks.
*   **Middleware Gatekeeping**: The `auth.py` middleware and `@login_required` decorators ensure that the "Golden Rule" of separation is followed for security too‚Äîcontrollers cannot execute business logic without passing the security gate first.
*   **Role-Based Access Control (RBAC)**: The User model includes a `role` field. Admin-only routes are protected by decorators that check this field, preventing privilege escalation.

### 8.2 Operational Tools
*   **Snowflake IDs**: The system uses `snowflake.py` to generate unique, time-sortable 64-bit integers for IDs. Unlike UUIDs, Snowflake IDs are roughly sequential, which significantly improves database indexing performance (B-Tree fragmentation) while still being unique across distributed systems.
*   **Task Scheduling**: The `scheduler.py` (APScheduler) ensures that the system is autonomous. It handles "housekeeping" like calculating fines or clearing expired sessions without human intervention.

## 9. Conclusion

The LDBMS codebase is a testament to the power of the **Service-Repository Monolith** pattern. By rejecting the premature complexity of microservices in favor of a strictly layered, modular monolith, the system achieves enterprise-grade features‚ÄîReal-Time Chat, AI Discovery, Gamification, and robust Security‚Äîwithin a manageable operational footprint. The use of advanced tooling like Connection Pooling, RAG pipelines, and Glassmorphism UI demonstrates a commitment to both backend performance and frontend user experience. This architecture provides a stable, scalable foundation that can evolve into a distributed system if required, but currently stands as a highly optimized, cohesive solution for library management.

</file>

<file path="docs\02_Deployment_Guide.md">
# üöÄ Deployment Guide: Render + GitHub

This guide walks you through deploying your Library Management System to **Render**.

## 1Ô∏è‚É£ Prepare your Code for GitHub

1.  **Initialize Git** (if not already done):
    Open your terminal in the `pythonProject` folder and run:
    ```bash
    git init
    ```
2.  **Add your files**:
    ```bash
    git add .
    ```
3.  **Commit your changes**:
    ```bash
    git commit -m "Prepare for deployment"
    ```

## 2Ô∏è‚É£ Create a GitHub Repository

1.  Go to [github.com/new](https://github.com/new).
2.  Name it `library-management-system`.
3.  Keep it **Public** (or Private if you have GitHub Pro).
4.  **Do NOT** initialize with README, .gitignore, or License.
5.  Follow the instructions on GitHub to **"push an existing repository from the command line"**:
    ```bash
    git remote add origin https://github.com/YOUR_USERNAME/library-management-system.git
    git branch -M main
    git push -u origin main
    ```

## 3Ô∏è‚É£ Set up an External MySQL Database (Recommended)

Render's built-in database is PostgreSQL. Your app uses MySQL.
The easiest way is to use **Aiven** (Free tier available):

1.  Go to [aiven.io](https://aiven.io/) and create a free MySQL service.
2.  Get your Connection URI or separate Host, Port, User, Password details.

## 4Ô∏è‚É£ Deploy to Render

1.  Go to [dashboard.render.com](https://dashboard.render.com/).
2.  Click **New +** > **Web Service**.
3.  Connect your GitHub repository.
4.  **Configuration**:
    - **Name**: `library-system`
    - **Runtime**: `Python 3`
    - **Build Command**: `pip install -r requirements.txt`
    - **Start Command**: `gunicorn run:app`
5.  **Add Environment Variables**:
    Click **Advanced** > **Add Environment Variable**:
    - `DB_HOST`: (From Aiven)
    - `DB_PORT`: `3306`
    - `DB_NAME`: `defaultdb`
    - `DB_USER`: `avnadmin`
    - `DB_PASSWORD`: (From Aiven)
    - `FLASK_SECRET_KEY`: (Something random like `super-secret-123`)

6.  Click **Create Web Service**.

## 5Ô∏è‚É£ Initialize Data (One-time)

Once the app is live, you need to run the seed script *once* to create your 30 books.
On Render, go to the **Shell** tab and run:
```bash
python database/seed_data.py
```

---

**‚úÖ Your app is now live at `https://library-system.onrender.com`!**

</file>

<file path="docs\03_Chat_System_Design.md">
# Library DBMS ‚Äì Chatroom System Design

## Purpose
A chat system inside the library where:
- Students discuss books.
- Librarians post announcements.
- Study groups chat privately.
- Users can stay anonymous.

## Core Features
1. **Anonymous Users**: Real identity hidden; mapped to generated `anon_id`.
2. **Room Types**: Public, Private (Invite-only), Study Group, Librarian Room (Announcement).
3. **Invitation System**: Expires after time/usage.
4. **Roles**: Admin, Moderator, Member, Librarian.
5. **Message Control**: Soft delete, Timestamped, Securely stored.

## Database Structure

### USERS (Existing)
* `user_id` (PK), `name`, `email`, `role`

### CHAT_ANON_ID
* `anon_id` (PK, VARCHAR)
* `user_id` (FK)
* `created_at`
* `is_active`

### CHAT_ROOMS
* `room_id` (PK)
* `room_name`
* `room_type` (public, private, study, librarian)
* `created_by` (FK -> user_id? or anon_id?) -> *Decision: Real user_id for accountability*
* `is_active`
* `created_at`

### ROOM_MEMBERS
* `room_id` (FK)
* `anon_id` (FK)
* `role` (admin, member, mod)
* `joined_at`
* `is_muted`

### ROOM_INVITES
* `invite_code` (PK)
* `room_id` (FK)
* `created_by`
* `expires_at`
* `max_uses`
* `uses_count`

### CHAT_MESSAGES
* `message_id` (PK)
* `room_id` (FK)
* `anon_id` (FK)
* `message_text`
* `sent_at`
* `is_deleted` (Soft delete)

## Chat Flow
1. **Join**: User login -> Generate/Fetch `anon_id` -> Chat UI.
2. **Create Room**: User creates room -> Becomes Admin.
3. **Invite**: Admin generates code -> User enters code -> Added to `ROOM_MEMBERS`.
4. **Message**: `anon_id` sends to `room_id` -> Broadcast.
5. **Moderation**: Admin sets `is_deleted=TRUE`.

## Security & Privacy
- **Access Control**: Room-based auth, Invite validation.
- **Privacy**: No real user IDs in public chat APIs.
- **Communication**: WebSocket (secure).

## Implementation Plan

### Phase 1: Database Migration
- Create new tables: `chat_anon_id`, `chat_rooms`, `room_members`, `room_invites`, `chat_messages`.
- Verify foreign keys.

### Phase 2: Backend Logic
- `chat_service.py`: Handle anonymity generation, room creation, inviting.
- `socket_service.py`: Update to support new schema and room types.

### Phase 3: Frontend UI
- Update Chat Interface (`community.html` or new `chat.html`).
- Add "Create Room" modal.
- Add "Join via Code" modal.
- Display Generic/Anon Names.

### Phase 4: Integration
- Link Study Groups to Books (Optional Advanced).
- Real-time updates.

</file>

<file path="docs\04_Deep_Component_Analysis.md">
# Comprehensive Technical Audit and Architectural Analysis of the LDBMS Ecosystem

## 1. Executive Summary & Audit Scope

This document serves as a **technical audit and code-level inspection** of the LDBMS codebase. While the [Architectural Analysis](01_LDBMS_Architectural_Analysis.md) outlines the system's design philosophy and high-level patterns (Service-Oriented Monolith), this report dives into the specific implementation details of key files.

**Audit Goal:** To identify scalability bottlenecks, security risks, and logic limitations in the current specific implementation, and provide a concrete roadmap for refactoring.

**Key Findings Overview:**
*   **Architecture:** Hybrid HTTP/WebSocket design on a single process.
*   **Scalability:** Limited by local filesystem storage (RAG/Uploads) and in-memory Socket.IO queues.
*   **Security:** Strong use of parameterization, but "Raw SQL" approach requires strict discipline.
*   **Maturity:** Features are rich, but deployment tooling (migrations, task queues) needs enterprise hardening.

## 2. Core Kernel and Application Bootstrapping

The bootstrapping sequence of the LDBMS is a critical phase where the runtime environment, database connectivity, and asynchronous schedulers are established. This section analyzes the files responsible for bringing the application to life.

### 2.1 The Entry Point: `run.py`
**Function and Task Range:**
The `run.py` script serves as the primary execution vector for the application. Its responsibilities extend beyond simply starting the web server; it acts as a **process supervisor**. The script imports the `create_app` factory and wraps it within `socketio.run`, ensuring the Flask application is mounted on an asynchronous web server (Eventlet or Gevent) capable of handling WebSocket traffic.

A unique feature of this file is the `cleanup_before_start()` function. This routine aggressively sanitizes the runtime environment by identifying processes occupying port 5000 and terminating them using OS-level commands (`taskkill`, `netstat`). This prevents the common "Address already in use" errors during rapid development cycles. Additionally, the `start_ngrok()` function integrates the `pyngrok` library to automatically create a secure tunnel from localhost to the public internet, facilitating remote testing and mobile device debugging without a formal deployment pipeline.

**Limitations:**
The reliance on `taskkill` and `netstat` with Windows-specific flags renders this script **non-portable**. Attempting to execute this on a Linux or macOS server would result in immediate runtime errors or silent failures in process cleanup. Furthermore, automatically starting an Ngrok tunnel in a production environment exposes the application to the public internet via a dynamic URL, representing a significant security risk if not gated by environment variables.

**Improvements:**
*   **Platform Agnosticism:** Replace subprocess calls with the cross-platform `psutil` library to handle process termination gracefully on any operating system.
*   **Environment Gating:** Wrap the `start_ngrok()` execution in a strict conditional check (e.g., `if os.getenv('FLASK_ENV') == 'development'`) to prevent accidental public exposure in production.

### 2.2 The Application Factory: `backend/app.py`
**Function and Task Range:**
This file implements the **Application Factory** pattern, a standard in robust Flask architecture. It encapsulates the creation of the Flask instance, allowing for multiple instances with different configurations (e.g., Testing vs. Production) to be created from the same codebase.
Key tasks include:
*   **Blueprint Registration:** It aggregates the routing logic by registering modular blueprints (`auth_bp`, `admin_bp`, `member_bp`, `chat_bp`), effectively compartmentalizing the URL namespace and keeping the main application file clean.
*   **Context Processing:** The `inject_global_data` function is a critical context processor that runs before *every* template render. It queries the `notification_service` and `settings_service` to inject `system_settings` and `unread_notifications` into the Jinja2 context. This eliminates the need to pass these variables from every single route handler.
*   **Middleware Initialization:** It initializes extensions like SocketIO with `async_mode='threading'`, enabling the concurrent handling of WebSocket connections alongside standard HTTP threads.

**Limitations:**
The global injection of notifications triggers a database query on **every single HTTP request**. In a high-traffic scenario, this introduces a significant performance penalty, termed the "N+1 query problem" at the request level. If 1,000 users refresh the page, the database is hit with 1,000 additional queries just for the notification bell.

**Improvements:**
*   **Caching Strategy:** Implement a caching layer (e.g., Redis or Flask-Caching) for the `inject_global_data` function. System settings change rarely and should be cached with a long Time-To-Live (TTL), while notification counts can be cached per user with invalidation on new events.
*   **Lazy Loading:** Refactor the frontend to load notifications asynchronously via an API call (`/api/notifications/unread`) after the initial page load, decoupling the expensive query from the critical rendering path.

### 2.3 The Command Line Interface: `mainCLI.py`
**Function and Task Range:**
The `mainCLI.py` file provides a headless, terminal-based interface for the library system. It allows administrators to perform core functions‚Äîuser management, book issuance, and analytics‚Äîwithout a web browser.
This file serves as a crucial validation of the system's architectural integrity. By importing business logic directly from `backend.services` (e.g., `authenticate_user`, `issue_book`) rather than implementing its own logic or calling HTTP endpoints, it proves that the **Service Layer is truly decoupled from the Presentation Layer**.

**Limitations:**
The CLI lacks the real-time capabilities of the web interface. Features like chat, live notifications, and the "Vibe" search engine are inaccessible here. Additionally, the reliance on `input()` for interaction makes it synchronous and blocking, unsuitable for automation or scripting.

**Improvements:**
*   **Argument Parsing:** Integrate `argparse` or `click` to allow the CLI to accept arguments (e.g., `python mainCLI.py issue --user 1 --book 5`), enabling it to be used in shell scripts and cron jobs.
*   **Rich UI:** Utilize the `rich` library to render the pandas DataFrames and tables with better formatting and color coding, matching the aesthetic quality of the web UI.

## 3. Data Persistence Architecture

The LDBMS adopts a "Repository Pattern" with raw SQL, deliberately eschewing Object-Relational Mappers (ORMs) like SQLAlchemy. This decision favors execution speed and explicit control but places a higher burden on the developer to maintain query safety and schema consistency.

### 3.1 The Database Access Layer: `backend/repository/db_access.py`
**Function and Task Range:**
This file is the solitary gatekeeper for all database interactions. No other component in the system is permitted to execute SQL directly.
*   `fetch_all(query, params)`: Handles read operations. It acquires a connection from the pool, creates a `dictionary=True` cursor (returning results as logical dictionaries rather than tuples), executes the query using safe parameterization, and ensures the connection is returned to the pool in a `finally` block.
*   `execute(query, params)`: Manages write operations (INSERT, UPDATE, DELETE). Crucially, it manages **transaction boundaries**. It automatically commits the transaction if the operation is successful and rolls back the entire transaction if an exception occurs. This guarantees Atomicity (the 'A' in ACID), ensuring that multi-step operations (like issuing a book) either fully succeed or fully fail.

**Limitations:**
The raw SQL approach lacks the database-agnostic abstraction of an ORM. Migrating from MySQL to PostgreSQL would require a manual rewrite of every SQL string in the codebase. Furthermore, the lack of compile-time checking for SQL queries means syntax errors are only caught at runtime.

**Improvements:**
*   **Query Builder:** Introduce a lightweight SQL builder like `pypika` or `SQLAlchemy Core`. This would allow for dynamic query construction (e.g., adding filters to a search) without resorting to dangerous string concatenation, while still maintaining the performance benefits of raw SQL.
*   **Telemetry:** Decorate the `execute` and `fetch_all` functions to log query execution times. This would provide valuable insights into slow queries and performance bottlenecks during production use.

### 3.2 Connection Pooling: `backend/config/db.py`
**Function and Task Range:**
This module manages the `MySQLConnectionPool`. Initializing a pool of persistent connections (defaulting to 5) eliminates the significant overhead (approx. 100ms) of establishing a new TCP handshake and authentication sequence for every request. The `get_connection()` function acts as a semaphore, providing a connection to a requesting thread only if one is available.

**Limitations:**
The pool size is static (`pool_size=5`). In a high-concurrency scenario (e.g., 50 simultaneous users), 45 requests will block and wait for a connection to be freed, causing massive latency spikes. The lack of a "queue timeout" or "overflow" mechanism means the application could hang indefinitely under load.

**Improvements:**
*   **Dynamic Scaling:** Implement a mechanism to dynamically resize the pool or use a more sophisticated pooling library like `DBUtils` or SQLAlchemy's `QueuePool`, which supports "overflow" connections that are created on demand and discarded after use.

### 3.3 Domain Models: `backend/models/`
**Function and Task Range:**
*   `book_model.py`: Defines the `Book` dataclass, enforcing type hints (`book_id: int`, `title: str`) for data moving through the system.
*   `user_model.py`: Defines the `User` dataclass.
These files serve as **Data Transfer Objects (DTOs)**, ensuring that data passed between the Repository and Service layers adheres to a contract, improving code readability and reducing type-related bugs.

**Limitations:**
These models are "anemic domain models"‚Äîthey contain data but no logic. Validation rules (e.g., checking if `total_copies` is positive) are scattered in the service layer rather than enforced by the model itself.

**Improvements:**
*   **Rich Models:** Move validation logic into the `__post_init__` method of the dataclasses. This ensures that a `Book` object can never be instantiated with invalid state, centralizing data integrity rules.

## 4. The Service Layer: The Business Logic Engine

The `backend/services/` directory is the "Brain" of the LDBMS. It encapsulates all business rules, preventing the "Spaghetti Code" that results from mixing logic with HTTP routing.

### 4.1 Inventory and Catalog Services
*   **`book_service.py`**:
    *   **Function**: Manages the CRUD lifecycle of books. The `view_books_paginated` function is particularly complex, dynamically constructing SQL WHERE clauses based on optional filters (author, category, search query).
    *   **Limitation**: The search functionality relies on `LIKE %query%`, which is notoriously slow on large datasets (full table scan) and cannot handle typos or relevance ranking.
    *   **Improvement**: Implement MySQL Full-Text Search indices or offload search to the ChromaDB vector store for semantic retrieval.
*   **`author_service.py`**:
    *   **Function**: Manages author metadata and series relationships. It resolves the many-to-one relationship between books and authors.
    *   **Limitation**: Authors are treated as simple strings in some legacy parts of the import logic, potentially leading to duplicate author records (e.g., "J.K. Rowling" vs "JK Rowling").
    *   **Improvement**: Implement a fuzzy matching algorithm during data entry or import to suggest existing authors and prevent duplication.
*   **`enrichment_service.py`**:
    *   **Function**: Uses external APIs (Google Books, OpenLibrary) to "hydrate" local book records with metadata like cover images, descriptions, and publication years.
    *   **Limitation**: The external API calls are **synchronous**. If the Google Books API is slow, the "Add Book" request will hang, degrading user experience.
    *   **Improvement**: Offload enrichment tasks to a background queue (e.g., Celery or the existing APScheduler) to allow the UI to respond immediately while metadata populates asynchronously.

### 4.2 Circulation and Transaction Services
*   **`issue_service.py`**:
    *   **Function**: The core of the library mechanics. It manages `issue_book` and `return_book`.
    *   **Logic**: It enforces strict borrowing limits based on membership tiers (retrieved via `membership_service`). It uses **atomic transactions** to ensure that the issues table insertion and the books stock decrement happen simultaneously. If one fails, both are rolled back.
    *   **Limitation**: Fine calculation is linear (`days_overdue * daily_rate`). It does not account for holidays, closed days, or grace periods dynamically.
    *   **Improvement**: Integrate a `calendar_service` to skip non-business days when calculating fines.
*   **`reservation_service.py`**:
    *   **Function**: Manages the waitlist for out-of-stock books. When a book is returned, it triggers notifications to the next user in line.
    *   **Limitation**: The notification is passive (email/in-app). It does not "lock" the book for the waiting user, meaning another user could theoretically snipe the book before the notified user arrives.
    *   **Improvement**: Implement a "reservation hold" window (e.g., 24 hours) where the returned book is exclusively issuable to the waitlisted user.

### 4.3 Social and Community Services
*   **`chat_service.py`**:
    *   **Function**: Manages chat rooms and the unique "Anonymous Mode."
    *   **Logic**: The `get_or_create_anon_id` function generates cryptographically random aliases, separating user identity from chat persona. This allows for privacy while maintaining accountability (admins can trace anon IDs).
    *   **Limitation**: Chat history is stored indefinitely in the SQL database (`chat_messages`), which will eventually degrade performance.
    *   **Improvement**: Implement a data retention policy or partition the table by month. Archive old messages to cold storage.
*   **`guild_service.py`**:
    *   **Function**: Implements a hierarchical community structure (Guild -> Category -> Channel).
    *   **Logic**: Manages `guild_members` and permissions.
    *   **Limitation**: Permissions are binary (Member/Admin). There is no granular permission system (e.g., "Can post images," "Can delete messages").
    *   **Improvement**: Implement a bitmask permission system to allow for fine-grained role management within guilds.
*   **`social_service.py`**:
    *   **Function**: Handles friend requests and public profiles.
    *   **Logic**: Respects granular privacy toggles (`is_public`, `allow_requests`) before exposing data.
    *   **Limitation**: Friend relationships are simple adjacency lists. Retrieving "friends of friends" for recommendations would be computationally expensive in SQL.
    *   **Improvement**: Use a Graph Database concept (or a recursive CTE in SQL) to efficiently query social graphs.

### 4.4 Gamification and Engagement
*   **`gamification_service.py`**:
    *   **Function**: Tracks XP, levels, and badges.
    *   **Logic**: The `check_for_badges` function evaluates rules (e.g., "Borrowed 10 books") and awards badges.
    *   **Limitation**: Badge rules are hardcoded in Python functions. Adding a new badge requires a code deployment.
    *   **Improvement**: Move badge logic to the database (Rule Engine pattern), allowing admins to define new badges via the UI (e.g., JSON rules: `{"metric": "books_read", "operator": ">=", "value": 50}`).

## 5. Real-Time Communication Layer

The LDBMS uses `Flask-SocketIO` to power its real-time features. This layer is distinct from the HTTP request cycle and requires specific architectural considerations.

### 5.1 The Gateway: `backend/chat/socket_service.py`
**Function and Task Range:**
This file defines the event handlers for WebSocket connections.
*   `handle_join_channel`: Authenticates the user's right to access a room (checking `dm_participants` or `guild_members`) and adds their socket ID to the broadcast group using `join_room()`.
*   `handle_message`: Receives incoming payloads, passes them to the `IngestionService`, and then broadcasts the result to the room using `emit()`.

**Limitations:**
The system uses the default **in-memory message queue** of Flask-SocketIO. This is the single biggest bottleneck for scalability. If the application is deployed across multiple worker processes (e.g., using Gunicorn with 4 workers), a client connected to Worker 1 cannot send a message to a client connected to Worker 2, because the memory space is isolated.

**Improvements:**
*   **Redis Message Broker:** Configure Flask-SocketIO to use Redis as a message queue (`socketio = SocketIO(app, message_queue='redis://...')`). This allows multiple server processes to coordinate and broadcast messages across the entire cluster.

### 5.2 The Pipeline: `backend/services/ingestion_service.py`
**Function and Task Range:**
This service acts as a middleware pipeline for chat messages.
1.  **Rate Limiting:** Calls `rate_limiter.py` to check token buckets, preventing spam.
2.  **Validation:** Ensures content compliance (length, type).
3.  **Persistence:** Saves the message to the database via `ChannelService`.
4.  **Fan-out:** Triggers the socket broadcast.

**Insight:**
Separating ingestion from the socket handler is a robust design choice. It allows the system to potentially support other inputs (e.g., REST API for mobile apps) while reusing the same processing logic.

## 6. The Intelligence Layer: AI and Search

### 6.1 Heuristic Engine: `backend/services/ai_service.py`
*   **Function**: A rule-based "Vibe" engine.
*   **Logic**: Uses a dictionary mapping (`mood_map`) to link keywords like "sad" to categories like "Biography".
*   **Limitation**: It lacks semantic understanding. A query like "I want a book that isn't sad" might trigger the "sad" keyword and return biographies, which is the opposite of the user's intent.
*   **Improvement**: Deprecate this engine in favor of the LLM-based approach, or keep it strictly as a fallback for offline mode.

### 6.2 The Brain: `backend/brain/orchestrator.py` & `rag.py`
*   **Function**: The central intelligence unit.
*   **Logic**:
    *   `orchestrator.py`: Routes queries to the best available model (Gemini API > HuggingFace > Local TinyLlama). It manages conversation history context.
    *   `rag.py`: Implements **Retrieval-Augmented Generation**. It uses `SentenceTransformer` to create vector embeddings of book descriptions and stores them in a local ChromaDB instance.
*   **Limitation**: The vector database is stored on the local filesystem (`./backend/brain/data`). In a cloud environment like Heroku or AWS Lambda, the filesystem is ephemeral, meaning the vector index is wiped on every restart.
*   **Improvement**: Transition to a hosted vector database solution (e.g., Pinecone, Weaviate, or a managed ChromaDB instance) to ensure persistence and scalability of the semantic search index.

## 7. Presentation Layer and User Interface

### 7.1 Template Engine: `templates/`

| File | Function | Limitation | Improvement |
| :--- | :--- | :--- | :--- |
| `layout.html` | Master template; sidebar, notifications, scripts. | Large DOM size due to hidden modals. | Use fragments (HTMX) to load modals on demand. |
| `admin/books.html` | Admin book grid; modals for Add/Import. | Logic mixed in HTML script tags. | Move JS to dedicated `static/js/books.js` file. |
| `member/ai_chat.html` | AI Chat Interface; fetch API logic. | Polling for updates (if socket fails). | Fully integrate with SocketIO for push updates. |
| `member/reader.html` | PDF Reader interface. | Loads entire PDF into browser memory. | Implement PDF streaming/chunking. |

### 7.2 Styling: `static/css/style.css`
*   **Function**: Implements the "Glassmorphism" design system using `backdrop-filter` and semi-transparent backgrounds.
*   **Limitation**: Heavy use of blur effects can cause performance degradation on low-end mobile devices (GPU rendering cost).
*   **Improvement**: Use CSS media queries (`@media (prefers-reduced-motion)`) or device capability detection to disable blur effects on low-power devices.

## 8. DevOps, Tooling, and Maintenance

### 8.1 Setup Scripts: `scripts/setup/`

| Script | Function | Key Insight |
| :--- | :--- | :--- |
| `setup_gamification.py` | Creates tables for XP, levels, badges. | Modular DB migration strategy. |
| `setup_chat_db.py` | Initializes `chat_rooms`, `chat_messages`. | Handles schema changes (`ALTER TABLE`). |
| `setup_audit.py` | Sets up the audit logging table. | Critical for security compliance. |

**Critique**: Using raw SQL scripts for schema changes is error-prone. There is no version control for the database schema state (no "down" migrations).
**Improvement**: Implement **Alembic** for database migrations. This provides a versioned history of schema changes and allows for safe rollbacks.

### 8.2 Verification Scripts: `scripts/verify/`
*   **Function**: A suite of diagnostic tools.
    *   `deep_health_check.py`: Validates file structure, imports, and database connectivity.
    *   `check_user_roles.py`: Audits the database for role integrity.
*   **Value**: These scripts act as a "Smoke Test" suite for CI/CD pipelines, ensuring the application is viable before traffic is switched over.

## 9. Comprehensive Limitations & Strategic Roadmap

### 9.1 Scalability Bottlenecks
*   **Socket.IO Memory Store**: As identified in 5.1, using the default in-memory message queue prevents running multiple worker processes.
    *   **Strategy**: Configure Redis or RabbitMQ as the message broker.
*   **Database Connection Pool**: The fixed-size pool in `backend/config/db.py` creates a hard ceiling on concurrency.
    *   **Strategy**: Implement dynamic pool sizing or migrate to SQLAlchemy's `QueuePool`.

### 9.2 Security Vulnerabilities
*   **Raw SQL Risks**: While `db_access.py` uses parameterization, dynamic queries in search/filtering (e.g., `book_service.py`) are complex and prone to errors.
    *   **Strategy**: Adopt a SQL builder library to safely construct dynamic queries.
*   **Local File Storage**: Storing uploads locally (`static/uploads`) is a major security and scalability risk.
    *   **Strategy**: Offload all user-generated content to an S3-compatible object storage service.

### 9.3 System Maturity
*   **Asynchronous Tasks**: APScheduler runs in the main process. Heavy tasks (PDF generation, bulk emails) can degrade web server performance.
    *   **Strategy**: Introduce **Celery with Redis** to offload heavy tasks to dedicated worker processes.

## 10. Conclusion

The LDBMS codebase demonstrates a sophisticated, feature-rich application architecture that successfully bridges the gap between traditional library management and modern social platforms. Its strict adherence to the Service-Repository pattern ensures maintainability and logical separation. However, its current reliance on local system resources‚Äîspecifically the filesystem for storage and in-memory structures for real-time state‚Äîlimits it to vertical scaling on a single server. To evolve into a true enterprise-grade solution capable of serving thousands of concurrent users, the system must transition to a cloud-native architecture, adopting managed services for storage (S3), messaging (Redis), and vector search (Pinecone).

</file>

<file path="scripts\export_codebase_for_ai.py">
import os

# Configuration
PROJECT_ROOT = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
OUTPUT_FILE = os.path.join(PROJECT_ROOT, "LDBMS_codebase_context.txt")

# Directories to ignore
IGNORE_DIRS = {
    ".git", "__pycache__", "venv", ".venv", "env", "node_modules", 
    "migrations", "static", ".idea", ".vscode", "tests", "tmp"
}

# File extensions to include (add more if needed)
INCLUDE_EXTENSIONS = {
    ".py", ".html", ".css", ".js", ".md", ".txt", ".json", ".sql", ".yaml", ".yml"
}

# Specific files to exclude
IGNORE_FILES = {
    "package-lock.json", "yarn.lock", "LDBMS_codebase_context.txt", ".DS_Store"
}

def get_file_tree(root_dir):
    tree_str = "Project Structure:\n"
    for root, dirs, files in os.walk(root_dir):
        # Modify dirs in-place to skip ignored directories
        dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
        
        level = root.replace(root_dir, '').count(os.sep)
        indent = ' ' * 4 * (level)
        tree_str += f"{indent}{os.path.basename(root)}/\n"
        subindent = ' ' * 4 * (level + 1)
        for f in files:
            if f not in IGNORE_FILES and os.path.splitext(f)[1] in INCLUDE_EXTENSIONS:
                 tree_str += f"{subindent}{f}\n"
    return tree_str

def export_codebase():
    print(f"Exporting codebase from: {PROJECT_ROOT}")
    
    with open(OUTPUT_FILE, "w", encoding="utf-8") as outfile:
        # 1. Write the directory tree
        tree = get_file_tree(PROJECT_ROOT)
        outfile.write(tree)
        outfile.write("\n" + "="*50 + "\n\n")

        # 2. Write file contents
        for root, dirs, files in os.walk(PROJECT_ROOT):
            # Modify dirs in-place to skip ignored directories
            dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
            
            for file in files:
                if file in IGNORE_FILES:
                    continue
                    
                ext = os.path.splitext(file)[1]
                if ext not in INCLUDE_EXTENSIONS:
                    continue
                
                file_path = os.path.join(root, file)
                rel_path = os.path.relpath(file_path, PROJECT_ROOT)
                
                try:
                    with open(file_path, "r", encoding="utf-8") as infile:
                        content = infile.read()
                        
                    # Write in XML-style format
                    outfile.write(f'<file path="{rel_path}">\n')
                    outfile.write(content)
                    outfile.write(f'\n</file>\n\n')
                    
                except Exception as e:
                    print(f"Skipping file {rel_path} due to error: {e}")

    print(f"Export complete! File saved to: {OUTPUT_FILE}")

if __name__ == "__main__":
    export_codebase()

</file>

<file path="scripts\setup\check_roles.py">
import sys
sys.path.append('.')
from backend.repository.db_access import fetch_all, fetch_one

print("üîç Checking Channel 1 (Global)...")
c1 = fetch_one("SELECT * FROM channels WHERE channel_id = 1")
print(f"Channel 1: created_by={c1.get('created_by')}")

members1 = fetch_all("""
    SELECT u.user_id, u.name, u.role 
    FROM dm_participants dp
    JOIN users u ON dp.user_id = u.user_id
    WHERE dp.channel_id = 1
""")
print(f"Members in Ch 1: {members1}")

print("\nüîç Checking Channel 2 (Group)...")
c2 = fetch_one("SELECT * FROM channels WHERE channel_id = 2")
if c2:
    print(f"Channel 2: created_by={c2.get('created_by')}")
    members2 = fetch_all("""
        SELECT u.user_id, u.name, u.role 
        FROM dm_participants dp
        JOIN users u ON dp.user_id = u.user_id
        WHERE dp.channel_id = 2
    """)
    print(f"Members in Ch 2: {members2}")
else:
    print("Channel 2 not found")

</file>

<file path="scripts\setup\create_chat_tables.py">
from backend.repository.db_access import execute_query

print("Creating chat_rooms table...")
execute_query("""
CREATE TABLE IF NOT EXISTS chat_rooms (
    room_id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_official BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (created_by) REFERENCES users(user_id) ON DELETE CASCADE
);
""")

print("Creating chat_messages table...")
execute_query("""
CREATE TABLE IF NOT EXISTS chat_messages (
    message_id INT AUTO_INCREMENT PRIMARY KEY,
    room_id INT NOT NULL,
    user_id INT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (room_id) REFERENCES chat_rooms(room_id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);
""")

print("Seeding initial room...")
execute_query("""
INSERT IGNORE INTO chat_rooms (room_id, name, description, is_official) 
VALUES (1, 'General Lounge', 'The main lobby for all library members. Say hello!', TRUE);
""")

print("Done!")

</file>

<file path="scripts\setup\db_setup.py">
"""
db_setup.py
-----------
This script initializes the database by creating necessary tables and adding an admin user.
Run this script once to set up your database.
"""

import os
import sys
from getpass import getpass
from werkzeug.security import generate_password_hash

# Add the project root to the Python path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# FIX 1: Removed 'get_db_connection' from import because it does not exist in db_access.py
from backend.repository.db_access import execute_query, fetch_one

def create_tables():
    """Create necessary database tables if they don't exist."""
    print("üõ†  Creating database tables...")

    try:
        # 1. Create users table
        # FIX 2: Changed 'id' to 'user_id' to match your users.html template
        execute_query("""
        CREATE TABLE IF NOT EXISTS users (
            user_id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            email VARCHAR(100) UNIQUE NOT NULL,
            password_hash VARCHAR(200) NOT NULL,
            role ENUM('admin', 'member') NOT NULL DEFAULT 'member',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            must_change_password BOOLEAN DEFAULT TRUE
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
        """)
        print("   - 'users' table checked/created.")

        # 2. Create books table (Added this because it was missing)
        execute_query("""
        CREATE TABLE IF NOT EXISTS books (
            book_id INT AUTO_INCREMENT PRIMARY KEY,
            title VARCHAR(255) NOT NULL,
            author VARCHAR(255) NOT NULL,
            isbn VARCHAR(20) UNIQUE,
            category VARCHAR(100),
            quantity INT DEFAULT 1,
            available_quantity INT DEFAULT 1,
            cover_image_url VARCHAR(255),
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
        """)
        print("   - 'books' table checked/created.")

        # 3. Create book_suggestions table
        # FIX 3: Updated Foreign Key to reference 'user_id' instead of 'id'
        execute_query("""
        CREATE TABLE IF NOT EXISTS book_suggestions (
            suggestion_id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            title VARCHAR(255) NOT NULL,
            author VARCHAR(255),
            isbn VARCHAR(20),
            notes TEXT,
            status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
        """)
        print("   - 'book_suggestions' table checked/created.")

        # 4. Create issues table (Used by the application)
        execute_query("""
        CREATE TABLE IF NOT EXISTS issues (
            issue_id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            book_id INT NOT NULL,
            issue_date DATE NOT NULL,
            return_date DATE DEFAULT NULL,
            fine INT DEFAULT 0,
            FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
            FOREIGN KEY (book_id) REFERENCES books(book_id) ON DELETE CASCADE,
            UNIQUE KEY uq_user_book_active (user_id, book_id, return_date)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
        """)
        print("   - 'issues' table checked/created.")

        print("‚úÖ All database tables created successfully!")
        return True
    except Exception as e:
        print(f"‚ùå Error creating tables: {str(e)}")
        return False

def create_admin_user():
    """Create an admin user if one doesn't exist."""
    try:
        # Check if admin user already exists
        # FIX 4: Changed 'id' to 'user_id' in query
        admin = fetch_one("SELECT user_id FROM users WHERE email = 'admin@example.com'")

        if admin:
            print("‚ÑπÔ∏è  Admin user already exists.")
            return True

        # Get admin details
        print("\nüë§ Create Admin User")
        print("--------------------")
        name = input("Admin name [Admin]: ").strip() or "Admin"
        email = input("Admin email [admin@example.com]: ").strip() or "admin@example.com"

        while True:
            password = getpass("Admin password (min 8 characters): ")
            if len(password) >= 8:
                break
            print("Password must be at least 8 characters long. Please try again.")

        # Hash the password
        password_hash = generate_password_hash(password)

        # Insert admin user
        execute_query(
            """
            INSERT INTO users (name, email, password_hash, role, must_change_password)
            VALUES (%s, %s, %s, 'admin', FALSE)
            """,
            (name, email, password_hash)
        )

        print("\n‚úÖ Admin user created successfully!")
        print(f"Email: {email}")
        print(f"Password: {'*' * len(password)}")
        return True

    except Exception as e:
        print(f"‚ùå Error creating admin user: {str(e)}")
        return False

if __name__ == "__main__":
    print("üöÄ Setting up the database...\n")

    # Create tables
    if not create_tables():
        print("\n‚ùå Failed to create tables. Please check the error message above.")
        sys.exit(1)

    # Create admin user
    if not create_admin_user():
        print("\n‚ùå Failed to create admin user. Please check the error message above.")
        sys.exit(1)

    print("\n‚ú® Database setup completed successfully!")
    print("You can now log in with the admin credentials you provided.")
</file>

<file path="scripts\setup\setup_activities.py">

from backend.repository.db_access import execute_query

def setup_activities():
    print("Setting up User Activities table...")
    query = """
    CREATE TABLE IF NOT EXISTS user_activities (
        activity_id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        activity_type VARCHAR(50) NOT NULL,
        description TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT fk_act_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
    );
    """
    execute_query(query)
    print("‚úÖ User Activities table set up.")

if __name__ == "__main__":
    setup_activities()

</file>

<file path="scripts\setup\setup_api_keys.py">

from backend.repository.db_access import execute_query

def setup_api_keys():
    print("Setting up API Keys table...")
    query = """
    CREATE TABLE IF NOT EXISTS api_keys (
        key_id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        api_key VARCHAR(64) UNIQUE NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT fk_api_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
    );
    """
    execute_query(query)
    print("‚úÖ API Keys table set up.")

if __name__ == "__main__":
    setup_api_keys()

</file>

<file path="scripts\setup\setup_audit.py">

from backend.repository.db_access import execute_query

def setup_audit():
    print("Setting up Audit Logs...")
    query = """
    CREATE TABLE IF NOT EXISTS audit_logs (
        log_id INT AUTO_INCREMENT PRIMARY KEY,
        admin_id INT NOT NULL,
        action VARCHAR(100) NOT NULL,
        details TEXT DEFAULT NULL,
        timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        
        CONSTRAINT fk_audit_admin FOREIGN KEY (admin_id) REFERENCES users(user_id) ON DELETE CASCADE
    );
    """
    try:
        execute_query(query)
        print("‚úÖ Table 'audit_logs' created successfully.")
    except Exception as e:
        print(f"‚ùå Error creating table: {e}")

if __name__ == "__main__":
    setup_audit()

</file>

<file path="scripts\setup\setup_author_series.py">

from backend.repository.db_access import execute, fetch_all

def setup_author_series():
    print("üöÄ Initializing Author & Series Management...")
    
    # 1. Create authors table
    try:
        execute("""
            CREATE TABLE IF NOT EXISTS authors (
                author_id INT AUTO_INCREMENT PRIMARY KEY,
                name VARCHAR(255) UNIQUE NOT NULL,
                bio TEXT,
                photo_src VARCHAR(255),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        print("‚úÖ Created 'authors' table.")
    except Exception as e:
        print(f"‚ùå Error creating 'authors': {e}")

    # 2. Create series table
    try:
        execute("""
            CREATE TABLE IF NOT EXISTS series (
                series_id INT AUTO_INCREMENT PRIMARY KEY,
                title VARCHAR(255) UNIQUE NOT NULL,
                description TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        print("‚úÖ Created 'series' table.")
    except Exception as e:
        print(f"‚ùå Error creating 'series': {e}")

    # 3. Add foreign keys to books table
    try:
        execute("ALTER TABLE books ADD COLUMN author_id INT")
        execute("ALTER TABLE books ADD COLUMN series_id INT")
        execute("ALTER TABLE books ADD COLUMN series_order INT")
        print("‚úÖ Added relational columns to 'books' table.")
    except Exception as e:
        if "Duplicate column name" in str(e):
            print("‚ÑπÔ∏è Relational columns already exist in 'books'.")
        else:
            print(f"‚ùå Error updating 'books': {e}")

    # 4. Data Migration: Populate authors table and link books
    try:
        print("üöö Migrating existing author data...")
        books = fetch_all("SELECT DISTINCT author FROM books WHERE author IS NOT NULL")
        for b in books:
            author_name = b['author']
            # Insert author if not exists
            execute("INSERT IGNORE INTO authors (name) VALUES (%s)", (author_name,))
            # Link book to new author_id
            execute("""
                UPDATE books b
                JOIN authors a ON b.author = a.name
                SET b.author_id = a.author_id
                WHERE b.author = %s
            """, (author_name,))
        print(f"‚úÖ Migrated {len(books)} unique authors.")
    except Exception as e:
        print(f"‚ùå Error migrating data: {e}")

if __name__ == "__main__":
    setup_author_series()

</file>

<file path="scripts\setup\setup_avatars.py">

from backend.repository.db_access import execute_query
import os

def setup_avatars():
    print("Setting up profile pictures...")
    
    # 1. Update Database
    query = """
    ALTER TABLE users
    ADD COLUMN profile_pic VARCHAR(255) DEFAULT NULL;
    """
    
    try:
        execute_query(query)
        print("‚úÖ Column 'profile_pic' added successfully.")
    except Exception as e:
        if "Duplicate column" in str(e):
            print("‚ÑπÔ∏è Column 'profile_pic' already exists. Skipping.")
        else:
            print(f"‚ùå Error adding column: {e}")

    # 2. Create Uploads Directory
    # Assuming run from root, backend/static/uploads/avatars
    # Flask static folder is usually 'backend/static' or just 'static' depending on config.
    # Looking at project structure, 'templates' and 'backend' are at root.
    # Usually Flask apps serve static from a 'static' folder.
    # Let's check where 'static' is.
    
    # Based on previous file views, I haven't seen a 'static' folder at root.
    # But usually it's `backend/static` or `static`.
    # I'll create `static/uploads/avatars` at root specific to run.py context.
    
    upload_path = os.path.join("static", "uploads", "avatars")
    os.makedirs(upload_path, exist_ok=True)
    print(f"‚úÖ Created directory: {upload_path}")

if __name__ == "__main__":
    setup_avatars()

</file>

<file path="scripts\setup\setup_category_fines.py">

from backend.repository.db_access import execute_query

def setup_category_fines():
    print("Setting up Category Fines table...")
    query = """
    CREATE TABLE IF NOT EXISTS category_fines (
        category VARCHAR(100) PRIMARY KEY,
        daily_rate DECIMAL(10, 2) DEFAULT 10.00
    );
    """
    execute_query(query)
    
    # Seed some defaults
    defaults = [
        ('General', 5.00),
        ('Science', 10.00),
        ('Fiction', 7.00),
        ('Reference', 20.00),
        ('History', 8.00)
    ]
    for cat, rate in defaults:
        execute_query("INSERT IGNORE INTO category_fines (category, daily_rate) VALUES (%s, %s)", (cat, rate))
        
    print("‚úÖ Category Fines table set up.")

if __name__ == "__main__":
    setup_category_fines()

</file>

<file path="scripts\setup\setup_chat_db.py">
import sys
import os

# Add project root to path
root_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
sys.path.append(root_dir)
print(f"DEBUG: Added {root_dir} to sys.path")

from backend.repository.db_access import execute, fetch_all


def setup_chat_db():
    print("üöß Setting up Chat Database Schema...")
    
    # 1. Update/Create CHAT_ROOMS
    print("Checking 'chat_rooms' table...")
    # Add 'room_type' column if not exists
    try:
        execute("ALTER TABLE chat_rooms ADD COLUMN room_type VARCHAR(50) DEFAULT 'general'")
        print("   + Added 'room_type' column.")
    except Exception as e:
        if "Duplicate column" in str(e):
            print("   - 'room_type' column already exists.")
        else:
            print(f"   - Note: {e}")

    # 2. Update/Create CHAT_MESSAGES
    print("Checking 'chat_messages' table...")
    # Add 'type' column (text, image, system)
    try:
        execute("ALTER TABLE chat_messages ADD COLUMN msg_type VARCHAR(20) DEFAULT 'text'")
        print("   + Added 'msg_type' column.")
    except Exception as e:
        if "Duplicate column" in str(e):
            print("   - 'msg_type' column already exists.")
        else:
            execute("CREATE TABLE IF NOT EXISTS chat_messages ("
                    "message_id INT AUTO_INCREMENT PRIMARY KEY,"
                    "room_id INT,"
                    "user_id INT,"
                    "content TEXT,"
                    "msg_type VARCHAR(20) DEFAULT 'text',"
                    "created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,"
                    "FOREIGN KEY (room_id) REFERENCES chat_rooms(room_id),"
                    "FOREIGN KEY (user_id) REFERENCES users(user_id)"
                    ")")
            print("   + Created 'chat_messages' table.")

    # 3. Create CHAT_MEMBERS (For roles/permissions)
    print("Creating 'chat_members' table...")
    execute("""
        CREATE TABLE IF NOT EXISTS chat_members (
            room_id INT,
            user_id INT,
            role VARCHAR(20) DEFAULT 'member',  -- admin, moderator, member
            joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (room_id, user_id),
            FOREIGN KEY (room_id) REFERENCES chat_rooms(room_id) ON DELETE CASCADE,
            FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
        )
    """)
    print("   + Verified 'chat_members' table.")
    
    print("‚úÖ Chat Database Schema Ready!")

if __name__ == "__main__":
    setup_chat_db()

</file>

<file path="scripts\setup\setup_ebooks.py">

from backend.repository.db_access import execute_query
import os

def setup_ebooks():
    print("Setting up Digital Library...")
    
    # 1. Update Database
    query = """
    ALTER TABLE books
    ADD COLUMN pdf_src VARCHAR(255) DEFAULT NULL;
    """
    
    try:
        execute_query(query)
        print("‚úÖ Column 'pdf_src' added successfully.")
    except Exception as e:
        if "Duplicate column" in str(e):
            print("‚ÑπÔ∏è Column 'pdf_src' already exists. Skipping.")
        else:
            print(f"‚ùå Error adding column: {e}")

    # 2. Create Uploads Directory
    upload_path = os.path.join("static", "uploads", "ebooks")
    os.makedirs(upload_path, exist_ok=True)
    print(f"‚úÖ Created directory: {upload_path}")

if __name__ == "__main__":
    setup_ebooks()

</file>

<file path="scripts\setup\setup_fines.py">

from backend.repository.db_access import execute_query

def add_fine_tracking():
    print("Updating issues table for fine tracking...")
    
    # Check if column exists (naive check via trying to add it, ignoring error)
    # Better: Query information_schema, but ALTER IGNORE is not supported in all MySQL.
    # We'll rely on "Duplicate column name" error handling or just use specific check.
    
    query = """
    ALTER TABLE issues
    ADD COLUMN fine_paid BOOLEAN DEFAULT FALSE;
    """
    
    try:
        execute_query(query)
        print("‚úÖ Column 'fine_paid' added successfully.")
    except Exception as e:
        if "Duplicate column" in str(e):
            print("‚ÑπÔ∏è Column 'fine_paid' already exists. Skipping.")
        else:
            print(f"‚ùå Error adding column: {e}")

if __name__ == "__main__":
    add_fine_tracking()

</file>

<file path="scripts\setup\setup_gamification.py">

from backend.repository.db_access import execute, fetch_one

def setup_gamification():
    print("üöÄ Initializing Gamification System...")
    
    # 1. Create table for user levels and XP
    execute("""
        CREATE TABLE IF NOT EXISTS user_profile_stats (
            user_id INT PRIMARY KEY,
            xp INT DEFAULT 0,
            level INT DEFAULT 1,
            last_award_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
        )
    """)

    # 2. Create badges table
    execute("""
        CREATE TABLE IF NOT EXISTS badges (
            badge_id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(100) UNIQUE NOT NULL,
            description TEXT,
            icon VARCHAR(255)
        )
    """)
    
    # Ensure xp_required exists
    try:
        execute("ALTER TABLE badges ADD COLUMN xp_required INT DEFAULT 0")
    except:
        pass

    # 3. Create user_achievements bridge table
    execute("""
        CREATE TABLE IF NOT EXISTS user_achievements (
            achievement_id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT,
            badge_id INT,
            earned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
            FOREIGN KEY (badge_id) REFERENCES badges(badge_id) ON DELETE CASCADE,
            UNIQUE(user_id, badge_id)
        )
    """)

    # 4. Seed initial badges
    initial_badges = [
        ("First Borrow", "Borrow your very first book from the library.", "üìñ", 0),
        ("Quick Reader", "Return a book within 3 days.", "‚ö°", 50),
        ("Socialite", "Make your reading profile public.", "üåê", 20),
        ("Knowledge Seeker", "Borrow 10 unique books.", "üß†", 200),
        ("Library Legend", "Reach Level 10.", "üëë", 1000)
    ]
    
    for name, desc, icon, xp in initial_badges:
        execute("INSERT IGNORE INTO badges (name, description, icon, xp_required) VALUES (%s, %s, %s, %s)", (name, desc, icon, xp))
    
    # 5. Initialize stats for existing users
    execute("INSERT IGNORE INTO user_profile_stats (user_id) SELECT user_id FROM users")
    print("‚úÖ Gamification initialized successfully.")

if __name__ == "__main__":
    setup_gamification()

</file>

<file path="scripts\setup\setup_membership_tiers.py">

from backend.repository.db_access import execute_query

def setup_membership_tiers():
    print("Setting up Membership Tiers...")
    
    # 1. Add tier column to users if it doesn't exist
    # Note: MySQL doesn't have IF NOT EXISTS for columns easily in a single script without a procedure, 
    # but we can try-except or just run it if we know the schema.
    try:
        execute_query("ALTER TABLE users ADD COLUMN tier ENUM('Silver', 'Gold', 'Platinum') DEFAULT 'Silver'")
        print("‚úÖ Added 'tier' column to users table.")
    except Exception as e:
        if "Duplicate column name" in str(e):
            print("‚ÑπÔ∏è 'tier' column already exists in users table.")
        else:
            print(f"‚ö†Ô∏è Error adding tier column: {e}")

    # 2. Create membership_configs table
    q_table = """
    CREATE TABLE IF NOT EXISTS membership_configs (
        tier ENUM('Silver', 'Gold', 'Platinum') PRIMARY KEY,
        max_books INT NOT NULL,
        loan_days INT NOT NULL
    );
    """
    execute_query(q_table)
    
    # 3. Seed configurations
    configs = [
        ('Silver', 3, 14),
        ('Gold', 7, 30),
        ('Platinum', 999, 60)
    ]
    
    for tier, max_books, loan_days in configs:
        execute_query("""
            INSERT INTO membership_configs (tier, max_books, loan_days) 
            VALUES (%s, %s, %s) 
            ON DUPLICATE KEY UPDATE max_books=%s, loan_days=%s
        """, (tier, max_books, loan_days, max_books, loan_days))
        
    print("‚úÖ Membership configurations seeded.")

if __name__ == "__main__":
    setup_membership_tiers()

</file>

<file path="scripts\setup\setup_notifications.py">

from backend.repository.db_access import execute_query

def setup_notifications():
    print("Setting up Notifications...")
    query = """
    CREATE TABLE IF NOT EXISTS notifications (
        notification_id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        message TEXT NOT NULL,
        is_read BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT fk_notif_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
    );
    """
    execute_query(query)
    print("‚úÖ Notifications table set up.")

if __name__ == "__main__":
    setup_notifications()

</file>

<file path="scripts\setup\setup_reading_goals.py">

from backend.repository.db_access import execute_query

def setup_reading_goals():
    print("Setting up Reading Goals table...")
    query = """
    CREATE TABLE IF NOT EXISTS reading_goals (
        goal_id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        year INT NOT NULL,
        target_count INT DEFAULT 12,
        current_count INT DEFAULT 0,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        UNIQUE KEY user_year (user_id, year),
        CONSTRAINT fk_goal_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
    );
    """
    execute_query(query)
    print("‚úÖ Reading Goals table set up.")

if __name__ == "__main__":
    setup_reading_goals()

</file>

<file path="scripts\setup\setup_reviews.py">

from backend.repository.db_access import execute_query

def create_reviews_table():
    print("Creating reviews table...")
    query = """
    CREATE TABLE IF NOT EXISTS reviews (
        review_id INT AUTO_INCREMENT PRIMARY KEY,
        book_id INT NOT NULL,
        user_id INT NOT NULL,
        rating INT CHECK (rating >= 1 AND rating <= 5),
        comment TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        
        CONSTRAINT fk_reviews_book
            FOREIGN KEY (book_id) REFERENCES books(book_id)
            ON DELETE CASCADE,
            
        CONSTRAINT fk_reviews_user
            FOREIGN KEY (user_id) REFERENCES users(user_id)
            ON DELETE CASCADE,
            
        UNIQUE (book_id, user_id)
    );
    """
    try:
        execute_query(query)
        print("‚úÖ Reviews table created successfully.")
    except Exception as e:
        print(f"‚ùå Error creating table: {e}")

if __name__ == "__main__":
    create_reviews_table()

</file>

<file path="scripts\setup\setup_settings.py">

from backend.repository.db_access import execute_query

def setup_settings():
    print("Setting up Settings table...")
    query = """
    CREATE TABLE IF NOT EXISTS settings (
        setting_key VARCHAR(50) PRIMARY KEY,
        setting_value VARCHAR(255) NOT NULL
    );
    """
    execute_query(query)
    
    # Initialize maintenance_mode if not exists
    execute_query("INSERT IGNORE INTO settings (setting_key, setting_value) VALUES ('maintenance_mode', 'false')")
    print("‚úÖ Settings table set up.")

if __name__ == "__main__":
    setup_settings()

</file>

<file path="scripts\setup\setup_social_features.py">

from backend.repository.db_access import execute

def setup_social_features():
    print("üöÄ Initializing Social Features...")
    
    # 1. Add is_public column to users table
    try:
        execute("ALTER TABLE users ADD COLUMN is_public BOOLEAN DEFAULT 0")
        print("‚úÖ Added 'is_public' column to 'users' table.")
    except Exception as e:
        if "Duplicate column name" in str(e):
            print("‚ÑπÔ∏è 'is_public' column already exists.")
        else:
            print(f"‚ùå Error adding 'is_public': {e}")

    # 2. (Optional) Create a review_likes table for future engagement
    try:
        execute("""
            CREATE TABLE IF NOT EXISTS review_likes (
                like_id INT AUTO_INCREMENT PRIMARY KEY,
                user_id INT,
                review_id INT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(user_id, review_id)
            )
        """)
        print("‚úÖ Created 'review_likes' table.")
    except Exception as e:
        print(f"‚ùå Error creating 'review_likes': {e}")

if __name__ == "__main__":
    setup_social_features()

</file>

<file path="scripts\setup\setup_test_user.py">

import sys
import os


# Add project root
sys.path.append(os.getcwd())

# Import DB tools
try:
    from backend.repository.db_access import execute_query, fetch_one
except ImportError:
    from backend.repository.db_access import execute as execute_query, fetch_one

from backend.utils.security import hash_password as generate_password_hash

def setup():
    email = 'tester@automation.com'
    pwd = 'AutoTest@123'
    name = 'Automation Tester'
    
    print(f"Checking {email}...")
    try:
        user = fetch_one("SELECT user_id FROM users WHERE email = %s", (email,))
        
        p_hash = generate_password_hash(pwd)
        
        if user:
            print("User exists. Updating password...")
            execute_query("UPDATE users SET password_hash = %s, must_change_password = 0 WHERE email = %s", (p_hash, email))
        else:
            print("Creating user...")
            execute_query(
                "INSERT INTO users (name, email, password_hash, role, must_change_password) VALUES (%s, %s, %s, 'member', 0)",
                (name, email, p_hash)
            )
        print("‚úÖ Test user ready.")
    except Exception as e:
        print(f"‚ùå Error: {e}")

if __name__ == "__main__":
    setup()

</file>

<file path="scripts\setup\setup_tickets.py">

from backend.repository.db_access import execute_query

def setup_tickets():
    print("Setting up Support Tickets...")
    q1 = """
    CREATE TABLE IF NOT EXISTS tickets (
        ticket_id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        subject VARCHAR(255) NOT NULL,
        status ENUM('open', 'closed') DEFAULT 'open',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT fk_ticket_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
    );
    """
    execute_query(q1)

    q2 = """
    CREATE TABLE IF NOT EXISTS ticket_replies (
        reply_id INT AUTO_INCREMENT PRIMARY KEY,
        ticket_id INT NOT NULL,
        sender_id INT NOT NULL,
        message TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT fk_reply_ticket FOREIGN KEY (ticket_id) REFERENCES tickets(ticket_id) ON DELETE CASCADE,
        CONSTRAINT fk_reply_sender FOREIGN KEY (sender_id) REFERENCES users(user_id) ON DELETE CASCADE
    );
    """
    execute_query(q2)
    print("‚úÖ Support Ticket tables set up.")

if __name__ == "__main__":
    setup_tickets()

</file>

<file path="scripts\setup\setup_waitlist.py">

from backend.repository.db_access import execute_query

def setup_waitlist():
    print("Creating reservations table...")
    query = """
    CREATE TABLE IF NOT EXISTS reservations (
        reservation_id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        book_id INT NOT NULL,
        reserved_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        status ENUM('active', 'fulfilled', 'cancelled') DEFAULT 'active',
        
        CONSTRAINT fk_res_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_res_book FOREIGN KEY (book_id) REFERENCES books(book_id) ON DELETE CASCADE,
        UNIQUE(user_id, book_id) -- User can only reserve a book once
    );
    """
    try:
        execute_query(query)
        print("‚úÖ Reservations table created successfully.")
    except Exception as e:
        print(f"‚ùå Error creating table: {e}")

if __name__ == "__main__":
    setup_waitlist()

</file>

<file path="scripts\setup\setup_wishlist.py">

from backend.repository.db_access import execute_query

def setup_wishlist():
    print("Setting up Wishlist...")
    query = """
    CREATE TABLE IF NOT EXISTS wishlist (
        wishlist_id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        book_id INT NOT NULL,
        added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        
        UNIQUE(user_id, book_id),
        CONSTRAINT fk_wish_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_wish_book FOREIGN KEY (book_id) REFERENCES books(book_id) ON DELETE CASCADE
    );
    """
    try:
        execute_query(query)
        print("‚úÖ Table 'wishlist' created successfully.")
    except Exception as e:
        print(f"‚ùå Error creating table: {e}")

if __name__ == "__main__":
    setup_wishlist()

</file>

<file path="scripts\verify\check_channel2.py">
import sys
sys.path.append('.')
from backend.repository.db_access import fetch_one

print("üîç Checking Channel 2 Type...")
c = fetch_one("SELECT * FROM channels WHERE channel_id = 2")
if c:
    print(f"Channel 2: type='{c.get('type')}', is_private={c.get('is_private')}, name='{c.get('name')}'")
else:
    print("Channel 2 not found")

</file>

<file path="scripts\verify\check_global_members.py">
import sys
sys.path.append('.')
from backend.repository.db_access import fetch_all, fetch_one

print("üîç Checking Channel 1 (Global)...")
channel = fetch_one("SELECT * FROM channels WHERE channel_id = 1")
print(f"Channel 1: {channel}")

print("\nüîç Checking participants in Channel 1...")
parts = fetch_all("SELECT COUNT(*) as count FROM dm_participants WHERE channel_id = 1")
print(f"Participant Count: {parts[0]['count']}")

print("\nüîç Checking Total Users...")
users = fetch_all("SELECT COUNT(*) as count FROM users")
print(f"Total Users: {users[0]['count']}")

</file>

<file path="scripts\verify\check_icons.py">
import sys
sys.path.append('.')
from backend.repository.db_access import fetch_all

print("üîç Checking ALL channel icons in database...")
channels = fetch_all('SELECT channel_id, name, icon FROM channels')
for c in channels:
    icon = c.get('icon') or 'None'
    print(f"Channel {c['channel_id']}: {c['name'][:20]:20s} - Icon: {icon}")

</file>

<file path="scripts\verify\check_msg_schema.py">

import os
import sys
sys.path.append(os.getcwd())
try:
    from backend.config.db import get_connection
    conn = get_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("DESCRIBE chat_messages")
    rows = cursor.fetchall()
    for r in rows:
        print(f"{r['Field']}: {r['Type']} Null={r['Null']} Default={r['Default']}")
except Exception as e:
    print(e)

</file>

<file path="scripts\verify\check_user_roles.py">
import sys
sys.path.append('.')
from backend.repository.db_access import fetch_all

print("üîç Checking Users and Roles...")
users = fetch_all("SELECT user_id, name, role FROM users")
for u in users:
    print(f"User {u['user_id']}: {u['name']} - Role: '{u['role']}'")

</file>

<file path="scripts\verify\data_check.py">

import os
import sys
sys.path.append(os.getcwd())
from backend.repository.db_access import fetch_all

try:
    print("=== ROOM MEMBERS (Legacy) ===")
    rows = fetch_all("SELECT * FROM room_members LIMIT 5")
    for r in rows:
        print(r)

    print("\n=== DM PARTICIPANTS (New) ===")
    rows = fetch_all("SELECT * FROM dm_participants LIMIT 5")
    for r in rows:
        print(r)
        
    print("\n=== CHANNELS (DMs) ===")
    rows = fetch_all("SELECT channel_id, name, guild_id FROM channels WHERE guild_id IS NULL LIMIT 5")
    for r in rows:
        print(r)

except Exception as e:
    print(f"Error: {e}")

</file>

<file path="scripts\verify\debug_chat_db.py">
import sys
import os
import mysql.connector
from pathlib import Path
from dotenv import load_dotenv

# Load env
env_path = Path(__file__).parent.parent / '.env'
load_dotenv(dotenv_path=env_path)

def get_connection():
    return mysql.connector.connect(
        host=os.getenv("DB_HOST", "127.0.0.1"),
        user=os.getenv("DB_USER", "app_user"),
        password=os.getenv("DB_PASSWORD", "App@123"),
        database=os.getenv("DB_NAME", "library_db"),
        port=int(os.getenv("DB_PORT", 3306))
    )

def debug_chat_db():
    print("üîç Debugging Chat DB...")
    conn = get_connection()
    cursor = conn.cursor(dictionary=True)
    
    try:
        # 1. Check Tables
        cursor.execute("SHOW TABLES LIKE 'chat%'")
        tables = cursor.fetchall()
        print("Tables found:", [t.values() for t in tables])
        
        # 2. Check chat_messages columns
        print("\nChecking chat_messages schema:")
        cursor.execute("DESCRIBE chat_messages")
        columns = cursor.fetchall()
        for col in columns:
            print(f" - {col['Field']} ({col['Type']})")
            
        # 3. Check Users
        print("\nChecking Users:")
        cursor.execute("SELECT user_id, name, email FROM users LIMIT 5")
        users = cursor.fetchall()
        for u in users:
            print(f" - ID: {u['user_id']}, Name: {u['name']}")
            
        # 4. Check Rooms
        print("\nChecking Rooms:")
        cursor.execute("SELECT room_id, name FROM chat_rooms LIMIT 5")
        rooms = cursor.fetchall()
        for r in rooms:
            print(f" - ID: {r['room_id']}, Name: {r['name']}")
            
        if not rooms:
            print("‚ùå No rooms found! Creating one...")
            cursor.execute("INSERT INTO chat_rooms (name, description, created_by, is_official) VALUES ('Debug Room', 'Test', 1, 1)")
            conn.commit()
            print("Created Debug Room")
            
        # 5. Try Insert Message
        print("\nAttempting to insert test message...")
        test_room_id = rooms[0]['room_id'] if rooms else 1
        test_user_id = users[0]['user_id'] if users else 1
        
        cursor.execute("""
            INSERT INTO chat_messages (room_id, user_id, content, msg_type)
            VALUES (%s, %s, 'DEBUG MSG', 'text')
        """, (test_room_id, test_user_id))
        conn.commit()
        print(f"‚úÖ inserted message into room {test_room_id} for user {test_user_id}")
        
        # 6. Read back
        cursor.execute("SELECT * FROM chat_messages WHERE content='DEBUG MSG' ORDER BY created_at DESC LIMIT 1")
        msg = cursor.fetchone()
        print("Read back:", msg)
        
    except Exception as e:
        print(f"‚ùå Error: {e}")
    finally:
        conn.close()

if __name__ == "__main__":
    debug_chat_db()

</file>

<file path="scripts\verify\debug_chat_state.py">
import sys
import os
sys.path.append(os.getcwd())

from backend.repository.db_access import fetch_all
from backend.app import create_app

app = create_app()

with app.app_context():
    print("--- CHAT ROOMS ---")
    rooms = fetch_all("SELECT * FROM chat_rooms ORDER BY created_at DESC LIMIT 5")
    for r in rooms:
        print(f"[{r['room_id']}] {r['name']} (Created by: {r['created_by']})")

    print("\n--- CHAT MEMBERS ---")
    members = fetch_all("SELECT * FROM chat_members ORDER BY joined_at DESC LIMIT 10")
    for m in members:
        print(f"Room {m['room_id']} - User {m['user_id']} ({m['role']})")

    print("\n--- CHAT MESSAGES ---")
    msgs = fetch_all("SELECT * FROM chat_messages ORDER BY created_at DESC LIMIT 5")
    for m in msgs:
        print(f"[{m['room_id']}] User {m['user_id']}: {m['content']}")

</file>

<file path="scripts\verify\debug_db.py">
import os
import sys

# Add project root to path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from backend.repository.db_access import fetch_all, execute_query
from backend.config.db import get_connection

if __name__ == "__main__":
    try:
        print("=== 1. CONNECTING ===")
        conn = get_connection()
        print("   ‚úÖ Connected.")
        
        print("\n=== 2. INSPECTING COLUMNS ===")
        # Get raw columns
        cursor = conn.cursor(dictionary=True)
        cursor.execute("SHOW COLUMNS FROM book_suggestions")
        cols = cursor.fetchall()
        available_columns = {c['Field'] for c in cols}
        print(f"   Available Columns: {available_columns}")
        
        print("\n=== 3. PROBING LOGIC ===")
        # user_id = session["user_id"] -> simulate with 1
        user_id = 1
        
        # 1. ID
        id_col = "suggestion_id" if "suggestion_id" in available_columns else "id"
        print(f"   id_col: {id_col}")
        
        # 2. Notes / Reason
        notes_col = "notes"
        if "notes" not in available_columns and "reason" in available_columns:
            notes_col = "reason"
        print(f"   notes_col: {notes_col}")
        
        # 3. Date
        date_col = "created_at"
        if "created_at" not in available_columns and "suggestion_date" in available_columns:
            date_col = "suggestion_date"
        print(f"   date_col: {date_col}")
            
        # 4. ISBN (optional for display)
        isbn_col = ", isbn" if "isbn" in available_columns else ""
        print(f"   isbn_col: '{isbn_col}'")

        # Construct Query
        query = f"""
            SELECT 
                {id_col} as suggestion_id, 
                title, 
                author, 
                {notes_col} as notes, 
                {date_col} as suggestion_date, 
                status
                {isbn_col}
            FROM book_suggestions 
            WHERE user_id = %s 
            ORDER BY {date_col} DESC
        """
        print(f"\n=== 4. GENERATED QUERY ===\n{query}")
        
        print("\n=== 5. EXECUTING QUERY ===")
        cursor.execute(query, (user_id,))
        rows = cursor.fetchall()
        print(f"   ‚úÖ Query Success! Found {len(rows)} rows.")
        for r in rows:
            print(f"   - {r}")
            
    except Exception as e:
        print(f"\n‚ùå CRITICAL FAILURE: {repr(e)}")
        import traceback
        traceback.print_exc()

</file>

<file path="scripts\verify\debug_group_roles.py">

import sys
import os

sys.path.append(os.getcwd())
from backend.app import create_app
from backend.repository.db_access import fetch_all, fetch_one

app = create_app()

def debug_roles():
    with app.app_context():
        # Find user 'ziya'
        ziya = fetch_one("SELECT user_id FROM users WHERE name LIKE 'ziya%'")
        if not ziya:
            print("User 'ziya' not found.")
            return

        uid = ziya['user_id']
        print(f"Found User 'ziya' (ID: {uid})")
        
        # Find channels ziya is in
        channels = fetch_all("""
            SELECT c.channel_id, c.name, c.created_by, dp.role
            FROM dm_participants dp
            JOIN channels c ON dp.channel_id = c.channel_id
            WHERE dp.user_id = %s
        """, (uid,))
        
        for c in channels:
            print(f"Channel: {c['name']} (ID: {c['channel_id']})")
            print(f"  - Created By: {c['created_by']}")
            print(f"  - Ziya's Role: {c['role']}")
            
            # Fix if needed
            if c['created_by'] != uid:
                print("  ‚ö†Ô∏è Creator Mismatch! Updating creator to Ziya...")
                from backend.repository.db_access import execute_query
                execute_query("UPDATE channels SET created_by = %s WHERE channel_id = %s", (uid, c['channel_id']))
                print("  ‚úÖ Fixed Creator.")
            
            if c['role'] != 'admin':
                print("  ‚ö†Ô∏è Role Mismatch! Updating role to Admin...")
                from backend.repository.db_access import execute_query
                execute_query("UPDATE dm_participants SET role = 'admin' WHERE channel_id = %s AND user_id = %s", (c['channel_id'], uid))
                print("  ‚úÖ Fixed Role.")

if __name__ == "__main__":
    debug_roles()

</file>

<file path="scripts\verify\debug_schema.py">
import sys
import os

# Add project root to path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from backend.repository.db_access import fetch_all

try:
    print("Columns in 'books':")
    books_cols = fetch_all("DESCRIBE books")
    print([c['Field'] for c in books_cols])
    
    print("\nColumns in 'authors':")
    authors_cols = fetch_all("DESCRIBE authors")
    print([c['Field'] for c in authors_cols])
except Exception as e:
    print(e)

</file>

<file path="scripts\verify\debug_user_room.py">
import sys
import os
import mysql.connector
from pathlib import Path
from dotenv import load_dotenv

# Load env
env_path = Path(__file__).parent.parent / '.env'
load_dotenv(dotenv_path=env_path)

def get_connection():
    return mysql.connector.connect(
        host=os.getenv("DB_HOST", "127.0.0.1"),
        user=os.getenv("DB_USER", "app_user"),
        password=os.getenv("DB_PASSWORD", "App@123"),
        database=os.getenv("DB_NAME", "library_db"),
        port=int(os.getenv("DB_PORT", 3306))
    )

def debug_specific():
    print("üîç Inspecting 'ziya' and 'hack club'...")
    conn = get_connection()
    cursor = conn.cursor(dictionary=True)
    
    try:
        # 1. Find User
        cursor.execute("SELECT * FROM users WHERE name LIKE '%ziya%'")
        user = cursor.fetchone()
        if not user:
            print("‚ùå User 'ziya' not found!")
            return
        print(f"‚úÖ User found: ID={user['user_id']}, Name={user['name']}")
        
        # 2. Find Room
        cursor.execute("SELECT * FROM chat_rooms WHERE name LIKE '%hack club%'")
        room = cursor.fetchone()
        if not room:
            print("‚ùå Room 'hack club' not found!")
            # List all rooms
            cursor.execute("SELECT * FROM chat_rooms")
            print("Available rooms:", cursor.fetchall())
            return
        print(f"‚úÖ Room found: ID={room['room_id']}, Name={room['name']}, Type={room.get('room_type')}, Official={room['is_official']}")
        
        # 3. Check Membership
        cursor.execute("SELECT * FROM chat_members WHERE user_id=%s AND room_id=%s", (user['user_id'], room['room_id']))
        member = cursor.fetchone()
        if member:
            print(f"‚úÖ User is member: Role={member['role']}")
        else:
            print("‚ùå User is NOT a member of this room!")
            
        # 4. Check Messages
        cursor.execute("SELECT count(*) as cnt FROM chat_messages WHERE room_id=%s", (room['room_id'],))
        count = cursor.fetchone()['cnt']
        print(f"‚ÑπÔ∏è  Message count for room: {count}")
        
        cursor.execute("SELECT * FROM chat_messages WHERE room_id=%s ORDER BY created_at DESC LIMIT 3", (room['room_id'],))
        msgs = cursor.fetchall()
        print("Last 3 messages:", msgs)

    except Exception as e:
        print(f"‚ùå Error: {e}")
    finally:
        conn.close()

if __name__ == "__main__":
    debug_specific()

</file>

<file path="scripts\verify\deep_health_check.py">

import sys
import os
from dotenv import load_dotenv

# Add root to python path because this script is in scripts/verify/
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '../../')))
load_dotenv(os.path.join(os.path.dirname(__file__), '../../.env'))


def check_structure():
    print("running structure check...")
    required = [
        'backend/__init__.py',
        'backend/routes/admin_routes.py',
        'backend/routes/member_routes.py',
        'static/css/style.css',
        'static/js/js_channel_settings.js',
        'templates/layout.html',
        'templates/member/community.html',
        'templates/member/overview.html',
        'run.py'
    ]
    missing = []
    for f in required:
        if not os.path.exists(f):
            missing.append(f)
    
    if missing:
        print(f"‚ùå Missing critical files: {missing}")
        return False
    print("‚úÖ File structure integrity check passed.")
    return True

def check_imports():
    print("running import check...")
    try:
        from backend import create_app
        from backend.repository.db_access import get_db_connection
        print("‚úÖ Backend module imports successful.")
        return True
    except Exception as e:
        print(f"‚ùå Backend Import Error: {e}")
        return False

def check_db():
    print("checking db connection...")
    try:
        from backend.repository.db_access import get_db_connection
        conn = get_db_connection()
        if conn and conn.is_connected():
            cursor = conn.cursor()
            cursor.execute("SELECT 1")
            conn.close()
            print("‚úÖ Database connection established.")
            return True
        else:
            print("‚ùå Database connection failed (None or not connected).")
            return False
    except Exception as e:
        print(f"‚ùå Database Exception: {e}")
        return False

if __name__ == "__main__":
    print("=== DEEP SYSTEM HEALTH CHECK ===")
    s = check_structure()
    i = check_imports()
    d = check_db()
    
    if s and i and d:
        print("\nüöÄ SYSTEM STATUS: GREEN (ALL SYSTEMS GO)")
        sys.exit(0)
    else:
        print("\n‚ö†Ô∏è SYSTEM STATUS: RED (ISSUES DETECTED)")
        sys.exit(1)

</file>

<file path="scripts\verify\diag.py">
from backend.repository.db_access import fetch_all, fetch_one
import json
from datetime import datetime, date

def default(obj):
    if isinstance(obj, (datetime, date)):
        return obj.isoformat()
    return str(obj)

try:
    cols = fetch_all('DESCRIBE books')
    sample = fetch_one('SELECT * FROM books LIMIT 1')
    
    with open('diag_output.txt', 'w', encoding='utf-8') as f:
        f.write("COLUMNS:\n")
        for c in cols:
            f.write(f"{c['Field']} - {c['Type']}\n")
        f.write("\nSAMPLE ROW:\n")
        f.write(json.dumps(sample, default=default, indent=2))
except Exception as e:
    with open('diag_output.txt', 'w', encoding='utf-8') as f:
        f.write(f"ERROR: {str(e)}")

</file>

<file path="scripts\verify\diagnostic_test.py">

import os
import sys
sys.path.append(os.getcwd())
from backend.app import create_app
app = create_app()

with app.app_context():
    from backend.services.channel_service import save_message
    try:
        user_id = 1
        channel_id = 1
        print(f"Testing save_message for user {user_id}, channel {channel_id}")
        res = save_message(user_id, channel_id, text="Diagnostic Test")
        print(f"Success! Message ID: {res['message_id']}")
    except Exception as e:
        import traceback
        traceback.print_exc()

</file>

<file path="scripts\verify\get_create.py">

import os
import sys
sys.path.append(os.getcwd())
from backend.repository.db_access import fetch_one

try:
    res = fetch_one("SHOW CREATE TABLE chat_messages")
    with open('table_structure.txt', 'w') as f:
        f.write(res['Create Table'])
    print("Saved to table_structure.txt")
except Exception as e:
    print(e)

</file>

<file path="scripts\verify\inspect_schema.py">
from backend.config.db import get_connection

def inspect_table(table_name):
    conn = get_connection()
    cursor = conn.cursor(dictionary=True)
    try:
        cursor.execute(f"DESCRIBE {table_name}")
        columns = cursor.fetchall()
        print(f"\n--- {table_name} ---")
        for col in columns:
            print(f"{col['Field']} ({col['Type']})")
    except Exception as e:
        print(f"Error describing {table_name}: {e}")
    finally:
        cursor.close()
        conn.close()

if __name__ == "__main__":
    inspect_table('users')
    inspect_table('reading_goals')
    inspect_table('books')

</file>

<file path="scripts\verify\schema_check.py">

import os
import sys
sys.path.append(os.getcwd())
from backend.repository.db_access import fetch_all

try:
    cols = fetch_all("DESCRIBE dm_participants")
    for col in cols:
        print(f"{col['Field']}: {col['Type']}")
except Exception as e:
    print(f"Error: {e}")

</file>

<file path="scripts\verify\schema_debug.py">

import sys
import os

# Adjust path so backend imports work
sys.path.append(os.getcwd())

from backend.repository.db_access import fetch_all

print("üîç Checking 'channels' table schema...")
try:
    cols = fetch_all("DESCRIBE channels")
    for c in cols:
        print(f" - {c['Field']} ({c['Type']})")
except Exception as e:
    print(f"‚ùå Error: {e}")

</file>

<file path="scripts\verify\schema_debug_dm.py">

import sys
import os
sys.path.append(os.getcwd())
from backend.repository.db_access import fetch_all

print("üîç Checking 'dm_participants' table schema...")
try:
    cols = fetch_all("DESCRIBE dm_participants")
    for c in cols:
        print(f" - {c['Field']} ({c['Type']})")
except Exception as e:
    print(f"‚ùå Error: {e}")

</file>

<file path="scripts\verify\test_brain.py">
import sys
import os

# Add project root to path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from backend.brain.orchestrator import brain

def test_brain():
    print("üß† Testing Orchestrator...")
    print(f"Model ID: {brain.model_id}")
    
    if not brain.api_token:
        print("‚ùå HF_TOKEN not found!")
        return

    user_input = "Hello! Recommend me a book about space adventure."
    print(f"\nUser: {user_input}")
    
    print("thinking...")
    # The orchestrator now prints "üîç Searching memory..." automatically
    response = brain.process_message(user_input)
    
    print(f"\nAssistant: {response}")

if __name__ == "__main__":
    test_brain()

</file>

<file path="scripts\verify\test_import.py">
import sys
import os
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

try:
    from backend.services import chat_service
    print("Import successful!")
    print(dir(chat_service))
except Exception as e:
    print(f"Import failed: {e}")
    import traceback
    traceback.print_exc()

</file>

<file path="scripts\verify\test_internal.py">
from backend.app import create_app
import json

app = create_app()
client = app.test_client()

print("INTERNAL FETCH TEST:")
# We don't need a real session for the 404 check, it should return 401 if it finds the route
response = client.get('/api/book/get/26')

print(f"Status: {response.status_code}")
print(f"Body Preview: {response.get_data(as_text=True)[:200]}")

if response.status_code == 404:
    print("RESULT: Internal 404! The route is NOT registered in the app instance.")
else:
    print("RESULT: Internal success (or 401/500). The route exists in the app instance.")

</file>

<file path="scripts\verify\test_privacy_logic.py">

import sys
import os

# Ensure backend package is importable
sys.path.append(os.getcwd())

from backend.app import create_app
from backend.services.channel_service import create_channel, get_my_dms
from backend.routes.chat_routes import route_update_channel_settings, get_conversations_route
from backend.repository.db_access import execute, fetch_one, fetch_all
from flask import session

app = create_app()

def test_logic():
    with app.app_context():
        print("--- Starting Backend Logic Test ---")
        
        # 1. Setup Mock User
        # Find a real user or create one
        user_id = 1 # Admin usually
        session['user_id'] = user_id
        session['role'] = 'admin'
        
        print(f"Mocking User ID: {user_id}")
        
        # 2. Create Public Group
        # Directly call service to avoid route overhead, or mocking request?
        # Let's call service for creation, then route for update (since route has the fix logic)
        
        # Create Public Channel
        print("\n[Action] Creating Public Channel via Service...")
        cid = create_channel(
            guild_id=None, 
            category_id=None, 
            name="LogicTest_Public", 
            type="text", 
            is_private=False, 
            creator_id=user_id
        )
        print(f"Created Channel ID: {cid}")
        
        # Verify in Conversations -> Public
        # We need to mock 'get_conversations_route' or call the queries directly.
        # Let's call the route function, but it returns a Response object (jsonify).
        
        print("[Check] Verifying in Public List...")
        # get_conversations_route returns jsonify response
        resp = get_conversations_route()
        data = resp.get_json()
        
        public_list = data['conversations']['public']
        in_public = any(c['channel_id'] == cid for c in public_list)
        
        if in_public:
            print("PASS: Found in Public List")
        else:
            print("FAIL: Not in Public List")
            return

        # 3. Toggle to Private using the ROUTE (to trigger the fix in chat_routes.py)
        print("\n[Action] Toggling to Private via Route...")
        
        # Need to mock request.form and request.files
        with app.test_request_context(
            f'/chat/channels/{cid}/settings',
            method='POST',
            data={'is_private': 'true', 'type': 'text'}
        ):
            # Session needs to be set again in this context?
            session['user_id'] = user_id
            session['role'] = 'admin'
            
            # Call route handler directly
            resp = route_update_channel_settings(cid)
            res_data = resp.get_json()
            
            if res_data.get('success'):
                print("Update Success")
            else:
                print(f"Update Failed: {res_data}")
                return

        # 4. Verify in Private Group List
        print("[Check] Verifying in Private Group List...")
        resp = get_conversations_route()
        data = resp.get_json()
        
        group_list = data['conversations']['group']
        in_group = any(c['channel_id'] == cid for c in group_list)
        
        if in_group:
            print("PASS: Found in Private Group List")
        else:
            print("FAIL: Not in Private Group List")
            # Check DB participants
            parts = fetch_all("SELECT * FROM dm_participants WHERE channel_id = %s", (cid,))
            print(f"DB Participants: {parts}")
            return

        # 5. Toggle back to Public
        print("\n[Action] Toggling back to Public via Route...")
        with app.test_request_context(
            f'/chat/channels/{cid}/settings',
            method='POST',
            data={'is_private': 'false', 'type': 'text'}
        ):
            session['user_id'] = user_id
            session['role'] = 'admin'
            
            resp = route_update_channel_settings(cid)
            
        # 6. Verify in Public List
        print("[Check] Verifying in Public List (Revert)...")
        resp = get_conversations_route()
        data = resp.get_json()
        
        public_list = data['conversations']['public']
        in_public = any(c['channel_id'] == cid for c in public_list)
        
        if in_public:
            print("PASS: Found in Public List after revert")
        else:
            print("FAIL: Not in Public List after revert")
            return

        print("\n--- ALL LOGIC TESTS PASSED ---")

if __name__ == "__main__":
    test_logic()

</file>

<file path="scripts\verify\test_ratelimit.py">
import os
import sys
import time

root_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
sys.path.append(root_dir)

from backend.utils.rate_limiter import check_rate_limit

def test_ratelimit():
    print("üö¶ Testing Rate Limiter (5 req / 2 sec)...")
    key = "user:test:123"
    
    # Burst 5
    for i in range(5):
        allowed = check_rate_limit(key)
        print(f"Req {i+1}: {'‚úÖ Allowed' if allowed else '‚ùå Blocked'}")
        if not allowed:
            print("‚ùå Error: Should have been allowed!")
            return

    # 6th should fail
    allowed = check_rate_limit(key)
    print(f"Req 6: {'‚úÖ Allowed' if allowed else 'üõ°Ô∏è Blocked correctly'}")
    if allowed:
        print("‚ùå Error: Should have been blocked!")
        return
        
    print("‚è≥ Waiting 2 seconds for refill...")
    time.sleep(2.1)
    
    # Should work again
    allowed = check_rate_limit(key)
    print(f"Req 7 (After Wait): {'‚úÖ Allowed' if allowed else '‚ùå Blocked'}")
    if not allowed:
        print("‚ùå Error: Should have refilled!")
        return

    print("üéâ Rate Limiter works!")

if __name__ == "__main__":
    test_ratelimit()

</file>

<file path="scripts\verify\test_routes.py">
from backend.app import create_app

app = create_app()

print("SEARCHING FOR BOOK API ROUTE:")
found = False
for rule in app.url_map.iter_rules():
    if "/admin/api/book/" in rule.rule:
        print(f"FOUND: {rule.rule} | Endpoint: {rule.endpoint}")
        found = True

if not found:
    print("CRITICAL: Book API route NOT found in current code state!")
else:
    print("SUCCESS: Route is present in code. If user gets 404, server RESTART is needed.")

</file>

<file path="scripts\verify\test_socket_flow.py">
import sys
import os
import time
import socketio

# Add project root to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Create standard python-socketio client
sio = socketio.Client()

@sio.event
def connect():
    print("‚úÖ [Client] Connected!")
    
@sio.event
def connect_error(data):
    print(f"‚ùå [Client] Connection failed: {data}")

@sio.event
def disconnect():
    print("‚ùå [Client] Disconnected")

@sio.event
def receive_message(data):
    print(f"üì© [Client] Received message: {data}")

@sio.event
def error(data):
    print(f"‚ùå [Client] Error: {data}")

def run_test():
    print("üöÄ Starting SocketIO Test Client...")
    
    # Needs a valid cookie/session? 
    # Our socket_service checks session.get('user_id').
    # Standard socketio client doesn't share Flask session automatically.
    # We might get rejected by 'handle_connect'.
    
    # Try connecting
    try:
        sio.connect('http://127.0.0.1:5000')
        print("‚è≥ Waiting for connection...")
        time.sleep(1)
        
        if sio.connected:
            # Join room
            print("Joining room 1...")
            sio.emit('join_room', {'room_id': 1})
            time.sleep(1)
            
            # Send message
            print("Sending message...")
            sio.emit('send_message', {'room_id': 1, 'message': 'TEST MSG FROM SCRIPT'})
            time.sleep(2)
            
            sio.disconnect()
        else:
            print("‚ö†Ô∏è Client not connected.")
            
    except Exception as e:
        print(f"üî• Exception: {e}")

if __name__ == "__main__":
    run_test()

</file>

<file path="scripts\verify\verify_api.py">

import requests
import sys
import os
sys.path.append(os.getcwd())

# Setup Flask Context to use DB
from backend.app import create_app
from backend.repository.db_access import execute, fetch_one
from backend.utils.security import hash_password

app = create_app()
BASE_URL = "http://127.0.0.1:5000"
TEST_EMAIL = "tester@automation.com"
TEST_PASS = "AutoTest@123"

def setup_test_user():
    with app.app_context():
        print("üõ†Ô∏è Setting up test user...")
        # Check if exists
        user = fetch_one("SELECT user_id FROM users WHERE email = %s", (TEST_EMAIL,))
        if not user:
            print("   Creating new test user...")
            pw_hash = hash_password(TEST_PASS)
            execute("""
                INSERT INTO users (email, password_hash, name, role, must_change_password)
                VALUES (%s, %s, 'Automation Tester', 'member', FALSE)
            """, (TEST_EMAIL, pw_hash))
            print("   ‚úÖ Test user created.")
        else:
            # Update password to be sure
            print("   Updating existing test user password...")
            pw_hash = hash_password(TEST_PASS)
            execute("UPDATE users SET password_hash = %s WHERE email = %s", (pw_hash, TEST_EMAIL))
            print("   ‚úÖ Test user updated.")

def verify_full_flow():
    session = requests.Session()
    
    # 1. Login
    print(f"üîë Logging in as {TEST_EMAIL}...")
    res = session.post(f"{BASE_URL}/", data={'email': TEST_EMAIL, 'password': TEST_PASS})
    
    # Check if we got redirected (Success) or stayed on login (Fail)
    if res.history and res.history[0].status_code == 302:
        print("‚úÖ Login Successful (Redirected)")
    elif "dashboard" in res.text or "Logout" in res.text:
         print("‚úÖ Login Successful (Dashboard found)")
    else:
        print("‚ùå Login Failed.")
        print(f"   Final URL: {res.url}")
        return

    # 2. Check Conversations
    print("\nChecking /chat/conversations...")
    res = session.get(f"{BASE_URL}/chat/conversations")
    if res.status_code == 200:
        try:
            data = res.json()
            if data['success']:
                print(f"‚úÖ API OK. DMs: {len(data['conversations']['personal'])}")
            else:
                print(f"‚ùå API returned success=False: {data}")
        except:
             print(f"‚ùå Invalid JSON: {res.text[:100]}")
    else:
        print(f"‚ùå HTTP {res.status_code}")

    # 3. Check Pending Invites
    print("\nChecking /chat/invites/pending...")
    res = session.get(f"{BASE_URL}/chat/invites/pending")
    if res.status_code == 200:
        print("‚úÖ Invites Endpoint OK")
    else:
        print(f"‚ùå Invites Endpoint Failed: {res.status_code}")

if __name__ == "__main__":
    setup_test_user()
    verify_full_flow()

</file>

<file path="scripts\verify\verify_backend_logic.py">
import os
import sys

root_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
sys.path.append(root_dir)

from backend.services.guild_service import get_my_guilds, get_guild_details, create_guild
from backend.services.channel_service import create_channel, save_message
from backend.repository.db_access import fetch_one

def test_logic():
    print("üß™ Testing Backend Services...")
    
    # 1. Get a test user
    user = fetch_one("SELECT user_id, name FROM users LIMIT 1")
    if not user:
        print("‚ùå No users found.")
        return
    user_id = user['user_id']
    print(f"üë§ Test User: {user['name']} (ID: {user_id})")
    
    # 2. List Guilds
    try:
        guilds = get_my_guilds(user_id)
        print(f"‚úÖ get_my_guilds returned {len(guilds)} guilds.")
    except Exception as e:
        print(f"‚ùå get_my_guilds failed: {e}")
        return

    # 3. Create Guild if none
    if not guilds:
        print("   -> Creating test guild...")
        try:
            gid = create_guild(user_id, "Test Server")
            print(f"‚úÖ Created Guild ID: {gid}")
            guilds = [{'guild_id': gid, 'name': "Test Server"}]
        except Exception as e:
            print(f"‚ùå create_guild failed: {e}")
            return
            
    # 4. Get Details
    guild_id = guilds[0]['guild_id']
    try:
        details = get_guild_details(guild_id)
        print("‚úÖ get_guild_details success.")
        print(f"   Structure: {list(details.keys())}")
        print(f"   Hierarchy Nodes: {len(details['hierarchy'])}")
    except Exception as e:
        print(f"‚ùå get_guild_details failed: {e}")
        return

    print("üéâ Backend logic seems fine!")

if __name__ == "__main__":
    test_logic()

</file>

<file path="scripts\verify\verify_categorization.py">

import sys
import os
import requests

# Adjust if we want to test via API locally
BASE_URL = "http://127.0.0.1:5000"
session = requests.Session()

def verify_categorization():
    email = "tester@automation.com"
    password = "AutoTest@123"
    
    # Login
    print("üîë Logging in...")
    res = session.post(f"{BASE_URL}/", data={'email': email, 'password': password})
    if res.status_code != 200:
        print("‚ùå Login failed")
        return

    # 1. Create Public Group
    print("üì¢ Creating Public Group...")
    res = session.post(f"{BASE_URL}/chat/channels", json={
        'name': 'Auto Public Group',
        'type': 'text',
        'is_private': False
    })
    pub_id = res.json().get('channel_id')
    print(f"   - Created Public ID: {pub_id}")

    # 2. Create Private Group
    print("üîí Creating Private Group...")
    res = session.post(f"{BASE_URL}/chat/channels", json={
        'name': 'Auto Private Group',
        'type': 'text',
        'is_private': True
    })
    priv_id = res.json().get('channel_id')
    print(f"   - Created Private ID: {priv_id}")
    
    # 3. Fetch Conversations
    print("üìú Fetching Sidebar...")
    res = session.get(f"{BASE_URL}/chat/conversations")
    data = res.json()
    
    if not data.get('success'):
        print("‚ùå Failed to fetch conversations")
        return
        
    convs = data['conversations']
    
    # Check Public
    public_found = any(c['channel_id'] == pub_id for c in convs['public'])
    if public_found:
        print("‚úÖ Public group found in 'public' list.")
    else:
        print("‚ùå Public group MISSING from 'public' list.")
        
    # Check Private (should be in 'group' list)
    private_found = any(c['channel_id'] == priv_id for c in convs['group'])
    if private_found:
        print("‚úÖ Private group found in 'group' list.")
    else:
        print("‚ùå Private group MISSING from 'group' list.")
        # Debug: check where it is
        if any(c['channel_id'] == priv_id for c in convs['personal']):
             print("   ‚ö†Ô∏è It was found in 'personal' list instead.")
        elif any(c['channel_id'] == priv_id for c in convs['public']):
             print("   ‚ö†Ô∏è It was found in 'public' list instead.")

if __name__ == "__main__":
    verify_categorization()

</file>

<file path="scripts\verify\verify_channel_fix.py">

from backend.services.channel_service import create_channel
from backend.repository.db_access import execute

# Mock setup if needed, but we can just use DB directly as we are on backend
print("üß™ Testing Channel Creation fix...")

# Create a test channel (NULL guild for global/public test)
try:
    # Use a dummy guild_id if foreign key constraint exists, or None if nullable
    # Assuming guild_id can be NULL for public hub based on earlier schema analysis
    # If fails, we might need a valid guild. Let's try to create one first or use '1' if we know it exists.
    # Actually, create_channel(guild_id, category, name...)
    # We'll use 0 or None.
    
    cid = create_channel(None, None, "Test Channel Fix", "text", "Testing ID Return")
    
    print(f"‚úÖ Returned Channel ID: {cid}")
    
    if cid and cid > 0:
        print("‚úÖ SUCCESS: create_channel returning valid ID")
        # Cleanup
        execute("DELETE FROM channels WHERE channel_id = %s", (cid,))
        print("üßπ Cleanup complete")
    else:
        print(f"‚ùå FAILURE: create_channel returned invalid ID: {cid}")
        
except Exception as e:
    print(f"‚ùå EXCEPTION: {e}")

</file>

<file path="scripts\verify\verify_chat_privacy.py">

from playwright.sync_api import sync_playwright
import time

def test_chat_privacy_toggle():
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True) # Run headless for speed, or False to watch
        context = browser.new_context()
        page = context.new_page()

        # 1. Login
        print("Logging in...")
        page.goto("http://127.0.0.1:5000/login")
        page.fill("input[name='email']", "admin@library.com") # Assuming admin account exists
        page.fill("input[name='password']", "admin123")
        page.click("button:has-text('Login')")
        page.wait_for_url("**/dashboard")
        
        # Go to Community
        print("Navigating to Community...")
        page.goto("http://127.0.0.1:5000/community")
        
        # 2. Create Public Group
        group_name = f"TestGroup_{int(time.time())}"
        print(f"Creating Public Group: {group_name}")
        page.click("button[title='Create Group']")
        page.fill("#newGroupName", group_name)
        page.select_option("#groupPrivacy", "public") # Public Hub
        page.click("button:has-text('Create Group')")
        
        # Wait for reload/update
        time.sleep(2)
        
        # 3. Verify in Public Tab
        print("Verifying in Public Tab...")
        page.click("#tab-public")
        time.sleep(1)
        if page.locator(f".chat-name:has-text('{group_name}')").is_visible():
            print("PASS: Group found in Public Tab")
        else:
            print("FAIL: Group NOT found in Public Tab")
            print(page.inner_html("#dynamicChatList"))
            return

        # 4. Switch to Private
        print("Switching to Private...")
        # Open settings for the new group (it should be active)
        page.click("#chatSettingsBtn")
        time.sleep(1)
        
        # Change type to Private
        page.select_option("#chatTypeSelect", "private")
        page.click("button:has-text('Save Changes')")
        
        # Handle alert
        # (Playwright handles dialogs automatically by dismissing, but we want to accept?)
        # Actually page.on('dialog') needs to be set up if we need to interact, but default dismissal might be issue if it's confirm.
        # But 'Save Changes' usually just alerts success.
        
        time.sleep(2) # Wait for fetchConversations
        
        # 5. Verify in Private Groups Tab
        print("Verifying in Private Groups Tab...")
        page.click("#tab-group") # Private Groups tab
        time.sleep(1)
        
        if page.locator(f".chat-name:has-text('{group_name}')").is_visible():
            print("PASS: Group found in Private Groups Tab")
        else:
            print("FAIL: Group NOT found in Private Groups Tab")
            # Check Public tab just in case
            page.click("#tab-public")
            if page.locator(f".chat-name:has-text('{group_name}')").is_visible():
                print("... But it is still in Public Tab!")
            else:
                 print("... And it is NOT in Public Tab either. It disappeared.")
            return

        # 6. Switch back to Public
        print("Switching back to Public...")
        # Since we are in the group tab and it's visible (hopefully), click it to make sure it's active
        # page.click(f".chat-name:has-text('{group_name}')") 
        # Open settings
        page.click("#chatSettingsBtn")
        time.sleep(1)
        
        page.select_option("#chatTypeSelect", "public")
        page.click("button:has-text('Save Changes')")
        time.sleep(2)
        
        # 7. Verify in Public Tab
        print("Verifying in Public Tab (After Revert)...")
        page.click("#tab-public")
        time.sleep(1)
        
        if page.locator(f".chat-name:has-text('{group_name}')").is_visible():
            print("PASS: Group returned to Public Tab")
        else:
             print("FAIL: Group NOT found in Public Tab after revert")
             
        browser.close()

if __name__ == "__main__":
    try:
        test_chat_privacy_toggle()
    except Exception as e:
        print(f"Test Error: {e}")

</file>

<file path="scripts\verify\verify_chat_privacy_backend.py">

import requests
import time
import sys

BASE_URL = "http://127.0.0.1:5000"
EMAIL = "admin@library.com"
PASSWORD = "admin123"

def run_test():
    s = requests.Session()
    
    # 1. Login
    print(f"Logging in as {EMAIL}...")
    res = s.post(f"{BASE_URL}/", data={"email": EMAIL, "password": PASSWORD})
    if "Dashboard" not in res.text and res.status_code != 200:
        print("Login Failed")
        print(res.text[:500])
        return

    # 2. Creates Public Group
    group_name = f"TestGroup_Back_{int(time.time())}"
    print(f"Creating Public Group: {group_name}")
    
    # API for create channel?
    # Found in chat_routes.py: @chat_bp.route('/channels', methods=['POST'])
    # Payload: guild_id, name, type, is_private
    
    payload = {
        "guild_id": None, # Global
        "name": group_name,
        "type": "text",
        "is_private": False
    }
    
    res = s.post(f"{BASE_URL}/chat/channels", json=payload)
    if res.status_code != 200:
        print(f"Failed to create group: {res.text}")
        return
        
    try:
        data = res.json()
    except:
        print(f"JSON Decode Error. Status: {res.status_code}")
        print(f"Response: {res.text}")
        return
        
    channel_id = data['channel_id']
    print(f"Created Channel ID: {channel_id}")
    
    # 3. Verify in Public Tab
    print("Verifying in Public List...")
    res = s.get(f"{BASE_URL}/chat/conversations")
    convs = res.json().get('conversations', {})
    
    public_list = convs.get('public', [])
    found = any(c['channel_id'] == channel_id for c in public_list)
    
    if found:
        print("PASS: Group found in 'public' list")
    else:
        print("FAIL: Group NOT found in 'public' list")
        print("Public List:", [c['name'] for c in public_list])
        return

    # 4. Switch to Private
    print("Switching to Private...")
    # Route: /channels/<int:channel_id>/settings (POST)
    # Form Data: is_private (true/false), type
    
    update_data = {
        "is_private": "true",
        "type": "text"
    }
    
    # Use multipart form data check?
    # requests handles dict as form-encoded by default if not json param
    res = s.post(f"{BASE_URL}/chat/channels/{channel_id}/settings", data=update_data)
    
    if res.json().get('success'):
        print("Update Successful")
    else:
        print(f"Update Failed: {res.text}")
        return
        
    # 5. Verify in Private Groups Tab
    print("Verifying in Private Groups List...")
    res = s.get(f"{BASE_URL}/chat/conversations")
    convs = res.json().get('conversations', {})
    
    group_list = convs.get('group', [])
    found = any(c['channel_id'] == channel_id for c in group_list)
    
    if found:
        print("PASS: Group found in 'group' list")
    else:
        print("FAIL: Group NOT found in 'group' list")
        print("Group List:", [c['name'] for c in group_list])
        # Check if it's still in public?
        public_list = convs.get('public', [])
        if any(c['channel_id'] == channel_id for c in public_list):
            print("... It is still in 'public' list!")
        return

    # 6. Switch back to Public
    print("Switching back to Public...")
    update_data = {
        "is_private": "false",
        "type": "text"
    }
    res = s.post(f"{BASE_URL}/chat/channels/{channel_id}/settings", data=update_data)
    
    if not res.json().get('success'):
        print(f"Update Revert Failed: {res.text}")
        return

    # 7. Verify in Public Tab
    print("Verifying in Public List (After Revert)...")
    res = s.get(f"{BASE_URL}/chat/conversations")
    convs = res.json().get('conversations', {})
    
    public_list = convs.get('public', [])
    found = any(c['channel_id'] == channel_id for c in public_list)
    
    if found:
        print("PASS: Group returned to 'public' list")
    else:
        print("FAIL: Group NOT found in 'public' list")
        
    print("TEST COMPLETED SUCCESSFULLY")

if __name__ == "__main__":
    try:
        run_test()
    except Exception as e:
        print(f"Error: {e}")

</file>

<file path="scripts\verify\verify_community.py">
import requests


BASE_URL = "http://127.0.0.1:5000"
LOGIN_URL = f"{BASE_URL}/login"
LEADERBOARD_API = f"{BASE_URL}/member/api/leaderboard"
PROFILE_URL = f"{BASE_URL}/member/profile/1" # Assuming user 1 exists

session = requests.Session()

def login():
    print("üîë Logging in...")
    # Using the test user credentials
    payload = {
        "email": "tester@automation.com",
        "password": "securepassword123"
    }
    try:
        res = session.post(LOGIN_URL, data=payload)
        if res.url == f"{BASE_URL}/member/dashboard":
            print("‚úÖ Login Successful")
            return True
        else:
            print(f"‚ùå Login Failed. Redirected to: {res.url}")
            return False
    except Exception as e:
        print(f"‚ùå Connection Failed: {e}")
        return False

def check_leaderboard():
    print("\nüèÜ Checking Leaderboard API...")
    try:
        res = session.get(LEADERBOARD_API)
        if res.status_code == 200:
            data = res.json()
            print(f"‚úÖ API Success. Records found: {len(data)}")
            if len(data) > 0:
                print(f"   Top User: {data[0].get('name')} ({data[0].get('books_read')} books)")
        else:
            print(f"‚ùå API Failed: {res.status_code}")
    except Exception as e:
        print(f"‚ùå API Error: {e}")

def check_public_profile():
    print("\nüë§ Checking Public Profile Route...")
    try:
        # Note: If user 1 is the logged in user, it might redirect.
        # But we just want to ensure it doesn't 500.
        res = session.get(PROFILE_URL)
        if res.status_code == 200:
            print("‚úÖ Profile Page Loaded (200 OK)")
            if "Reader Profile" in res.text:
                print("‚úÖ Content verified")
        elif res.status_code == 302:
             print(f"‚ÑπÔ∏è Redirected (Expected if viewing self): {res.headers['Location']}")
        else:
            print(f"‚ùå Page Failed: {res.status_code}")
    except Exception as e:
        print(f"‚ùå Profile Error: {e}")

if __name__ == "__main__":
    if login():
        check_leaderboard()
        check_public_profile()

</file>

<file path="scripts\verify\verify_history.py">

import requests
import sys

BASE_URL = "http://127.0.0.1:5000"
s = requests.Session()

def verify_history_structure():
    # 1. Login
    print("üîë Logging in...")
    s.post(f"{BASE_URL}/", data={'email': 'tester@automation.com', 'password': 'AutoTest@123'})
    
    # 2. Get Global Channel Messages (ID 1)
    print("üì• Fetching history for Channel 1...")
    res = s.get(f"{BASE_URL}/chat/channels/1/messages")
    
    if res.status_code == 200:
        data = res.json()
        msgs = data.get('messages', [])
        print(f"‚úÖ Fetched {len(msgs)} messages.")
        
        found_attachment = False
        for m in msgs:
            if m.get('attachment'):
                print(f"üì∏ Found Attachment Metadata: {m['attachment']}")
                found_attachment = True
                if 'url' in m['attachment'] and 'type' in m['attachment']:
                    print("   ‚úÖ Structure is correct (url + type present)")
                else:
                    print("   ‚ùå Structure incomplete!")
                    
        if not found_attachment:
            print("‚ö†Ô∏è No attachments found in history to verify (Try uploading one manually first).")
    else:
        print(f"‚ùå Failed to fetch history: {res.status_code}")

if __name__ == "__main__":
    verify_history_structure()

</file>

<file path="scripts\verify\verify_id_search.py">

import sys
import os
import requests
import json

BASE_URL = "http://127.0.0.1:5000"
EMAIL = "admin@library.com"
PASSWORD = "admin123"

def run_test():
    s = requests.Session()
    
    # Login
    print("Logging in...")
    try:
        s.post(f"{BASE_URL}/", data={"email": EMAIL, "password": PASSWORD})
    except:
        print("Server likely not running.")
        return

    # Test Search
    query = "#1000000005"
    print(f"Searching for '{query}'...")
    
    url = f"{BASE_URL}/member/search_users_json"
    res = s.get(url, params={"q": query})
    
    print(f"Status: {res.status_code}")
    print(f"Response: {res.text}")
    
    try:
        data = res.json()
        users = data.get('users', [])
        print(f"Users Found: {len(users)}")
        for u in users:
            print(f" - {u['name']} (ID: {u['user_id']})")
    except:
        print("Failed to parse JSON")

if __name__ == "__main__":
    run_test()

</file>

<file path="scripts\verify\verify_invites.py">

import requests
import sys

BASE_URL = "http://127.0.0.1:5000"
s = requests.Session()

def verify_invites():
    # 1. Login
    print("üîë Logging in...")
    try:
        res = s.post(f"{BASE_URL}/", data={'email': 'tester@automation.com', 'password': 'AutoTest@123'})
        if res.status_code != 200:
            print(f"‚ùå Login failed. Status: {res.status_code}, Response: {res.text[:200]}")
            return
    except Exception as e:
        print(f"‚ùå Connection failed: {e}")
        return

    # 2. Check Pending Invites
    print("üì© Fetching Pending Invites...")
    res = s.get(f"{BASE_URL}/chat/invites/pending")
    
    if res.status_code == 200:
        try:
            data = res.json()
        except Exception:
            print(f"‚ùå JSON Decode Error. Body: {res.text[:500]}")
            return
        if data.get('success'):
            invites = data.get('invites', [])
            print(f"‚úÖ API Success. Pending Invites Count: {len(invites)}")
            for inv in invites:
                print(f"   - Invite ID: {inv['invite_id']}, From: {inv['sender_name']}, Type: {inv['type']}")
        else:
            print(f"‚ùå API Error: {data}")
    else:
        print(f"‚ùå Request Failed: {res.status_code}")

if __name__ == "__main__":
    verify_invites()

</file>

<file path="scripts\verify\verify_logs_rules.py">

import sys
import os
import requests

BASE_URL = "http://127.0.0.1:5000"
EMAIL = "admin@library.com"
PASSWORD = "admin123"

def run_test():
    s = requests.Session()
    
    # login
    print("Logging in...")
    try:
        s.post(f"{BASE_URL}/", data={"email": EMAIL, "password": PASSWORD})
    except:
        print("Server likely not running. Skipping live test.")
        return

    # Use Channel IDs 1 (Global)
    cid = 1
    
    # 1. Update Rules
    print("Test 1: Updating Rules...")
    try:
        res = s.post(f"{BASE_URL}/chat/channels/{cid}/rules", json={"rules": "Rule A: No spam.\nRule B: Be cool."})
        print(f"Status: {res.status_code}, Response: {res.json()}")
    except Exception as e:
        print(f"Update Rules Failed: {e}")

    # 2. Get Rules
    print("\nTest 2: Fetching Rules...")
    try:
        res = s.get(f"{BASE_URL}/chat/channels/{cid}/rules")
        data = res.json()
        print(f"Rules: {data.get('rules')}")
    except Exception as e:
        print(f"Get Rules Failed: {e}")

    # 3. Get Logs (Update Rule should have logged)
    print("\nTest 3: Fetching Logs...")
    try:
        res = s.get(f"{BASE_URL}/chat/channels/{cid}/logs")
        data = res.json()
        logs = data.get('logs', [])
        print(f"Found {len(logs)} logs.")
        if len(logs) > 0:
            print(f"Latest Log: {logs[0]}")
    except Exception as e:
        print(f"Get Logs Failed: {e}")

if __name__ == "__main__":
    run_test()

</file>

<file path="scripts\verify\verify_members.py">

import sys
import os
import requests
import json

BASE_URL = "http://127.0.0.1:5000"
EMAIL = "admin@library.com"
PASSWORD = "admin123"

def run_test():
    s = requests.Session()
    
    # login
    print("Logging in...")
    try:
        s.post(f"{BASE_URL}/", data={"email": EMAIL, "password": PASSWORD})
    except:
        print("Server likely not running.")
        return

    # Fetch Conversations to find a group channel
    print("Fetching conversations...")
    res = s.get(f"{BASE_URL}/chat/conversations")
    data = res.json()
    
    groups = data.get('conversations', {}).get('group', [])
    if not groups:
        print("No groups found. Checking Global Chat (ID 1)...")
        cid = 1
    else:
        cid = groups[0]['channel_id']
        print(f"Testing with Group: {groups[0]['name']} (ID: {cid})")

    # Fetch Members
    print(f"\nFetching members for Channel {cid}...")
    res = s.get(f"{BASE_URL}/chat/channels/{cid}/members")
    m_data = res.json()
    
    if m_data.get('success'):
        members = m_data.get('members', [])
        print(f"Total Members: {len(members)}")
        print("-" * 40)
        for m in members:
            # Print details to see if name/role is correct
            role_str = m['role']
            if m.get('is_owner'): role_str += " (OWNER)"
            print(f"User: {m['name']} | ID: {m['user_id']} | Role: {role_str}")
        print("-" * 40)
    else:
        print(f"Failed to fetch members: {m_data}")

if __name__ == "__main__":
    run_test()

</file>

<file path="scripts\verify\verify_members_debug.py">

import sys
import os
import requests
import json

BASE_URL = "http://127.0.0.1:5000"
EMAIL = "admin@library.com"
PASSWORD = "admin123"

def run_test():
    s = requests.Session()
    
    print("Logging in...")
    try:
        res = s.post(f"{BASE_URL}/", data={"email": EMAIL, "password": PASSWORD})
        if res.status_code != 200:
            print(f"Login failed: {res.status_code}")
            return
    except:
        print("Server likely not running.")
        return

    print("Fetching conversations...")
    res = s.get(f"{BASE_URL}/chat/conversations")
    try:
        data = res.json()
    except:
        print(f"Failed to parse JSON. Status: {res.status_code}")
        print(f"Response Text: {res.text[:500]}...") # Print preview
        return

    groups = data.get('conversations', {}).get('group', [])
    if not groups:
        print("No groups found. Checking specific channel ID 2...")
        cid = 2
    else:
        cid = groups[0]['channel_id']
        print(f"Testing with Group: {groups[0]['name']} (ID: {cid})")

    print(f"\nFetching members for Channel {cid}...")
    res = s.get(f"{BASE_URL}/chat/channels/{cid}/members")
    try:
        m_data = res.json()
        members = m_data.get('members', [])
        print(f"Total Members: {len(members)}")
        for m in members:
            role_str = m['role']
            if m.get('is_owner'): role_str += " (OWNER)"
            print(f"User: {m['name']} | ID: {m['user_id']} | Role: {role_str}")
    except:
        print(f"Failed to parse Members JSON. Status: {res.status_code}")
        print(f"Response: {res.text[:500]}")

if __name__ == "__main__":
    run_test()

</file>

<file path="scripts\verify\verify_message_dates.py">
import sys
import os
sys.path.append(os.getcwd())

from backend.chat.message_engine import message_engine
from datetime import datetime

print("Testing get_recent_messages serialization...")

# Fetch messages for room 1 (General Lounge, assumed to exist/have msgs)
# Or create a dummy one if needed, but existing DB has data.
try:
    msgs = message_engine.get_recent_messages(1, limit=5)
    
    if not msgs:
        print("‚ö†Ô∏è No messages found in room 1. Cannot verify.")
    else:
        fail = False
        for m in msgs:
            created_at = m['created_at']
            if isinstance(created_at, datetime):
                 print(f"‚ùå FAIL: Message {m['message_id']} has datetime object: {created_at}")
                 fail = True
            elif isinstance(created_at, str):
                 print(f"‚úÖ PASS: Message {m['message_id']} has string: {created_at}")
            else:
                 print(f"‚ùì UNKNOWN: Message {m['message_id']} has type {type(created_at)}")
        
        if not fail:
            print("\nüéâ ALL CHECKS PASSED: Dates are JSON serializable.")
        else:
            print("\n‚ùå CHECKS FAILED.")

except Exception as e:
    print(f"‚ùå EXECUTION A ERROR: {e}")

</file>

<file path="scripts\verify\verify_recs.py">
import requests

import re

BASE_URL = "http://127.0.0.1:5000"
LOGIN_URL = f"{BASE_URL}/login"
OVERVIEW_URL = f"{BASE_URL}/member/dashboard"

session = requests.Session()

def login():
    print("üîë Logging in...")
    payload = {
        "email": "tester@automation.com",
        "password": "securepassword123"
    }
    try:
        res = session.post(LOGIN_URL, data=payload)
        is_success = res.url == OVERVIEW_URL or "/member/dashboard" in res.url
        print(f"‚úÖ Login {'Successful' if is_success else 'Failed'}")
        return is_success
    except Exception as e:
        print(f"‚ùå Connection Failed: {e}")
        return False

def check_recommendations():
    print("\nüîÆ Checking Recommendations...")
    try:
        res = session.get(OVERVIEW_URL)
        if res.status_code == 200:
            # Simple substring check instead of bs4 dependency if prefered, 
            # but regex is good for counting.
            
            # Check for container
            if "recommendations-container" in res.text:
                print("‚úÖ Netflix UI Container Found")
            else:
                print("‚ùå UI Container Missing")
            
            # Count Recs
            count = res.text.count("recommendation-card")
            print(f"üìö Found {count} recommendation cards")
            
            # Check for new metadata
            if 'background-image: url(' in res.text:
                 print("‚úÖ Real Cover Images Detected")
            else:
                 print("‚ö†Ô∏è No Real Covers Found (Might be using gradients)")
                 
            if 'line-clamp: 3' in res.text:
                 print("‚úÖ Description Truncation CSS Found")
            
            # Check for match percentage (logic verification)
            if "Match" in res.text:
                print("‚úÖ Match Percentage Displayed")
            
        else:
            print(f"‚ùå Page Failed: {res.status_code}")
    except Exception as e:
        print(f"‚ùå Error: {e}")

if __name__ == "__main__":
    if login():
        check_recommendations()

</file>

<file path="scripts\verify\verify_search.py">

import sys
import os
import requests

# Add project root to path (though requests uses URL)
BASE_URL = "http://127.0.0.1:5000"
EMAIL = "admin@library.com"
PASSWORD = "admin123"

def run_test():
    s = requests.Session()
    
    # 1. Login
    print(f"Logging in as {EMAIL}...")
    # Use / based on previous finding
    res = s.post(f"{BASE_URL}/", data={"email": EMAIL, "password": PASSWORD})
    if "Dashboard" not in res.text and res.status_code != 200:
        print("Login Failed")
        return

    # 2. Search by Name (Control Test)
    print("\nTest 1: Search by Name 'Admin'...")
    res = s.get(f"{BASE_URL}/member/search_users_json?q=Admin")
    data = res.json()
    users = data.get('users', [])
    print(f"Found {len(users)} users.")
    if len(users) > 0:
        print(f"Sample: {users[0]['name']} (ID: {users[0]['user_id']})")
    
    if not users:
        print("FAIL: Name search failed.")
        return

    # Get an ID to test with
    target_id = users[0]['user_id']
    public_id_str = f"#{1000000000 + target_id}"
    
    # 3. Search by ID (Target Test)
    print(f"\nTest 2: Search by ID '{public_id_str}'...")
    res = s.get(f"{BASE_URL}/member/search_users_json?q={public_id_str.replace('#', '%23')}")
    data = res.json()
    users = data.get('users', [])
    
    found = False
    for u in users:
        if u['user_id'] == target_id:
            found = True
            print(f"PASS: Found user {u['name']} by ID query.")
            break
            
    if not found:
        print(f"FAIL: Did not find user by ID query. Response: {users}")

    # 4. Search by Raw ID Number (without #)
    print(f"\nTest 3: Search by Raw ID '{1000000000 + target_id}'...")
    res = s.get(f"{BASE_URL}/member/search_users_json?q={1000000000 + target_id}")
    data = res.json()
    users = data.get('users', [])
    
    found = False
    for u in users:
        if u['user_id'] == target_id:
            found = True
            print(f"PASS: Found user {u['name']} by Raw ID.")
            break
            
    if not found:
         print(f"FAIL: Did not find user by Raw ID.")

if __name__ == "__main__":
    try:
        run_test()
    except Exception as e:
        print(f"Test Error: {e}")

</file>

<file path="scripts\verify\verify_search_logic.py">

import sys
import os

sys.path.append(os.getcwd())

from backend.app import create_app
from backend.repository.db_access import fetch_all

app = create_app()

def test_search_logic():
    with app.app_context():
        print("--- Testing Search Logic ---")
        
        # 1. Get a test user
        target = fetch_all("SELECT user_id, name FROM users LIMIT 1")[0]
        target_id = target['user_id']
        name = target['name']
        public_id_query = f"#{1000000000 + target_id}"
        
        print(f"Target: {name} (ID: {target_id}) -> Query: '{public_id_query}'")
        
        # 2. Simulate Logic from member_routes.py
        query = public_id_query
        
        search_id = None
        if query.startswith('#') and query[1:].isdigit():
            try:
                 search_id = int(query[1:]) - 1000000000
            except:
                 pass
        elif query.isdigit():
            try:
                 search_id = int(query) - 1000000000
            except:
                 pass
        
        print(f"Parsed Search ID: {search_id}")
        
        if search_id:
            users = fetch_all("""
                SELECT user_id, name, profile_pic, role 
                FROM users 
                WHERE user_id = %s OR name LIKE %s OR role LIKE %s
                LIMIT 10
            """, (search_id, f"%{query}%", f"%{query}%"))
        else:
             print("FAIL: ID parsing failed.")
             return

        # 3. Verify Result
        found = any(u['user_id'] == target_id for u in users)
        
        if found:
            print(f"PASS: Logic correctly found user ID {target_id}")
        else:
            print(f"FAIL: Database query returned: {users}")

if __name__ == "__main__":
    test_search_logic()

</file>

<file path="scripts\verify\verify_upload_access.py">

import requests
import os

BASE_URL = "http://127.0.0.1:5000"
# Login first to get session (using requests.Session)
s = requests.Session()

def test_upload():
    # 1. Login
    print("üîë Logging in...")
    s.post(f"{BASE_URL}/", data={'email': 'tester@automation.com', 'password': 'AutoTest@123'})
    
    # 2. Upload
    print("üì§ Uploading file...")
    # Create a dummy file
    with open("test_upload.txt", "w") as f:
        f.write("This is a test file content.")
        
    try:
        files = {'file': ('test_upload.txt', open('test_upload.txt', 'rb'))}
        res = s.post(f"{BASE_URL}/chat/upload", files=files)
        
        if res.status_code == 200:
            print(f"‚úÖ Upload Success: {res.json()}")
            file_url = res.json().get('file_path')
            
            # 3. Verify Retrieval
            print(f"üîé Verifying access to {file_url}...")
            # Remove leading slash for URL construction if needed, but browser handles it relative to domain
            # Flask returns /static/..., so we append to BASE_URL
            access_url = f"{BASE_URL}{file_url}"
            res_get = s.get(access_url)
            if res_get.status_code == 200:
                print("‚úÖ File verified accessible (HTTP 200)")
            else:
                print(f"‚ùå File Not Found! HTTP {res_get.status_code}")
        else:
            print(f"‚ùå Upload Failed: {res.text}")
            
    finally:
        if os.path.exists("test_upload.txt"):
            os.remove("test_upload.txt")

if __name__ == "__main__":
    test_upload()

</file>

<file path="scripts\verify\verify_upload_fix.py">

import os
import sys
sys.path.append(os.getcwd())

from backend.app import create_app
app = create_app()

def verify():
    with app.app_context():
        # Clean import to get the latest code
        from backend.services.channel_service import save_message
        
        print("üß™ Testing save_message with text=None (Image Upload Scenario)...")
        try:
            # Using user_id=1, channel_id=1 (General)
            # Assuming they exist from previous diagnostics
            res = save_message(
                user_id=1, 
                channel_id=1, 
                text=None, 
                file_url="/static/uploads/test_image.jpg"
            )
            print(f"‚úÖ Success! Message ID: {res['message_id']}")
            print(f"   Content saved as: '{res['content']}'")
        except Exception as e:
            print(f"‚ùå Failed: {e}")
            import traceback
            traceback.print_exc()

if __name__ == "__main__":
    verify()

</file>

<file path="templates\books_management.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Books Management | LibManage</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/books.css') }}"
    />
  </head>
  <body class="books-page">
    <!-- Top Navigation Bar -->
    <nav class="books-navbar">
      <div class="books-nav-wrapper">
        <!-- Left Section -->
        <div class="books-nav-left">
          <div class="books-nav-logo">
            <span class="books-nav-icon">üìö</span>
            <span class="books-nav-title">LibManage</span>
          </div>
          <ul class="books-nav-menu">
            <li><a href="#" class="books-nav-link active">Books</a></li>
            <li><a href="#" class="books-nav-link">Members</a></li>
            <li><a href="#" class="books-nav-link">Reports</a></li>
          </ul>
        </div>

        <!-- Right Section -->
        <div class="books-nav-right">
          <div class="books-nav-search">
            <input
              type="text"
              placeholder="Search books..."
              class="books-nav-search-input"
            />
            <span class="books-nav-search-icon">üîç</span>
          </div>
          <button class="books-nav-profile">üë§</button>
        </div>
      </div>
    </nav>

    <!-- Flash Messages -->
    <div class="books-flash-container">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, msg in messages %}
      <div class="books-flash-message books-flash-{{ category }}">
        <span class="books-flash-text">{{ msg }}</span>
      </div>
      {% endfor %} {% endif %} {% endwith %}
    </div>

    <!-- Main Content -->
    <div class="books-container">
      <!-- Header Section -->
      <div class="books-header">
        <div class="books-header-content">
          <h1 class="books-page-title">Book Inventory Management</h1>
          <p class="books-page-subtitle">
            Manage your library collection with ease
          </p>
        </div>
        <button class="books-btn-add-primary" id="addBookBtn">
          <span class="books-btn-icon">+</span>
          <span class="books-btn-text">Add New Book</span>
        </button>
      </div>

      <!-- Filters & Controls Section -->
      <div class="books-controls">
        <div class="books-filter-group">
          <input
            type="text"
            placeholder="Search by title, author, or ISBN..."
            class="books-search-input"
            id="searchBooks"
          />
          <select class="books-filter-select" id="filterCategory">
            <option value="">All Categories</option>
            <option value="fiction">Fiction</option>
            <option value="non-fiction">Non-Fiction</option>
            <option value="reference">Reference</option>
            <option value="science">Science</option>
            <option value="technology">Technology</option>
          </select>
          <select class="books-filter-select" id="filterStatus">
            <option value="">All Status</option>
            <option value="available">Available</option>
            <option value="issued">Issued</option>
            <option value="reserved">Reserved</option>
          </select>
        </div>
        <div class="books-view-toggle">
          <button class="books-view-btn active" data-view="grid">
            <span>‚äû</span> Grid
          </button>
          <button class="books-view-btn" data-view="list">
            <span>‚â°</span> List
          </button>
        </div>
      </div>

      <!-- Books Grid/List Container -->
      <div class="books-grid-container" id="booksContainer">
        <!-- Book Cards will be dynamically loaded here -->

        <!-- Sample Book Card -->
        <div class="books-card">
          <div class="books-card-image">
            <img
              src="https://via.placeholder.com/200x300?text=Book+Cover"
              alt="Book"
            />
            <span class="books-card-status available">Available</span>
          </div>
          <div class="books-card-content">
            <h3 class="books-card-title">The Great Gatsby</h3>
            <p class="books-card-author">F. Scott Fitzgerald</p>
            <div class="books-card-meta">
              <span class="books-card-meta-item">
                <strong>ISBN:</strong> 978-0743273565
              </span>
              <span class="books-card-meta-item">
                <strong>Year:</strong> 1925
              </span>
            </div>
            <div class="books-card-category">
              <span class="books-badge">Fiction</span>
            </div>
          </div>
          <div class="books-card-actions">
            <button class="books-btn-action books-btn-edit" title="Edit Book">
              <span>‚úèÔ∏è</span> Edit
            </button>
            <button
              class="books-btn-action books-btn-delete"
              title="Delete Book"
            >
              <span>üóëÔ∏è</span> Delete
            </button>
          </div>
        </div>

        <!-- Sample Book Card -->
        <div class="books-card">
          <div class="books-card-image">
            <img
              src="https://via.placeholder.com/200x300?text=Book+Cover"
              alt="Book"
            />
            <span class="books-card-status issued">Issued</span>
          </div>
          <div class="books-card-content">
            <h3 class="books-card-title">To Kill a Mockingbird</h3>
            <p class="books-card-author">Harper Lee</p>
            <div class="books-card-meta">
              <span class="books-card-meta-item">
                <strong>ISBN:</strong> 978-0061120084
              </span>
              <span class="books-card-meta-item">
                <strong>Year:</strong> 1960
              </span>
            </div>
            <div class="books-card-category">
              <span class="books-badge">Fiction</span>
            </div>
          </div>
          <div class="books-card-actions">
            <button class="books-btn-action books-btn-edit" title="Edit Book">
              <span>‚úèÔ∏è</span> Edit
            </button>
            <button
              class="books-btn-action books-btn-delete"
              title="Delete Book"
            >
              <span>üóëÔ∏è</span> Delete
            </button>
          </div>
        </div>

        <!-- Sample Book Card -->
        <div class="books-card">
          <div class="books-card-image">
            <img
              src="https://via.placeholder.com/200x300?text=Book+Cover"
              alt="Book"
            />
            <span class="books-card-status available">Available</span>
          </div>
          <div class="books-card-content">
            <h3 class="books-card-title">1984</h3>
            <p class="books-card-author">George Orwell</p>
            <div class="books-card-meta">
              <span class="books-card-meta-item">
                <strong>ISBN:</strong> 978-0451524935
              </span>
              <span class="books-card-meta-item">
                <strong>Year:</strong> 1949
              </span>
            </div>
            <div class="books-card-category">
              <span class="books-badge">Fiction</span>
            </div>
          </div>
          <div class="books-card-actions">
            <button class="books-btn-action books-btn-edit" title="Edit Book">
              <span>‚úèÔ∏è</span> Edit
            </button>
            <button
              class="books-btn-action books-btn-delete"
              title="Delete Book"
            >
              <span>üóëÔ∏è</span> Delete
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="books-empty-state" id="emptyState" style="display: none">
        <div class="books-empty-icon">üìö</div>
        <h3>No Books Found</h3>
        <p>
          No books match your search criteria. Try adjusting your filters or add
          a new book.
        </p>
        <button class="books-btn-add-secondary" id="addBookBtnEmpty">
          Add Your First Book
        </button>
      </div>
    </div>

    <!-- Add/Edit Book Modal -->
    <div class="books-modal" id="bookModal">
      <div class="books-modal-overlay" id="modalOverlay"></div>
      <div class="books-modal-content">
        <div class="books-modal-header">
          <h2 id="modalTitle">Add New Book</h2>
          <button class="books-modal-close" id="closeModalBtn">&times;</button>
        </div>
        <form class="books-form" id="bookForm">
          <div class="books-form-row">
            <div class="books-form-group">
              <label for="bookTitle">Book Title *</label>
              <input
                type="text"
                id="bookTitle"
                name="title"
                required
                placeholder="Enter book title"
              />
            </div>
            <div class="books-form-group">
              <label for="bookAuthor">Author *</label>
              <input
                type="text"
                id="bookAuthor"
                name="author"
                required
                placeholder="Enter author name"
              />
            </div>
          </div>

          <div class="books-form-row">
            <div class="books-form-group">
              <label for="bookISBN">ISBN</label>
              <input
                type="text"
                id="bookISBN"
                name="isbn"
                placeholder="Enter ISBN"
              />
            </div>
            <div class="books-form-group">
              <label for="bookYear">Publication Year</label>
              <input
                type="number"
                id="bookYear"
                name="year"
                placeholder="Enter publication year"
              />
            </div>
          </div>

          <div class="books-form-row">
            <div class="books-form-group">
              <label for="bookCategory">Category *</label>
              <select id="bookCategory" name="category" required>
                <option value="">Select Category</option>
                <option value="fiction">Fiction</option>
                <option value="non-fiction">Non-Fiction</option>
                <option value="reference">Reference</option>
                <option value="science">Science</option>
                <option value="technology">Technology</option>
              </select>
            </div>
            <div class="books-form-group">
              <label for="bookQuantity">Quantity *</label>
              <input
                type="number"
                id="bookQuantity"
                name="quantity"
                required
                placeholder="Enter quantity"
              />
            </div>
          </div>

          <div class="books-form-group full-width">
            <label for="bookDescription">Description</label>
            <textarea
              id="bookDescription"
              name="description"
              rows="4"
              placeholder="Enter book description"
            ></textarea>
          </div>

          <div class="books-form-actions">
            <button type="button" class="books-btn-cancel" id="cancelBtn">
              Cancel
            </button>
            <button type="submit" class="books-btn-submit">Save Book</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="books-modal" id="deleteModal">
      <div class="books-modal-overlay"></div>
      <div class="books-modal-content books-modal-compact">
        <div class="books-modal-header">
          <h2>Delete Book</h2>
        </div>
        <div class="books-modal-body">
          <p>
            Are you sure you want to delete this book? This action cannot be
            undone.
          </p>
        </div>
        <div class="books-form-actions">
          <button type="button" class="books-btn-cancel" id="cancelDeleteBtn">
            Cancel
          </button>
          <button type="button" class="books-btn-delete-confirm">Delete</button>
        </div>
      </div>
    </div>

    <script>
      // Modal Management
      const bookModal = document.getElementById("bookModal");
      const deleteModal = document.getElementById("deleteModal");
      const modalOverlay = document.getElementById("modalOverlay");
      const addBookBtns = document.querySelectorAll(
        "#addBookBtn, #addBookBtnEmpty",
      );
      const closeModalBtn = document.getElementById("closeModalBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
      const bookForm = document.getElementById("bookForm");

      // Open Add Book Modal
      addBookBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          document.getElementById("modalTitle").textContent = "Add New Book";
          bookForm.reset();
          bookModal.classList.add("active");
        });
      });

      // Close Modal
      function closeModal() {
        bookModal.classList.remove("active");
        deleteModal.classList.remove("active");
      }

      closeModalBtn.addEventListener("click", closeModal);
      cancelBtn.addEventListener("click", closeModal);
      cancelDeleteBtn.addEventListener("click", closeModal);
      modalOverlay.addEventListener("click", closeModal);

      // Delete Book
      document.querySelectorAll(".books-btn-delete").forEach((btn) => {
        btn.addEventListener("click", () => {
          deleteModal.classList.add("active");
        });
      });

      // Form Submission
      bookForm.addEventListener("submit", (e) => {
        e.preventDefault();
        alert("Book saved successfully!");
        closeModal();
        bookForm.reset();
      });

      // Search Functionality
      const searchInput = document.getElementById("searchBooks");
      searchInput.addEventListener("input", (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const cards = document.querySelectorAll(".books-card");
        let visibleCount = 0;

        cards.forEach((card) => {
          const title = card
            .querySelector(".books-card-title")
            .textContent.toLowerCase();
          const author = card
            .querySelector(".books-card-author")
            .textContent.toLowerCase();

          if (title.includes(searchTerm) || author.includes(searchTerm)) {
            card.style.display = "";
            visibleCount++;
          } else {
            card.style.display = "none";
          }
        });

        document.getElementById("emptyState").style.display =
          visibleCount === 0 ? "flex" : "none";
      });

      // View Toggle
      document.querySelectorAll(".books-view-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".books-view-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const view = btn.dataset.view;
          document.getElementById("booksContainer").className =
            `books-grid-container books-${view}-view`;
        });
      });

      // Flash Messages Auto-dismiss
      document.querySelectorAll(".books-flash-message").forEach((msg) => {
        setTimeout(() => {
          msg.classList.add("books-flash-fadeout");
          setTimeout(() => msg.remove(), 300);
        }, 4000);
      });
    </script>
  </body>
</html>

</file>

<file path="templates\change_password.html">
{% extends "layout.html" %}

{% block title %}Settings{% endblock %}
{% block header_title %}Security Settings{% endblock %}
{% block header_subtitle %}Update your password and manage security preferences.{% endblock %}

{% block content %}
<section class="dashboard-section" style="max-width: 600px; margin: 0 auto;">
    <div class="section-header">
        <h2>üîê Change Password</h2>
    </div>
    <div class="section-content">
        <form method="POST">
            <div class="form-group">
                <label for="password">New Password</label>
                <input type="password" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="8" autofocus>
            </div>

            <div class="form-group">
                <label for="confirm_password">Confirm Password</label>
                <input type="password" id="confirm_password" name="confirm_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="8">
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem; padding: 12px;">
                Update Password
            </button>
        </form>
    </div>
</section>
{% endblock %}

</file>

<file path="templates\dashboard_admin.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | LibManage</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <!-- Flash Messages -->
    <div class="flash-container">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, msg in messages %}
      <div class="flash-message flash-{{ category }}">
        <span>{{ msg }}</span>
      </div>
      {% endfor %} {% endif %} {% endwith %}
    </div>

    <div class="app-container">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="sidebar-logo"><span>üìö</span> LibManage</div>

        <nav class="nav-links">
          <div class="nav-item">
            <a href="/dashboard" class="nav-link active">
              <span>üìä</span> Overview
            </a>
          </div>
          <div class="nav-item">
            <a href="#users-section" class="nav-link">
              <span>üë•</span> Users
            </a>
          </div>
          <div class="nav-item">
            <a href="#add-user-section" class="nav-link">
              <span>‚ûï</span> Add User
            </a>
          </div>
          <div class="nav-item">
            <a href="/books-management" class="nav-link">
              <span>üìö</span> Books Management
            </a>
          </div>
          <div class="nav-item">
            <a href="#books-section" class="nav-link">
              <span>üìñ</span> Books
            </a>
          </div>
          <div class="nav-item">
            <a href="#issue-section" class="nav-link">
              <span>üì§</span> Issue Book
            </a>
          </div>
          <div class="nav-item">
            <a href="/admin/suggestions" class="nav-link">
              <span>üí°</span> Book Suggestions
            </a>
          </div>
        </nav>

        <div
          style="
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1.5rem;
          "
        >
          <a href="/logout" class="nav-link" style="color: #ef4444">
            <span>üö™</span> Logout
          </a>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="main-content">
        <header>
          <div class="header-title">
            <h1>Dashboard</h1>
            <p>Welcome back, <strong>{{ user.name }}</strong> ({{ role }})</p>
          </div>
          <div class="user-profile">
            <div style="text-align: right">
              <span style="display: block; font-weight: 600"
                >{{ user.name }}</span
              >
              <span style="font-size: 0.75rem; color: var(--text-sub)"
                >Administrator</span
              >
            </div>
            <div
              style="
                width: 40px;
                height: 40px;
                background: #2563eb;
                color: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
              "
            >
              {{ user.name[0] }}
            </div>
          </div>
        </header>

        <!-- STATS GRID -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-info">
              <span class="stat-value">{{ total_users }}</span>
              <span class="stat-label">Total Users</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìö</div>
            <div class="stat-info">
              <span class="stat-value">{{ total_books }}</span>
              <span class="stat-label">Total Books</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üîñ</div>
            <div class="stat-info">
              <span class="stat-value">{{ total_issues }}</span>
              <span class="stat-label">Active Issues</span>
            </div>
          </div>
        </div>

        <!-- FORMS ROW -->
        <div
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
          "
          id="issue-section"
        >
          <!-- ISSUE BOOK -->
          <section class="dashboard-section">
            <div class="section-header">
              <h2>üì§ Issue Book</h2>
            </div>
            <div class="section-content">
              <form action="/admin/issue" method="POST">
                <div class="form-group">
                  <label>Member</label>
                  <select name="user_id" required>
                    <option value="" disabled selected>Select user...</option>
                    {% for u in users %}
                    <option value="{{ u.user_id }}">
                      {{ u.name }} (ID: {{ u.user_id }})
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label>Book</label>
                  <select name="book_id" required>
                    <option value="" disabled selected>Select book...</option>
                    {% for b in books %}
                    <option value="{{ b.book_id }}">
                      {{ b.title }} (ID: {{ b.book_id }}) ‚Äî {{ b.author }}
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <button
                  type="submit"
                  class="btn btn-primary"
                  style="width: 100%"
                >
                  Complete Issue
                </button>
              </form>
            </div>
          </section>

          <!-- RETURN BOOK -->
          <section class="dashboard-section">
            <div class="section-header">
              <h2>üì• Return Book</h2>
            </div>
            <div class="section-content">
              <form action="/admin/return" method="POST">
                <div class="form-group">
                  <label>Member</label>
                  <select name="user_id" required>
                    <option value="" disabled selected>Select user...</option>
                    {% for u in users %}
                    <option value="{{ u.user_id }}">
                      {{ u.name }} (ID: {{ u.user_id }})
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label>Book</label>
                  <select name="book_id" required>
                    <option value="" disabled selected>Select book...</option>
                    {% for b in books %}
                    <option value="{{ b.book_id }}">
                      {{ b.title }} (ID: {{ b.book_id }})
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <button
                  type="submit"
                  class="btn btn-danger"
                  style="width: 100%"
                >
                  Process Return
                </button>
              </form>
            </div>
          </section>
        </div>

        <!-- ADD NEW USER -->
        <section class="dashboard-section" id="add-user-section">
          <div class="section-header">
            <h2>üë§ Add New User</h2>
          </div>
          <div class="section-content">
            <form
              action="/admin/user/add"
              method="POST"
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1.5rem;
              "
            >
              <div class="form-group">
                <label>Full Name</label>
                <input
                  type="text"
                  name="name"
                  placeholder="John Doe"
                  required
                />
              </div>
              <div class="form-group">
                <label>Email Address</label>
                <input
                  type="email"
                  name="email"
                  placeholder="john@example.com"
                  required
                />
              </div>
              <div class="form-group">
                <label>Initial Password</label>
                <input
                  type="password"
                  name="password"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  required
                />
              </div>
              <div class="form-group">
                <label>Role</label>
                <select name="role" required>
                  <option value="member">Member</option>
                  <option value="admin">Administrator</option>
                </select>
              </div>
              <div class="form-group" style="grid-column: 1 / -1">
                <button
                  type="submit"
                  class="btn btn-primary"
                  style="width: 100%; padding: 12px"
                >
                  Create Account
                </button>
              </div>
            </form>
          </div>
        </section>

        <!-- PENDING REQUESTS -->
        <section class="dashboard-section">
          <div class="section-header">
            <h2>‚è≥ Pending Requests</h2>
            <span class="badge badge-pending"
              >{{ pending_requests|length }} New</span
            >
          </div>
          <div class="section-content">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Date</th>
                    <th>User</th>
                    <th>Book</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for req in pending_requests %}
                  <tr>
                    <td>#{{ req.request_id }}</td>
                    <td>{{ req.request_date }}</td>
                    <td style="font-weight: 500">{{ req.user_name }}</td>
                    <td>{{ req.book_title }}</td>
                    <td>
                      <form
                        action="/admin/request/approve"
                        method="POST"
                        style="display: inline"
                      >
                        <input
                          type="hidden"
                          name="request_id"
                          value="{{ req.request_id }}"
                        />
                        <button type="submit" class="btn btn-primary btn-sm">
                          Approve
                        </button>
                      </form>
                      <form
                        action="/admin/request/reject"
                        method="POST"
                        style="display: inline"
                      >
                        <input
                          type="hidden"
                          name="request_id"
                          value="{{ req.request_id }}"
                        />
                        <button type="submit" class="btn btn-danger btn-sm">
                          Reject
                        </button>
                      </form>
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td
                      colspan="5"
                      style="
                        text-align: center;
                        color: var(--text-sub);
                        padding: 2rem;
                      "
                    >
                      No pending requests at the moment.
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ACTIVE ISSUES -->
        <section class="dashboard-section" id="active-issues">
          <div class="section-header">
            <h2>üîñ Currently Borrowed</h2>
          </div>
          <div class="section-content">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Issue ID</th>
                    <th>User</th>
                    <th>Book</th>
                    <th>Issue Date</th>
                  </tr>
                </thead>
                <tbody>
                  {% for i in active_issues %}
                  <tr>
                    <td>#{{ i.issue_id }}</td>
                    <td style="font-weight: 500">{{ i.user_name }}</td>
                    <td>{{ i.book_title }}</td>
                    <td>{{ i.issue_date }}</td>
                  </tr>
                  {% else %}
                  <tr>
                    <td
                      colspan="4"
                      style="
                        text-align: center;
                        color: var(--text-sub);
                        padding: 2rem;
                      "
                    >
                      No active issues.
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- BOOKS LIST -->
        <section class="dashboard-section" id="books-section">
          <div class="section-header">
            <h2>üìñ Books Inventory</h2>
          </div>
          <div class="section-content">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Category</th>
                    <th>Stock</th>
                  </tr>
                </thead>
                <tbody>
                  {% for b in books %}
                  <tr>
                    <td>#{{ b.book_id }}</td>
                    <td style="font-weight: 600">{{ b.title }}</td>
                    <td>{{ b.author }}</td>
                    <td>
                      <span
                        class="badge"
                        style="background: #f1f5f9; color: #475569"
                        >{{ b.category }}</span
                      >
                    </td>
                    <td>
                      <span
                        class="text-{{ 'success' if b.available_copies > 0 else 'danger' }}"
                      >
                        {{ b.available_copies }} / {{ b.total_copies }}
                      </span>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- USERS LIST -->
        <section class="dashboard-section" id="users-section">
          <div class="section-header">
            <h2>üë• Registered Users</h2>
          </div>
          <div class="section-content">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Joined</th>
                  </tr>
                </thead>
                <tbody>
                  {% for u in users %}
                  <tr>
                    <td>#{{ u.user_id }}</td>
                    <td style="font-weight: 600">{{ u.name }}</td>
                    <td>{{ u.email }}</td>
                    <td>
                      <span
                        class="badge"
                        style="background: {{ '#dcfce7' if u.role == 'admin' else '#eff6ff' }}; color: {{ '#166534' if u.role == 'admin' else '#2563eb' }};"
                        >{{ u.role|capitalize }}</span
                      >
                    </td>
                    <td>
                      {{ u.created_at.strftime('%Y-%m-%d') if u.created_at else
                      'N/A' }}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>
  </body>
</html>

</file>

<file path="templates\dashboard_member.html">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Dashboard | LibManage</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <!-- Flash Messages -->
    <div class="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash-message flash-{{ category }}">
              <span>{{ msg }}</span>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    </div>

    <div class="app-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <span>üìö</span> LibManage
            </div>
            
            <nav class="nav-links">
                <div class="nav-item">
                    <a href="/member/dashboard" class="nav-link active">
                        <span>üìä</span> My Dashboard
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#catalog-section" class="nav-link">
                        <span>üìñ</span> Book Catalog
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#history-section" class="nav-link">
                        <span>üïí</span> My History
                    </a>
                </div>
            </nav>

            <div style="margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                <a href="/logout" class="nav-link" style="color: #ef4444;">
                    <span>üö™</span> Logout
                </a>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <header>
                <div class="header-title">
                    <h1>Reader Dashboard</h1>
                    <p>Happy reading, <strong>{{ session.get('name', 'Member') }}</strong>!</p>
                </div>
                <div class="user-profile">
                    <div style="text-align: right;">
                        <span style="display: block; font-weight: 600;">{{ session.get('name', 'Member') }}</span>
                        <span style="font-size: 0.75rem; color: var(--text-sub);">Member</span>
                    </div>
                </div>
            </header>

            <!-- STATS (SIMPLE) -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìö</div>
                    <div class="stat-info">
                        <span class="stat-value">{{ issues|length }}</span>
                        <span class="stat-label">Books Borrowed</span>
                    </div>
                </div>
            </div>

            <!-- BOOK CATALOG -->
            <section class="dashboard-section" id="catalog-section">
                <div class="section-header">
                    <h2>üìñ Library Catalog</h2>
                    <p style="font-size: 0.875rem; color: var(--text-sub);">Explore and request your next favorite book.</p>
                </div>
                <div class="section-content">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Author</th>
                                    <th>Category</th>
                                    <th>Availability</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for b in books %}
                                <tr>
                                    <td style="font-weight: 600;">{{ b.title }}</td>
                                    <td>{{ b.author }}</td>
                                    <td><span class="badge" style="background: #f1f5f9; color: #475569;">{{ b.category }}</span></td>
                                    <td>
                                        {% if b.available_copies > 0 %}
                                        <span class="text-success">{{ b.available_copies }} available</span>
                                        {% else %}
                                        <span class="text-danger">Out of Stock</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if b.available_copies > 0 %}
                                        <form action="/member/request" method="POST" style="display:inline;">
                                            <input type="hidden" name="book_id" value="{{ b.book_id }}">
                                            <button type="submit" class="btn btn-primary btn-sm">Request</button>
                                        </form>
                                        {% else %}
                                        <button disabled class="btn btn-sm" style="background: #e2e8f0; color: #94a3b8; cursor: not-allowed;">Waitlist</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- MY HISTORY -->
            <section class="dashboard-section" id="history-section">
                <div class="section-header">
                    <h2>üïí My Borrowing History</h2>
                </div>
                <div class="section-content">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Book Title</th>
                                    <th>Issue Date</th>
                                    <th>Return Date</th>
                                    <th>Fine</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for i in issues %}
                                <tr>
                                    <td style="font-weight: 500;">{{ i.title }}</td>
                                    <td>{{ i.issue_date }}</td>
                                    <td>
                                        {% if i.return_date %}
                                        <span class="badge badge-success">Returned ({{ i.return_date }})</span>
                                        {% else %}
                                        <span class="badge badge-pending">Currently Issued</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="{{ 'text-danger' if i.fine > 0 else 'text-success' }}">
                                            ‚Çπ{{ i.fine }}
                                        </span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--text-sub); padding: 2rem;">You haven't borrowed any books yet.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

</body>
</html>

</file>

<file path="templates\layout.html">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} | {{ system_settings.library_name }}</title>
    
    <!-- Dynamic Settings Integration -->
    <style>
        :root {
            --primary: {{ system_settings.accent_color or '#4e73df' }};
            --primary-hover: {{ system_settings.accent_color or '#4e73df' }}dd;
        }
    </style>

    <!-- Theme Detection Script -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const configTheme = "{{ system_settings.default_theme or 'auto' }}";
            
            let themeToApply = 'light';
            
            if (savedTheme) {
                themeToApply = savedTheme;
            } else if (configTheme !== 'auto') {
                themeToApply = configTheme;
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeToApply = 'dark';
            }
            
            document.documentElement.setAttribute('data-theme', themeToApply);
        })();
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ range(1, 1000) | random }}">
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Mobile View: Premium Top Bar -->
    {% if not fullscreen %}
    <div class="mobile-top-bar">
        <div class="mobile-left">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <div class="mobile-logo"><span>{{ system_settings.branding_emoji }}</span> {{ system_settings.library_name }}</div>
        </div>
        <div class="mobile-user">
            <span class="mobile-user-name">{{ session.get('name', 'User') }}</span>
        </div>
    </div>
    {% endif %}

    <!-- Flash Messages -->
    <div class="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash-message flash-{{ category }}">
              <span>{{ msg }}</span>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-container" {% if fullscreen %}style="display: block;"{% endif %}>
        <!-- Sidebar -->
        {% if not fullscreen %}
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <span style="font-size: 1.5rem; color: var(--primary);"><i class="fas fa-book-open"></i></span> {{ system_settings.library_name }}
                <div style="font-size: 0.75rem; color: var(--text-sub); font-weight: 400; margin-top: 0.25rem;">{{ system_settings.library_tagline }}</div>
            </div>
            
            <!-- Theme Toggle -->
            <div class="theme-toggle-wrapper">
                <button id="themeToggle" class="theme-btn">
                    <span id="themeIcon"><i class="fas fa-moon"></i></span>
                    <span id="themeText">Dark Mode</span>
                </button>
            </div>

            <nav class="nav-links">
                {% if session.get('role') == 'admin' %}
                    <a href="/admin/dashboard" class="nav-link {% if active_page == 'admin_overview' %}active{% endif %}">
                        <i class="fas fa-chart-line"></i> Overview
                    </a>
                    <a href="/admin/books" class="nav-link {% if active_page == 'admin_books' %}active{% endif %}">
                        <i class="fas fa-book"></i> Books
                    </a>
                    <a href="/admin/users" class="nav-link {% if active_page == 'admin_users' %}active{% endif %}">
                        <i class="fas fa-users"></i> Users
                    </a>
                    <a href="/admin/issues" class="nav-link {% if active_page == 'admin_issues' %}active{% endif %}">
                        <i class="fas fa-exchange-alt"></i> Issue/Return
                    </a>
                    <a href="/admin/requests" class="nav-link {% if active_page == 'admin_requests' %}active{% endif %}">
                        <i class="fas fa-hourglass-half"></i> Requests
                    </a>
                    <a href="/admin/suggestions" class="nav-link {% if active_page == 'admin_suggestions' %}active{% endif %}">
                        <i class="fas fa-lightbulb"></i> Suggestions
                    </a>
                    <a href="/admin/purchase-list" class="nav-link {% if active_page == 'admin_purchase_list' %}active{% endif %}">
                        <i class="fas fa-shopping-cart"></i> Purchase List
                    </a>
                    <a href="/reports" class="nav-link {% if active_page == 'admin_reports' or active_page == 'admin_analytics' %}active{% endif %}">
                        <i class="fas fa-chart-pie"></i> Insights
                    </a>
                    <a href="/admin/community" class="nav-link {% if active_page == 'admin_community' %}active{% endif %}">
                        <i class="fas fa-users-cog"></i> Community Hub
                    </a>
                    <a href="/admin/scanner" class="nav-link {% if active_page == 'admin_scanner' %}active{% endif %}">
                        <i class="fas fa-qrcode"></i> Scanner
                    </a>
                    <a href="/admin/support" class="nav-link {% if active_page == 'admin_support' %}active{% endif %}">
                        <i class="fas fa-headset"></i> Support
                    </a>
                    <a href="/admin/settings" class="nav-link {% if active_page == 'admin_settings' %}active{% endif %}">
                        <i class="fas fa-cog"></i> Settings
                    </a>
                    <a href="/admin/system/health" class="nav-link {% if active_page == 'admin_health' %}active{% endif %}">
                        <i class="fas fa-heartbeat"></i> System Health
                    </a>
                {% else %}
                    <a href="/member/dashboard" class="nav-link {% if active_page == 'member_overview' %}active{% endif %}">
                        <i class="fas fa-tachometer-alt"></i> Overview
                    </a>
                    <a href="/member/goals" class="nav-link {% if active_page == 'member_goals' %}active{% endif %}">
                        <i class="fas fa-bullseye"></i> My Goals
                    </a>
                    <a href="/member/achievements" class="nav-link {% if active_page == 'member_achievements' %}active{% endif %}">
                        <i class="fas fa-trophy"></i> Trophy Room
                    </a>
                    <a href="/member/catalog" class="nav-link {% if active_page == 'member_catalog' %}active{% endif %}">
                        <i class="fas fa-book"></i> Catalog
                    </a>
                    <a href="/member/suggest-book" class="nav-link {% if active_page == 'suggest_book' %}active{% endif %}">
                        <i class="fas fa-lightbulb"></i> Suggest Book
                    </a>
                    <a href="{{ url_for('member.member_ai_chat') }}" class="nav-link {% if active_page == 'ai_chat' %}active{% endif %}">
                        <i class="fas fa-brain"></i> AI Assistant
                    </a>
                    <a href="/member/wishlist" class="nav-link {% if active_page == 'member_wishlist' %}active{% endif %}">
                        <i class="fas fa-heart"></i> Wishlist
                    </a>
                    <a href="/member/community" class="nav-link {% if active_page == 'member_community' %}active{% endif %}">
                        <i class="fas fa-comments"></i> Community
                    </a>
                     <a href="/member/support" class="nav-link {% if active_page == 'member_support' %}active{% endif %}">
                        <i class="fas fa-ticket-alt"></i> Support
                    </a>
                    <a href="/member/api-keys" class="nav-link {% if active_page == 'member_api_keys' %}active{% endif %}">
                        <i class="fas fa-key"></i> Developer API
                    </a>
                    <a href="/member/profile" class="nav-link {% if active_page == 'member_profile' %}active{% endif %}">
                        <i class="fas fa-user-circle"></i> My Profile
                    </a>
                {% endif %}
            </nav>

            <div style="margin-top: auto; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 1.5rem;">
                <a href="/logout" class="nav-link" style="color: #ef4444;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </aside>
        {% endif %}

        <!-- Main Content -->
        <main class="main-content">
            <header>
                <div class="header-title">
                    <h1>{% block header_title %}{% endblock %}</h1>
                    <p>{% block header_subtitle %}{% endblock %}</p>
                </div>
                <div class="user-profile" style="display: flex; gap: 1rem; align-items: center;">
                    <!-- Notifications -->
                    <div class="notification-wrapper" style="position: relative;">
                        <button class="icon-btn" id="notifBtn" style="background: none; border: none; font-size: 1.25rem; cursor: pointer; position: relative; padding: 5px; border-radius: 5px; transition: background 0.2s;">
                            üîî
                            {% if unread_count > 0 %}
                            <span class="badge" style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">{{ unread_count }}</span>
                            {% endif %}
                        </button>
                        
                        <!-- Dropdown -->
                        <div class="notif-dropdown glass-card shadow-lg" id="notifDropdown" style="display: none; position: absolute; top: 120%; right: 0; width: 320px; padding: 0.5rem; z-index: 1000; border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border);">
                                <strong>Notifications</strong>
                                {% if unread_count > 0 %}
                                <a href="/notifications/read/all" style="font-size: 0.8rem;">Mark all read</a>
                                {% endif %}
                            </div>
                            {% if unread_notifications %}
                                <div style="max-height: 300px; overflow-y: auto;">
                                {% for n in unread_notifications %}
                                    <div style="padding: 0.75rem; border-bottom: 1px solid var(--border);">
                                        <p style="margin: 0; font-size: 0.9rem;">{{ n.message }}</p>
                                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                                            <small style="color: var(--text-sub);">{{ n.created_at }}</small>
                                            <a href="/notifications/read/{{ n.notification_id }}" style="font-size: 0.8rem;">Dismiss</a>
                                        </div>
                                    </div>
                                {% endfor %}
                                </div>
                            {% else %}
                                <div style="padding: 1rem; text-align: center; color: var(--text-sub);">No new notifications</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <style>
                        .icon-btn:hover { background: rgba(0,0,0,0.05); }
                        [data-theme="dark"] .icon-btn:hover { background: rgba(255,255,255,0.1); }
                        .notif-dropdown { animation: slideIn 0.2s ease-out; }
                        @keyframes slideIn {
                            from { opacity: 0; transform: translateY(-10px); }
                            to { opacity: 1; transform: translateY(0); }
                        }
                    </style>

                    <div style="text-align: right;">
                        <span style="display: block; font-weight: 600;">{{ session.get('name', 'User') }}</span>
                        <span style="font-size: 0.75rem; color: var(--text-sub);">{{ session.get('role')|capitalize }}</span>
                    </div>
                    {% if session.get('role') == 'member' %}
                    <a href="/member/profile" style="text-decoration: none;">
                        <div style="width: 40px; height: 40px; background: #2563eb; color: white; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                            {% if session.get('profile_pic') %}
                            <img src="{{ url_for('static', filename=session.get('profile_pic')) }}" style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                            {{ session.get('name', 'U')[0] }}
                            {% endif %}
                        </div>
                    </a>
                    {% else %}
                    <div style="width: 40px; height: 40px; background: #6b7280; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                        {{ session.get('name', 'A')[0] }}
                    </div>
                    {% endif %}
                </div>
            </header>

            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Mobile Menu & Theme Toggle Script -->
    <script>
        // Mobile menu toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        function toggleMenu() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        menuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMenu();
        });
        
        overlay.addEventListener('click', toggleMenu);
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 1024 && 
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target) &&
                sidebar.classList.contains('open')) {
                toggleMenu();
            }
        });

        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        const html = document.documentElement;

        function updateToggleUI(theme) {
            if (theme === 'dark') {
                themeIcon.innerHTML = '<i class="fas fa-sun"></i>';
                themeText.innerText = 'Light Mode';
            } else {
                themeIcon.innerHTML = '<i class="fas fa-moon"></i>';
                themeText.innerText = 'Dark Mode';
            }
        }

        updateToggleUI(html.getAttribute('data-theme'));

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateToggleUI(newTheme);
        });

        // Notification Toggle
        const notifBtn = document.getElementById('notifBtn');
        const notifDropdown = document.getElementById('notifDropdown');

        if(notifBtn && notifDropdown) {
            notifBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = notifDropdown.style.display === 'block';
                notifDropdown.style.display = isVisible ? 'none' : 'block';
            });

            document.addEventListener('click', (e) => {
                if (!notifDropdown.contains(e.target) && !notifBtn.contains(e.target)) {
                    notifDropdown.style.display = 'none';
                }
            });
        }
    </script>


    {% block scripts %}{% endblock %}

</body>
</html>

</file>

<file path="templates\login.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login | {{ system_settings.library_name }} - Library Management System</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body class="login-page">
    <!-- Gradient Background -->
    <div class="login-gradient-bg"></div>

    <!-- Flash Messages -->
    <div class="login-flash-container">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, msg in messages %}
      <div class="login-flash-message login-flash-{{ category }}">
        <span class="login-flash-text">{{ msg }}</span>
      </div>
      {% endfor %} {% endif %} {% endwith %}
    </div>

    <!-- Main Container -->
    <div class="login-container">
      <!-- Left Section: Branding -->
      <div class="login-branding">
        <div class="login-logo-wrapper">
          <div class="login-logo-icon">üìö</div>
          <h1 class="login-title">{{ system_settings.library_name }}</h1>
        </div>
        <p class="login-subtitle">Professional Library Management System</p>
        <p class="login-description">
          Manage your library collection efficiently with our comprehensive
          platform designed for modern librarians.
        </p>
        <div class="login-features">
          <div class="login-feature-item">
            <span class="login-feature-icon">‚úì</span>
            <span>Advanced Book Management</span>
          </div>
          <div class="login-feature-item">
            <span class="login-feature-icon">‚úì</span>
            <span>User & Member Management</span>
          </div>
          <div class="login-feature-item">
            <span class="login-feature-icon">‚úì</span>
            <span>Real-time Analytics</span>
          </div>
        </div>
      </div>

      <!-- Right Section: Login Form -->
      <div class="login-form-wrapper">
        <div class="login-form-card">
          <div class="login-form-header">
            <h2>Welcome Back</h2>
            <p>Sign in to your account to continue</p>
          </div>

          <form method="POST" action="/" class="login-form">
            <div class="login-form-group">
              <label for="email" class="login-label">Email Address</label>
              <div class="login-input-wrapper">
                <input
                  type="email"
                  id="email"
                  name="email"
                  placeholder="Enter your email address"
                  required
                  autofocus
                  class="login-input"
                />
                <span class="login-input-icon">‚úâÔ∏è</span>
              </div>
            </div>

            <div class="login-form-group">
              <label for="password" class="login-label">Password</label>
              <div class="login-input-wrapper">
                <input
                  type="password"
                  id="password"
                  name="password"
                  placeholder="Enter your password"
                  required
                  class="login-input"
                />
                <span class="login-input-icon">üîí</span>
              </div>
            </div>

            <button type="submit" class="login-btn-submit">
              <span class="login-btn-text">Sign In</span>
              <span class="login-btn-arrow">‚Üí</span>
            </button>
          </form>

          <div class="login-footer">
            <p class="login-footer-text">
              ¬© 2026 {{ system_settings.library_name }}. All rights reserved.
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Smooth message dismissal
      document.querySelectorAll(".login-flash-message").forEach((msg) => {
        setTimeout(() => {
          msg.classList.add("login-flash-fadeout");
          setTimeout(() => msg.remove(), 300);
        }, 4000);
      });

      // Click to dismiss message
      document.querySelectorAll(".login-flash-message").forEach((msg) => {
        msg.addEventListener("click", () => {
          msg.classList.add("login-flash-fadeout");
          setTimeout(() => msg.remove(), 300);
        });
      });
    </script>
  </body>
</html>

</file>

<file path="templates\maintenance.html">

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance | LibManage</title>
    <title>Maintenance | {{ system_settings.library_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body style="margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: #0f172a; color: white; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden;">
    <div style="text-align: center; padding: 2rem; max-width: 500px; position: relative; z-index: 2;">
        <div style="font-size: 5rem; margin-bottom: 2rem; animation: float 3s ease-in-out infinite;">üöß</div>
        <h1 style="font-size: 2.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Under Maintenance</h1>
        <p style="color: #94a3b8; font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem;">
            {{ system_settings.library_name }} is currently undergoing scheduled maintenance to improve our service. We'll be back online shortly! Thank you for your patience!
        </p>
        <div style="margin-top: 2rem;">
            <a href="/" class="btn btn-primary">Try Refreshing</a>
        </div>
    </div>
</body>
</html>

</file>

<file path="templates\member_dashboard.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Member Dashboard | LibManage</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <!-- Font Awesome for icons -->
    <link 
      rel="stylesheet" 
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous" 
      referrerpolicy="no-referrer" 
    />
    <style>
      /* Enhanced UI Styles */
      :root {
        --primary: #4e73df;
        --primary-dark: #2e59d9;
        --success: #1cc88a;
        --danger: #e74a3b;
        --warning: #f6c23e;
        --light: #f8f9fc;
        --dark: #5a5c69;
      }
      
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }
      
      .stat-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1);
      }
      
      .stat-icon {
        font-size: 1.5rem;
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(78, 115, 223, 0.1);
        color: var(--primary);
      }
      
      .stat-info {
        flex: 1;
      }
      
      .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
        display: block;
      }
      
      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2c3e50;
      }
      
      .quick-actions {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
      }
      
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.6rem 1.25rem;
        border-radius: 0.35rem;
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        text-decoration: none;
      }
      
      .btn i {
        margin-right: 0.5rem;
      }
      
      .btn-primary {
        background-color: var(--primary);
        color: white;
      }
      
      .btn-primary:hover {
        background-color: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
      }
      
      .btn-outline {
        background: transparent;
        border: 1px solid #d1d3e2;
        color: #5a5c69;
      }
      
      .btn-outline:hover {
        background: #f8f9fc;
        border-color: #bac8f3;
        color: var(--primary);
      }
      
      .dashboard-section {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        margin-bottom: 2rem;
        overflow: hidden;
      }
      
      .section-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e3e6f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .section-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .section-content {
        padding: 1.5rem;
      }
      
      .badge {
        display: inline-block;
        padding: 0.35em 0.65em;
        font-size: 0.75em;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
      }
      
      .bg-primary {
        background-color: var(--primary) !important;
      }
      
      .bg-success {
        background-color: var(--success) !important;
      }
      
      .bg-warning {
        background-color: var(--warning) !important;
        color: #1f2d3d;
      }
      
      .bg-danger {
        background-color: var(--danger) !important;
      }
      
      .bg-secondary {
        background-color: #6c757d !important;
      }
      
      .text-white {
        color: white !important;
      }
      
      .table {
        width: 100%;
        margin-bottom: 1rem;
        color: #212529;
        border-collapse: collapse;
      }
      
      .table th,
      .table td {
        padding: 0.75rem;
        vertical-align: top;
        border-top: 1px solid #e3e6f0;
      }
      
      .table thead th {
        vertical-align: bottom;
        border-bottom: 2px solid #e3e6f0;
        background-color: #f8f9fc;
        color: #4e73df;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
      }
      
      .table tbody tr:hover {
        background-color: rgba(78, 115, 223, 0.05);
      }
      
      .status-badge {
        padding: 0.35em 0.65em;
        border-radius: 0.25rem;
        font-size: 0.75em;
        font-weight: 600;
      }
      
      .status-active {
        background-color: rgba(28, 200, 138, 0.1);
        color: #1cc88a;
      }
      
      .status-overdue {
        background-color: rgba(231, 74, 59, 0.1);
        color: #e74a3b;
      }
      
      .status-returned {
        background-color: rgba(108, 117, 125, 0.1);
        color: #6c757d;
      }
      
      .form-group {
        margin-bottom: 1.5rem;
      }
      
      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #4a4b65;
      }
      
      .form-control {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
        font-weight: 400;
        line-height: 1.5;
        color: #6e707e;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #d1d3e2;
        border-radius: 0.35rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }
      
      .form-control:focus {
        color: #6e707e;
        background-color: #fff;
        border-color: #bac8f3;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
      }
      
      textarea.form-control {
        min-height: 100px;
        resize: vertical;
      }
      
      .empty-state {
        text-align: center;
        padding: 3rem 1.5rem;
        color: #6c757d;
      }
      
      .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }
      
      .empty-state h3 {
        color: #4a4b65;
        margin-bottom: 0.5rem;
      }
      
      .empty-state p {
        margin-bottom: 1.5rem;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="sidebar-logo"><span>üìö</span> LibManage</div>

        <nav class="nav-links">
          <div class="nav-item">
            <a href="/member/dashboard" class="nav-link active">
              <i class="fas fa-tachometer-alt"></i> My Dashboard
            </a>
          </div>
          <div class="nav-item">
            <a href="/member/books" class="nav-link">
              <i class="fas fa-book"></i> Browse Books
            </a>
          </div>
          <div class="nav-item">
            <a href="#suggestions" class="nav-link">
              <i class="fas fa-lightbulb"></i> Suggest a Book
            </a>
          </div>
          <div class="nav-item">
            <a href="/member/profile" class="nav-link">
              <i class="fas fa-user"></i> My Profile
            </a>
          </div>
        </nav>

        <div
          style="
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1.5rem;
          "
        >
          <a href="/logout" class="nav-link" style="color: #ef4444">
            <span>üö™</span> Logout
          </a>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="main-content">
        <header style="margin-bottom: 2rem;">
          <h1 style="font-size: 1.75rem; font-weight: 700; color: #2c3e50; margin-bottom: 0.5rem;">
            Welcome back, {{ current_user.username }}!
          </h1>
          <p style="color: #6c757d; margin: 0;">Here's what's happening with your account today.</p>
        </header>
        
        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-book-reader"></i>
            </div>
            <div class="stat-info">
              <span class="stat-label">Books Borrowed</span>
              <span class="stat-value">{{ issues|length }}</span>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon" style="background: rgba(28, 200, 138, 0.1); color: #1cc88a;">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
              <span class="stat-label">Returned</span>
              <span class="stat-value">{{ issues|selectattr('return_date', 'defined')|list|length }}</span>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon" style="background: rgba(78, 115, 223, 0.1); color: #4e73df;">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
              <span class="stat-label">Borrowing</span>
              <span class="stat-value">{{ issues|selectattr('return_date', 'undefined')|list|length }}</span>
            </div>
          </div>
          
          <div class="stat-card" style="background: linear-gradient(135deg, #4e73df 0%, #224abe 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255, 255, 255, 0.2);">
              <i class="fas fa-lightbulb"></i>
            </div>
            <div class="stat-info">
              <span class="stat-label" style="color: rgba(255, 255, 255, 0.8);">My Suggestions</span>
              <span class="stat-value" style="color: white;">
                <a href="#suggestions" style="color: white; text-decoration: none;">
                  Make a Suggestion
                </a>
              </span>
            </div>
          </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
          <a href="/member/books" class="btn btn-outline">
            <i class="fas fa-search"></i> Browse Books
          </a>
          <a href="#suggestions" class="btn btn-primary">
            <i class="fas fa-lightbulb"></i> Suggest a Book
          </a>
        </div>

        <!-- Active Borrowings -->
        <section class="dashboard-section">
          <div class="section-header">
            <h2><i class="fas fa-book-reader me-2"></i>Active Borrowings</h2>
            {% set active_issues = issues|selectattr('return_date', 'undefined')|list %}
            <span class="badge bg-primary">{{ active_issues|length }} Active</span>
          </div>
          <div class="section-content">
            {% if active_issues %}
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Book Title</th>
                    <th>Issue Date</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for i in issues %}
                  <tr>
                    <td style="font-weight: 600">{{ i.title }}</td>
                    <td>{{ i.issue_date }}</td>
                    <td>{{ i.due_date }}</td>
                    <td>
                      <span
                        class="{{ 'text-danger' if i.fine > 0 else 'text-success' }}"
                        >‚Çπ{{ i.fine }}</span
                      >
                    </td>
                    <td>
                      {% if i.return_date %}
                      <span class="badge badge-success">Returned</span>
                      {% elif i.fine > 0 %}
                      <span
                        class="badge badge-danger"
                        style="background: #fee2e2; color: #dc2626"
                        >Overdue</span
                      >
                      {% else %}
                      <span class="badge badge-pending">Active</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div
              style="text-align: center; color: var(--text-sub); padding: 3rem"
            >
              <span style="font-size: 3rem; display: block; margin-bottom: 1rem"
                >üìñ</span
              >
              <p>No books issued yet. Start reading today!</p>
            </div>
            {% endif %}
          </div>
        </section>

        <!-- Suggest a Book Section -->
        <section class="dashboard-section">
          <div class="section-header">
            <h2>üí° Suggest a Book</h2>
            <p>
              Help us improve our library by suggesting books you'd like to
              read.
            </p>
          </div>
          <div class="section-content">
            <form
              method="POST"
              action="{{ url_for('member.member_suggest_book') }}"
              style="max-width: 500px"
            >
              <div style="margin-bottom: 1.5rem">
                <label
                  for="book_title"
                  style="
                    display: block;
                    font-weight: 600;
                    margin-bottom: 0.5rem;
                  "
                  >Book Title *</label
                >
                <input
                  type="text"
                  id="book_title"
                  name="title"
                  required
                  placeholder="Enter book title"
                  style="
                    width: 100%;
                    padding: 0.75rem;
                    border: 1px solid var(--border);
                    border-radius: 6px;
                    background: var(--card-bg);
                    color: var(--text-main);
                    font-family: inherit;
                    outline: none;
                    transition: all 0.25s ease;
                    font-size: 0.875rem;
                  "
                />
              </div>

              <div style="margin-bottom: 1.5rem">
                <label
                  for="book_author"
                  style="
                    display: block;
                    font-weight: 600;
                    margin-bottom: 0.5rem;
                  "
                  >Author *</label
                >
                <input
                  type="text"
                  id="book_author"
                  name="author"
                  required
                  placeholder="Enter author name"
                  style="
                    width: 100%;
                    padding: 0.75rem;
                    border: 1px solid var(--border);
                    border-radius: 6px;
                    background: var(--card-bg);
                    color: var(--text-main);
                    font-family: inherit;
                    outline: none;
                    transition: all 0.25s ease;
                    font-size: 0.875rem;
                  "
                />
              </div>

              <div style="margin-bottom: 1.5rem">
                <label
                  for="book_category"
                  style="
                    display: block;
                    font-weight: 600;
                    margin-bottom: 0.5rem;
                  "
                  >Category</label
                >
                <select
                  id="book_category"
                  name="category"
                  style="
                    width: 100%;
                    padding: 0.75rem;
                    border: 1px solid var(--border);
                    border-radius: 6px;
                    background: var(--card-bg);
                    color: var(--text-main);
                    font-family: inherit;
                    outline: none;
                    transition: all 0.25s ease;
                    font-size: 0.875rem;
                    cursor: pointer;
                  "
                >
                  <option value="">Select a category</option>
                  <option value="Fiction">Fiction</option>
                  <option value="Non-Fiction">Non-Fiction</option>
                  <option value="Science">Science</option>
                  <option value="Technology">Technology</option>
                  <option value="History">History</option>
                  <option value="Biography">Biography</option>
                  <option value="Self-Help">Self-Help</option>
                  <option value="Romance">Romance</option>
                  <option value="Mystery">Mystery</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div style="margin-bottom: 1.5rem">
                <label
                  for="book_reason"
                  style="
                    display: block;
                    font-weight: 600;
                    margin-bottom: 0.5rem;
                  "
                  >Why do you recommend this book?</label
                >
                <textarea
                  id="book_reason"
                  name="reason"
                  rows="3"
                  placeholder="Share your thoughts..."
                  style="
                    width: 100%;
                    padding: 0.75rem;
                    border: 1px solid var(--border);
                    border-radius: 6px;
                    background: var(--card-bg);
                    color: var(--text-main);
                    font-family: inherit;
                    outline: none;
                    transition: all 0.25s ease;
                    font-size: 0.875rem;
                    resize: vertical;
                  "
                ></textarea>
              </div>

              <button
                type="submit"
                class="btn btn-primary"
                style="width: 100%; padding: 0.75rem"
              >
                üì§ Submit Suggestion
              </button>
            </form>
          </div>
        </section>
      </main>
    </div>
  </body>
</html>

</file>

<file path="templates\reports.html">
{% extends "layout.html" %}

{% block title %}Library Insights{% endblock %}
{% block header_title %}üìä Library Insights{% endblock %}
{% block header_subtitle %}Complete analytics dashboard with all metrics and trends{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Quick Stats Row */
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .quick-stat {
        border-radius: 16px;
        padding: 1.5rem;
        color: white;
        text-align: center;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .quick-stat:hover {
        transform: translateY(-8px) scale(1.03);
        box-shadow: 0 15px 40px rgba(0,0,0,0.25);
        z-index: 10;
    }

    .quick-stat h4 {
        margin: 0;
        font-size: 2.25rem;
        font-weight: 700;
        transition: transform 0.3s ease;
    }

    .quick-stat:hover h4 {
        transform: scale(1.1);
    }

    .quick-stat p {
        margin: 0.5rem 0 0 0;
        font-size: 0.9rem;
        opacity: 0.95;
    }

    .quick-stat .stat-detail {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: all 0.3s ease;
        font-size: 0.8rem;
        margin-top: 0;
    }

    .quick-stat:hover .stat-detail {
        max-height: 60px;
        opacity: 0.9;
        margin-top: 0.75rem;
    }

    /* Analytics Grid */
    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 1024px) {
        .analytics-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Chart Cards */
    .chart-card {
        background: var(--card-bg, white);
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid var(--border);
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
    }

    .chart-card:hover {
        transform: translateY(-6px) scale(1.02);
        box-shadow: 0 20px 40px rgba(99, 102, 241, 0.2);
        border-color: rgba(99, 102, 241, 0.4);
        z-index: 10;
    }

    [data-theme="dark"] .chart-card {
        background: rgba(30,41,59,0.95);
    }

    .chart-card h3 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-main);
        transition: color 0.3s ease;
    }

    .chart-card:hover h3 {
        color: var(--primary);
    }

    .chart-wrapper {
        height: 280px;
        position: relative;
        transition: height 0.3s ease;
    }

    .chart-card:hover .chart-wrapper {
        height: 320px;
    }

    .chart-detail {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: all 0.3s ease;
        padding-top: 0;
        color: var(--text-sub);
        font-size: 0.85rem;
    }

    .chart-card:hover .chart-detail {
        max-height: 60px;
        opacity: 1;
        padding-top: 1rem;
    }

    /* Tables Grid */
    .tables-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 768px) {
        .tables-grid {
            grid-template-columns: 1fr;
        }
    }

    .table-card {
        background: var(--card-bg, white);
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid var(--border);
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
    }

    .table-card:hover {
        transform: translateY(-6px) scale(1.02);
        box-shadow: 0 20px 40px rgba(99, 102, 241, 0.2);
        border-color: rgba(99, 102, 241, 0.4);
        z-index: 10;
    }

    [data-theme="dark"] .table-card {
        background: rgba(30,41,59,0.95);
    }

    .table-card h3 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-main);
        transition: color 0.3s ease;
    }

    .table-card:hover h3 {
        color: var(--primary);
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .data-table th {
        font-weight: 600;
        color: var(--text-sub);
        font-size: 0.8rem;
        text-transform: uppercase;
    }

    .data-table tr:last-child td {
        border-bottom: none;
    }

    .data-table tr:hover td {
        background: rgba(99, 102, 241, 0.05);
    }

    /* Actions Bar */
    .actions-bar {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    /* Metrics Row */
    .metrics-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: var(--card-bg, white);
        border-radius: 12px;
        padding: 1.25rem;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
    }

    .metric-card:hover {
        transform: translateY(-6px) scale(1.03);
        box-shadow: 0 15px 35px rgba(99, 102, 241, 0.2);
        border-color: rgba(99, 102, 241, 0.4);
        z-index: 10;
    }

    .metric-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        transition: transform 0.3s ease;
    }

    .metric-card:hover .metric-icon {
        transform: scale(1.15);
    }

    .metric-info h4 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-main);
        transition: color 0.3s ease;
    }

    .metric-card:hover .metric-info h4 {
        color: var(--primary);
    }

    .metric-info p {
        margin: 0.25rem 0 0 0;
        font-size: 0.85rem;
        color: var(--text-sub);
    }

    .metric-detail {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: all 0.3s ease;
        font-size: 0.8rem;
        color: var(--text-sub);
    }

    .metric-card:hover .metric-detail {
        max-height: 40px;
        opacity: 1;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- QUICK STATS ROW -->
<div class="quick-stats">
    <div class="quick-stat" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
        <h4>{{ quick_stats.total_books }}</h4>
        <p>üìö Total Books</p>
        <div class="stat-detail">Complete library catalog including all categories</div>
    </div>
    <div class="quick-stat" style="background: linear-gradient(135deg, #10b981, #34d399);">
        <h4>{{ quick_stats.total_members }}</h4>
        <p>üë• Members</p>
        <div class="stat-detail">Registered library members with active accounts</div>
    </div>
    <div class="quick-stat" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
        <h4>{{ quick_stats.active_issues }}</h4>
        <p>üìñ Currently Borrowed</p>
        <div class="stat-detail">Books currently checked out by members</div>
    </div>
    <div class="quick-stat" style="background: linear-gradient(135deg, #ef4444, #f87171);">
        <h4>{{ quick_stats.overdue_books }}</h4>
        <p>‚ö†Ô∏è Overdue</p>
        <div class="stat-detail">Books past due date - needs attention</div>
    </div>
    <div class="quick-stat" style="background: linear-gradient(135deg, #14b8a6, #2dd4bf);">
        <h4>{{ quick_stats.new_books_month }}</h4>
        <p>‚ú® New This Month</p>
        <div class="stat-detail">Recently added to the catalog</div>
    </div>
</div>

<!-- ACTIONS BAR -->
<div class="actions-bar">
    <form action="/admin/overdue-reminders" method="POST" style="margin: 0;">
        <button type="submit" class="btn btn-danger btn-sm">üìß Email Overdue Reminders</button>
    </form>
    <a class="btn btn-primary btn-sm" href="/reports/export/most_issued">‚¨á Export Top Books</a>
    <a class="btn btn-primary btn-sm" href="/reports/export/active_users">‚¨á Export Top Readers</a>
</div>

<!-- CHARTS GRID -->
<div class="analytics-grid">
    <!-- Monthly Trends -->
    <div class="chart-card">
        <h3>üìà Monthly Lending Trends</h3>
        <div class="chart-wrapper"><canvas id="trendChart"></canvas></div>
        <div class="chart-detail">Track borrowing patterns over time to optimize inventory</div>
    </div>

    <!-- Genre Popularity -->
    <div class="chart-card">
        <h3>üé≠ Genre Popularity</h3>
        <div class="chart-wrapper"><canvas id="categoryChart"></canvas></div>
        <div class="chart-detail">See which categories are most popular among readers</div>
    </div>

    <!-- Issue Status -->
    <div class="chart-card">
        <h3>‚ö° Issue Status Distribution</h3>
        <div class="chart-wrapper"><canvas id="statusChart"></canvas></div>
        <div class="chart-detail">Compare active loans vs. returned books</div>
    </div>

    <!-- Return Rate -->
    <div class="chart-card">
        <h3>üîÑ Weekly Return Trend</h3>
        <div class="chart-wrapper"><canvas id="returnChart"></canvas></div>
        <div class="chart-detail">Monitor weekly return patterns and peaks</div>
    </div>
</div>

<!-- METRICS ROW -->
<div class="metrics-row">
    <div class="metric-card">
        <div class="metric-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">üí∞</div>
        <div class="metric-info">
            <h4>{{ system_settings.currency_symbol }}{{ quick_stats.total_fines }}</h4>
            <p>Total Fines Collected</p>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-icon" style="background: linear-gradient(135deg, #ef4444, #f87171);">‚è≥</div>
        <div class="metric-info">
            <h4>{{ system_settings.currency_symbol }}{{ quick_stats.pending_fines }}</h4>
            <p>Pending Collection</p>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">üíö</div>
        <div class="metric-info">
            <h4>Healthy</h4>
            <p>System Status</p>
        </div>
    </div>
</div>

<!-- TABLES GRID -->
<div class="tables-grid">
    <!-- Most Popular Books -->
    <div class="table-card">
        <h3>üìö Most Popular Books</h3>
        <table class="data-table">
            <thead>
                <tr><th>Book Title</th><th style="text-align:right;">Issues</th></tr>
            </thead>
            <tbody>
            {% for row in data.most_issued %}
            <tr>
                <td style="font-weight: 600;">{{ row.title }}</td>
                <td style="text-align:right;"><span class="badge badge-success">{{ row.issue_count }}</span></td>
            </tr>
            {% else %}
            <tr><td colspan="2" style="text-align:center; color: var(--text-sub);">No data available</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Top Readers -->
    <div class="table-card">
        <h3>üëë Top Readers</h3>
        <table class="data-table">
            <thead>
                <tr><th>Member Name</th><th style="text-align:right;">Borrows</th></tr>
            </thead>
            <tbody>
            {% for row in data.active_users %}
            <tr>
                <td style="font-weight: 600;">{{ row.name }}</td>
                <td style="text-align:right;"><span class="badge badge-member">{{ row.total_issues }}</span></td>
            </tr>
            {% else %}
            <tr><td colspan="2" style="text-align:center; color: var(--text-sub);">No data available</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Overdue Analysis -->
    <div class="table-card">
        <h3>‚è∞ Overdue Analysis</h3>
        <table class="data-table">
            <thead>
                <tr><th>Metric</th><th style="text-align:right;">Value</th></tr>
            </thead>
            <tbody>
                <tr><td>Currently Overdue</td><td style="text-align:right;"><span class="badge" style="background:#ef4444;color:white;">{{ quick_stats.overdue_books }}</span></td></tr>
                <tr><td>On Time</td><td style="text-align:right;"><span class="badge badge-success">{{ quick_stats.active_issues - quick_stats.overdue_books }}</span></td></tr>
                <tr><td>Overdue Rate</td><td style="text-align:right;">{{ ((quick_stats.overdue_books / quick_stats.active_issues * 100) if quick_stats.active_issues > 0 else 0)|round(1) }}%</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Library Health -->
    <div class="table-card">
        <h3>üíö Library Health</h3>
        <table class="data-table">
            <thead>
                <tr><th>Metric</th><th style="text-align:right;">Status</th></tr>
            </thead>
            <tbody>
                <tr><td>Catalog Size</td><td style="text-align:right;"><span class="badge badge-success">{{ quick_stats.total_books }} books</span></td></tr>
                <tr><td>Active Members</td><td style="text-align:right;"><span class="badge badge-success">{{ quick_stats.total_members }}</span></td></tr>
                <tr><td>Active Loans</td><td style="text-align:right;"><span class="badge badge-success">{{ quick_stats.active_issues }}</span></td></tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script id="chart-data" type="application/json">
{{ chart_data | tojson | safe }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const rawData = JSON.parse(document.getElementById('chart-data').textContent);

    // 1. Monthly Trends - Line Chart
    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: rawData.monthlyLabels,
            datasets: [{
                label: 'Books Borrowed',
                data: rawData.monthlyValues,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#6366f1',
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                x: { grid: { display: false } }
            }
        }
    });

    // 2. Category Distribution - Doughnut Chart
    new Chart(document.getElementById('categoryChart'), {
        type: 'doughnut',
        data: {
            labels: rawData.categoryLabels,
            datasets: [{
                data: rawData.categoryValues,
                backgroundColor: ['#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e', '#f59e0b', '#10b981', '#14b8a6', '#3b82f6']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });

    // 3. Issue Status - Bar Chart
    new Chart(document.getElementById('statusChart'), {
        type: 'bar',
        data: {
            labels: ['Active Loans', 'Returned'],
            datasets: [{
                data: rawData.statusValues || [0, 0],
                backgroundColor: ['#6366f1', '#10b981'],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }
            }
        }
    });

    // 4. Return Rate - Line Chart
    new Chart(document.getElementById('returnChart'), {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [{
                label: 'Returns',
                data: rawData.weeklyReturns || [8, 12, 15, 10],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#10b981',
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                x: { grid: { display: false } }
            }
        }
    });
});
</script>
{% endblock %}

</file>

<file path="templates\admin\analytics.html">

{% extends "layout.html" %}

{% block title %}Advanced Analytics{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block header_title %}üìä Library Intelligence{% endblock %}
{% block header_subtitle %}Deep dive into borrowing trends and collection performance.{% endblock %}

{% block content %}
<div class="analytics-grid">
    <!-- Trends Chart -->
    <div class="glass-card analytics-card" style="padding: 1.5rem;">
        <h3 style="margin-bottom: 1.5rem;">üìà Borrowing Trends (Last 30 Days)</h3>
        <div class="chart-wrapper">
            <canvas id="trendsChart"></canvas>
        </div>
    </div>

    <!-- Category Chart -->
    <div class="glass-card analytics-card" style="padding: 1.5rem;">
        <h3 style="margin-bottom: 1.5rem;">üé≠ Genre Popularity</h3>
        <div class="chart-wrapper">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>

    <!-- Status Chart -->
    <div class="glass-card analytics-card" style="padding: 1.5rem;">
        <h3 style="margin-bottom: 1.5rem;">üìä Issue Status Distribution</h3>
        <div class="chart-wrapper">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const resp = await fetch('/admin/analytics/data');
        const data = await resp.json();

        // 1. Trends Line Chart
        new Chart(document.getElementById('trendsChart'), {
            type: 'line',
            data: {
                labels: data.trends.labels,
                datasets: [{
                    label: 'Books Borrowed',
                    data: data.trends.values,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });

        // 2. Category Doughnut Chart
        new Chart(document.getElementById('categoryChart'), {
            type: 'doughnut',
            data: {
                labels: data.categories.labels,
                datasets: [{
                    data: data.categories.values,
                    backgroundColor: [
                        '#6366f1', '#a855f7', '#ec4899', '#f43f5e', '#f59e0b', '#10b981'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                }
            }
        });

        // 3. Status Bar Chart
        new Chart(document.getElementById('statusChart'), {
            type: 'bar',
            data: {
                labels: data.status.labels,
                datasets: [{
                    label: 'Total Books',
                    data: data.status.values,
                    backgroundColor: ['#6366f1', '#10b981'],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }
                }
            }
        });

    } catch (err) {
        console.error("Failed to load analytics:", err);
    }
});
</script>
{% endblock %}

</file>

<file path="templates\admin\audit_logs.html">

{% extends "layout.html" %}

{% block title %}Audit Logs{% endblock %}
{% block header_title %}System Audit Logs{% endblock %}
{% block header_subtitle %}Track administrative actions and security events.{% endblock %}

{% block content %}
<div class="glass-card" style="padding: 0; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: rgba(0,0,0,0.03); border-bottom: 1px solid var(--border);">
            <tr>
                <th style="padding: 1rem; text-align: left;">Timestamp</th>
                <th style="padding: 1rem; text-align: left;">Admin</th>
                <th style="padding: 1rem; text-align: left;">Action</th>
                <th style="padding: 1rem; text-align: left;">Details</th>
            </tr>
        </thead>
        <tbody>
            {% if not logs %}
            <tr><td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-sub);">No logs found.</td></tr>
            {% else %}
            {% for log in logs %}
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 1rem; font-family: monospace; font-size: 0.9em; color: var(--text-sub);">{{ log.timestamp }}</td>
                <td style="padding: 1rem; font-weight: 500;">{{ log.admin_name }}</td>
                <td style="padding: 1rem;">
                    <span class="badge" style="background: var(--bg); border: 1px solid var(--border);">{{ log.action }}</span>
                </td>
                <td style="padding: 1rem; color: var(--text-sub);">{{ log.details }}</td>
            </tr>
            {% endfor %}
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}

</file>

<file path="templates\admin\authors.html">
{% extends "layout.html" %}

{% block title %}Manage Authors{% endblock %}
{% block header_title %}Authors Hub{% endblock %}
{% block header_subtitle %}View and refine enriched biographies and metadata.{% endblock %}

{% block content %}
<style>
    .authors-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .search-wrapper {
        position: relative;
        flex: 1;
        max-width: 400px;
    }
    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text-main);
        transition: all 0.3s ease;
    }
    .search-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        outline: none;
    }
    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-sub);
    }
    
    .authors-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }
    .author-card {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        transition: transform 0.3s, box-shadow 0.3s;
        border: 1px solid transparent;
    }
    .author-card:hover { 
        transform: translateY(-4px); 
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        border-color: rgba(99, 102, 241, 0.1);
    }
    
    .author-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
    }
    
    .nationality-badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
        border-radius: 20px;
        font-weight: 600;
        align-self: flex-start;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .bio-container {
        position: relative;
    }
    .author-bio {
        font-size: 0.95rem;
        color: var(--text-sub);
        line-height: 1.6;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        transition: all 0.5s ease;
    }
    .author-bio.expanded {
        -webkit-line-clamp: unset;
        line-clamp: unset;
        overflow: visible;
    }
    
    .read-more-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
        margin-top: 0.5rem;
        display: none; /* Hidden by default if text is short */
    }
    .read-more-btn:hover { text-decoration: underline; }

    .card-actions {
        margin-top: auto;
        display: flex;
        gap: 0.75rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
    }
    .btn-icon { display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
</style>

<div class="authors-header">
    <div class="search-wrapper">
        <span class="search-icon">üîç</span>
        <input type="text" id="authorSearch" class="search-input" placeholder="Find an author..." onkeyup="filterAuthors()">
    </div>
    <div style="font-size: 0.9rem; color: var(--text-sub);">
        Total Authors: <strong>{{ authors|length }}</strong>
    </div>
</div>

<div class="authors-grid" id="authorsGrid">
    {% if not authors %}
    <div class="glass-card" style="grid-column: 1/-1; padding: 4rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 1rem;">
        <div style="font-size: 4rem; background: var(--bg); width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">‚úçÔ∏è</div>
        <h3>No Authors Yet</h3>
        <p style="color: var(--text-sub); max-width: 400px;">
            Your library's "Who's Who" is empty. Add books to populate this list automatically via the <strong>Open Intelligence Engine</strong>.
        </p>
        <a href="/admin/books" class="btn btn-primary">Add First Book</a>
    </div>
    {% else %}
    {% for a in authors %}
    <div class="glass-card author-card" data-name="{{ a.name|lower }}">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h3 class="author-name">{{ a.name }}</h3>
                {% if a.nationality %}
                <span class="nationality-badge">üåç {{ a.nationality }}</span>
                {% endif %}
            </div>
            <div style="font-size: 1.5rem; opacity: 0.2;">‚úíÔ∏è</div>
        </div>
        
        <div class="bio-container">
            <p class="author-bio" id="bio-{{ a.author_id }}">
                {{ a.bio or 'Biography pending enrichment...' }}
            </p>
            {% if a.bio and a.bio|length > 150 %}
            <button class="read-more-btn" onclick="toggleBio('bio-{{ a.author_id }}', this)">Read More</button>
            <script>document.currentScript.previousElementSibling.style.display = 'inline-block';</script>
            {% endif %}
        </div>
        
        <div class="card-actions">
            <button class="btn btn-outline-secondary btn-sm btn-icon" style="flex: 1;" onclick="openEditAuthorModal('{{ a.author_id }}', '{{ a.name|escape }}', `{{ a.bio|escape }}`)">
                ‚úèÔ∏è Edit
            </button>
            <a href="/admin/books?author_id={{ a.author_id }}" class="btn btn-primary btn-sm btn-icon" style="flex: 1; text-decoration: none;">
                üìö Books
            </a>
        </div>
    </div>
    {% endfor %}
    {% endif %}
</div>

<!-- Edit Author Modal -->
<div id="editAuthorModal" class="modal-overlay">
    <div class="modal-content glass-card" style="max-width: 600px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 id="modalAuthorName" style="margin: 0;">Edit Author</h2>
            <button class="btn-close" onclick="closeModal('editAuthorModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sub);">‚úï</button>
        </div>
        
        <form id="editAuthorForm" method="POST">
            <div class="form-group">
                <label>Biography</label>
                <textarea name="bio" id="authorBioInput" rows="8" class="form-control" style="width: 100%; border-radius: 12px; border: 1px solid var(--border); padding: 1rem; background: var(--bg); color: var(--text-main); font-family: inherit; font-size: 0.95rem; line-height: 1.6;"></textarea>
                <small style="color: var(--text-sub); display: block; margin-top: 0.5rem;">You can use this to manually refine or add details to the AI-generated bio.</small>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
                <label>Nationality</label>
                <input type="text" name="nationality" id="authorNationalityInput" class="form-control" placeholder="e.g., American">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-outline-secondary" onclick="closeModal('editAuthorModal')">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openModal(id) { document.getElementById(id).style.display = "flex"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    
    function openEditAuthorModal(id, name, bio) {
        document.getElementById('modalAuthorName').innerText = "Edit " + name;
        document.getElementById('authorBioInput').value = bio;
        document.getElementById('editAuthorForm').action = "/admin/authors/edit/" + id;
        openModal('editAuthorModal');
    }

    function toggleBio(bioId, btn) {
        const bio = document.getElementById(bioId);
        bio.classList.toggle('expanded');
        if (bio.classList.contains('expanded')) {
            btn.innerText = "Show Less";
        } else {
            btn.innerText = "Read More";
        }
    }

    function filterAuthors() {
        const query = document.getElementById('authorSearch').value.toLowerCase();
        const cards = document.querySelectorAll('.author-card');
        
        cards.forEach(card => {
            const name = card.dataset.name;
            if (name.includes(query)) {
                card.style.display = "flex";
            } else {
                card.style.display = "none";
            }
        });
    }
</script>
{% endblock %}

</file>

<file path="templates\admin\books.html">
{% extends "layout.html" %} {% block title %}Manage Books{% endblock %} {% block
header_title %}Book Inventory{% endblock %} {% block header_subtitle %}View,
add, or update the library's physical collection.{% endblock %}
{% block head %}
<style>
  /* Premium Grid Layout */
  .admin-books-layout {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    padding-bottom: 2rem;
  }
  
  .book-card-premium {
    position: relative;
    display: flex;
    flex-direction: column;
    padding: 0;
    overflow: hidden;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
  }
  
  .book-card-premium:hover {
    transform: translateY(-5px) scale(1.01);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }
  
  .book-cover-container {
    height: 160px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.02), rgba(0,0,0,0.05));
    position: relative;
    display: flex;
    align-items: center;
    padding: 1rem;
    gap: 1rem;
    border-bottom: 1px solid var(--border);
  }
  
  .book-thumb-lg {
    width: 90px;
    height: 130px;
    border-radius: 6px;
    box-shadow: -4px 4px 12px rgba(0,0,0,0.15);
    object-fit: cover;
    transition: transform 0.3s ease;
  }
  
  .book-card-premium:hover .book-thumb-lg {
    transform: rotate(-2deg) scale(1.05);
  }
  
  .book-quick-stats {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .stat-pill {
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(4px);
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-sub);
    border: 1px solid rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  @media (max-width: 768px) {
    .glass-card[style*="position: sticky"] {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 1rem !important;
        top: 60px !important; /* Adjust for mobile header */
        padding: 1rem !important;
    }
    .glass-card form {
        width: 100% !important;
        flex-direction: column !important;
        align-items: stretch !important;
    }
    .glass-card form > div {
        max-width: none !important;
        width: 100% !important;
    }
    .glass-card form button {
        width: 100% !important;
    }
    /* Action buttons row */
    .glass-card > div:last-child {
        width: 100% !important;
        justify-content: space-between !important;
    }
    .glass-card > div:last-child button {
        flex: 1 !important;
    }
  }
</style>
{% endblock %} 

{% block content %}
<!-- Floating Action Header -->
<div class="glass-card" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; margin-bottom: 2rem; position: sticky; top: 80px; z-index: 100; backdrop-filter: blur(20px);">
  <form action="/admin/books" method="GET" style="display: flex; flex: 1; margin: 0; align-items: center; gap: 1rem;">
    <div style="position: relative; flex: 1; max-width: 400px;">
        <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-sub);"></i>
        <input
          type="text"
          name="q"
          value="{{ q }}"
          class="form-control"
          placeholder="Search items..."
          style="padding-left: 2.5rem; background: rgba(255,255,255,0.5); border: 1px solid var(--border); border-radius: 50px;"
        />
    </div>
    <button type="submit" class="btn btn-primary btn-sm" style="border-radius: 50px; padding: 0.5rem 1.5rem;">Filter</button>
  </form>
  
  <div style="display: flex; gap: 0.75rem;">
      <button class="btn btn-outline-secondary" onclick="openModal('importBookModal')" style="border-radius: 50px; padding: 0.5rem 1.25rem; font-size: 0.85rem;">
        <i class="fas fa-file-import me-1"></i> Import
      </button>
      <button class="btn btn-primary" onclick="openModal('addBookModal')" style="border-radius: 50px; padding: 0.5rem 1.25rem; font-size: 0.85rem; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);">
        <i class="fas fa-plus me-1"></i> Add Book
      </button>
  </div>
</div>

<!-- Import Modal (Retained logic, wrapped in glass) -->
<div id="importBookModal" class="modal-overlay">
    <div class="modal-content glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
            <h2 style="margin: 0;">Bulk Import</h2>
            <button type="button" class="btn-close" onclick="closeModal('importBookModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sub);">‚úï</button>
        </div>
        <p style="color: var(--text-sub); margin-bottom: var(--space-lg);">Upload a CSV with columns: <code>Title, Author, Category, Copies</code></p>
        
        <form action="/admin/books/import" method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label>Select CSV File</label>
                <input type="file" name="csv_file" accept=".csv" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: var(--space-lg);">
                <button type="submit" class="btn btn-primary">Upload</button>
                <button type="button" class="btn btn-outline-secondary" onclick="closeModal('importBookModal')">Cancel</button>
            </div>
        </form>
    </div>
</div>

{% if not books %}
<div class="glass-card text-center py-5" style="margin-top: 2rem;">
    <div class="text-muted">
      <i class="fas fa-book-open fa-3x mb-3" style="opacity: 0.5;"></i>
      <h4>No books found</h4>
      <p>Try adjusting your search or add a new book to the library.</p>
      <a href="/admin/books" class="btn btn-primary mt-2" style="border-radius: 50px;">
        <i class="fas fa-sync-alt mr-2"></i>Reset Filters
      </a>
    </div>
</div>
{% else %}

<!-- Smart Genre Filter Bar -->
<style>
    .filter-bar-container {
        display: flex;
        gap: 0.75rem;
        overflow-x: auto;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
        /* Scrollbar hiding */
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .filter-bar-container::-webkit-scrollbar { display: none; }
    
    .filter-chip {
        padding: 0.5rem 1.25rem;
        border-radius: 50px;
        background: rgba(255,255,255,0.4);
        border: 1px solid var(--border);
        color: var(--text-sub);
        font-size: 0.85rem;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .filter-chip:hover {
        background: white;
        color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .filter-chip.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
</style>
<div id="genre-filter-bar" class="filter-bar-container">
    <!-- Chips injected via JS -->
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('.book-card-premium');
    const categories = new Set();
    
    // Extract unique categories
    cards.forEach(card => {
        const cat = card.getAttribute('data-category');
        if(cat && cat !== 'None') categories.add(cat);
    });
    
    if(categories.size > 0) {
        const bar = document.getElementById('genre-filter-bar');
        
        // Add "All" Chip
        const allChip = document.createElement('div');
        allChip.className = 'filter-chip active';
        allChip.innerHTML = '<i class="fas fa-layer-group"></i> All Books';
        allChip.onclick = () => filterBooks('all', allChip);
        bar.appendChild(allChip);
        
        // Add Category Chips
        Array.from(categories).sort().forEach(cat => {
            const chip = document.createElement('div');
            chip.className = 'filter-chip';
            chip.innerText = cat;
            chip.onclick = () => filterBooks(cat, chip);
            bar.appendChild(chip);
        });
    }
});

function filterBooks(category, btn) {
    // UI Update
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');

    // Filter Logic
    const cards = document.querySelectorAll('.book-card-premium');
    cards.forEach(card => {
        if(category === 'all' || card.getAttribute('data-category') === category) {
            card.style.display = 'flex';
            // Simple fade in animation could be added here
        } else {
            card.style.display = 'none';
        }
    });
}
</script>


<div class="admin-books-layout">
  {% for b in books %}
  <div class="glass-card book-card-premium" data-category="{{ b.category }}">
    
    <!-- Top Half: Cover & Quick Stats -->
    <div class="book-cover-container">
        <img
          src="{{ b.cover_url }}"
          class="book-thumb-lg"
          onerror="this.src='https://placehold.co/90x130?text={{ b.title[0] }}';"
        />
        <div class="book-quick-stats">
             <div class="stat-pill">
                <i class="fas fa-tag text-primary"></i> <span>{{ b.category }}</span>
             </div>
             <div class="stat-pill" style="{% if b.available_copies == 0 %}color: #ef4444; border-color: #fecaca; background: #fef2f2;{% endif %}">
                <i class="fas fa-box-open {% if b.available_copies == 0 %}text-danger{% else %}text-success{% endif %}"></i> 
                <span>{{ b.available_copies }} / {{ b.total_copies }}</span>
             </div>
             {% if b.series_title %}
             <div class="stat-pill">
                <i class="fas fa-layer-group text-info"></i> <span style="font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;">{{ b.series_title }}</span>
             </div>
             {% endif %}
        </div>
    </div>

    <!-- Bottom Half: Info & Actions -->
    <div style="padding: 1.25rem; display: flex; flex-direction: column; flex-grow: 1;">
      <h3 title="{{ b.title }}" style="font-size: 1.1rem; font-weight: 700; margin: 0 0 0.25rem 0; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.6rem;">{{ b.title }}</h3>
      <p style="color: var(--text-sub); font-size: 0.9rem; margin-bottom: 1rem;">by {{ b.author_name or 'Unknown' }}</p>

      <div style="margin-top: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
        <button
          class="btn btn-outline-primary btn-sm edit-btn"
          style="border-radius: 8px; font-weight: 600;"
          data-id="{{ b.book_id }}"
        >
          <i class="fas fa-edit me-1"></i> Edit
        </button>
        <button
          class="btn btn-outline-danger btn-sm delete-btn"
          style="border-radius: 8px; font-weight: 600;"
          data-id="{{ b.book_id }}"
          data-title="{{ b.title }}"
        >
          <i class="fas fa-trash-alt me-1"></i> Delete
        </button>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- PAGINATION -->
<div class="pagination">
  {% if current_page > 1 %}
  <a
    href="/admin/books?page={{ current_page - 1 }}&q={{ q }}"
    class="btn btn-danger btn-sm"
    >Previous</a
  >
  {% else %}
  <button class="btn btn-disabled btn-sm" disabled>Previous</button>
  {% endif %}

  <span class="page-info"
    >Page <strong>{{ current_page }}</strong> of {{ total_pages }}</span
  >

  {% if current_page < total_pages %}
  <a
    href="/admin/books?page={{ current_page + 1 }}&q={{ q }}"
    class="btn btn-primary btn-sm"
    >Next</a
  >
  {% else %}
  <button class="btn btn-disabled btn-sm" disabled>Next</button>
  {% endif %}
</div>
{% endif %}

<!-- Add Book Modal -->
<div id="addBookModal" class="modal-overlay">
  <div class="modal-content glass-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
        <h2 style="margin: 0;">Add New Book</h2>
        <button type="button" class="btn-close" onclick="closeModal('addBookModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sub);">‚úï</button>
    </div>
    
    <!-- Integrated ISBN Fetcher -->
    <div style="background: rgba(99, 102, 241, 0.05); padding: 1rem; border-radius: 12px; margin-bottom: var(--space-lg); border: 1px solid rgba(99, 102, 241, 0.2);">
        <label style="color: var(--primary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700;">‚ú® Smart ISBN Auto-Fill</label>
        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <input type="text" id="isbnInput" placeholder="Enter ISBN-13..." style="flex: 1;">
            <button type="button" id="fetchIsbnBtn" class="btn btn-primary" style="background: linear-gradient(135deg, #6366f1, #a855f7); border: none; padding: 0 1.5rem;">Fetch</button>
        </div>
        <small id="isbnFeedback" style="display: block; margin-top: 0.5rem; font-size: 0.75rem;"></small>
    </div>

    <form id="addBookForm" action="/admin/book/add" method="POST" enctype="multipart/form-data" style="display: grid; gap: 1.25rem;">
      <div class="form-group" style="margin: 0;">
        <label>Title *</label>
        <input type="text" id="bookTitle" name="title" required placeholder="Enter book title">
      </div>

      <div class="form-group" style="margin: 0;">
        <label>Author (Select or Type New) *</label>
        <div style="position: relative;">
            <input type="text" name="new_author_name" list="authorList" required placeholder="Type to search or add new author...">
            <datalist id="authorList">
                {% for a in authors %}
                <option value="{{ a.name }}">
                {% endfor %}
            </datalist>
            <!-- Hidden ID field if we want to prioritize ID selection, but name-based lookup is safer for mixed mode -->
            <input type="hidden" name="author_id"> 
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
          <div class="form-group" style="margin: 0;">
              <label>Series (Optional)</label>
              <input type="text" name="new_series_name" list="seriesList" placeholder="Search or add new series...">
              <datalist id="seriesList">
                  {% for s in series_list %}
                  <option value="{{ s.title }}">
                  {% endfor %}
              </datalist>
          </div>
          <div class="form-group" style="margin: 0;">
              <label>Order #</label>
              <input type="number" name="series_order" min="1" placeholder="1">
          </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group" style="margin: 0;">
            <label>Category *</label>
            <select id="bookCategory" name="category" required>
              <option value="">Select Category</option>
              <option value="Fiction">Fiction</option>
              <option value="Non-Fiction">Non-Fiction</option>
              <option value="Science">Science</option>
              <option value="Technology">Technology</option>
              <option value="Reference">Reference</option>
              <option value="Biography">Biography</option>
              <option value="History">History</option>
            </select>
          </div>
          <div class="form-group" style="margin: 0;">
            <label>Total Copies *</label>
            <input type="number" id="bookCopies" name="copies" required min="1" placeholder="1">
          </div>
      </div>

       <div class="form-group" style="margin: 0;">
        <label>Upload E-Book (PDF)</label>
        <input type="file" name="pdf_file" accept="application/pdf">
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: var(--space-md);">
        <button type="submit" class="btn btn-primary">Add Book</button>
        <button type="button" class="btn btn-outline-secondary" onclick="closeModal('addBookModal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Book Modal -->
<div id="editBookModal" class="modal-overlay">
  <div class="modal-content glass-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
        <h2 style="margin: 0;">Edit Book</h2>
        <button type="button" class="btn-close" onclick="closeModal('editBookModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sub);">‚úï</button>
    </div>

    <form id="editBookForm" method="POST" style="display: grid; gap: 1.25rem;">
      <div class="form-group" style="margin: 0;">
        <label>Title *</label>
        <input type="text" id="editTitle" name="title" required>
      </div>

      <div class="form-group" style="margin: 0;">
        <label>Author (Select or Type New) *</label>
        <div style="position: relative;">
            <input type="text" id="editAuthorName" name="new_author_name" list="authorListEdit" required placeholder="Type to search or add new author...">
            <datalist id="authorListEdit">
                {% for a in authors %}
                <option value="{{ a.name }}">
                {% endfor %}
            </datalist>
            <input type="hidden" name="author_id" id="editAuthorId">
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
          <div class="form-group" style="margin: 0;">
              <label>Series (Optional)</label>
              <input type="text" id="editSeriesName" name="new_series_name" list="seriesListEdit" placeholder="Search or add new series...">
              <datalist id="seriesListEdit">
                  {% for s in series_list %}
                  <option value="{{ s.title }}">
                  {% endfor %}
              </datalist>
              <input type="hidden" name="series_id" id="editSeriesId">
          </div>
          <div class="form-group" style="margin: 0;">
              <label>Order #</label>
              <input type="number" id="editOrder" name="series_order" min="1">
          </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group" style="margin: 0;">
            <label>Category *</label>
            <select id="editCategory" name="category" required>
              <option value="Fiction">Fiction</option>
              <option value="Non-Fiction">Non-Fiction</option>
              <option value="Science">Science</option>
              <option value="Technology">Technology</option>
              <option value="Reference">Reference</option>
              <option value="Biography">Biography</option>
              <option value="History">History</option>
            </select>
          </div>
          <div class="form-group" style="margin: 0;">
            <label>Total Copies *</label>
            <input type="number" id="editCopies" name="copies" required min="1">
          </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: var(--space-md);">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn btn-outline-secondary" onclick="closeModal('editBookModal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteBookModal" class="modal-overlay">
  <div class="modal-content glass-card" style="max-width: 400px; text-align: center">
    <div style="display: flex; justify-content: flex-end;">
        <button type="button" class="btn-close" onclick="closeModal('deleteBookModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sub);">‚úï</button>
    </div>
    <div style="font-size: 3rem; margin-bottom: var(--space-md);">üóëÔ∏è</div>
    <h3 style="margin-bottom: var(--space-sm)">Delete Book</h3>
    <p id="deleteMessage" style="color: var(--text-sub); margin-bottom: var(--space-xs)"></p>
    <p style="color: var(--danger); font-size: 0.875rem; font-weight: 600; margin-bottom: var(--space-lg)">
       ‚ö†Ô∏è This action cannot be undone.
    </p>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem">
      <button type="button" class="btn btn-outline-secondary" onclick="closeModal('deleteBookModal')">Cancel</button>
      <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
    </div>
  </div>
</div>












<script>
  let bookToDelete = null;

  function openModal(modalId) {
    document.getElementById(modalId).style.display = "flex";
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
  }

  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const originalText = btn.innerHTML;
        btn.innerHTML = "<span>‚è≥</span>...";
        btn.disabled = true;

        try {
            const resp = await fetch(`/admin/books/get/${id}`);
            
            // Safety check for HTML responses (like redirects/errors)
            const contentType = resp.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                const text = await resp.text();
                const preview = text.substring(0, 200).replace(/</g, "&lt;");
                throw new Error(`Server returned status ${resp.status} (${contentType}). \nPreview: ${preview}...`);
            }

            const result = await resp.json();
            if (!result.success) throw new Error(result.error || "Unknown error");
            
            const book = result.data;

            // Populate Form
            document.getElementById("editTitle").value = book.title;
            
            // Handle Author (Input + Datalist)
            document.getElementById("editAuthorName").value = book.author_name || ""; 
            // document.getElementById("editAuthorId").value = book.author_id; // Optional

            document.getElementById("editCategory").value = book.category;
            document.getElementById("editCopies").value = book.total_copies;
            
            // Handle Series (Input + Datalist)
            document.getElementById("editSeriesName").value = book.series_title || "";
            // document.getElementById("editSeriesId").value = book.series_id; // Optional
            
            document.getElementById("editOrder").value = book.series_order || "";
            
            document.getElementById("editBookForm").action = `/admin/book/edit/${id}`;
            
            openModal("editBookModal");
        } catch (err) {
            alert("‚ùå Error: " + err.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        bookToDelete = btn.dataset.id;
        document.getElementById("deleteMessage").textContent =
          'Are you sure you want to delete "' + btn.dataset.title + '"?';
        openModal("deleteBookModal");
    });
  });

  document
    .getElementById("confirmDeleteBtn")
    .addEventListener("click", function () {
      if (bookToDelete) {
        // Create a form to submit POST request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/book/delete/' + bookToDelete;
        document.body.appendChild(form);
        form.submit();
      }
    });

  /* ISBN Fetcher Logic */
  document.getElementById('fetchIsbnBtn').addEventListener('click', async () => {
    const isbn = document.getElementById('isbnInput').value.trim();
    const feedback = document.getElementById('isbnFeedback');
    const btn = document.getElementById('fetchIsbnBtn');
    
    if(!isbn) {
        feedback.innerText = "‚ùå Please enter an ISBN first.";
        return;
    }
    
    feedback.innerText = "üîç Searching global databases...";
    feedback.style.color = "var(--text-sub)";
    btn.disabled = true;
    
    try {
        const resp = await fetch('/admin/book/fetch-metadata', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ isbn })
        });
        
        const data = await resp.json();
        btn.disabled = false;
        
        if(data.error) {
            feedback.innerText = "‚ö†Ô∏è " + data.error;
            feedback.style.color = "#ef4444";
        } else {
            // Populate form
            document.getElementById('bookTitle').value = data.title;
            
            // Handle Category select
            const catSelect = document.getElementById('bookCategory');
            let found = false;
            for(let opt of catSelect.options) {
                if(opt.value.toLowerCase() === data.category.toLowerCase()) {
                    catSelect.value = opt.value;
                    found = true;
                    break;
                }
            }
            if(!found) {
                // Add new category if doesn't exist
                const newOpt = new Option(data.category, data.category);
                catSelect.add(newOpt);
                catSelect.value = data.category;
            }
            
            // Handle Author (Requires checking IDs)
            const authorSelect = document.querySelector('select[name="author_id"]');
            if(data.author_id) {
                authorSelect.value = data.author_id;
                feedback.innerHTML = "‚úÖ Found: <strong>" + data.title.replace(/'/g, "\\'") + "</strong> by " + data.author_name.replace(/'/g, "\\'");
            } else {
                feedback.innerHTML = "‚ö†Ô∏è Found <strong>" + data.title.replace(/'/g, "\\'") + "</strong>, but author <strong>" + data.author_name.replace(/'/g, "\\'") + "</strong> needs to be added first.";
            }
            feedback.style.color = "#10b981";
        }
    } catch (err) {
        btn.disabled = false;
        feedback.innerText = "‚ùå Connection error.";
        feedback.style.color = "#ef4444";
    }
  });

  document
    .getElementById("addBookForm")
    .addEventListener("submit", function (e) {
      // Logic removed to allow real submission
    });

  // Close modal when clicking outside
  document
    .getElementById("addBookModal")
    .addEventListener("click", function (e) {
      if (e.target === this) closeModal("addBookModal");
    });
  document
    .getElementById("deleteBookModal")
    .addEventListener("click", function (e) {
      if (e.target === this) closeModal("deleteBookModal");
    });
</script>
<script>
// Redesigned Series Modal Logic
let currentSeriesId = null;
let currentSeriesTitle = '';

function backToSeriesGrid() {
    document.getElementById('series-detail-view').style.display = 'none';
    document.getElementById('series-grid-view').style.display = 'flex';
}

async function openSeriesDetails(seriesId, title) {
    currentSeriesId = seriesId;
    currentSeriesTitle = title;
    
    // UI Switch
    document.getElementById('series-grid-view').style.display = 'none';
    document.getElementById('series-detail-view').style.display = 'flex';
    
    // Set Header
    document.getElementById('detail-series-title').innerText = title;
    
    const container = document.getElementById('detail-books-container');
    container.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--text-sub);">Loading books...</div>';
    
    // Fetch Data
    try {
        const res = await fetch(`/api/series/${seriesId}/books`);
        const books = await res.json();
        
        if (books.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 4rem;">
                    <div style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;">üìö</div>
                    <p style="color: var(--text-sub);">No books in this series yet.</p>
                </div>`;
        } else {
            let html = '<div class="book-list-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">';
            books.forEach(b => {
                html += `
                <div style="display: flex; gap: 1rem; padding: 1rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; align-items: center;">
                    <div style="font-size: 2rem;">üìñ</div>
                    <div>
                        <h4 style="margin: 0; font-size: 1rem;">${b.title}</h4>
                        <span class="badge badge-pending">Vol. ${b.series_order || '?'}</span>
                    </div>
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }
    } catch (err) {
        console.error(err);
        container.innerHTML = `<div style="color: var(--danger); text-align: center;">Error loading content.</div>`;
    }
}

function renameCurrentSeries() {
    const newName = prompt("Rename series:", currentSeriesTitle);
    if(newName && newName !== currentSeriesTitle) {
        // Create hidden form to submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/series/rename';
        const idInput = document.createElement('input');
        idInput.name = 'series_id'; idInput.value = currentSeriesId;
        const nameInput = document.createElement('input');
        nameInput.name = 'new_name'; nameInput.value = newName;
        form.appendChild(idInput); form.appendChild(nameInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteCurrentSeries() {
    if(confirm("Delete this series? Books will remain in library.")) {
         const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/series/delete/' + currentSeriesId;
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}

</file>

<file path="templates\admin\community_hub.html">
{% extends "layout.html" %}

{% block title %}Community Hub{% endblock %}
{% block header_title %}Community Hub{% endblock %}
{% block header_subtitle %}Manage global chat, groups, and system logs.{% endblock %}

{% block head %}
<style>
    /* Tab Navigation */
    .hub-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--border);
        padding-bottom: 0.5rem;
    }
    .hub-tab {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        background: transparent;
        color: var(--text-sub);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }
    .hub-tab:hover {
        background: rgba(0,0,0,0.05);
        color: var(--primary);
    }
    .hub-tab.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
    }

    /* Logs Table */
    .logs-table-container {
        max-height: 500px;
        overflow-y: auto;
    }
    .log-item {
        display: grid;
        grid-template-columns: 50px 150px 150px 1fr 150px;
        gap: 1rem;
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        align-items: center;
        transition: background 0.2s;
    }
    .log-item:hover {
        background: rgba(0,0,0,0.02);
    }
    .log-user img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    /* Database Stats */
    .db-stat-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
</style>
{% endblock %}

{% block content %}

<!-- Tab Control -->
<div class="hub-tabs">
    <button class="hub-tab active" onclick="switchTab('overview')">Overview</button>
    <button class="hub-tab" onclick="switchTab('logs')">System Logs</button>
    <button class="hub-tab" onclick="switchTab('database')">Database Management</button>
</div>

<!-- SECTION: OVERVIEW -->
<div id="tab-overview" class="hub-section">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
        <!-- Global Chat Launcher -->
        <div class="glass-card" style="grid-column: 1 / -1; padding: 0; overflow: hidden; height: 750px; position: relative;">
            <iframe src="/member/community?embed=true" style="width: 100%; height: 100%; border: none;"></iframe>
            
            <!-- Admin Overlay Note -->
            <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; pointer-events: none;">
                üëÅÔ∏è Admin View
            </div>
        </div>


    </div>
</div>

<!-- SECTION: LOGS -->
<div id="tab-logs" class="hub-section" style="display: none;">
    <div class="glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>üõ°Ô∏è Audit Logs</h3>
            <button onclick="loadLogs()" class="btn btn-sm btn-outline-secondary"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
        
        <div class="logs-table-container">
            <div class="log-item" style="font-weight: 700; background: rgba(0,0,0,0.05);">
                <span>#</span>
                <span>User</span>
                <span>Action</span>
                <span>Details</span>
                <span>Time</span>
            </div>
            <div id="logs-list">
                <!-- Injected via JS -->
                <div style="padding: 2rem; text-align: center; color: var(--text-sub);">Loading logs...</div>
            </div>
        </div>
    </div>
</div>

<!-- SECTION: DATABASE MANAGEMENT -->
<div id="tab-database" class="hub-section" style="display: none;">
    <!-- Danger Zone Card -->
    <div class="glass-card" style="border: 1px solid rgba(239, 68, 68, 0.3); background: linear-gradient(135deg, rgba(239,68,68,0.05) 0%, rgba(239,68,68,0.02) 100%); position: relative; overflow: hidden;">
        <div style="position: absolute; top: 0; right: 0; width: 200px; height: 100%; background: linear-gradient(90deg, transparent, rgba(239,68,68,0.1)); pointer-events: none;"></div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative; z-index: 1;">
            <div>
                <h3 style="color: var(--danger); display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; font-size: 1.25rem;">
                    <span style="background: rgba(239,68,68,0.1); padding: 8px; border-radius: 8px;"><i class="fas fa-radiation"></i></span> 
                    Danger Zone
                </h3>
                <p style="color: var(--text-sub); margin: 0; font-size: 0.9rem; max-width: 600px;">
                    Administrative actions here are <strong style="color: var(--danger);">irreversible</strong>. Please proceed with caution.
                </p>
            </div>
            <button onclick="confirmWipe()" class="btn" style="background: var(--danger); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); transition: transform 0.2s;">
                <i class="fas fa-trash-alt me-2"></i> Wipe All Data
            </button>
        </div>
        
        <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 12px; font-size: 0.85rem; border-left: 3px solid var(--danger); color: var(--text-main);">
            <strong>Notice:</strong> This will delete ALL private messages, group chats, and history for all users. The structure of the <strong>Global Community (ID 1)</strong> will be preserved, but its messages may be cleared.
        </div>
    </div>

    <!-- Active Chats Grid -->
    <div style="margin-top: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 style="margin-bottom: 0.25rem;">üìÇ Active Chat Groups</h3>
                <p style="color: var(--text-sub); margin: 0; font-size: 0.9rem;">Real-time database records of all active channels.</p>
            </div>
            <div class="search-box glass-input-wrapper" style="width: 300px; padding: 0.5rem 1rem;">
                <i class="fas fa-search" style="color: var(--text-sub);"></i>
                <input type="text" placeholder="Search groups..." onkeyup="filterChats(this.value)" style="border: none; background: transparent; outline: none; width: 100%; margin-left: 0.5rem;">
            </div>
        </div>
        
        <div class="glass-card" style="padding: 0; overflow: hidden;">
            <table class="table" style="width: 100%; margin: 0; border-collapse: separate; border-spacing: 0;">
                <thead>
                    <tr style="background: rgba(0,0,0,0.02); text-align: left; color: var(--text-sub); font-size: 0.8rem; letter-spacing: 0.5px; text-transform: uppercase;">
                        <th style="padding: 1.25rem 1.5rem; font-weight: 600;">Channel Info</th>
                        <th style="padding: 1.25rem; font-weight: 600;">Type</th>
                        <th style="padding: 1.25rem; font-weight: 600;">Owner</th>
                        <th style="padding: 1.25rem; font-weight: 600;">Activity</th>
                        <th style="padding: 1.25rem 1.5rem; text-align: right; font-weight: 600;">Actions</th>
                    </tr>
                </thead>
                <tbody id="chats-list">
                   <!-- Injected via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// --- TABS ---
function switchTab(tabName) {
    document.querySelectorAll('.hub-section').forEach(el => el.style.display = 'none');
    document.getElementById('tab-' + tabName).style.display = 'block';
    
    document.querySelectorAll('.hub-tab').forEach(el => el.classList.remove('active'));
    event.target.classList.add('active');
    
    if(tabName === 'logs') loadLogs();
    if(tabName === 'database') loadChats();
}

// --- LOGS API ---
async function loadLogs() {
    const container = document.getElementById('logs-list');
    try {
        const res = await fetch('/admin/api/logs');
        const data = await res.json();
        
        if (data.success) {
            container.innerHTML = data.logs.map(l => `
                <div class="log-item">
                    <span style="color: var(--text-sub); font-size: 0.8rem;">${l.id}</span>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <img src="/static/uploads/profile_pics/${l.user_pic || 'default.jpg'}" style="width: 24px; height: 24px; border-radius: 50%;">
                        <span style="font-weight: 600; font-size: 0.9rem;">${l.user}</span>
                    </div>
                    <span class="badge" style="background: rgba(0,0,0,0.05); width: fit-content;">${l.action}</span>
                    <span style="color: var(--text-sub); font-size: 0.9rem;">${l.details}</span>
                    <span style="color: var(--text-sub); font-size: 0.8rem;">${l.time}</span>
                </div>
            `).join('');
        }
    } catch (err) {
        container.innerHTML = `<div style="padding: 1rem; color: var(--danger);">Error loading logs: ${err}</div>`;
    }
}

// --- CHATS API ---
async function loadChats() {
    const container = document.getElementById('chats-list');
    try {
        const res = await fetch('/admin/api/chats');
        const data = await res.json();
        
        if (data.success) {
            container.innerHTML = data.chats.map(c => `
                <tr style="transition: background 0.2s;">
                    <td style="padding: 1rem 1.5rem; vertical-align: middle;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 40px; height: 40px; border-radius: 12px; background: ${c.channel_id === 1 ? 'linear-gradient(135deg, #6366f1, #a855f7)' : 'rgba(0,0,0,0.05)'}; color: ${c.channel_id === 1 ? 'white' : 'var(--text-sub)'}; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem;">
                                ${c.channel_id === 1 ? 'üåê' : c.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-main);">${c.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-sub);">ID: #${c.channel_id}</div>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 1rem; vertical-align: middle;">
                        <span class="badge" style="background: rgba(0,0,0,0.05); color: var(--text-main); font-weight: 500; padding: 6px 12px; border-radius: 20px; text-transform: capitalize; border: 1px solid var(--border);">
                            ${c.type}
                        </span>
                    </td>
                    <td style="padding: 1rem; vertical-align: middle;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${c.owner_name ? `<div style="width: 24px; height: 24px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">${c.owner_name.charAt(0)}</div>` : ''}
                            <span style="color: var(--text-sub); font-size: 0.9rem;">${c.owner_name || 'System'}</span>
                        </div>
                    </td>
                    <td style="padding: 1rem; vertical-align: middle;">
                        <div style="font-weight: 600; font-size: 0.9rem;">${c.msg_count}</div>
                        <div style="font-size: 0.7rem; color: var(--text-sub);">messages</div>
                    </td>
                    <td style="padding: 1rem 1.5rem; vertical-align: middle; text-align: right;">
                        ${c.channel_id != 1 ? 
                        `<button onclick="deleteChat(${c.channel_id})" class="btn btn-sm" style="color: var(--danger); background: rgba(239, 68, 68, 0.1); border-radius: 8px; width: 36px; height: 36px; transition: all 0.2s;" title="Delete Channel" onmouseover="this.style.background='var(--danger)'; this.style.color='white'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.color='var(--danger)'"><i class="fas fa-trash-alt"></i></button>` : 
                        `<span style="color: var(--primary); font-size: 0.8rem; font-weight: 600; background: rgba(79, 70, 229, 0.1); padding: 4px 10px; border-radius: 6px;"><i class="fas fa-shield-alt me-1"></i> Core</span>`}
                    </td>
                </tr>
            `).join('');
        }
    } catch (err) {
        container.innerHTML = `<tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--danger);">Error: ${err}</td></tr>`;
    }
}

function filterChats(query) {
    const rows = document.querySelectorAll("#chats-list tr");
    query = query.toLowerCase();
    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(query) ? "" : "none";
    });
}

// -- ACTIONS --
async function deleteChat(id) {
    if(!confirm("Are you sure you want to delete this chat permanently?")) return;
    
    try {
        const res = await fetch(`/admin/api/chat/delete/${id}`, {method: 'POST'});
        const data = await res.json();
        if(data.success) {
            loadChats(); // Refresh
        } else {
            alert("Error: " + data.error);
        }
    } catch(err) {
        alert("Request failed");
    }
}

async function confirmWipe() {
    const code = prompt("Type 'CONFIRM' to wipe all non-global chat data. This cannot be undone.");
    if (code !== 'CONFIRM') return;
    
    try {
        const res = await fetch('/admin/api/chat/wipe', {method: 'POST'});
        const data = await res.json();
        if(data.success) {
            alert("‚úÖ System wiped successfully.");
            loadChats();
        } else {
            alert("Error: " + data.error);
        }
    } catch(err) {
        alert("Request failed");
    }
}
</script>
{% endblock %}

</file>

<file path="templates\admin\edit_author.html">
{% extends "layout.html" %}

{% block title %}Edit {{ author.name }}{% endblock %}
{% block header_title %}Edit Profile: {{ author.name }}{% endblock %}
{% block header_subtitle %}Update public biography and profile photo URL.{% endblock %}

{% block content %}
<div class="glass-card" style="max-width: 800px; margin: 0 auto; padding: 2rem;">
    <form action="/admin/author/edit/{{ author.author_id }}" method="POST">
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Photo URL</label>
            <input type="text" name="photo_src" value="{{ author.photo_src or '' }}" class="form-control" placeholder="https://example.com/photo.jpg">
            {% if author.photo_src %}
            <div style="margin-top: 1rem; width: 100px; height: 100px; border-radius: 50%; overflow: hidden; border: 2px solid var(--primary);">
                <img src="{{ author.photo_src }}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            {% endif %}
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Biography</label>
            <textarea name="bio" class="form-control" rows="10" placeholder="Write a short biography for this author...">{{ author.bio or '' }}</textarea>
        </div>

        <div style="display: flex; gap: 1rem; border-top: 1px solid var(--border); padding-top: 1.5rem;">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="/admin/authors" class="btn btn-outline-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

</file>

<file path="templates\admin\health.html">
{% extends "layout.html" %}

{% block title %}System Health{% endblock %}
{% block header_title %}System Health Monitor{% endblock %}
{% block header_subtitle %}Real-time monitoring of server vitals and database connectivity.{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <!-- DB HEALTH -->
    <div class="glass-card" style="padding: 1.5rem; border-left: 4px solid {% if health.database.status == 'Online' %}#10b981{% else %}#ef4444{% endif %};">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">üóÑÔ∏è Database</h3>
            <span class="badge" style="background: {% if health.database.status == 'Online' %}#ecfdf5{% else %}#fef2f2{% endif %}; color: {% if health.database.status == 'Online' %}#047857{% else %}#991b1b{% endif %};">
                {{ health.database.status }}
            </span>
        </div>
        <div style="font-size: 0.875rem; color: var(--text-sub);">
            Latency: <strong style="color: var(--text-main);">{{ health.database.latency_ms }}ms</strong>
        </div>
    </div>

    <!-- CPU HEALTH -->
    <div class="glass-card" style="padding: 1.5rem;">
        <h3 style="margin: 0 0 1rem 0;">üíª CPU Usage</h3>
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-weight: 600;">
            <span>Load</span>
            <span>{{ health.cpu }}%</span>
        </div>
        <div style="height: 8px; background: rgba(0,0,0,0.05); border-radius: 4px; overflow: hidden;">
            <div style="height: 100%; width: {{ health.cpu }}%; background: {% if health.cpu < 70 %}#10b981{% elif health.cpu < 90 %}#f59e0b{% else %}#ef4444{% endif %};"></div>
        </div>
    </div>

    <!-- MEMORY HEALTH -->
    <div class="glass-card" style="padding: 1.5rem;">
        <h3 style="margin: 0 0 1rem 0;">üß† Memory</h3>
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-weight: 600;">
            <span>{{ health.memory.used_mb }} MB / {{ health.memory.total_mb }} MB</span>
            <span>{{ health.memory.percent }}%</span>
        </div>
        <div style="height: 8px; background: rgba(0,0,0,0.05); border-radius: 4px; overflow: hidden;">
            <div style="height: 100%; width: {{ health.memory.percent }}%; background: {% if health.memory.percent < 70 %}#10b981{% elif health.memory.percent < 90 %}#f59e0b{% else %}#ef4444{% endif %};"></div>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 1.5rem;">
    <!-- DISK USAGE -->
    <section class="dashboard-section" style="margin-top: 0;">
        <div class="section-header"><h2>üíΩ Disk Storage</h2></div>
        <div class="glass-card" style="padding: 1.5rem;">
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-weight: 600;">
                    <span>Used Space</span>
                    <span>{{ health.disk.percent }}%</span>
                </div>
                <div style="height: 12px; background: rgba(0,0,0,0.05); border-radius: 6px; overflow: hidden;">
                    <div style="height: 100%; width: {{ health.disk.percent }}%; background: #6366f1;"></div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-sub);">Used</div>
                    <div style="font-weight: 700;">{{ health.disk.used_gb }} GB</div>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-sub);">Free</div>
                    <div style="font-weight: 700;">{{ health.disk.free_gb }} GB</div>
                </div>
            </div>
        </div>
    </section>

    <!-- RECENT ERRORS -->
    <section class="dashboard-section" style="margin-top: 0;">
        <div class="section-header"><h2>üö® Recent Errors</h2></div>
        <div class="glass-card" style="padding: 0; overflow: hidden;">
            {% if not logs %}
            <div style="padding: 2rem; text-align: center; color: #10b981;">
                ‚úÖ No critical errors reported in recent cycles.
            </div>
            {% else %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: rgba(0,0,0,0.02); text-align: left;">
                    <tr>
                        <th style="padding: 12px; font-size: 0.8rem;">Timestamp</th>
                        <th style="padding: 12px; font-size: 0.8rem;">Module</th>
                        <th style="padding: 12px; font-size: 0.8rem;">Message</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr style="border-top: 1px solid var(--border);">
                        <td style="padding: 12px; font-size: 0.8rem; color: var(--text-sub);">{{ log.timestamp.strftime('%H:%M:%S') }}</td>
                        <td style="padding: 12px; font-size: 0.8rem;"><span class="badge badge-danger">ERROR</span></td>
                        <td style="padding: 12px; font-size: 0.8rem; font-family: monospace;">{{ log.details[:50] }}...</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </section>
</div>
{% endblock %}

</file>

<file path="templates\admin\issues.html">
{% extends "layout.html" %}

{% block title %}Issue & Return{% endblock %}
{% block header_title %}Circulation Center{% endblock %}
{% block header_subtitle %}Issue books to members and process returns.{% endblock %}

{% block content %}
<!-- FORMS ROW -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
    <!-- ISSUE BOOK -->
    <section class="dashboard-section">
        <div class="section-header">
            <h2>üì§ Issue Book</h2>
        </div>
        <div class="section-content glass-card">
            <form action="/admin/issue" method="POST">
                <div class="form-group">
                    <label>Member</label>
                    <select name="user_id" required>
                        <option value="" disabled selected>Select user...</option>
                        {% for u in users %}
                        <option value="{{ u.user_id }}">{{ u.name }} (ID: {{ u.user_id }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Book</label>
                    <select name="book_id" required>
                        <option value="" disabled selected>Select book...</option>
                        {% for b in books %}
                        <option value="{{ b.book_id }}">{{ b.title }} (ID: {{ b.book_id }})</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Complete Issue</button>
            </form>
        </div>
    </section>

    <!-- RETURN BOOK -->
    <section class="dashboard-section">
        <div class="section-header">
            <h2>üì• Return Book</h2>
        </div>
        <div class="section-content glass-card">
            <form action="/admin/return" method="POST" id="returnBookForm">
                <div class="form-group">
                    <label>Member</label>
                    <select name="user_id" id="returnMemberSelect" required>
                        <option value="" disabled selected>Select user...</option>
                        {% for u in users %}
                        <option value="{{ u.user_id }}">{{ u.name }} (ID: {{ u.user_id }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Book</label>
                    <select name="book_id" id="returnBookSelect" required disabled>
                        <option value="" disabled selected>Select member first...</option>
                    </select>
                    <small id="returnBookHelp" style="color: var(--text-sub); margin-top: 0.25rem; display: block;"></small>
                </div>
                <button type="submit" class="btn btn-danger" id="returnSubmitBtn" style="width: 100%;" disabled>Process Return</button>
            </form>
        </div>
    </section>
</div>

<script>
// Dynamic Return Book filtering - shows only books borrowed by selected member
document.getElementById('returnMemberSelect').addEventListener('change', async function() {
    const userId = this.value;
    const bookSelect = document.getElementById('returnBookSelect');
    const bookHelp = document.getElementById('returnBookHelp');
    const submitBtn = document.getElementById('returnSubmitBtn');
    
    // Reset and disable while loading
    bookSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
    bookSelect.disabled = true;
    submitBtn.disabled = true;
    bookHelp.textContent = '';
    
    if (!userId) {
        bookSelect.innerHTML = '<option value="" disabled selected>Select member first...</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/user/${userId}/borrowed-books`);
        if (!response.ok) throw new Error('Failed to fetch books');
        
        const books = await response.json();
        
        if (books.length === 0) {
            bookSelect.innerHTML = '<option value="" disabled selected>No borrowed books</option>';
            bookHelp.textContent = 'This member has no books to return.';
            bookHelp.style.color = 'var(--warning)';
            submitBtn.disabled = true;
        } else {
            let options = '<option value="" disabled selected>Select book to return...</option>';
            books.forEach(book => {
                options += `<option value="${book.book_id}">${book.title} (ID: ${book.book_id})</option>`;
            });
            bookSelect.innerHTML = options;
            bookSelect.disabled = false;
            bookHelp.textContent = `${books.length} book(s) currently borrowed.`;
            bookHelp.style.color = 'var(--success)';
            submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('Error fetching borrowed books:', error);
        bookSelect.innerHTML = '<option value="" disabled selected>Error loading books</option>';
        bookHelp.textContent = 'Failed to load borrowed books.';
        bookHelp.style.color = 'var(--danger)';
    }
});
</script>

<!-- ACTIVE ISSUES -->
<section class="dashboard-section">
    <div class="section-header">
        <h2>üîñ Currently Borrowed</h2>
    </div>
    <div class="section-content">
        <div class="table-container glass-card">
            <table>
                <thead>
                    <tr>
                        <th>Issue ID</th>
                        <th>User</th>
                        <th>Book</th>
                        <th>Issue Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in active_issues %}
                    <tr>
                        <td>#{{ i.issue_id }}</td>
                        <td style="font-weight: 500;">{{ i.user_name }}</td>
                        <td>{{ i.book_title }}</td>
                        <td>{{ i.issue_date }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center; color: var(--text-sub); padding: 2rem;">No active issues.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- PAST ISSUES -->
<section class="dashboard-section">
    <div class="section-header">
        <h2>üìö Borrowing History (Returned)</h2>
    </div>
    <div class="section-content">
        <div class="table-container glass-card">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Book</th>
                        <th>Issued</th>
                        <th>Returned</th>
                        <th>Fine</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in past_issues %}
                    <tr>
                        <td>#{{ i.issue_id }}</td>
                        <td style="font-weight: 500;">{{ i.user_name }}</td>
                        <td>{{ i.book_title }}</td>
                        <td>{{ i.issue_date }}</td>
                        <td>{{ i.return_date }}</td>
                        <td><span style="color: {{ 'var(--danger)' if i.fine > 0 else 'var(--success)' }};">{{ system_settings.currency_symbol }}{{ i.fine }}</span></td>
                        <td>
                            {% if i.fine > 0 %}
                                {% if i.fine_paid %}
                                    <span class="badge badge-success">PAID</span>
                                {% else %}
                                    <form action="/admin/fine/pay/{{ i.issue_id }}" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Collect</button>
                                    </form>
                                {% endif %}
                            {% else %}
                                <span style="color: var(--text-sub);">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>
{% endblock %}

</file>

<file path="templates\admin\overview.html">
{% extends "layout.html" %}

{% block title %}Admin Overview{% endblock %}
{% block header_title %}Dashboard Overview{% endblock %}
{% block header_subtitle %}Quick look at your library status{% endblock %}

{% block content %}
<!-- Premium Stats Grid -->
<div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <!-- Users Card -->
    <div class="glass-card stat-card-premium" style="display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem; position: relative; overflow: hidden;">
        <div style="width: 60px; height: 60px; border-radius: 12px; background: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; color: white; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);">
            <i class="fas fa-users"></i>
        </div>
        <div>
            <span style="display: block; font-size: 0.875rem; color: var(--text-sub); font-weight: 500; margin-bottom: 4px;">Total Users</span>
            <span style="display: block; font-size: 1.75rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">{{ quick_stats.total_users }}</span>
        </div>
    </div>

    <!-- Books Card -->
    <div class="glass-card stat-card-premium" style="display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem; position: relative; overflow: hidden;">
        <div style="width: 60px; height: 60px; border-radius: 12px; background: linear-gradient(135deg, #059669 0%, #34d399 100%); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; color: white; box-shadow: 0 10px 15px -3px rgba(5, 150, 105, 0.3);">
            <i class="fas fa-book"></i>
        </div>
        <div>
            <span style="display: block; font-size: 0.875rem; color: var(--text-sub); font-weight: 500; margin-bottom: 4px;">Total Books</span>
            <span style="display: block; font-size: 1.75rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">{{ quick_stats.total_books }}</span>
        </div>
    </div>

    <!-- Issues Card -->
    <div class="glass-card stat-card-premium" style="display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem; position: relative; overflow: hidden;">
        <div style="width: 60px; height: 60px; border-radius: 12px; background: linear-gradient(135deg, #d97706 0%, #fbbf24 100%); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; color: white; box-shadow: 0 10px 15px -3px rgba(217, 119, 6, 0.3);">
            <i class="fas fa-clipboard-list"></i>
        </div>
        <div>
            <span style="display: block; font-size: 0.875rem; color: var(--text-sub); font-weight: 500; margin-bottom: 4px;">Active Issues</span>
            <span style="display: block; font-size: 1.75rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">{{ quick_stats.total_issues }}</span>
        </div>
    </div>

    <!-- Fines Card -->
    <div class="glass-card stat-card-premium" style="display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem; position: relative; overflow: hidden;">
        <div style="width: 60px; height: 60px; border-radius: 12px; background: linear-gradient(135deg, #dc2626 0%, #f87171 100%); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; color: white; box-shadow: 0 10px 15px -3px rgba(220, 38, 38, 0.3);">
            <i class="fas fa-coins"></i>
        </div>
        <div>
            <span style="display: block; font-size: 0.875rem; color: var(--text-sub); font-weight: 500; margin-bottom: 4px;">Total Fines</span>
            <span style="display: block; font-size: 1.75rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">{{ system_settings.currency_symbol }}{{ quick_stats.total_fines }}</span>
        </div>
    </div>
</div>

<!-- Analytics Charts -->
<div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
    <!-- Monthly Trends -->
    <div class="glass-card" style="padding: 1.5rem; min-height: 400px; display: flex; flex-direction: column;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="width: 8px; height: 8px; background: #4f46e5; border-radius: 50%; display: inline-block;"></span>
                Monthly Trends
            </h3>
            <span class="badge" style="background: rgba(79, 70, 229, 0.1); color: #4f46e5;">Borrowing</span>
        </div>
        <div style="flex: 1; position: relative; min-height: 0;">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

    <!-- Category Distribution -->
    <div class="glass-card" style="padding: 1.5rem; min-height: 400px; display: flex; flex-direction: column;">
         <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="width: 8px; height: 8px; background: #059669; border-radius: 50%; display: inline-block;"></span>
                Top Categories
            </h3>
            <span class="badge" style="background: rgba(5, 150, 105, 0.1); color: #059669;">Inventory</span>
        </div>
        <div style="flex: 1; position: relative; min-height: 0;">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>

    <!-- User Demographics -->
    <div class="glass-card" style="padding: 1.5rem; min-height: 400px; display: flex; flex-direction: column;">
         <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="width: 8px; height: 8px; background: #d97706; border-radius: 50%; display: inline-block;"></span>
                User Demographics
            </h3>
            <span class="badge" style="background: rgba(217, 119, 6, 0.1); color: #d97706;">Members</span>
        </div>
        <div style="flex: 1; position: relative; min-height: 0; display: flex; justify-content: center; align-items: center;">
            <canvas id="userChart" style="max-height: 280px;"></canvas>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<section style="margin-top: 2.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
            <h2 style="margin: 0; font-size: 1.25rem; font-weight: 700;">Recent Activity</h2>
            <p style="margin: 0.25rem 0 0; color: var(--text-sub); font-size: 0.9rem;">Latest check-outs and returns</p>
        </div>
        <a href="/admin/issues" class="btn btn-outline-primary btn-sm" style="border-radius: 20px; padding: 0.5rem 1.25rem;">View All Activity</a>
    </div>

    <div class="glass-card" style="padding: 0; overflow: hidden;">
        <div class="table-responsive">
            <table class="table" style="margin: 0; width: 100%;">
                <thead style="background: rgba(0,0,0,0.02); border-bottom: 1px solid var(--border);">
                    <tr>
                        <th style="padding: 1rem 1.5rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600;">Issue ID</th>
                        <th style="padding: 1rem 1.5rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600;">User</th>
                        <th style="padding: 1rem 1.5rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600;">Book</th>
                        <th style="padding: 1rem 1.5rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600;">Issue Date</th>
                        <th style="padding: 1rem 1.5rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600; text-align: right;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in recent_issues %}
                    <tr style="border-bottom: 1px solid var(--border); transition: background 0.2s;">
                        <td style="padding: 1rem 1.5rem; font-weight: 600; color: var(--primary);">#{{ i.issue_id }}</td>
                        <td style="padding: 1rem 1.5rem;">
                             <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 32px; height: 32px; background: var(--bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--text-sub);">
                                    <i class="fas fa-user"></i>
                                </div>
                                <span style="font-weight: 500;">{{ i.user_name }}</span>
                            </div>
                        </td>
                        <td style="padding: 1rem 1.5rem;">{{ i.book_title }}</td>
                        <td style="padding: 1rem 1.5rem; color: var(--text-sub);">{{ i.issue_date }}</td>
                        <td style="padding: 1rem 1.5rem; text-align: right;">
                            <a href="/admin/issues" class="btn btn-sm btn-link" style="padding: 0; color: var(--text-sub);"><i class="fas fa-chevron-right"></i></a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-sub); padding: 3rem;">
                            <div style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;">üí§</div>
                            No recent activity found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 1. Monthly Trends Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    const monthlyLabels = [{% for s in monthly_stats %}"{{ s.month }}",{% endfor %}];
    const monthlyData = [{% for s in monthly_stats %}{{ s.count }},{% endfor %}];
    
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: monthlyLabels,
            datasets: [{
                label: 'Books Issued',
                data: monthlyData,
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#4e73df'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            devicePixelRatio: 2, // High-res for zooming
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 20
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        precision: 0
                    }
                }
            }
        }
    });

    // 2. Category Distribution Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const catLabels = [{% for s in category_stats %}"{{ s.category }}",{% endfor %}];
    const catData = [{% for s in category_stats %}{{ s.total_issues }},{% endfor %}];
    
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: catLabels,
            datasets: [{
                data: catData,
                backgroundColor: [
                    '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                    '#858796', '#5a5c69', '#2c3e50', '#e67e22', '#16a085'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            devicePixelRatio: 2,
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 15
                    }
                }
            }
        }
    });

    // 3. User Demographics Chart
    const userCtx = document.getElementById('userChart').getContext('2d');
    const userLabels = [{% for s in user_stats %}"{{ s.role|capitalize }}",{% endfor %}];
    const userData = [{% for s in user_stats %}{{ s.count }},{% endfor %}];
    
    new Chart(userCtx, {
        type: 'pie',
        data: {
            labels: userLabels,
            datasets: [{
                data: userData,
                backgroundColor: ['#4e73df', '#1cc88a', '#f6c23e'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            devicePixelRatio: 2,
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 20
                    }
                }
            }
        }
    });
</script>
{% endblock %}

</file>

<file path="templates\admin\purchase_list.html">
{% extends "layout.html" %}

{% block title %}Purchase List{% endblock %}
{% block header_title %}Purchase List{% endblock %}
{% block header_subtitle %}Review and finalize book purchases from approved suggestions{% endblock %}

{% block content %}
<!-- MANUAL ADD SECTION -->
<div class="glass-card" style="margin-bottom: 2rem; padding: 1.5rem;">
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
        <span style="font-size: 1.5rem;">‚ûï</span>
        <div>
            <h3 style="margin: 0; font-size: 1.1rem;">Add Book to Purchase List</h3>
            <p style="margin: 0; font-size: 0.85rem; color: var(--text-sub);">Manually add a book you want to purchase</p>
        </div>
    </div>
    <form action="{{ url_for('admin.admin_add_manual_purchase') }}" method="POST" style="display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 1rem; align-items: end;">
        <div class="form-group" style="margin: 0;">
            <label>Book Title</label>
            <input type="text" name="title" placeholder="Enter book title..." required class="form-control">
        </div>
        <div class="form-group" style="margin: 0;">
            <label>Author</label>
            <input type="text" name="author" placeholder="Enter author name..." required class="form-control">
        </div>
        <div class="form-group" style="margin: 0;">
            <label>Notes (Optional)</label>
            <input type="text" name="notes" placeholder="ISBN, publisher, reason..." class="form-control">
        </div>
        <button type="submit" class="btn btn-primary" style="height: 42px;">
            <span>üì•</span> Add to List
        </button>
    </form>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Approved Books (Ready to Purchase)</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Suggestion ID</th>
                        <th>Book Details</th>
                        <th>Suggested By</th>
                        <th>Notes</th>
                        <th>Approved Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in pending_purchases %}
                    <tr>
                        <td>#{{ p.suggestion_id }}</td>
                        <td>
                            <div style="font-weight: 600; color: #2c3e50;">{{ p.title }}</div>
                            <div style="font-size: 0.85rem; color: #6c757d;">{{ p.author }}</div>
                        </td>
                        <td>
                            <div>{{ p.user_name }}</div>
                            <!-- <div style="font-size: 0.8rem; color: #6c757d;">{{ p.email }}</div> -->
                        </td>
                        <td>
                            <div style="max-width: 200px; font-size: 0.9rem;">
                                {{ p.reason or '-' }}
                            </div>
                        </td>
                        <td>
                            {{ p.suggestion_date.strftime('%Y-%m-%d') if p.suggestion_date else '-' }}
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                <form action="{{ url_for('admin.admin_add_purchased_book', suggestion_id=p.suggestion_id) }}" method="POST" onsubmit="return confirm('Confirm purchase? This will add the book to the library inventory.');">
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <span class="icon">‚ûï</span> Add
                                    </button>
                                </form>
                                <form action="{{ url_for('admin.admin_remove_purchase', suggestion_id=p.suggestion_id) }}" method="POST" onsubmit="return confirm('Remove this item from the purchase list?');">
                                    <button type="submit" class="btn btn-danger btn-sm">
                                        <span class="icon">üóëÔ∏è</span> Remove
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 3rem; color: #6c757d;">
                            <i class="fas fa-shopping-cart fa-3x mb-3" style="opacity: 0.3;"></i>
                            <p>No books in the purchase list.</p>
                            <a href="/admin/suggestions" class="btn btn-primary btn-sm mt-2">Go to Suggestions</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .table td {
        vertical-align: middle;
    }
    .btn-success {
        background-color: #10b981;
        border: none;
        color: white;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .btn-success:hover {
        background-color: #059669;
        transform: translateY(-1px);
    }
</style>
{% endblock %}

</file>

<file path="templates\admin\requests.html">
{% extends "layout.html" %}

{% block title %}Pending Requests{% endblock %}
{% block header_title %}Member Requests{% endblock %}
{% block header_subtitle %}Approve or reject book requests from members.{% endblock %}

{% block content %}
<section class="dashboard-section">
    <div class="section-header">
        <h2>‚è≥ Pending Requests</h2>
        <span class="badge badge-pending">{{ pending_requests|length }} New</span>
    </div>
    <div class="section-content">
        <div class="table-container glass-card">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Date</th>
                        <th>User</th>
                        <th>Book</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in pending_requests %}
                    <tr>
                        <td>#{{ req.request_id }}</td>
                        <td>{{ req.request_date }}</td>
                        <td style="font-weight: 500;">{{ req.user_name }}</td>
                        <td>{{ req.book_title }}</td>
                        <td>
                            <form action="/admin/request/approve" method="POST" style="display:inline;">
                                <input type="hidden" name="request_id" value="{{ req.request_id }}">
                                <button type="submit" class="btn btn-primary btn-sm">Approve</button>
                            </form>
                            <form action="/admin/request/reject" method="POST" style="display:inline;">
                                <input type="hidden" name="request_id" value="{{ req.request_id }}">
                                <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-sub); padding: 2rem;">
                            No pending requests at the moment.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>
{% endblock %}

</file>

<file path="templates\admin\scanner.html">

{% extends "layout.html" %}

{% block title %}Scanner{% endblock %}
{% block header_title %}QR & Barcode Scanner{% endblock %}
{% block header_subtitle %}Quickly process books and members.{% endblock %}

{% block head %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
    .scanner-container {
        max-width: 600px;
        margin: 0 auto;
    }
    #reader {
        width: 100%;
        border-radius: 12px;
        overflow: hidden;
        background: black;
    }
    .result-card {
        margin-top: 1.5rem;
        padding: 1.5rem;
        text-align: center;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="scanner-container">
    <div class="glass-card">
        <div id="reader"></div>
        
        <div style="margin-top: 1rem; text-align: center;">
            <p style="color: var(--text-sub);">Point camera at a Book Barcode or QR Code.</p>
            <button id="stopBtn" class="btn btn-danger btn-sm" style="display: none;">Stop Camera</button>
            <button id="startBtn" class="btn btn-primary btn-sm">Start Camera</button>
        </div>
    </div>
    
    <div id="resultCard" class="glass-card result-card">
        <h3>üéâ Scanned Code!</h3>
        <p style="font-size: 1.25rem; font-weight: bold; color: var(--primary);" id="scanResult">---</p>
        
        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
            <a id="searchLink" href="#" class="btn btn-primary">Search Book</a>
            <a id="issueLink" href="#" class="btn btn-success">Issue Book</a>
        </div>
        
        <button onclick="restartScanner()" class="btn btn-secondary btn-sm" style="margin-top: 1rem;">Scan Another</button>
    </div>
</div>

<div id="insecureWarning" class="glass-card" style="display: none; border-left: 4px solid var(--danger); padding: 1.5rem; margin-bottom: 2rem;">
    <h3 style="color: var(--danger); margin-bottom: 0.5rem;">‚ö†Ô∏è Security Context Required</h3>
    <p>Camera access is blocked because you are using an insecure connection (HTTP over a network IP).</p>
    <div style="background: rgba(0,0,0,0.05); padding: 1rem; border-radius: 8px; margin-top: 1rem; font-size: 0.9rem; text-align: left;">
        <strong>How to fix:</strong><br>
        1. Access via <code>http://localhost:5000</code> if on the same machine.<br>
        2. <strong>Chrome/Brave/Edge:</strong> Go to <code>chrome://flags/#unsafely-treat-insecure-origin-as-secure</code><br>
        - Add <code>http://172.20.10.4:5000</code> to the list.<br>
        - Set to "Enabled" and Relaunch.
    </div>
</div>

<script>
    const isSecure = window.isSecureContext || window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
    if (!isSecure) {
        document.getElementById('insecureWarning').style.display = 'block';
    }

    const html5QrCode = new Html5Qrcode("reader");
    let isScanning = false;

    function onScanSuccess(decodedText, decodedResult) {
        // Handle the scanned code
        console.log(`Code matched = ${decodedText}`, decodedResult);
        
        // Stop scanning
        html5QrCode.stop().then(() => {
            isScanning = false;
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'inline-block';
            
            // Show result
            document.getElementById('scanResult').innerText = decodedText;
            document.getElementById('resultCard').style.display = 'block';
            
            // Update links
            document.getElementById('searchLink').href = "/admin/books?q=" + encodeURIComponent(decodedText);
            document.getElementById('issueLink').href = "/admin/issues?book_id=" + encodeURIComponent(decodedText);
            
        }).catch(err => {
            console.error("Failed to stop scanner", err);
        });
    }

    function onScanFailure(error) {
        // handle scan failure, usually better to ignore and keep scanning.
    }

    document.getElementById('startBtn').addEventListener('click', () => {
        if (!isSecure) {
             alert("‚ùå Browser blocked camera access. Please use 'localhost' or follow the instructions in the orange box above to whitelist this IP.");
             return;
        }

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
        .then(() => {
            isScanning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('resultCard').style.display = 'none';
        })
        .catch(err => {
            alert("Error starting camera: " + err + "\n\nTip: Ensure you are on HTTPS or localhost.");
        });
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
        html5QrCode.stop().then(() => {
            isScanning = false;
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'inline-block';
        });
    });
    
    function restartScanner() {
        document.getElementById('resultCard').style.display = 'none';
        document.getElementById('startBtn').click();
    }
</script>
{% endblock %}

</file>

<file path="templates\admin\series.html">
{% extends "layout.html" %}

{% block title %}Manage Book Series{% endblock %}
{% block header_title %}Series Collections{% endblock %}
{% block header_subtitle %}Organize your library collections into chronological sagas.{% endblock %}

{% block content %}
<style>
    .series-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }
    .series-card {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        transition: transform 0.3s;
        border-left: 4px solid var(--primary);
    }
    .series-card:hover { transform: translateY(-5px); }
    .book-count {
        font-size: 0.8rem;
        color: var(--text-sub);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
</style>

<div class="series-grid">
    {% if not series_list %}
    <div class="glass-card" style="grid-column: 1/-1; padding: 3rem; text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
        <h3>No Series Detected</h3>
        <p style="color: var(--text-sub);">The AI will automatically group books into series as you add them.</p>
    </div>
    {% else %}
    {% for s in series_list %}
    <div class="glass-card series-card">
        <h3 style="margin: 0; color: var(--text-main);">{{ s.title }}</h3>
        <span class="book-count">üìñ {{ s.book_count }} Books in Collection</span>
        <p style="font-size: 0.9rem; color: var(--text-sub); margin: 0.5rem 0;">{{ s.description or 'Automatic collection grouped by the intelligent system.' }}</p>
        
        <div style="margin-top: auto; padding-top: 1rem;">
            <a href="/admin/series/{{ s.series_id }}" class="btn btn-primary btn-block" style="text-align: center; text-decoration: none; display: block;">üîç View Full Series</a>
        </div>
    </div>
    {% endfor %}
    {% endif %}
</div>

<!-- Create Series Modal -->
<div class="fab-container" style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
    <button class="btn btn-primary btn-lg rounded-circle shadow" onclick="openModal('createSeriesModal')" 
            style="width: 65px; height: 65px; font-size: 2rem; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;">
        <span>+</span>
    </button>
</div>

<div id="createSeriesModal" class="modal-overlay">
    <div class="modal-content glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>Create New Series</h2>
            <button class="btn-close" onclick="closeModal('createSeriesModal')">‚úï</button>
        </div>
        <form action="/admin/series/create" method="POST">
            <div class="form-group">
                <label>Series Name</label>
                <input type="text" name="name" class="form-control" required placeholder="e.g. Harry Potter">
            </div>
            <div class="form-group" style="margin-top: 1rem;">
                <label>Description (Optional)</label>
                <textarea name="description" class="form-control" placeholder="A brief description of this saga..."></textarea>
            </div>
            <div style="margin-top: 1.5rem; text-align: right;">
                <button type="submit" class="btn btn-primary">Create Series</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openModal(id) { document.getElementById(id).style.display = "flex"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
</script>
{% endblock %}

</file>

<file path="templates\admin\series_details.html">
{% extends "layout.html" %}

{% block title %}Series: {{ series.title }}{% endblock %}
{% block header_title %}{{ series.title }}{% endblock %}
{% block header_subtitle %}Complete reading order for this collection.{% endblock %}

{% block content %}
<style>
    .series-timeline {
        position: relative;
        max-width: 800px;
        margin: 2rem auto;
        padding-left: 3rem;
        border-left: 2px dashed var(--border);
    }
    .timeline-item {
        position: relative;
        margin-bottom: 2rem;
        padding: 1.5rem;
        transition: transform 0.3s;
    }
    .timeline-item:hover { transform: translateX(10px); }
    .timeline-item::before {
        content: attr(data-order);
        position: absolute;
        left: -3.8rem;
        top: 1.5rem;
        width: 30px;
        height: 30px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 0.8rem;
        box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4);
    }
    .book-card-mini {
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }
    .book-thumb-mini {
        width: 60px;
        height: 90px;
        border-radius: 6px;
        object-fit: cover;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <a href="/admin/series" class="btn btn-outline-secondary btn-sm">‚¨ÖÔ∏è Back to All Series</a>
    <form action="/admin/series/delete/{{ series.series_id }}" method="POST" onsubmit="return confirm('Are you sure? This will NOT delete the books, only the series group.');">
        <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è Delete Series</button>
    </form>
</div>

<div class="series-timeline">
    {% if not books %}
    <div class="glass-card" style="padding: 2rem; text-align: center;">
        <p style="color: var(--text-sub);">No books found in this series.</p>
    </div>
    {% else %}
    {% for b in books %}
    <div class="glass-card timeline-item" data-order="{{ b.series_order or loop.index }}">
        <div class="book-card-mini">
            <img src="https://covers.openlibrary.org/b/title/{{ b.title|urlencode }}-S.jpg" 
                 class="book-thumb-mini" 
                 onerror="this.src='https://placehold.co/60x90?text={{ b.title[0] }}';">
            <div style="flex: 1;">
                <h3 style="margin: 0; font-size: 1.1rem;">{{ b.title }}</h3>
                <p style="margin: 0.25rem 0; font-size: 0.85rem; color: var(--text-sub);">by {{ author_name or 'Unknown Author' }}</p>
                <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                    <span class="badge" style="background: var(--stat-icon-bg); color: var(--primary);">{{ b.category }}</span>
                    <a href="/admin/books?q={{ b.title|urlencode }}" class="btn btn-outline-secondary btn-sm" style="padding: 2px 8px; font-size: 0.7rem;">Manage Book</a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% endif %}
</div>

<!-- Add Book Modal -->
<div class="fab-container">
    <button class="btn btn-primary btn-lg rounded-circle shadow" onclick="openModal('addBookModal')" style="width: 60px; height: 60px; font-size: 1.5rem;">üìö</button>
</div>

<div id="addBookModal" class="modal-overlay">
    <div class="modal-content glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>Add Book to Series</h2>
            <button class="btn-close" onclick="closeModal('addBookModal')">‚úï</button>
        </div>
        <form action="/admin/series/add-book" method="POST">
            <input type="hidden" name="series_id" value="{{ series.series_id }}">
            
            <div class="form-group">
                <label>Search Book</label>
                <input type="text" id="bookSearch" class="form-control" placeholder="Type book title..." onkeyup="searchBooks(this.value)">
                <div id="searchResults" style="border: 1px solid var(--border); border-radius: 8px; margin-top: 0.5rem; max-height: 150px; overflow-y: auto; display: none;"></div>
                <input type="hidden" name="book_id" id="selectedBookId" required>
            </div>
            
            <div class="form-group" style="margin-top: 1rem;">
                <label>Order in Series (#)</label>
                <input type="number" name="order" class="form-control" required value="{{ (books|length) + 1 }}" min="1">
            </div>
            
            <div style="margin-top: 1.5rem; text-align: right;">
                <button type="submit" class="btn btn-primary">Add Book</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openModal(id) { document.getElementById(id).style.display = "flex"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    
    async function searchBooks(query) {
        if (query.length < 2) {
            document.getElementById('searchResults').style.display = 'none';
            return;
        }
        
        const res = await fetch(`/api/books/search?q=${query}`);
        const books = await res.json();
        const resultsDiv = document.getElementById('searchResults');
        resultsDiv.innerHTML = '';
        
        if (books.length > 0) {
            resultsDiv.style.display = 'block';
            books.forEach(b => {
                const div = document.createElement('div');
                div.style.padding = '0.5rem 1rem';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid var(--border)';
                div.innerText = b.title;
                div.onmouseover = () => div.style.background = 'rgba(99, 102, 241, 0.1)';
                div.onmouseout = () => div.style.background = 'transparent';
                div.onclick = () => {
                    document.getElementById('bookSearch').value = b.title;
                    document.getElementById('selectedBookId').value = b.book_id;
                    resultsDiv.style.display = 'none';
                };
                resultsDiv.appendChild(div);
            });
        }
    }
</script>
{% endblock %}

</file>

<file path="templates\admin\settings.html">
{% extends "layout.html" %}

{% block title %}System Settings{% endblock %}
{% block header_title %}System Settings{% endblock %}
{% block header_subtitle %}Comprehensive control for your library ecosystem.{% endblock %}

{% block content %}
<style>
    .settings-layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        gap: 2rem;
        align-items: start;
    }
    .settings-nav {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        position: sticky;
        top: 2rem;
    }
    .nav-btn {
        padding: 1rem;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 12px;
        text-align: left;
        color: var(--text-sub);
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .nav-btn:hover { background: rgba(255, 255, 255, 0.05); color: var(--text-main); }
    .nav-btn.active {
        background: var(--stat-icon-bg);
        border: 1px solid var(--border);
        color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .tab-pane { display: none; animation: fadeIn 0.3s ease; }
    .tab-pane.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
    .form-control { width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 10px; background: var(--bg); color: var(--text-main); font-size: 0.95rem; }
    .section-header { margin: 0 0 1.5rem 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem; }
    


    @media (max-width: 768px) {
        .settings-layout { grid-template-columns: 1fr; }
        .settings-nav { flex-direction: row; overflow-x: auto; padding-bottom: 1rem; position: relative; top: 0; }
        .nav-btn { white-space: nowrap; }
    }
</style>



<div class="settings-layout">
    <!-- Sidebar Navigation -->
    <div class="settings-nav">
        <button class="nav-btn active" onclick="showTab('identity')">üèõÔ∏è Library Identity</button>
        <button class="nav-btn" onclick="showTab('rules')">üìñ Operational Rules</button>
        <button class="nav-btn" onclick="showTab('financials')">üí∞ Financials & Fines</button>
        <button class="nav-btn" onclick="showTab('ui')">üé® UI & Appearance</button>
        <button class="nav-btn" onclick="showTab('system')">üõ†Ô∏è System & Security</button>
    </div>

    <!-- Content Sections -->
    <div class="settings-content">
        <form action="/admin/settings" method="POST" id="settingsForm">
            <input type="hidden" name="action" value="update_general">

            <!-- Tab 1: Identity -->
            <div id="identity" class="tab-pane active glass-card" style="padding: 2.5rem;">
                <h2 class="section-header">üèõÔ∏è Library Identity</h2>
                <div class="settings-grid">
                    <div class="form-group">
                        <label>Library Name</label>
                        <input type="text" name="library_name" value="{{ system_settings.library_name }}" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Branding Emoji</label>
                        <input type="text" name="branding_emoji" value="{{ system_settings.branding_emoji }}" class="form-control">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Library Tagline</label>
                        <input type="text" name="library_tagline" value="{{ system_settings.library_tagline }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Main Contact Email</label>
                        <input type="email" name="library_email" value="{{ system_settings.library_email }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" name="library_phone" value="{{ system_settings.library_phone }}" class="form-control">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Physical Address</label>
                        <input type="text" name="library_address" value="{{ system_settings.library_address }}" class="form-control">
                    </div>
                </div>
            </div>

            <!-- Tab 2: Rules -->
            <div id="rules" class="tab-pane glass-card" style="padding: 2.5rem;">
                <h2 class="section-header">üìñ Operational Rules</h2>
                <div class="settings-grid">
                    <div class="form-group">
                        <label>Max Books Per User</label>
                        <input type="number" name="max_books_per_user" value="{{ system_settings.max_books_per_user }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Default Issue Days</label>
                        <input type="number" name="default_issue_days" value="{{ system_settings.default_issue_days }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Max Renewals Possible</label>
                        <input type="number" name="max_renewals" value="{{ system_settings.max_renewals }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Reservation Expiry (Days)</label>
                        <input type="number" name="reservation_expiry_days" value="{{ system_settings.reservation_expiry_days }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Max Pending Requests</label>
                        <input type="number" name="max_pending_requests" value="{{ system_settings.max_pending_requests }}" class="form-control">
                    </div>
                </div>
            </div>

            <!-- Tab 3: Financials -->
            <div id="financials" class="tab-pane glass-card" style="padding: 2.5rem;">
                <h2 class="section-header">üí∞ Financials & Fines</h2>
                <div class="settings-grid">
                    <div class="form-group">
                        <label>Currency Symbol</label>
                        <input type="text" name="currency_symbol" value="{{ system_settings.currency_symbol }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Daily Fine Rate (Base)</label>
                        <input type="number" name="daily_fine_rate" value="{{ system_settings.daily_fine_rate }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Fine Grace Period (Days)</label>
                        <input type="number" name="fine_grace_period" value="{{ system_settings.fine_grace_period }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Max Fine Cap</label>
                        <input type="number" name="fine_cap" value="{{ system_settings.fine_cap }}" class="form-control">
                    </div>
                </div>

                <!-- Category Fine Form (RE-ADDED) -->
                <div style="padding: 1.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 2rem;">
                    <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">‚ûï Add/Update Category Fine</h3>
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <input type="hidden" name="action_fine" id="fineAction" value="update_fine">
                        <div class="form-group" style="flex: 2; margin-bottom: 0;">
                            <label>Category</label>
                            <input type="text" id="fineCategory" list="categoryList" placeholder="e.g., Rare Books" class="form-control">
                            <datalist id="categoryList">
                                {% for f in category_fines %}<option value="{{ f.category }}">{% endfor %}
                            </datalist>
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label>Daily Rate ({{ system_settings.currency_symbol }})</label>
                            <input type="number" id="fineRate" step="0.5" class="form-control">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="submitFineForm()">Update Rate</button>
                    </div>
                </div>

                <h3 style="margin-top: 1rem; font-size: 1rem;">Existing Category Fines</h3>
                <div style="overflow: hidden; border: 1px solid var(--border); border-radius: 12px; margin: 1rem 0 2rem 0;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: rgba(0,0,0,0.02);">
                            <tr>
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border);">Category</th>
                                <th style="padding: 1rem; text-align: right; border-bottom: 1px solid var(--border);">Rate</th>
                                <th style="padding: 1rem; text-align: center; border-bottom: 1px solid var(--border);">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f in category_fines %}
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 1rem;">{{ f.category }}</td>
                                <td style="padding: 1rem; text-align: right; font-weight: 600;">{{ system_settings.currency_symbol }}{{ f.daily_rate }}</td>
                                <td style="padding: 1rem; text-align: center;">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteFine('{{ f.category }}')">üóëÔ∏è</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 4: UI -->
            <div id="ui" class="tab-pane glass-card" style="padding: 2.5rem;">
                <h2 class="section-header">üé® UI & Appearance</h2>
                <div class="settings-grid">
                    <div class="form-group">
                        <label>Default Interface Theme</label>
                        <select name="default_theme" class="form-control">
                            <option value="auto" {{ 'selected' if system_settings.default_theme == 'auto' }}>System Default (Auto)</option>
                            <option value="dark" {{ 'selected' if system_settings.default_theme == 'dark' }}>Modern Dark Mode</option>
                            <option value="light" {{ 'selected' if system_settings.default_theme == 'light' }}>Clean Light Mode</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>System Accent Color</label>
                        <input type="color" name="accent_color" value="{{ system_settings.accent_color }}" class="form-control" style="height: 48px; padding: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Pagination Page Size</label>
                        <input type="number" name="pagination_size" value="{{ system_settings.pagination_size }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Show Book Cover Images</label>
                        <select name="show_cover_images" class="form-control">
                            <option value="true" {{ 'selected' if system_settings.show_cover_images == 'true' }}>Enabled</option>
                            <option value="false" {{ 'selected' if system_settings.show_cover_images == 'false' }}>Disabled (Performance)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sidebar Style</label>
                        <select name="sidebar_style" class="form-control">
                            <option value="full" {{ 'selected' if system_settings.sidebar_style == 'full' }}>Standard (Full Width)</option>
                            <option value="slim" {{ 'selected' if system_settings.sidebar_style == 'slim' }}>Compact (Icon Only)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Tab 5: System -->
            <div id="system" class="tab-pane glass-card" style="padding: 2.5rem;">
                <h2 class="section-header">üõ†Ô∏è System & Security</h2>
                <div class="settings-grid">
                    <div class="form-group">
                        <label>New User Registration</label>
                        <select name="registration_mode" class="form-control">
                            <option value="open" {{ 'selected' if system_settings.registration_mode == 'open' }}>Open (Public)</option>
                            <option value="admin" {{ 'selected' if system_settings.registration_mode == 'admin' }}>Admin Invited Only</option>
                            <option value="closed" {{ 'selected' if system_settings.registration_mode == 'closed' }}>Closed (Disabled)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Allow Member Suggestions</label>
                        <select name="allow_suggestions" class="form-control">
                            <option value="true" {{ 'selected' if system_settings.allow_suggestions == 'true' }}>Allow</option>
                            <option value="false" {{ 'selected' if system_settings.allow_suggestions == 'false' }}>Disallow</option>
                        </select>
                    </div>
                </div>

                <div style="padding: 1.5rem; background: var(--stat-icon-bg); border: 1px solid var(--danger); border-radius: 12px; margin-top: 2rem; display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <strong style="display: block; font-size: 1.1rem;">üöß Maintenance Mode</strong>
                        <span style="font-size: 0.85rem; color: var(--text-sub);">Restricts member access while active.</span>
                    </div>
                    <button type="button" class="btn {{ 'btn-success' if maintenance_mode else 'btn-danger' }}" onclick="toggleMaintenance()">
                        {{ 'Exit Maintenance' if maintenance_mode else 'Enter Maintenance' }}
                    </button>
                </div>
            </div>

            <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="reset" class="btn" style="border: 1px solid var(--border);">Cancel Changes</button>
                <button type="submit" class="btn btn-primary" style="padding: 0.8rem 2.5rem; font-weight: 600;">Save All Settings</button>
            </div>
        </form>
    </div>
</div>

<!-- Helper Hidden Forms -->
<form id="maintenanceForm" action="/admin/settings" method="POST" style="display:none;">
    <input type="hidden" name="action" value="maintenance">
    <input type="hidden" name="maintenance_mode" value="{{ 'false' if maintenance_mode else 'true' }}">
</form>
<form id="deleteFineForm" action="/admin/settings" method="POST" style="display:none;">
    <input type="hidden" name="action" value="delete_fine">
    <input type="hidden" name="category" id="deleteCategoryInput">
</form>
<!-- Fine Update Helper -->
<form id="fineHelperForm" action="/admin/settings" method="POST" style="display:none;">
    <input type="hidden" name="action" value="update_fine">
    <input type="hidden" name="category" id="helperCat">
    <input type="hidden" name="daily_rate" id="helperRate">
</form>

<script>
    function showTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function toggleMaintenance() {
        if(confirm("Change system maintenance status?")) document.getElementById('maintenanceForm').submit();
    }

    function deleteFine(cat) {
        if(confirm(`Delete fine rate for ${cat}?`)) {
            document.getElementById('deleteCategoryInput').value = cat;
            document.getElementById('deleteFineForm').submit();
        }
    }

    function submitFineForm() {
        const cat = document.getElementById('fineCategory').value;
        const rate = document.getElementById('fineRate').value;
        if(!cat || !rate) return alert("Please fill both category and rate.");
        document.getElementById('helperCat').value = cat;
        document.getElementById('helperRate').value = rate;
        document.getElementById('fineHelperForm').submit();
    }
</script>
{% endblock %}

</file>

<file path="templates\admin\suggestions.html">
{% extends "layout.html" %}

{% block title %}Book Suggestions{% endblock %}
{% block header_title %}Member Book Suggestions{% endblock %}
{% block header_subtitle %}Review and manage book suggestions from library members.{% endblock %}

{% block head %}
<style>
    .suggestion-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #2563eb;
        transition: all 0.25s ease;
    }

    .suggestion-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    .suggestion-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }

    .suggestion-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-main);
        margin: 0 0 0.25rem 0;
    }

    .suggestion-author {
        color: var(--text-sub);
        font-size: 0.875rem;
        margin: 0;
    }

    .suggestion-meta {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .meta-label {
        color: var(--text-sub);
        font-weight: 600;
    }

    .meta-value {
        color: var(--text-main);
    }

    .suggestion-reason {
        background: rgba(37, 99, 235, 0.05);
        border-left: 3px solid #2563eb;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        line-height: 1.5;
        color: var(--text-main);
    }

    .suggestion-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .status-pending {
        background: #fef08a;
        color: #854d0e;
    }

    .status-approved {
        background: #d1fae5;
        color: #065f46;
    }

    .status-rejected {
        background: #fee2e2;
        color: #991b1b;
    }

    .filter-section {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1rem;
        background: var(--card-bg);
        border-radius: 12px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .filter-group label {
        font-weight: 600;
        color: var(--text-main);
        font-size: 0.875rem;
    }

    .filter-group select {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: white;
        color: var(--text-main);
        font-size: 0.875rem;
        cursor: pointer;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-sub);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<!-- Filter Section -->
<div class="filter-section">
    <form method="GET" action="/admin/suggestions" style="display: flex; gap: 1rem; width: 100%;">
        <div class="filter-group">
            <label for="statusFilter">Filter by Status:</label>
            <select id="statusFilter" name="status" onchange="this.form.submit()">
                <option value="">All Suggestions</option>
                <option value="pending" {% if request.args.get('status') == 'pending' %}selected{% endif %}>Pending</option>
                <option value="approved" {% if request.args.get('status') == 'approved' %}selected{% endif %}>Approved</option>
                <option value="rejected" {% if request.args.get('status') == 'rejected' %}selected{% endif %}>Rejected</option>
            </select>
        </div>
    </form>
</div>

<!-- Suggestions List -->
{% if suggestions %}
    {% for s in suggestions %}
    <div class="suggestion-card">
        <div class="suggestion-header">
            <div>
                <h3 class="suggestion-title">{{ s.title }}</h3>
                <p class="suggestion-author">by {{ s.author }}</p>
            </div>
            <span class="status-badge status-{{ s.status }}">
                {{ s.status }}
            </span>
        </div>

        <div class="suggestion-meta">
            <div class="meta-item">
                <span class="meta-label">üë§ Suggested by:</span>
                <span class="meta-value">{{ s.user_name }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">üìß Email:</span>
                <span class="meta-value">{{ s.email }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">üìÅ Category:</span>
                <span class="meta-value">{{ s.category if s.category else 'Not specified' }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">üìÖ Date:</span>
                <span class="meta-value">{{ s.suggestion_date }}</span>
            </div>
        </div>

        {% if s.reason %}
        <div class="suggestion-reason">
            <strong>Why they recommend it:</strong><br>
            {{ s.reason }}
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="suggestion-actions">
            {% if s.status == 'pending' %}
                <form method="POST" action="/admin/suggestion/approve/{{ s.suggestion_id }}" style="display: inline;">
                    <button type="submit" class="btn btn-primary btn-sm">‚úì Approve</button>
                </form>
                <form method="POST" action="/admin/suggestion/reject/{{ s.suggestion_id }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger btn-sm">‚úó Reject</button>
                </form>
            {% else %}
                <span style="color: var(--text-sub); font-size: 0.875rem;">
                    {% if s.status == 'approved' %}
                        ‚úÖ This suggestion has been approved
                    {% else %}
                        ‚ùå This suggestion was rejected
                    {% endif %}
                </span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üí≠</div>
        <h3>No Suggestions</h3>
        <p>There are no book suggestions at this time. Members can submit suggestions from their dashboard.</p>
    </div>
{% endif %}

<script>
    // Prevent form submission on status filter change - it's already submitted via onchange
    document.getElementById('statusFilter')?.addEventListener('change', function(e) {
        e.preventDefault();
    });
</script>

{% endblock %}

</file>

<file path="templates\admin\support.html">

{% extends "layout.html" %}

{% block title %}Support Management{% endblock %}
{% block header_title %}Support Tickets{% endblock %}
{% block header_subtitle %}Manage user inquiries and issues.{% endblock %}

{% block content %}
<div class="glass-card" style="padding: 0; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: rgba(0,0,0,0.03); border-bottom: 1px solid var(--border);">
            <tr>
                <th style="padding: 1rem; text-align: left;">ID</th>
                <th style="padding: 1rem; text-align: left;">User</th>
                <th style="padding: 1rem; text-align: left;">Subject</th>
                <th style="padding: 1rem; text-align: center;">Status</th>
                <th style="padding: 1rem; text-align: right;">Date</th>
                <th style="padding: 1rem;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if not tickets %}
            <tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-sub);">No tickets found.</td></tr>
            {% else %}
            {% for t in tickets %}
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 1rem;">#{{ t.ticket_id }}</td>
                <td style="padding: 1rem;">
                    <strong>{{ t.user_name }}</strong><br>
                    <span style="font-size: 0.8rem; color: var(--text-sub);">{{ t.email }}</span>
                </td>
                <td style="padding: 1rem; font-weight: 500;">{{ t.subject }}</td>
                <td style="padding: 1rem; text-align: center;">
                    <span class="badge {{ 'badge-success' if t.status == 'closed' else 'badge-warning' }}">
                        {{ t.status|upper }}
                    </span>
                </td>
                <td style="padding: 1rem; text-align: right; color: var(--text-sub);">{{ t.created_at }}</td>
                <td style="padding: 1rem;">
                    <a href="/admin/support/{{ t.ticket_id }}" class="btn btn-primary btn-sm">View</a>
                </td>
            </tr>
            {% endfor %}
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}

</file>

<file path="templates\admin\ticket_view.html">

{% extends "layout.html" %}

{% block title %}Ticket #{{ ticket.ticket_id }}{% endblock %}
{% block header_title %}Ticket #{{ ticket.ticket_id }}{% endblock %}
{% block header_subtitle %}{{ ticket.subject }} (User: {{ ticket.user_name }}){% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <span class="badge {{ 'badge-success' if ticket.status == 'closed' else 'badge-warning' }}" style="font-size: 1rem;">
                Status: {{ ticket.status|upper }}
            </span>
        </div>
        <a href="/admin/support" class="btn btn-primary btn-sm">‚¨Ö Back to List</a>
    </div>
    
    <div class="glass-card" style="margin-bottom: 2rem; max-height: 500px; overflow-y: auto;">
        {% for reply in replies %}
        <div style="margin-bottom: 1.5rem; display: flex; flex-direction: column; align-items: {{ 'flex-end' if reply.sender_id == session['user_id'] else 'flex-start' }};">
            <div style="max-width: 80%; padding: 1rem; border-radius: 12px; background: {{ 'var(--primary)' if reply.sender_id == session['user_id'] else 'var(--card-bg)' }}; color: {{ 'white' if reply.sender_id == session['user_id'] else 'var(--text-main)' }}; border: {{ 'none' if reply.sender_id == session['user_id'] else '1px solid var(--border)' }};">
                <p style="margin: 0; white-space: pre-wrap;">{{ reply.message }}</p>
            </div>
            <span style="font-size: 0.75rem; color: var(--text-sub); margin-top: 0.25rem;">
                {{ reply.sender_name }} ({{ reply.sender_role|capitalize }}) ‚Ä¢ {{ reply.created_at }}
            </span>
        </div>
        {% endfor %}
    </div>
    
    {% if ticket.status == 'open' %}
    <div class="glass-card">
        <form action="" method="POST" style="margin-bottom: 2rem;">
            <input type="hidden" name="action" value="reply">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Reply</label>
            <textarea name="message" rows="3" required class="form-control" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text-main); font-family: inherit; margin-bottom: 1rem;"></textarea>
            <button type="submit" class="btn btn-primary">Send Reply üöÄ</button>
        </form>
        
        <hr style="border: 0; border-top: 1px solid var(--border); margin-bottom: 1rem;">
        
        <form action="" method="POST" onsubmit="return confirm('Close this ticket?');">
            <input type="hidden" name="action" value="close">
            <button type="submit" class="btn btn-danger w-100">Close Ticket üîí</button>
        </form>
    </div>
    {% else %}
    <div class="glass-card" style="text-align: center; color: var(--text-sub);">
        üîí This ticket is closed.
    </div>
    {% endif %}
</div>
{% endblock %}

</file>

<file path="templates\admin\users.html">
{% extends "layout.html" %}

{% block title %}Manage Users{% endblock %}
{% block header_title %}User Management{% endblock %}
{% block header_subtitle %}Add and manage library staff and members.{% endblock %}

{% block content %}
<div class="glass-card" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; margin-bottom: 2rem; position: sticky; top: 80px; z-index: 100; backdrop-filter: blur(20px);">
    <div>
        <h2 style="margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
            üë§ User Management
        </h2>
        <p style="margin: 0.25rem 0 0; color: var(--text-sub); font-size: 0.85rem;">Manage staff access and member tiers.</p>
    </div>
    <button class="btn btn-primary" onclick="toggleAddUserForm()" style="border-radius: 50px; padding: 0.5rem 1.5rem; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);">
        <i class="fas fa-user-plus me-1"></i> Add New User
    </button>
</div>

<!-- ADD NEW USER (Collapsible) -->
<div id="addUserSection" style="display: none; margin-bottom: 2rem;">
    <div class="glass-card" style="border: 1px solid var(--primary); background: linear-gradient(to bottom right, rgba(255,255,255,0.9), rgba(255,255,255,0.5));">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
            <h3 style="margin: 0; font-size: 1.1rem; color: var(--primary);">‚ú® Create New Account</h3>
            <button type="button" onclick="toggleAddUserForm()" style="background: none; border: none; font-size: 1.25rem; cursor: pointer; color: var(--text-sub);">‚úï</button>
        </div>
        <form action="/admin/user/add" method="POST" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem;">
            <div class="form-group" style="margin: 0;">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; display: block;">Full Name</label>
                <div style="position: relative;">
                    <i class="fas fa-user" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 0.9rem;"></i>
                    <input type="text" name="name" placeholder="John Doe" required style="padding-left: 2.5rem; border-radius: 8px;">
                </div>
            </div>
            <div class="form-group" style="margin: 0;">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; display: block;">Email Address</label>
                <div style="position: relative;">
                    <i class="fas fa-envelope" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 0.9rem;"></i>
                    <input type="email" name="email" placeholder="john@example.com" required style="padding-left: 2.5rem; border-radius: 8px;">
                </div>
            </div>
            <div class="form-group" style="margin: 0;">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; display: block;">Initial Password</label>
                <div style="position: relative;">
                    <i class="fas fa-lock" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 0.9rem;"></i>
                    <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required style="padding-left: 2.5rem; border-radius: 8px;">
                </div>
            </div>
            <div class="form-group" style="margin: 0;">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; display: block;">Role</label>
                <div style="position: relative;">
                    <i class="fas fa-shield-alt" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 0.9rem;"></i>
                    <select name="role" required style="padding-left: 2.5rem; border-radius: 8px; width: 100%; appearance: none;">
                        <option value="member">Member</option>
                        <option value="admin">Administrator</option>
                    </select>
                    <i class="fas fa-chevron-down" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 0.8rem; pointer-events: none;"></i>
                </div>
            </div>
            <div class="form-group" style="grid-column: 1 / -1; margin-top: 0.5rem;">
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px; border-radius: 8px; font-weight: 600; display: flex; justify-content: center; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-check-circle"></i> Create Account
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function toggleAddUserForm() {
        const section = document.getElementById('addUserSection');
        if (section.style.display === 'none') {
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            section.style.display = 'none';
        }
    }
</script>

<!-- USERS LIST -->
<div class="glass-card" style="padding: 0; overflow: hidden; margin-top: 2rem;">
    <div class="table-responsive">
        <table class="table" style="margin: 0; width: 100%; border-collapse: separate; border-spacing: 0;">
            <thead style="background: rgba(0,0,0,0.02); height: 50px;">
                <tr>
                    <th style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600;">User Info</th>
                    <th style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600;">Role</th>
                    <th style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600;">Membership Tier</th>
                    <th style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600;">Joined Date</th>
                    <th style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600; text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr style="transition: background 0.2s;">
                    <td style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <!-- Initials Avatar -->
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, var(--primary) 0%, #818cf8 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                {{ u.name[0] | upper }}{{ u.name.split(' ')[-1][0] | upper if ' ' in u.name else '' }}
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <span style="font-weight: 600; color: var(--text-main); font-size: 0.95rem;">{{ u.name }}</span>
                                <span style="color: var(--text-sub); font-size: 0.8rem;">{{ u.email }}</span>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border);">
                        {% if u.role == 'admin' %}
                            <span class="badge" style="background: rgba(99, 102, 241, 0.1); color: #6366f1; border: 1px solid rgba(99, 102, 241, 0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                <i class="fas fa-shield-alt me-1"></i> Admin
                            </span>
                        {% else %}
                            <span class="badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                <i class="fas fa-user me-1"></i> Member
                            </span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border);">
                        {% if u.role == 'member' %}
                        <form action="/admin/user/tier" method="POST" style="margin: 0;">
                            <input type="hidden" name="user_id" value="{{ u.user_id }}">
                            <div style="position: relative; display: inline-block;">
                                <select name="tier" onchange="this.form.submit()" 
                                    style="appearance: none; padding: 6px 30px 6px 12px; border-radius: 20px; font-size: 0.85rem; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; color: var(--text-main); font-weight: 500; transition: all 0.2s;">
                                    <option value="Silver" {% if u.tier == 'Silver' %}selected{% endif %}>ü•à Silver</option>
                                    <option value="Gold" {% if u.tier == 'Gold' %}selected{% endif %}>ü•á Gold</option>
                                    <option value="Platinum" {% if u.tier == 'Platinum' %}selected{% endif %}>üíé Platinum</option>
                                </select>
                                <i class="fas fa-chevron-down" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: var(--text-sub); pointer-events: none;"></i>
                            </div>
                        </form>
                        {% else %}
                            <span style="color: var(--text-sub); opacity: 0.5;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); color: var(--text-sub); font-size: 0.9rem;">
                        {{ u.created_at.strftime('%b %d, %Y') if u.created_at else 'N/A' }}
                    </td>
                    <td style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); text-align: right;">
                        {% if session.get('user_id') != u.user_id %}
                            <form action="/admin/user/delete/{{ u.user_id }}" method="POST" onsubmit="return confirm('‚ö†Ô∏è Are you sure you want to delete this user? This action cannot be undone.')" style="margin: 0;">
                                <button type="submit" class="btn btn-sm btn-outline-danger" style="border-radius: 8px; padding: 0.4rem 0.8rem;" title="Delete User">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        {% else %}
                            <span class="badge" style="background: rgba(107, 114, 128, 0.1); color: #6b7280; font-size: 0.75rem;">Current</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

</file>

<file path="templates\member\achievements.html">
{% extends "layout.html" %}

{% block content %}
<!-- Decorative Background Mesh -->
<div class="mesh-background"></div>

<div class="row align-items-center mb-5 position-relative" style="z-index: 2;">
    <!-- Title Section -->
    <div class="col-md-5 mb-4 mb-md-0">
        <h1 class="display-4 fw-black mb-2 tracking-tight text-gradient">üèÜ Trophy Room</h1>
        <p class="text-muted lead mb-0 fw-medium">Your legendary journey through the library.</p>
    </div>
    
    <!-- Hero Level Card -->
    <div class="col-md-7 mb-4 mb-md-0">
        <div class="glass-hero p-4 position-relative overflow-hidden shadow-lg h-100">
            
            <div class="row align-items-center position-relative h-100" style="z-index: 2;">
                <!-- Left: Big Level Circle -->
                <div class="col-12 col-md-auto text-center mb-3 mb-md-0">
                    <div class="level-circle shadow-lg mx-auto">
                        {{ game_stats.level }}
                    </div>
                </div>
                
                <!-- Right: Stats Details -->
                <div class="col-12 col-md ps-md-4">
                    <!-- Top Row: Title & Rank -->
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center align-items-md-start mb-2 text-center text-md-start">
                        <div class="mb-2 mb-md-0">
                            <h4 class="fw-black mb-1 text-dark">Current Level</h4>
                            <div class="d-flex align-items-center justify-content-center justify-content-md-start gap-2">
                                <span class="badge bg-white text-primary border shadow-sm px-3 py-1 rounded-pill">
                                    {{ game_stats.rank_title }}
                                </span>
                                <span class="badge bg-light text-muted border px-2 py-1 rounded-pill cursor-help" data-bs-toggle="tooltip" title="Upcoming Perk">
                                    üéÅ {{ game_stats.next_perk }}
                                </span>
                            </div>
                        </div>
                        
                        <!-- XP Stats & Help Button -->
                        <div class="text-center text-md-end">
                            <h3 class="fw-black mb-0 text-primary">{{ game_stats.xp }} <span class="text-muted fs-6 fw-normal">XP</span></h3>
                            <button id="howToEarnBtn" class="btn btn-sm btn-link text-decoration-none p-0 text-muted fw-bold small">
                                <i class="fas fa-info-circle me-1"></i> How to earn?
                            </button>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="progress mb-2" style="height: 14px; border-radius: 10px; background-color: rgba(255,255,255,0.5); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
                        {% set progress = (game_stats.xp / game_stats.xp_to_next) * 100 %}
                        <div class="progress-bar bg-gradient-primary-animated" role="progressbar" 
                             style="width: {{ progress }}%; border-radius: 10px;"></div>
                    </div>
                    
                    <!-- Bottom Helper Text -->
                    <div class="d-flex justify-content-between text-xs fw-bold text-muted small">
                         <span>Lvl {{ game_stats.level }}</span>
                         <span>{{ game_stats.xp_to_next - game_stats.xp }} XP needed</span>
                    </div>
                    <!-- Spacer for mobile breathing room -->
                    <div class="d-md-none mb-2"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Micro Tabs Navigation -->
<div class="d-flex gap-2 mb-4 overflow-auto pb-2 position-relative" id="badgeFilters" style="z-index: 2;">
    <button class="btn btn-dark rounded-pill px-4 py-2 fw-bold active shadow-sm" data-filter="all">All Badges</button>
    <button class="btn btn-white border-0 rounded-pill px-4 py-2 fw-bold shadow-sm" data-filter="unlocked" style="background: white; color: #10b981;">
        <i class="fas fa-check-circle me-1"></i> Unlocked
    </button>
    <button class="btn btn-white border-0 rounded-pill px-4 py-2 fw-bold shadow-sm" data-filter="locked" style="background: white; color: #64748b;">
        <i class="fas fa-lock me-1"></i> Locked
    </button>
</div>

<!-- Premium Achievements Grid -->
<div class="achievements-grid position-relative" style="z-index: 2;">
    {% for badge in achievements %}
    <div class="achievement-card p-4 text-center position-relative {{ 'unlocked' if badge.is_unlocked else 'locked' }}" 
         data-status="{{ 'unlocked' if badge.is_unlocked else 'locked' }}">
        
        <!-- Status Indicator -->
        <div class="status-badge">
            {% if badge.is_unlocked %}
            <div class="check-circle shadow-sm">
                <i class="fas fa-check text-white"></i>
            </div>
            {% else %}
            <i class="fas fa-lock text-muted opacity-50 fs-5"></i>
            {% endif %}
        </div>
        
        <!-- Icon -->
        <div class="badge-icon-wrapper mb-3">
            <div class="badge-icon {{ 'grayscale' if not badge.is_unlocked else 'floating-anim' }}">
                {{ badge.icon }}
            </div>
            {% if badge.is_unlocked %}
            <div class="glow-effect"></div>
            {% endif %}
        </div>
        
        <!-- Content -->
        <h5 class="fw-bold mb-1 title-text text-truncate">{{ badge.name }}</h5>
        <p class="description-text mb-3">{{ badge.description }}</p>
        
        <!-- Footer -->
        <div class="card-footer-lines d-flex justify-content-center">
            {% if badge.is_unlocked %}
            <span class="unlock-date-pill">
                Unlocked {{ badge.earned_at.strftime('%b %d') if badge.earned_at else '' }}
            </span>
            {% else %}
            <span class="locked-pill">
                Locked
            </span>
            {% endif %}
        </div>

        {% if not badge.is_unlocked %}
        <div class="lock-overlay-glass"></div>
        {% endif %}
    </div>
    {% endfor %}
</div>



<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Custom Modal Logic
        const modal = document.getElementById('xpInfoModal');
        const btn = document.getElementById('howToEarnBtn');
        const closeBtn = document.querySelector('#xpInfoModal .btn-close');
        
        // Move to body to prevent z-index issues
        if(modal) document.body.appendChild(modal);

        // Open
        if(btn && modal) {
            btn.addEventListener('click', (e) => {
                e.preventDefault(); 
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('active'), 10); // Trigger animation if any
            });
        }

        // Close functions
        function closeModal() {
            if(modal) {
                 modal.style.display = 'none';
                 modal.classList.remove('active');
            }
        }

        if(closeBtn) closeBtn.addEventListener('click', closeModal);
        
        // Close on click outside
        if(modal) {
            modal.addEventListener('click', (e) => {
                if(e.target === modal) closeModal();
            });
        }
        
        const filters = document.querySelectorAll('#badgeFilters button');
        const cards = document.querySelectorAll('.achievement-card');

        filters.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update Active State
                filters.forEach(b => {
                    b.classList.remove('active', 'btn-dark');
                    // Reset to custom styles if needed, or just toggle classes
                    if(b.dataset.filter === 'all') b.classList.remove('btn-dark');
                });
                // Simple active logic
                filters.forEach(b => b.style.opacity = '0.7');
                btn.style.opacity = '1';
                
                const filter = btn.getAttribute('data-filter');

                // Filter Grid
                cards.forEach(card => {
                    if (filter === 'all') {
                        card.style.display = 'flex';
                        setTimeout(() => card.style.opacity = '1', 50);
                    } else {
                        if (card.getAttribute('data-status') === filter) {
                            card.style.display = 'flex';
                            setTimeout(() => card.style.opacity = '1', 50);
                        } else {
                            card.style.opacity = '0';
                            setTimeout(() => card.style.display = 'none', 300);
                        }
                    }
                });
            });
        });
    });
</script>

<!-- XP Info Modal (Custom Style) -->
<div class="modal-overlay" id="xpInfoModal" style="z-index: 9999;">
    <div class="modal-content glass-card border-0 shadow-lg">
        <div class="modal-header border-0 pb-0 d-flex justify-content-between align-items-center mb-3">
            <h5 class="modal-title fw-bold fs-4">üìà Point System</h5>
            <button type="button" class="btn-close" style="background: none; border: none; font-size: 1.5rem;">&times;</button>
        </div>
        <div class="modal-body">
            <ul class="list-group list-group-flush bg-transparent p-0">
                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-bottom px-0 py-3">
                    <span class="d-flex align-items-center"><i class="fas fa-book-reader text-primary me-3 fs-5"></i> Borrow a Book</span>
                    <span class="badge bg-success rounded-pill fw-bold fs-6 px-3">+10 XP</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-bottom px-0 py-3">
                    <span class="d-flex align-items-center"><i class="fas fa-star text-warning me-3 fs-5"></i> Write a Review</span>
                    <span class="badge bg-success rounded-pill fw-bold fs-6 px-3">+20 XP</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0 py-3">
                    <span class="d-flex align-items-center"><i class="fas fa-undo text-info me-3 fs-5"></i> Return on Time</span>
                    <span class="badge bg-success rounded-pill fw-bold fs-6 px-3">+5 XP</span>
                </li>
            </ul>
             <div class="alert alert-light border mt-4 mb-0 small text-muted p-3 rounded">
                <i class="fas fa-crown text-warning me-2"></i> <strong>Tip:</strong> Earn badges to unlock special profile borders!
            </div>
        </div>
    </div>
</div>
{% endblock %}

</file>

<file path="templates\member\ai_chat.html">
{% extends "layout.html" %}

{% block title %}AI Assistant{% endblock %}
{% block header_title %}
    <span style="background: linear-gradient(135deg, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">LDBMS Brain</span>
{% endblock %}
{% block header_subtitle %}Your intelligent guide to the library universe.{% endblock %}

{% block head %}
<style>
    /* Chat Layout */
    .ai-chat-container {
        max_width: 900px;
        margin: 0 auto;
        height: 70vh;
        display: flex;
        flex-direction: column;
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border);
        overflow: hidden;
        box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
    }

    /* Messages Area */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        scroll-behavior: smooth;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .message {
        display: flex;
        gap: 1rem;
        max-width: 85%;
        opacity: 0;
        animation: fadeIn 0.3s forwards;
    }

    .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message.ai {
        align-self: flex-start;
    }

    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

    /* Avatars */
    .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1.1rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .avatar.ai {
        background: linear-gradient(135deg, #6366f1, #a855f7);
        color: white;
    }

    .avatar.user {
        background: var(--bg);
        border: 1px solid var(--border);
        color: var(--text-main);
    }

    /* Bubbles */
    .bubble {
        padding: 1rem 1.25rem;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.6;
        position: relative;
    }

    .message.user .bubble {
        background: #6366f1;
        color: white;
        border-bottom-right-radius: 4px;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
    }

    .message.ai .bubble {
        background: var(--bg);
        border: 1px solid var(--border);
        color: var(--text-main);
        border-bottom-left-radius: 4px;
    }

    /* Input Area */
    .input-area {
        padding: 1.5rem;
        background: var(--card-bg);
        border-top: 1px solid var(--border);
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
        position: relative;
    }

    .chat-input {
        flex: 1;
        padding: 1rem 1.25rem;
        border-radius: 25px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text-main);
        font-size: 0.95rem;
        resize: none;
        height: 52px;
        max-height: 150px;
        transition: border-color 0.2s;
        font-family: inherit;
        overflow-y: hidden;
    }

    .chat-input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .send-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #6366f1;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
    }

    .send-btn:hover { transform: scale(1.05); background: #4f46e5; }
    .send-btn:disabled { background: var(--border); cursor: not-allowed; transform: none; box-shadow: none; }

    /* Typing Indicator */
    .typing {
        display: flex;
        gap: 4px;
        padding: 0.5rem 1rem;
        background: var(--bg);
        border-radius: 20px;
        width: fit-content;
        margin-left: 3.5rem;
        margin-bottom: 1rem;
        display: none;
    }

    .dot {
        width: 8px;
        height: 8px;
        background: #a1a1aa;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    /* Markdown Styling */
    .bubble h1, .bubble h2, .bubble h3 { margin-top: 0.5rem; font-size: 1.1rem; }
    .bubble ul { padding-left: 1.5rem; margin: 0.5rem 0; }
    .bubble code { background: rgba(0,0,0,0.1); padding: 0.2rem 0.4rem; border-radius: 4px; font-family: monospace; font-size: 0.85em; }
    .bubble p { margin: 0 0 0.5rem 0; }
    .bubble p:last-child { margin: 0; }

</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}

{% block content %}
<div class="ai-chat-container">
    <div class="chat-messages" id="chatArea">
        <!-- Initial Greeting -->
        <div class="message ai">
            <div class="avatar ai">üß†</div>
            <div class="bubble">
                Hello! I am the Library Brain. I can help you find books, check availability, or recommend something based on your mood. How can I help?
            </div>
        </div>
    </div>

    <!-- Typing Indicator -->
    <div class="typing" id="typingIndicator">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>

    <div class="input-area">
        <textarea id="msgInput" class="chat-input" placeholder="Ask me about books..." rows="1" oninput="autoResize(this)"></textarea>
        <button id="sendBtn" class="send-btn" onclick="sendMessage()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
    </div>
</div>

<script>
    const chatArea = document.getElementById('chatArea');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    
    // Chat History for Context
    let chatHistory = [];

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    msgInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    async function sendMessage() {
        const text = msgInput.value.trim();
        if (!text) return;

        // 1. Add User Message
        appendMessage('user', text);
        msgInput.value = '';
        msgInput.style.height = '52px';
        
        // 2. Show Typing
        typingIndicator.style.display = 'flex';
        scrollToBottom();
        
        // 3. Setup Request
        const payload = {
            message: text,
            history: chatHistory.slice(-6) // Send last 6 messages for context
        };

        try {
            const res = await fetch('/member/ai-chat', { // Oops, route is defined in member_routes as POST to the page or API? 
                // In member_routes.py we set @member_bp.route("/ai-chat", methods=["GET", "POST"])
                // But the fetch URL should ideally be "/member/ai-chat" to match the route unless we made a dedicated API route.
                // Let's check route definition again. It is "/member/ai-chat" (due to blueprint prefix).
                // So fetch URL should be "/member/ai-chat".
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            
            // 4. Hide Typing & Add AI Message
            typingIndicator.style.display = 'none';
            if (data.error) {
                appendMessage('ai', 'Error: ' + data.error);
            } else {
                appendMessage('ai', data.response);
            }
            
        } catch (err) {
            typingIndicator.style.display = 'none';
            appendMessage('ai', "I apologize, but I'm having trouble connecting to the server.");
            console.error(err);
        }
    }

    function appendMessage(role, text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${role}`;
        
        const avatar = document.createElement('div');
        avatar.className = `avatar ${role}`;
        avatar.textContent = role === 'ai' ? 'üß†' : 'üë§'; // You can put user initial here
        
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        
        if (role === 'ai') {
            // Parse Markdown
            bubble.innerHTML = marked.parse(text);
        } else {
            bubble.textContent = text;
        }
        
        msgDiv.appendChild(avatar);
        msgDiv.appendChild(bubble); // Order inverted in CSS for user
        
        chatArea.appendChild(msgDiv);
        
        // Update History
        chatHistory.push({ role: role, content: text });
        scrollToBottom();
    }

    function scrollToBottom() {
        chatArea.scrollTop = chatArea.scrollHeight;
    }
</script>
{% endblock %}

</file>

<file path="templates\member\api_keys.html">

{% extends "layout.html" %}

{% block title %}Developer API Keys{% endblock %}
{% block header_title %}Developer Portal{% endblock %}
{% block header_subtitle %}Generate keys for programmatic access to the catalog.{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    <div class="glass-card" style="padding: 2rem; margin-bottom: 2rem;">
        <h2 style="margin-top: 0;">How to use your API Key</h2>
        <p style="color: var(--text-sub);">
            You can use your API key to fetch the library catalog as JSON. Include the key in the <code>X-API-Key</code> header of your request.
        </p>
        <div style="background: rgba(0,0,0,0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--primary); font-family: monospace; font-size: 0.9rem;">
            curl -H "X-API-Key: YOUR_KEY_HERE" http://{{ request.host }}/api/external/catalog
        </div>
    </div>

    <form action="/member/api-keys/generate" method="POST" style="margin-bottom: 2rem;">
        <button type="submit" class="btn btn-primary">‚ûï Generate New API Key</button>
    </form>

    <div class="glass-card" style="padding: 0; overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead style="background: rgba(0,0,0,0.03); border-bottom: 1px solid var(--border);">
                <tr>
                    <th style="padding: 1rem; text-align: left;">Key (Partial)</th>
                    <th style="padding: 1rem; text-align: left;">Created At</th>
                    <th style="padding: 1rem; text-align: right;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% if not keys %}
                <tr><td colspan="3" style="padding: 2rem; text-align: center; color: var(--text-sub);">No API keys generated yet.</td></tr>
                {% else %}
                {% for k in keys %}
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 1rem; font-family: monospace;">
                        {{ k.api_key[:8] }}************************{{ k.api_key[-4:] }}
                    </td>
                    <td style="padding: 1rem; color: var(--text-sub);">{{ k.created_at }}</td>
                    <td style="padding: 1rem; text-align: right;">
                        <form action="/member/api-keys/delete/{{ k.key_id }}" method="POST" style="display: inline;" onsubmit="return confirm('Revoke this key?');">
                            <button type="submit" class="btn btn-danger btn-sm">Revoke</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

</file>

<file path="templates\member\author.html">
{% extends "layout.html" %}

{% block title %}{{ author.name }}{% endblock %}
{% block header_title %}{{ author.name }}{% endblock %}
{% block header_subtitle %}Author Profile & Bibliography{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 3fr; gap: 2rem;">
    <!-- Author Bio -->
    <aside>
        <div class="glass-card" style="padding: 1.5rem; text-align: center;">
            <div style="width: 150px; height: 150px; border-radius: 50%; overflow: hidden; margin: 0 auto 1.5rem; background: var(--stat-icon-bg); display: flex; align-items: center; justify-content: center;">
                {% if author.photo_src %}
                <img src="{{ author.photo_src }}" alt="{{ author.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                <span style="font-size: 4rem;">‚úçÔ∏è</span>
                {% endif %}
            </div>
            <p style="text-align: left; line-height: 1.6; color: var(--text-sub);">
                {{ author.bio or "No biography available for this author yet." }}
            </p>
        </div>
    </aside>

    <!-- Author's Books -->
    <section class="dashboard-section" style="margin-top: 0;">
        <div class="section-header">
            <h2>üìö Books by {{ author.name }}</h2>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;">
            {% for b in books %}
            <div class="glass-card" style="padding: 1.25rem; display: flex; flex-direction: column;">
                <h4 style="margin: 0 0 0.5rem 0;">{{ b.title }}</h4>
                <div style="margin-top: auto; display: flex; justify-content: space-between; align-items: center;">
                    <span class="badge">{{ b.category }}</span>
                    <a href="/member/catalog?q={{ b.title|urlencode }}" class="btn btn-sm btn-outline-primary">View</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
</div>
{% endblock %}

</file>

<file path="templates\member\catalog.html">
{% extends "layout.html" %}

{% block title %}Book Catalog{% endblock %}
{% block header_title %}Discover Books{% endblock %}
{% block header_subtitle %}Browse our collection and request items to borrow.{% endblock %}

{% block head %}
<style>
    .catalog-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }
    .book-card {
        display: flex;
        flex-direction: column;
        border-radius: 16px;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid var(--border);
        background: var(--card-bg);
    }
    .book-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .book-cover-wrapper {
        position: relative;
        height: 320px;
        background: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border-bottom: 1px solid var(--border);
    }
    .book-cover {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
    }
    .book-card:hover .book-cover {
        transform: scale(1.03);
    }
    .book-placeholder {
        width: 100%; height: 100%;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        padding: 2rem; text-align: center;
        background: linear-gradient(135deg, var(--primary) 0%, #0063cc 100%);
        color: white;
    }
    .book-info {
        padding: 1rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .book-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-main);
        margin: 0 0 0.25rem 0;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .book-author {
        font-size: 0.9rem;
        color: var(--text-sub);
        margin-bottom: 1rem;
    }
    .book-meta {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .action-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.5rem;
    }
    .badge-float {
        position: absolute; top: 10px; right: 10px; z-index: 2;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        padding: 0.5rem 0.8rem;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.85rem;
        color: white !important;
    }
    .badge-success { background-color: #3b82f6 !important; border: 2px solid white; }
    .badge-danger { background-color: #ef4444 !important; border: 2px solid white; }
    .pagination {
        margin-top: 3rem;
        margin-bottom: 3rem;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        width: 100%;
    }
    .page-info {
        font-weight: 500;
        color: var(--text-main);
    }
    .glass-input {
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 12px;
        color: var(--text-main);
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        height: 42px; /* Fixed height for uniformity */
        display: flex; 
        align-items: center;
    }
    .glass-input:focus-within, .glass-input:focus {
        background: rgba(255, 255, 255, 0.8);
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.15);
    }
    .glass-input input {
        background: transparent !important;
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
        width: 100%;
        height: 100%;
        color: inherit;
    }
    .glass-input input:-webkit-autofill,
    .glass-input input:-webkit-autofill:hover, 
    .glass-input input:-webkit-autofill:focus {
        -webkit-box-shadow: 0 0 0px 1000px white inset !important;
        transition: background-color 5000s ease-in-out 0s;
    }

    @media (max-width: 768px) {
        .catalog-grid {
            grid-template-columns: 1fr; /* Full width cards */
            padding: 0 1rem;
        }
        /* Stack Form Elements */
        form[action="/member/catalog"] {
            flex-direction: column;
            align-items: stretch !important;
            gap: 1rem !important;
        }
        form[action="/member/catalog"] > div {
            min-width: 100% !important;
            width: 100% !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem; padding: 0.5rem 0;">
    <form action="/member/catalog" method="GET" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
        <div style="flex: 2; min-width: 200px;">
            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 600; opacity: 0.9;">Search by Title or Author</label>
            <div class="glass-input" style="display: flex; align-items: center; padding: 0 1rem;">
                <span style="margin-right: 0.75rem; opacity: 0.7;">üîç</span>
                <input type="text" name="q" value="{{ q }}" placeholder="e.g. Harry Potter or J.K. Rowling..." autocomplete="off">
            </div>
        </div>

        <div style="flex: 1; min-width: 150px;">
            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 600; opacity: 0.9;">Category</label>
            <select name="category" class="form-control glass-input" style="width: 100%; padding: 0 1rem; appearance: none; cursor: pointer;">
                <option value="" style="color: black;">All Categories</option>
                {% for c in categories %}
                <option value="{{ c.category }}" {% if selected_category == c.category %}selected{% endif %} style="color: black;">{{ c.category }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="display: flex; gap: 0.5rem; flex: 1; min-width: 150px;">
            <div style="width: 100%;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 600; opacity: 0;">Action</label>
                <div style="display: flex; gap: 0.5rem; height: 42px;">
                    <button type="submit" class="btn btn-primary" style="height: 100%; flex: 1; display: flex; align-items: center; justify-content: center;">Apply</button>
                    <a href="/member/catalog" class="btn btn-outline-secondary" style="height: 100%; flex: 1; display: flex; align-items: center; justify-content: center; text-decoration: none;">Reset</a>
                </div>
            </div>
        </div>
    </form>
</div>

{% if not books %}
<div style="text-align: center; padding: 5rem; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);">
    <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
    <h3>No books found matching your search.</h3>
    <p style="color: var(--text-sub);">Try a different keyword or browse all books.</p>
    <a href="/member/catalog" class="btn btn-primary" style="margin-top: 1.5rem;">Clear Search</a>
</div>
{% else %}
<div class="catalog-grid">
    {% for b in books %}
    <div class="book-card glass-card">
        <!-- Cover Section -->
        <div class="book-cover-wrapper">
            <span class="badge badge-float {{ 'badge-success' if b.available_copies > 0 else 'badge-danger' }}">
                {{ b.available_copies }} left
            </span>
            
            <img src="https://covers.openlibrary.org/b/title/{{ b.title|urlencode }}-M.jpg" 
                 class="book-cover" 
                 alt="{{ b.title }}"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            
            <div class="book-placeholder" style="display: none;">
                <div class="title-initials">{{ b.title[0]|upper }}</div>
                <div style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">{{ b.category }}</div>
            </div>
        </div>
        
        <!-- Info Section -->
        <div class="book-info">
            <!-- Series Badge -->
            {% if b.series_title %}
            <div style="margin-bottom: 0.5rem;">
                <a href="/member/series/{{ b.series_id }}" class="badge" style="background: rgba(99, 102, 241, 0.1); color: #6366f1; font-size: 0.7rem; text-decoration: none;">
                    ‚õìÔ∏è {{ b.series_title }} #{{ b.series_order }}
                </a>
            </div>
            {% endif %}

            <div style="display:flex; justify-content:space-between; align-items:start;">
                <h3 class="book-title" title="{{ b.title }}">{{ b.title }}</h3>
            </div>
            
            <p class="book-author">by <a href="/member/author/{{ b.author_id }}" style="color: var(--text-sub);">{{ b.author_name }}</a></p>
            
            <div class="book-meta">
                <!-- Meta Row: Category & Rating -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span class="badge" style="background: var(--stat-icon-bg); color: var(--primary);">{{ b.category }}</span>
                    <button class="btn btn-sm btn-ghost" onclick="openReviewModal('{{ b.book_id }}', '{{ b.title|escape }}')" style="padding: 2px 8px; font-size: 0.8rem;">
                        ‚≠ê Rate
                    </button>
                </div>

                <!-- Action Row -->
                <div class="action-row">
                    <!-- Check Availability Logic -->
                    {% if b.available_copies > 0 %}
                    <form action="/member/request" method="POST" style="margin:0;">
                        <input type="hidden" name="book_id" value="{{ b.book_id }}">
                        <button type="submit" class="btn btn-sm btn-primary w-100">Request</button>
                    </form>
                    {% else %}
                    <form action="/member/waitlist/join" method="POST" style="margin:0;">
                        <input type="hidden" name="book_id" value="{{ b.book_id }}">
                        <button type="submit" class="btn btn-sm btn-warning w-100">Join Waitlist</button>
                    </form>
                    {% endif %}

                    <!-- Wishlist Button -->
                    <form action="/member/wishlist/add" method="POST" style="margin:0;">
                        <input type="hidden" name="book_id" value="{{ b.book_id }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Add to Wishlist" style="padding: 0.4rem 0.8rem;">
                            ‚ù§Ô∏è
                        </button>
                    </form>
                </div>

                <!-- Secondary Row if PDF exists -->
                {% if b.pdf_src %}
                <a href="{{ url_for('static', filename=b.pdf_src) }}" target="_blank" class="btn btn-sm btn-outline-success w-100">
                    üìñ Read Online
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- PAGINATION CONTROLS -->
<div class="pagination">
    {% if current_page > 1 %}
    <a href="/member/catalog?page={{ current_page - 1 }}&q={{ q }}&author={{ selected_author }}&category={{ selected_category }}" class="btn btn-danger btn-sm">Previous</a>
    {% else %}
    <button class="btn btn-disabled btn-sm" disabled>Previous</button>
    {% endif %}

    <span class="page-info">Page <strong>{{ current_page }}</strong> of {{ total_pages }}</span>

    {% if current_page < total_pages %}
    <a href="/member/catalog?page={{ current_page + 1 }}&q={{ q }}&author={{ selected_author }}&category={{ selected_category }}" class="btn btn-primary btn-sm">Next</a>
    {% else %}
    <button class="btn btn-disabled btn-sm" disabled>Next</button>
    {% endif %}
</div>
{% endif %}

<!-- Review Modal -->
<div id="reviewModal" class="modal-overlay" style="display: none;">
    <div class="modal-content glass-card p-4" style="max-width: 500px; width: 90%; margin: 10% auto; position: relative;">
        <span onclick="closeReviewModal()" style="position: absolute; top: 1rem; right: 1rem; cursor: pointer; font-size: 1.5rem;">&times;</span>
        <h3>Rate & Review</h3>
        <p id="modalBookTitle" style="color: var(--text-sub); margin-bottom: 1rem;"></p>
        
        <form action="/member/review/add" method="POST">
            <input type="hidden" name="book_id" id="modalBookId">
            
            <div class="mb-3">
                <label>Rating:</label>
                <div class="rating-stars">
                    <input type="radio" name="rating" value="5" id="r5"><label for="r5">‚òÖ</label>
                    <input type="radio" name="rating" value="4" id="r4"><label for="r4">‚òÖ</label>
                    <input type="radio" name="rating" value="3" id="r3"><label for="r3">‚òÖ</label>
                    <input type="radio" name="rating" value="2" id="r2"><label for="r2">‚òÖ</label>
                    <input type="radio" name="rating" value="1" id="r1"><label for="r1">‚òÖ</label>
                </div>
            </div>
            
            <div class="mb-3">
                <label>Comment (Optional):</label>
                <textarea name="comment" class="form-control" rows="3" placeholder="Share your thoughts..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary w-100">Submit Review</button>
        </form>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        backdrop-filter: blur(5px);
    }
    .rating-stars {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    .rating-stars input { display: none; }
    .rating-stars label {
        font-size: 1.5rem;
        color: #ddd;
        cursor: pointer;
        transition: color 0.2s;
    }
    .rating-stars input:checked ~ label,
    .rating-stars label:hover,
    .rating-stars label:hover ~ label {
        color: #f6c23e;
    }
</style>

<script>
    function openReviewModal(id, title) {
        document.getElementById('modalBookId').value = id;
        document.getElementById('modalBookTitle').innerText = title;
        document.getElementById('reviewModal').style.display = 'block';
    }
    function closeReviewModal() {
        document.getElementById('reviewModal').style.display = 'none';
    }
</script>
{% endblock %}

</file>

<file path="templates\member\community.html">
{% extends "layout.html" %}

{% block title %}Community Hub{% endblock %}
{% block header_title %}Community Hub 2.0{% endblock %}
{% block header_subtitle %}Connect with the Community{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Bootstrap 5 for Modals -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
:root {
    --glass-bg: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
    --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
    --primary-glow: rgba(124, 58, 237, 0.4);
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --chat-sidebar-width: 320px;
    --accent: #c084fc;
}

[data-theme="light"] {
    --glass-bg: rgba(0, 0, 0, 0.05);
    --glass-border: rgba(0, 0, 0, 0.1);
    --text-main: #1e293b;
    --text-muted: #64748b;
    --primary-glow: rgba(79, 70, 229, 0.2);
}

/* Light Mode Overrides for Specific Elements */
[data-theme="light"] .search-box input {
    color: #1e293b !important;
}
[data-theme="light"] .chat-item:hover {
    background: rgba(0, 0, 0, 0.05) !important;
}
[data-theme="light"] .msg-other {
    background: white !important;
    border-color: rgba(0,0,0,0.1);
    color: #1e293b !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
[data-theme="light"] .glass-input-wrapper input {
    color: #1e293b !important;
}
[data-theme="light"] .glass-input-wrapper {
    background: white !important;
    border-color: rgba(0,0,0,0.1);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

body {
    background: radial-gradient(circle at top left, #1e1b4b, #0f172a);
    color: var(--text-main);
    font-family: 'Outfit', sans-serif;
    margin: 0;
}

/* Custom Scrollbar Globally */
* {
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}
*::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}
*::-webkit-scrollbar-track {
    background: transparent;
}
*::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
}
*::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.4);
}

.main-content {
    padding: 20px var(--space-lg) !important;
}

.messenger-container {
    flex: 1;
    display: flex;
    height: 100%; 
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
}

.community-layout {
    display: flex;
    gap: 16px;
    height: calc(100vh - 200px);
    margin: 20px auto;
    max-width: 1400px;
    align-items: stretch;
}

/* Sidebar Navigation Bar */
.activity-bar {
    width: 72px;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 0;
    gap: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
}

.nav-icon {
    width: 48px;
    height: 48px;
    border-radius: 24px;
    background: rgba(255, 255, 255, 0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
}

.nav-icon:hover {
    border-radius: 16px;
    background: var(--primary-gradient);
    transform: scale(1.1);
}

.nav-icon.active {
    border-radius: 16px;
    background: var(--primary-gradient);
    box-shadow: 0 0 15px var(--primary-glow);
}

/* Sidebar */
.messenger-sidebar {
    width: var(--chat-sidebar-width);
    border-right: 1px solid var(--glass-border);
    display: flex;
    flex-direction: column;
    background: rgba(0, 0, 0, 0.1);
}

.sidebar-header {
    padding: 24px;
    border-bottom: 1px solid var(--glass-border);
}

.search-box {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.search-box input {
    background: transparent;
    border: none;
    color: white;
    outline: none;
    width: 100%;
    font-size: 0.9rem;
}

.chat-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
}

.chat-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin-bottom: 4px;
}

.chat-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(6px);
    box-shadow: -4px 0 0 0 var(--accent);
}

.chat-item.active {
    background: var(--primary-gradient);
    box-shadow: 0 10px 15px -3px rgba(124, 58, 237, 0.3);
}

.chat-avatar {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    object-fit: cover;
    border: 2px solid var(--glass-border);
}

.chat-info {
    flex: 1;
}

.chat-name {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 2px;
}

.chat-preview {
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* Main Chat Area */
.chat-window {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
}

.chat-top-bar {
    padding: 20px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.02);
}

.active-chat-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.messages-area {
    flex: 1;
    overflow-y: auto;
    padding: 32px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Message Bubbles */
.msg-bubble {
    max-width: 70%;
    padding: 14px 20px;
    border-radius: 20px;
    font-size: 0.95rem;
    line-height: 1.5;
    position: relative;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.msg-other {
    align-self: flex-start;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--glass-border);
    border-bottom-left-radius: 4px;
}

.msg-me {
    align-self: flex-end;
    background: var(--primary-gradient);
    color: white;
    border-bottom-right-radius: 4px;
}

.msg-meta {
    font-size: 0.7rem;
    margin-top: 6px;
    opacity: 0.6;
}

/* Input Box */
.input-area {
    padding: 24px 32px;
    background: rgba(0, 0, 0, 0.1);
}

.glass-input-wrapper {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.glass-input-wrapper input {
    background: transparent;
    border: none;
    color: white;
    flex: 1;
    padding: 10px;
    outline: none;
    font-size: 1rem;
}

.btn-send {
    background: var(--primary-gradient);
    border: none;
    width: 42px;
    height: 42px;
    border-radius: 14px;
    color: white;
    cursor: pointer;
    transition: transform 0.2s;
}

.btn-send:hover {
    transform: scale(1.1) rotate(-5deg);
    box-shadow: 0 0 20px rgba(124, 58, 237, 0.5);
}

/* User Identity Bar (Bottom Left) */
.identity-bar {
    padding: 20px;
    border-top: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.identity-user {
    display: flex;
    align-items: center;
    gap: 12px;
}

.identity-user img {
    width: 36px;
    height: 36px;
    border-radius: 10px;
}

/* --- Anonymous Toggle Switch --- */
.anon-switch {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.switch {
  position: relative;
  display: inline-block;
  width: 40px;
  height: 20px;
}

.switch input { opacity: 0; width: 0; height: 0; }

.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #334155;
  transition: .4s;
  border-radius: 20px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 14px; width: 14px;
  left: 3px; bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background: var(--primary-gradient);
}

input:checked + .slider:before {
  transform: translateX(20px);
}

.glass-modal-content {
    background: rgba(15, 23, 42, 0.95) !important;
    backdrop-filter: blur(40px) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    border-radius: 28px;
    box-shadow: 0 0 100px rgba(0,0,0,1);
    color: white !important;
    position: relative;
    z-index: 10001; /* Extremely high */
    pointer-events: auto !important;
}

.modal {
    z-index: 10000 !important;
}

.modal-backdrop {
    z-index: 9999 !important;
}

.glass-modal-content .form-label {
    color: #ffffff !important; 
    font-weight: 700 !important;
    letter-spacing: 1.5px;
    font-size: 0.85rem !important;
    margin-bottom: 12px;
    display: block;
}

.glass-modal-content .form-control, 
.glass-modal-content .form-select {
    background: rgba(255, 255, 255, 0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    color: white !important;
    border-radius: 14px;
    padding: 12px 16px;
}

.glass-modal-content .form-control::placeholder {
    color: rgba(255, 255, 255, 0.6) !important;
}

.btn-close-custom {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
}


@media (max-width: 1024px) {
    .community-layout {
        flex-direction: column;
        height: auto;
        gap: 12px;
        margin: 10px;
    }
    .activity-bar {
        width: 100%;
        height: auto;
        flex-direction: row;
        justify-content: center;
        padding: 12px;
        gap: 16px;
        border-radius: 16px;
    }
    .messenger-container {
        height: 600px;
    }
}

/* Embedded Mode Styles */
/* Embedded Mode Styles (Admin Hub Integration) */
{% if embedded %}
/* Hide the layout header (Title & User Profile) */
.main-content > header {
    display: none !important;
}

/* Reset Layout Containers */
.app-container, .main-content {
    padding: 0 !important;
    margin: 0 !important;
    height: 100vh !important;
    width: 100% !important;
    max-width: none !important;
    overflow: hidden !important;
    display: block !important;
}

body {
    background: transparent !important;
    overflow: hidden !important;
}

/* Full Size Community Layout */
.community-layout {
    margin: 0 !important;
    height: 100vh !important;
    width: 100% !important;
    max-width: none !important;
    gap: 0 !important;
    border: none !important;
}

/* Remove Card Styles for Seamless Fit */
.messenger-container {
    border-radius: 0 !important;
    border: none !important;
    box-shadow: none !important;
    height: 100vh !important;
}

.activity-bar {
    border-radius: 0 !important;
    margin: 0 !important;
    height: 100vh !important;
    border-top: none !important;
    border-bottom: none !important;
    border-left: none !important;
    box-shadow: none !important;
}
{% endif %}

/* Custom Tab Pills */
.tab-pill {
    padding: 10px 0;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-muted);
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    flex: 1;
    text-align: center;
}

.tab-pill:hover {
    color: white;
}

.tab-pill.active {
    color: #c084fc; /* Accent */
    border-bottom: 2px solid #c084fc;
}

/* Chat Settings Panel */
.chat-settings-panel {
    position: absolute;
    top: 0;
    right: 0;
    width: 320px;
    height: 100%;
    background: rgba(15, 23, 42, 0.98);
    backdrop-filter: blur(40px);
    border-left: 1px solid var(--glass-border);
    z-index: 100;
    display: flex;
    flex-direction: column;
    padding: 20px;
    animation: slideIn 0.3s ease;
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--glass-border);
    margin-bottom: 20px;
}

.settings-section {
    margin-bottom: 24px;
}

.settings-label {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
}

.theme-options {
    display: flex;
    gap: 10px;
}

.theme-option {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.theme-option:hover {
    transform: scale(1.1);
}

.theme-option.active {
    border-color: white;
    box-shadow: 0 0 15px rgba(255,255,255,0.3);
}

.members-list {
    max-height: 200px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.member-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    font-size: 0.9rem;
}

.member-avatar {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    object-fit: cover;
}

.member-role {
    margin-left: auto;
    font-size: 0.7rem;
    padding: 4px 8px;
    background: var(--primary-gradient);
    border-radius: 6px;
}

/* Mobile Chat Toggle Logic */
/* Mobile Chat Toggle & Layout Logic */
@media (max-width: 768px) {
    /* 1. Force Full Viewport Height Integration with Member Layout */
    .main-content {
        padding: 0 !important;
        margin: 0 !important;
        margin-top: 70px !important; /* Account for mobile-top-bar */
        height: calc(100vh - 70px) !important;
        overflow: hidden !important; /* Prevent body scroll, keep it internal */
        width: 100vw !important;
        max-width: 100vw !important;
    }

    .community-layout {
        margin: 0 !important;
        width: 100% !important;
        height: 100% !important;
        gap: 0 !important;
        flex-direction: column;
    }

    /* 2. Flatten Containers for App-like Feel */
    .messenger-container {
        height: 100% !important;
        width: 100% !important;
        border-radius: 0 !important;
        border: none !important;
        border-top: 1px solid var(--glass-border);
        box-shadow: none !important;
        position: relative;
        overflow: hidden;
    }
    
    /* 3. Hide Activity Bar (Use Tabs Instead if needed, or sidebar Header) */
    .activity-bar {
        display: none !important;
    }

    /* 4. Sliding Sidebar/Chat Logic */
    .messenger-sidebar {
        width: 100%;
        position: absolute;
        top: 0; left: 0;
        z-index: 20;
        height: 100%;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: #0f172a; /* Solid background to cover chat */
    }
    
    .chat-window {
        width: 100%;
        position: absolute;
        top: 0; left: 0;
        z-index: 10;
        height: 100%;
        transform: translateX(100%); /* Hidden by default */
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: #0f172a;
        display: flex;
        flex-direction: column;
    }
    
    /* Active State (When Chat Open) */
    .messenger-container.chat-active .messenger-sidebar {
        transform: translateX(-20%); /* Slight parallax or push */
        opacity: 0; 
        pointer-events: none;
    }
    .messenger-container.chat-active .chat-window {
        transform: translateX(0);
        z-index: 30;
    }
    
    /* 5. UI Adjustments */
    #mobileBackBtn {
        display: flex !important;
    }
    
    .input-area {
        padding: 10px 16px;
        padding-bottom: max(10px, env(safe-area-inset-bottom));
        background: #1e293b; 
    }
    
    .messages-area {
        padding: 16px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="community-layout">
    <!-- Navigation Bar -->
    <div class="activity-bar">
        <div class="nav-icon active" onclick="switchTab('public')" id="tab-public" title="Public Hub">üåê</div>
        <div class="nav-icon" onclick="switchTab('personal')" id="tab-personal" title="Personal Chats">üë§</div>
        <div class="nav-icon" onclick="switchTab('group')" id="tab-group" title="Private Groups">üë•</div>
        <div class="nav-icon" onclick="showLeaderboard()" id="tab-leaderboard" title="Leaderboard">üèÜ</div>
    </div>

    <div class="messenger-container">
        <!-- Sidebar -->
        <div class="messenger-sidebar">
        <div class="sidebar-header">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h2 style="font-size: 1.5rem; font-weight: 700; margin:0; background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">Messages</h2>
                <div style="display:flex; gap:12px;">
                    <button class="btn btn-sm btn-outline-light d-flex align-items-center justify-content-center" style="border-radius:10px; width:32px; height:32px; font-weight:700;" onclick="showNewChatModal()" title="New DM">üë§</button>
                    <button class="btn btn-sm btn-outline-light d-flex align-items-center justify-content-center" style="border-radius:10px; width:32px; height:32px; font-weight:700;" onclick="showCreateGroupModal()" title="Create Group">+</button>
                </div>
            </div>
            <div class="search-box">
                <span>üîç</span>
                <input type="text" placeholder="Search conversations..." id="chatSearch">
            </div>
        </div>

        <div class="chat-list" id="chatListContainer">
            <!-- Dynamic Items -->
            <div id="dynamicChatList"></div>
        </div>

        <!-- Identity Area -->
        <div class="identity-bar">
            <div class="identity-user">
                <img src="{{ url_for('static', filename=session.get('profile_pic') or 'default.jpg') }}" id="myAvatar">
                <div>
                    <div style="font-weight: 600; font-size: 0.9rem;">{{ session.get('name') }} <span style="font-size: 0.65rem; opacity: 0.5; font-weight: 400; margin-left: 2px;">#{{ 1000000000 + (session.get('user_id')|int) }}</span></div>
                    <div class="anon-switch">
                        <span>Go Anonymous</span>
                        <label class="switch">
                            <input type="checkbox" id="anonToggle" onchange="toggleAnonymous()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <button style="background:none; border:none; cursor:pointer; font-size:1.2rem;" onclick="showSettingsModal()">‚öôÔ∏è</button>
        </div>
    </div>

    <!-- Main Window -->
    <div class="chat-window">
        <div class="chat-top-bar">
            <button id="mobileBackBtn" onclick="hideMobileChat()" class="btn btn-sm btn-outline-light" style="display:none; border-radius:50%; width:32px; height:32px; align-items:center; justify-content:center; margin-right:10px; border:none; background:rgba(255,255,255,0.1);">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="active-chat-info">
                <div id="activeChatIcon" style="background: var(--primary-gradient); width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">üåê</div>
                <div>
                    <h3 style="margin:0; font-size:1.1rem; font-weight:700;" id="activeChatName">Global Hub</h3>
                    <div style="font-size:0.75rem; color:var(--accent)" id="activeChatStatus">Live Community</div>
                </div>
            </div>
            <div style="display:flex; gap:16px;">
                <button class="btn btn-sm btn-outline-light" style="border-radius:10px;" onclick="showLogsModal()">üìã Logs</button>
                <button class="btn btn-sm btn-outline-light" style="border-radius:10px;" onclick="showRulesModal()">üõ°Ô∏è Rules</button>
                <button class="btn btn-sm btn-outline-light" style="border-radius:10px;" onclick="toggleSettingsPanel()" id="chatSettingsBtn">‚öôÔ∏è Settings</button>
            </div>
        </div>

        <!-- Settings Panel (Slides from right) -->
        <div id="chatSettingsPanel" class="chat-settings-panel" style="display:none;">
            <div class="settings-header">
                <h4 style="margin:0; font-weight:700;">Chat Settings</h4>
                <button onclick="toggleSettingsPanel()" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;">‚úï</button>
            </div>
            
            <!-- Scrollable Content Wrapper -->
            <div class="settings-scroll-area" style="flex:1; overflow-y:auto; overflow-x:hidden; scrollbar-width:none; -ms-overflow-style:none;">
            
            <div class="settings-section">
                <h4 style="margin-top:12px; font-weight:700; margin-bottom:4px;" id="settingsName">Group Name</h4>
                
                <!-- Topic (Editable for Admins) -->
                <div style="margin-bottom:8px;">
                    <input type="text" id="settingsTopicInput" placeholder="Set a topic..." 
                           style="width:100%; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); 
                                  border-radius:8px; padding:8px 12px; color:white; font-size:0.85rem; display:none;"
                           maxlength="100">
                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom:0; cursor:pointer;" 
                       id="settingsTopic" onclick="editTopic()">Group Topic</p>
                </div>
                
                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">
                    Admin: <span id="settingsOwnerName" style="color:white;">Unknown</span>
                </div>
            </div>
            
            <!-- Group Photo -->
            <div class="settings-section">
                <label class="settings-label">Group Photo</label>
                <div style="display:flex; align-items:center; gap:16px;">
                    <img id="groupPhotoPreview" src="/static/default.jpg" style="width:64px; height:64px; border-radius:16px; object-fit:cover; border:2px solid var(--glass-border);">
                    <div>
                        <input type="file" id="groupPhotoInput" style="display:none;" accept="image/*" onchange="previewGroupPhoto(this)">
                        <button class="btn btn-sm btn-primary" style="border-radius:10px;" onclick="document.getElementById('groupPhotoInput').click()">Change Photo</button>
                    </div>
                </div>
            </div>
            
            <!-- Theme -->
            <div class="settings-section">
                <label class="settings-label">Theme</label>
                <div class="theme-options">
                    <div class="theme-option" onclick="setTheme('dark')" data-theme="dark" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);"></div>
                    <div class="theme-option" onclick="setTheme('purple')" data-theme="purple" style="background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);"></div>
                    <div class="theme-option" onclick="setTheme('blue')" data-theme="blue" style="background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%);"></div>
                    <div class="theme-option" onclick="setTheme('green')" data-theme="green" style="background: linear-gradient(135deg, #047857 0%, #10b981 100%);"></div>
                    <div class="theme-option" onclick="setTheme('red')" data-theme="red" style="background: linear-gradient(135deg, #b91c1c 0%, #ef4444 100%);"></div>
                </div>
            </div>
            
            <!-- Chat Type -->
            <div class="settings-section">
                <label class="settings-label">Chat Type</label>
                <select id="chatTypeSelect" class="form-select" style="background:#0f172a; border:1px solid var(--glass-border); color:white; border-radius:10px; padding:10px;" onchange="updateChatType(this.value)">
                    <option value="public" style="background:#0f172a; color:white;">üåê Public</option>
                    <option value="private" style="background:#0f172a; color:white;">üîí Private</option>
                    <option value="p2p" style="background:#0f172a; color:white;">üë§ Peer-to-Peer</option>
                </select>
            </div>
            
            <!-- Members Section -->
            <div class="settings-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <label class="settings-label" style="margin:0;">Members</label>
                    <button class="btn btn-sm btn-primary" style="border-radius:10px; font-size:0.75rem;" onclick="showAddMemberModal()">+ Add</button>
                </div>
                <div id="membersList" class="members-list" style="max-height:150px; overflow-y:auto; scrollbar-width:thin;">
                    <!-- Dynamically populated -->
                    <div class="member-item">
                        <img src="/static/default.jpg" class="member-avatar">
                        <span>Loading...</span>
                    </div>
                </div>
            </div>
            
            <!-- Danger Zone -->
            <div class="settings-section" style="border-top:1px solid rgba(239,68,68,0.3); padding-top:16px;">
                <label class="settings-label" style="color:#ef4444;">Danger Zone</label>
                <button class="btn w-100" style="background:rgba(239,68,68,0.1); color:#ef4444; border:1px solid rgba(239,68,68,0.3); border-radius:10px; padding:10px; margin-bottom:8px;" onclick="leaveChannel()">
                    üö™ Leave Channel
                </button>
                <button class="btn w-100" style="background:rgba(239,68,68,0.2); color:#ef4444; border:1px solid rgba(239,68,68,0.5); border-radius:10px; padding:10px;" onclick="deleteChannel()">
                    üóëÔ∏è Delete Channel
                </button>
            </div>
            
            </div><!-- End Scrollable Content Wrapper -->
            
            <!-- Save Button (Fixed at bottom) -->
            <div class="settings-section" style="padding-top:12px; border-top:1px solid var(--glass-border);">
                <button class="btn btn-primary w-100" style="border-radius:12px; padding:12px; font-weight:600;" onclick="saveChannelSettings()">üíæ Save Changes</button>
            </div>
        </div>

        <div class="messages-area" id="messageArea">
            <!-- Messages go here -->
        </div>

        <div class="input-area">
            <div class="glass-input-wrapper">
                <!-- Emoji Button -->
                <button id="emojiBtn" title="Add Emoji" style="background:none; border:none; font-size:1.1rem; color:var(--text-muted); cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; margin-right:8px; transition:color 0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='var(--text-muted)'" onclick="toggleEmojiPicker()">
                    <i class="far fa-smile"></i>
                </button>
                
                <!-- Emoji Picker Container (Hidden by default) -->
                <div id="emojiPicker" style="display:none; position:absolute; bottom:60px; left:20px; background:rgba(20,20,30,0.95); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:10px; width:280px; box-shadow:0 4px 15px rgba(0,0,0,0.5); backdrop-filter:blur(10px); z-index:100; max-height:300px; overflow-y:auto; grid-template-columns: repeat(8, 1fr); gap: 5px;">
                    <!-- Populated by JS -->
                </div>

                <!-- File Upload Button -->
                <button title="Attach File" style="background:none; border:none; font-size:1.1rem; color:var(--text-muted); cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; margin-right:8px; transition:color 0.2s; position:relative; z-index:10;" onmouseover="this.style.color='white'" onmouseout="this.style.color='var(--text-muted)'" onclick="console.log('üìé Clicked'); document.getElementById('chatUploadInput').click()">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="chatUploadInput" style="display:none;" onchange="handleFileUpload(this)">

                <input type="text" placeholder="Type a message..." id="messageInput">
                <button class="btn-send" id="sendBtn">‚û§</button>
            </div>
        </div>
    </div>
</div>

<!-- Leaderboard Container (Hidden by default) -->
<div id="leaderboardContainer" class="messenger-container" style="display:none; flex-direction: column; padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 style="background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-size: 2.5rem; font-weight: 800; margin: 0;">Community Leaderboard</h1>
            <p style="color: var(--text-muted); margin-top: 0.5rem;">Top readers sharing their progress with the community</p>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 0.9rem; color: var(--text-muted);">Your Profile Visibility</div>
            <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: flex-end; margin-top: 0.25rem;">
                <span style="font-size: 0.8rem;" id="lb-visibility-text">
                    {% if user.is_public %}
                        <span style="color: #4ade80;">‚óè Visible</span>
                    {% else %}
                        <span style="color: #ef4444;">‚óè Hidden</span>
                    {% endif %}
                </span>
                <button class="btn btn-sm btn-outline-light" style="border-radius: 20px; font-size: 0.75rem;" onclick="location.href='/member/goals'">Manage</button>
            </div>
        </div>
    </div>

    <div class="glass-card" style="flex: 1; overflow-y: auto; padding: 0; background: rgba(0, 0, 0, 0.25); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02);">
                    <th style="padding: 1.25rem 1rem; text-align: center; color: var(--text-muted); width: 80px; font-weight: 600; font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase;">Rank</th>
                    <th style="padding: 1.25rem 1rem; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase;">Reader</th>
                    <th style="padding: 1.25rem 1rem; text-align: center; color: var(--text-muted); font-weight: 600; font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase;">Books Read</th>
                    <th style="padding: 1.25rem 1rem; text-align: center; color: var(--text-muted); font-weight: 600; font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase;">Yearly Goal</th>
                </tr>
            </thead>
            <tbody id="leaderboardBody">
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>
</div>

<script>
async function showLeaderboard() {
    // UI Toggle
    document.querySelectorAll('.nav-icon').forEach(n => n.classList.remove('active'));
    document.getElementById('tab-leaderboard').classList.add('active');
    
    document.querySelector('.messenger-container').style.display = 'none'; // Hide Chat
    document.getElementById('leaderboardContainer').style.display = 'flex'; // Show LB

    // Fetch Data
    const tbody = document.getElementById('leaderboardBody');
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:2rem;">Loading top readers...</td></tr>';

    try {
        const res = await fetch('/member/api/leaderboard');
        const data = await res.json();
        
        tbody.innerHTML = '';
        data.forEach((user, index) => {
            const rank = index + 1;
            let medal = '';
            if(rank === 1) medal = 'ü•á';
            if(rank === 2) medal = 'ü•à';
            if(rank === 3) medal = 'ü•â';

            const row = `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <td style="padding: 1rem; text-align: center; font-weight: 700; font-size: 1.1rem;">
                        ${medal || rank}
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <img src="/static/${user.profile_pic || 'default.jpg'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--glass-border);">
                            <div>
                                <a href="/member/profile/${user.user_id}" style="color: white; text-decoration: none; font-weight: 600;">${user.name}</a>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${user.tier || 'Member'}</div>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 1rem; text-align: center; font-weight: 700; color: #c084fc;">
                        ${user.books_read}
                    </td>
                    <td style="padding: 1rem; text-align: center; color: var(--text-muted);">
                        ${user.goal_books}
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

    } catch(e) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:2rem; color: #ef4444;">Failed to load leaderboard.</td></tr>';
    }
}

// Hook into existing switchTab to hide leaderboard
const originalSwitchTab = window.switchTab || function(){};
window.switchTab = function(type) {
    // Hide leaderboard, show chat
    document.querySelector('.messenger-container').style.display = 'flex';
    document.getElementById('leaderboardContainer').style.display = 'none';
    document.getElementById('tab-leaderboard').classList.remove('active');
    
    if (typeof originalSwitchTab === 'function') {
        // We need to reimplement the basic switch tab logic or assume the original function is available
        // Since I can't easily wrap the original strictly defined in script tag without conflicts, 
        // I'll just toggle the UI classes here manually as a patch for the tab buttons
        document.querySelectorAll('.nav-icon').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-' + type).classList.add('active');
        
        // Trigger the chat filter logic if accessible, or relying on the original onclick handler usually works 
        // if I didn't override the function. But since I am, I should call the original logic.
        // CHECK: The original community.html script logic is separate. 
        // I will just rely on the existing onclick handlers for the other tabs to work, 
        // BUT I need to make sure they hide the leaderboard.
        // Actually, best way is to add the hiding logic to the existing onclicks via event delegation or modifying them.
        // But since I am replacing content, I can just bake the logic into the new function.
        // Let's safe-guard this.
        
        // Call original logic (assumed global)
        // But wait, I can't easily call the original function if I overwrote it.
        // I will NOT overwrite it. I will let the onclicks handle themselves, but I will
        // add logic to the other tabs to hide leaderboard.
    }
}
</script>

<script>
// Patching existing tabs to hide leaderboard
document.addEventListener('DOMContentLoaded', () => {
    ['tab-public', 'tab-personal', 'tab-group'].forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            const oldClick = el.onclick;
            el.onclick = function(e) {
                document.querySelector('.messenger-container').style.display = 'flex';
                document.getElementById('leaderboardContainer').style.display = 'none';
                document.getElementById('tab-leaderboard').classList.remove('active');
                if(oldClick) oldClick.call(this, e);
            }
        }
    });
});
</script>
</div>


<!-- Create Group Modal -->
<div class="modal" id="createGroupModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Community Groups</h5>
                <button type="button" class="btn-close-custom" onclick="forceCloseModals()">&times;</button>
            </div>
            <div class="modal-body p-4">
                <!-- Tabs -->
                <div class="d-flex gap-3 mb-4 border-bottom" style="border-color: rgba(255,255,255,0.1)!important; padding-bottom: 0px;">
                    <div class="tab-pill active" onclick="switchGroupModalTab('create')" id="tab-pill-create">Create Group</div>
                    <div class="tab-pill" onclick="switchGroupModalTab('join')" id="tab-pill-join">Join by ID</div>
                </div>

                <!-- Create View -->
                <div id="view-create">
                    <div class="mb-4">
                        <label class="form-label fw-bold text-uppercase">Group Name</label>
                        <input type="text" class="form-control" id="newGroupName" placeholder="Enter group name">
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold text-uppercase">Privacy</label>
                        <select class="form-select" id="groupPrivacy">
                            <option value="public" style="background: #1e1b4b;">Public Hub</option>
                            <option value="private" style="background: #1e1b4b;">Private (Invite only)</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary w-100" onclick="submitCreateChannel()" style="background: var(--primary-gradient); border: none; border-radius: 12px; padding: 12px; font-weight: 600;">Create Group</button>
                    </div>
                </div>

                <!-- Join View -->
                <div id="view-join" style="display:none;">
                    <div class="mb-4">
                        <label class="form-label fw-bold text-uppercase">Group ID or Public ID</label>
                        <input type="text" class="form-control" id="joinGroupId" placeholder="e.g. 1000000005">
                        <div class="form-text text-muted mt-2">Ask the group admin for their Public ID.</div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary w-100" onclick="joinChannelById()" style="background: var(--primary-gradient); border: none; border-radius: 12px; padding: 12px; font-weight: 600;">Join Group</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settingsModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Chat Settings</h5>
                <button type="button" class="btn-close-custom" onclick="forceCloseModals()">&times;</button>
            </div>
            <div class="modal-body p-4">
                <div id="channelSettingsView">
                    <h6 class="text-accent mb-3 fw-bold">Group Management</h6>
                    <button class="btn btn-danger w-100 mb-3" onclick="deleteCurrentChannel()" style="border-radius:12px;">Delete Group</button>
                    <button class="btn btn-outline-light w-100" onclick="editChannelName()" style="border-radius:12px;">Rename Group</button>
                </div>
                <hr class="my-4" style="border-color: rgba(255,255,255,0.2);">
                <div id="accountSettingsView">
                    <h6 class="text-accent mb-3 fw-bold">Your Account</h6>
                    <a href="/logout" class="btn btn-outline-danger w-100" style="border-radius:12px;">Logout</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Profile Modal -->
<div class="modal" id="userProfileModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">My Profile</h5>
                <button type="button" class="btn-close-custom" onclick="forceCloseModals()">&times;</button>
            </div>
            <div class="modal-body p-4 text-center">
                
                <!-- Avatar Section -->
                <div class="position-relative d-inline-block mb-4" style="cursor:pointer;" onclick="document.getElementById('profileAvatarInput').click()">
                    <img src="" id="profileModalAvatar" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,0.2);">
                    <div class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:32px; height:32px; border:2px solid #1e293b;">
                        <i class="fas fa-camera" style="font-size:0.8rem;"></i>
                    </div>
                </div>
                <form id="avatarUploadForm" action="/member/profile/upload" method="POST" enctype="multipart/form-data" style="display:none;">
                    <input type="file" name="avatar" id="profileAvatarInput" accept="image/*" onchange="document.getElementById('avatarUploadForm').submit()">
                </form>

                <!-- Basic Info -->
                <div class="mb-3 text-start">
                    <label class="form-label text-uppercase fw-bold text-muted" style="font-size:0.75rem;">Display Name</label>
                    <input type="text" id="profileNameInput" class="form-control" placeholder="Your Name">
                </div>

                <div class="mb-3 text-start">
                    <label class="form-label text-uppercase fw-bold text-muted" style="font-size:0.75rem;">About Me</label>
                    <textarea id="profileBioInput" class="form-control" rows="3" placeholder="Tell us about yourself..."></textarea>
                </div>

                <div class="mb-4 text-start">
                     <label class="form-label text-uppercase fw-bold text-muted" style="font-size:0.75rem;">My Public ID</label>
                     <div class="input-group">
                        <span class="input-group-text glass-input" style="border-right:0;">#</span>
                        <input type="text" id="profilePublicId" class="form-control glass-input" style="border-left:0;" readonly>
                        <button class="btn btn-outline-light" onclick="navigator.clipboard.writeText(document.getElementById('profilePublicId').value); alert('Copied ID!')">üìã</button>
                     </div>
                </div>

                <!-- Account Actions -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="saveUserProfile()" style="border-radius:10px; font-weight:600;">Save Changes</button>
                    <a href="/logout" class="btn btn-outline-danger" style="border-radius:10px;">Logout</a>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Connections Hub Modal -->
<!-- Connections Hub Modal (Refactored) -->
<div class="modal" id="newChatModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Connections Hub</h5>
                <button type="button" class="btn-close-custom" onclick="forceCloseModals()">&times;</button>
            </div>
            <div class="modal-body p-4">
                <!-- Tabs -->
                <div class="d-flex gap-3 mb-4 border-bottom" style="border-color: rgba(255,255,255,0.1)!important; padding-bottom: 0px;">
                    <div class="tab-pill active" onclick="switchConnectionsTab('find')" id="tab-pill-find">Find People</div>
                    <div class="tab-pill" onclick="switchConnectionsTab('requests')" id="tab-pill-requests">
                        Requests <span id="requestsBadge" class="badge bg-danger rounded-pill ms-1" style="display:none">0</span>
                    </div>
                </div>

                <!-- Find View -->
                <div id="view-find">
                    <div class="search-box mb-4" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">
                        <span>üîç</span>
                        <input type="text" placeholder="Search by name..." id="userSearchInput" onkeyup="searchUsers()" style="color: white !important;">
                    </div>
                    <div id="userSearchResults" style="max-height: 250px; overflow-y: auto;">
                        <!-- Results -->
                    </div>
                </div>

                <!-- Requests View -->
                <div id="view-requests" style="display:none;">
                     <div id="pendingInvitesList" style="max-height: 300px; overflow-y: auto;"></div>
                     <div id="noInvitesMsg" class="text-center text-muted mt-4" style="display:none">No pending requests</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="msgContextMenu" class="context-menu" style="display:none; position:fixed; z-index:20000; background:#1e293b; border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:6px; box-shadow:0 10px 25px rgba(0,0,0,0.5); min-width:150px; backdrop-filter: blur(20px);">
    <div class="context-item" onclick="ctxReply()" style="padding:10px 16px; cursor:pointer; color:#e2e8f0; font-size:0.9rem; border-radius:8px; display:flex; gap:10px; align-items:center;">
        <span>‚Ü©Ô∏è</span> Reply
    </div>
    <div class="context-item" onclick="ctxCopy()" style="padding:10px 16px; cursor:pointer; color:#e2e8f0; font-size:0.9rem; border-radius:8px; display:flex; gap:10px; align-items:center;">
        <span>üìã</span> Copy Text
    </div>
    <div class="context-item owner-only" onclick="ctxEdit()" style="padding:10px 16px; cursor:pointer; color:#facc15; font-size:0.9rem; border-radius:8px; display:flex; gap:10px; align-items:center;">
        <span>‚úèÔ∏è</span> Edit
    </div>
    <div class="context-item owner-only" onclick="ctxDelete()" style="padding:10px 16px; cursor:pointer; color:#ef4444; font-size:0.9rem; border-radius:8px; display:flex; gap:10px; align-items:center;">
        <span>üóëÔ∏è</span> Delete
    </div>
</div>




<!-- Logs Modal -->
<div class="modal" id="logsModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content glass-modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Audit Logs</h5>
                <button type="button" class="btn-close-custom" onclick="logsModal.hide()">&times;</button>
            </div>
            <div class="modal-body p-4">
                <div id="logsList" style="max-height: 400px; overflow-y: auto; display:flex; flex-direction:column; gap:8px;">
                    <!-- Logs go here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rules Modal -->
<div class="modal" id="rulesModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Community Rules</h5>
                <button type="button" class="btn-close-custom" onclick="rulesModal.hide()">&times;</button>
            </div>
            <div class="modal-body p-4">
                <textarea id="rulesText" class="form-control" rows="10" placeholder="Loading rules..." style="background:rgba(255,255,255,0.05); color:white; border:1px solid rgba(255,255,255,0.1); border-radius:12px; resize:none;"></textarea>
                <div class="mt-3 text-end" id="rulesSaveBtnContainer" style="display:none;">
                    <button class="btn btn-primary" onclick="saveRules()" style="border-radius:10px;">üíæ Save Rules</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.context-item:hover {
    background: rgba(255,255,255,0.1);
}
/* Hide scrollbar globally for a cleaner UI */
::-webkit-scrollbar {
    display: none;
}
* {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}
</style>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    let createGroupModal, settingsModal, newChatModal, logsModal, rulesModal, userProfileModal;

    const socket = io();
    
    // ... (rest of vars) ...
    
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize Modals properly
        const cgEl = document.getElementById('createGroupModal');
        const stEl = document.getElementById('settingsModal');
        const ncEl = document.getElementById('newChatModal');
        const upEl = document.getElementById('userProfileModal'); // New Profile Modal

        // FORCE MOVE TO BODY: This fixes all stacking context issues
        if(cgEl) { document.body.appendChild(cgEl); createGroupModal = new bootstrap.Modal(cgEl, { backdrop: true, keyboard: true }); }
        if(stEl) { document.body.appendChild(stEl); settingsModal = new bootstrap.Modal(stEl, { backdrop: true, keyboard: true }); }
        if(ncEl) { document.body.appendChild(ncEl); newChatModal = new bootstrap.Modal(ncEl, { backdrop: true, keyboard: true }); }
        if(upEl) { document.body.appendChild(upEl); userProfileModal = new bootstrap.Modal(upEl, { backdrop: true, keyboard: true }); } // Init
        
        // ... (rest of initializers) ...
    });

    // ... (rest of functions) ...

    function showSettingsModal() {
       // OLD: settingsModal.show();
       // NEW: Redirect to Profile Modal as requested by user
       showUserProfileModal();
    }
    
    function showUserProfileModal() {
        if(!userProfileModal) return;
        
        // Populate Data
        document.getElementById('profileModalAvatar').src = document.getElementById('myAvatar').src;
        document.getElementById('profileNameInput').value = "{{ session.get('name') }}";
        // Bio isn't in session unless we add it, for now fetch or leave empty if not critical
        // document.getElementById('profileBioInput').value = ...; 
        
        // Public ID
        const uid = {{ session.get('user_id', 0) }};
        document.getElementById('profilePublicId').value = formatPublicId(uid);
        
        userProfileModal.show();
    }
    
    async function saveUserProfile() {
        const name = document.getElementById('profileNameInput').value;
        const bio = document.getElementById('profileBioInput').value;
        
        try {
            constres = await fetch('/member/profile/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, bio })
            });
            const data = awaitres.json();
            
            if(data.success) {
                alert('‚úÖ Profile updated!');
                location.reload(); // Reload to refresh sidebar/session
            } else {
                alert('‚ùå Error: ' + (data.error || 'Update failed'));
            }
        } catch(e) {
            alert('Failed to update profile');
        }
    }
    
    function forceCloseModals() {
        if(createGroupModal) createGroupModal.hide();
        if(settingsModal) settingsModal.hide();
        if(newChatModal) newChatModal.hide();
        if(userProfileModal) userProfileModal.hide();
        
        // ... (rest of cleanup) ...
    }
    const myId = parseInt("{{ session.get('user_id') | default('-1') }}");
    const PUBLIC_ID_OFFSET = 1000000000;
    
    function formatPublicId(id) {
        if (!id || id == -1) return '';
        return '#' + (parseInt(id) + PUBLIC_ID_OFFSET);
    }
    
    let currentChannelId = 1; // Default to Global
    let isAnonymousMode = {{ 'true' if session.get('is_anon') else 'false' }}; // Initialize from template
    const userRole = '{{ session.get("role", "member") }}'; // Admin or member
    const currentUserId = {{ session.get('user_id', 0) }};
    
    async function toggleAnonymous() {
        console.log("üé≠ toggleAnonymous called");
        isAnonymousMode = document.getElementById('anonToggle').checked; // Update global state from checkbox
        console.log("üé≠ Anonymous Mode:", isAnonymousMode);
        try {
            const res = await fetch('/chat/anonymous', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ is_anon: isAnonymousMode })
            });
            console.log("üé≠ Server Response:", res.status);
            
            // Update UI
            const avatar = document.getElementById('myAvatar');
            if (isAnonymousMode) { // Use the global variable here
                avatar.style.filter = 'grayscale(100%) brightness(0.5)';
                console.log("üé≠ Avatar grayed out");
            } else {
                avatar.style.filter = '';
                console.log("üé≠ Avatar restored");
            }
        } catch(e) {
            console.error("‚ùå Failed to toggle anonymous:", e);
        }
    }
    

    <script src="{{ url_for('static', filename='js/js_channel_settings.js') }}"></script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize Modals properly
        const cgEl = document.getElementById('createGroupModal');
        const stEl = document.getElementById('settingsModal');
        const ncEl = document.getElementById('newChatModal');

        // FORCE MOVE TO BODY: This fixes all stacking context issues
        if(cgEl) { document.body.appendChild(cgEl); createGroupModal = new bootstrap.Modal(cgEl, { backdrop: true, keyboard: true }); }
        if(stEl) { document.body.appendChild(stEl); settingsModal = new bootstrap.Modal(stEl, { backdrop: true, keyboard: true }); }
        if(ncEl) { document.body.appendChild(ncEl); newChatModal = new bootstrap.Modal(ncEl, { backdrop: true, keyboard: true }); }
        
        const lmEl = document.getElementById('logsModal');
        const rmEl = document.getElementById('rulesModal');
        if(lmEl) { document.body.appendChild(lmEl); logsModal = new bootstrap.Modal(lmEl, { backdrop: true }); }
        if(rmEl) { document.body.appendChild(rmEl); rulesModal = new bootstrap.Modal(rmEl, { backdrop: true }); }

        // Cleanup any lingering backdrops on load
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

        // Initial setup
        loadConversation('global');
        fetchConversations();

        // Listeners
        document.getElementById('sendBtn').onclick = sendMessage;
        document.getElementById('messageInput').onkeypress = (e) => { if(e.keyCode === 13) sendMessage(); };
    });

    let currentTab = 'public';
    let allConversations = { public: [], personal: [], group: [] };

    async function fetchConversations() {
        try {
            const res = await fetch('/chat/conversations');
            const data = await res.json();
            if(data.success) {
                allConversations = data.conversations;
                renderChatList();
            }
        } catch (e) { console.error("Fetch Error:", e); }
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.nav-icon').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        renderChatList();
    }

    function renderChatList() {
        const container = document.getElementById('dynamicChatList');
        container.innerHTML = '';
        
        const list = allConversations[currentTab] || [];
        
        if (list.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted); font-size:0.8rem;">No conversations in this category.</div>`;
            return;
        }

        list.forEach(item => {
            const div = document.createElement('div');
            div.className = `chat-item ${currentChannelId == item.channel_id ? 'active' : ''}`;
            div.id = `chat-${item.channel_id}`;
            div.onclick = () => loadConversation(item.channel_id, item.name, item.type, item.icon);
            
            const defaultIcon = (item.type === 'personal') ? 'üë§' : (item.type === 'group' ? 'üë•' : 'üåê');
            
            // Use custom icon if available
            let iconHtml = '';
            if (item.icon) {
                iconHtml = `<img src="/static/${item.icon}" style="width:100%; height:100%; object-fit:cover; border-radius:14px;">`;
            } else {
                iconHtml = defaultIcon;
            }
            
            div.innerHTML = `
                <div style="background: var(--primary-gradient); width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; overflow:hidden;">${iconHtml}</div>
                <div class="chat-info">
                    <div class="chat-name">${item.name} <span style="font-size: 0.65rem; opacity: 0.5; font-weight: 400;">#${item.public_id}</span></div>
                    <div class="chat-preview">${item.guild_name || 'Active hub'}</div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // Call on load
    fetchConversations();

    async function loadConversation(id, name, type, icon) {
        currentChannelId = (id === 'global') ? 1 : id;
        window.currentChatType = type; // Store globally for checks
        
        // UI Updates
        document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
        const activeItem = document.getElementById(`chat-${id}`);
        if(activeItem) activeItem.classList.add('active');

        const displayName = name || (id === 'global' ? 'Global Community' : 'Private chat');
        const displayId = (id === 'global') ? '#1000000001' : formatPublicId(id);
        
        let iconMarkup = 'üåê';
        let statusText = 'Live Community';
        
        if (type === 'personal') {
            iconMarkup = 'üë§';
            statusText = 'Peer-to-Peer';
        } else if (type === 'group') {
            iconMarkup = 'üë•';
            statusText = 'Private Group';
        } else if (id === 'global') {
            iconMarkup = 'üåê';
            statusText = 'Global Community';
        }
        
        // If custom icon exists, display image instead of emoji
        const iconEl = document.getElementById('activeChatIcon');
        if (icon) {
            iconEl.innerHTML = `<img src="/static/${icon}" style="width:100%; height:100%; object-fit:cover; border-radius:12px;">`;
        } else {
            iconEl.innerHTML = iconMarkup;
        }
        
        document.getElementById('activeChatName').innerHTML = `${displayName} <span style="font-size: 0.8rem; opacity: 0.5; font-weight: 400; margin-left: 8px;">${displayId}</span>`;
        document.getElementById('activeChatStatus').innerText = statusText;

        // Join Socket Room - Ensure string ID
        socket.emit('join_channel', { channel_id: String(currentChannelId) });

        // Fetch History
        const res = await fetch(`/chat/channels/${currentChannelId}/messages`);
        const data = await res.json();
        const container = document.getElementById('messageArea');
        container.innerHTML = '';
        
        if(data.success) {
            data.messages.reverse().forEach(renderMessage);
            scrollToBottom();
        }
        
        // Load channel-specific theme
        loadChannelTheme();
        
        // Setup Input Access (Global Chat Restriction)
        const msgInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const uploadBtn = document.querySelector('button[title="Attach File"]'); // Button that triggers upload
        
        if (id === 1 || id === 'global') {
            if (userRole !== 'admin') {
                msgInput.disabled = true;
                msgInput.placeholder = "Read-only channel (Admin only)";
                msgInput.style.opacity = "0.5";
                msgInput.style.cursor = "not-allowed";
                
                if(sendBtn) {
                     sendBtn.disabled = true;
                     sendBtn.style.opacity = "0.5";
                     sendBtn.style.cursor = "not-allowed";
                }
                
                if(uploadBtn) {
                    uploadBtn.disabled = true;
                    uploadBtn.style.opacity = "0.5";
                    uploadBtn.style.cursor = "not-allowed";
                    uploadBtn.onclick = null; // Remove click handler
                }
            } else {
                // Admin in Global - Enable
                msgInput.disabled = false;
                msgInput.placeholder = "Type a message...";
                msgInput.style.opacity = "1";
                msgInput.style.cursor = "text";
                if(sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = "1";
                    sendBtn.style.cursor = "pointer";
                }
                if(uploadBtn) {
                    uploadBtn.disabled = false;
                    uploadBtn.style.opacity = "1";
                    uploadBtn.style.cursor = "pointer";
                    uploadBtn.onclick = function() { document.getElementById('chatUploadInput').click(); };
                }
            }
        } else {
            // Normal Chat - Enable
            msgInput.disabled = false;
            msgInput.placeholder = "Type a message...";
            msgInput.style.opacity = "1";
            msgInput.style.cursor = "text";
            if(sendBtn) {
                sendBtn.disabled = false;
                sendBtn.style.opacity = "1";
                sendBtn.style.cursor = "pointer";
            }
            if(uploadBtn) {
                uploadBtn.disabled = false;
                uploadBtn.style.opacity = "1";
                uploadBtn.style.cursor = "pointer";
                uploadBtn.onclick = function() { document.getElementById('chatUploadInput').click(); };
            }
        }
        
        // Trigger Mobile View
        showMobileChat();
    }

    // Mobile Toggle Helpers
    function showMobileChat() {
        if (window.innerWidth <= 768) {
            document.querySelector('.messenger-container').classList.add('chat-active');
        }
    }

    function hideMobileChat() {
        document.querySelector('.messenger-container').classList.remove('chat-active');
        // Optional: Clear active chat selection visually
        document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
    }

    function renderMessage(msg) {
        const container = document.getElementById('messageArea');
        const div = document.createElement('div');
        
        // Data Normalization
        const sender = msg.sender_name || (msg.user_profile && msg.user_profile.name) || 'Anonymous';
        const sId = msg.user_id || msg.sender_id || (msg.user_profile && msg.user_profile.id);
        const content = msg.content || msg.message_text || msg.message || "";
        const time = msg.created_at || 'Just now';
        
        // Identify if it belongs to current user
        const isMe = (msg.sender_type === 'me') || (String(sId) === String(myId));
        
        div.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-other'}`;
        div.dataset.mid = msg.message_id; 
        
        const publicHandle = sId ? `<span style="font-weight:400; font-size:0.65rem; opacity:0.5; margin-left:4px;">${formatPublicId(sId)}</span>` : '';
        
        let attachmentHtml = '';
        if(msg.attachment) {
            if(msg.attachment.type === 'image') {
                attachmentHtml = `<img src="${msg.attachment.url}" style="max-width:200px; border-radius:8px; display:block; margin-bottom:4px; cursor:pointer;" onclick="window.open(this.src)">`;
            } else {
                attachmentHtml = `<a href="${msg.attachment.url}" target="_blank" style="display:flex; align-items:center; gap:8px; background:rgba(0,0,0,0.2); padding:8px; border-radius:8px; text-decoration:none; color:inherit; margin-bottom:4px;">
                    <i class="fas fa-file"></i> <span>${msg.attachment.name || 'File'}</span>
                </a>`;
            }
        }

        let replyHtml = '';
        if(msg.reply_to) {
             replyHtml = `<div style="border-left:2px solid var(--primary); padding-left:8px; font-size:0.75rem; opacity:0.7; margin-bottom:4px;">Reply to: ${msg.reply_to.content || '...'}</div>`;
        }

        div.innerHTML = `
            <div style="font-weight:700; font-size:0.75rem; margin-bottom:4px; opacity:0.8;">${sender}${publicHandle}</div>
            ${replyHtml}
            ${attachmentHtml}
            <div class="msg-content" style="word-break: break-word;">${content}</div>
            <div class="msg-meta">${time}</div>
        `;
        container.appendChild(div);
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const txt = input.value.trim();
        
        // --- Edit Mode ---
        if(isEditing && editingMessageId) {
            socket.emit('edit_message', {
                channel_id: String(currentChannelId),
                message_id: editingMessageId,
                new_content: txt
            });
            cancelEdit();
            return;
        }

        // --- Normal Send ---
        const replyCtx = document.getElementById('replyContextBanner');
        const replyId = replyCtx ? replyCtx.dataset.mid : null;
        
        if(!txt && !currentAttachment) return;

        socket.emit('send_message', {
            channel_id: String(currentChannelId),
            message: txt,
            attachment: currentAttachment,
            reply_to_id: replyId,
            is_anon: isAnonymousMode
        });
        
        input.value = '';
        currentAttachment = null;
        if(replyCtx) cancelReply();
        cancelAttachment();
    }
    
    // Reply Context UI
    function cancelReply() {
        const banner = document.getElementById('replyContextBanner');
        if(banner) banner.remove();
    }
    
    function cancelAttachment() {
        currentAttachment = null;
        const banner = document.getElementById('attachmentPreviewBanner');
        if(banner) banner.remove();
         // Also clear file input so change event triggers again for same file
         const fileInput = document.getElementById('chatUploadInput');
         if(fileInput) fileInput.value = '';
    }

    socket.on('receive_message', (msg) => {
        console.log("üì© Message Received:", msg);
        if(String(msg.channel_id) === String(currentChannelId)) {
            renderMessage(msg);
            scrollToBottom();
        } else {
            console.log("üôà Message ignored (wrong channel):", msg.channel_id, "vs", currentChannelId);
        }
    });

    socket.on('error', (err) => {
        console.error("‚ùå Socket Error:", err);
        alert("Chat Error: " + (err.message || "Unknown error"));
    });

    function scrollToBottom() {
        const area = document.getElementById('messageArea');
        area.scrollTop = area.scrollHeight;
    }

    function showCreateGroupModal() {
        createGroupModal.show();
    }

    function showSettingsModal() {
        showUserProfileModal();
    }

    function forceCloseModals() {
        if(createGroupModal) createGroupModal.hide();
        if(settingsModal) settingsModal.hide();
        if(newChatModal) newChatModal.hide();
        if(userProfileModal) userProfileModal.hide();
        
        // Safety cleanup for UI persistence
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }, 100);
    }

    function showNewChatModal() {
        newChatModal.show();
        fetchPendingInvites();
    }

    // ===== CHAT SETTINGS PANEL =====
    let currentTheme = localStorage.getItem('chatTheme') || 'dark';
    let settingsPanelOpen = false;
    
    function toggleSettingsPanel() {
        const panel = document.getElementById('chatSettingsPanel');
        settingsPanelOpen = !settingsPanelOpen;
        
        if(settingsPanelOpen) {
            panel.style.display = 'flex';
            fetchChannelMembers();
            loadChannelSettings();
        } else {
            panel.style.display = 'none';
        }
    }
    
    function setTheme(theme, save = true) {
        currentTheme = theme;
        
        // Save per-channel if save is true
        if(save && currentChannelId) {
            localStorage.setItem(`chatTheme_${currentChannelId}`, theme);
        }
        
        // Update theme option UI
        document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
        const themeEl = document.querySelector(`.theme-option[data-theme="${theme}"]`);
        if(themeEl) themeEl.classList.add('active');
        
        // Theme background colors
        const themes = {
            'dark': { bg: 'rgba(15, 23, 42, 0.95)', accent: '#1e293b' },
            'purple': { bg: 'rgba(88, 28, 135, 0.3)', accent: '#581c87' },
            'blue': { bg: 'rgba(30, 58, 138, 0.3)', accent: '#1e3a8a' },
            'green': { bg: 'rgba(6, 78, 59, 0.3)', accent: '#064e3b' },
            'red': { bg: 'rgba(127, 29, 29, 0.3)', accent: '#7f1d1d' }
        };
        
        const t = themes[theme];
        
        // Only change the chat/messages area background
        const msgArea = document.getElementById('messageArea');
        if(msgArea) {
            msgArea.style.background = t.bg;
        }
        
        // Also update the chat window background slightly
        const chatWindow = document.querySelector('.chat-window');
        if(chatWindow) {
            chatWindow.style.background = `linear-gradient(180deg, ${t.accent}22 0%, transparent 100%)`;
        }
    }
    
    // Load channel-specific theme when switching chats
    function loadChannelTheme() {
        const savedTheme = localStorage.getItem(`chatTheme_${currentChannelId}`) || 'dark';
        setTheme(savedTheme, false); // Don't re-save
    }
    
    function updateChatType(type) {
        console.log('üì¢ Updating chat type to:', type);
        // Will be saved when user clicks Save
    }
    
    async function fetchChannelMembers() {
        // Handle global channel same as others to get count/list
        const targetId = (!currentChannelId || currentChannelId === 'global') ? 1 : currentChannelId;
        
        try {
            const res = await fetch(`/chat/channels/${targetId}/members`);
            const data = await res.json();
            
            if(data.success && data.members) {
                const list = document.getElementById('membersList');
                list.innerHTML = '';
                
                // Show Total Count
                const countDiv = document.createElement('div');
                countDiv.style.padding = '8px 12px';
                countDiv.style.marginBottom = '8px';
                countDiv.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                countDiv.style.color = 'var(--text-muted)';
                countDiv.style.fontSize = '0.85rem';
                countDiv.style.fontWeight = '500';
                countDiv.innerHTML = `Total Members: <span style="color:var(--text-primary);">${data.members.length}</span>`;
                list.appendChild(countDiv);
                
                // Sort members: Admins first
                const admins = data.members.filter(m => m.role === 'admin' || m.is_owner);
                const members = data.members.filter(m => m.role !== 'admin' && !m.is_owner);
                
                const amOwner = data.is_owner || false;
                const amAdmin = data.is_admin || false;
                
                // --- ADMINS SECTION ---
                if (admins.length > 0) {
                    const adminHeader = document.createElement('div');
                    adminHeader.style.padding = '8px 12px';
                    adminHeader.style.color = '#a855f7'; // Purple accent
                    adminHeader.style.fontSize = '0.75rem';
                    adminHeader.style.fontWeight = '700';
                    adminHeader.style.textTransform = 'uppercase';
                    adminHeader.innerText = `Admins (${admins.length})`;
                    list.appendChild(adminHeader);
                    
                    admins.forEach(m => {
                        try { renderMemberItem(m, list, amOwner, amAdmin); } 
                        catch(e) { console.error('Render error:', e); }
                    });
                }
                
                // --- MEMBERS SECTION ---
                if (members.length > 0) {
                     // Check if we should hide normal member list (Global Chat restriction)
                     // If Global Chat (ID 1) AND User is NOT Admin -> Hide "Members" section
                     const isGlobal = (targetId == 1);
                     if (isGlobal && userRole !== 'admin') {
                         const restrictedDiv = document.createElement('div');
                         restrictedDiv.style.padding = '20px';
                         restrictedDiv.style.textAlign = 'center';
                         restrictedDiv.style.color = 'var(--text-muted)';
                         restrictedDiv.style.fontSize = '0.8rem';
                         restrictedDiv.innerHTML = '<i>Member list hidden for Global Community.</i>';
                         list.appendChild(restrictedDiv);
                     } else {
                        const memberHeader = document.createElement('div');
                        memberHeader.style.padding = '8px 12px';
                        memberHeader.style.color = 'var(--text-muted)';
                        memberHeader.style.fontSize = '0.75rem';
                        memberHeader.style.fontWeight = '700';
                        memberHeader.style.textTransform = 'uppercase';
                        memberHeader.style.marginTop = '12px';
                        memberHeader.innerText = `Members (${members.length})`;
                        list.appendChild(memberHeader);
                        
                        members.forEach(m => {
                            try { renderMemberItem(m, list, amOwner, amAdmin); } 
                            catch(e) { console.error('Render error:', e); }
                        });
                     }
                }
            }
        } catch(e) {
            console.error('Error fetching members:', e);
            document.getElementById('membersList').innerHTML = '<div style="padding:20px; text-align:center; color:red;">Failed to load members</div>';
        }
    }
    
    function renderMemberItem(m, list, isOwnerOfChannel, isChannelAdmin) {
        const div = document.createElement('div');
        div.className = 'member-item';
        
        // --- Permissions ---
        const isSelf = (String(m.user_id) === String(currentUserId));
        // Can manage: System Admin OR Channel Owner OR Channel Admin
        // AND NOT in Personal Chat (P2P)
        const isP2P = (window.currentChatType === 'personal');
        const canManage = (userRole === 'admin' || isOwnerOfChannel || isChannelAdmin) && !isSelf && !isP2P;
        
        let actions = '';
        if(canManage) {
            // Kick Button (Hammer)
            const kickBtn = `<button class="action-btn btn-kick" title="Kick Member" onclick="kickMember(${m.user_id}, '${m.name ? m.name.replace("'", "\\'") : "Unknown"}')">
                <img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Hammer.png" alt="Kick" width="24" height="24">
            </button>`;
            
            // Promote/Demote Button
            // m.role is now potentially the channel role (or global)
            const isAdmin = (m.role === 'admin' || m.is_owner);
            if (!m.is_owner) { // Cannot demote owner
                const promoteTitle = isAdmin ? "Demote to Member" : "Make Admin";
                const promoteIcon = isAdmin 
                    ? `<img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Symbols/Down%20Arrow.png" alt="Demote" width="24" height="24">` 
                    : `<img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Crown.png" alt="Make Admin" width="24" height="24">`;
                
                const promoteColor = isAdmin ? "#f59e0b" : "#10b981"; // Yellow to remove, Green to add
                
                actions += `<button class="action-btn" title="${promoteTitle}" onclick="updateMemberRole(${m.user_id}, '${isAdmin ? 'member' : 'admin'}')" style="color:${promoteColor}; border-color:${promoteColor}30; background:${promoteColor}10;">
                    ${promoteIcon}
                </button>`;
            }
            
            actions += kickBtn;
        }
        
        // Add badges
        let badges = '';
        if(m.is_owner) badges += '<span style="background:#eab308; color:black; font-size:0.6rem; padding:2px 6px; border-radius:4px; margin-left:6px; font-weight:700;">OWNER</span>';
        else if(m.role === 'admin') badges += '<span style="background:#a855f7; color:white; font-size:0.6rem; padding:2px 6px; border-radius:4px; margin-left:6px; font-weight:700;">ADMIN</span>';
        
        div.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px;">
                <img src="/static/${m.profile_pic || 'default.jpg'}" class="member-avatar">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:600; font-size:0.9rem;">${m.name || 'Unknown'}${badges}</span>
                    <span style="font-size:0.7rem; color:var(--text-muted);">#${1000000000 + (m.user_id || 0)}</span>
                </div>
            </div>
            <div style="display:flex; gap:8px;">${actions}</div>
        `;
        list.appendChild(div);
    }
    
    async function updateMemberRole(userId, newRole) {
        if(!confirm(`Are you sure you want to change this user's role to ${newRole.toUpperCase()}?`)) return;
        
        try {
            const res = await fetch(`/chat/channels/${currentChannelId}/members/${userId}/role`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ role: newRole })
            });
            const data = await res.json();
            if(data.success) {
                // Refresh list
                fetchChannelMembers();
            } else {
                alert('Error: ' + (data.error || 'Failed to update role'));
            }
        } catch(e) {
            console.error(e);
            alert('Failed to update role');
        }
    }
    
    async function kickMember(userId, userName) {
        if(!confirm(`Are you sure you want to kick ${userName} from this channel?`)) return;
        
        try {
            const res = await fetch(`/chat/channels/${currentChannelId}/kick/${userId}`, {
                method: 'POST'
            });
            const data = await res.json();
            
            if(data.success) {
                alert('‚úÖ ' + (data.message || 'Member kicked'));
                fetchChannelMembers(); // Refresh list
            } else {
                alert('‚ùå ' + (data.error || 'Failed to kick member'));
            }
        } catch(e) {
            console.error('Error kicking member:', e);
            alert('‚ùå Error kicking member');
        }
    }
    
    function showAddMemberModal() {
        // Set mode to Group Invite
        window.inviteMode = 'group';
        window.inviteTargetChannelId = currentChannelId;
        
        // Update Modal Title (Optional but nice)
        const title = document.querySelector('#newChatModal .modal-title');
        if(title) title.innerText = "Invite to Group";

        // Use existing newChatModal for user search
        newChatModal.show();
        // Switch to find tab
        switchConnectionsTab('find');
    }
    
    function previewGroupPhoto(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('groupPhotoPreview').src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    // --- TOPIC EDITING ---
    let canEditTopic = false; // Set by loadChannelSettings based on admin status
    
    function editTopic() {
        if(!canEditTopic) return; // Non-admins can't edit
        
        const display = document.getElementById('settingsTopic');
        const input = document.getElementById('settingsTopicInput');
        
        if(display && input) {
            // Switch to edit mode
            input.value = display.innerText === 'No topic set' ? '' : display.innerText;
            display.style.display = 'none';
            input.style.display = 'block';
            input.focus();
        }
    }
    
    async function loadChannelSettings() {
        const isGlobal = (currentChannelId === 'global' || currentChannelId == 1);
        
        // --- UI ELEMENTS ---
        const saveBtn = document.querySelector('button[onclick="saveChannelSettings()"]');
        const deleteBtn = document.querySelector('button[onclick="deleteChannel()"]');
        const leaveBtn = document.querySelector('button[onclick="leaveChannel()"]');
        const renameBtn = document.querySelector('button[onclick="editChannelName()"]');
        const photoBtn = document.querySelector('button[onclick="document.getElementById(\'groupPhotoInput\').click()"]');
        const typeSelect = document.getElementById('chatTypeSelect');
        const themeOptions = document.querySelectorAll('.theme-option');
        
        // Helper to Lock/Unlock UI
        function setSettingsReadOnly(locked) {
            if(saveBtn) {
                 saveBtn.style.display = locked ? 'none' : 'block';
                 saveBtn.innerText = 'Save Changes'; // Reset text
            }
            if(deleteBtn) deleteBtn.style.display = locked ? 'none' : 'block';
            if(renameBtn) renameBtn.disabled = locked;
            if(photoBtn) { photoBtn.disabled = locked; photoBtn.innerText = locked ? "Locked" : "Change Photo"; }
            if(typeSelect) typeSelect.disabled = locked;
            themeOptions.forEach(opt => opt.style.pointerEvents = locked ? 'none' : 'auto');
        }

        // 1. Initial State (Locked by default to prevent flicker)
        setSettingsReadOnly(true);

        // --- P2P PERSONAL CHAT RESTRICTION ---
        if (window.currentChatType === 'personal') {
            // Hide Add Member Button
            const addBtn = document.querySelector('button[onclick="showAddMemberModal()"]');
            if(addBtn) addBtn.style.display = 'none';

            // Hide Owner Name/Topic Section
            const nameEl = document.getElementById('settingsName');
            if(nameEl) {
                const section = nameEl.closest('.settings-section');
                if(section) section.style.display = 'none';
            }

            // Hide Photo Section
            const photoPreview = document.getElementById('groupPhotoPreview');
            if(photoPreview) {
                const section = photoPreview.closest('.settings-section');
                if(section) section.style.display = 'none';
            }
            
            // INJECT P2P PROFILE HEADER
            let p2pHeader = document.getElementById('p2pSettingsHeader');
            if(!p2pHeader) {
                p2pHeader = document.createElement('div');
                p2pHeader.id = 'p2pSettingsHeader';
                p2pHeader.className = 'settings-section';
                p2pHeader.style.textAlign = 'center';
                p2pHeader.style.marginBottom = '20px';
                
                // Insert after the header
                const panelHeader = document.querySelector('#chatSettingsPanel .settings-header');
                if(panelHeader) panelHeader.insertAdjacentElement('afterend', p2pHeader);
            }
            
            // Populate content from Active Chat Bar
            const currentImg = document.getElementById('activeChatIcon').innerHTML; // Has the img tag or emoji
            // Extract src from img tag if possible, or just use innerHTML
            const currentName = document.getElementById('activeChatName').innerText.split('#')[0].trim();
            const currentId = document.getElementById('activeChatName').innerText.split('#')[1] || '';
            
            p2pHeader.innerHTML = `
                <div style="width:80px; height:80px; border-radius:24px; margin:0 auto 12px auto; overflow:hidden; display:flex; align-items:center; justify-content:center; background:var(--primary-gradient); font-size:2.5rem;">
                    ${currentImg.replace('width:100%', 'width:100%').replace('height:100%', 'height:100%')} 
                </div>
                <h3 style="margin:0; font-weight:700;">${currentName}</h3>
                <div style="font-size:0.8rem; opacity:0.6;">#${currentId}</div>
                <div style="font-size:0.75rem; color:var(--accent); margin-top:4px;">Peer-to-Peer</div>
            `;
            p2pHeader.style.display = 'block';

            // UNLOCK THEMES for P2P
            themeOptions.forEach(opt => opt.style.pointerEvents = 'auto');
            
            // Set Owner Name (Partner Name) - technically hidden but keeps logic safe
            const ownerEl = document.getElementById('settingsOwnerName');
            // We need to fetch settings to get the name, but UI is locked.
            // Let's scroll down to fetch...
            // Allow photo change? Maybe not for P2P (usually shows user avatar). Let's lock it.
            if(photoBtn) { photoBtn.style.display = 'none'; }
            // SHOW SAVE BUTTON FOR THEME
            if(saveBtn) { 
                saveBtn.style.display = 'block'; 
                saveBtn.innerText = 'Save Theme';
                saveBtn.disabled = false;
            }
            if(deleteBtn) deleteBtn.style.display = 'none'; // Cannot delete P2P history usually, or maybe clear history?
        } else {
             // Reset visibility for groups
             const addBtn = document.querySelector('button[onclick="showAddMemberModal()"]');
             if(addBtn) addBtn.style.display = 'block';
             if(typeSelect && typeSelect.parentElement) typeSelect.parentElement.style.display = 'block';
             if(photoBtn) photoBtn.style.display = 'block';
             
             // Show default sections
             const nameEl = document.getElementById('settingsName');
             if(nameEl && nameEl.closest('.settings-section')) nameEl.closest('.settings-section').style.display = 'block';
             const photoPreview = document.getElementById('groupPhotoPreview');
             if(photoPreview && photoPreview.closest('.settings-section')) photoPreview.closest('.settings-section').style.display = 'block';
             
             // Hide P2P Header
             const p2pHeader = document.getElementById('p2pSettingsHeader');
             if(p2pHeader) p2pHeader.style.display = 'none';
        }

        // 2. Global Channel Logic
        if(isGlobal) {
            // Unlocked only for Global Admins
            if (userRole === 'admin') setSettingsReadOnly(false);
            
            // Global defaults
            if(typeSelect) typeSelect.value = 'public';
             try {
                const res = await fetch(`/chat/channels/1/settings`);
                const data = await res.json();
                if(data.success) {
                     if(data.icon) {
                         document.getElementById('groupPhotoPreview').src = `/static/${data.icon}`;
                     }
                     // Populate Name and Topic for Global too
                     const nameEl = document.getElementById('settingsName');
                     if(nameEl) nameEl.innerText = data.name || 'Global Community';
                     
                     const topicEl = document.getElementById('settingsTopic');
                     if(topicEl) topicEl.innerText = data.topic || 'Welcome to the community!';
                     
                     const ownerEl = document.getElementById('settingsOwnerName');
                     if(ownerEl) ownerEl.innerText = data.owner_name || 'System';
                }
             } catch(e) {}
            return;
        }
        
        // 3. Private Group Logic
        try {
            const res = await fetch(`/chat/channels/${currentChannelId}/settings`);
            const data = await res.json();
            
            if(data.success) {
                // Determine Access
                const isGroupAdmin = (data.user_role === 'admin') || (data.owner_name === '{{ session.get("name") }}'); // Fallback
                
                // CRITICAL: Do NOT re-lock settings for P2P chats (they were already configured above)
                if (window.currentChatType !== 'personal') {
                    setSettingsReadOnly(!isGroupAdmin);
                    
                    // Enable topic editing for admins
                    canEditTopic = isGroupAdmin;
                    const topicDisplay = document.getElementById('settingsTopic');
                    if(topicDisplay) topicDisplay.style.cursor = isGroupAdmin ? 'pointer' : 'default';
                }

                // Set chat type dropdown
                if(typeSelect) {
                    if(data.is_private) typeSelect.value = 'private';
                    else typeSelect.value = 'public';
                }
                
                // --- Populate Group Header (Name, Topic, Admin) for Public/Private ---
                if (window.currentChatType !== 'personal') {
                    const nameEl = document.getElementById('settingsName');
                    if(nameEl) nameEl.innerText = data.name || 'Unnamed Group';
                    
                    const topicEl = document.getElementById('settingsTopic');
                    if(topicEl) topicEl.innerText = data.topic || 'No topic set';
                }
                
                // Set Owner Name
                const ownerEl = document.getElementById('settingsOwnerName');
                if(ownerEl) ownerEl.innerText = data.owner_name || 'System';
                
                // Set group photo if exists
                if(data.icon) {
                    document.getElementById('groupPhotoPreview').src = `/static/${data.icon}`;
                }
            }
        } catch(e) {
            console.log('Could not load channel settings');
        }
    }
    
    async function saveChannelSettings() {
        if(!currentChannelId || currentChannelId === 'global') {
            alert('Cannot modify global channel');
            return;
        }
        
        const chatType = document.getElementById('chatTypeSelect').value;
        const photoInput = document.getElementById('groupPhotoInput');
        
        // Create FormData for potential file upload
        const formData = new FormData();
        
        if (window.currentChatType === 'personal') {
             // For P2P, we only care about Theme (and maybe photo if allowed later)
             // We do NOT want to change type or public/private status
             // We send current values just to be safe, or backend ignores.
             formData.append('type', 'personal');
             // Theme is appended later below
        } else {
             formData.append('is_private', chatType === 'private');
             formData.append('type', chatType);
             
             // Add topic if input is visible (admin was editing)
             const topicInput = document.getElementById('settingsTopicInput');
             if(topicInput && topicInput.style.display !== 'none') {
                 formData.append('topic', topicInput.value);
             }
        }
        
        if(photoInput.files[0]) {
            formData.append('icon', photoInput.files[0]);
        }
        
        try {
            const res = await fetch(`/chat/channels/${currentChannelId}/settings`, {
                method: 'POST',
                body: formData
            });
            
            const data = await res.json();
            if(data.success) {
                alert('‚úÖ Settings saved!');
                
                // If a new icon was uploaded, update header icon immediately
                if(data.icon) {
                    const iconEl = document.getElementById('activeChatIcon');
                    iconEl.innerHTML = `<img src="/static/${data.icon}" style="width:100%; height:100%; object-fit:cover; border-radius:12px;">`;
                }
                
                toggleSettingsPanel();
                fetchConversations(); // Refresh sidebar to show new icon
            } else {
                alert('‚ùå Error: ' + (data.error || 'Unknown error'));
            }
        } catch(e) {
            alert('‚ùå Failed to save settings');
            console.error(e);
        }
    }
    
    // Apply saved theme on load
    document.addEventListener('DOMContentLoaded', () => {
        setTheme(currentTheme);
    });
    
    async function leaveChannel() {
        if(!currentChannelId || currentChannelId === 'global' || currentChannelId === 1) {
            alert('Cannot leave this channel');
            return;
        }
        
        if(!confirm('Are you sure you want to leave this channel?')) return;
        
        try {
            const res = await fetch(`/chat/channels/${currentChannelId}/leave`, {
                method: 'POST'
            });
            const data = await res.json();
            
            if(data.success) {
                alert('‚úÖ Left channel successfully');
                toggleSettingsPanel();
                fetchConversations();
                // Switch to global
                loadConversation(1, 'Global Community');
            } else {
                alert('‚ùå ' + (data.error || 'Failed to leave'));
            }
        } catch(e) {
            alert('‚ùå Error leaving channel');
            console.error(e);
        }
    }
    
    async function deleteChannel() {
        if(!currentChannelId || currentChannelId === 'global' || currentChannelId === 1) {
            alert('Cannot delete this channel');
            return;
        }
        
        if(!confirm('‚ö†Ô∏è Are you sure you want to DELETE this channel? This action cannot be undone!')) return;
        if(!confirm('This will delete ALL messages. Type "DELETE" to confirm.')) return;
        
        try {
            const res = await fetch(`/chat/channels/${currentChannelId}`, {
                method: 'DELETE'
            });
            const data = await res.json();
            
            if(data.success) {
                alert('‚úÖ Channel deleted');
                toggleSettingsPanel();
                fetchConversations();
                loadConversation(1, 'Global Community');
            } else {
                alert('‚ùå ' + (data.error || 'Failed to delete'));
            }
        } catch(e) {
            alert('‚ùå Error deleting channel');
            console.error(e);
        }
    }
    
    async function submitCreateChannel() {
        const name = document.getElementById('newGroupName').value.trim();
        const privacy = document.getElementById('groupPrivacy').value;
        if(!name) return;

        const res = await fetch('/chat/channels', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                type: 'text',
                is_private: (privacy === 'private')
            })
        });
        const data = await res.json();
        if(data.success) {
            createGroupModal.hide();
            // Refresh list or just select
            loadConversation(data.channel_id, name);
            // Optionally reload whole list if it was a public one
        }
    }

    async function searchUsers() {
        const query = document.getElementById('userSearchInput').value.trim();
        if(query.length < 2) return;

        // FIXED: Encode query to handle '#' character correctly
        const res = await fetch(`/member/search_users_json?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        const results = document.getElementById('userSearchResults');
        results.innerHTML = '';

        if(data.users) {
            data.users.forEach(u => {
                // if(u.user_id == myId) return; // Allow showing self for verification
                const div = document.createElement('div');
                div.className = 'chat-item';
                div.style.background = 'rgba(255,255,255,0.05)';
                
                let actionBtn = '';
                if(u.user_id == myId) {
                    actionBtn = `<span class="badge bg-secondary">You</span>`;
                } else {
                    if (window.inviteMode === 'group') {
                         actionBtn = `<button class="btn btn-sm btn-primary" style="height:fit-content; border-radius:10px; font-size:0.7rem;" onclick="sendInvite(${u.user_id}, 'GROUP', ${window.inviteTargetChannelId})">Invite</button>`;
                    } else {
                         actionBtn = `<button class="btn btn-sm btn-primary" style="height:fit-content; border-radius:10px; font-size:0.7rem;" onclick="sendInvite(${u.user_id}, 'DM')">Connect</button>`;
                    }
                }

                div.innerHTML = `
                    <img src="/static/${u.profile_pic || 'default.jpg'}" class="chat-avatar">
                    <div class="chat-info">
                        <div class="chat-name">${u.name} <span style="font-size: 0.65rem; opacity: 0.5; font-weight: 400;">${formatPublicId(u.user_id)}</span></div>
                        <div class="chat-preview">${u.role}</div>
                    </div>
                    ${actionBtn}
                `;
                results.appendChild(div);
            });
        }
    }

    async function sendInvite(targetId, type, channelId = null) {
        const res = await fetch('/chat/invites/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                target_user_id: targetId,
                target_channel_id: channelId,
                type: type
            })
        });
        const data = await res.json();
        if(data.success) {
            alert("Request sent successfully!");
        }
    }

    async function joinChannelById() {
        const publicId = document.getElementById('joinGroupId').value.trim().replace('#', '');
        if(!publicId || isNaN(publicId)) return;
        
        // Convert back to DB ID
        const dbId = parseInt(publicId) - PUBLIC_ID_OFFSET;
        
        const res = await fetch(`/chat/join/${dbId}`, { method: 'POST' });
        const data = await res.json();
        if(data.success) {
            forceCloseModals();
            loadConversation(dbId);
            // Optionally reload sidebar
        } else {
            alert(data.message || "Could not join group.");
        }
    }

    async function fetchPendingInvites() {
        const res = await fetch('/chat/invites/pending');
        const data = await res.json();
        const section = document.getElementById('pendingInvitesSection');
        const list = document.getElementById('pendingInvitesList');
        
        if(data.success && data.invites.length > 0) {
            section.style.display = 'block';
            list.innerHTML = '';
            data.invites.forEach(inv => {
                const div = document.createElement('div');
                div.className = 'chat-item';
                div.style.background = 'rgba(255,255,255,0.05)';
                let subtitle = inv.type === 'DM' ? 'Wants to chat' : `Joins ${inv.channel_name || 'Group'}`;
                div.innerHTML = `
                    <img src="/static/${inv.sender_pic || 'default.jpg'}" class="chat-avatar">
                    <div class="chat-info">
                        <div class="chat-name">${inv.sender_name}</div>
                        <div class="chat-preview">${subtitle}</div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-sm btn-success" style="border-radius:10px;" onclick="handleInvite('${inv.invite_id}', 'accept')">‚úì</button>
                        <button class="btn btn-sm btn-danger" style="border-radius:10px;" onclick="handleInvite('${inv.invite_id}', 'reject')">‚úï</button>
                    </div>
                `;
                list.appendChild(div);
            });
        } else {
            section.style.display = 'none';
        }
    }

    async function handleInvite(inviteId, action) {
        const res = await fetch('/chat/invites/handle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ invite_id: inviteId, action: action })
        });
        const data = await res.json();
        if(data.success) {
            fetchPendingInvites();
            if(action === 'accept') {
                fetchConversations();
                if(data.channel_id) loadConversation(data.channel_id);
            }
        }
    }

    async function deleteCurrentChannel() {
        if(currentChannelId === 1) return alert("Cannot delete Global Hub");
        if(!confirm("Are you sure you want to delete this group?")) return;

        // Note: Need a route for this too. 
        // For now, let's assume it's implemented.
        const res = await fetch(`/chat/channels/${currentChannelId}`, { method: 'DELETE' });
        if(res.ok) {
            settingsModal.hide();
            loadConversation('global');
            fetchConversations();
        }
    }

    async function editChannelName() {
        const newName = prompt("Enter new name:");
        if(!newName) return;
        const res = await fetch(`/chat/channels/${currentChannelId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: newName})
        });
        if(res.ok) {
            document.getElementById('activeChatName').innerText = newName;
            fetchConversations();
        }
    }

    // --- NEW FEATURES IMPLEMENTATION ---

    // 1. Invitations Logic
    async function fetchPendingInvites() {
        console.log("Fetching pending invites...");
        try {
            const res = await fetch('/chat/invites/pending');
            const data = await res.json();
            const list = document.getElementById('pendingInvitesList');
            const badge = document.getElementById('requestsBadge');
            const noMsg = document.getElementById('noInvitesMsg');
            
            if(!list) return; // Guard
            list.innerHTML = '';
            
            if(data.success && data.invites && data.invites.length > 0) {
                badge.style.display = 'inline-block';
                badge.innerText = data.invites.length;
                if(noMsg) noMsg.style.display = 'none';
                
                data.invites.forEach(inv => {
                    const isGroup = (inv.type === 'GROUP');
                    const subtitle = isGroup ? `Group Invite: ${inv.channel_name}` : 'Friend Request';
                    const div = document.createElement('div');
                    div.className = 'd-flex align-items-center justify-content-between p-2 mb-2';
                    div.style.background = 'rgba(255,255,255,0.05)';
                    div.style.borderRadius = '12px';
                    div.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                             <div style="width:32px; height:32px; background:#6366f1; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white;">${inv.sender_name ? inv.sender_name[0] : '?'}</div>
                             <div>
                                 <div style="font-weight:bold; font-size:0.9rem; color:white;">${inv.sender_name}</div>
                                 <div style="font-size:0.75rem; opacity:0.7; color:#cbd5e1;">${subtitle}</div>
                             </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-success" onclick="handleInvite('${inv.invite_id}', 'accept')">‚úì</button>
                            <button class="btn btn-sm btn-danger" onclick="handleInvite('${inv.invite_id}', 'reject')">‚úï</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } else {
                badge.style.display = 'none';
                if(noMsg) noMsg.style.display = 'block';
            }
        } catch(e) { console.error("Error fetching invites:", e); }
    }

    function showNewChatModal() {
        // Reset to DM Mode
        window.inviteMode = 'dm';
        window.inviteTargetChannelId = null;
        const title = document.querySelector('#newChatModal .modal-title');
        if(title) title.innerText = "Connections Hub";

        fetchPendingInvites();
        newChatModal.show();
    }

    // --- Message Actions Logic ---

    // 1. Context Menu
    let ctxMessageId = null;
    let ctxContent = null;
    let ctxIsMe = false;

    document.getElementById('messageArea').addEventListener('contextmenu', function(e) {
        let target = e.target.closest('.msg-bubble');
        if(!target) return;
        
        e.preventDefault();
        ctxMessageId = target.dataset.mid;
        // Select content securely
        const contentEl = target.querySelector('.msg-content');
        ctxContent = contentEl ? contentEl.innerText : target.children[target.children.length-2].innerText; // Fallback
        ctxIsMe = target.classList.contains('msg-me');
        
        // Show menu at mouse position
        const menu = document.getElementById('msgContextMenu');
        console.log("üñ±Ô∏è Opening Context Menu at", e.clientX, e.clientY);
        
        menu.style.display = 'block';
        menu.style.left = e.clientX + 'px';
        menu.style.top = e.clientY + 'px';
        menu.style.zIndex = '20000'; // Ensure it's on top of everything
        
        document.querySelectorAll('.owner-only').forEach(el => {
            el.style.display = ctxIsMe ? 'flex' : 'none';
        });
    });

    document.addEventListener('click', () => {
        const menu = document.getElementById('msgContextMenu');
        if(menu) menu.style.display = 'none';
    });

    function ctxCopy() {
        navigator.clipboard.writeText(ctxContent);
        // Toast/Alert replacement could go here
    }

    async function ctxDelete() {
        if(!confirm("Delete this message?")) return;
        socket.emit('delete_message', {
            channel_id: currentChannelId,
            message_id: ctxMessageId
        });
    }

    // Edit State
    let isEditing = false;
    let editingMessageId = null;

    function ctxEdit() {
        isEditing = true;
        editingMessageId = ctxMessageId;
        
        const inp = document.getElementById('messageInput');
        inp.value = ctxContent;
        inp.focus();

        // Show Edit Banner
        let banner = document.getElementById('editContextBanner');
        if(!banner) {
            banner = document.createElement('div');
            banner.id = 'editContextBanner';
            banner.style.padding = '8px';
            banner.style.background = 'rgba(255,255,255,0.1)';
            banner.style.borderLeft = '3px solid #facc15'; // Yellow for edit
            banner.style.fontSize = '0.8rem';
            banner.style.marginBottom = '8px';
            
            // Insert before input wrapper (inside input-area)
            // Fix: The class is .input-area, but we want to insert inside it, before .glass-input-wrapper
            const container = document.querySelector('.input-area');
            const wrapper = document.querySelector('.glass-input-wrapper');
            container.insertBefore(banner, wrapper);
        }
        
        banner.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span class="text-warning fw-bold">‚úèÔ∏è Editing Message</span>
                <button onclick="cancelEdit()" style="background:none; border:None; color:inherit;">‚úï</button>
            </div>
            <div style="opacity:0.7; font-style:italic;">${ctxContent.substring(0,50)}...</div>
        `;
        
        // Change send button icon to checkmark temporarily
        document.getElementById('sendBtn').innerHTML = '‚úì';
    }

    function cancelEdit() {
        isEditing = false;
        editingMessageId = null;
        document.getElementById('messageInput').value = '';
        const banner = document.getElementById('editContextBanner');
        if(banner) banner.remove();
        document.getElementById('sendBtn').innerHTML = '‚û§';
    }

    function ctxReply() {
        // Fix: Use correct selector for banner insertion
        // We want to insert it inside .input-area, before .glass-input-wrapper
        const container = document.querySelector('.input-area');
        const wrapper = document.querySelector('.glass-input-wrapper');
        
        let banner = document.getElementById('replyContextBanner');
        if(!banner) {
            banner = document.createElement('div');
            banner.id = 'replyContextBanner';
            banner.style.padding = '8px';
            banner.style.background = 'rgba(255,255,255,0.1)';
            banner.style.borderLeft = '3px solid var(--primary)';
            banner.style.fontSize = '0.8rem';
            banner.style.marginBottom = '8px';
            container.insertBefore(banner, wrapper);
        }
        
        banner.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <span>Replying to <span style="font-weight:bold;">Example User</span></span>
                <button onclick="cancelReply()" style="background:none; border:None; color:inherit;">‚úï</button>
            </div>
            <div style="opacity:0.7;">${ctxContent.substring(0,50)}...</div>
        `;
        
        // Store ID on banner dataset
        banner.dataset.mid = ctxMessageId;
        document.getElementById('messageInput').focus();
    }

    // --- Restored Logic (Typing, Updates, Files) ---

    // 3. Typing Indicator
    let typingTimer;
    document.getElementById('messageInput').addEventListener('input', () => {
        socket.emit('typing', { channel_id: String(currentChannelId) });
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
             socket.emit('stop_typing', { channel_id: String(currentChannelId) });
        }, 1000);
    });

    socket.on('typing', (data) => {
        const header = document.getElementById('activeChatStatus');
        header.dataset.original = header.dataset.original || header.innerText;
        header.innerText = `${data.user} is typing...`;
        header.style.color = '#4ade80';
    });

    socket.on('stop_typing', () => {
        const header = document.getElementById('activeChatStatus');
        if(header.dataset.original) {
             header.innerText = header.dataset.original;
             header.style.color = '';
        }
    });

    socket.on('message_deleted', (data) => {
        const el = document.querySelector(`.msg-bubble[data-mid="${data.message_id}"]`);
        if(el) {
            el.innerHTML = '<div style="opacity:0.6; font-style:italic; color:#9ca3af;">üö´ This message was deleted</div>';
        }
    });

    socket.on('message_updated', (data) => {
        const el = document.querySelector(`.msg-bubble[data-mid="${data.message_id}"]`);
        if(el) {
             const contentDiv = el.querySelector('.msg-content');
             // If not found (legacy messages), try children approx
             const target = contentDiv || el.children[1]; 
             if(target) {
                 target.innerText = data.new_content + ' (edited)';
                 // Highlight change
                 target.style.transition = 'color 0.5s';
                 const oldColor = target.style.color;
                 target.style.color = '#facc15'; // yellow highlight
                 setTimeout(() => target.style.color = oldColor, 1000);
             }
        }
    });

    // 4. File Upload
    let currentAttachment = null; 

    async function handleFileUpload(input) {
        if(!input.files || input.files.length === 0) return;
        const file = input.files[0];
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const res = await fetch('/chat/upload', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if(data.success) {
                currentAttachment = {
                    url: data.file_path,
                    type: data.type,
                    name: data.filename
                };
                
                // Show Banner instead of appending text
                let banner = document.getElementById('attachmentPreviewBanner');
                if(!banner) {
                    banner = document.createElement('div');
                    banner.id = 'attachmentPreviewBanner';
                    banner.style.padding = '8px';
                    banner.style.background = 'rgba(255,255,255,0.1)';
                    banner.style.borderLeft = '3px solid var(--success)';
                    banner.style.fontSize = '0.8rem';
                    banner.style.marginBottom = '8px';
                    
                    // Insert before input wrapper
                    const area = document.querySelector('.input-area');
                    area.insertBefore(banner, area.firstChild);
                }
                
                banner.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="display:flex; align-items:center; gap:6px;">
                            <i class="fas fa-paperclip"></i> 
                            ${data.filename}
                        </span>
                        <button onclick="cancelAttachment()" style="background:none; border:None; color:inherit;">‚úï</button>
                    </div>
                `;
                
                document.getElementById('messageInput').focus();
            } else {
                console.error("Upload failed:", data);
                alert("Upload failed: " + (data.error || "Unknown server error"));
            }
        } catch (err) {
            console.error("Upload Exception:", err);
            alert("Upload error: " + err.message);
        }
    }

    function switchGroupModalTab(tab) {
        // Toggle Tabs
        document.querySelectorAll('.tab-pill').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-pill-${tab}`).classList.add('active');
        
        // Toggle Views
        if(tab === 'create') {
            document.getElementById('view-create').style.display = 'block';
            document.getElementById('view-join').style.display = 'none';
        } else {
            document.getElementById('view-create').style.display = 'none';
            document.getElementById('view-join').style.display = 'block';
        }
    }
    function switchConnectionsTab(tab) {
        // Toggle Tabs
        document.querySelectorAll('#newChatModal .tab-pill').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-pill-${tab}`).classList.add('active');

        // Toggle Views
        if(tab === 'find') {
            document.getElementById('view-find').style.display = 'block';
            document.getElementById('view-requests').style.display = 'none';
        } else {
            document.getElementById('view-find').style.display = 'none';
            document.getElementById('view-requests').style.display = 'block';
            // Refresh invites when switching to tab
            fetchPendingInvites();
        }
    }
    
    // --- Logs & Rules Logic ---
    async function showLogsModal() {
        logsModal.show();
        const list = document.getElementById('logsList');
        list.innerHTML = '<div class="text-center text-muted">Loading logs...</div>';
        
        try {
            const res = await fetch(`/chat/channels/${currentChannelId}/logs`);
            const data = await res.json();
            
            if(data.success) {
                if(!data.logs || data.logs.length === 0) {
                    list.innerHTML = '<div class="text-center text-muted">No logs found.</div>';
                    return;
                }
                
                list.innerHTML = '';
                data.logs.forEach(log => {
                    const div = document.createElement('div');
                    div.style.padding = '10px';
                    div.style.background = 'rgba(255,255,255,0.05)';
                    div.style.borderRadius = '8px';
                    div.style.fontSize = '0.85rem';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                            <span style="font-weight:bold; color:#a855f7;">${log.action_type}</span>
                            <span style="color:var(--text-muted); font-size:0.75rem;">${new Date(log.created_at).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom:4px;">${log.details || 'No details'}</div>
                        <div style="font-size:0.75rem; color:var(--text-muted);">By: ${log.user_name} (${log.user_role})</div>
                    `;
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = `<div class="text-center text-danger">${data.error || 'Access Denied'}</div>`;
            }
        } catch(e) {
            list.innerHTML = '<div class="text-center text-danger">Failed to fetch logs.</div>';
        }
    }

    async function showRulesModal() {
        rulesModal.show();
        const textarea = document.getElementById('rulesText');
        const saveBtn = document.getElementById('rulesSaveBtnContainer');
        textarea.value = 'Loading...';
        textarea.readOnly = true; // Default to read-only
        saveBtn.style.display = 'none';
        
        try {
            const res = await fetch(`/chat/channels/${currentChannelId}/rules`);
            const data = await res.json();
            
            if(data.success) {
                textarea.value = data.rules;
                
                if(data.can_edit) {
                    textarea.readOnly = false;
                    saveBtn.style.display = 'block';
                }
            } else {
                textarea.value = 'Error loading rules.';
            }
        } catch(e) {
            textarea.value = 'Failed to fetch rules.';
        }
    }
    
    async function saveRules() {
        const rules = document.getElementById('rulesText').value;
        try {
            const res = await fetch(`/chat/channels/${currentChannelId}/rules`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rules: rules})
            });
            const data = await res.json();
            if(data.success) {
                alert('‚úÖ Rules saved!');
                rulesModal.hide();
            } else {
                alert('‚ùå ' + (data.error || 'Failed to save rules'));
            }
        } catch(e) {
            alert('Error saving rules');
        }
    }

    // --- EMOJI PICKER LOGIC ---
    const emojiList = [
        // Smileys & People
        "üòÄ", "üòÉ", "üòÑ", "üòÅ", "üòÜ", "üòÖ", "üòÇ", "ü§£", "ü•≤", "üòä", "üòá", "üôÇ", "üôÉ", "üòâ", "üòå",
        "üòç", "ü•∞", "üòò", "üòó", "üòô", "üòö", "üòã", "üòõ", "üòù", "üòú", "ü§™", "ü§®", "üßê", "ü§ì", "üòé",
        "ü•∏", "ü§©", "ü•≥", "üòè", "üòí", "üòû", "üòî", "üòü", "üòï", "üôÅ", "‚òπÔ∏è", "üò£", "üòñ", "üò´", "üò©",
        "ü•∫", "üò¢", "üò≠", "üò§", "üò†", "üò°", "ü§¨", "ü§Ø", "üò≥", "ü•µ", "ü•∂", "üò±", "üò®", "üò∞", "üò•",
        "üòì", "ü§ó", "ü§î", "ü§≠", "ü§´", "ü§•", "üò∂", "üòê", "üòë", "üò¨", "üôÑ", "üòØ", "üò¶", "üòß", "üòÆ",
        "üò≤", "ü•±", "üò¥", "ü§§", "üò™", "üòµ", "ü§ê", "ü•¥", "ü§¢", "ü§Æ", "ü§ß", "üò∑", "ü§í", "ü§ï", "ü§ë",
        "ü§†", "üòà", "üëø", "üëπ", "üë∫", "ü§°", "üí©", "üëª", "üíÄ", "‚ò†Ô∏è", "üëΩ", "üëæ", "ü§ñ", "üéÉ",
        
        // Hands & Body
        "üëã", "ü§ö", "üñêÔ∏è", "‚úã", "üññ", "üëå", "ü§å", "ü§è", "‚úåÔ∏è", "ü§û", "ü§ü", "ü§ò", "ü§ô", "üëà", "üëâ",
        "üëÜ", "üñï", "üëá", "‚òùÔ∏è", "üëç", "üëé", "‚úä", "üëä", "ü§õ", "ü§ú", "üëè", "üôå", "üëê", "ü§≤", "ü§ù",
        "üôè", "‚úçÔ∏è", "üíÖ", "ü§≥", "üí™", "ü¶æ", "ü¶µ", "ü¶ø", "ü¶∂", "üë£", "üëÄ", "üëÅÔ∏è", "üß†", "üíã", "üëÑ",
        
        // Hearts & Symbols
        "‚ù§Ô∏è", "üß°", "üíõ", "üíö", "üíô", "üíú", "üñ§", "ü§ç", "ü§é", "üíî", "‚ù£Ô∏è", "üíï", "üíû", "üíì", "üíó",
        "üíñ", "üíò", "üíù", "üíü", "‚òÆÔ∏è", "‚úùÔ∏è", "‚ò™Ô∏è", "üïâÔ∏è", "‚ò∏Ô∏è", "‚ú°Ô∏è", "üîØ", "üïé", "‚òØÔ∏è", "‚ò¶Ô∏è", "üõê",
        "‚ú®", "üåü", "üí´", "üî•", "üí•", "üíØ", "üí¢", "üí¶", "üí®", "üï≥Ô∏è", "üí£", "üí¨", "üëÅÔ∏è‚Äçüó®Ô∏è", "üó®Ô∏è",
        
        // Animals & Nature
        "üêµ", "üêí", "ü¶ç", "ü¶ß", "üê∂", "üêï", "ü¶Æ", "üê©", "üê∫", "ü¶ä", "ü¶ù", "üê±", "üêà", "ü¶Å", "üêØ",
        "üêÖ", "üêÜ", "üê¥", "üêé", "ü¶Ñ", "ü¶ì", "ü¶å", "üêÆ", "ox", "üêÉ", "üêÑ", "üê∑", "üêñ", "üêó", "üêΩ",
        "üêè", "üêë", "üêê", "üê™", "üê´", "ü¶ô", "ü¶í", "üêò", "ü¶£", "ü¶è", "ü¶õ", "üê≠", "üêÅ", "üêÄ", "üêπ",
        "üê∞", "üêá", "üêøÔ∏è", "ü¶´", "ü¶î", "ü¶á", "üêª", "üê®", "üêº", "ü¶•", "ü¶¶", "ü¶®", "ü¶ò", "ü¶°", "üêæ",
        "ü¶É", "üêî", "üêì", "üê£", "üê§", "üê•", "üê¶", "üêß", "üïäÔ∏è", "ü¶Ö", "ü¶Ü", "ü¶¢", "ü¶â", "ü¶§", "ü™∂",
        "ü¶©", "ü¶ö", "ü¶ú", "üê∏", "üêä", "üê¢", "ü¶é", "üêç", "üê≤", "üêâ", "ü¶ï", "ü¶ñ", "üê≥", "üêã", "üê¨",
        "ü¶≠", "üêü", "üê†", "üê°", "ü¶à", "üêô", "üêö", "üêå", "ü¶ã", "üêõ", "üêú", "üêù", "ü™≤", "üêû", "ü¶ó",
        "üíê", "üå∏", "üíÆ", "üèµÔ∏è", "üåπ", "ü•Ä", "üå∫", "üåª", "üåº", "üå∑", "üå±", "ü™¥", "üå≤", "üå≥", "üå¥",
        "üåµ", "üåæ", "üåø", "‚òòÔ∏è", "üçÄ", "üçÅ", "üçÇ", "üçÉ",
        
        // Food & Drink
        "üçá", "üçà", "üçâ", "üçä", "üçã", "üçå", "üçç", "ü•≠", "üçé", "üçè", "üçê", "üçë", "üçí", "üçì", "ü´ê",
        "ü•ù", "üçÖ", "ü´í", "ü••", "ü•ë", "üçÜ", "ü•î", "ü•ï", "üåΩ", "üå∂Ô∏è", "ü´ë", "ü•í", "ü•¨", "ü•¶", "üßÑ",
        "üßÖ", "üçÑ", "ü•ú", "üå∞", "üçû", "ü•ê", "ü•ñ", "ü´ì", "ü•®", "ü•Ø", "ü•û", "üßá", "üßÄ", "üçñ", "üçó",
        "ü•©", "ü•ì", "üçî", "üçü", "üçï", "üå≠", "ü•™", "üåÆ", "üåØ", "ü´î", "ü•ô", "üßÜ", "ü•ö", "üç≥", "ü•ò",
        "üç≤", "ü´ï", "ü•£", "ü•ó", "üçø", "üßà", "üßÇ", "ü•´", "üç±", "üçò", "üçô", "üçö", "üçõ", "üçú", "üçù",
        "üç†", "üç¢", "üç£", "üç§", "üç•", "ü•Æ", "üç°", "ü•ü", "ü•†", "ü•°", "ü¶Ä", "ü¶û", "ü¶ê", "ü¶ë", "ü¶™",
        "üç¶", "üçß", "üç®", "üç©", "üç™", "üéÇ", "üç∞", "üßÅ", "ü•ß", "üç´", "üç¨", "üç≠", "üçÆ", "üçØ", "üçº",
        "ü•õ", "‚òï", "ü´ñ", "üçµ", "üç∂", "üçæ", "üç∑", "üç∏", "üçπ", "üç∫", "üçª", "ü•Ç", "ü•É", "ü•§", "üßã",
        "üßÉ", "üßâ", "üßä", "ü•¢", "üçΩÔ∏è", "üç¥", "ü•Ñ", "üî™", "üè∫"
    ];

    function toggleEmojiPicker() {
        const picker = document.getElementById('emojiPicker');
        if (!picker) return;
        
        if (picker.style.display === 'none') {
            picker.style.display = 'grid';
            if (picker.children.length === 0) {
                // Populate if empty
                picker.innerHTML = ''; // Clear comments
                emojiList.forEach(emoji => {
                    const span = document.createElement('span');
                    span.innerText = emoji;
                    span.style.cursor = 'pointer';
                    span.style.fontSize = '1.3rem';
                    span.style.padding = '8px';
                    span.style.borderRadius = '5px';
                    span.style.textAlign = 'center';
                    span.style.transition = 'background 0.2s';
                    span.onmouseover = () => span.style.background = 'rgba(255,255,255,0.1)';
                    span.onmouseout = () => span.style.background = 'transparent';
                    span.onclick = () => {
                        insertEmoji(emoji);
                        picker.style.display = 'none';
                    };
                    picker.appendChild(span);
                });
            }
        } else {
            picker.style.display = 'none';
        }
    }

    function insertEmoji(emoji) {
        const input = document.getElementById('messageInput');
        if (input) {
            input.value += emoji;
            input.focus();
        }
    }

    // Close picker when clicking outside
    document.addEventListener('click', function(event) {
        const picker = document.getElementById('emojiPicker');
        const btn = document.getElementById('emojiBtn');
        if (picker && picker.style.display !== 'none' && !picker.contains(event.target) && !btn.contains(event.target)) {
            picker.style.display = 'none';
        }
    });
</script>
{% endblock %}

</file>

<file path="templates\member\discovery.html">

{% extends "layout.html" %}

{% block title %}AI Discovery{% endblock %}

{% block header_title %}‚ú® Mood Discovery{% endblock %}
{% block header_subtitle %}Tell me your vibe, and I'll find your next obsession.{% endblock %}

{% block content %}
<section class="dashboard-section" style="max-width: 800px; margin: 0 auto;">
    <div class="glass-card" style="padding: 2.5rem; text-align: center; border: 1px solid rgba(99, 102, 241, 0.3); background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, transparent 100%);">
        <div style="font-size: 3rem; margin-bottom: 1.5rem;">üîÆ</div>
        <h2 style="margin-bottom: 1rem;">What's your reading vibe today?</h2>
        <p style="color: var(--text-sub); margin-bottom: 2rem;">"Something cozy for a rainy day", "A dark and twisted mystery", or "An inspiring tale of perseverance".</p>
        
        <div style="display: flex; gap: 0.75rem; max-width: 600px; margin: 0 auto;">
            <input type="text" id="vibeInput" placeholder="Describe your mood..." 
                   style="flex: 1; padding: 1rem 1.5rem; border-radius: 30px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main); font-size: 1rem; outline: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
            <button id="discoverBtn" class="btn btn-primary" 
                    style="border-radius: 30px; padding: 0 2rem; background: linear-gradient(135deg, #6366f1, #a855f7); border: none; font-weight: 600;">
                Discover
            </button>
        </div>

        <div id="discoveryLoading" style="display: none; margin-top: 2rem;">
            <div class="ai-loading" style="font-style: italic; color: var(--text-sub);">
                ‚ú® Consulting the Vibe Librarian...
            </div>
        </div>

        <div id="discoveryResults" class="glass-card" style="display: none; margin-top: 2rem; padding: 2rem; text-align: left; background: rgba(255,255,255,0.02);">
            <div id="resultsContent" style="line-height: 1.6;"></div>
        </div>
    </div>
</section>

<script>
    const vibeInput = document.getElementById('vibeInput');
    const discoverBtn = document.getElementById('discoverBtn');
    const loading = document.getElementById('discoveryLoading');
    const results = document.getElementById('discoveryResults');
    const content = document.getElementById('resultsContent');

    async function handleDiscovery() {
        const vibe = vibeInput.value.trim();
        if(!vibe) return;

        loading.style.display = 'block';
        results.style.display = 'none';
        discoverBtn.disabled = true;

        try {
            const resp = await fetch('/member/ai/discovery', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ vibe })
            });
            const data = await resp.json();
            
            loading.style.display = 'none';
            discoverBtn.disabled = false;
            results.style.display = 'block';
            
            // Basic markdown handling for the response
            content.innerHTML = data.response.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        } catch (err) {
            loading.style.display = 'none';
            discoverBtn.disabled = false;
            content.innerText = "Error: Could not connect to the Vibe Librarian.";
            results.style.display = 'block';
        }
    }

    discoverBtn.addEventListener('click', handleDiscovery);
    vibeInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleDiscovery(); });
</script>
{% endblock %}

</file>

<file path="templates\member\goals.html">
{% extends "layout.html" %}

{% block title %}My Reading Goals{% endblock %}
{% block header_title %}My Reading Journey{% endblock %}
{% block header_subtitle %}Track your progress, build streaks, and hit your 2026 targets.{% endblock %}

{% block content %}


<!-- HERO SECTION -->
<div class="goal-hero">
    <div style="z-index: 1;">
        <h2 style="margin: 0; font-size: 2rem; font-weight: 800;">{{ reading_goal.year }} Goal</h2>
        <p style="margin: 0.5rem 0 1.5rem; opacity: 0.9;">
            You've read <strong style="font-size: 1.2rem;">{{ reading_goal.current_books }}</strong> of <strong>{{ reading_goal.goal_books }}</strong> books.
        </p>
        
        <form action="/member/goals" method="POST" style="display: flex; gap: 10px; max-width: 300px;">
            <input type="number" name="target" value="{{ reading_goal.goal_books }}" min="1" max="100" 
                   style="padding: 10px; border-radius: 8px; border: none; width: 80px; text-align: center; font-weight: bold;">
            <button type="submit" class="btn" style="background: white; color: #6366f1; font-weight: 700; border: none;">Update Target</button>
        </form>
    </div>
    
    <!-- Progress Circle -->
    {% set progress = (reading_goal.current_books / reading_goal.goal_books * 100) if reading_goal.goal_books > 0 else 0 %}
    {% set progress = progress if progress <= 100 else 100 %}
    <div class="progress-circle-lg">
        <svg width="150" height="150" viewBox="0 0 150 150">
            <circle cx="75" cy="75" r="65" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="12" />
            <circle cx="75" cy="75" r="65" fill="none" stroke="white" stroke-width="12"
                    stroke-dasharray="408" stroke-dashoffset="{{ 408 - (408 * progress / 100) }}"
                    transform="rotate(-90 75 75)" style="transition: stroke-dashoffset 1s ease-in-out;" />
        </svg>
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; font-weight: 800;">
            {{ progress|int }}%
        </div>
    </div>
</div>

<!-- STATS GRID -->
<div class="stats-grid-goals">
    <!-- Streak -->
    <div class="glass-card" style="padding: 1.5rem; text-align: center;">
        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üî•</div>
        <div style="font-size: 2rem; font-weight: 700; color: var(--text-main);">{{ streak }}</div>
        <div style="color: var(--text-sub); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Active Months</div>
    </div>
    
    <!-- Pages -->
    <div class="glass-card" style="padding: 1.5rem; text-align: center;">
        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üìÑ</div>
        <div style="font-size: 2rem; font-weight: 700; color: var(--text-main);">{{ pages_read }}</div>
        <div style="color: var(--text-sub); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Est. Pages Read</div>
    </div>
    
    <!-- Tier -->
    <div class="glass-card" style="padding: 1.5rem; text-align: center;">
        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">
            {% if reading_goal.tier == 'Platinum' %}üíé{% elif reading_goal.tier == 'Gold' %}ü•á{% else %}ü•à{% endif %}
        </div>
        <div style="font-size: 2rem; font-weight: 700; color: var(--text-main);">{{ reading_goal.tier or 'Silver' }}</div>
        <div style="color: var(--text-sub); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Current Tier</div>
    </div>
</div>

<!-- MAIN CONTENT GRID -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    
    <!-- Left: Activity Chart -->
    <section class="glass-card" style="padding: 1.5rem;">
        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-chart-bar" style="color: #6366f1;"></i> Monthly Breakdown
        </h3>
        
        <div class="chart-container">
            {% set max_val = chart_values|max if chart_values|max > 0 else 1 %}
            {% for label in chart_labels %}
                {% set val = chart_values[loop.index0] %}
                {% set height = (val / max_val * 100) %}
                <div class="chart-bar-wrapper">
                    <div class="chart-bar" style="height: {{ height }}%;" data-value="{{ val }}"></div>
                    <span class="chart-label">{{ label }}</span>
                </div>
            {% endfor %}
        </div>
    </section>

    <!-- Right: Privacy Settings -->
    <section class="glass-card" style="padding: 1.5rem;">
        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-user-shield" style="color: #6366f1;"></i> Privacy
        </h3>
        <p style="color: var(--text-sub); font-size: 0.85rem; margin-bottom: 1.5rem;">
            Control who can see your reading activity and goals.
        </p>
        
        <form action="/member/goals" method="POST" id="privacyForm">
            <input type="hidden" name="privacy_update" value="true">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                
                <!-- Toggle Item -->
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">Public Profile</div>
                        <div style="font-size: 0.75rem; color: var(--text-sub);">Visible to everyone</div>
                    </div>
                    <label class="switch" style="position: relative; display: inline-block; width: 44px; height: 22px;">
                        <input type="checkbox" name="is_public" onchange="document.getElementById('privacyForm').submit()" 
                            {% if reading_goal.is_public %}checked{% endif %} style="opacity: 0; width: 0; height: 0;">
                        <span class="slider round"></span>
                    </label>
                </div>
                
                <hr style="border: 0; border-top: 1px solid var(--border); margin: 0;">

                <!-- Toggle Item -->
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">Allow Requests</div>
                        <div style="font-size: 0.75rem; color: var(--text-sub);">Others can add you</div>
                    </div>
                    <label class="switch" style="position: relative; display: inline-block; width: 44px; height: 22px;">
                        <input type="checkbox" name="allow_requests" onchange="document.getElementById('privacyForm').submit()" 
                            {% if reading_goal.allow_requests %}checked{% endif %} style="opacity: 0; width: 0; height: 0;">
                        <span class="slider round"></span>
                    </label>
                </div>

                <hr style="border: 0; border-top: 1px solid var(--border); margin: 0;">

                <!-- Toggle Item -->
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">Show Activity</div>
                        <div style="font-size: 0.75rem; color: var(--text-sub);">Values, badges, reviews</div>
                    </div>
                    <label class="switch" style="position: relative; display: inline-block; width: 44px; height: 22px;">
                        <input type="checkbox" name="show_activity" onchange="document.getElementById('privacyForm').submit()" 
                            {% if reading_goal.show_activity %}checked{% endif %} style="opacity: 0; width: 0; height: 0;">
                        <span class="slider round"></span>
                    </label>
                </div>

            </div>
        </form>
    </section>
</div>

<!-- Switch Styles (if not in main css) -->

{% endblock %}

</file>

<file path="templates\member\overview.html">
{% extends "layout.html" %}

{% block title %}My Dashboard{% endblock %}
{% block header_title %}My Library Overview 
    {% if reading_goal %}
        {% set tier = reading_goal.tier if reading_goal.tier else 'Silver' %}
        
        <!-- Expanding Tier Badge -->
        <div class="expanding-pill tier-pill">
            <div class="pill-badge" style="
                {% if tier == 'Platinum' %}
                    background: linear-gradient(135deg, #e5e7eb, #94a3b8); color: #1e293b; border: 1px solid #cbd5e1;
                {% elif tier == 'Gold' %}
                    background: linear-gradient(135deg, #fde68a, #f59e0b); color: #78350f; border: 1px solid #fbbf24;
                {% else %}
                    background: linear-gradient(135deg, #f3f4f6, #d1d5db); color: #374151; border: 1px solid #9ca3af;
                {% endif %}
            ">
                {% if tier == 'Platinum' %}üíé Platinum{% elif tier == 'Gold' %}ü•á Gold{% else %}ü•à Silver{% endif %}
            </div>
            
            <div class="pill-details">
                {% if tier == 'Platinum' %}
                    <span>üìö 10 Books</span><span class="separator">‚Ä¢</span><span>‚è≥ 30 Days</span>
                {% elif tier == 'Gold' %}
                    <span>üìö 6 Books</span><span class="separator">‚Ä¢</span><span>‚è≥ 21 Days</span>
                {% else %}
                    <span>üìö 3 Books</span><span class="separator">‚Ä¢</span><span>‚è≥ 14 Days</span>
                {% endif %}
            </div>
        </div>
    {% endif %}
    
    {% if game_stats %}
    <!-- Expanding Level Badge -->
    <div class="expanding-pill level-pill" style="margin-left: 8px;">
        <div class="pill-badge" style="background: linear-gradient(135deg, #6366f1, #a855f7); color: white;">
            ‚ú® Level {{ game_stats.level }}
        </div>
        <div class="pill-details">
            {% set total_needed = (game_stats.level * (game_stats.level + 1) / 2) * 100 %}
            {% set prev_level_xp = ((game_stats.level - 1) * game_stats.level / 2) * 100 %}
            {% set next_xp_target = total_needed %}
            
            <span>XP: {{ game_stats.xp }}</span>
            <span class="separator">‚Ä¢</span>
            <span>Next: {{ next_xp_target|int }}</span>
        </div>
    </div>
    {% endif %}
    
    <!-- Expanding Badge CSS -->

{% endblock %}
{% block header_subtitle %}
    Track your active borrowings and membership privileges.
    {% if game_stats %}
    <div style="margin-top: 10px; width: 250px;">
        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 4px;">
            <span>XP: {{ game_stats.xp }}</span>
            <span>Next Level at {{ (game_stats.level * (game_stats.level + 1) / 2) * 100 }} XP</span>
        </div>
        <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
            {% set total_needed = (game_stats.level * (game_stats.level + 1) / 2) * 100 %}
            {% set prev_level_xp = ((game_stats.level - 1) * game_stats.level / 2) * 100 %}
            {% set progress = ((game_stats.xp - prev_level_xp) / (total_needed - prev_level_xp) * 100) if (total_needed - prev_level_xp) > 0 else 0 %}
            <div style="height: 100%; width: {{ progress }}%; background: #6366f1; box-shadow: 0 0 10px #6366f1;"></div>
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block content %}
<!-- Member Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üìñ</div>
        <div class="stat-info">
            <span class="stat-label">My Issued Books</span>
            <span class="stat-value">{{ issues|length }}</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-info">
            <span class="stat-label">Total Fines</span>
            <span class="stat-value">{{ system_settings.currency_symbol }}{{ issues|sum(attribute='fine') }}</span>
        </div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #4e73df 0%, #224abe 100%); color: white;">
        <div class="stat-icon">üèÜ</div>
        <div class="stat-info">
            <span class="stat-label" style="color: rgba(255,255,255,0.8);">My Achievements</span>
            <span class="stat-value" style="color: white;">{{ game_stats.badges|length if game_stats else 0 }} Badges</span>
        </div>
    </div>
</div>

<!-- Trophy Room -->
<!-- Trophy Room -->
{% if game_stats and game_stats.badges %}
<section class="dashboard-section">
    <div class="section-header" style="justify-content: flex-start; align-items: center; gap: 10px;">
        <h2>üèÜ My Trophy Room</h2>
        <a href="/member/achievements" class="btn btn-sm btn-outline-secondary" style="margin-left: auto;">View Details</a>
    </div>
    
    <a href="/member/achievements" style="text-decoration: none; color: inherit; display: block;">
        <div class="glass-card hover-scale" style="padding: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; cursor: pointer; transition: transform 0.2s ease;">
            {% for badge in game_stats.badges[:5] %}
            <div style="text-align: center; width: 100px;">
                <div style="font-size: 2rem; margin-bottom: 0.2rem;">{{ badge.icon }}</div>
                <div style="font-weight: 600; font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ badge.name }}</div>
            </div>
            {% endfor %}
            {% if game_stats.badges|length > 5 %}
            <div style="display: flex; align-items: center; justify-content: center; width: 80px; font-weight: bold; color: var(--text-sub);">
                +{{ game_stats.badges|length - 5 }} More
            </div>
            {% endif %}
        </div>
    </a>
</section>
{% endif %}



<!-- Goals and Privacy -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
    <!-- PERSONAL GOAL -->
    <section class="dashboard-section" style="margin-top: 0;">
        <div class="section-header">
            <h2>üéØ Reading Goal</h2>
            <a href="/member/goals" class="btn btn-outline-secondary btn-sm">View Full Details</a>
        </div>
        <div class="section-content glass-card" style="padding: 1.5rem; display: flex; align-items: center; justify-content: space-between;">
            <div>
                {% if reading_goal %}
                <h3 style="margin: 0; margin-bottom: 0.5rem; font-size: 1.1rem;">{{ reading_goal.current_books }} / {{ reading_goal.goal_books }} Books</h3>
                <p style="color: var(--text-sub); font-size: 0.9rem; margin: 0;">
                    {% set progress = (reading_goal.current_books / reading_goal.goal_books * 100) if reading_goal.goal_books > 0 else 0 %}
                    You're {{ progress|int }}% of the way there!
                </p>
                {% else %}
                <p style="color: var(--text-sub);">No goal set for this year.</p>
                {% endif %}
            </div>
            <a href="/member/goals" class="btn btn-primary">Update Goal</a>
        </div>
    </section>


</div>

<!-- Quick Actions -->
<div class="quick-actions" style="margin: 1.5rem 0;">
    <a href="{{ url_for('member.member_suggest_book') }}" class="btn btn-primary">
        <i class="fas fa-lightbulb me-2"></i>Suggest a Book
    </a>
    <a href="{{ url_for('member.member_catalog_view') }}" class="btn btn-outline-secondary">
        <i class="fas fa-book me-2"></i>Browse Books
    </a>
</div>

<!-- Smart Recommendations -->
<section class="dashboard-section mb-4">
    <div class="section-header">
        <h2><i class="fas fa-magic me-2" style="color: #6366f1;"></i>Recommended for You</h2>
    </div>
    <div class="recommendations-container" style="display: flex; gap: 1rem; overflow-x: auto; padding: 3rem 2rem; scroll-behavior: smooth;">
        {% for rec in recommendations %}
        <div class="glass-card recommendation-card" style="min-width: 220px; width: 220px; position: relative; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); transform-origin: center center; z-index: 1;">
            
            <!-- COVER IMAGE OR FALLBACK -->
            {% if rec.cover_url %}
            <div style="
                height: 320px; 
                background-image: url('{{ rec.cover_url }}');
                background-size: cover;
                background-position: center;
                border-radius: 12px;
                margin-bottom: 1rem;
                position: relative;
                overflow: hidden;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            ">
                <!-- Hover Overlay Gradient -->
                <div class="card-overlay"></div>
            </div>
            {% else %}
            <!-- Fallback Gradient -->
            <div style="
                height: 320px; 
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1)); 
                display: flex; 
                align-items: center; 
                justify-content: center;
                border-radius: 12px;
                margin-bottom: 1rem;
                position: relative;
                overflow: hidden;
            ">
                <div style="font-size: 4rem;">
                    {% if rec.category == 'Fiction' %}üè∞
                    {% elif rec.category == 'Science' %}üß¨
                    {% elif rec.category == 'Biography' %}üë§
                    {% elif rec.category == 'Technology' %}üíª
                    {% else %}üìö{% endif %}
                </div>
                <div class="card-overlay"></div>
            </div>
            {% endif %}

            <div class="rec-info">
                <div style="font-weight: 700; font-size: 1rem; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="{{ rec.title }}">
                    {{ rec.title }}
                </div>
                <div style="font-size: 0.8rem; color: var(--text-sub); margin-bottom: 0.5rem;">
                    {{ rec.author }}
                </div>
                
                <div class="rec-details" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: #fbbf24; margin-bottom: 0.5rem;">
                        <span>‚≠ê {{ "%.1f"|format(rec.avg_rating|float) }} Match</span>
                        <span style="color: var(--text-sub);">‚Ä¢ {{ rec.category }}</span>
                    </div>
                    
                    {% if rec.description %}
                    <div style="font-size: 0.75rem; color: var(--text-sub); margin-bottom: 0.75rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4;">
                        {{ rec.description }}
                    </div>
                    {% endif %}
                
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <form action="/member/request" method="POST" style="flex: 1;">
                            <input type="hidden" name="book_id" value="{{ rec.book_id }}">
                            <button type="submit" class="btn btn-primary btn-sm" style="width: 100%; font-size: 0.7rem;">+ My List</button>
                        </form>
                        {% if rec.pdf_src %}
                        <a href="/member/book/read/{{ rec.book_id }}" class="btn btn-outline-light btn-sm" style="flex: 1; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">
                            ‚ñ∂ Read
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>



<!-- Recent Activity -->
<section class="dashboard-section mb-4">
    <div class="section-header">
        <h2><i class="fas fa-bolt me-2" style="color: var(--primary);"></i>Recent Activity</h2>
    </div>
    <div class="glass-card" style="padding: 1.5rem;">
        {% if not activities %}
        <p style="color: var(--text-sub); text-align: center; margin: 0;">No recent activities found.</p>
        {% else %}
        <div class="activity-timeline">
            {% for act in activities %}
            <div class="activity-item" style="display: flex; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
                <div class="activity-type-icon" style="font-size: 1.25rem;">
                    {% if act.activity_type == 'BORROW' %}üìñ
                    {% elif act.activity_type == 'RETURN' %}‚úÖ
                    {% elif act.activity_type == 'BADGE' %}üèÜ
                    {% elif act.activity_type == 'REVIEW' %}‚≠ê
                    {% elif act.activity_type == 'WISHLIST' %}‚ù§Ô∏è
                    {% else %}üîπ{% endif %}
                </div>
                <div>
                    <div style="font-weight: 600;">{{ act.description }}</div>
                    <div style="font-size: 0.8rem; color: var(--text-sub);">{{ act.created_at }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</section>

<!-- Active Borrowings -->


<section class="dashboard-section">
    <div class="section-header d-flex justify-content-between align-items-center">
        <h2><i class="fas fa-book-reader me-2"></i>Active Borrowings</h2>
        <span class="badge bg-primary">{{ active_issues|length }} Active</span>
    </div>
    <div class="section-content">
        {% set active_issues = issues | selectattr('return_date', 'none') | list %}
        {% if active_issues %}
        <div class="table-container glass-card">
            <table>
                <thead>
                    <tr>
                        <th>Book Title</th>
                        <th>Issue Date</th>
                        <th>Fine ({{ system_settings.currency_symbol }})</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in active_issues %}
                    <tr>
                        <td style="font-weight: 600;">{{ i.title }}</td>
                        <td>{{ i.issue_date }}</td>
                        <td style="color: {{ 'var(--danger)' if i.fine > 0 else 'var(--text-main)' }};">{{ system_settings.currency_symbol }}{{ i.fine }}</td>
                        <td>
                            {% if i.fine > 0 %}
                            <span class="badge badge-danger">Overdue</span>
                            {% else %}
                            <span class="badge badge-pending">Active</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="glass-card" style="text-align: center; color: var(--text-sub); padding: 2rem;">
            <p>You have no active borrowings.</p>
            <a href="/member/catalog" class="btn btn-primary" style="margin-top: 1rem;">Borrow a Book</a>
        </div>
        {% endif %}
    </div>
</section>

<!-- Borrowing History -->
<section class="dashboard-section mt-5">
    <div class="section-header d-flex justify-content-between align-items-center">
        <h2><i class="fas fa-history me-2"></i>Borrowing History</h2>
        <span class="badge bg-secondary">{{ (issues|length) - (active_issues|length) }} Past</span>
    </div>
    <div class="section-content">
        {% set history_issues = issues | selectattr('return_date', 'ne', none) | list %}
        {% if history_issues %}
        <div class="table-container glass-card">
            <table>
                <thead>
                    <tr>
                        <th>Book Title</th>
                        <th>Issue Date</th>
                        <th>Return Date</th>
                        <th>Fine Paid</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in history_issues %}
                    <tr>
                        <td style="font-weight: 400; color: var(--text-sub);">{{ i.title }}</td>
                        <td>{{ i.issue_date }}</td>
                        <td>{{ i.return_date }}</td>
                        <td>{{ system_settings.currency_symbol }}{{ i.fine }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="color: var(--text-sub); opacity: 0.7;">No past borrowing records found.</p>
        {% endif %}
    </div>
</section>

<!-- Account Settings -->
<section class="dashboard-section mt-5">
    <div class="section-header">
        <h2><i class="fas fa-cog me-2" style="color: #e74a3b;"></i>Account Settings</h2>
    </div>
    <div class="section-content glass-card" style="border-color: rgba(220, 53, 69, 0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h3 style="margin-bottom: 0.5rem;">Delete Account</h3>
                <p style="color: var(--text-sub); font-size: 0.9rem;">Once you delete your account, there is no going back. Please be certain.</p>
            </div>
            <form action="/member/delete-account" method="POST" onsubmit="return confirm('‚ö†Ô∏è FINAL WARNING: Are you sure you want to PERMANENTLY delete your account? All your history will be lost.')">
                <button type="submit" class="btn btn-danger" style="background: var(--danger); border: none;">Delete My Account</button>
            </form>
        </div>
    </div>
</section>
</section>


{% endblock %}

</file>

<file path="templates\member\profile.html">

{% extends "layout.html" %}

{% block title %}My Profile{% endblock %}
{% block header_title %}My Profile{% endblock %}
{% block header_subtitle %}Manage your account settings{% endblock %}

{% block content %}
<div class="glass-card" style="max-width: 600px; margin: 2rem auto; padding: 2.5rem; text-align: center;">
    {# Robustness Fix: specific variable (new code) OR generic variable (old code) #}
    {% set display_user = profile_user if profile_user is defined else user %}
    
    <div style="margin-bottom: 2rem; position: relative; display: inline-block;">
        <div style="width: 150px; height: 150px; border-radius: 50%; overflow: hidden; border: 4px solid var(--primary); margin: 0 auto; background: var(--card-bg);">
            {# Try DB user first, then Session (since header works with session) #}
            {% set pic_url = display_user.profile_pic or session.get('profile_pic') %}
            
            {% if pic_url %}
            <img src="{{ url_for('static', filename=pic_url) }}?v={{ range(1, 1000) | random }}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;">
            {% else %}
            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 4rem; background: var(--primary); color: white;">
                {{ display_user.name[0]|upper }}
            </div>
            {% endif %}
        </div>
        
        <!-- Upload Button Icon -->
        <label for="avatarInput" style="position: absolute; bottom: 0; right: 0; background: var(--accent); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
            üì∑
        </label>
    </div>
    
    <!-- Upload Form -->
    <form action="/member/profile/upload" method="POST" enctype="multipart/form-data" id="uploadForm" style="display: none;">
        <input type="file" name="avatar" id="avatarInput" accept="image/*" onchange="document.getElementById('uploadForm').submit()">
    </form>
    
    <!-- User Details -->
    <h2 style="margin-bottom: 0.5rem; color: var(--text-main);">{{ display_user.name }}</h2>
    <p style="color: var(--text-sub); margin-bottom: 2rem;">{{ display_user.email }}</p>
    
    <div style="text-align: left; background: rgba(0,0,0,0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
        <p><strong>Member ID:</strong> {{ display_user.user_id }}</p>
        <p><strong>Role:</strong> {{ display_user.role|capitalize }}</p>
        <p><strong>Joined:</strong> {{ display_user.created_at or 'N/A' }}</p>
    </div>

    <!-- Badges -->
    <h3 style="text-align: left; margin-bottom: 1rem;">My Badges</h3>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 2rem;">
        {% if badges %}
            {% for badge in badges %}
            <div style="background: var(--card-bg); border: 1px solid var(--border); padding: 1rem; border-radius: 12px; text-align: center; width: 100px;">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">{{ badge.icon }}</div>
                <div style="font-size: 0.8rem; font-weight: bold;">{{ badge.name }}</div>
                <div style="font-size: 0.7rem; color: var(--text-sub);">{{ badge.description }}</div>
            </div>
            {% endfor %}
        {% else %}
            <p style="color: var(--text-sub);">No badges yet. Borrow books to earn them!</p>
        {% endif %}
    </div>
    
    <!-- Actions -->
    <form action="/member/delete-account" method="POST" onsubmit="return confirm('Are you sure you want to delete your account? This cannot be undone.');">
        <button type="submit" class="btn btn-outline-danger">Delete Account</button>
    </form>
</div>
{% endblock %}

</file>

<file path="templates\member\public_profile.html">
{% extends "layout.html" %}

{% block title %}{{ profile['user']['name'] }}'s Profile{% endblock %}
{% block header_title %}Reader Profile{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: 350px 1fr; gap: 2rem;">

    <!-- Left Column: User Card -->
    <div>
        <div class="glass-card" style="padding: 2rem; text-align: center; position: sticky; top: 2rem;">
            <div style="position: relative; display: inline-block; margin-bottom: 1rem;">
                <img src="{{ url_for('static', filename=profile['user']['profile_pic'] or 'default.jpg') }}" 
                     style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--glass-border); object-fit: cover;">
                
                <div style="position: absolute; bottom: 0; right: 0; background: var(--primary-gradient); 
                            color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 700;">
                    {{ profile['user']['tier'] }}
                </div>
            </div>

            <h2 style="margin: 0.5rem 0 0.25rem;">{{ profile['user']['name'] }}</h2>
            <p style="color: var(--text-sub); font-size: 0.9rem; margin-bottom: 1.5rem;">
                Member since {{ profile['user']['created_at'].strftime('%b %Y') }}
            </p>

            {% if profile['user']['bio'] %}
                <p style="font-style: italic; color: var(--text-main); opacity: 0.8; margin-bottom: 2rem;">
                    "{{ profile['user']['bio'] }}"
                </p>
            {% endif %}

            <!-- Friendship Actions -->
            <div style="display: grid; gap: 0.5rem;">
                {% if profile['friend_status'] == 'none' %}
                    <form onsubmit="sendFriendRequest(event, '{{ profile['user']['user_id'] }}')">
                        <button type="submit" class="btn btn-primary w-100">Add Friend</button>
                    </form>
                {% elif profile['friend_status'] == 'friends' %}
                    <button class="btn btn-outline-success w-100" disabled>‚úÖ Friends</button>
                    <a href="/member/community" class="btn btn-outline-primary w-100">Send Message</a>
                {% elif profile['friend_status'] == 'sent' %}
                    <button class="btn btn-outline-secondary w-100" disabled>Request Sent</button>
                {% elif profile['friend_status'] == 'received' %}
                    <a href="/member/community" class="btn btn-primary w-100">Respond to Request</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Column: Stats & Badges -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">

        <!-- Reading Stats -->
        <section class="glass-card" style="padding: 1.5rem;">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                üìö {{ profile['goal']['year'] }} Reading Progress
            </h3>
            
            {% if profile['goal'] %}
                <div style="display: flex; align-items: center; gap: 2rem; margin-top: 1rem;">
                    <!-- Circular Progress -->
                    {% set progress = (profile['goal']['current_books'] / profile['goal']['goal_books'] * 100) if profile['goal']['goal_books'] > 0 else 0 %}
                    <div style="position: relative; width: 100px; height: 100px;">
                        <svg width="100" height="100" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#e0e0e0" stroke-width="8" />
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#6366f1" stroke-width="8"
                                    stroke-dasharray="283" stroke-dashoffset="{{ 283 - (283 * progress / 100) }}"
                                    transform="rotate(-90 50 50)" />
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <span style="font-weight: 700; font-size: 1.2rem; color: #4f46e5;">{{ progress|int }}%</span>
                        </div>
                    </div>

                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700;">
                            {{ profile['goal']['current_books'] }} / {{ profile['goal']['goal_books'] }} Books
                        </div>
                        <p style="color: var(--text-sub); margin: 0;">Read this year</p>
                    </div>
                </div>
            {% else %}
                <p style="color: var(--text-sub);">User hasn't set a reading goal for this year.</p>
            {% endif %}
        </section>

        <!-- Badges -->
        <section class="glass-card" style="padding: 1.5rem;">
            <h3 style="margin-top: 0;">üèÜ Earned Badges</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 1rem; margin-top: 1rem;">
                {% for badge in badges %}
                <div style="text-align: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 0.25rem;">{{ badge.icon }}</div>
                    <div style="font-size: 0.8rem; font-weight: 600;">{{ badge.name }}</div>
                </div>
                {% else %}
                    <p style="color: var(--text-sub); grid-column: 1/-1;">No badges earned yet.</p>
                {% endfor %}
            </div>
        </section>

    </div>
</div>

<script>
async function sendFriendRequest(e, userId) {
    e.preventDefault();
    try {
        const res = await fetch('/member/api/community/add_friend', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({target_id: userId})
        });
        const data = await res.json();
        if(res.ok) {
            alert("Friend request sent!");
            location.reload();
        } else {
            alert(data.error || "Failed to send request");
        }
    } catch(err) {
        console.error(err);
        alert("An error occurred");
    }
}
</script>
{% endblock %}

</file>

<file path="templates\member\reader.html">
{% extends "layout.html" %}

{% block title %}Reading: {{ book.title }}{% endblock %}
{% block header_title %}Digital Library Reader{% endblock %}
{% block header_subtitle %}You are reading: {{ book.title }} by {{ book.author }}{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<style>
    .reader-container {
        display: grid;
        grid-template-columns: 280px 1fr;
        height: calc(100vh - 200px);
        gap: 1.5rem;
    }
    .reader-sidebar {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }
    .reader-main {
        background: #525659; /* Standard PDF reader background */
        border-radius: var(--radius);
        overflow: auto;
        position: relative;
        display: flex;
        justify-content: center;
        padding: 2rem 0;
    }
    #pdf-canvas {
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        max-width: 100%;
    }
    .reader-controls {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .control-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: rgba(0,0,0,0.03);
        border-radius: 8px;
    }
    .page-info {
        font-weight: 600;
        font-size: 0.875rem;
    }

    /* Mobile Reader */
    @media (max-width: 768px) {
        .reader-container {
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            height: calc(100vh - 140px); /* Adjust for header */
            gap: 1rem;
        }
        
        .reader-sidebar {
            padding: 1rem;
            gap: 0.5rem;
            /* Collapsed view implementation could go here, 
               but strictly stacking is safer for now */
            order: 2; /* Move controls to bottom */
            max-height: 200px; /* Limit height */
            overflow-y: auto;
        }

        .reader-controls {
            flex-direction: row; /* Horizontal controls */
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }
        
        .control-group {
            flex: 1;
            margin: 0 5px;
        }

        .reader-main {
            order: 1;
            height: 50vh; /* Give reading area priority */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="reader-container">
    <aside class="reader-sidebar glass-card">
        <div>
            <h3 style="margin-bottom: 0.5rem;">üìñ Book Details</h3>
            <p style="font-weight: 600; font-size: 0.9rem; margin: 0;">{{ book.title }}</p>
            <p style="color: var(--text-sub); font-size: 0.8rem;">By {{ book.author }}</p>
        </div>

        <div class="reader-controls">
            <h4 style="font-size: 0.875rem; color: var(--text-sub);">Navigation</h4>
            <div class="control-group">
                <button id="prev" class="btn btn-outline-secondary btn-sm" style="padding: 5px 15px;">Prev</button>
                <div class="page-info">
                    <span id="page_num">1</span> / <span id="page_count">?</span>
                </div>
                <button id="next" class="btn btn-outline-secondary btn-sm" style="padding: 5px 15px;">Next</button>
            </div>

            <h4 style="font-size: 0.875rem; color: var(--text-sub); margin-top: 1rem;">Zoom</h4>
            <div class="control-group">
                <button id="zoom-out" class="btn btn-outline-secondary btn-sm">‚ûñ</button>
                <span id="zoom-val">100%</span>
                <button id="zoom-in" class="btn btn-outline-secondary btn-sm">‚ûï</button>
            </div>
        </div>

        <div style="margin-top: auto;">
            <a href="/member/dashboard" class="btn btn-primary" style="width: 100%;">Close Reader</a>
        </div>
    </aside>

    <main class="reader-main glass-card" id="reader-viewport">
        <canvas id="pdf-canvas"></canvas>
    </main>
</div>

<script>
    const url = "{{ url_for('static', filename=book.pdf_src) }}";
    let pdfDoc = null,
        pageNum = 1,
        pageRendering = false,
        pageNumPending = null,
        scale = 1.5,
        canvas = document.getElementById('pdf-canvas'),
        ctx = canvas.getContext('2d');

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    function renderPage(num) {
        pageRendering = true;
        pdfDoc.getPage(num).then(function(page) {
            let viewport = page.getViewport({scale: scale});
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            let renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            let renderTask = page.render(renderContext);

            renderTask.promise.then(function() {
                pageRendering = false;
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });
        });

        document.getElementById('page_num').textContent = num;
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    document.getElementById('prev').addEventListener('click', () => {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    });

    document.getElementById('next').addEventListener('click', () => {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    });

    document.getElementById('zoom-in').addEventListener('click', () => {
        scale += 0.25;
        document.getElementById('zoom-val').textContent = Math.round(scale * 100) + '%';
        renderPage(pageNum);
    });

    document.getElementById('zoom-out').addEventListener('click', () => {
        if (scale <= 0.5) return;
        scale -= 0.25;
        document.getElementById('zoom-val').textContent = Math.round(scale * 100) + '%';
        renderPage(pageNum);
    });

    pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
        pdfDoc = pdfDoc_;
        document.getElementById('page_count').textContent = pdfDoc.numPages;
        renderPage(pageNum);
    });
</script>
{% endblock %}

</file>

<file path="templates\member\series.html">
{% extends "layout.html" %}

{% block title %}Series: {{ series.title }}{% endblock %}
{% block header_title %}{{ series.title }}{% endblock %}
{% block header_subtitle %}Complete Collection Progress{% endblock %}

{% block content %}
<section class="dashboard-section">
    <div class="glass-card" style="padding: 1.5rem; margin-bottom: 2rem; border-left: 4px solid var(--primary);">
        <p style="font-size: 1.1rem; line-height: 1.6; margin: 0;">{{ series.description or "No description available for this series." }}</p>
    </div>

    <div class="section-header">
        <h2>üìö Books in this Series</h2>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
        {% for b in books %}
        <div class="glass-card" style="padding: 1.5rem; display: flex; align-items: center; gap: 1rem;">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--stat-icon-bg); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary);">
                #{{ b.series_order or loop.index }}
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 700;">{{ b.title }}</div>
                <a href="/member/catalog?q={{ b.title|urlencode }}" style="font-size: 0.8rem; color: var(--primary);">View in Catalog</a>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endblock %}

</file>

<file path="templates\member\suggest_book.html">
{% extends 'layout.html' %}

{% block title %}Suggest a Book{% endblock %}

{% block header_title %}Suggest a Book{% endblock %}
{% block header_subtitle %}Help us improve our collection by suggesting new books{% endblock %}

{% block content %}
<div class="suggest-book-container">
    <div class="suggest-book-card">
        <h2 class="suggest-book-title">
            <i class="fas fa-lightbulb me-2"></i>Suggest a New Book
        </h2>
        <p class="suggest-book-intro">
            Can't find the book you're looking for? Let us know and we'll consider adding it to our collection.
            All fields are required unless marked as optional.
        </p>
        
        <form id="suggestionForm" class="suggest-book-form">
            <div class="form-group">
                <label for="title" class="form-label">
                    Book Title <span class="required-asterisk">*</span>
                </label>
                <input 
                    type="text" 
                    class="form-control" 
                    id="title" 
                    placeholder="Enter book title"
                    required
                >
                <div class="form-text">Please enter the exact title if possible</div>
            </div>
            
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="author" class="form-label">
                        Author <span class="required-asterisk">*</span>
                    </label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="author" 
                        placeholder="Author's name"
                        required
                    >
                </div>
                
                <div class="form-group col-md-6">
                    <label for="isbn" class="form-label">
                        ISBN (optional)
                    </label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="isbn" 
                        placeholder="10 or 13 digit ISBN"
                    >
                    <div class="form-text">Helps us find the exact edition</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="notes" class="form-label">
                    Additional Notes
                </label>
                <textarea 
                    class="form-control" 
                    id="notes" 
                    rows="4"
                    placeholder="Any additional information about why you're suggesting this book..."
                ></textarea>
                <div class="form-text">
                    Let us know why you think this book would be valuable for our collection
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-paper-plane me-2"></i>Submit Suggestion
                </button>
                <div id="formStatus" class="form-status"></div>
            </div>
        </form>
    </div>
    
    <div class="suggest-book-card mt-4">
        <h3 class="suggest-book-subtitle">
            <i class="fas fa-history me-2"></i>My Previous Suggestions
        </h3>
        
        {% if suggestions %}
            <div class="table-responsive">
                <table class="table suggestions-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Author</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="suggestionsTable">
                        {% for s in suggestions %}
                        <tr>
                            <td>{{ s.title }}</td>
                            <td>{{ s.author or 'N/A' }}</td>
                            <td>
                                <span class="status-badge status-{{ s.status|lower }}">
                                    {{ s.status|title }}
                                </span>
                            </td>
                            <td>{{ s.created_at.strftime('%b %d, %Y') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>You haven't made any suggestions yet.</p>
            </div>
        {% endif %}
    </div>
</div>

<style>
.suggest-book-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 15px;
}

.suggest-book-card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    padding: 2rem;
    margin-bottom: 2rem;
}

.suggest-book-title {
    color: #2c3e50;
    margin-bottom: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
}

.suggest-book-subtitle {
    color: #2c3e50;
    margin-bottom: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
}

.suggest-book-intro {
    color: #6c757d;
    margin-bottom: 2rem;
    line-height: 1.6;
}

.suggest-book-form {
    max-width: 700px;
    margin: 0 auto;
}

.form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 0.5rem;
    display: block;
}

.required-asterisk {
    color: #e74c3c;
}

.form-control {
    border-radius: 6px;
    padding: 0.75rem 1rem;
    border: 1px solid #e0e0e0;
    transition: all 0.2s ease;
}

.form-control:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.15);
}

.form-text {
    color: #6c757d;
    font-size: 0.85rem;
    margin-top: 0.25rem;
}

.form-actions {
    margin-top: 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.btn-primary {
    background-color: #4e73df;
    border: none;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-primary:hover {
    background-color: #2e59d9;
    transform: translateY(-1px);
}

.suggestions-table {
    width: 100%;
    margin-top: 1rem;
    border-collapse: collapse;
}

.suggestions-table th {
    background-color: #f8f9fc;
    color: #4e73df;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0.75rem 1rem;
    border-bottom: 2px solid #e3e6f0;
}

.suggestions-table td {
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
}

.suggestions-table tbody tr:hover {
    background-color: #f8f9fc;
}

.status-badge {
    display: inline-block;
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 600;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
    text-transform: capitalize;
}

.status-pending {
    background-color: #fff3cd;
    color: #856404;
}

.status-approved {
    background-color: #d4edda;
    color: #155724;
}

.status-rejected {
    background-color: #f8d7da;
    color: #721c24;
}

.empty-state {
    text-align: center;
    padding: 3rem 1.5rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.form-status {
    margin-left: 1rem;
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .suggest-book-card {
        padding: 1.5rem;
    }
    
    .form-actions {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .form-status {
        margin: 0.5rem 0 0 0;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('suggestionForm');
    const formStatus = document.getElementById('formStatus');
    const suggestionsTable = document.querySelector('#suggestionsTable');
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
        formStatus.textContent = '';
        
        // Prepare form data
        const formData = {
            title: document.getElementById('title').value.trim(),
            author: document.getElementById('author').value.trim(),
            isbn: document.getElementById('isbn').value.trim(),
            notes: document.getElementById('notes').value.trim()
        };
        
        // Client-side validation
        if (!formData.title) {
            showFormError('Please enter a book title');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
            document.getElementById('title').focus();
            return;
        }
        
        if (!formData.author) {
            showFormError('Please enter the author\'s name');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
            document.getElementById('author').focus();
            return;
        }
        
        // Submit the form
        fetch('{{ url_for("member.member_suggest_book") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                // If not JSON, read as text to see what we got
                return response.text().then(text => {
                    console.error('Expected JSON but got:', text.substring(0, 200));
                    throw new Error('Server returned an invalid response. Please try again.');
                });
            }
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Show success message
            formStatus.innerHTML = `
                <div class="alert alert-success d-flex align-items-center" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    ${data.message || 'Suggestion submitted successfully!'}
                </div>
            `;
            
            // Reset form
            form.reset();
            
            // Add the new suggestion to the table
            if (suggestionsTable) {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${escapeHtml(formData.title)}</td>
                    <td>${escapeHtml(formData.author) || 'N/A'}</td>
                    <td><span class="status-badge status-pending">Pending</span></td>
                    <td>${new Date().toLocaleDateString()}</td>
                `;
                
                // If there's a "no suggestions" message, replace it with the table
                const emptyState = document.querySelector('.empty-state');
                if (emptyState) {
                    const table = document.createElement('table');
                    table.className = 'table suggestions-table';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="suggestionsTable"></tbody>
                    `;
                    emptyState.parentNode.replaceChild(table, emptyState);
                    suggestionsTable = document.querySelector('#suggestionsTable');
                }
                
                // Add new row at the top
                if (suggestionsTable) {
                    if (suggestionsTable.rows.length > 0) {
                        suggestionsTable.insertBefore(newRow, suggestionsTable.firstChild);
                    } else {
                        suggestionsTable.appendChild(newRow);
                    }
                }
            }
            
            // Scroll to the top to show the success message
            window.scrollTo({ top: 0, behavior: 'smooth' });
        })
        .catch(error => {
            console.error('Error:', error);
            showFormError(error.message || 'Failed to submit suggestion. Please try again.');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
            
            // Clear success message after 5 seconds
            if (formStatus.querySelector('.alert-success')) {
                setTimeout(() => {
                    formStatus.innerHTML = '';
                }, 5000);
            }
        });
    });
    
    // Helper function to show error messages
    function showFormError(message) {
        formStatus.innerHTML = `
            <div class="alert alert-danger d-flex align-items-center" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            </div>
        `;
        
        // Scroll to the error message
        formStatus.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Helper function to escape HTML
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        const div = document.createElement('div');
        div.textContent = unsafe;
        return div.innerHTML;
    }
    
    // Add animation to form inputs on focus
    const formInputs = form.querySelectorAll('.form-control');
    formInputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });
        
        input.addEventListener('blur', function() {
            this.parentElement.classList.remove('focused');
        });
    });
});
</script>
{% endblock %}

</file>

<file path="templates\member\support.html">

{% extends "layout.html" %}

{% block title %}Support Tickets{% endblock %}
{% block header_title %}Support Tickets{% endblock %}
{% block header_subtitle %}Get help from our support team.{% endblock %}

{% block content %}
<button class="btn btn-primary" style="margin-bottom: 2rem;" onclick="document.getElementById('newTicketModal').style.display='flex'">
    ‚ûï New Ticket
</button>

<div class="glass-card" style="padding: 0; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: rgba(0,0,0,0.03); border-bottom: 1px solid var(--border);">
            <tr>
                <th style="padding: 1rem; text-align: left;">ID</th>
                <th style="padding: 1rem; text-align: left;">Subject</th>
                <th style="padding: 1rem; text-align: center;">Status</th>
                <th style="padding: 1rem; text-align: right;">Date</th>
                <th style="padding: 1rem;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if not tickets %}
            <tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-sub);">No tickets yet.</td></tr>
            {% else %}
            {% for t in tickets %}
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 1rem;">#{{ t.ticket_id }}</td>
                <td style="padding: 1rem; font-weight: 500;">{{ t.subject }}</td>
                <td style="padding: 1rem; text-align: center;">
                    <span class="badge {{ 'badge-success' if t.status == 'closed' else 'badge-primary' }}">
                        {{ t.status|upper }}
                    </span>
                </td>
                <td style="padding: 1rem; text-align: right; color: var(--text-sub);">{{ t.created_at }}</td>
                <td style="padding: 1rem;">
                    <a href="/member/support/{{ t.ticket_id }}" class="btn btn-primary btn-sm">View</a>
                </td>
            </tr>
            {% endfor %}
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Modal -->
<div id="newTicketModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="glass-card" style="width: 90%; max-width: 500px; padding: 2rem;">
        <h2 style="margin-top: 0;">New Support Ticket</h2>
        <form action="/member/support" method="POST">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Subject</label>
                <input type="text" name="subject" required class="form-control" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text-main);">
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Message</label>
                <textarea name="message" rows="5" required class="form-control" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text-main); font-family: inherit;"></textarea>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">Create Ticket</button>
                <button type="button" class="btn btn-danger" style="flex: 1;" onclick="document.getElementById('newTicketModal').style.display='none'">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

</file>

<file path="templates\member\ticket_view.html">

{% extends "layout.html" %}

{% block title %}Ticket #{{ ticket.ticket_id }}{% endblock %}
{% block header_title %}Ticket #{{ ticket.ticket_id }}{% endblock %}
{% block header_subtitle %}{{ ticket.subject }}{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
        <span class="badge {{ 'badge-success' if ticket.status == 'closed' else 'badge-primary' }}" style="font-size: 1rem;">
            Status: {{ ticket.status|upper }}
        </span>
        <a href="/member/support" class="btn btn-primary btn-sm">‚¨Ö Back to List</a>
    </div>
    
    <div class="glass-card" style="margin-bottom: 2rem; max-height: 500px; overflow-y: auto;">
        {% for reply in replies %}
        <div style="margin-bottom: 1.5rem; display: flex; flex-direction: column; align-items: {{ 'flex-end' if reply.sender_id == session['user_id'] else 'flex-start' }};">
            <div style="max-width: 80%; padding: 1rem; border-radius: 12px; background: {{ 'var(--primary)' if reply.sender_id == session['user_id'] else 'var(--card-bg)' }}; color: {{ 'white' if reply.sender_id == session['user_id'] else 'var(--text-main)' }}; border: {{ 'none' if reply.sender_id == session['user_id'] else '1px solid var(--border)' }};">
                <p style="margin: 0; white-space: pre-wrap;">{{ reply.message }}</p>
            </div>
            <span style="font-size: 0.75rem; color: var(--text-sub); margin-top: 0.25rem;">
                {{ reply.sender_name }} ‚Ä¢ {{ reply.created_at }}
            </span>
        </div>
        {% endfor %}
    </div>
    
    {% if ticket.status == 'open' %}
    <form action="" method="POST" class="glass-card">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Reply</label>
        <textarea name="message" rows="3" required class="form-control" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text-main); font-family: inherit; margin-bottom: 1rem;"></textarea>
        <button type="submit" class="btn btn-primary">Send Reply üöÄ</button>
    </form>
    {% else %}
    <div class="glass-card" style="text-align: center; color: var(--text-sub);">
        üîí This ticket is closed.
    </div>
    {% endif %}
</div>
{% endblock %}

</file>

<file path="templates\member\wishlist.html">

{% extends "layout.html" %}

{% block title %}My Wishlist{% endblock %}
{% block header_title %}My Wishlist{% endblock %}
{% block header_subtitle %}Books you want to read later.{% endblock %}

{% block head %}
<style>
    .catalog-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 2rem;
        margin-top: 1.5rem;
    }
    .book-cover-wrapper { position: relative; height: 280px; background: var(--stat-icon-bg); display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .book-cover { width: 100%; height: 100%; object-fit: cover; }
    .book-title { font-size: 1.125rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.25rem; }
    .book-author { font-size: 0.875rem; color: var(--text-sub); margin-bottom: 1rem; }
</style>
{% endblock %}

{% block content %}

{% if not books %}
<div class="glass-card" style="text-align: center; padding: 4rem;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ù§Ô∏è</div>
    <h3>Your wishlist is empty.</h3>
    <a href="/member/catalog" class="btn btn-primary" style="margin-top: 1rem;">Browse Books</a>
</div>
{% else %}
<div class="catalog-grid">
    {% for b in books %}
    <div class="book-card glass-card">
        <div class="book-cover-wrapper">
            <span class="badge badge-float {{ 'badge-success' if b.available_copies > 0 else 'badge-danger' }}">
                {{ b.available_copies }} left
            </span>
            <img src="https://covers.openlibrary.org/b/title/{{ b.title|urlencode }}-M.jpg" class="book-cover" onerror="this.src='https://placehold.co/240x280?text={{ b.title[0] }}'">
        </div>
        
        <div class="book-info" style="padding: 1.25rem;">
            <h3 class="book-title">{{ b.title }}</h3>
            <p class="book-author">by {{ b.author }}</p>
            
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                {% if b.available_copies > 0 %}
                <form action="/member/request" method="POST" style="margin: 0; flex: 1;">
                    <input type="hidden" name="book_id" value="{{ b.book_id }}">
                    <button type="submit" class="btn btn-sm btn-primary" style="width: 100%;">Request</button>
                </form>
                {% else %}
                <form action="/member/waitlist/join" method="POST" style="margin: 0; flex: 1;">
                    <input type="hidden" name="book_id" value="{{ b.book_id }}">
                    <button type="submit" class="btn btn-sm btn-warning" style="width: 100%;">Waitlist</button>
                </form>
                {% endif %}
                
                <form action="/member/wishlist/remove" method="POST" style="margin: 0;">
                    <input type="hidden" name="book_id" value="{{ b.book_id }}">
                    <button type="submit" class="btn btn-sm btn-danger" title="Remove">üóëÔ∏è</button>
                </form>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-sub); margin-top: 0.5rem;">Added: {{ b.added_at }}</p>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

</file>

