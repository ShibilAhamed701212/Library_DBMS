{% extends "layout.html" %}

{% block title %}Manage Users{% endblock %}
{% block header_title %}User Management{% endblock %}
{% block header_subtitle %}Add and manage library staff and members.{% endblock %}

{% block content %}
<div class="glass-card" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; margin-bottom: 2rem; position: sticky; top: 80px; z-index: 100; backdrop-filter: blur(20px);">
    <div>
        <h2 style="margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
            ðŸ‘¤ User Management
        </h2>
        <p style="margin: 0.25rem 0 0; color: var(--text-sub); font-size: 0.85rem;">Manage staff access and member tiers.</p>
    </div>
    <button class="btn btn-primary" onclick="toggleAddUserForm()" style="border-radius: 50px; padding: 0.5rem 1.5rem; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);">
        <i class="fas fa-user-plus me-1"></i> Add New User
    </button>
</div>

<!-- ADD NEW USER (Collapsible) -->
<div id="addUserSection" style="display: none; margin-bottom: 2rem;">
    <div class="glass-card" style="border: 1px solid var(--primary); background: linear-gradient(to bottom right, rgba(255,255,255,0.9), rgba(255,255,255,0.5));">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
            <h3 style="margin: 0; font-size: 1.1rem; color: var(--primary);">âœ¨ Create New Account</h3>
            <button type="button" onclick="toggleAddUserForm()" style="background: none; border: none; font-size: 1.25rem; cursor: pointer; color: var(--text-sub);">âœ•</button>
        </div>
        <form action="/admin/user/add" method="POST" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem;">
            <div class="form-group" style="margin: 0;">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; display: block;">Full Name</label>
                <div style="position: relative;">
                    <i class="fas fa-user" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 0.9rem;"></i>
                    <input type="text" name="name" placeholder="John Doe" required style="padding-left: 2.5rem; border-radius: 8px;">
                </div>
            </div>
            <div class="form-group" style="margin: 0;">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; display: block;">Email Address</label>
                <div style="position: relative;">
                    <i class="fas fa-envelope" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 0.9rem;"></i>
                    <input type="email" name="email" placeholder="john@example.com" required style="padding-left: 2.5rem; border-radius: 8px;">
                </div>
            </div>
            <div class="form-group" style="margin: 0;">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; display: block;">Initial Password</label>
                <div style="position: relative;">
                    <i class="fas fa-lock" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 0.9rem;"></i>
                    <input type="password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required style="padding-left: 2.5rem; border-radius: 8px;">
                </div>
            </div>
            <div class="form-group" style="margin: 0;">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; display: block;">Role</label>
                <div style="position: relative;">
                    <i class="fas fa-shield-alt" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 0.9rem;"></i>
                    <select name="role" required style="padding-left: 2.5rem; border-radius: 8px; width: 100%; appearance: none;">
                        <option value="member">Member</option>
                        <option value="admin">Administrator</option>
                    </select>
                    <i class="fas fa-chevron-down" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 0.8rem; pointer-events: none;"></i>
                </div>
            </div>
            <div class="form-group" style="grid-column: 1 / -1; margin-top: 0.5rem;">
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px; border-radius: 8px; font-weight: 600; display: flex; justify-content: center; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-check-circle"></i> Create Account
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function toggleAddUserForm() {
        const section = document.getElementById('addUserSection');
        if (section.style.display === 'none') {
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            section.style.display = 'none';
        }
    }
</script>

<!-- USERS LIST -->
<div class="glass-card" style="padding: 0; overflow: hidden; margin-top: 2rem;">
    <div class="table-responsive">
        <table class="table" style="margin: 0; width: 100%; border-collapse: separate; border-spacing: 0;">
            <thead style="background: rgba(0,0,0,0.02); height: 50px;">
                <tr>
                    <th style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600;">User Info</th>
                    <th style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600;">Role</th>
                    <th style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600;">Membership Tier</th>
                    <th style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600;">Joined Date</th>
                    <th style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 600; text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr style="transition: background 0.2s;">
                    <td style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <!-- Initials Avatar -->
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, var(--primary) 0%, #818cf8 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                {{ u.name[0] | upper }}{{ u.name.split(' ')[-1][0] | upper if ' ' in u.name else '' }}
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <span style="font-weight: 600; color: var(--text-main); font-size: 0.95rem;">{{ u.name }}</span>
                                <span style="color: var(--text-sub); font-size: 0.8rem;">{{ u.email }}</span>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border);">
                        {% if u.role == 'admin' %}
                            <span class="badge" style="background: rgba(99, 102, 241, 0.1); color: #6366f1; border: 1px solid rgba(99, 102, 241, 0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                <i class="fas fa-shield-alt me-1"></i> Admin
                            </span>
                        {% else %}
                            <span class="badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                <i class="fas fa-user me-1"></i> Member
                            </span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border);">
                        {% if u.role == 'member' %}
                        <form action="/admin/user/tier" method="POST" style="margin: 0;">
                            <input type="hidden" name="user_id" value="{{ u.user_id }}">
                            <div style="position: relative; display: inline-block;">
                                <select name="tier" onchange="this.form.submit()" 
                                    style="appearance: none; padding: 6px 30px 6px 12px; border-radius: 20px; font-size: 0.85rem; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; color: var(--text-main); font-weight: 500; transition: all 0.2s;">
                                    <option value="Silver" {% if u.tier == 'Silver' %}selected{% endif %}>ðŸ¥ˆ Silver</option>
                                    <option value="Gold" {% if u.tier == 'Gold' %}selected{% endif %}>ðŸ¥‡ Gold</option>
                                    <option value="Platinum" {% if u.tier == 'Platinum' %}selected{% endif %}>ðŸ’Ž Platinum</option>
                                </select>
                                <i class="fas fa-chevron-down" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: var(--text-sub); pointer-events: none;"></i>
                            </div>
                        </form>
                        {% else %}
                            <span style="color: var(--text-sub); opacity: 0.5;">â€”</span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); color: var(--text-sub); font-size: 0.9rem;">
                        {{ u.created_at.strftime('%b %d, %Y') if u.created_at else 'N/A' }}
                    </td>
                    <td style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); text-align: right;">
                        {% if session.get('user_id') != u.user_id %}
                            <form action="/admin/user/delete/{{ u.user_id }}" method="POST" onsubmit="return confirm('âš ï¸ Are you sure you want to delete this user? This action cannot be undone.')" style="margin: 0;">
                                <button type="submit" class="btn btn-sm btn-outline-danger" style="border-radius: 8px; padding: 0.4rem 0.8rem;" title="Delete User">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        {% else %}
                            <span class="badge" style="background: rgba(107, 114, 128, 0.1); color: #6b7280; font-size: 0.75rem;">Current</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
