{% extends "layout.html" %}

{% block title %}Series: {{ series.title }}{% endblock %}
{% block header_title %}{{ series.title }}{% endblock %}
{% block header_subtitle %}Complete reading order for this collection.{% endblock %}

{% block content %}
<style>
    .series-timeline {
        position: relative;
        max-width: 800px;
        margin: 2rem auto;
        padding-left: 3rem;
        border-left: 2px dashed var(--border);
    }
    .timeline-item {
        position: relative;
        margin-bottom: 2rem;
        padding: 1.5rem;
        transition: transform 0.3s;
    }
    .timeline-item:hover { transform: translateX(10px); }
    .timeline-item::before {
        content: attr(data-order);
        position: absolute;
        left: -3.8rem;
        top: 1.5rem;
        width: 30px;
        height: 30px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 0.8rem;
        box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4);
    }
    .book-card-mini {
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }
    .book-thumb-mini {
        width: 60px;
        height: 90px;
        border-radius: 6px;
        object-fit: cover;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <a href="/admin/series" class="btn btn-outline-secondary btn-sm">‚¨ÖÔ∏è Back to All Series</a>
    <form action="/admin/series/delete/{{ series.series_id }}" method="POST" onsubmit="return confirm('Are you sure? This will NOT delete the books, only the series group.');">
        <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è Delete Series</button>
    </form>
</div>

<div class="series-timeline">
    {% if not books %}
    <div class="glass-card" style="padding: 2rem; text-align: center;">
        <p style="color: var(--text-sub);">No books found in this series.</p>
    </div>
    {% else %}
    {% for b in books %}
    <div class="glass-card timeline-item" data-order="{{ b.series_order or loop.index }}">
        <div class="book-card-mini">
            <img src="https://covers.openlibrary.org/b/title/{{ b.title|urlencode }}-S.jpg" 
                 class="book-thumb-mini" 
                 onerror="this.src='https://placehold.co/60x90?text={{ b.title[0] }}';">
            <div style="flex: 1;">
                <h3 style="margin: 0; font-size: 1.1rem;">{{ b.title }}</h3>
                <p style="margin: 0.25rem 0; font-size: 0.85rem; color: var(--text-sub);">by {{ author_name or 'Unknown Author' }}</p>
                <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                    <span class="badge" style="background: var(--stat-icon-bg); color: var(--primary);">{{ b.category }}</span>
                    <a href="/admin/books?q={{ b.title|urlencode }}" class="btn btn-outline-secondary btn-sm" style="padding: 2px 8px; font-size: 0.7rem;">Manage Book</a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% endif %}
</div>

<!-- Add Book Modal -->
<div class="fab-container">
    <button class="btn btn-primary btn-lg rounded-circle shadow" onclick="openModal('addBookModal')" style="width: 60px; height: 60px; font-size: 1.5rem;">üìö</button>
</div>

<div id="addBookModal" class="modal-overlay">
    <div class="modal-content glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>Add Book to Series</h2>
            <button class="btn-close" onclick="closeModal('addBookModal')">‚úï</button>
        </div>
        <form action="/admin/series/add-book" method="POST">
            <input type="hidden" name="series_id" value="{{ series.series_id }}">
            
            <div class="form-group">
                <label>Search Book</label>
                <input type="text" id="bookSearch" class="form-control" placeholder="Type book title..." onkeyup="searchBooks(this.value)">
                <div id="searchResults" style="border: 1px solid var(--border); border-radius: 8px; margin-top: 0.5rem; max-height: 150px; overflow-y: auto; display: none;"></div>
                <input type="hidden" name="book_id" id="selectedBookId" required>
            </div>
            
            <div class="form-group" style="margin-top: 1rem;">
                <label>Order in Series (#)</label>
                <input type="number" name="order" class="form-control" required value="{{ (books|length) + 1 }}" min="1">
            </div>
            
            <div style="margin-top: 1.5rem; text-align: right;">
                <button type="submit" class="btn btn-primary">Add Book</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openModal(id) { document.getElementById(id).style.display = "flex"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    
    async function searchBooks(query) {
        if (query.length < 2) {
            document.getElementById('searchResults').style.display = 'none';
            return;
        }
        
        const res = await fetch(`/api/books/search?q=${query}`);
        const books = await res.json();
        const resultsDiv = document.getElementById('searchResults');
        resultsDiv.innerHTML = '';
        
        if (books.length > 0) {
            resultsDiv.style.display = 'block';
            books.forEach(b => {
                const div = document.createElement('div');
                div.style.padding = '0.5rem 1rem';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid var(--border)';
                div.innerText = b.title;
                div.onmouseover = () => div.style.background = 'rgba(99, 102, 241, 0.1)';
                div.onmouseout = () => div.style.background = 'transparent';
                div.onclick = () => {
                    document.getElementById('bookSearch').value = b.title;
                    document.getElementById('selectedBookId').value = b.book_id;
                    resultsDiv.style.display = 'none';
                };
                resultsDiv.appendChild(div);
            });
        }
    }
</script>
{% endblock %}
