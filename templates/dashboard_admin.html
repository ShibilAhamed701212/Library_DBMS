<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | LibManage</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <!-- Flash Messages -->
    <div class="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash-message flash-{{ category }}">
              <span>{{ msg }}</span>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    </div>

    <div class="app-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <span>üìö</span> LibManage
            </div>
            
            <nav class="nav-links">
                <div class="nav-item">
                    <a href="/dashboard" class="nav-link active">
                        <span>üìä</span> Overview
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#users-section" class="nav-link">
                        <span>üë•</span> Users
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#add-user-section" class="nav-link">
                        <span>‚ûï</span> Add User
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#books-section" class="nav-link">
                        <span>üìñ</span> Books
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#issue-section" class="nav-link">
                        <span>üì§</span> Issue Book
                    </a>
                </div>
            </nav>

            <div style="margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                <a href="/logout" class="nav-link" style="color: #ef4444;">
                    <span>üö™</span> Logout
                </a>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <header>
                <div class="header-title">
                    <h1>Dashboard</h1>
                    <p>Welcome back, <strong>{{ user.name }}</strong> ({{ role }})</p>
                </div>
                <div class="user-profile">
                    <div style="text-align: right;">
                        <span style="display: block; font-weight: 600;">{{ user.name }}</span>
                        <span style="font-size: 0.75rem; color: var(--text-sub);">Administrator</span>
                    </div>
                    <div style="width: 40px; height: 40px; background: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                        {{ user.name[0] }}
                    </div>
                </div>
            </header>

            <!-- STATS GRID -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <span class="stat-value">{{ total_users }}</span>
                        <span class="stat-label">Total Users</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìö</div>
                    <div class="stat-info">
                        <span class="stat-value">{{ total_books }}</span>
                        <span class="stat-label">Total Books</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üîñ</div>
                    <div class="stat-info">
                        <span class="stat-value">{{ total_issues }}</span>
                        <span class="stat-label">Active Issues</span>
                    </div>
                </div>
            </div>

            <!-- FORMS ROW -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;" id="issue-section">
                <!-- ISSUE BOOK -->
                <section class="dashboard-section">
                    <div class="section-header">
                        <h2>üì§ Issue Book</h2>
                    </div>
                    <div class="section-content">
                        <form action="/admin/issue" method="POST">
                            <div class="form-group">
                                <label>Member</label>
                                <select name="user_id" required>
                                    <option value="" disabled selected>Select user...</option>
                                    {% for u in users %}
                                    <option value="{{ u.user_id }}">{{ u.name }} (ID: {{ u.user_id }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Book</label>
                                <select name="book_id" required>
                                    <option value="" disabled selected>Select book...</option>
                                    {% for b in books %}
                                    <option value="{{ b.book_id }}">{{ b.title }} (ID: {{ b.book_id }}) ‚Äî {{ b.author }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Complete Issue</button>
                        </form>
                    </div>
                </section>

                <!-- RETURN BOOK -->
                <section class="dashboard-section">
                    <div class="section-header">
                        <h2>üì• Return Book</h2>
                    </div>
                    <div class="section-content">
                        <form action="/admin/return" method="POST">
                            <div class="form-group">
                                <label>Member</label>
                                <select name="user_id" required>
                                    <option value="" disabled selected>Select user...</option>
                                    {% for u in users %}
                                    <option value="{{ u.user_id }}">{{ u.name }} (ID: {{ u.user_id }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Book</label>
                                <select name="book_id" required>
                                    <option value="" disabled selected>Select book...</option>
                                    {% for b in books %}
                                    <option value="{{ b.book_id }}">{{ b.title }} (ID: {{ b.book_id }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-danger" style="width: 100%;">Process Return</button>
                        </form>
                    </div>
                </section>
            </div>

            <!-- ADD NEW USER -->
            <section class="dashboard-section" id="add-user-section">
                <div class="section-header">
                    <h2>üë§ Add New User</h2>
                </div>
                <div class="section-content">
                    <form action="/admin/user/add" method="POST" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" name="name" placeholder="John Doe" required>
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" name="email" placeholder="john@example.com" required>
                        </div>
                        <div class="form-group">
                            <label>Initial Password</label>
                            <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select name="role" required>
                                <option value="member">Member</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">Create Account</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- PENDING REQUESTS -->
            <section class="dashboard-section">
                <div class="section-header">
                    <h2>‚è≥ Pending Requests</h2>
                    <span class="badge badge-pending">{{ pending_requests|length }} New</span>
                </div>
                <div class="section-content">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Book</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in pending_requests %}
                                <tr>
                                    <td>#{{ req.request_id }}</td>
                                    <td>{{ req.request_date }}</td>
                                    <td style="font-weight: 500;">{{ req.user_name }}</td>
                                    <td>{{ req.book_title }}</td>
                                    <td>
                                        <form action="/admin/request/approve" method="POST" style="display:inline;">
                                            <input type="hidden" name="request_id" value="{{ req.request_id }}">
                                            <button type="submit" class="btn btn-primary btn-sm">Approve</button>
                                        </form>
                                        <form action="/admin/request/reject" method="POST" style="display:inline;">
                                            <input type="hidden" name="request_id" value="{{ req.request_id }}">
                                            <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                                        </form>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" style="text-align: center; color: var(--text-sub); padding: 2rem;">
                                        No pending requests at the moment.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ACTIVE ISSUES -->
            <section class="dashboard-section" id="active-issues">
                <div class="section-header">
                    <h2>üîñ Currently Borrowed</h2>
                </div>
                <div class="section-content">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Issue ID</th>
                                    <th>User</th>
                                    <th>Book</th>
                                    <th>Issue Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for i in active_issues %}
                                <tr>
                                    <td>#{{ i.issue_id }}</td>
                                    <td style="font-weight: 500;">{{ i.user_name }}</td>
                                    <td>{{ i.book_title }}</td>
                                    <td>{{ i.issue_date }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--text-sub); padding: 2rem;">No active issues.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- BOOKS LIST -->
            <section class="dashboard-section" id="books-section">
                <div class="section-header">
                    <h2>üìñ Books Inventory</h2>
                </div>
                <div class="section-content">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Author</th>
                                    <th>Category</th>
                                    <th>Stock</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for b in books %}
                                <tr>
                                    <td>#{{ b.book_id }}</td>
                                    <td style="font-weight: 600;">{{ b.title }}</td>
                                    <td>{{ b.author }}</td>
                                    <td><span class="badge" style="background: #f1f5f9; color: #475569;">{{ b.category }}</span></td>
                                    <td>
                                        <span class="text-{{ 'success' if b.available_copies > 0 else 'danger' }}">
                                            {{ b.available_copies }} / {{ b.total_copies }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

             <!-- USERS LIST -->
             <section class="dashboard-section" id="users-section">
                <div class="section-header">
                    <h2>üë• Registered Users</h2>
                </div>
                <div class="section-content">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Joined</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for u in users %}
                                <tr>
                                    <td>#{{ u.user_id }}</td>
                                    <td style="font-weight: 600;">{{ u.name }}</td>
                                    <td>{{ u.email }}</td>
                                    <td><span class="badge" style="background: {{ '#dcfce7' if u.role == 'admin' else '#eff6ff' }}; color: {{ '#166534' if u.role == 'admin' else '#2563eb' }};">{{ u.role|capitalize }}</span></td>
                                    <td>{{ u.created_at.strftime('%Y-%m-%d') if u.created_at else 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

</body>
</html>
