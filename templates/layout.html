<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} | LibManage</title>
    
    <!-- Theme Detection Script -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Mobile View: Premium Top Bar -->
    <div class="mobile-top-bar">
        <div class="mobile-left">
            <button class="menu-toggle" id="menuToggle">â˜°</button>
            <div class="mobile-logo"><span>ğŸ“š</span> LibManage</div>
        </div>
        <div class="mobile-user">
            <span class="mobile-user-name">{{ session.get('name', 'User') }}</span>
        </div>
    </div>

    <!-- Flash Messages -->
    <div class="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash-message flash-{{ category }}">
              <span>{{ msg }}</span>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <span>ğŸ“š</span> LibManage
            </div>
            
            <!-- Theme Toggle -->
            <div class="theme-toggle-wrapper">
                <button id="themeToggle" class="theme-btn">
                    <span id="themeIcon">ğŸŒ™</span>
                    <span id="themeText">Dark Mode</span>
                </button>
            </div>

            <nav class="nav-links">
                {% if session.get('role') == 'admin' %}
                    <a href="/admin/dashboard" class="nav-link {% if active_page == 'admin_overview' %}active{% endif %}">
                        <span>ğŸ“Š</span> Overview
                    </a>
                    <a href="/admin/books" class="nav-link {% if active_page == 'admin_books' %}active{% endif %}">
                        <span>ğŸ“–</span> Books
                    </a>
                    <a href="/admin/users" class="nav-link {% if active_page == 'admin_users' %}active{% endif %}">
                        <span>ğŸ‘¥</span> Users
                    </a>
                    <a href="/admin/issues" class="nav-link {% if active_page == 'admin_issues' %}active{% endif %}">
                        <span>ğŸ“¤</span> Issue/Return
                    </a>
                    <a href="/admin/requests" class="nav-link {% if active_page == 'admin_requests' %}active{% endif %}">
                        <span>â³</span> Requests
                    </a>
                    <a href="/reports" class="nav-link {% if active_page == 'admin_reports' %}active{% endif %}">
                        <span>ğŸ“ˆ</span> Reports
                    </a>
                {% else %}
                    <a href="/member/dashboard" class="nav-link {% if active_page == 'member_overview' %}active{% endif %}">
                        <span>ğŸ“Š</span> Overview
                    </a>
                    <a href="/member/catalog" class="nav-link {% if active_page == 'member_catalog' %}active{% endif %}">
                        <span>ğŸ“–</span> Catalog
                    </a>
                {% endif %}
            </nav>

            <div style="margin-top: auto; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 1.5rem;">
                <a href="/logout" class="nav-link" style="color: #ef4444;">
                    <span>ğŸšª</span> Logout
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header>
                <div class="header-title">
                    <h1>{% block header_title %}{% endblock %}</h1>
                    <p>{% block header_subtitle %}{% endblock %}</p>
                </div>
                <div class="user-profile">
                    <div style="text-align: right;">
                        <span style="display: block; font-weight: 600;">{{ session.get('name', 'User') }}</span>
                        <span style="font-size: 0.75rem; color: var(--text-sub);">{{ session.get('role')|capitalize }}</span>
                    </div>
                    <div style="width: 40px; height: 40px; background: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                        {{ session.get('name', 'U')[0] }}
                    </div>
                </div>
            </header>

            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Mobile Menu & Theme Toggle Script -->
    <script>
        // Mobile menu toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        function toggleMenu() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        menuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMenu();
        });
        
        overlay.addEventListener('click', toggleMenu);
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 1024 && 
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target) &&
                sidebar.classList.contains('open')) {
                toggleMenu();
            }
        });

        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        const html = document.documentElement;

        function updateToggleUI(theme) {
            if (theme === 'dark') {
                themeIcon.innerText = 'â˜€ï¸';
                themeText.innerText = 'Light Mode';
            } else {
                themeIcon.innerText = 'ğŸŒ™';
                themeText.innerText = 'Dark Mode';
            }
        }

        updateToggleUI(html.getAttribute('data-theme'));

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateToggleUI(newTheme);
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
