{% extends "layout.html" %}

{% block title %}{{ profile['user']['name'] }}'s Profile{% endblock %}
{% block header_title %}Reader Profile{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: 350px 1fr; gap: 2rem;">

    <!-- Left Column: User Card -->
    <div>
        <div class="glass-card" style="padding: 2rem; text-align: center; position: sticky; top: 2rem;">
            <div style="position: relative; display: inline-block; margin-bottom: 1rem;">
                <img src="{{ url_for('static', filename=profile['user']['profile_pic'] or 'default.jpg') }}" 
                     style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--glass-border); object-fit: cover;">
                
                <div style="position: absolute; bottom: 0; right: 0; background: var(--primary-gradient); 
                            color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 700;">
                    {{ profile['user']['tier'] }}
                </div>
            </div>

            <h2 style="margin: 0.5rem 0 0.25rem;">{{ profile['user']['name'] }}</h2>
            <p style="color: var(--text-sub); font-size: 0.9rem; margin-bottom: 1.5rem;">
                Member since {{ profile['user']['created_at'].strftime('%b %Y') }}
            </p>

            {% if profile['user']['bio'] %}
                <p style="font-style: italic; color: var(--text-main); opacity: 0.8; margin-bottom: 2rem;">
                    "{{ profile['user']['bio'] }}"
                </p>
            {% endif %}

            <!-- Friendship Actions -->
            <div style="display: grid; gap: 0.5rem;">
                {% if profile['friend_status'] == 'none' %}
                    <form onsubmit="sendFriendRequest(event, '{{ profile['user']['user_id'] }}')">
                        <button type="submit" class="btn btn-primary w-100">Add Friend</button>
                    </form>
                {% elif profile['friend_status'] == 'friends' %}
                    <button class="btn btn-outline-success w-100" disabled>‚úÖ Friends</button>
                    <a href="/member/community" class="btn btn-outline-primary w-100">Send Message</a>
                {% elif profile['friend_status'] == 'sent' %}
                    <button class="btn btn-outline-secondary w-100" disabled>Request Sent</button>
                {% elif profile['friend_status'] == 'received' %}
                    <a href="/member/community" class="btn btn-primary w-100">Respond to Request</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Column: Stats & Badges -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">

        <!-- Reading Stats -->
        <section class="glass-card" style="padding: 1.5rem;">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                üìö {{ profile['goal']['year'] }} Reading Progress
            </h3>
            
            {% if profile['goal'] %}
                <div style="display: flex; align-items: center; gap: 2rem; margin-top: 1rem;">
                    <!-- Circular Progress -->
                    {% set progress = (profile['goal']['current_books'] / profile['goal']['goal_books'] * 100) if profile['goal']['goal_books'] > 0 else 0 %}
                    <div style="position: relative; width: 100px; height: 100px;">
                        <svg width="100" height="100" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#e0e0e0" stroke-width="8" />
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#6366f1" stroke-width="8"
                                    stroke-dasharray="283" stroke-dashoffset="{{ 283 - (283 * progress / 100) }}"
                                    transform="rotate(-90 50 50)" />
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <span style="font-weight: 700; font-size: 1.2rem; color: #4f46e5;">{{ progress|int }}%</span>
                        </div>
                    </div>

                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700;">
                            {{ profile['goal']['current_books'] }} / {{ profile['goal']['goal_books'] }} Books
                        </div>
                        <p style="color: var(--text-sub); margin: 0;">Read this year</p>
                    </div>
                </div>
            {% else %}
                <p style="color: var(--text-sub);">User hasn't set a reading goal for this year.</p>
            {% endif %}
        </section>

        <!-- Badges -->
        <section class="glass-card" style="padding: 1.5rem;">
            <h3 style="margin-top: 0;">üèÜ Earned Badges</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 1rem; margin-top: 1rem;">
                {% for badge in badges %}
                <div style="text-align: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 0.25rem;">{{ badge.icon }}</div>
                    <div style="font-size: 0.8rem; font-weight: 600;">{{ badge.name }}</div>
                </div>
                {% else %}
                    <p style="color: var(--text-sub); grid-column: 1/-1;">No badges earned yet.</p>
                {% endfor %}
            </div>
        </section>

    </div>
</div>

<script>
async function sendFriendRequest(e, userId) {
    e.preventDefault();
    try {
        const res = await fetch('/member/api/community/add_friend', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({target_id: userId})
        });
        const data = await res.json();
        if(res.ok) {
            alert("Friend request sent!");
            location.reload();
        } else {
            alert(data.error || "Failed to send request");
        }
    } catch(err) {
        console.error(err);
        alert("An error occurred");
    }
}
</script>
{% endblock %}
