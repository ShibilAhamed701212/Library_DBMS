{% extends "layout.html" %}

{% block title %}Book Catalog{% endblock %}
{% block header_title %}Discover Books{% endblock %}
{% block header_subtitle %}Browse our collection and request items to borrow.{% endblock %}

{% block head %}
<style>
    .catalog-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }
    .book-card {
        display: flex;
        flex-direction: column;
        border-radius: 16px;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid var(--border);
        background: var(--card-bg);
    }
    .book-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .book-cover-wrapper {
        position: relative;
        height: 320px;
        background: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border-bottom: 1px solid var(--border);
    }
    .book-cover {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
    }
    .book-card:hover .book-cover {
        transform: scale(1.03);
    }
    .book-placeholder {
        width: 100%; height: 100%;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        padding: 2rem; text-align: center;
        background: linear-gradient(135deg, var(--primary) 0%, #0063cc 100%);
        color: white;
    }
    .book-info {
        padding: 1rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .book-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-main);
        margin: 0 0 0.25rem 0;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .book-author {
        font-size: 0.9rem;
        color: var(--text-sub);
        margin-bottom: 1rem;
    }
    .book-meta {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .action-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.5rem;
    }
    .badge-float {
        position: absolute; top: 10px; right: 10px; z-index: 2;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        padding: 0.5rem 0.8rem;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.85rem;
        color: white !important;
    }
    .badge-success { background-color: #3b82f6 !important; border: 2px solid white; }
    .badge-danger { background-color: #ef4444 !important; border: 2px solid white; }
    .pagination {
        margin-top: 3rem;
        margin-bottom: 3rem;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        width: 100%;
    }
    .page-info {
        font-weight: 500;
        color: var(--text-main);
    }
    .glass-input {
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 12px;
        color: var(--text-main);
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        height: 42px; /* Fixed height for uniformity */
        display: flex; 
        align-items: center;
    }
    .glass-input:focus-within, .glass-input:focus {
        background: rgba(255, 255, 255, 0.8);
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.15);
    }
    .glass-input input {
        background: transparent !important;
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
        width: 100%;
        height: 100%;
        color: inherit;
    }
    .glass-input input:-webkit-autofill,
    .glass-input input:-webkit-autofill:hover, 
    .glass-input input:-webkit-autofill:focus {
        -webkit-box-shadow: 0 0 0px 1000px white inset !important;
        transition: background-color 5000s ease-in-out 0s;
    }

    @media (max-width: 768px) {
        .catalog-grid {
            grid-template-columns: 1fr; /* Full width cards */
            padding: 0 1rem;
        }
        /* Stack Form Elements */
        form[action="/member/catalog"] {
            flex-direction: column;
            align-items: stretch !important;
            gap: 1rem !important;
        }
        form[action="/member/catalog"] > div {
            min-width: 100% !important;
            width: 100% !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem; padding: 0.5rem 0;">
    <form action="/member/catalog" method="GET" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
        <div style="flex: 2; min-width: 200px;">
            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 600; opacity: 0.9;">Search by Title or Author</label>
            <div class="glass-input" style="display: flex; align-items: center; padding: 0 1rem;">
                <span style="margin-right: 0.75rem; opacity: 0.7;">üîç</span>
                <input type="text" name="q" value="{{ q }}" placeholder="e.g. Harry Potter or J.K. Rowling..." autocomplete="off">
            </div>
        </div>

        <div style="flex: 1; min-width: 150px;">
            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 600; opacity: 0.9;">Category</label>
            <select name="category" class="form-control glass-input" style="width: 100%; padding: 0 1rem; appearance: none; cursor: pointer;">
                <option value="" style="color: black;">All Categories</option>
                {% for c in categories %}
                <option value="{{ c.category }}" {% if selected_category == c.category %}selected{% endif %} style="color: black;">{{ c.category }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="display: flex; gap: 0.5rem; flex: 1; min-width: 150px;">
            <div style="width: 100%;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 600; opacity: 0;">Action</label>
                <div style="display: flex; gap: 0.5rem; height: 42px;">
                    <button type="submit" class="btn btn-primary" style="height: 100%; flex: 1; display: flex; align-items: center; justify-content: center;">Apply</button>
                    <a href="/member/catalog" class="btn btn-outline-secondary" style="height: 100%; flex: 1; display: flex; align-items: center; justify-content: center; text-decoration: none;">Reset</a>
                </div>
            </div>
        </div>
    </form>
</div>

{% if not books %}
<div style="text-align: center; padding: 5rem; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);">
    <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
    <h3>No books found matching your search.</h3>
    <p style="color: var(--text-sub);">Try a different keyword or browse all books.</p>
    <a href="/member/catalog" class="btn btn-primary" style="margin-top: 1.5rem;">Clear Search</a>
</div>
{% else %}
<div class="catalog-grid">
    {% for b in books %}
    <div class="book-card glass-card">
        <!-- Cover Section -->
        <div class="book-cover-wrapper">
            <span class="badge badge-float {{ 'badge-success' if b.available_copies > 0 else 'badge-danger' }}">
                {{ b.available_copies }} left
            </span>
            
            <img src="https://covers.openlibrary.org/b/title/{{ b.title|urlencode }}-M.jpg" 
                 class="book-cover" 
                 alt="{{ b.title }}"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            
            <div class="book-placeholder" style="display: none;">
                <div class="title-initials">{{ b.title[0]|upper }}</div>
                <div style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">{{ b.category }}</div>
            </div>
        </div>
        
        <!-- Info Section -->
        <div class="book-info">
            <!-- Series Badge -->
            {% if b.series_title %}
            <div style="margin-bottom: 0.5rem;">
                <a href="/member/series/{{ b.series_id }}" class="badge" style="background: rgba(99, 102, 241, 0.1); color: #6366f1; font-size: 0.7rem; text-decoration: none;">
                    ‚õìÔ∏è {{ b.series_title }} #{{ b.series_order }}
                </a>
            </div>
            {% endif %}

            <div style="display:flex; justify-content:space-between; align-items:start;">
                <h3 class="book-title" title="{{ b.title }}">{{ b.title }}</h3>
            </div>
            
            <p class="book-author">by <a href="/member/author/{{ b.author_id }}" style="color: var(--text-sub);">{{ b.author_name }}</a></p>
            
            <div class="book-meta">
                <!-- Meta Row: Category & Rating -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span class="badge" style="background: var(--stat-icon-bg); color: var(--primary);">{{ b.category }}</span>
                    <button class="btn btn-sm btn-ghost" onclick="openReviewModal('{{ b.book_id }}', '{{ b.title|escape }}')" style="padding: 2px 8px; font-size: 0.8rem;">
                        ‚≠ê Rate
                    </button>
                </div>

                <!-- Action Row -->
                <div class="action-row">
                    <!-- Check Availability Logic -->
                    {% if b.available_copies > 0 %}
                    <form action="/member/request" method="POST" style="margin:0;">
                        <input type="hidden" name="book_id" value="{{ b.book_id }}">
                        <button type="submit" class="btn btn-sm btn-primary w-100">Request</button>
                    </form>
                    {% else %}
                    <form action="/member/waitlist/join" method="POST" style="margin:0;">
                        <input type="hidden" name="book_id" value="{{ b.book_id }}">
                        <button type="submit" class="btn btn-sm btn-warning w-100">Join Waitlist</button>
                    </form>
                    {% endif %}

                    <!-- Wishlist Button -->
                    <form action="/member/wishlist/add" method="POST" style="margin:0;">
                        <input type="hidden" name="book_id" value="{{ b.book_id }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Add to Wishlist" style="padding: 0.4rem 0.8rem;">
                            ‚ù§Ô∏è
                        </button>
                    </form>
                </div>

                <!-- Secondary Row if PDF exists -->
                {% if b.pdf_src %}
                <a href="{{ url_for('static', filename=b.pdf_src) }}" target="_blank" class="btn btn-sm btn-outline-success w-100">
                    üìñ Read Online
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- PAGINATION CONTROLS -->
<div class="pagination">
    {% if current_page > 1 %}
    <a href="/member/catalog?page={{ current_page - 1 }}&q={{ q }}&author={{ selected_author }}&category={{ selected_category }}" class="btn btn-danger btn-sm">Previous</a>
    {% else %}
    <button class="btn btn-disabled btn-sm" disabled>Previous</button>
    {% endif %}

    <span class="page-info">Page <strong>{{ current_page }}</strong> of {{ total_pages }}</span>

    {% if current_page < total_pages %}
    <a href="/member/catalog?page={{ current_page + 1 }}&q={{ q }}&author={{ selected_author }}&category={{ selected_category }}" class="btn btn-primary btn-sm">Next</a>
    {% else %}
    <button class="btn btn-disabled btn-sm" disabled>Next</button>
    {% endif %}
</div>
{% endif %}

<!-- Review Modal -->
<div id="reviewModal" class="modal-overlay" style="display: none;">
    <div class="modal-content glass-card p-4" style="max-width: 500px; width: 90%; margin: 10% auto; position: relative;">
        <span onclick="closeReviewModal()" style="position: absolute; top: 1rem; right: 1rem; cursor: pointer; font-size: 1.5rem;">&times;</span>
        <h3>Rate & Review</h3>
        <p id="modalBookTitle" style="color: var(--text-sub); margin-bottom: 1rem;"></p>
        
        <form action="/member/review/add" method="POST">
            <input type="hidden" name="book_id" id="modalBookId">
            
            <div class="mb-3">
                <label>Rating:</label>
                <div class="rating-stars">
                    <input type="radio" name="rating" value="5" id="r5"><label for="r5">‚òÖ</label>
                    <input type="radio" name="rating" value="4" id="r4"><label for="r4">‚òÖ</label>
                    <input type="radio" name="rating" value="3" id="r3"><label for="r3">‚òÖ</label>
                    <input type="radio" name="rating" value="2" id="r2"><label for="r2">‚òÖ</label>
                    <input type="radio" name="rating" value="1" id="r1"><label for="r1">‚òÖ</label>
                </div>
            </div>
            
            <div class="mb-3">
                <label>Comment (Optional):</label>
                <textarea name="comment" class="form-control" rows="3" placeholder="Share your thoughts..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary w-100">Submit Review</button>
        </form>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        backdrop-filter: blur(5px);
    }
    .rating-stars {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    .rating-stars input { display: none; }
    .rating-stars label {
        font-size: 1.5rem;
        color: #ddd;
        cursor: pointer;
        transition: color 0.2s;
    }
    .rating-stars input:checked ~ label,
    .rating-stars label:hover,
    .rating-stars label:hover ~ label {
        color: #f6c23e;
    }
</style>

<script>
    function openReviewModal(id, title) {
        document.getElementById('modalBookId').value = id;
        document.getElementById('modalBookTitle').innerText = title;
        document.getElementById('reviewModal').style.display = 'block';
    }
    function closeReviewModal() {
        document.getElementById('reviewModal').style.display = 'none';
    }
</script>
{% endblock %}
