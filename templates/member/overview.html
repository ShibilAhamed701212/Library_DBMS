{% extends "layout.html" %}

{% block title %}My Dashboard{% endblock %}
{% block header_title %}My Library Overview 
    {% if reading_goal %}
        {% set tier = reading_goal.tier if reading_goal.tier else 'Silver' %}
        
        <!-- Expanding Tier Badge -->
        <div class="expanding-pill tier-pill">
            <div class="pill-badge" style="
                {% if tier == 'Platinum' %}
                    background: linear-gradient(135deg, #e5e7eb, #94a3b8); color: #1e293b; border: 1px solid #cbd5e1;
                {% elif tier == 'Gold' %}
                    background: linear-gradient(135deg, #fde68a, #f59e0b); color: #78350f; border: 1px solid #fbbf24;
                {% else %}
                    background: linear-gradient(135deg, #f3f4f6, #d1d5db); color: #374151; border: 1px solid #9ca3af;
                {% endif %}
            ">
                {% if tier == 'Platinum' %}üíé Platinum{% elif tier == 'Gold' %}ü•á Gold{% else %}ü•à Silver{% endif %}
            </div>
            
            <div class="pill-details">
                {% if tier == 'Platinum' %}
                    <span>üìö 10 Books</span><span class="separator">‚Ä¢</span><span>‚è≥ 30 Days</span>
                {% elif tier == 'Gold' %}
                    <span>üìö 6 Books</span><span class="separator">‚Ä¢</span><span>‚è≥ 21 Days</span>
                {% else %}
                    <span>üìö 3 Books</span><span class="separator">‚Ä¢</span><span>‚è≥ 14 Days</span>
                {% endif %}
            </div>
        </div>
    {% endif %}
    
    {% if game_stats %}
    <!-- Expanding Level Badge -->
    <div class="expanding-pill level-pill" style="margin-left: 8px;">
        <div class="pill-badge" style="background: linear-gradient(135deg, #6366f1, #a855f7); color: white;">
            ‚ú® Level {{ game_stats.level }}
        </div>
        <div class="pill-details">
            {% set total_needed = (game_stats.level * (game_stats.level + 1) / 2) * 100 %}
            {% set prev_level_xp = ((game_stats.level - 1) * game_stats.level / 2) * 100 %}
            {% set next_xp_target = total_needed %}
            
            <span>XP: {{ game_stats.xp }}</span>
            <span class="separator">‚Ä¢</span>
            <span>Next: {{ next_xp_target|int }}</span>
        </div>
    </div>
    {% endif %}
    
    <!-- Expanding Badge CSS -->
    <style>
        .expanding-pill {
            display: inline-flex;
            align-items: center;
            border-radius: 50px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(0,0,0,0.05);
            cursor: default;
            vertical-align: middle;
            position: relative;
            overflow: hidden;
            border: 1px solid transparent;
        }

        .expanding-pill:hover {
            background: rgba(255,255,255,1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-color: rgba(99, 102, 241, 0.2);
            transform: translateY(-1px);
        }

        .pill-badge {
            padding: 5px 14px;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            border-radius: 50px;
            z-index: 2;
            white-space: nowrap;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .pill-details {
            max-width: 0;
            opacity: 0;
            transform: translateX(-10px);
            white-space: nowrap;
            padding-right: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-sub);
            display: flex;
            align-items: center;
        }

        .expanding-pill:hover .pill-details {
            max-width: 250px; 
            opacity: 1;
            transform: translateX(0);
            padding-right: 14px;
            padding-left: 8px;
        }

        .separator {
            margin: 0 6px;
            opacity: 0.3;
        }
    </style>
{% endblock %}
{% block header_subtitle %}
    Track your active borrowings and membership privileges.
    {% if game_stats %}
    <div style="margin-top: 10px; width: 250px;">
        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 4px;">
            <span>XP: {{ game_stats.xp }}</span>
            <span>Next Level at {{ (game_stats.level * (game_stats.level + 1) / 2) * 100 }} XP</span>
        </div>
        <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
            {% set total_needed = (game_stats.level * (game_stats.level + 1) / 2) * 100 %}
            {% set prev_level_xp = ((game_stats.level - 1) * game_stats.level / 2) * 100 %}
            {% set progress = ((game_stats.xp - prev_level_xp) / (total_needed - prev_level_xp) * 100) if (total_needed - prev_level_xp) > 0 else 0 %}
            <div style="height: 100%; width: {{ progress }}%; background: #6366f1; box-shadow: 0 0 10px #6366f1;"></div>
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block content %}
<!-- Member Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üìñ</div>
        <div class="stat-info">
            <span class="stat-label">My Issued Books</span>
            <span class="stat-value">{{ issues|length }}</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-info">
            <span class="stat-label">Total Fines</span>
            <span class="stat-value">{{ system_settings.currency_symbol }}{{ issues|sum(attribute='fine') }}</span>
        </div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #4e73df 0%, #224abe 100%); color: white;">
        <div class="stat-icon">üèÜ</div>
        <div class="stat-info">
            <span class="stat-label" style="color: rgba(255,255,255,0.8);">My Achievements</span>
            <span class="stat-value" style="color: white;">{{ game_stats.badges|length if game_stats else 0 }} Badges</span>
        </div>
    </div>
</div>

<!-- Trophy Room -->
<!-- Trophy Room -->
{% if game_stats and game_stats.badges %}
<section class="dashboard-section">
    <div class="section-header" style="justify-content: flex-start; align-items: center; gap: 10px;">
        <h2>üèÜ My Trophy Room</h2>
        <a href="/member/achievements" class="btn btn-sm btn-outline-secondary" style="margin-left: auto;">View Details</a>
    </div>
    
    <a href="/member/achievements" style="text-decoration: none; color: inherit; display: block;">
        <div class="glass-card hover-scale" style="padding: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; cursor: pointer; transition: transform 0.2s ease;">
            {% for badge in game_stats.badges[:5] %}
            <div style="text-align: center; width: 100px;">
                <div style="font-size: 2rem; margin-bottom: 0.2rem;">{{ badge.icon }}</div>
                <div style="font-weight: 600; font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ badge.name }}</div>
            </div>
            {% endfor %}
            {% if game_stats.badges|length > 5 %}
            <div style="display: flex; align-items: center; justify-content: center; width: 80px; font-weight: bold; color: var(--text-sub);">
                +{{ game_stats.badges|length - 5 }} More
            </div>
            {% endif %}
        </div>
    </a>
</section>
{% endif %}



<!-- Goals and Privacy -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
    <!-- PERSONAL GOAL -->
    <section class="dashboard-section" style="margin-top: 0;">
        <div class="section-header">
            <h2>üéØ Reading Goal</h2>
            <a href="/member/goals" class="btn btn-outline-secondary btn-sm">View Full Details</a>
        </div>
        <div class="section-content glass-card" style="padding: 1.5rem; display: flex; align-items: center; justify-content: space-between;">
            <div>
                {% if reading_goal %}
                <h3 style="margin: 0; margin-bottom: 0.5rem; font-size: 1.1rem;">{{ reading_goal.current_books }} / {{ reading_goal.goal_books }} Books</h3>
                <p style="color: var(--text-sub); font-size: 0.9rem; margin: 0;">
                    {% set progress = (reading_goal.current_books / reading_goal.goal_books * 100) if reading_goal.goal_books > 0 else 0 %}
                    You're {{ progress|int }}% of the way there!
                </p>
                {% else %}
                <p style="color: var(--text-sub);">No goal set for this year.</p>
                {% endif %}
            </div>
            <a href="/member/goals" class="btn btn-primary">Update Goal</a>
        </div>
    </section>


</div>

<!-- Quick Actions -->
<div class="quick-actions" style="margin: 1.5rem 0;">
    <a href="{{ url_for('member.member_suggest_book') }}" class="btn btn-primary">
        <i class="fas fa-lightbulb me-2"></i>Suggest a Book
    </a>
    <a href="{{ url_for('member.member_catalog_view') }}" class="btn btn-outline-secondary">
        <i class="fas fa-book me-2"></i>Browse Books
    </a>
</div>

<!-- Smart Recommendations -->
<section class="dashboard-section mb-4">
    <div class="section-header">
        <h2><i class="fas fa-magic me-2" style="color: #6366f1;"></i>Recommended for You</h2>
    </div>
    <div class="recommendations-container" style="display: flex; gap: 1rem; overflow-x: auto; padding: 3rem 2rem; scroll-behavior: smooth;">
        {% for rec in recommendations %}
        <div class="glass-card recommendation-card" style="min-width: 220px; width: 220px; position: relative; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); transform-origin: center center; z-index: 1;">
            
            <!-- COVER IMAGE OR FALLBACK -->
            {% if rec.cover_url %}
            <div style="
                height: 320px; 
                background-image: url('{{ rec.cover_url }}');
                background-size: cover;
                background-position: center;
                border-radius: 12px;
                margin-bottom: 1rem;
                position: relative;
                overflow: hidden;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            ">
                <!-- Hover Overlay Gradient -->
                <div class="card-overlay"></div>
            </div>
            {% else %}
            <!-- Fallback Gradient -->
            <div style="
                height: 320px; 
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1)); 
                display: flex; 
                align-items: center; 
                justify-content: center;
                border-radius: 12px;
                margin-bottom: 1rem;
                position: relative;
                overflow: hidden;
            ">
                <div style="font-size: 4rem;">
                    {% if rec.category == 'Fiction' %}üè∞
                    {% elif rec.category == 'Science' %}üß¨
                    {% elif rec.category == 'Biography' %}üë§
                    {% elif rec.category == 'Technology' %}üíª
                    {% else %}üìö{% endif %}
                </div>
                <div class="card-overlay"></div>
            </div>
            {% endif %}

            <div class="rec-info">
                <div style="font-weight: 700; font-size: 1rem; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="{{ rec.title }}">
                    {{ rec.title }}
                </div>
                <div style="font-size: 0.8rem; color: var(--text-sub); margin-bottom: 0.5rem;">
                    {{ rec.author }}
                </div>
                
                <div class="rec-details" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: #fbbf24; margin-bottom: 0.5rem;">
                        <span>‚≠ê {{ "%.1f"|format(rec.avg_rating|float) }} Match</span>
                        <span style="color: var(--text-sub);">‚Ä¢ {{ rec.category }}</span>
                    </div>
                    
                    {% if rec.description %}
                    <div style="font-size: 0.75rem; color: var(--text-sub); margin-bottom: 0.75rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4;">
                        {{ rec.description }}
                    </div>
                    {% endif %}
                
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <form action="/member/request" method="POST" style="flex: 1;">
                            <input type="hidden" name="book_id" value="{{ rec.book_id }}">
                            <button type="submit" class="btn btn-primary btn-sm" style="width: 100%; font-size: 0.7rem;">+ My List</button>
                        </form>
                        {% if rec.pdf_src %}
                        <a href="/member/book/read/{{ rec.book_id }}" class="btn btn-outline-light btn-sm" style="flex: 1; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">
                            ‚ñ∂ Read
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<style>
    /* Netflix-style Hover Effects */
    /* Netflix-style Hover Effects */
    .recommendation-card {
        /* Optimize transitions for width/layout changes */
        transition: width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                    min-width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                    transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                    box-shadow 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                    background-color 0.4s ease;
    }

    .recommendation-card:hover {
        /* "Pushing" Effect: Physically expand unit width */
        min-width: 300px !important; /* Increased from 260px */
        width: 300px !important;
        
        transform: scale(1.05) translateY(-5px); /* Slightly more pop */
        z-index: 100 !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        background: #ffffff; /* White background for readability */
        height: auto; /* Allow natural expansion for details */
        border: 1px solid rgba(99, 102, 241, 0.2);
    }
    
    /* Smart Transform Origins to prevent clipping at edges */
    .recommendation-card:first-child:hover {
        transform-origin: left center;
    }
    .recommendation-card:last-child:hover {
        transform-origin: right center;
    }
    
    .recommendation-card:hover .rec-details {
        display: block !important;
        opacity: 1 !important;
    }
    
    .card-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .recommendation-card:hover .card-overlay {
        opacity: 1;
    }
    
    /* Hide scrollbar but keep functionality */
    .recommendations-container::-webkit-scrollbar {
        height: 6px;
    }
    .recommendations-container::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.1);
        border-radius: 3px;
    }
    .recommendations-container::-webkit-scrollbar-track {
        background: transparent;
    }
</style>

<!-- Recent Activity -->
<section class="dashboard-section mb-4">
    <div class="section-header">
        <h2><i class="fas fa-bolt me-2" style="color: var(--primary);"></i>Recent Activity</h2>
    </div>
    <div class="glass-card" style="padding: 1.5rem;">
        {% if not activities %}
        <p style="color: var(--text-sub); text-align: center; margin: 0;">No recent activities found.</p>
        {% else %}
        <div class="activity-timeline">
            {% for act in activities %}
            <div class="activity-item" style="display: flex; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
                <div class="activity-type-icon" style="font-size: 1.25rem;">
                    {% if act.activity_type == 'BORROW' %}üìñ
                    {% elif act.activity_type == 'RETURN' %}‚úÖ
                    {% elif act.activity_type == 'BADGE' %}üèÜ
                    {% elif act.activity_type == 'REVIEW' %}‚≠ê
                    {% elif act.activity_type == 'WISHLIST' %}‚ù§Ô∏è
                    {% else %}üîπ{% endif %}
                </div>
                <div>
                    <div style="font-weight: 600;">{{ act.description }}</div>
                    <div style="font-size: 0.8rem; color: var(--text-sub);">{{ act.created_at }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</section>

<!-- Active Borrowings -->
<style>
    /* Enhanced table styles */
    .table-container {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        overflow: hidden;
    }
    
    .table-container table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .table-container th {
        background-color: #f8f9fc;
        color: #4e73df;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
        padding: 1rem;
        text-align: left;
    }
    
    .table-container td {
        padding: 1rem;
        border-top: 1px solid #e3e6f0;
        vertical-align: middle;
    }
    
    .table-container tr:hover {
        background-color: rgba(78, 115, 223, 0.05);
    }
    
    .badge {
        font-weight: 500;
        padding: 0.35em 0.65em;
        font-size: 0.75em;
        border-radius: 0.25rem;
    }
    
    .badge-success {
        background-color: #1cc88a;
        color: white;
    }
    
    .badge-warning {
        background-color: #f6c23e;
        color: #1f2d3d;
    }
    
    .badge-danger {
        background-color: #e74a3b;
        color: white;
    }
    
    .btn {
        border-radius: 0.35rem;
        font-weight: 500;
        padding: 0.375rem 0.75rem;
        font-size: 0.8rem;
        transition: all 0.2s;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 0.15rem 0.5rem rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    .btn-outline-secondary {
        border-color: #d1d3e2;
        color: #6e707e;
    }
    
    .btn-outline-secondary:hover {
        background-color: #f8f9fc;
        border-color: #bac8f3;
        color: #4e73df;
    }
    
    .quick-actions {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }
    
    .stat-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.05) !important;
    }
</style>

<section class="dashboard-section">
    <div class="section-header d-flex justify-content-between align-items-center">
        <h2><i class="fas fa-book-reader me-2"></i>Active Borrowings</h2>
        <span class="badge bg-primary">{{ active_issues|length }} Active</span>
    </div>
    <div class="section-content">
        {% set active_issues = issues | selectattr('return_date', 'none') | list %}
        {% if active_issues %}
        <div class="table-container glass-card">
            <table>
                <thead>
                    <tr>
                        <th>Book Title</th>
                        <th>Issue Date</th>
                        <th>Fine ({{ system_settings.currency_symbol }})</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in active_issues %}
                    <tr>
                        <td style="font-weight: 600;">{{ i.title }}</td>
                        <td>{{ i.issue_date }}</td>
                        <td style="color: {{ 'var(--danger)' if i.fine > 0 else 'var(--text-main)' }};">{{ system_settings.currency_symbol }}{{ i.fine }}</td>
                        <td>
                            {% if i.fine > 0 %}
                            <span class="badge badge-danger">Overdue</span>
                            {% else %}
                            <span class="badge badge-pending">Active</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="glass-card" style="text-align: center; color: var(--text-sub); padding: 2rem;">
            <p>You have no active borrowings.</p>
            <a href="/member/catalog" class="btn btn-primary" style="margin-top: 1rem;">Borrow a Book</a>
        </div>
        {% endif %}
    </div>
</section>

<!-- Borrowing History -->
<section class="dashboard-section mt-5">
    <div class="section-header d-flex justify-content-between align-items-center">
        <h2><i class="fas fa-history me-2"></i>Borrowing History</h2>
        <span class="badge bg-secondary">{{ (issues|length) - (active_issues|length) }} Past</span>
    </div>
    <div class="section-content">
        {% set history_issues = issues | selectattr('return_date', 'ne', none) | list %}
        {% if history_issues %}
        <div class="table-container glass-card">
            <table>
                <thead>
                    <tr>
                        <th>Book Title</th>
                        <th>Issue Date</th>
                        <th>Return Date</th>
                        <th>Fine Paid</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in history_issues %}
                    <tr>
                        <td style="font-weight: 400; color: var(--text-sub);">{{ i.title }}</td>
                        <td>{{ i.issue_date }}</td>
                        <td>{{ i.return_date }}</td>
                        <td>{{ system_settings.currency_symbol }}{{ i.fine }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="color: var(--text-sub); opacity: 0.7;">No past borrowing records found.</p>
        {% endif %}
    </div>
</section>

<!-- Account Settings -->
<section class="dashboard-section mt-5">
    <div class="section-header">
        <h2><i class="fas fa-cog me-2" style="color: #e74a3b;"></i>Account Settings</h2>
    </div>
    <div class="section-content glass-card" style="border-color: rgba(220, 53, 69, 0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h3 style="margin-bottom: 0.5rem;">Delete Account</h3>
                <p style="color: var(--text-sub); font-size: 0.9rem;">Once you delete your account, there is no going back. Please be certain.</p>
            </div>
            <form action="/member/delete-account" method="POST" onsubmit="return confirm('‚ö†Ô∏è FINAL WARNING: Are you sure you want to PERMANENTLY delete your account? All your history will be lost.')">
                <button type="submit" class="btn btn-danger" style="background: var(--danger); border: none;">Delete My Account</button>
            </form>
        </div>
    </div>
</section>
{% endblock %}
